<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id></id>
    <title>Matthew Daly&apos;s Blog</title>
    <updated>2018-01-02T20:28:39Z</updated>
    <generator>grunt-blogbuilder https://github.com/matthewbdaly/grunt-blogbuilder</generator>
    <author>
        <name>Matthew Daly</name>
        <email>matthew@matthewdaly.co.uk</email>
        <uri>https://matthewdaly.co.uk</uri>
    </author>
    <link rel="alternate" href="https://matthewdaly.co.uk"/>
    <subtitle>I&apos;m a web developer in Norfolk. This is my blog...</subtitle>
    <rights>Matthew Daly 2018</rights>
    <entry>
        <title type="html"><![CDATA[A Laravel package boilerplate]]></title>
        <id>https://matthewdaly.co.uk/blog/2018/01/02/a-laravel-package-boilerplate/</id>
        <link href="https://matthewdaly.co.uk/blog/2018/01/02/a-laravel-package-boilerplate/">
        </link>
        <updated>2018-01-02T12:12:15Z</updated>
        <summary type="html"><![CDATA[<p>The second package I’ve been working on recently is <a href="https://github.com/matthewbdaly/laravel-package-boilerplate">Laravel Package Boilerplate</a>. It’s a basic starter boilerplate for building your own Laravel packages.</p>
<p>It’s not meant to be installed as a project dependency. Instead, run the following command to create a new project boilerplate with it:</p>
<pre><code class="hljs lang-bash singleline">composer create-project --prefer-dist matthewbdaly/laravel-package-boilerplate &lt;YOUR_NEW_PACKAGE_DIRECTORY&gt;</code></pre>
<p>This will create a new folder that includes a <code>src</code> folder containing a service provider, and a <code>tests</code> folder containing a preconfigured base test case, as well as a simple test case for tests that don’t need the full application instantiated, in order to help keep your test suite as fast as possible.</p>
<p>In addition, it includes configuration files for:</p>
<ul>
<li>PHPUnit</li>
<li>PHP CodeSniffer</li>
<li>Travis CI</li>
</ul>
<p>That way you can start your project off the right way with very little effort.</p>
<p>I’ve also added my Artisan Standalone project as a dependency - that way you can access any Artisan commands you need to generate files you need as follows:</p>
<pre><code class="hljs lang-bash singleline">$ vendor/bin/artisan</code></pre>
<p>Hopefully this package should make it a lot easier to create new Laravel packages in future.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Using Artisan from standalone Laravel packages]]></title>
        <id>https://matthewdaly.co.uk/blog/2018/01/02/using-artisan-from-standalone-laravel-packages/</id>
        <link href="https://matthewdaly.co.uk/blog/2018/01/02/using-artisan-from-standalone-laravel-packages/">
        </link>
        <updated>2018-01-02T12:01:10Z</updated>
        <summary type="html"><![CDATA[<p>Recently I’ve been building and publishing a significant number of Laravel packages, and I thought I’d share details of some of them over the next few days.</p>
<p><a href="https://github/com/matthewbdaly/artisan-standalone">Artisan Standalone</a> is a package that, when installed in a standalone Laravel package (eg, not in an actual Laravel install, but in a package that you’re building that is intended for use with Laravel), allows you to use Artisan. It’s intended largely to make it quicker and easier to build functionality as separate packages by giving you access to the same generator commands as you have when working with a Laravel application. It came about largely from a need to scratch my own itch, as when building packages I was having to either run Artisan commands in a Laravel app and move them over, or copy them from existing files, which was obviously a pain in the proverbial.</p>
<p>You can install it with the following command:</p>
<pre><code class="hljs lang-bash singleline">$ composer require --dev matthewbdaly/artisan-standalone</code></pre>
<p>Once it’s installed, you can access Artisan as follows:</p>
<pre><code class="hljs lang-bash singleline">$ vendor/bin/artisan</code></pre>
<p>Note that it doesn’t explicitly include Laravel as a dependency - you’ll need to add that in the parent package to pull in the libraries it needs (which you should be doing anyway). It’s possible that there are some commands that won’t work in this context, but they’re almost certainly ones you won’t need here, such as the <code>migrate</code> command. As far as I can tell the generator commands, which are the only ones we’re really interested in here, all work OK.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Creating Artisan tasks that generate files]]></title>
        <id>https://matthewdaly.co.uk/blog/2018/01/01/creating-artisan-tasks-that-generate-files/</id>
        <link href="https://matthewdaly.co.uk/blog/2018/01/01/creating-artisan-tasks-that-generate-files/">
        </link>
        <updated>2018-01-01T16:06:21Z</updated>
        <summary type="html"><![CDATA[<p>While the documentation for creating Artisan tasks is generally pretty good, it doesn’t really touch on creating tasks that generate new files. The only way to figure it out was to go digging through the source code. In this case, I was building an Artisan command to create Fractal transformers as part of a package I’m working on.</p>
<p>There’s a specialised class for generating files at <code>Illuminate\Console\GeneratorCommand</code>, which your command class should extend instead of <code>Illuminate\Console\Command</code>. In addition to the usual properties such as the signature and description, you also need to specify <code>$type</code> to give the type of class being generated. Also, note that the constructor is different, so if you use <code>php artisan make:console</code> to create the boilerplate for this command, you’ll need to delete the constructor.</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Commands</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">GeneratorCommand</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputArgument</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformerMakeCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GeneratorCommand</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     * The name and signature of the console command.</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@var</span> string</td><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $signature = <span class="hljs-string">'make:transformer {name : The required name of the transformer class}'</span>;</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="18"></td><td>     * The console command description.</td><tr><td class="linenos" data-pseudo-content="19"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="20"></td><td>     * <span class="hljs-doctag">@var</span> string</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-keyword">protected</span> $description = <span class="hljs-string">'Create a Fractal transformer'</span>;</td><tr><td class="linenos" data-pseudo-content="23"></td><td></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="25"></td><td>     * The type of class being generated.</td><tr><td class="linenos" data-pseudo-content="26"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@var</span> string</td><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">protected</span> $type = <span class="hljs-string">'Fractal transformer'</span>;</td><tr><td class="linenos" data-pseudo-content="30"></td><td></td><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="32"></td><td>     * Get the stub file for the generator.</td><tr><td class="linenos" data-pseudo-content="33"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="34"></td><td>     * <span class="hljs-doctag">@return</span> string</td><tr><td class="linenos" data-pseudo-content="35"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStub</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="37"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/stubs/transformer.stub'</span>;</td><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="40"></td><td></td><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="42"></td><td>     * Get the console command arguments.</td><tr><td class="linenos" data-pseudo-content="43"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> array</td><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getArguments</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="47"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="49"></td><td>            [<span class="hljs-string">'name'</span>, InputArgument::REQUIRED, <span class="hljs-string">'The name of the command.'</span>],</td><tr><td class="linenos" data-pseudo-content="50"></td><td>        ];</td><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="52"></td><td></td><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="54"></td><td>     * Get the default namespace for the class.</td><tr><td class="linenos" data-pseudo-content="55"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="56"></td><td>     * <span class="hljs-doctag">@param</span>  string  $rootNamespace</td><tr><td class="linenos" data-pseudo-content="57"></td><td>     * <span class="hljs-doctag">@return</span> string</td><tr><td class="linenos" data-pseudo-content="58"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDefaultNamespace</span><span class="hljs-params">($rootNamespace)</span></td><tr><td class="linenos" data-pseudo-content="60"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="61"></td><td>        <span class="hljs-keyword">return</span> $rootNamespace.<span class="hljs-string">'\Transformers'</span>;</td><tr><td class="linenos" data-pseudo-content="62"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="63"></td><td>}</td></table></code></pre>
<p>Note the <code>getDefaultNamespace()</code> method. If your class will live directly under the <code>app</code> folder this is not necessary. Otherwise, it needs to return the root namespace, with the folder structure you want after it. Here my class will live under <code>app\Transformers</code>, so I’ve set it to reflect that.</p>
<p>Also, note the <code>getStub()</code> method. This tells Artisan that it should use the specified stub file as the basis for our class. Below you’ll find the stub file I used for my transformer:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">DummyNamespace</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">BaseTransformer</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DummyClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTransformer</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Model $model)</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $model-&gt;id,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        ];</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></table></code></pre>
<p>Note that the <code>DummyNamespace</code> and <code>DummyClass</code> fields will be overwritten with the correct values.</p>
<p>Once this Artisan command is registered in the usual way, you can then run it as follows:</p>
<pre><code class="hljs lang-bash singleline">$ php artisan make:transformer Example</code></pre>
<p>And it will generate a boilerplate class something like this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Transformers</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">BaseTransformer</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTransformer</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Model $model)</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $model-&gt;id,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        ];</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></table></code></pre>
<p>You can then replace the model with your own one as necessary, and add any further content to this class.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Using UUIDs as primary keys with Laravel and PostgreSQL]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/12/29/using-uuids-as-primary-keys-with-laravel-and-postgresql/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/12/29/using-uuids-as-primary-keys-with-laravel-and-postgresql/">
        </link>
        <updated>2017-12-29T18:01:04Z</updated>
        <summary type="html"><![CDATA[<p>For many applications, using UUID’s as the primary keys on a database table can make a lot of sense. For mobile or offline apps, in particular, they mean you can create new objects locally and assign them a primary key without having to worry about it colliding with another object that was created in the meantime once it gets synchronised to the server. Also, they are less informative to nefarious users - an autoincrementing value in a URL tells a user that that value is the primary key, and means the app may potentially allow gathering of information via user enumeration (eg calling <code>/api/v1/users/1</code>, <code>/api/v1/users/2</code> etc).</p>
<p>It’s fairly straightforward to use UUID’s as primary keys on your models when using PostgreSQL. First, you need to set up your migrations to use the <code>uuid-ossp</code> extension and set up the <code>id</code> field as both a UUID and the primary key. You also need to set a default value manually so that if it’s left empty it will generate a UUID for it.</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'</span>);</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Schema::create(<span class="hljs-string">'items'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    $table-&gt;uuid(<span class="hljs-string">'id'</span>)-&gt;primary();</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    $table-&gt;text(<span class="hljs-string">'text'</span>)-&gt;nullable();</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    $table-&gt;timestamps();</td><tr><td class="linenos" data-pseudo-content="6"></td><td>});</td><tr><td class="linenos" data-pseudo-content="7"></td><td>DB::statement(<span class="hljs-string">'ALTER TABLE items ALTER COLUMN id SET DEFAULT uuid_generate_v4();'</span>);</td></table></code></pre>
<p>Then, in the model definition, you need to tell Laravel to cast the <code>id</code> field to a string, and explicitly set the primary key to <code>id</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">protected</span> $casts = [</td><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'string'</span>,</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    ];</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">protected</span> $primaryKey = <span class="hljs-string">"id"</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td>}</td></table></code></pre>
<p>Once this is done, the model should generate the primary keys for you as usual, except as UUID’s. If your application needs to accept UUID primary keys that were created offline, such as in a mobile app, you will probably want to add the <code>id</code> field to the <code>$fillable</code> array on the model to allow this.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full text search with Laravel and PostgreSQL]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/12/02/full-text-search-with-laravel-and-postgresql/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/12/02/full-text-search-with-laravel-and-postgresql/">
        </link>
        <updated>2017-12-02T23:30:44Z</updated>
        <summary type="html"><![CDATA[<p>I’ve touched on <a href="/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">using PostgreSQL to implement fuzzy search with Laravel before</a>, but another type of search that PostgreSQL can handle fairly easily is full-text search. Here I’ll show you how to use it in a Laravel application.</p>
<p>An obvious use case for this kind of search is a personal blogging engine. It’s unlikely something like this is going to have enough content for it to be worth using a heavier solution like Elasticsearch, but a <code>LIKE</code> or <code>ILIKE</code> statement doesn’t really cut it either, so Postgres’s full text search is a good fit. Below you’ll see a Laravel migration for the blog posts table:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreatePostsTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'posts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;increments(<span class="hljs-string">'id'</span>);</td><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'title'</span>);</td><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;datetime(<span class="hljs-string">'pub_date'</span>);</td><tr><td class="linenos" data-pseudo-content="20"></td><td>            $table-&gt;text(<span class="hljs-string">'text'</span>);</td><tr><td class="linenos" data-pseudo-content="21"></td><td>            $table-&gt;string(<span class="hljs-string">'slug'</span>);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>            $table-&gt;integer(<span class="hljs-string">'author_id'</span>);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            $table-&gt;timestamps();</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        DB::statement(<span class="hljs-string">"ALTER TABLE posts ADD COLUMN searchtext TSVECTOR"</span>);</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">"UPDATE posts SET searchtext = to_tsvector('english', title || '' || text)"</span>);</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        DB::statement(<span class="hljs-string">"CREATE INDEX searchtext_gin ON posts USING GIN(searchtext)"</span>);</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        DB::statement(<span class="hljs-string">"CREATE TRIGGER ts_searchtext BEFORE INSERT OR UPDATE ON posts FOR EACH ROW EXECUTE PROCEDURE tsvector_update_trigger('searchtext', 'pg_catalog.english', 'title', 'text')"</span>);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="30"></td><td></td><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="32"></td><td>     * Reverse the migrations.</td><tr><td class="linenos" data-pseudo-content="33"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="34"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="35"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="37"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="38"></td><td>        DB::statement(<span class="hljs-string">"DROP TRIGGER IF EXISTS tsvector_update_trigger ON posts"</span>);</td><tr><td class="linenos" data-pseudo-content="39"></td><td>        DB::statement(<span class="hljs-string">"DROP INDEX IF EXISTS searchtext_gin"</span>);</td><tr><td class="linenos" data-pseudo-content="40"></td><td>        DB::statement(<span class="hljs-string">"ALTER TABLE posts DROP COLUMN searchtext"</span>);</td><tr><td class="linenos" data-pseudo-content="41"></td><td>        Schema::dropIfExists(<span class="hljs-string">'posts'</span>);</td><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="43"></td><td>}</td></table></code></pre>
<p>Note that after we create the basic layout of our <code>posts</code> table, we then have to drop down to raw DB statements to achieve the next steps:</p>
<ul>
<li>We add a column called <code>searchtext</code> with a type of <code>TSVECTOR</code> (unfortunately Laravel doesn’t have a convenient method to create this column type, so we need to do it with a raw statement). This column will hold our searchable document.</li>
<li>We use the <code>to_tsvector()</code> method to generate a document on each row that combines the title and text fields and store it in the <code>searchtext</code> column. Note also that we specify the language as the first argument. This is because Postgres’s full text search understands so-called “stopwords”, which are words that are so common as to not be worth bothering with at all, such as “the” - these will obviously differ between languages, so it’s prudent to explicitly state this so Postgres knows what stopwords to expect.</li>
<li>We create a <code>GIN</code> index on the <code>posts</code> table using our new <code>searchtext</code> column.</li>
<li>Finally we create a trigger which, when the table is amended, regenerates the search text.</li>
</ul>
<p>With that done, we can now look at actually performing a full-text search. To facilitate easy re-use, we’ll create a local scope on our <code>Post</code> model. If you haven’t used scopes in Laravel before, they essentially allow you to break queries into reusable chunks. In this case, we expect our scope to receive two arguments, the query instance (which is passed through automatically), and the search text:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $fillable = [</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-string">'title'</span>,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-string">'pub_date'</span>,</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-string">'text'</span>,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-string">'slug'</span>,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-string">'author_id'</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    ];</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeSearch</span><span class="hljs-params">($query, $search)</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> (!$search) {</td><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">return</span> $query;</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> $query-&gt;whereRaw(<span class="hljs-string">'searchtext @@ to_tsquery(\'english\', ?)'</span>, [$search])</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            -&gt;orderByRaw(<span class="hljs-string">'ts_rank(searchtext, to_tsquery(\'english\', ?)) DESC'</span>, [$search]);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></table></code></pre>
<p>If <code>$search</code> is empty, we just return the query object as is. Otherwise, we first of all construct a <code>WHERE</code> clause that matches our search text against the <code>searchtext</code> column. Note the syntax used here:</p>
<pre><code class="hljs lang-sql singleline">searchtext @@ to_tsquery('english', 'foo')</code></pre>
<p>We use the <code>to_tsquery()</code> method to match our text against our search document. As before, note that we specify the language.</p>
<p>Finally, we specify an order - we want the highest ranked matches to appear first, and this section of the query does that:</p>
<pre><code class="hljs lang-sql singleline">ts_rank(searchtext, to_tsquery('english', 'foo')) DESC</code></pre>
<p>Here we use <code>ts_rank()</code> to ensure we get our results in the appropriate order. Note that for both queries, we passed the arguments through as parameterized queries, rather than constructing a raw string - we have to watch out for SQL injection when we’re writing raw queries, but we can use PDO’s parameterized queries from Eloquent in a raw statement, which makes things a bit easier.</p>
<p>Now we can call our new search scope as follows:</p>
<pre><code class="hljs lang-php singleline">$posts = Post::search($search)-&gt;get();</code></pre>
<p>Because the scope receives and returns a query builder instance, you can continue to add the rest of your query, or paginate it, as necessary:</p>
<pre><code class="hljs lang-php singleline">$posts = Post::search($search)-&gt;where(<span class="hljs-string">'draft'</span>, <span class="hljs-keyword">false</span>)-&gt;simplePaginate(<span class="hljs-number">5</span>);</code></pre>
<p>If you’re working in a language that makes heavy use of accents, such as French, you might also want to install the <code>unaccent</code> extension (you can do this in the migration with <code>CREATE EXTENSION unaccent</code>). Then, any time we call <code>to_tsvector()</code>, you should pass any strings through the <code>unaccent()</code> method to strip out the accents.</p>
<h2 id="do-we-need-the-migrations-">Do we need the migrations?</h2>
<p>Technically, we could do without the additional changes to the database structure - we could create a document on the fly inside a subquery and use that to query against, which would look something like this in SQL:</p>
<pre><code class="hljs lang-sql"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">SELECT</span> *</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">FROM</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td>  (<span class="hljs-keyword">SELECT</span> *,</td><tr><td class="linenos" data-pseudo-content="4"></td><td>          to_tsvector(<span class="hljs-string">'english'</span>, posts.title) || to_tsvector(<span class="hljs-string">'english'</span>, posts.text) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">document</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-keyword">FROM</span> <span class="hljs-string">"posts"</span>) <span class="hljs-keyword">search</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">WHERE</span> search.document @@ to_tsquery(<span class="hljs-string">'Redis'</span>)</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ts_rank(search.document, to_tsquery(<span class="hljs-string">'english'</span>, <span class="hljs-string">'Redis'</span>)) <span class="hljs-keyword">DESC</span>;</td></table></code></pre>
<p>However, the performance is likely to be significantly worse using this approach as it has to recreate the document, and doesn’t have an existing index to query against. It’s also a pig to write something like this with an ORM.</p>
<p>I’m currently working on a more generic solution for implementing full text search with Postgres and Laravel, however so far it looks like that solution will not only be considerably more complex than this (consistently producing a suitable query for unknown data is rather fiddly), but you can’t create a column for the vector ahead of time, meaning the query will be slower. This approach, while it requires more work than simply installing a package, is not terribly hard to implement on a per-model basis and is easy to customise for your use case.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Building a postcode lookup client with HTTPlug and PHPSpec]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/">
        </link>
        <updated>2017-11-28T11:40:39Z</updated>
        <summary type="html"><![CDATA[<p>While PHPUnit is my normal go-to PHP testing framework, for some applications I find <a href="http://www.phpspec.net/en/stable/">PHPSpec</a> superior, in particular REST API clients. I’ve found that it makes for a better flow when doing test-driven development, because it makes it very natural to write a test first, then run it, then make the test pass.</p>
<p>In this tutorial I’ll show you how to build a lookup API client for UK postcodes. In the process of doing so, we’ll use PHPSpec to drive our development process. We’ll also use <a href="http://docs.php-http.org/en/latest/httplug/tutorial.html">HTTPlug</a> as our underlying HTTP library. The advantage of this over using something like Guzzle is that we give library users the freedom to choose the HTTP library they feel is most appropriate to their situation.</p>
<h2 id="background">Background</h2>
<p>If you’re unfamiliar with it, the UK postcode system is our equivalent of a zip code in the US, but with two major differences:</p>
<ul>
<li>The codes themselves are alphanumeric instead of numeric, with the first part including one or two letters usually (but not always) derived from the nearest large town or city (eg L for Liverpool, B for Birmingham, OX for Oxford), or for London, based on the part of the city (eg NW for the north-west of London)</li>
<li>A full postcode is in two parts (eg NW1 8TQ), and the first part narrows the location down to a similar area to a US-style zip code, while the second part usually narrows it down to a street (although sometimes large organisations that receive a lot of mail will have a postcode to themselves).</li>
</ul>
<p>This means that if you have someone’s postcode and house name or address, you can use those details to look up the rest of their address details. This obviously makes it easier for users to fill out a form, such as when placing an order on an e-commerce site - you can just request those two details and then autofill the rest from them.</p>
<p>Unfortunately, it’s not quite that simple. The data is owned by Royal Mail, and they charge through the nose for access to the raw data, which places this data well outside the budgets of many web app developers. Fortunately, <a href="https://ideal-postcodes.co.uk/">Ideal Postcodes</a> offer a REST API for querying this data. It’s not free, but at 2.5p per request it’s not going to break the bank unless used excessively, and they offer some dummy postcodes that are free to query, which is perfectly fine for testing.</p>
<p>For those of you outside the UK, this may not be of much immediate use, but the underlying principles will still be useful, and you can probably build a similar client for your own nation’s postal code system. For instance, there’s a <a href="https://www.zipcodeapi.com/API">Zipcode API</a> that those of you in the US can use, and if you understand what’s going on here it shouldn’t be hard to adapt it to work with that. If you do produce a similar client for your country’s postal code system, submit a pull request to update the README with a link to it and I’ll include it.</p>
<h2 id="setting-up">Setting up</h2>
<p>First we’ll create a <code>composer.json</code> to specify our dependencies:</p>
<pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/postcode-client"</span>,</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A postcode lookup client."</span>,</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"library"</span>,</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"keywords"</span>: [<span class="hljs-string">"postcode"</span>],</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attr">"require"</span>: {</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"psr/http-message"</span>: <span class="hljs-string">"^1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"php-http/client-implementation"</span>: <span class="hljs-string">"^1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">"php-http/httplug"</span>: <span class="hljs-string">"^1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-attr">"php-http/message-factory"</span>: <span class="hljs-string">"^1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-attr">"php-http/discovery"</span>: <span class="hljs-string">"^1.0"</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    },</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-attr">"psy/psysh"</span>: <span class="hljs-string">"^0.8.0"</span>,</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^3.2"</span>,</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-attr">"squizlabs/php_codesniffer"</span>: <span class="hljs-string">"^2.7"</span>,</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-attr">"php-http/mock-client"</span>: <span class="hljs-string">"^1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-attr">"php-http/message"</span>: <span class="hljs-string">"^1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attr">"guzzlehttp/psr7"</span>: <span class="hljs-string">"^1.0"</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    },</td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attr">"authors"</span>: [</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        {</td><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"matthewbdaly@gmail.com"</span></td><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    ],</td><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-attr">"Matthewbdaly\\Postcode\\"</span>: <span class="hljs-string">"src/"</span></td><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></table></code></pre>
<p>Note that we don’t install an actual HTTPlug client, other than the mock one, which is only useful for testing. This is deliberate - we’re giving developers working with this library the choice of working with whatever HTTP client they see fit. We do use the Guzzle PSR7 library, but that’s just for the PSR7 library.</p>
<p>Then we install our dependencies:</p>
<pre><code class="hljs lang-bash singleline">$ composer install</code></pre>
<p>We also need to tell PHPSpec what our namespace will be. Save this as <code>phpspec.yml</code>:</p>
<pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-symbol">suites:</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-symbol">    test_suite:</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-symbol">        namespace:</span> Matthewbdaly\Postcode</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-symbol">        psr4_prefix:</span> Matthewbdaly\Postcode</td></table></code></pre>
<p>Don’t forget to update the namespace in both files to whatever you’re using, which should have a vendor name and a package name.</p>
<p>With that done, it’s time to introduce the next component.</p>
<h2 id="introducing-httplug">Introducing HTTPlug</h2>
<p>In the past I’ve usually used either Curl or Guzzle to carry out HTTP requests. However, the problem with this approach is that you’re forcing whoever uses your library to use whatever HTTP client, and whatever version of that client, that you deem appropriate. If they’re also using another library that someone else has written and they made different choices, you could have problems.</p>
<p>HTTPlug is an excellent way of solving this problem. By requiring only an interface and not a concrete implementation, using HTTPlug means that you can specify that the consumer of the library must provide a suitable implementation of that library, but leave the choice of implementation up to them. This means that they can choose whatever implementation best fits their use case. There are <a href="http://docs.php-http.org/en/latest/clients.html">adapters for many different clients</a>, so it’s unlikely that they won’t be able to find one that meets their needs.</p>
<p>In addition, HTTPlug provides the means to automatically determine what HTTP client to use, so that if one is not explicitly provided, it can be resolved without any action on the part of the developer. As long as a suitable HTTP adapter is installed, it will be used.</p>
<h2 id="getting-started">Getting started</h2>
<p>One advantage of PHPSpec is that it will automatically generate much of the boilerplate for our client and specs. To create our client spec, run this command:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec desc Matthewbdaly/Postcode/Client</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Specification <span class="hljs-keyword">for</span> Matthewbdaly\Postcode\Client created <span class="hljs-keyword">in</span> /home/matthew/Projects/postcode-client/spec/ClientSpec.php.</td></table></code></pre>
<p>Now that we have a spec for our client, we can generate the client itself:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  11  - it is initializable</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      class Matthewbdaly\Postcode\Client does not exist.</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>                                      100%                                       1</td><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="8"></td><td>1 example (1 broken)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>14ms</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client` <span class="hljs-keyword">for</span> you?              </td><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td><tr><td class="linenos" data-pseudo-content="15"></td><td>Class Matthewbdaly\Postcode\Client created <span class="hljs-keyword">in</span> /home/matthew/Projects/postcode-client/src/Client.php.</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>                                      100%                                       1</td><tr><td class="linenos" data-pseudo-content="18"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="19"></td><td>1 example (1 passed)</td><tr><td class="linenos" data-pseudo-content="20"></td><td>16ms</td></table></code></pre>
<p>You will need to enter <code>Y</code> when prompted. We now have an empty class for our client.</p>
<p>Next, we need to make sure that the constructor for our client accepts two parameters:</p>
<ul>
<li>The HTTP client</li>
<li>A message factory instance, which is used to create the request</li>
</ul>
<p>Amend <code>spec/ClientSpec.php</code> as follows:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Client</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Client</span>\<span class="hljs-title">HttpClient</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageFactory</span>;</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">let</span> <span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory)</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(Client::class);</td><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="22"></td><td>}</td></table></code></pre>
<p>Note the use of the <code>let()</code> method here. This lets us specify how the object is constructed, with the <code>beConstructedWith()</code> method. Also, note that <code>$this</code> refers not to the test, but to the object being tested - this takes a bit of getting used to if you’re used to working with PHPUnit.</p>
<p>Also, note that the objects passed through are not actual instances of those objects - instead they are mocks created automatically by PHPSpec. This makes mocking extremely easy, and you can easily set up your own expectations on those mock objects in the test. If you want to use a real object, you can instantiate it in the spec as usual. If we need any other mocks, we can typehint them in our method in exactly the same way.</p>
<p>If we once again use <code>vendor/bin/phpspec run</code> we can now generate a constructor:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  18  - it is initializable</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::__construct not found.</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>                                      100%                                       1</td><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="8"></td><td>1 example (1 broken)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>281ms</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::__construct()` <span class="hljs-keyword">for</span>    </td><tr><td class="linenos" data-pseudo-content="13"></td><td>  you?                                                                          </td><tr><td class="linenos" data-pseudo-content="14"></td><td>                                                                         [Y/n] </td><tr><td class="linenos" data-pseudo-content="15"></td><td>y</td><tr><td class="linenos" data-pseudo-content="16"></td><td>  Method Matthewbdaly\Postcode\Client::__construct() has been created.</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>                                      100%                                       1</td><tr><td class="linenos" data-pseudo-content="19"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="20"></td><td>1 example (1 passed)</td><tr><td class="linenos" data-pseudo-content="21"></td><td>50ms</td></table></code></pre>
<p>This will only create a placeholder for the constructor. You need to populate it yourself, so update <code>src/Client.php</code> as follows:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Client</span>\<span class="hljs-title">HttpClient</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Discovery</span>\<span class="hljs-title">HttpClientDiscovery</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageFactory</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Discovery</span>\<span class="hljs-title">MessageFactoryDiscovery</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(HttpClient $client = null, MessageFactory $messageFactory = null)</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;client = $client ?: HttpClientDiscovery::find();</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;messageFactory = $messageFactory ?: MessageFactoryDiscovery::find();</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></table></code></pre>
<p>A little explanation is called for here. We need two arguments in our construct:</p>
<ul>
<li>An instance of <code>Http\Client\HttpClient</code> to send the request</li>
<li>An instance of <code>Http\Message\MessageFactory</code> to create the request</li>
</ul>
<p>However, we don’t want to force the user to create one. Therefore if they are not set, we use <code>Http\Discovery\HttpClientDiscovery</code> and <code>Http\Discovery\MessageFactoryDiscovery</code> to create them for us.</p>
<p>If we re-run PHPSpec, it should now pass:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       1</td><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="4"></td><td>1 example (1 passed)</td><tr><td class="linenos" data-pseudo-content="5"></td><td>31ms</td></table></code></pre>
<p>Next, we want to have a method for retrieving the endpoint. Add the following method to <code>spec/ClientSpec.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_retrieve_the_base_url</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getBaseUrl()-&gt;shouldReturn(<span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></table></code></pre>
<p>Here we’re asserting that fetching the base URL returns the given result. Note how much simpler and more intuitive this syntax is than PHPUnit would be:</p>
<pre><code class="hljs lang-php singleline"><span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>, $client-&gt;getBaseUrl());</code></pre>
<p>Running the tests again should prompt us to create the boilerplate for the new method:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  23  - it can retrieve the base url</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::getBaseUrl not found.</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>                  50%                                     50%                    2</td><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="8"></td><td>2 examples (1 passed, 1 broken)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>40ms</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::getBaseUrl()` <span class="hljs-keyword">for</span>     </td><tr><td class="linenos" data-pseudo-content="13"></td><td>  you?                                                                          </td><tr><td class="linenos" data-pseudo-content="14"></td><td>                                                                         [Y/n] </td><tr><td class="linenos" data-pseudo-content="15"></td><td>y</td><tr><td class="linenos" data-pseudo-content="16"></td><td>  Method Matthewbdaly\Postcode\Client::getBaseUrl() has been created.</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="19"></td><td>  23  - it can retrieve the base url</td><tr><td class="linenos" data-pseudo-content="20"></td><td>      expected <span class="hljs-string">"https://api.ideal-postcod..."</span>, but got null.</td><tr><td class="linenos" data-pseudo-content="21"></td><td></td><tr><td class="linenos" data-pseudo-content="22"></td><td>                  50%                                     50%                    2</td><tr><td class="linenos" data-pseudo-content="23"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="24"></td><td>2 examples (1 passed, 1 failed)</td><tr><td class="linenos" data-pseudo-content="25"></td><td>72ms</td></table></code></pre>
<p>Now we need to update that method to work as expected:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $baseUrl = <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>     ...</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBaseUrl</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;baseUrl;</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></table></code></pre>
<p>This should make the tests pass:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       2</td><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="4"></td><td>2 examples (2 passed)</td><tr><td class="linenos" data-pseudo-content="5"></td><td>34ms</td></table></code></pre>
<p>Next, we need to be able to get and set the API key. Add the following to <code>spec/ClientSpec.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_get_and_set_the_key</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getKey()-&gt;shouldReturn(<span class="hljs-keyword">null</span>);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>)-&gt;shouldReturn(<span class="hljs-keyword">$this</span>);</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getKey()-&gt;shouldReturn(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></table></code></pre>
<p>Note that we expect <code>$this-&gt;setKey(&#39;foo&#39;)</code> to return <code>$this</code>. This is an example of a <em>fluent</em> interface - by returning an instance of the object, it enables methods to be chained, eg <code>$client-&gt;setKey(&#39;foo&#39;)-&gt;get()</code>. Obviously it won’t work for anything that has to return a value, but it’s a useful way of making your classes more intuitive to use.</p>
<p>Next, run the tests again and agree to the prompts as before:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::getKey not found.</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>                         66%                                     33%             3</td><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="8"></td><td>3 examples (2 passed, 1 broken)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>51ms</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::getKey()` <span class="hljs-keyword">for</span> you?    </td><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td><tr><td class="linenos" data-pseudo-content="15"></td><td>  Method Matthewbdaly\Postcode\Client::getKey() has been created.</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="18"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td><tr><td class="linenos" data-pseudo-content="19"></td><td>      method Matthewbdaly\Postcode\Client::<span class="hljs-built_in">set</span>Key not found.</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>                         66%                                     33%             3</td><tr><td class="linenos" data-pseudo-content="22"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="23"></td><td>3 examples (2 passed, 1 broken)</td><tr><td class="linenos" data-pseudo-content="24"></td><td>43ms</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td></td><tr><td class="linenos" data-pseudo-content="27"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::<span class="hljs-built_in">set</span>Key()` <span class="hljs-keyword">for</span> you?    </td><tr><td class="linenos" data-pseudo-content="28"></td><td>                                                                         [Y/n] </td><tr><td class="linenos" data-pseudo-content="29"></td><td>y</td><tr><td class="linenos" data-pseudo-content="30"></td><td>  Method Matthewbdaly\Postcode\Client::<span class="hljs-built_in">set</span>Key() has been created.</td><tr><td class="linenos" data-pseudo-content="31"></td><td></td><tr><td class="linenos" data-pseudo-content="32"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="33"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td><tr><td class="linenos" data-pseudo-content="34"></td><td>      expected [obj:Matthewbdaly\Postcode\Client], but got null.</td><tr><td class="linenos" data-pseudo-content="35"></td><td></td><tr><td class="linenos" data-pseudo-content="36"></td><td>                         66%                                     33%             3</td><tr><td class="linenos" data-pseudo-content="37"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="38"></td><td>3 examples (2 passed, 1 failed)</td><tr><td class="linenos" data-pseudo-content="39"></td><td>52ms</td></table></code></pre>
<p>Next, add our getter and setter for the key, as well as declaring the property <code>$key</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $key;</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getKey</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;key;</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setKey</span><span class="hljs-params">(string $key)</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">$this</span>-&gt;key = $key;</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></table></code></pre>
<p>That should make the tests pass:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       3</td><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="4"></td><td>3 examples (3 passed)</td><tr><td class="linenos" data-pseudo-content="5"></td><td>38ms</td></table></code></pre>
<p>With that done, our final task is to be able to handle sending requests. Add the following imports at the top of <code>spec/ClientSpec.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">RequestInterface</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">ResponseInterface</span>;</td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">StreamInterface</span>;</td></table></code></pre>
<p>And add the following method at the bottom of the same file:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_send_the_request</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        $data = json_encode([</td><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'result'</span> =&gt; [</td><tr><td class="linenos" data-pseudo-content="7"></td><td>                <span class="hljs-string">"postcode"</span> =&gt; <span class="hljs-string">"SW1A 2AA"</span>,</td><tr><td class="linenos" data-pseudo-content="8"></td><td>                <span class="hljs-string">"postcode_inward"</span> =&gt; <span class="hljs-string">"2AA"</span>,</td><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-string">"postcode_outward"</span> =&gt; <span class="hljs-string">"SW1A"</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-string">"post_town"</span> =&gt; <span class="hljs-string">"LONDON"</span>,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-string">"dependant_locality"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="12"></td><td>                <span class="hljs-string">"double_dependant_locality"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-string">"thoroughfare"</span> =&gt; <span class="hljs-string">"Downing Street"</span>,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">"dependant_thoroughfare"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="15"></td><td>                <span class="hljs-string">"building_number"</span> =&gt; <span class="hljs-string">"10"</span>,</td><tr><td class="linenos" data-pseudo-content="16"></td><td>                <span class="hljs-string">"building_name"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="17"></td><td>                <span class="hljs-string">"sub_building_name"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="18"></td><td>                <span class="hljs-string">"po_box"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="19"></td><td>                <span class="hljs-string">"department_name"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="20"></td><td>                <span class="hljs-string">"organisation_name"</span> =&gt; <span class="hljs-string">"Prime Minister &amp; First Lord Of The Treasury"</span>,</td><tr><td class="linenos" data-pseudo-content="21"></td><td>                <span class="hljs-string">"udprn"</span> =&gt; <span class="hljs-number">23747771</span>,</td><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">"umprn"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="23"></td><td>                <span class="hljs-string">"postcode_type"</span> =&gt; <span class="hljs-string">"L"</span>,</td><tr><td class="linenos" data-pseudo-content="24"></td><td>                <span class="hljs-string">"su_organisation_indicator"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="25"></td><td>                <span class="hljs-string">"delivery_point_suffix"</span> =&gt; <span class="hljs-string">"1A"</span>,</td><tr><td class="linenos" data-pseudo-content="26"></td><td>                <span class="hljs-string">"line_1"</span> =&gt; <span class="hljs-string">"Prime Minister &amp; First Lord Of The Treasury"</span>,</td><tr><td class="linenos" data-pseudo-content="27"></td><td>                <span class="hljs-string">"line_2"</span> =&gt; <span class="hljs-string">"10 Downing Street"</span>,</td><tr><td class="linenos" data-pseudo-content="28"></td><td>                <span class="hljs-string">"line_3"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="29"></td><td>                <span class="hljs-string">"premise"</span> =&gt; <span class="hljs-string">"10"</span>,</td><tr><td class="linenos" data-pseudo-content="30"></td><td>                <span class="hljs-string">"longitude"</span> =&gt; <span class="hljs-number">-0.127695242183412</span>,</td><tr><td class="linenos" data-pseudo-content="31"></td><td>                <span class="hljs-string">"latitude"</span> =&gt; <span class="hljs-number">51.5035398826274</span>,</td><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-string">"eastings"</span> =&gt; <span class="hljs-number">530047</span>,</td><tr><td class="linenos" data-pseudo-content="33"></td><td>                <span class="hljs-string">"northings"</span> =&gt; <span class="hljs-number">179951</span>,</td><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-string">"country"</span> =&gt; <span class="hljs-string">"England"</span>,</td><tr><td class="linenos" data-pseudo-content="35"></td><td>                <span class="hljs-string">"traditional_county"</span> =&gt; <span class="hljs-string">"Greater London"</span>,</td><tr><td class="linenos" data-pseudo-content="36"></td><td>                <span class="hljs-string">"administrative_county"</span> =&gt; <span class="hljs-string">""</span>,</td><tr><td class="linenos" data-pseudo-content="37"></td><td>                <span class="hljs-string">"postal_county"</span> =&gt; <span class="hljs-string">"London"</span>,</td><tr><td class="linenos" data-pseudo-content="38"></td><td>                <span class="hljs-string">"county"</span> =&gt; <span class="hljs-string">"London"</span>,</td><tr><td class="linenos" data-pseudo-content="39"></td><td>            ]</td><tr><td class="linenos" data-pseudo-content="40"></td><td>        ]);</td><tr><td class="linenos" data-pseudo-content="41"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td><tr><td class="linenos" data-pseudo-content="42"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td><tr><td class="linenos" data-pseudo-content="43"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">200</span>);</td><tr><td class="linenos" data-pseudo-content="44"></td><td>        $response-&gt;getBody()-&gt;willReturn($stream);</td><tr><td class="linenos" data-pseudo-content="45"></td><td>        $stream-&gt;getContents()-&gt;willReturn($data);</td><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'SW1A 2AA'</span>)-&gt;shouldBeLike(json_decode($data, <span class="hljs-keyword">true</span>));</td><tr><td class="linenos" data-pseudo-content="47"></td><td>    }</td></table></code></pre>
<p>This test is by far the biggest so far, so it merits some degree of explanation.</p>
<p>Note that we don’t make a real HTTP request against the API. This may sound strange, but bear with me. We have no control whatsoever over that API, and it could in theory become inaccessible or be subject to breaking changes at any time. We also don’t want to be shelling out for a paid service just to test our API client works. All we can do is test that our implementation will send the request we expect it to send - we don’t want our test suite reporting a bug when the API goes down.</p>
<p>We therefore typehint not just the dependencies for the constructor, but a request, response and stream instance. We mock our our responses from those instances using the <code>willReturn()</code> method, so we have complete control over what we pass to our client. That way we can return any appropriate response or throw any exception we deem fit to test the behaviour under those circumstances. For the message factory, we specify what arguments it should receive to create the request, and return our mocked-out request object.</p>
<p>Also, note we use <code>shouldBeLike()</code> to verify the response - this is effectively using the <code>==</code> operator, whereas <code>shouldBe()</code> uses the <code>===</code> operator, making it stricter.</p>
<p>Let’s run the tests, and don’t forget the prompt:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-number">38</span>  - it can send the request</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::get not found.</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>                            <span class="hljs-number">75</span>%                                     <span class="hljs-number">25</span>%          <span class="hljs-number">4</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-number">1</span> specs</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-number">4</span> examples (<span class="hljs-number">3</span> passed, <span class="hljs-number">1</span> broken)</td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-number">55</span>ms</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-keyword">Do</span> you want me to create `Matthewbdaly\Postcode\Client::get()` <span class="hljs-keyword">for</span> you?       </td><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td><tr><td class="linenos" data-pseudo-content="15"></td><td>  Method Matthewbdaly\Postcode\Client::get() has been created.</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-number">38</span>  - it can send the request</td><tr><td class="linenos" data-pseudo-content="19"></td><td>      expected [<span class="hljs-keyword">array</span>:<span class="hljs-number">1</span>], but got <span class="hljs-keyword">null</span>.</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>                            <span class="hljs-number">75</span>%                                     <span class="hljs-number">25</span>%          <span class="hljs-number">4</span></td><tr><td class="linenos" data-pseudo-content="22"></td><td><span class="hljs-number">1</span> specs</td><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-number">4</span> examples (<span class="hljs-number">3</span> passed, <span class="hljs-number">1</span> failed)</td><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-number">56</span>ms</td></table></code></pre>
<p>Now we can implement the <code>get()</code> method:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        ]);</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">'GET'</span>,</td><tr><td class="linenos" data-pseudo-content="8"></td><td>            $url,</td><tr><td class="linenos" data-pseudo-content="9"></td><td>            [],</td><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-keyword">null</span>,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-string">'1.1'</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>        );</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> $data;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></table></code></pre>
<p>We first build up our URL, before using the message factory to create a request object. We then pass the built request to our client to send, before decoding the response into the format we want.</p>
<p>This should make our tests pass:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       4</td><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="4"></td><td>4 examples (4 passed)</td><tr><td class="linenos" data-pseudo-content="5"></td><td>307ms</td></table></code></pre>
<p>Our client now works, but there are a couple of situations we need to account for. First, the API will raise a 402 if you make a request for a real postcode without having paid. We need to catch this and throw an exception. Add this to <code>spec/ClientSpec.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PaymentRequired</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_throws_an_exception_if_payment_required</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">402</span>);</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(PaymentRequired::class)-&gt;duringGet(<span class="hljs-string">'SW1A 2AA'</span>);</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></table></code></pre>
<p>With that done, run the tests again:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  87  - it throws an exception <span class="hljs-keyword">if</span> payment required</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got</td><tr><td class="linenos" data-pseudo-content="5"></td><td>      [exc:Prophecy\Exception\Call\UnexpectedCallException(<span class="hljs-string">"Method call:</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        - getBody()</td><tr><td class="linenos" data-pseudo-content="7"></td><td>      on Double\ResponseInterface\P15 was not expected, expected calls were:</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        - getStatusCode()"</span>)].</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td>                              80%                                     20%        5</td><tr><td class="linenos" data-pseudo-content="11"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="12"></td><td>5 examples (4 passed, 1 failed)</td><tr><td class="linenos" data-pseudo-content="13"></td><td>130ms</td></table></code></pre>
<p>Let’s amend the client to throw this exception:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PaymentRequired</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        ]);</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-string">'GET'</span>,</td><tr><td class="linenos" data-pseudo-content="12"></td><td>            $url,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            [],</td><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-keyword">null</span>,</td><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-string">'1.1'</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td>        );</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">402</span>) {</td><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PaymentRequired;</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> $data;</td><tr><td class="linenos" data-pseudo-content="23"></td><td>    }</td></table></code></pre>
<p>And let’s re-run the tests:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  87  - it throws an exception <span class="hljs-keyword">if</span> payment required</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got [obj:Error] with the</td><tr><td class="linenos" data-pseudo-content="5"></td><td>      message: <span class="hljs-string">"Class 'Matthewbdaly\Postcode\Exceptions\PaymentRequired' not found"</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>                              80%                                     20%        5</td><tr><td class="linenos" data-pseudo-content="8"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="9"></td><td>5 examples (4 passed, 1 failed)</td><tr><td class="linenos" data-pseudo-content="10"></td><td>389ms</td></table></code></pre>
<p>It fails now because the exception doesn’t exist. Let’s create it at <code>src/Exceptions/PaymentRequired.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentRequired</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td></table></code></pre>
<p>That should be enough to make our tests pass:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       5</td><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="4"></td><td>5 examples (5 passed)</td><tr><td class="linenos" data-pseudo-content="5"></td><td>89ms</td></table></code></pre>
<p>We also need to raise an exception when the postcode is not found, which raises a 404 error. Add the following spec:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PostcodeNotFound</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_throws_an_exception_if_postcode_not_found</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">404</span>);</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(PostcodeNotFound::class)-&gt;duringGet(<span class="hljs-string">'SW1A 2AA'</span>);</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    }</td></table></code></pre>
<p>Run the tests:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td><tr><td class="linenos" data-pseudo-content="3"></td><td>  98  - it throws an exception <span class="hljs-keyword">if</span> postcode not found</td><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got</td><tr><td class="linenos" data-pseudo-content="5"></td><td>      [exc:Prophecy\Exception\Call\UnexpectedCallException(<span class="hljs-string">"Method call:</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        - getBody()</td><tr><td class="linenos" data-pseudo-content="7"></td><td>      on Double\ResponseInterface\P20 was not expected, expected calls were:</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        - getStatusCode()"</span>)].</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td>                                83%                                     16%      6</td><tr><td class="linenos" data-pseudo-content="11"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="12"></td><td>6 examples (5 passed, 1 failed)</td><tr><td class="linenos" data-pseudo-content="13"></td><td>538ms</td></table></code></pre>
<p>This time we’ll create the exception class before updating the client. Create the following class at <code>src/Exceptions/PostcodeNotFound.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="6"></td><td> * Postcode not found exception</td><tr><td class="linenos" data-pseudo-content="7"></td><td> *</td><tr><td class="linenos" data-pseudo-content="8"></td><td> */</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostcodeNotFound</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></table></code></pre>
<p>And update the client:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PostcodeNotFound</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        ]);</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-string">'GET'</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>            $url,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>            [],</td><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">null</span>,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'1.1'</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>        );</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">402</span>) {</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PaymentRequired;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">404</span>) {</td><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PostcodeNotFound;</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> $data;</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></table></code></pre>
<p>Re-run the tests:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       6</td><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td><tr><td class="linenos" data-pseudo-content="4"></td><td>6 examples (6 passed)</td><tr><td class="linenos" data-pseudo-content="5"></td><td>103ms</td></table></code></pre>
<p>And our API client is feature complete! You can find the source code of the finished client <a href="https://github.com/matthewbdaly/postcode-client">here</a>.</p>
<h2 id="summary">Summary</h2>
<p>Personally, I find that while PHPSpec isn’t appropriate for every use case, it’s particularly handy for API clients and it’s generally my go-to testing solution for them. It handles producing a lot of the boilerplate for me, and it results in a much better workflow for test-driven development as it makes it very natural to write the test first, then make it pass.</p>
<p>HTTPlug has been a revelation for me. While it takes a bit of getting used to if you’re used to something like Guzzle, it means that you’re giving consumers of your library the freedom to choose the HTTP client of their choice, meaning they don’t have to fight with several different libraries requiring different versions of Guzzle. It also allows for easy resolution of the HTTP client, rather than having to explicitly pass through an instance when instantiating your client. I’m planning to use it extensively in the future.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Creating custom assertions with PHPUnit]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/11/16/creating-custom-assertions-with-phpunit/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/11/16/creating-custom-assertions-with-phpunit/">
        </link>
        <updated>2017-11-16T15:15:50Z</updated>
        <summary type="html"><![CDATA[<p>Today I’ve been working on a library I’m building for making it easier to build RESTful API’s with Laravel. It uses an abstract RESTful controller, which inherits from the default Laravel controller, and I wanted to verify that the instantiated controller includes all the traits from the base controller.</p>
<p>However, there was a problem. The only practical way to verify that a class includes a trait is with the <code>class_uses()</code> function, but this doesn’t work if the class inherits from a parent that includes these traits. As the class is abstract, it can’t be instantiated directly, so you must either create a dummy class just for testing that extends it, or mock the class, and that means that <code>class_uses()</code> won’t work. As a result, I needed to first get the parent class, then call <code>class_uses()</code> on that, which is possible, but a bit verbose to do repeatedly for several tests.</p>
<p>Fortunately it’s quite easy to create your own custom assertions in PHPUnit. I started out by setting up the test with the assertion I wanted to have:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RestfulControllerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testTraits</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        $controller = m::mock(<span class="hljs-string">'Matthewbdaly\Harmony\Http\Controllers\RestfulController'</span>)-&gt;makePartial();</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertParentHasTrait(<span class="hljs-string">'Illuminate\Foundation\Bus\DispatchesJobs'</span>, $controller);</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertParentHasTrait(<span class="hljs-string">'Illuminate\Foundation\Validation\ValidatesRequests'</span>, $controller);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertParentHasTrait(<span class="hljs-string">'Illuminate\Foundation\Auth\Access\AuthorizesRequests'</span>, $controller);</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></table></code></pre>
<p>Actually implementing the assertion is fairly straightforward. You simply add the assertion as a method on the base test case you’re using. and accept whatever arguments are required, plus a final argument of <code>$message = &#39;&#39;</code>. Then you call <code>self::assertThat()</code>, as demonstrated below:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assertParentHasTrait</span><span class="hljs-params">($trait, $class, $message = <span class="hljs-string">''</span>)</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        $parent = get_parent_class($class);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>        $traits = class_uses($parent);</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">self</span>::assertThat(in_array($trait, $traits), <span class="hljs-keyword">self</span>::isTrue(), $message);</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></table></code></pre>
<p>In this case we’re asserting that the specified trait appears in the list of traits on the parent class. Note the use of <code>self::isTrue()</code> - this just verifies that the response is truthy.</p>
<p>Using this method it’s quite easy to create custom assertions, which can help make your tests less verbose and easier to read.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Catching debug statements in PHP]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/11/06/catching-debug-statements-in-php/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/11/06/catching-debug-statements-in-php/">
        </link>
        <updated>2017-11-06T12:00:18Z</updated>
        <summary type="html"><![CDATA[<p>It’s unfortunately quite easy to neglect to remove debugging statements in PHP code. I’ve done so many times myself, and it’s not unknown for these to wind up in production. After I saw it happen again recently, I decided to look around for a way to prevent it happening.</p>
<p><a href="/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/">As mentioned earlier</a>, I generally use PHP CodeSniffer to enforce a coding standard on my projects, and it’s easy to set it up and run it. With a little work, you can also use it to catch these unwanted debugging statements before they get committed.</p>
<p>First, you need to make sure <code>squizlabs/php_codesniffer</code> is included in your project’s development dependencies in <code>composer.json</code>. Then, create a <code>phpcs.xml</code> file that looks something like this:</p>
<pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Coding standard.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>src<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.Commenting.FunctionComment"</span> /&gt;</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.Commenting.FunctionCommentThrowTag"</span> /&gt;</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.Commenting.ClassComment"</span> /&gt;</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.PHP.ForbiddenFunctions"</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"forbiddenFunctions"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"array"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"eval=&gt;NULL,dd=&gt;NULL,die=&gt;NULL,var_dump=&gt;NULL,sizeof=&gt;count,delete=&gt;unset,print=&gt;echo,create_function=&gt;NULL"</span>/&gt;</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></table></code></pre>
<p>The key is the rule <code>Squiz.PHP.ForbiddenFunctions</code>. This allows us to define a list of functions that are forbidden in our project. Typically this will be things like <code>die()</code>, <code>eval()</code>, <code>var_dump()</code> and <code>dd()</code>.</p>
<p>Now, this ruleset will catch the unwanted functions (as well as enforcing PSR2 and certain rules about comments), but we can’t guarantee that we’ll always remember to run it. We could run CodeSniffer in continuous integration (and this is a good idea anyway), but that doesn’t stop us from committing code with those forbidden functions. We need a way to ensure that CodeSniffer runs on every commit and doesn’t allow it to go ahead if it fails. To do that we can use a pre-commit hook. Save the following in your repository as <code>.git/hooks/pre-commit</code>:</p>
<pre><code class="hljs lang-bash singleline">vendor/bin/phpcs</code></pre>
<p>Then run the following command to make it executable:</p>
<pre><code class="hljs lang-bash singleline">$ chmod +x .git/hooks/pre-commit</code></pre>
<p>A pre-commit hook is run before every commit, and if it returns false, will not allow the commit to go ahead. That means that if CodeSniffer fails for any reason, we will have to go back and fix the problem before we can commit. If for some reason you do need to bypass this check, you can still do so by using the <code>--no-verify</code> flag with <code>git commit</code>.</p>
<p>The advantage of this method is that it’s not dependent on any one IDE or editor, so it’s widely applicable. However, if you’re doing this sort of thing with Git hooks, you may want to look at some of the solutions for managing hooks, since <code>.git/hooks</code> is outside the actual Git repository.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[An Azure Filesystem integration for Laravel]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/10/29/an-azure-filesystem-integration-for-laravel/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/10/29/an-azure-filesystem-integration-for-laravel/">
        </link>
        <updated>2017-10-29T19:31:34Z</updated>
        <summary type="html"><![CDATA[<p><a href="/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/">My earlier post about integrating Laravel and Azure storage</a> seems to have become something of a go-to resource on this subject (I suspect this is because very few developers actually use Laravel and Azure together). Unfortunately it hasn’t really aged terribly well - changes to the namespace and to Guzzle mean that it needs some work to integrate it.</p>
<p>I’ve therefore <a href="https://github.com/matthewbdaly/laravel-azure-storage">created a package for it</a>. That way, it’s easier to keep it up to date as if someone finds and fixes an issue with it, they can submit their changes back.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Using phpiredis with Laravel]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/10/20/using-phpiredis-with-laravel/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/10/20/using-phpiredis-with-laravel/">
        </link>
        <updated>2017-10-20T21:55:26Z</updated>
        <summary type="html"><![CDATA[<p>Laravel has support out of the box for using Redis. However, by default it uses a Redis client written in PHP, which will always be a little slower than one written in C. If you’re making heavy use of Redis, it may be worth using the <a href="https://github.com/nrk/phpiredis">phpiredis</a> extension to squeeze a little more performance out of it.</p>
<p>I’m using PHP 7.0 on Ubuntu Zesty and I installed the dependencies with the following command:</p>
<pre><code class="hljs lang-bash singleline">$ sudo apt-get install libhiredis-dev php-redis php7.0-dev</code></pre>
<p>Then I installed phpiredis as follows:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>git <span class="hljs-built_in">clone</span> https://github.com/nrk/phpiredis.git &amp;&amp; \</td><tr><td class="linenos" data-pseudo-content="2"></td><td>       <span class="hljs-built_in">cd</span> phpiredis &amp;&amp; \</td><tr><td class="linenos" data-pseudo-content="3"></td><td>       phpize &amp;&amp; \</td><tr><td class="linenos" data-pseudo-content="4"></td><td>       ./configure --enable-phpiredis &amp;&amp; \</td><tr><td class="linenos" data-pseudo-content="5"></td><td>       make &amp;&amp; \</td><tr><td class="linenos" data-pseudo-content="6"></td><td>       sudo make install</td></table></code></pre>
<p>Finally, I configured Redis to use phpiredis in the <code>redis</code> section of <code>config/database.php</code> for a Laravel app:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-string">'redis'</span> =&gt; [</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'cluster'</span> =&gt; <span class="hljs-keyword">false</span>,</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-string">'default'</span> =&gt; [</td><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'host'</span>     =&gt; env(<span class="hljs-string">'REDIS_HOST'</span>, <span class="hljs-string">'localhost'</span>),</td><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">'password'</span> =&gt; env(<span class="hljs-string">'REDIS_PASSWORD'</span>, <span class="hljs-keyword">null</span>),</td><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">'port'</span>     =&gt; env(<span class="hljs-string">'REDIS_PORT'</span>, <span class="hljs-number">6379</span>),</td><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-string">'database'</span> =&gt; <span class="hljs-number">0</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-string">'options'</span> =&gt; [</td><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-string">'connections'</span> =&gt; [</td><tr><td class="linenos" data-pseudo-content="12"></td><td>                    <span class="hljs-string">'tcp'</span> =&gt; <span class="hljs-string">'Predis\Connection\PhpiredisStreamConnection'</span>, <span class="hljs-comment">// PHP streams</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>                    <span class="hljs-string">'unix'</span> =&gt; <span class="hljs-string">'Predis\Connection\PhpiredisSocketConnection'</span>, <span class="hljs-comment">// ext-socket</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>                ],</td><tr><td class="linenos" data-pseudo-content="15"></td><td>            ]</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        ],</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    ],</td></table></code></pre>
<p>Now, I’m going to be honest - in a casual comparison I couldn’t see much difference in terms of speed. I would probably only bother with setting this up on a site where high Redis performance was absolutely necessary. If you just want a quicker cache response it might make more sense to put Varnish in front of the site instead. However, in cases where Redis gets used heavily, it’s probably worth doing.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Simple fuzzy search with Laravel and PostgreSQL]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">
        </link>
        <updated>2017-10-03T22:56:11Z</updated>
        <summary type="html"><![CDATA[<p>When implementing fuzzy search, many developers reach straight for specialised tools like Elasticsearch. However, for simple implementations, this is often overkill. PostgreSQL, my relational database of choice, can natively handle fuzzy search quite easily if you know how. Here’s how you might use this with Laravel.</p>
<p>Suppose we have the following migration to create a <code>locations</code> table, storing towns, cities and villages:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateLocations</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="9"></td><td>     * Run the migrations.</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-comment">// Create locations table</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'locations'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;increments(<span class="hljs-string">'id'</span>)-&gt;unsigned();</td><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'name'</span>);</td><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;timestamps();</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Reverse the migrations.</td><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Drop locations table</span></td><tr><td class="linenos" data-pseudo-content="31"></td><td>        Schema::drop(<span class="hljs-string">'locations'</span>);</td><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></table></code></pre>
<p>The key to this implementation of fuzzy search is <em>trigrams</em>. A trigram is a group of three consecutive characters taken from a string. Using the <code>pg_trgm</code> module, which comes with PostgreSQL, we can break a string into as many trigrams as possible, and then return the strings with the most matching trigrams.</p>
<p>We can ensure that <code>pg_trgm</code> is set up on the database by creating a migration:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddTrgmExtension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS pg_trgm'</span>);</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Reverse the migrations.</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">'DROP EXTENSION IF EXISTS pg_trgm'</span>);</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></table></code></pre>
<p>Make sure you run the migration as well. Once that is done, we can make a raw fuzzy query against the <code>name</code> field as follows:</p>
<pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locations <span class="hljs-keyword">WHERE</span> <span class="hljs-string">'burgh'</span> % <span class="hljs-keyword">name</span>;</code></pre>
<p>Translating that to work with the Eloquent ORM, we can perform fuzzy queries against the <code>name</code> field as follows:</p>
<pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"'burgh' % name"</span>)-&gt;get();</code></pre>
<p>This query might match both <code>Aldeburgh</code> and <code>Edinburgh</code>. It’s also able to handle slight misspellings, as in this example:</p>
<pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"'hendrad' % name"</span>)-&gt;get();</code></pre>
<p>This query will match <code>East Hendred</code> or <code>West Hendred</code> successfully. As you can see, we can match strings at any point in the name string, and handle slight mis-spellings without any problems.</p>
<p>In practice, rather than using <code>whereRaw()</code> every time, you’ll probably want to create a local scope that accepts the name you want to match against. You’ll also want to use query parameters to prevent SQL injection:</p>
<pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"? % name"</span>, [$name])-&gt;get();</code></pre>
<h2 id="improving-performance-with-an-index">Improving performance with an index</h2>
<p>The performance of these queries isn’t that great out of the box. We can improve them by creating an index:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddTrgmExtension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS pg_trgm'</span>);</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        DB::statement(<span class="hljs-string">'CREATE INDEX locations_name_trigram ON locations USING gist(name gist_trgm_ops);'</span>);</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Reverse the migrations.</td><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        DB::statement(<span class="hljs-string">'DROP INDEX IF EXISTS locations_name_trigram'</span>);</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        DB::statement(<span class="hljs-string">'DROP EXTENSION IF EXISTS pg_trgm'</span>);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></table></code></pre>
<p>Adding an index should produce a noticeable improvement in the response time.</p>
<h2 id="final-thoughts">Final thoughts</h2>
<p>PostgreSQL’s <code>pg_trgm</code> module is a fairly straightforward way of implementing fuzzy search. It’s not much more involved than a <code>LIKE</code> or <code>ILIKE</code> clause in your query, and for many use cases, it’s more than sufficient. If you don’t have a huge number of records, it’s probably a more appropriate choice than something like Elasticsearch, and has the advantage of a simpler stack. However, if you have a larger dataset, you may be better off with a dedicated search solution. As always, if you’re unsure it’s a good idea to try both and see what works best for that particular use case.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[A generic PHP SMS library]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/09/25/a-generic-php-sms-library/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/09/25/a-generic-php-sms-library/">
        </link>
        <updated>2017-09-25T21:18:18Z</updated>
        <summary type="html"><![CDATA[<p>This weekend I published <a href="https://github.com/matthewbdaly/sms-client">sms-client</a>, a generic PHP library for sending SMS notifications. It’s intended to offer a consistent interface when sending SMS notifications by using swappable drivers. That way, if your SMS service provider suddenly goes out of business or bumps up their prices, it’s easy to switch to a new one.</p>
<p>Out of the box it comes with drivers for the following services:</p>
<ul>
<li>Nexmo</li>
<li>ClockworkSMS</li>
</ul>
<p>In addition, it provides the following test drivers:</p>
<ul>
<li>Null</li>
<li>Log</li>
<li>RequestBin</li>
</ul>
<p>Here’s an example of how you might use it with the ClockworkSMS driver:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Client</span> <span class="hljs-title">as</span> <span class="hljs-title">GuzzleClient</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Psr7</span>\<span class="hljs-title">Response</span>;</td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">SMS</span>\<span class="hljs-title">Drivers</span>\<span class="hljs-title">Clockwork</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">SMS</span>\<span class="hljs-title">Client</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>$guzzle = <span class="hljs-keyword">new</span> GuzzleClient;</td><tr><td class="linenos" data-pseudo-content="7"></td><td>$resp = <span class="hljs-keyword">new</span> Response;</td><tr><td class="linenos" data-pseudo-content="8"></td><td>$driver = <span class="hljs-keyword">new</span> Clockwork($guzzle, $resp, [</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-string">'MY_CLOCKWORK_API_KEY'</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>]);</td><tr><td class="linenos" data-pseudo-content="11"></td><td>$client = <span class="hljs-keyword">new</span> Client($driver);</td><tr><td class="linenos" data-pseudo-content="12"></td><td>$msg = [</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-string">'to'</span>      =&gt; <span class="hljs-string">'+44 01234 567890'</span>,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-string">'content'</span> =&gt; <span class="hljs-string">'Just testing'</span>,</td><tr><td class="linenos" data-pseudo-content="15"></td><td>];</td><tr><td class="linenos" data-pseudo-content="16"></td><td>$client-&gt;send($msg);</td></table></code></pre>
<p>If you want to roll your own driver for it, it should be easy - just create a class that implements the <code>Matthewbdaly\SMS\Contracts\Driver</code> interface. Most of the existing drivers work using Guzzle to send HTTP requests to an API, but you don’t necessarily have to do that - for instance, you could create a driver for a mail-to-SMS gateway by using Swiftmailer or the PHP mail class. If you create a driver for it, please feel free to submit a pull request so I can add it to the repository.</p>
<p>For Laravel or Lumen users, there’s <a href="https://github.com/matthewbdaly/laravel-sms">an integration package</a> that should make it easier to use. For users of other frameworks, it should still be fairly straightforward to integrate.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Installing Nginx Unit on Ubuntu]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/09/08/installing-nginx-unit-on-ubuntu/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/09/08/installing-nginx-unit-on-ubuntu/">
        </link>
        <updated>2017-09-08T21:05:04Z</updated>
        <summary type="html"><![CDATA[<p>Recently Nginx announced the release of the first beta of <a href="https://www.nginx.com/products/nginx-unit/">Unit</a>, an application server that supports Python, PHP and Go, with support coming for Java, Node.js and Ruby.</p>
<p>The really interesting part is that not only does it support more than one language, but Unit can be configured by making HTTP requests, rather than by editing config files. This makes it potentially very interesting to web developers like myself who have worked in multiple languages - I could use it to serve a Python or PHP web app, simply by making different requests during the setup process. I can see this being a boon for SaaS providers - you could pick up the language from a file, much like the <code>runtime.txt</code> used by Heroku, and set up the application on the fly.</p>
<p>It’s currently in public beta, and there are packages for Ubuntu, so I decided to try it out. I’ve created the Ansible role below to set up Unit on an Ubuntu 16.04 server or VM:</p>
<pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>-<span class="ruby">--</td><tr><td class="linenos" data-pseudo-content="2"></td><td></span>-<span class="ruby"> <span class="hljs-symbol">name:</span> Install keys</td><tr><td class="linenos" data-pseudo-content="3"></td><td></span>  apt_key: url=http://nginx.org/keys/nginx_signing.key state=present</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Setup main repo</td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>  apt_repository: repo='deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx' state=present</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Setup source rep</td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>  apt_repository: repo='deb-src http://nginx.org/packages/mainline/ubuntu/ xenial nginx' state=present</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Update system</td><tr><td class="linenos" data-pseudo-content="12"></td><td></span>  apt: upgrade=full update_cache=yes</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Install dependencies</td><tr><td class="linenos" data-pseudo-content="15"></td><td></span>  apt: name={{ item }} state=present</td><tr><td class="linenos" data-pseudo-content="16"></td><td>  with_items:</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    -<span class="ruby"> nginx</td><tr><td class="linenos" data-pseudo-content="18"></td><td></span>    -<span class="ruby"> unit</td><tr><td class="linenos" data-pseudo-content="19"></td><td></span>    -<span class="ruby"> golang</td><tr><td class="linenos" data-pseudo-content="20"></td><td></span>    -<span class="ruby"> php-dev</td><tr><td class="linenos" data-pseudo-content="21"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-dev</td><tr><td class="linenos" data-pseudo-content="22"></td><td></span>    -<span class="ruby"> libphp-embed</td><tr><td class="linenos" data-pseudo-content="23"></td><td></span>    -<span class="ruby"> libphp7.<span class="hljs-number">0</span>-embed</td><tr><td class="linenos" data-pseudo-content="24"></td><td></span>    -<span class="ruby"> python-dev</td><tr><td class="linenos" data-pseudo-content="25"></td><td></span>    -<span class="ruby"> python3</td><tr><td class="linenos" data-pseudo-content="26"></td><td></span>    -<span class="ruby"> python3-dev</td><tr><td class="linenos" data-pseudo-content="27"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-cli</td><tr><td class="linenos" data-pseudo-content="28"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-mcrypt</td><tr><td class="linenos" data-pseudo-content="29"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-pgsql</td><tr><td class="linenos" data-pseudo-content="30"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-sqlite3</td><tr><td class="linenos" data-pseudo-content="31"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-opcache</td><tr><td class="linenos" data-pseudo-content="32"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-curl</td><tr><td class="linenos" data-pseudo-content="33"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-mbstring</td><tr><td class="linenos" data-pseudo-content="34"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-dom</td><tr><td class="linenos" data-pseudo-content="35"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-xml</td><tr><td class="linenos" data-pseudo-content="36"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-zip</td><tr><td class="linenos" data-pseudo-content="37"></td><td></span>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-bcmath</td><tr><td class="linenos" data-pseudo-content="38"></td><td></span></td><tr><td class="linenos" data-pseudo-content="39"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Copy over Nginx configuration</td><tr><td class="linenos" data-pseudo-content="40"></td><td></span>  copy: src=nginx.conf dest=/etc/nginx/sites-available/default owner=root group=root mode=0644</td></table></code></pre>
<p>Note the section that copies over the Nginx config file. Here is that file:</p>
<pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute">upstream</span> unit_backend {</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8300</span>;</td><tr><td class="linenos" data-pseudo-content="3"></td><td>}</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-section">server</span> {</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server ipv6only=<span class="hljs-literal">on</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>; </td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-attribute">root</span> /var/www/public;</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">index</span> index.php index.html index.htm;</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attribute">server_name</span> server_domain_or_IP;</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">location</span> / { </td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.php?<span class="hljs-variable">$query_string</span>;</td><tr><td class="linenos" data-pseudo-content="20"></td><td>    }   </td><tr><td class="linenos" data-pseudo-content="21"></td><td></td><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /index.php =<span class="hljs-number">404</span>;</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-attribute">proxy_pass</span> http://unit_backend;</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;</td><tr><td class="linenos" data-pseudo-content="26"></td><td>    }   </td><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></table></code></pre>
<p>This setup proxies all dynamic requests to the Unit backed in a similar fashion to how it would normally pass it to PHP-FPM.</p>
<p>There were still a few little issues. It doesn’t exactly help that the Nginx package provided with this repository isn’t quite the same as the one in Ubuntu by default - not only is it the unstable version, but it doesn’t set up the <code>sites-available</code> and <code>sites-enabled</code> folders, so I had to do that manually. I also had an issue with Systemd starting the process (at <code>/run/control.unit.sock</code>) with permissions that didn’t allow Nginx to access it. I’m not that familiar with Systemd so I wound up just setting the permissions of the file manually, but that doesn’t persist between restarts. I expect this issue isn’t that big a deal to someone more familiar with Systemd, but I haven’t been able to resolve it yet.</p>
<p>I decided to try it out with a Laravel application. I created a new Laravel app and set it up with the web root at <code>/var/www</code>. I then saved the following configuration for it as <code>app.json</code>:</p>
<pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"listeners"</span>: {</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-attr">"*:8300"</span>: {</td><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-attr">"application"</span>: <span class="hljs-string">"myapp"</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    },</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attr">"applications"</span>: {</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"myapp"</span>: {</td><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-attr">"type"</span>: <span class="hljs-string">"php"</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-attr">"workers"</span>: <span class="hljs-number">20</span>,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-attr">"user"</span>: <span class="hljs-string">"www-data"</span>,</td><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-attr">"group"</span>: <span class="hljs-string">"www-data"</span>,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-attr">"root"</span>: <span class="hljs-string">"/var/www/public"</span>,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-attr">"index"</span>: <span class="hljs-string">"index.php"</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></table></code></pre>
<p>This is fairly basic, but a good example of how you configure an application with Unit. The <code>listener</code> section maps a port to an application, while the <code>applications</code> section defines an application called <code>myapp</code>. In this case, we specify that the type should be <code>php</code>. Note that each platform has slightly different options - for instance, the Python type doesn’t have the <code>index</code> or <code>root</code> options, instead having the <code>path</code> option, which specifies the path to the <code>wsgi.py</code> file.</p>
<p>I then ran the following command to upload the file:</p>
<pre><code class="hljs lang-bash singleline">$ curl -X PUT <span class="hljs-_">-d</span> @app.json --unix-socket /run/control.unit.sock http://localhost</code></pre>
<p>Note that we send it direct to the Unix socket file - this way we don’t have to expose the API to the outside. After this was done, the Laravel app began working as expected.</p>
<p>We can then make a GET request to view the configured applications:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ curl --unix-socket /run/control.unit.sock http://localhost/</td><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">"listeners"</span>: {</td><tr><td class="linenos" data-pseudo-content="4"></td><td>                <span class="hljs-string">"*:8300"</span>: {</td><tr><td class="linenos" data-pseudo-content="5"></td><td>                        <span class="hljs-string">"application"</span>: <span class="hljs-string">"saas"</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>                }</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        },</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-string">"applications"</span>: {</td><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-string">"saas"</span>: {</td><tr><td class="linenos" data-pseudo-content="11"></td><td>                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"php"</span>,</td><tr><td class="linenos" data-pseudo-content="12"></td><td>                        <span class="hljs-string">"workers"</span>: 20,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>                        <span class="hljs-string">"user"</span>: <span class="hljs-string">"www-data"</span>,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>                        <span class="hljs-string">"group"</span>: <span class="hljs-string">"www-data"</span>,</td><tr><td class="linenos" data-pseudo-content="15"></td><td>                        <span class="hljs-string">"root"</span>: <span class="hljs-string">"/var/www/public"</span>,</td><tr><td class="linenos" data-pseudo-content="16"></td><td>                        <span class="hljs-string">"index"</span>: <span class="hljs-string">"index.php"</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>                }</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></table></code></pre>
<p>It’s also possible to update and delete existing applications via the API using PUT and DELETE requests.</p>
<h2 id="final-thoughts">Final thoughts</h2>
<p>This is <em>way</em> too early to be seriously considering using Unit in production. It’s only just been released as a public beta, and it’s a bit fiddly to set up. However, it has an enormous amount of promise.</p>
<p>One thing I can’t really see right now is whether it’s possible to use a virtualenv with it for Python applications. In the Python community it’s standard practice to use Virtualenv to isolate the dependencies for individual applications, and it’s not clear how I’d be able to go about using this, if it is possible. For deploying Python applications, lack of virtualenv support would be a deal breaker, and I hope this gets clarified soon.</p>
<p>I’d also be curious to see benchmarks of how it compares to something like PHP-FPM. It’s quite possible that it may be less performant than other solutions. However, I will keep a close eye on this in future.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Making internal requests with Laravel]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/09/02/making-internal-requests-with-laravel/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/09/02/making-internal-requests-with-laravel/">
        </link>
        <updated>2017-09-02T13:45:27Z</updated>
        <summary type="html"><![CDATA[<p>Recently I’ve been working on a Phonegap app that needs to work offline. The nature of relational databases can often make this tricky if you’re dealing with related objects and you’re trying to retrofit it to something that wasn’t built with this use case in mind.</p>
<p>Originally my plan was to push each request that would have been made to a queue in WebSQL, and then on reconnect, make every request individually. It quickly became apparent, however, that this approach had a few problems:</p>
<ul>
<li>If one request failed, the remaining requests had to be stopped from executing</li>
<li>It didn’t allow for storing the failed transactions in a way that made them easy to retrieve</li>
</ul>
<p>Instead, I decided to create a single <code>sync</code> endpoint for the API that would accept an object containing all the requests that would be made, and then step through each one. If it failed, it would get the failed request and all subsequent ones in the object, and store them in the database. That way, even if the data didn’t sync correctly, it wasn’t lost, and if necessary it could be resolved manually.</p>
<p>Since the necessary API endpoints already existed, and were thoroughly tested, it was not a good idea to start duplicating that functionality. Instead, I implemented the functionality to carry out internal requests, and I thought I’d share how you can do this.</p>
<p>For any service you may build for your Laravel applications, it’s a good idea to create an interface for it first:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MakesInternalRequests</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Make an internal request</td><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@param</span> string $action   The HTTP verb to use.</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@param</span> string $resource The API resource to look up.</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> array  $data     The request body.</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span><span class="hljs-params">(string $action, string $resource, array $data = [])</span></span>;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></table></code></pre>
<p>That way you can resolve the service using dependency injection, making it trivial to replace it with a mock when testing.</p>
<p>Now, actually making an internal request is pretty easy. You get the app instance (you can do so by resolving it using dependency injection as I do below, or call the <code>app()</code> helper). Then you put together the request you want to make and pass it as an argument to the app’s <code>handle()</code> method:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MakesInternalRequests</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Application</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">FailedInternalRequestException</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="11"></td><td> * Internal request service</td><tr><td class="linenos" data-pseudo-content="12"></td><td> */</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MakesInternalRequests</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="16"></td><td>     * The app instance</td><tr><td class="linenos" data-pseudo-content="17"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="18"></td><td>     * <span class="hljs-doctag">@var</span> $app</td><tr><td class="linenos" data-pseudo-content="19"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">protected</span> $app;</td><tr><td class="linenos" data-pseudo-content="21"></td><td></td><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     * Constructor</td><tr><td class="linenos" data-pseudo-content="24"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@param</span> Application $app        The app instance.</td><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Application $app)</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app = $app;</td><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="32"></td><td></td><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="34"></td><td>     * Make an internal request</td><tr><td class="linenos" data-pseudo-content="35"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="36"></td><td>     * <span class="hljs-doctag">@param</span> string $action   The HTTP verb to use.</td><tr><td class="linenos" data-pseudo-content="37"></td><td>     * <span class="hljs-doctag">@param</span> string $resource The API resource to look up.</td><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@param</span> array  $data     The request body.</td><tr><td class="linenos" data-pseudo-content="39"></td><td>     * <span class="hljs-doctag">@throws</span> FailedInternalRequestException Request could not be synced.</td><tr><td class="linenos" data-pseudo-content="40"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td><tr><td class="linenos" data-pseudo-content="41"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span><span class="hljs-params">(string $action, string $resource, array $data = [])</span></td><tr><td class="linenos" data-pseudo-content="43"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-comment">// Create request</span></td><tr><td class="linenos" data-pseudo-content="45"></td><td>        $request = Request::create(<span class="hljs-string">'/api/'</span> . $resource, $action, $data, [], [], [</td><tr><td class="linenos" data-pseudo-content="46"></td><td>            <span class="hljs-string">'HTTP_Accept'</span>             =&gt; <span class="hljs-string">'application/json'</span>,</td><tr><td class="linenos" data-pseudo-content="47"></td><td>        ]);</td><tr><td class="linenos" data-pseudo-content="48"></td><td></td><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-comment">// Get response</span></td><tr><td class="linenos" data-pseudo-content="50"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;app-&gt;handle($request);</td><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() &gt;= <span class="hljs-number">400</span>) {</td><tr><td class="linenos" data-pseudo-content="52"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FailedInternalRequestException($request, $response);</td><tr><td class="linenos" data-pseudo-content="53"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="54"></td><td></td><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-comment">// Dispatch the request</span></td><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">return</span> $response;</td><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="58"></td><td>}</td></table></code></pre>
<p>Also note that I’ve created a custom exception, called <code>FailedInternalRequestException</code>. This is fired if the status code returned from the internal requests is greater than or equal to 400 (thus denoting an error):</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Exceptions</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Response</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="9"></td><td> * Exception for when a bulk sync job fails</td><tr><td class="linenos" data-pseudo-content="10"></td><td> */</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FailedInternalRequestException</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="14"></td><td>     * Request instance</td><tr><td class="linenos" data-pseudo-content="15"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@var</span> $request</td><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> $request;</td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Response instance</td><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@var</span> $response</td><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">protected</span> $response;</td><tr><td class="linenos" data-pseudo-content="26"></td><td></td><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="28"></td><td>     * Constructor</td><tr><td class="linenos" data-pseudo-content="29"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="30"></td><td>     * <span class="hljs-doctag">@param</span> Request  $request  The request object.</td><tr><td class="linenos" data-pseudo-content="31"></td><td>     * <span class="hljs-doctag">@param</span> Response $response The response object.</td><tr><td class="linenos" data-pseudo-content="32"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="33"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Request $request, Response $response)</span></td><tr><td class="linenos" data-pseudo-content="35"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">parent</span>::__construct();</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">$this</span>-&gt;request = $request;</td><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;response = $response;</td><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="40"></td><td></td><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="42"></td><td>     * Get request object</td><tr><td class="linenos" data-pseudo-content="43"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> Request</td><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequest</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="47"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;request;</td><tr><td class="linenos" data-pseudo-content="49"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="50"></td><td></td><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="52"></td><td>     * Get response object</td><tr><td class="linenos" data-pseudo-content="53"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="54"></td><td>     * <span class="hljs-doctag">@return</span> Response</td><tr><td class="linenos" data-pseudo-content="55"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getResponse</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="57"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;response;</td><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="60"></td><td>}</td></table></code></pre>
<p>You can catch this exception in an appropriate place and handle it as you wish. Now, if you import the internal request class as <code>$dispatcher</code>, you can just call <code>$dispatcher-&gt;request($action, $resource, $data)</code>, where <code>$action</code> is the HTTP verb, <code>$resource</code> is the API resource to send to, and <code>$data</code> is the data to send.</p>
<p>It’s actually quite rare to have to do this. In this case, because this was a REST API and every request made to it was changing the state of the application (there were no GET requests, only POST, PUT, PATCH and DELETE), it made sense to just break down the request body and do internal requests against the existing API, since otherwise I’d have to duplicate the existing functionality. I would not recommend this approach for something like fetching data to render a page on the server side, as there are more efficient ways of accomplishing it. In all honesty I can’t think of any other scenario where this would genuinely be the best option. However, it worked well for my use case and allowed me to implement this functionality quickly and simply.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Run your tests locally with Sismo]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/08/19/run-your-tests-locally-with-sismo/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/08/19/run-your-tests-locally-with-sismo/">
        </link>
        <updated>2017-08-19T14:40:07Z</updated>
        <summary type="html"><![CDATA[<p>Continuous integration is a veritable boon when working on any large software project. However, the popularity of distributed version control systems like Git over the older, more centralised ones like Subversion means that when you commit your changes, they don’t necessarily get pushed up to a remote repository immediately. While this is a good thing because it means you can commit at any stage without worrying about pushing up changes that break everyone else’s build, it has the downside that the tests aren’t automatically run on every commit, just every push, so if you get sloppy about running your tests before every commit you can more easily get caught out. In addition, a full CI server like Jenkins is a rather large piece of software that you don’t really want to run locally if you can help it, and has a lot of functionality you don’t need.</p>
<p><a href="https://sismo.symfony.com/">Sismo</a> is a small, simple continuous integration server, implemented in PHP, that’s ideal for running locally. You can set it up to run your tests on every commit, and it has an easy-to-use web interface. Although it’s a PHP application, there’s no reason why you couldn’t use it to run tests for projects in other languages, and because it’s focused solely on running your test suite without many of the other features of more advanced CI solutions, it’s a good fit for local use. Here I’ll show you how I use it.</p>
<h2 id="setting-up-sismo">Setting up Sismo</h2>
<p>Nowadays I don’t generally install a web server on a computer directly, preferring to use Vagrant or the dev server as appropriate, so Sismo generally doesn’t have to coexist with anything else. I normally install PHP7’s FastCGI implementation and Nginx, along with the SQLite bindings (which Sismo needs):</p>
<pre><code class="hljs lang-bash singleline">$ sudo apt-get install nginx php7.0-fpm php7.0-sqlite3</code></pre>
<p>Then we can set up our Nginx config at <code>/etc/nginx/sites-available/default</code>:</p>
<pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-section">server</span> {</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server ipv6only=<span class="hljs-literal">on</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attribute">root</span> /var/www/html;</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">index</span> sismo.php index.html index.htm;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-attribute">server_name</span> server_domain_or_IP;</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">location</span> / {</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /sismo.php?<span class="hljs-variable">$query_string</span>;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /sismo.php =<span class="hljs-number">404</span>;</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-attribute">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span>;</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-attribute">fastcgi_pass</span> unix:/var/run/php/php7.0-fpm.sock;</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-attribute">fastcgi_index</span> sismo.php;</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SISMO_DATA_PATH <span class="hljs-string">"/home/matthew/.sismo/data"</span>;</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SISMO_CONFIG_PATH <span class="hljs-string">"/home/matthew/.sismo/config.php"</span>;</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-attribute">include</span> fastcgi_params;</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></table></code></pre>
<p>You’ll probably want to adjust the paths as appropriate. Then set up the required folders:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ mkdir ~/.sismo</td><tr><td class="linenos" data-pseudo-content="2"></td><td>$ mkdir ~/.sismo/data</td><tr><td class="linenos" data-pseudo-content="3"></td><td>$ touch ~/.sismo/config.php</td><tr><td class="linenos" data-pseudo-content="4"></td><td>$ chmod -R a+w ~/.sismo/</td></table></code></pre>
<p>Then, <a href="https://sismo.symfony.com/get/sismo.php">download Sismo</a> and put it in your web root (here it’s at <code>/var/www/html/sismo.php</code>).</p>
<p>Now, say you have a project you want to test (I’m using my <a href="https://github.com/matthewbdaly/laravel-etag-middleware">Laravel ETag middleware</a> for this example). We need to specify the projects we want to test in <code>~/.sismo/config.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>$projects = <span class="hljs-keyword">array</span>();</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>$notifier = <span class="hljs-keyword">new</span> Sismo\Notifier\DBusNotifier();</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>Sismo\Project::setDefaultCommand(<span class="hljs-string">'if [ -f composer.json ]; then composer install; fi &amp;&amp; vendor/bin/phpunit'</span>);</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>$projects[] = <span class="hljs-keyword">new</span> Sismo\GithubProject(<span class="hljs-string">'Laravel ETag Middleware'</span>, <span class="hljs-string">'/home/matthew/Projects/laravel-etag-middleware'</span>, $notifier);</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">return</span> $projects;</td></table></code></pre>
<p>Hopefully this shouldn’t be too difficult to understand. We create an array of projects, then specify a notifier (this is Linux-specific - refer to the documentation for using Growl on Mac OS). Next, we specify that by default the tests should run <code>composer install</code> followed by <code>vendor/bin/phpunit</code>. We then specify this project is a Github project - it also supports Bitbucket, or plain SSH, or the default Project, but in general it shouldn’t be a problem to use it with any repository as you can just run it against the local copy. Finally we return the list of projects.</p>
<p>Now, we should be able to run our tests as follows:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php /var/www/html/sismo.php build</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Building Project <span class="hljs-string">"Laravel ETag Middleware"</span> (into <span class="hljs-string">"68a087"</span>)</td></table></code></pre>
<p>That should be working, but it doesn’t get us anything we don’t get by running the tests ourselves. To trigger the build, we need to set up a post-commit hook for our project in <code>.git/hooks/post-commit</code>:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">#!/bin/sh</td><tr><td class="linenos" data-pseudo-content="2"></td><td></span></td><tr><td class="linenos" data-pseudo-content="3"></td><td>php /var/www/html/sismo.php --quiet --force build laravel-etag-middleware `git <span class="hljs-built_in">log</span> -1 HEAD --pretty=<span class="hljs-string">"%H"</span>` &amp;&gt;/dev/null &amp;</td></table></code></pre>
<p>You should now be able to view your project in the Sismo web interface at <a href="http://localhost">http://localhost</a>:</p>
<p><img src="/static/images/sismo-screenshot.png" alt="Sismo"></p>
<p>Clicking on the project should take you through to its build history:</p>
<p><img src="/static/images/sismo-screenshot2.png" alt="Sismo project page"></p>
<p>From here on, it should be straightforward to add new projects as and when necessary. Because you can change the command on a per-project basis, you can quite happily use it to run tests for Python or Node.js projects as well as PHP ones, and it’s not hard to configure it.</p>
<p>I personally find it very useful to have something in place to run my tests on every commit like this, and while you could just use a post-commit hook for that, this approach is less obtrusive because it doesn’t force you to wait around for your test suite to finish.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Profiling your Laravel application with Clockwork]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/08/14/profiling-your-laravel-application-with-clockwork/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/08/14/profiling-your-laravel-application-with-clockwork/">
        </link>
        <updated>2017-08-14T11:40:00Z</updated>
        <summary type="html"><![CDATA[<p>If you’re building any non-trivial application, it’s always a good idea to profile it to find performance problems. <a href="https://github.com/barryvdh/laravel-debugbar">Laravel Debugbar</a> is the usual solution for profiling Laravel web applications, but it isn’t really much use for REST API’s or single-page web apps that consume them.</p>
<p>Recently I was introduced to <a href="https://github.com/itsgoingd/clockwork">Clockwork</a>, which is a server-side extension for profiling PHP applications. It’s made it a whole lot easier to track down issues like excessive numbers of queries when building an API, and as a result I’ve been able to dramatically improve the performance of an API I’ve been working on. Here I’ll show you how you can use it on a project.</p>
<h2 id="installing-clockwork">Installing Clockwork</h2>
<p>Clockwork is available via Composer:</p>
<pre><code class="hljs lang-bash singleline">$ composer require itsgoingd/clockwork</code></pre>
<p>You also need to register the service provider in <code>config/app.php</code>:</p>
<pre><code class="hljs lang-php singleline">   Clockwork\Support\Laravel\ClockworkServiceProvider::class,</code></pre>
<p>And register the middleware globally in <code>app/Http/Kernel.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">protected</span> $middleware = [</td><tr><td class="linenos" data-pseudo-content="2"></td><td>      \Clockwork\Support\Laravel\ClockworkMiddleware::class,</td><tr><td class="linenos" data-pseudo-content="3"></td><td>]</td></table></code></pre>
<p>Note that it only works when <code>APP_DEBUG</code> is set to true in your <code>.env</code> file. This means that you can keep it in your application without worrying about exposing too much data in production, as long as debug mode is not active on your production server (which it shouldn’t be anyway).</p>
<p>You will also need to install the <a href="https://chrome.google.com/webstore/detail/clockwork/dmggabnehkmmfmdffgajcflpdjlnoemp?hl=en">Chrome extension</a> in order to actually work with the returned data. Clockwork works by adding its own route to your Laravel application, and this extension makes sure that it makes the appropriate request on loading a page, and then displays the data in the dev tools.</p>
<p>Once it’s all installed and your application is running, open the dev tools and you should see the new <strong>Clockwork</strong> tab in there. On the left of this tab is a list of requests - if you make a request, you’ll see it added to the list. When you click on each request, you’ll see the following tabs, where applicable:</p>
<h2 id="request">Request</h2>
<p><img src="/static/images/clockwork1.png" alt="Request tab"></p>
<p>This is similar to Chrome’s network tab in that it shows all of the headers for a given request. It’s not anything you can’t get using Chrome’s existing dev tools, but because it doesn’t show any static content it’s arguably a bit easier to navigate.</p>
<h2 id="timeline">Timeline</h2>
<p><img src="/static/images/clockwork2.png" alt="Timeline tab"></p>
<p>This shows how long the response takes to respond, which can be helpful in identifying slower requests.</p>
<p>In addition, you can create your own events using the <code>clock()</code> helper, which will appear in the timeline, as in this example:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>clock()-&gt;startEvent(<span class="hljs-string">'email_sent'</span>, <span class="hljs-string">'Email sent.'</span>);</td><tr><td class="linenos" data-pseudo-content="2"></td><td>clock()-&gt;endEvent(<span class="hljs-string">'email_sent'</span>);</td></table></code></pre>
<h2 id="log">Log</h2>
<p><img src="/static/images/clockwork8.png" alt="Log tab"></p>
<p>The log tab is only displayed if you use the <code>clock()</code> helper to log data. You can log text or JSON objects as appropriate:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>clock(<span class="hljs-string">'Message text.'</span>); <span class="hljs-comment">// 'Message text.' appears in Clockwork log tab</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>clock([<span class="hljs-string">'hello'</span> =&gt; <span class="hljs-string">'world'</span>]); <span class="hljs-comment">// logs json representation of the array</span></td></table></code></pre>
<p>This is arguably more convenient than using the <code>Log</code> facade to write to the application log, since it’s kept in the browser and you can easily see what request caused what message to be logged.</p>
<h2 id="database">Database</h2>
<p><img src="/static/images/clockwork3.png" alt="Database tab"></p>
<p>The database tab displays details of the queries made by a request. This is useful for identifying things such as:</p>
<ul>
<li>Repeated queries that should be cached</li>
<li>The n+1 problem (which can be resolved by use of eager loading)</li>
<li>Slow queries that need to be optimised</li>
</ul>
<p>Note that if a particular endpoint does not trigger a query, this tab will not be visible.</p>
<h2 id="cookies">Cookies</h2>
<p><img src="/static/images/clockwork4.png" alt="Cookies tab"></p>
<p>For a REST API, you shouldn’t really have much use for cookies, but if you do, this tab lets you view the cookies set on the request.</p>
<h2 id="session">Session</h2>
<p><img src="/static/images/clockwork5.png" alt="Session tab"></p>
<p>As with cookies, the session isn’t normally something you’d use for an API, but this tab lets you view it.</p>
<h2 id="views">Views</h2>
<p><img src="/static/images/clockwork6.png" alt="Views tab"></p>
<p>This tab shows the views used on the page, and all of the data passed to them.</p>
<h2 id="routes">Routes</h2>
<p><img src="/static/images/clockwork7.png" alt="Routes tab"></p>
<p>This tab shows all of the routes defined within your application.</p>
<p>Clockwork isn’t limited to Laravel - you can also use it with Lumen, Slim 2, and CodeIgniter 2.1, and it’s possible to write your own integration for other frameworks. It’s still fundamentally browser-based, so it’s difficult to use it if your API doesn’t have at least some kind of web front end (whether that’s a single page web app or Phonegap app that consumes the API, or that the API is itself browseable and returns HTML in a web browser), but I’ve found it to be superior to Laravel Debugbar for most of what I do.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Snapshot test your Vue components with Jest]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/06/17/snapshot-test-your-vue-components-with-jest/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/06/17/snapshot-test-your-vue-components-with-jest/">
        </link>
        <updated>2017-06-17T13:12:02Z</updated>
        <summary type="html"><![CDATA[<p>At work I’ve recently started using <a href="https://vuejs.org/">Vue</a> as my main front-end framework instead of Angular 1. It has a relatively shallow learning curve and has enough similarities with both React and Angular 1 that if you’re familiar with one or both of them it feels quite familiar. We’re a Laravel shop and Laravel comes out of the box with a basic scaffolding for using Vue, so not only is it the path of least resistance, but many of my colleagues knew it already and it’s used on some existing projects (one of which I’ve been helping out on this week), so it made sense to learn it. Add to that the fact that the main alternative is Angular 2, which I vehemently dislike, and learning Vue was a no-brainer.</p>
<p><a href="https://facebook.github.io/jest/docs/snapshot-testing.html">Snapshot tests</a> are a really useful way of making sure your user interface doesn’t change unexpectedly. Facebook introduced them to their Jest testing framework last year, and they’ve started to appear in other testing frameworks too. In their words…</p>
<blockquote>
<p>A typical snapshot test case for a mobile app renders a UI component, takes a screenshot, then compares it to a reference image stored alongside the test. The test will fail if the two images do not match: either the change is unexpected, or the screenshot needs to be updated to the new version of the UI component.</p>
</blockquote>
<p>This makes it easy to make sure than a UI component, such as a React or Vue component, does not unexpectedly change how it is rendered. In the event that it does change, it will fail the test, and it’s up to the developer to confirm whether or not that’s expected - if so they can generate a new version of the snapshot and be on their way. Without it, you’re stuck manually testing that the right HTML tags get generated, which is a chore.</p>
<p>Jest’s documentation is aimed pretty squarely at React, but it’s not hard to adapt it to work with Vue components. Here I’ll show you how I got it working with Vue.</p>
<h2 id="setting-up-a-new-project">Setting up a new project</h2>
<p>I used the <a href="https://github.com/vuejs/vue-cli">Vue CLI</a> boilerplate generator to set up my initial dependencies for this project. I then had to install some further packages:</p>
<pre><code class="hljs lang-bash singleline">$ npm install --save-dev jest babel-jest jest-vue-preprocessor</code></pre>
<p>After that, I had to configure Jest to work with Vue. The finished <code>package.json</code> looked like this:</p>
<pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"myproject"</span>,</td><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</td><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A project"</span>,</td><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-attr">"author"</span>: <span class="hljs-string">"Matthew Daly &lt;matthew@matthewdaly.co.uk&gt;"</span>,</td><tr><td class="linenos" data-pseudo-content="6"></td><td>  <span class="hljs-attr">"private"</span>: <span class="hljs-literal">true</span>,</td><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-attr">"scripts"</span>: {</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"node build/dev-server.js"</span>,</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node build/dev-server.js"</span>,</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"node build/build.js"</span>,</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">"lint"</span>: <span class="hljs-string">"eslint --ext .js,.vue src"</span>,</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"jest __test__/ --coverage"</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>  },</td><tr><td class="linenos" data-pseudo-content="14"></td><td>  <span class="hljs-attr">"dependencies"</span>: {</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">"vue"</span>: <span class="hljs-string">"^2.3.3"</span>,</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attr">"vue-router"</span>: <span class="hljs-string">"^2.3.1"</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>  },</td><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-attr">"devDependencies"</span>: {</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-attr">"autoprefixer"</span>: <span class="hljs-string">"^6.7.2"</span>,</td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-attr">"babel-core"</span>: <span class="hljs-string">"^6.22.1"</span>,</td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"babel-eslint"</span>: <span class="hljs-string">"^7.1.1"</span>,</td><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attr">"babel-jest"</span>: <span class="hljs-string">"^20.0.3"</span>,</td><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-attr">"babel-loader"</span>: <span class="hljs-string">"^6.2.10"</span>,</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-attr">"babel-plugin-transform-runtime"</span>: <span class="hljs-string">"^6.22.0"</span>,</td><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-attr">"babel-preset-env"</span>: <span class="hljs-string">"^1.3.2"</span>,</td><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-attr">"babel-preset-stage-2"</span>: <span class="hljs-string">"^6.22.0"</span>,</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-attr">"babel-register"</span>: <span class="hljs-string">"^6.22.0"</span>,</td><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-attr">"chalk"</span>: <span class="hljs-string">"^1.1.3"</span>,</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-attr">"connect-history-api-fallback"</span>: <span class="hljs-string">"^1.3.0"</span>,</td><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-attr">"copy-webpack-plugin"</span>: <span class="hljs-string">"^4.0.1"</span>,</td><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-attr">"css-loader"</span>: <span class="hljs-string">"^0.28.0"</span>,</td><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-attr">"eslint"</span>: <span class="hljs-string">"^3.19.0"</span>,</td><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-attr">"eslint-config-standard"</span>: <span class="hljs-string">"^6.2.1"</span>,</td><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-attr">"eslint-friendly-formatter"</span>: <span class="hljs-string">"^2.0.7"</span>,</td><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-attr">"eslint-loader"</span>: <span class="hljs-string">"^1.7.1"</span>,</td><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-attr">"eslint-plugin-html"</span>: <span class="hljs-string">"^2.0.0"</span>,</td><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-attr">"eslint-plugin-promise"</span>: <span class="hljs-string">"^3.4.0"</span>,</td><tr><td class="linenos" data-pseudo-content="38"></td><td>    <span class="hljs-attr">"eslint-plugin-standard"</span>: <span class="hljs-string">"^2.0.1"</span>,</td><tr><td class="linenos" data-pseudo-content="39"></td><td>    <span class="hljs-attr">"eventsource-polyfill"</span>: <span class="hljs-string">"^0.9.6"</span>,</td><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.14.1"</span>,</td><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-attr">"extract-text-webpack-plugin"</span>: <span class="hljs-string">"^2.0.0"</span>,</td><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-attr">"file-loader"</span>: <span class="hljs-string">"^0.11.1"</span>,</td><tr><td class="linenos" data-pseudo-content="43"></td><td>    <span class="hljs-attr">"friendly-errors-webpack-plugin"</span>: <span class="hljs-string">"^1.1.3"</span>,</td><tr><td class="linenos" data-pseudo-content="44"></td><td>    <span class="hljs-attr">"html-webpack-plugin"</span>: <span class="hljs-string">"^2.28.0"</span>,</td><tr><td class="linenos" data-pseudo-content="45"></td><td>    <span class="hljs-attr">"http-proxy-middleware"</span>: <span class="hljs-string">"^0.17.3"</span>,</td><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-attr">"jest"</span>: <span class="hljs-string">"^20.0.4"</span>,</td><tr><td class="linenos" data-pseudo-content="47"></td><td>    <span class="hljs-attr">"jest-vue-preprocessor"</span>: <span class="hljs-string">"^1.0.1"</span>,</td><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-attr">"opn"</span>: <span class="hljs-string">"^4.0.2"</span>,</td><tr><td class="linenos" data-pseudo-content="49"></td><td>    <span class="hljs-attr">"optimize-css-assets-webpack-plugin"</span>: <span class="hljs-string">"^1.3.0"</span>,</td><tr><td class="linenos" data-pseudo-content="50"></td><td>    <span class="hljs-attr">"ora"</span>: <span class="hljs-string">"^1.2.0"</span>,</td><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-attr">"rimraf"</span>: <span class="hljs-string">"^2.6.0"</span>,</td><tr><td class="linenos" data-pseudo-content="52"></td><td>    <span class="hljs-attr">"semver"</span>: <span class="hljs-string">"^5.3.0"</span>,</td><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-attr">"shelljs"</span>: <span class="hljs-string">"^0.7.6"</span>,</td><tr><td class="linenos" data-pseudo-content="54"></td><td>    <span class="hljs-attr">"url-loader"</span>: <span class="hljs-string">"^0.5.8"</span>,</td><tr><td class="linenos" data-pseudo-content="55"></td><td>    <span class="hljs-attr">"vue-loader"</span>: <span class="hljs-string">"^12.1.0"</span>,</td><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-attr">"vue-style-loader"</span>: <span class="hljs-string">"^3.0.1"</span>,</td><tr><td class="linenos" data-pseudo-content="57"></td><td>    <span class="hljs-attr">"vue-template-compiler"</span>: <span class="hljs-string">"^2.3.3"</span>,</td><tr><td class="linenos" data-pseudo-content="58"></td><td>    <span class="hljs-attr">"webpack"</span>: <span class="hljs-string">"^2.6.1"</span>,</td><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-attr">"webpack-bundle-analyzer"</span>: <span class="hljs-string">"^2.2.1"</span>,</td><tr><td class="linenos" data-pseudo-content="60"></td><td>    <span class="hljs-attr">"webpack-dev-middleware"</span>: <span class="hljs-string">"^1.10.0"</span>,</td><tr><td class="linenos" data-pseudo-content="61"></td><td>    <span class="hljs-attr">"webpack-hot-middleware"</span>: <span class="hljs-string">"^2.18.0"</span>,</td><tr><td class="linenos" data-pseudo-content="62"></td><td>    <span class="hljs-attr">"webpack-merge"</span>: <span class="hljs-string">"^4.1.0"</span></td><tr><td class="linenos" data-pseudo-content="63"></td><td>  },</td><tr><td class="linenos" data-pseudo-content="64"></td><td>  <span class="hljs-attr">"engines"</span>: {</td><tr><td class="linenos" data-pseudo-content="65"></td><td>    <span class="hljs-attr">"node"</span>: <span class="hljs-string">"&gt;= 4.0.0"</span>,</td><tr><td class="linenos" data-pseudo-content="66"></td><td>    <span class="hljs-attr">"npm"</span>: <span class="hljs-string">"&gt;= 3.0.0"</span></td><tr><td class="linenos" data-pseudo-content="67"></td><td>  },</td><tr><td class="linenos" data-pseudo-content="68"></td><td>  <span class="hljs-attr">"browserslist"</span>: [</td><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-string">"&gt; 1%"</span>,</td><tr><td class="linenos" data-pseudo-content="70"></td><td>    <span class="hljs-string">"last 2 versions"</span>,</td><tr><td class="linenos" data-pseudo-content="71"></td><td>    <span class="hljs-string">"not ie &lt;= 8"</span></td><tr><td class="linenos" data-pseudo-content="72"></td><td>  ],</td><tr><td class="linenos" data-pseudo-content="73"></td><td>  <span class="hljs-attr">"jest"</span>: {</td><tr><td class="linenos" data-pseudo-content="74"></td><td>    <span class="hljs-attr">"testRegex"</span>: <span class="hljs-string">"spec.js$"</span>,</td><tr><td class="linenos" data-pseudo-content="75"></td><td>    <span class="hljs-attr">"moduleFileExtensions"</span>: [</td><tr><td class="linenos" data-pseudo-content="76"></td><td>      <span class="hljs-string">"js"</span>,</td><tr><td class="linenos" data-pseudo-content="77"></td><td>      <span class="hljs-string">"vue"</span></td><tr><td class="linenos" data-pseudo-content="78"></td><td>    ],</td><tr><td class="linenos" data-pseudo-content="79"></td><td>    <span class="hljs-attr">"transform"</span>: {</td><tr><td class="linenos" data-pseudo-content="80"></td><td>      <span class="hljs-attr">"^.+\\.js$"</span>: <span class="hljs-string">"&lt;rootDir&gt;/node_modules/babel-jest"</span>,</td><tr><td class="linenos" data-pseudo-content="81"></td><td>      <span class="hljs-attr">".*\\.(vue)$"</span>: <span class="hljs-string">"&lt;rootDir&gt;/node_modules/jest-vue-preprocessor"</span></td><tr><td class="linenos" data-pseudo-content="82"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="83"></td><td>  }</td><tr><td class="linenos" data-pseudo-content="84"></td><td>}</td></table></code></pre>
<p>I won’t include things like the Webpack config, because that’s all generated by Vue CLI. Note that we need to tell Jest what file extensions it should work with, including <code>.vue</code>, and we need to specify the appropriate transforms for different types of files. We use <code>jest-vue-preprocessor</code> for <code>.vue</code> files and <code>babel-jest</code> for <code>.js</code> files.</p>
<p>With that done, we can create a basic component. We’ll assume we’re writing a simple issue tracker here, and our first component will be at <code>src/components/Issue.vue</code>:</p>
<pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>An Issue<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {</td><tr><td class="linenos" data-pseudo-content="9"></td><td>  data () {</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">return</span> {}</td><tr><td class="linenos" data-pseudo-content="11"></td><td>  }</td><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td><tr><td class="linenos" data-pseudo-content="13"></td><td></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="undefined"></td><tr><td class="linenos" data-pseudo-content="16"></td><td></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></td></table></code></pre>
<p>Next, we create a simple test for this component. Save this as <code>__test__/components/issue.spec.js</code>:</p>
<pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> Issue <span class="hljs-keyword">from</span> <span class="hljs-string">'../../src/components/Issue.vue'</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">const</span> Constructor = Vue.extend(Issue)</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> Constructor().$mount()</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>describe(<span class="hljs-string">'Issue'</span>, () =&gt; {</td><tr><td class="linenos" data-pseudo-content="8"></td><td>  it(<span class="hljs-string">'should render'</span>, () =&gt; {</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    expect(vm.$el.querySelector(<span class="hljs-string">'h1'</span>).textContent).toEqual(<span class="hljs-string">'An Issue'</span>)</td><tr><td class="linenos" data-pseudo-content="10"></td><td>  });</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>  it(<span class="hljs-string">'should match the snapshot'</span>, () =&gt; {</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    expect(vm.$el).toMatchSnapshot()</td><tr><td class="linenos" data-pseudo-content="14"></td><td>  });</td><tr><td class="linenos" data-pseudo-content="15"></td><td>});</td></table></code></pre>
<p><code>Constructor</code> is what creates our Vue component, while <code>vm</code> is our actual newly-mounted Vue component. We can refer to the HTML inside the component through <code>vm.$el</code>, so we can then work with the virtual DOM easily.</p>
<p>In the first test we use the more traditional method of verifying our UI component has worked as expected - we fetch an HTML tag inside it and verify that the content inside is what we expect. This is fine for a small component, but as the components get larger we’ll find it more of a chore.</p>
<p>The second test is much simpler and more concise. We simply assert that it matches the snapshot. Not only is that easier, but it can scale to components of any size because we don’t have to check every little element.</p>
<p>Let’s run our tests:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td> PASS  __test__/components/issue.spec.js</td><tr><td class="linenos" data-pseudo-content="7"></td><td>  Issue</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    ✓ should render (46ms)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    ✓ should match the snapshot (14ms)</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>Snapshot Summary</td><tr><td class="linenos" data-pseudo-content="12"></td><td> › 1 snapshot written <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite.</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>Test Suites: 1 passed, 1 total</td><tr><td class="linenos" data-pseudo-content="15"></td><td>Tests:       2 passed, 2 total</td><tr><td class="linenos" data-pseudo-content="16"></td><td>Snapshots:   1 added, 1 total</td><tr><td class="linenos" data-pseudo-content="17"></td><td>Time:        8.264s</td><tr><td class="linenos" data-pseudo-content="18"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td><tr><td class="linenos" data-pseudo-content="19"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="20"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td><tr><td class="linenos" data-pseudo-content="21"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="22"></td><td>All files                                                  |    96.15 |       50 |      100 |       96 |                |</td><tr><td class="linenos" data-pseudo-content="23"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="24"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="25"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="26"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="27"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td><tr><td class="linenos" data-pseudo-content="28"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td><tr><td class="linenos" data-pseudo-content="29"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></table></code></pre>
<p>Note this section:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Snapshot Summary</td><tr><td class="linenos" data-pseudo-content="2"></td><td> › 1 snapshot written <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite.</td></table></code></pre>
<p>This tells us that the snapshot has been successfully written. If we run the tests again we should see that it checks against the existing snapshot:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td> PASS  __test__/components/issue.spec.js</td><tr><td class="linenos" data-pseudo-content="7"></td><td>  Issue</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    ✓ should render (40ms)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    ✓ should match the snapshot (12ms)</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>Test Suites: 1 passed, 1 total</td><tr><td class="linenos" data-pseudo-content="12"></td><td>Tests:       2 passed, 2 total</td><tr><td class="linenos" data-pseudo-content="13"></td><td>Snapshots:   1 passed, 1 total</td><tr><td class="linenos" data-pseudo-content="14"></td><td>Time:        3.554s</td><tr><td class="linenos" data-pseudo-content="15"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td><tr><td class="linenos" data-pseudo-content="16"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="17"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td><tr><td class="linenos" data-pseudo-content="18"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="19"></td><td>All files                                                  |    96.15 |       50 |      100 |       96 |                |</td><tr><td class="linenos" data-pseudo-content="20"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="21"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="22"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="23"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="24"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td><tr><td class="linenos" data-pseudo-content="25"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td><tr><td class="linenos" data-pseudo-content="26"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></table></code></pre>
<p>Great stuff. Now, if we make a minor change to our component, such as changing the text from <code>An Issue</code> to <code>My Issue</code>, does it pick that up?</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td> FAIL  __test__/components/issue.spec.js (5.252s)</td><tr><td class="linenos" data-pseudo-content="7"></td><td>  ● Issue › should render</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    expect(received).toEqual(expected)</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    Expected value to equal:</td><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-string">"An Issue"</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    Received:</td><tr><td class="linenos" data-pseudo-content="14"></td><td>      <span class="hljs-string">"My Issue"</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:9:52)</td><tr><td class="linenos" data-pseudo-content="17"></td><td>      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>  ● Issue › should match the snapshot</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    expect(value).toMatchSnapshot()</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>    Received value does not match stored snapshot 1.</td><tr><td class="linenos" data-pseudo-content="24"></td><td></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    - Snapshot</td><tr><td class="linenos" data-pseudo-content="26"></td><td>    + Received</td><tr><td class="linenos" data-pseudo-content="27"></td><td></td><tr><td class="linenos" data-pseudo-content="28"></td><td>     &lt;div&gt;</td><tr><td class="linenos" data-pseudo-content="29"></td><td>       &lt;h1&gt;</td><tr><td class="linenos" data-pseudo-content="30"></td><td>    -    An Issue</td><tr><td class="linenos" data-pseudo-content="31"></td><td>    +    My Issue</td><tr><td class="linenos" data-pseudo-content="32"></td><td>       &lt;/h1&gt;</td><tr><td class="linenos" data-pseudo-content="33"></td><td>     &lt;/div&gt;</td><tr><td class="linenos" data-pseudo-content="34"></td><td></td><tr><td class="linenos" data-pseudo-content="35"></td><td>      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:13:20)</td><tr><td class="linenos" data-pseudo-content="36"></td><td>      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)</td><tr><td class="linenos" data-pseudo-content="37"></td><td></td><tr><td class="linenos" data-pseudo-content="38"></td><td>  Issue</td><tr><td class="linenos" data-pseudo-content="39"></td><td>    ✕ should render (48ms)</td><tr><td class="linenos" data-pseudo-content="40"></td><td>    ✕ should match the snapshot (25ms)</td><tr><td class="linenos" data-pseudo-content="41"></td><td></td><tr><td class="linenos" data-pseudo-content="42"></td><td>Snapshot Summary</td><tr><td class="linenos" data-pseudo-content="43"></td><td> › 1 snapshot <span class="hljs-built_in">test</span> failed <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite. Inspect your code changes or run with `npm <span class="hljs-built_in">test</span> -- -u` to update them.</td><tr><td class="linenos" data-pseudo-content="44"></td><td></td><tr><td class="linenos" data-pseudo-content="45"></td><td>Test Suites: 1 failed, 1 total</td><tr><td class="linenos" data-pseudo-content="46"></td><td>Tests:       2 failed, 2 total</td><tr><td class="linenos" data-pseudo-content="47"></td><td>Snapshots:   1 failed, 1 total</td><tr><td class="linenos" data-pseudo-content="48"></td><td>Time:        7.082s</td><tr><td class="linenos" data-pseudo-content="49"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td><tr><td class="linenos" data-pseudo-content="50"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="51"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td><tr><td class="linenos" data-pseudo-content="52"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="53"></td><td>All files                                                  |    96.15 |       50 |      100 |       96 |                |</td><tr><td class="linenos" data-pseudo-content="54"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="55"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="56"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="57"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="58"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td><tr><td class="linenos" data-pseudo-content="59"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td><tr><td class="linenos" data-pseudo-content="60"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></table></code></pre>
<p>Yes, we can see that it’s picked up on the change and thrown an error. Note this line:</p>
<pre><code class="hljs lang-bash singleline"> › 1 snapshot <span class="hljs-built_in">test</span> failed <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite. Inspect your code changes or run with `npm <span class="hljs-built_in">test</span> -- -u` to update them.</code></pre>
<p>Jest is telling us that our snapshot has changed, but if we expect that, we can just run <code>npm test -- -u</code> to replace the existing one with our new one. Then, our tests will pass again.</p>
<p>Now, this component is pretty useless. It doesn’t accept any external input whatsoever, so the response is always going to be the same. How do we test a more dynamic component? Amend the component to look like this:</p>
<pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span></span><span class="hljs-template-variable">{{ issue.name }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {</td><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-attr">props</span>: {</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attr">issue</span>: <span class="hljs-built_in">Object</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>  },</td><tr><td class="linenos" data-pseudo-content="12"></td><td>  data () {</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">return</span> {}</td><tr><td class="linenos" data-pseudo-content="14"></td><td>  }</td><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td><tr><td class="linenos" data-pseudo-content="16"></td><td></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="undefined"></td><tr><td class="linenos" data-pseudo-content="19"></td><td></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span></td></table></code></pre>
<p>We’re now passing the <code>issue</code> object into our component as a prop, and getting the name from that. That will break our test, so we need to amend it to pass through the props:</p>
<pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> Issue <span class="hljs-keyword">from</span> <span class="hljs-string">'../../src/components/Issue.vue'</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">const</span> Constructor = Vue.extend(Issue)</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">const</span> issue = {</td><tr><td class="linenos" data-pseudo-content="6"></td><td>  <span class="hljs-attr">name</span>: <span class="hljs-string">'My Issue'</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> Constructor({</td><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-attr">propsData</span>: { <span class="hljs-attr">issue</span>: issue }</td><tr><td class="linenos" data-pseudo-content="10"></td><td>}).$mount()</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>describe(<span class="hljs-string">'Issue'</span>, () =&gt; {</td><tr><td class="linenos" data-pseudo-content="13"></td><td>  it(<span class="hljs-string">'should render'</span>, () =&gt; {</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    expect(vm.$el.querySelector(<span class="hljs-string">'h1'</span>).textContent).toEqual(<span class="hljs-string">'My Issue'</span>)</td><tr><td class="linenos" data-pseudo-content="15"></td><td>  });</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>  it(<span class="hljs-string">'should match the snapshot'</span>, () =&gt; {</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    expect(vm.$el).toMatchSnapshot()</td><tr><td class="linenos" data-pseudo-content="19"></td><td>  });</td><tr><td class="linenos" data-pseudo-content="20"></td><td>});</td></table></code></pre>
<p>Here we pass our prop into the constructor for the component. Now, let’s run the tests again:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td> FAIL  __test__/components/issue.spec.js</td><tr><td class="linenos" data-pseudo-content="7"></td><td>  ● Issue › should match the snapshot</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    expect(value).toMatchSnapshot()</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    Received value does not match stored snapshot 1.</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    - Snapshot</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    + Received</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>     &lt;div&gt;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>       &lt;h1&gt;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    -    An Issue</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    +    My Issue</td><tr><td class="linenos" data-pseudo-content="20"></td><td>       &lt;/h1&gt;</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     &lt;/div&gt;</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:18:20)</td><tr><td class="linenos" data-pseudo-content="24"></td><td>      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td>  Issue</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    ✓ should render (39ms)</td><tr><td class="linenos" data-pseudo-content="28"></td><td>    ✕ should match the snapshot (25ms)</td><tr><td class="linenos" data-pseudo-content="29"></td><td></td><tr><td class="linenos" data-pseudo-content="30"></td><td>Snapshot Summary</td><tr><td class="linenos" data-pseudo-content="31"></td><td> › 1 snapshot <span class="hljs-built_in">test</span> failed <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite. Inspect your code changes or run with `npm <span class="hljs-built_in">test</span> -- -u` to update them.</td><tr><td class="linenos" data-pseudo-content="32"></td><td></td><tr><td class="linenos" data-pseudo-content="33"></td><td>Test Suites: 1 failed, 1 total</td><tr><td class="linenos" data-pseudo-content="34"></td><td>Tests:       1 failed, 1 passed, 2 total</td><tr><td class="linenos" data-pseudo-content="35"></td><td>Snapshots:   1 failed, 1 total</td><tr><td class="linenos" data-pseudo-content="36"></td><td>Time:        3.717s</td><tr><td class="linenos" data-pseudo-content="37"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td><tr><td class="linenos" data-pseudo-content="38"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="39"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td><tr><td class="linenos" data-pseudo-content="40"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="41"></td><td>All files                                                  |     96.3 |       50 |      100 |    96.15 |                |</td><tr><td class="linenos" data-pseudo-content="42"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="43"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="44"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="45"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="46"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td><tr><td class="linenos" data-pseudo-content="47"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td><tr><td class="linenos" data-pseudo-content="48"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></table></code></pre>
<p>Jest has picked up on our changes and thrown an error. However, because we know the UI has changed, we’re happy with this situation, so we can tell Jest to replace the prior snapshot with <code>npm test -- -u</code> as mentioned earlier:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span> -- -u</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage <span class="hljs-string">"-u"</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td> PASS  __test__/components/issue.spec.js</td><tr><td class="linenos" data-pseudo-content="7"></td><td>  Issue</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    ✓ should render (39ms)</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    ✓ should match the snapshot (14ms)</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>Snapshot Summary</td><tr><td class="linenos" data-pseudo-content="12"></td><td> › 1 snapshot updated <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite.</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>Test Suites: 1 passed, 1 total</td><tr><td class="linenos" data-pseudo-content="15"></td><td>Tests:       2 passed, 2 total</td><tr><td class="linenos" data-pseudo-content="16"></td><td>Snapshots:   1 updated, 1 total</td><tr><td class="linenos" data-pseudo-content="17"></td><td>Time:        3.668s</td><tr><td class="linenos" data-pseudo-content="18"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td><tr><td class="linenos" data-pseudo-content="19"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="20"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td><tr><td class="linenos" data-pseudo-content="21"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td><tr><td class="linenos" data-pseudo-content="22"></td><td>All files                                                  |     96.3 |       50 |      100 |    96.15 |                |</td><tr><td class="linenos" data-pseudo-content="23"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="24"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="25"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="26"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td><tr><td class="linenos" data-pseudo-content="27"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td><tr><td class="linenos" data-pseudo-content="28"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td><tr><td class="linenos" data-pseudo-content="29"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></table></code></pre>
<p>Great, we now have a passing test suite again! That’s all we need to make sure that any regressions in the generated HTML of a component get caught.</p>
<p>Of course, this won’t help with the actual functionality of the component. However, Jest is pretty easy to use to write tests for the actual functionality of the application. If you prefer another testing framework, it’s possible to do the same with them, although I will leave setting them up as an exercise for the reader.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Enforcing a coding standard with PHP CodeSniffer]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/">
        </link>
        <updated>2017-03-15T21:37:11Z</updated>
        <summary type="html"><![CDATA[<p>We all start new projects with the best of intentions - it’ll be clean, fully tested and work perfectly. Sadly as deadlines loom, it’s all too easy to find yourself neglecting your code quality, and once it starts to degrade, getting it back becomes much harder. Many development teams try to adhere to a coding standard, but it can be hard to enforce on other people - it puts you in the uncomfortable position of nagging others all the time.</p>
<p>Fortunately, there’s an easy solution that doesn’t force everyone to use the same IDE. <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP CodeSniffer</a> is a useful package that lets you specify a coding standard and then validate your code against it. That way, you can set up continuous integration and use that to remind people of errors. Better still, it also allows many errors to be fixed automatically.</p>
<p>To use it on your PHP project, run the following command:</p>
<pre><code class="hljs lang-bash singleline">$ composer require --dev squizlabs/php_codesniffer</code></pre>
<p>As this will only ever be used in development, you should use the <code>--dev</code> flag. We also need to specify the settings for our project. This example is for a module to be used with a Laravel application and should be saved as <code>phpcs.xml</code>:</p>
<pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>The coding standard for our project.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>app<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>tests<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">exclude-pattern</span>&gt;</span>*/migrations/*<span class="hljs-tag">&lt;/<span class="hljs-name">exclude-pattern</span>&gt;</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></table></code></pre>
<p>Note the <code>&lt;rule /&gt;</code> tag - this specifies that this project should be validated as PSR2. Also, note the <code>&lt;file /&gt;</code> and <code>&lt;exclude-pattern /&gt;</code> tags - these specify what files should and should not be checked.</p>
<p>With this in place, we’re ready to run PHP CodeSniffer:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpcs</td><tr><td class="linenos" data-pseudo-content="2"></td><td>......................</td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td>Time: 45ms; Memory: 6Mb</td></table></code></pre>
<p>In this case, our code validated successfully. However, if it doesn’t, there’s an easy way to tidy it up. Just run this command:</p>
<pre><code class="hljs lang-bash singleline">$ vendor/bin/phpcbf</code></pre>
<p>That will fix many of the most common problems, and any others should be straightforward to fix.</p>
<p>PHP CodeSniffer makes it extremely straightforward to enforce a coding style. You can write custom rulesets or just use an existing one as you prefer, and it’s easy to fix many common problems automatically. In fact, it makes it so easy that there’s very little excuse <em>not</em> to meet the coding standard.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Decorating Laravel repositories]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/03/01/decorating-laravel-repositories/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/03/01/decorating-laravel-repositories/">
        </link>
        <updated>2017-03-01T23:16:57Z</updated>
        <summary type="html"><![CDATA[<p><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">As mentioned previously</a>, when building any nontrivial Laravel application, it’s prudent to decouple our controllers from the Eloquent ORM (or any other ORM or data source we may be using) by creating an interface, and then writing a repository that implements that interface. We can then resolve the interface to our repository, and use the repository to interact with our data source. Should we need to switch to a different implementation, we then need only create the new repository and amend how Laravel resolves that interface.</p>
<p>The same principle applies when it comes to caching. Database queries are typically a major bottleneck in a web application, and so it’s prudent to implement some form of caching for your queries. However, it’s a bad idea to do so in your controllers, because just as with Eloquent models, you’re tying yourself to one particular implementation and won’t be able to switch without rewriting a good chunk of your controllers, as well as possibly having to maintain large amounts of duplicate code for when a query is made in several places.</p>
<p>Alternatively, you could implement caching within the methods of your repository, which might make sense for smaller projects. However, it means that your repository is now dependent on both the ORM and cache you chose. If you decide you want to change your ORM but retain the same caching system, or vice versa, you’re stuck with writing a new repository to handle both, duplicating work you’ve already done.</p>
<p>Fortunately, there’s a more elegant solution. Using the <a href="http://designpatternsphp.readthedocs.io/en/latest/Structural/Decorator/README.html">decorator pattern</a>, we can create a second repository that implements the same interface and “wraps” the original repository. Each of its methods will call its counterpart in the original, and if appropriate cache the response. That way, our caching is implemented separately from our database interactions, and we can easily create a repository for a new data source without affecting the caching in the slightest.</p>
<p>Say we have the following interface for our <code>User</code> model:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span>;</td><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></table></code></pre>
<p>And the following repository implements that interface:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EloquentUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">private</span> $model;</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $model)</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;model = $model;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;all();</td><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;findOrFail($id);</td><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="27"></td><td></td><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="30"></td><td>        $user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">$this</span>-&gt;model;</td><tr><td class="linenos" data-pseudo-content="31"></td><td>        $user-&gt;email = $input[<span class="hljs-string">'email'</span>];</td><tr><td class="linenos" data-pseudo-content="32"></td><td>        $user-&gt;name = $input[<span class="hljs-string">'name'</span>];</td><tr><td class="linenos" data-pseudo-content="33"></td><td>        $user-&gt;password = Hash::make($input[<span class="hljs-string">'password'</span>]);</td><tr><td class="linenos" data-pseudo-content="34"></td><td>        $user-&gt;save();</td><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">return</span> $user;</td><tr><td class="linenos" data-pseudo-content="36"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="37"></td><td>}</td></table></code></pre>
<p>We might implement the following repository class to handle caching:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span> <span class="hljs-title">as</span> <span class="hljs-title">Cache</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(UserRepositoryInterface $repository, Cache $cache)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember(<span class="hljs-string">'all'</span>, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;all();</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="26"></td><td></td><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></td><tr><td class="linenos" data-pseudo-content="28"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember($id, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($id)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;findOrFail($id);</td><tr><td class="linenos" data-pseudo-content="31"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="33"></td><td></td><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></td><tr><td class="linenos" data-pseudo-content="35"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;flush();</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create($input);</td><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></table></code></pre>
<p>Note how each method doesn’t actually do any querying. Instead, the constructor accepts an implementation of the same interface and the cache, and we defer all interactions with the database to that implementation. Each call that queries the database is wrapped in a callback so that it’s stored in Laravel’s cache when it’s returned, without touching the original implementation. When a user is created, the users tag is flushed from the cache so that stale results don’t get served.</p>
<p>To actually use this implementation, we need to update our service provider so that it resolves the interface to an implementation of our decorator:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;singleton(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td><tr><td class="linenos" data-pseudo-content="27"></td><td>            $baseRepo = <span class="hljs-keyword">new</span> \App\Repositories\EloquentUserRepository(<span class="hljs-keyword">new</span> \App\User);</td><tr><td class="linenos" data-pseudo-content="28"></td><td>            $cachingRepo = <span class="hljs-keyword">new</span> \App\Repositories\Decorators\CachingUserRepository($baseRepo, <span class="hljs-keyword">$this</span>-&gt;app[<span class="hljs-string">'cache.store'</span>]);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-keyword">return</span> $cachingRepo;</td><tr><td class="linenos" data-pseudo-content="30"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="32"></td><td>}</td></table></code></pre>
<p>We instantiate the base repository, passing it the appropriate model. Then we instantiate the decorator, passing it the base repository and the cache, and return it. Now our controllers will start using the new decorator.</p>
<h2 id="testing-the-decorator">Testing the decorator</h2>
<p>Now that we have a working decorator, how do we test it? Just as with the decorator itself, we want our tests to be completely decoupled from any particular implementation of the dependencies. If in future we’re asked to migrate the database to MongoDB, say, we’ll have plenty of work writing our new database repositories, so we don’t want to have to rewrite the tests for our decorator as well. Fortunately, using Mockery we can just mock the interface for the repository, and pass that mock into the constructor of the decorator in our test. That way we can have the mock return a known response and not involve either the database repository or the underlying models in any way.</p>
<p>We will also want to mock the cache itself, as this is a unit test and so as far as possible it should not be testing anything outside of the repository class. Here’s an example of how we might test the above decorator.</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>\<span class="hljs-title">CachingUserRepository</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * Test fetching all items</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingAll</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'all'</span>)-&gt;andReturn([]);</td><tr><td class="linenos" data-pseudo-content="21"></td><td></td><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td><tr><td class="linenos" data-pseudo-content="23"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn([]);</td><tr><td class="linenos" data-pseudo-content="26"></td><td></td><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td><tr><td class="linenos" data-pseudo-content="28"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td><tr><td class="linenos" data-pseudo-content="29"></td><td></td><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Get all</span></td><tr><td class="linenos" data-pseudo-content="31"></td><td>        $items = $repository-&gt;all();</td><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertCount(<span class="hljs-number">0</span>, $items);</td><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="34"></td><td></td><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="36"></td><td>     * Test fetching a single item</td><tr><td class="linenos" data-pseudo-content="37"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="39"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFindOrFail</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="41"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td><tr><td class="linenos" data-pseudo-content="43"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td><tr><td class="linenos" data-pseudo-content="44"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'findOrFail'</span>)-&gt;with(<span class="hljs-number">1</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td><tr><td class="linenos" data-pseudo-content="45"></td><td></td><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td><tr><td class="linenos" data-pseudo-content="47"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td><tr><td class="linenos" data-pseudo-content="48"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td><tr><td class="linenos" data-pseudo-content="49"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td><tr><td class="linenos" data-pseudo-content="50"></td><td></td><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td><tr><td class="linenos" data-pseudo-content="52"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td><tr><td class="linenos" data-pseudo-content="53"></td><td></td><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment">// Get all</span></td><tr><td class="linenos" data-pseudo-content="55"></td><td>        $item = $repository-&gt;findOrFail(<span class="hljs-number">1</span>);</td><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNull($item);</td><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="58"></td><td></td><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="60"></td><td>     * Test creating a single item</td><tr><td class="linenos" data-pseudo-content="61"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="62"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreate</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="65"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td><tr><td class="linenos" data-pseudo-content="67"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td><tr><td class="linenos" data-pseudo-content="68"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>])-&gt;andReturn(<span class="hljs-keyword">true</span>);</td><tr><td class="linenos" data-pseudo-content="69"></td><td></td><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td><tr><td class="linenos" data-pseudo-content="71"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td><tr><td class="linenos" data-pseudo-content="72"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'usersUser'</span>)-&gt;andReturn($cache);</td><tr><td class="linenos" data-pseudo-content="73"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'flush'</span>)-&gt;andReturn(<span class="hljs-keyword">true</span>);</td><tr><td class="linenos" data-pseudo-content="74"></td><td></td><tr><td class="linenos" data-pseudo-content="75"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td><tr><td class="linenos" data-pseudo-content="76"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td><tr><td class="linenos" data-pseudo-content="77"></td><td></td><tr><td class="linenos" data-pseudo-content="78"></td><td>        <span class="hljs-comment">// Get all</span></td><tr><td class="linenos" data-pseudo-content="79"></td><td>        $item = $repository-&gt;create([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td><tr><td class="linenos" data-pseudo-content="80"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertTrue($item);</td><tr><td class="linenos" data-pseudo-content="81"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="82"></td><td></td><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="84"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="85"></td><td>        m::close();</td><tr><td class="linenos" data-pseudo-content="86"></td><td>        <span class="hljs-keyword">parent</span>::tearDown();</td><tr><td class="linenos" data-pseudo-content="87"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="88"></td><td>}</td></table></code></pre>
<p>As you can see, all we care about is that the underlying repository interface receives the correct method calls and arguments, nothing more. That way our test is fast and repository-agnositc.</p>
<h2 id="other-applications">Other applications</h2>
<p>Here I’ve used this technique to cache the queries, but that’s not the only use case for decorating a repository. For instance, you could decorate a repository to fire events when certain methods are called, and write different decorators when reusing these repositories for different applications. You could create one to log interactions with the repository, or you could use an external library to cache your queries, all without touching your existing repository. Should we need to switch back to our base repository, it’s just a matter of amending the service provider accordingly as both the decorator and the repository implement the same interface.</p>
<p>Creating decorators does mean you have to implement all of the interface’s methods again, but if you have a base repository that your other ones inherit from, you can easily create a base decorator in a similar fashion that wraps methods common to all the repositories, and then just implement the additional methods for each decorator as required. Also, each method is likely to be fairly limited in scope so it’s not generally too onerous.</p>
]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[My first Laravel package]]></title>
        <id>https://matthewdaly.co.uk/blog/2017/02/19/my-first-laravel-package/</id>
        <link href="https://matthewdaly.co.uk/blog/2017/02/19/my-first-laravel-package/">
        </link>
        <updated>2017-02-19T15:50:11Z</updated>
        <summary type="html"><![CDATA[<p>For some time now I’ve had a Laravel middleware I use extensively to add ETags to HTTP requests. I often use it for work projects, but obviously copying and pasting it all the time was a pain. I always meant to create a package for it, but I didn’t want to do so until such time as I had some proper tests for it. Now I’ve finally figured out how to test middleware in isolation and I’ve got around to adding tests and creating a proper package for it.</p>
<p>It’s available on <a href="https://github.com/matthewbdaly/laravel-etag-middleware">Github</a> and <a href="https://packagist.org/packages/matthewbdaly/laravel-etag-middleware">Packagist</a> if you want to use it.</p>
]]></summary>
    </entry>
</feed>