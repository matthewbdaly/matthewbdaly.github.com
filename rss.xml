<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Matthew Daly&apos;s Blog</title>
        <link>https://matthewdaly.co.uk</link>
        <description>I&apos;m a web developer in Norfolk. This is my blog...</description>
        <lastBuildDate>Thu, 06 Dec 2018 18:35:50 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <generator>grunt-blogbuilder https://github.com/matthewbdaly/grunt-blogbuilder</generator>
        <copyright>Matthew Daly 2018</copyright>
        <item>
            <title><![CDATA[Decorating service classes]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/12/06/decorating-service-classes/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/12/06/decorating-service-classes/</guid>
            <pubDate>Thu, 06 Dec 2018 18:34:16 GMT</pubDate>
            <description><![CDATA[<p>I’ve written before about using decorators to extend the functionality of existing classes, in the context of the repository pattern when working with Eloquent. However, the same practice is applicable in many other contexts.</p>
<p>Recently, I was asked to add RSS feeds to the home page of the legacy project that is my main focus these days. The resulting service class looked something like this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Rss</span>\<span class="hljs-title">Feed</span>\<span class="hljs-title">Reader</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">FeedFetcher</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RssFetcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeedFetcher</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> Reader::import($url);</td><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></table></code></pre>
<p>In accordance with the principle of loose coupling, I also created an interface for it:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FeedFetcher</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td>}</td></table></code></pre>
<p>I was recently able to add dependency injection to the project using PHP-DI, so now I can inject an instance of the feed fetcher into the controller by typehinting the interface and having it resolve to the <code>RssFetcher</code> class.</p>
<p>However, there was an issue. I didn’t want the application to make multiple HTTP requests to fetch those feeds every time the page loads. At the same time, it was also a bit much to have a scheduled task running to fetch those feeds and store them in the database, since many times that would be unnecessary. The obvious solution was to cache the feed content for a specified length of time, in this case five minutes.</p>
<p>I <em>could</em> have integrated the caching into the service class itself, but that wasn’t the best practice, because it would be tied to that implementation. If in future we needed to switch to a different feed handler, we’d have to re-implement the caching functionality. So I decided it made sense to decorate the service class.</p>
<p>The decorator class implemented the same interface as the feed fetcher, and accepted another instance of that interface in the constructor, along with a PSR6-compliant caching library. It looked something like this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">FeedFetcher</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">CacheItemPoolInterface</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FetcherCachingDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeedFetcher</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $fetcher;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(FeedFetcher $fetcher, CacheItemPoolInterface $cache)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fetcher = $fetcher;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;cache-&gt;getItem(<span class="hljs-string">'feed_'</span>.$url);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">if</span> (!$item-&gt;isHit()) {</td><tr><td class="linenos" data-pseudo-content="24"></td><td>            $item-&gt;set(<span class="hljs-keyword">$this</span>-&gt;fetcher-&gt;fetch($url));</td><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-keyword">$this</span>-&gt;cache-&gt;save($item);</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get();</td><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="29"></td><td>}</td></table></code></pre>
<p>Now, when you instantiate the feed fetcher, you wrap it in the decorator as follows:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>$fetcher = <span class="hljs-keyword">new</span> FetcherCachingDecorator(</td><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">new</span> App\Services\RssFetcher,</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        $cache</td><tr><td class="linenos" data-pseudo-content="6"></td><td>);</td></table></code></pre>
<p>As you can see, this solves our problem quite nicely. By wrapping our feed fetcher in this decorator, we keep the caching layer completely separate from any one implementation of the fetcher, so in the event we need to swap the current one out for another implementation, we don’t have to touch the caching layer at all. As long as we’re using dependency injection to resolve this interface, we’re only looking at a little more code to instantiate it.</p>
<p>In addition, this same approach can be applied for other purposes, and you can wrap the fetcher as many times as necessary. For instance, if we wanted to log all the responses we got, we could write a logging decorator something like this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">FeedFetcher</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Log</span>\<span class="hljs-title">LoggerInterface</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeedLoggingDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeedFetcher</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $fetcher;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> logger;</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(FeedFetcher $fetcher, LoggerInterface $logger)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fetcher = $fetcher;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;logger = $logger;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;fetcher-&gt;fetch($url);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;logger-&gt;info($response);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">return</span> $response;</td><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></table></code></pre>
<p>The same idea can be applied to an API client. For instance, say we have the following interface for an API client:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Contracts</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Objects</span>\<span class="hljs-title">Item</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Objects</span>\<span class="hljs-title">ItemCollection</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Client</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAll</span><span class="hljs-params">()</span>: <span class="hljs-title">ItemCollection</span></span>;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span><span class="hljs-params">(int $id)</span>: <span class="hljs-title">Item</span></span>;</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span>: <span class="hljs-title">Item</span></span>;</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(int $id, array $data)</span>: <span class="hljs-title">Item</span></span>;</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span><span class="hljs-params">(int $id)</span></span>;</td><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></table></code></pre>
<p>Now, of course any good API client should respect HTTP headers and use those to do some caching itself, but depending on the use case, you may also want to cache these requests yourself. For instance, if the only changes to the entities stored by the third party API will be ones you’ve made, or they don’t need to be 100% up to date, you may be better off caching those responses before they reach the actual API client. Under those circumstances, you might write a decorator like this to do the caching:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Client</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">CacheItemPoolInterface</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Client</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $client;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Client $client, CacheItemPoolInterface $cache)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;client = $client;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAll</span><span class="hljs-params">()</span>: <span class="hljs-title">ItemCollection</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;cache-&gt;getItem(<span class="hljs-string">'item_all'</span>);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">if</span> (!$item-&gt;isHit()) {</td><tr><td class="linenos" data-pseudo-content="24"></td><td>            $item-&gt;set(<span class="hljs-keyword">$this</span>-&gt;client-&gt;getAll());</td><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-keyword">$this</span>-&gt;cache-&gt;save($item);</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get();</td><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="29"></td><td></td><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span><span class="hljs-params">(int $id)</span>: <span class="hljs-title">Item</span></td><tr><td class="linenos" data-pseudo-content="31"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="32"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;cache-&gt;getItem(<span class="hljs-string">'item_'</span>.$id);</td><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">if</span> (!$item-&gt;isHit()) {</td><tr><td class="linenos" data-pseudo-content="34"></td><td>            $item-&gt;set(<span class="hljs-keyword">$this</span>-&gt;client-&gt;find($id));</td><tr><td class="linenos" data-pseudo-content="35"></td><td>            <span class="hljs-keyword">$this</span>-&gt;cache-&gt;save($item);</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get();</td><tr><td class="linenos" data-pseudo-content="38"></td><td></td><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="40"></td><td></td><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span>: <span class="hljs-title">Item</span></td><tr><td class="linenos" data-pseudo-content="42"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="43"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;clear();</td><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;client-&gt;create($data);</td><tr><td class="linenos" data-pseudo-content="45"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="46"></td><td></td><tr><td class="linenos" data-pseudo-content="47"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(int $id, array $data)</span>: <span class="hljs-title">Item</span></td><tr><td class="linenos" data-pseudo-content="48"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;clear();</td><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;client-&gt;update($id, $data);</td><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="52"></td><td></td><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span><span class="hljs-params">(int $id)</span></td><tr><td class="linenos" data-pseudo-content="54"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;clear();</td><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;client-&gt;delete($id);</td><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="58"></td><td>}</td></table></code></pre>
<p>Any methods that change the state of the data on the remote API will clear the cache, while any that fetch data will first check the cache, only explicitly fetching data from the API when the cache is empty, and caching it again. I won’t go into how you might write a logging decorator for this, but it should be straightforward to figure out for yourself.</p>
<p>The decorator pattern is a very powerful way of adding functionality to a class without tying it to a specific implementation. If you’re familiar with how middleware works, decorators work in a very similar fashion in that you can wrap your service in as many layers as you wish in order to accomplish specific tasks, and they adhere to the single responsibility principle by allowing you to use different decorators for different tasks.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Simplify your tests with anonymous classes]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/</guid>
            <pubDate>Sat, 20 Oct 2018 13:48:05 GMT</pubDate>
            <description><![CDATA[<p>Anonymous classes were added in PHP7, but so far I haven’t made all that much use of them. However, recently I’ve been working on building a simple dependency injection container for learning purposes. This uses the PHP Reflection API to determine how to resolve dependencies. For instance, if it’s asked for a class for which one of the dependencies required by the constructor is an instance of the <code>DateTime</code> class, it should create an instance, and then pass it into the constructor automatically when instantiating the class. Then it should return the newly created class.</p>
<p>Mocking isn’t really a suitable approach for this use case because the container needs to return a concrete class instance to do its job properly. You could just create a series of fixture classes purely for testing purposes, but that would mean either defining more than one class in a file (violating PSR-2), or defining a load of fixture classes in separate files, meaning you’d have to write a lot of boilerplate, and you’d have to move between several different files to understand what’s going on in the test.</p>
<p>Anonymous classes allow you a means to write simple classes for tests inline, as in this example for retrieving a very basic class. The tests use PHPSpec:</p>
<pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>\<span class="hljs-title">MyClass</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">DateTime</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_dependencies</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        };</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td>}</span></td></table></code></pre>
<p>You can also define your own methods inline. Here we implement the <code>invoke()</code> magic method so that the class is a callable:</p>
<pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_invokable</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span> </span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DateTime;</td><tr><td class="linenos" data-pseudo-content="10"></td><td>            }</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        };</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="15"></td><td>}</span></td></table></code></pre>
<p>You can also define a constructor. Here, we’re getting the class name of a newly created anonymous class that accepts an instance of <code>DateTime</code> as an argument to the constructor. Then, we can resolve a new instance out of the container:</p>
<pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_dependencies</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-title">new</span> <span class="hljs-title">DateTime</span>) </span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> $datetime;</td><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DateTime $datetime)</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>            </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-keyword">$this</span>-&gt;datetime = $datetime;</td><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td>}</span></td></table></code></pre>
<p>For classes that will extend an existing class or implement an interface, you can define those inline too. Or you can include a trait:</p>
<pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_dependencies</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-title">new</span> <span class="hljs-title">DateTime</span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Bar</span> </span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> $datetime;</td><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DateTime $datetime)</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>            </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-keyword">$this</span>-&gt;datetime = $datetime;</td><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-keyword">use</span> <span class="hljs-title">MyTrait</span>;</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="19"></td><td>}</span></td></table></code></pre>
<p>In cases where the functionality is contained in a trait or abstract class, and you might need to add little or no additional functionality, this is a lot less verbose than creating a class the conventional way.</p>
<p>None of this is stuff you can’t do without anonymous classes, but by defining these sort of disposable fixture classes inline in your tests, you’re writing the minimum amount of code necessary to implement your test, and it’s logical to define it inline since it’s only ever used in the tests. One thing to bear in mind is that anonymous classes are created and instantiated at the same time, so you can’t easily create a class and then instantiate an instance of it separately. However, you can instantiate one, then use the <code>get_class()</code> function to get its class name and use that to resolve it, which worked well for my use case.</p>
<p>Another use case for anonymous classes is testing traits or abstract classes. I generally use Mockery as my mocking solution with PHPUnit tests, but I’ve sometimes missed the <code>getMockForTrait()</code> method from PHPUnit. However, another option is to instantiate an anonymous class that includes that trait for testing purposes:</p>
<pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td>$item = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>() </span>{</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">MyTrait</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td>};</span></td></table></code></pre>
<p>This way, your test class is as minimal as possible, and you can test the trait/abstract class in a fairly isolated fashion.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Adding React to a legacy project]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/10/16/adding-react-to-a-legacy-project/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/10/16/adding-react-to-a-legacy-project/</guid>
            <pubDate>Tue, 16 Oct 2018 08:00:29 GMT</pubDate>
            <description><![CDATA[<p>The project I’m currently working on is a textbook example of what happens when a project uses jQuery when it really ought to use a proper Javascript framework, or it starts out just using jQuery and grows out of all proportion. It’s also not helped by the fact that historically it’s just been worked on when new functionality needs to be added, meaning that rather than refactoring the code base, it’s been copied-and-pasted. As a result, there’s lots of repetitive code in desparate need of refactoring, and huge reams of horrible jQuery spaghetti code.</p>
<p>When I first took over responsibility for the project, I integrated Laravel Mix into it so that I had the means to refactor some of the common functionality into separate files and require them during the build process, as well as use ES6. However, this was only the first step, as it didn’t sort out the fundamental problem of repetitive boilerplate code being copied and pasted. What I needed was a refactor to use something more opinionated. As it happened, I was asked to add a couple of modals to the admin, and since the modals were one of the worst parts of the admin in terms of repetitive code, they were a strong candidate for implementing using a more suitable library.</p>
<p>I looked at a few options:</p>
<ul>
<li>I’ve used Angular 1 quite successfully in the past, but I didn’t really want to use a framework that was being killed off, and it would be difficult to retrofit into a legacy application</li>
<li>Angular 2+ is actively maintained, but it would again be difficult to retrofit it into a legacy application. In addition, the need for TypeScript would make it problematic.</li>
<li>Vue was a possibility, but it did a bit too much for this use case, and it wasn’t all that clear how to retrofit it to an existing application</li>
</ul>
<p>Eventually, I settled on React.js, for the following reasons:</p>
<ul>
<li>It has a preset in Laravel Mix, making it easy to get started with it.</li>
<li>It has a very limited target - React is closely focused on the view layer, dealing only with rendering and event handling, so it does just what I needed in this case.</li>
<li>It has a strong record of use with legacy applications - after all, it was created by Facebook and they added it incrementally.</li>
<li>It’s easy to test - Jest’s snapshot tests make it easy to verify the rendered content hasn’t changed, and using Enzyme it’s straightforward to test interactions with the component</li>
<li>Higher order components provide a straightforward way to share functionality between components, which I needed to allow different modals to deal with another modal in the same way.</li>
<li>By creating a series of components for common user interface elements, I could then re-use those components in future work, saving time and effort.</li>
</ul>
<p>However, it wasn’t entirely clear how I might go about integrating React into a legacy application. In the end, I managed to figure out an approach which worked.</p>
<p>Normally, I would create a single root for my application, something like this:</p>
<pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/App'</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>ReactDOM.render(</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>,</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    document.getElementById('root')</td><tr><td class="linenos" data-pseudo-content="8"></td><td>);</span></td></table></code></pre>
<p>However, that wasn’t an option here. The existing modals were using jQuery and Bootstrap, and the new modals had to work with them. I therefore needed to have only certain parts of the UI managed with React, and the rest wouldn’t be touched. Here’s an example of how I rendered the modal in the end:</p>
<pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> higherOrderComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/higherOrderComponent'</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> modalComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/modalComponent'</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">const</span> Modal = higherOrderComponent(modalComponent);</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-built_in">window</span>.componentWrapper = ReactDOM.render(</td><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> /&gt;</span>,</td><tr><td class="linenos" data-pseudo-content="9"></td><td>  document.getElementById('modalTarget')</td><tr><td class="linenos" data-pseudo-content="10"></td><td>);</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>window.componentWrapper.setState({</td><tr><td class="linenos" data-pseudo-content="13"></td><td>  foo: 'bar'</td><tr><td class="linenos" data-pseudo-content="14"></td><td>});</span></td></table></code></pre>
<p>By extracting the duplicate functionality into a higher order component, I could easily wrap the new modals in that component and share that functionality between the modals. I could then render each component in a different target element, and assign it to a variable in the <code>window</code> namespace. The div with a ID of <code>modalTarget</code> needed to be added in the appropriate place, but otherwise the HTML didn’t need to be touched, since the required markup was in the React component instead.</p>
<p>Then, when I needed to change a value int the statee of the component, I could just call <code>window.componentWrapper.setState({})</code>, passing through the values to set, and these would propogate down to the child components as usual. I could also render multiple different modal components on the page, and refer to each one separately in order to set the state.</p>
<p>This isn’t an approach I’d recommend on a greenfield project - state isn’t really something you should be setting from outside a component like this, and normally I wouldn’t do it. However, it seemed to be the easiest way for this particular use case. Over time I’ll port more and more of the UI over to React, and eventually it won’t be necessary as I’ll be storing the application state in something like Redux.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Do you still need jQuery?]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/10/11/do-you-still-need-jquery/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/10/11/do-you-still-need-jquery/</guid>
            <pubDate>Thu, 11 Oct 2018 08:21:58 GMT</pubDate>
            <description><![CDATA[<p>There was a time not so long ago when jQuery was ubiquitous. It was used on almost every website as a matter of course, to the point that many HTML boilerplates included a reference to the CDN.</p>
<p>However, more and more I think it’s probably unnecessary for two main use cases:</p>
<h2 id="jquery-is-probably-unnecessary-for-many-web-apps-with-simple-javascript">jQuery is probably unnecessary for many web apps with simple Javascript</h2>
<p>When jQuery first appeared, IE6 was commonplace, and browser API’s were notoriously inconsistent. jQuery was very useful in ironing out those inconsistencies and helping to make the developer’s experience a bit better.</p>
<p>Nowadays, that’s no longer the case. Internet Explorer is on its way out, with IE11 being the only version still supported by Microsoft, and it’s becoming increasingly hard to justify support for older versions, especially with mobile browsers forming a bigger than ever chunk of the market. We’ll probably need to continue supporting IE11 for a good long while, and possibly IE10 for some time too, but these aren’t anything like as bad to work with as IE6. It’s worth noting that newer versions of jQuery are also dropping support for these older browsers, so in many ways it actually does less than it used to.</p>
<p><a href="http://lmgtfy.com/?q=do+you+still+need+jquery">This is the usual thrust of articles on whether you should still be using jQuery</a> so I’m not going to go over this matter , but for many smaller web apps, jQuery is no longer necessary, and a lot of developers have a tendency to keep using it when it’s probably not required.</p>
<h2 id="jquery-is-insufficient-for-web-apps-with-complex-javascript">jQuery is insufficient for web apps with complex Javascript</h2>
<p>Nowadays, there’s a lot of web applications that have moved big chunks of functionality from the server side to the client side. Beyond a certain (and quite small) level of complexity, jQuery just doesn’t do enough to cut it. For me personally, the nature of the projects I work on means that this is a far, far bigger issue than the first one.</p>
<p>I used to work predominantly with Phonegap, which meant that a lot of functionality traditionally done on the server side had to be moved to the client side, and for that jQuery was never sufficient. My first Phonegap app started out using jQuery, but it quickly became obvious that it was going to be problematic. It wound up as a huge mass of jQuery callbacks and Handlebars templates, which was almost impossible to test and hard to maintain. Given this experience, I resolved to switch to a full-fledged Javascript framework next time I built a mobile app, and for the next one I chose Backbone.js, which still used jQuery as a dependency, but made things more maintainable by giving a structure that it didn’t have before, which was the crucial difference.</p>
<p>The more modern generation of Javascript frameworks such as Vue and React, go further in making jQuery redundant. Both of these implement a so-called Virtual DOM, which is used to calculate the minimum changes required to re-render the element in question. Subsequently using jQuery to mutate the DOM would cause problems because it would get out of sync with the Virtual DOM - in fact, in order to get a jQuery plugin working in the context of a React component, you have to actively prevent React from touching the DOM, thereby losing most of the benefits of using React in the first place. You usually see better results from using a React component designed for that purpose (or writing one, which React makes surprisingly simple), than from trying to shoehorn a jQuery plugin into it.</p>
<p>They also make a lot of things that jQuery does trivially easy - for instance, if you want to conditionally show and hide content in a React component, it’s just a case of building it to hide that content based on a particular value in the props or state, or filtering a list is just a case of applying a filter to the array containing the data and setting the state as appropriate.</p>
<p>In short, for single-page web apps or other ones with a lot of Javascript, you should look at other solutions first, and not just blithely assume jQuery will be up to the task. It’s technically possible to build this sort of web app using jQuery, but it’s apt to turn into a morass of spaghetti code unless approached with a great deal of discipline, one that sadly many developers don’t have, and it doesn’t exactly make it easy to promote code reuse. These days, I prefer React for complex web apps, because it makes it extremely intuitive to break my user interface up into reusable components, and test them individually. Using React would be overkill on brochure-style sites (unless you wanted to build it with something like Gatsby), but for more complex apps it’s often a better fit than jQuery.</p>
<h2 id="so-when-should-you-use-jquery-">So when should you use jQuery?</h2>
<p>In truth, I’m finding it harder and harder to justify using it at all on new builds. I use it on my personal site because that’s built on Bootstrap 3 and so depends on jQuery, but for bigger web apps I’m generally finding myself moving to React, which renders it not just unnecessary for DOM manipulation, but counter-productive to use it. Most of what I do is big enough to justify something like React, and it generally results in code that is more declarative, easier to test and reason about, and less repetitive. Using jQuery for an application like this is probably a bad idea, because it’s difficult (not impossible, mind, if you follow some of the advice <a href="https://learn.jquery.com/code-organization/">here</a>, use a linter and consider using a proper client-side templating system alongside jQuery) to build an elegant and maintainable Javascript-heavy application.</p>
<p>As a rule of thumb, I find anything which is likely to require more than a few hundred lines of Javascript to be written, is probably complex enough that jQuery isn’t sufficient, and I should instead consider something like React.</p>
<p>I doubt it’d be worth the bother of ripping jQuery out of a legacy application and rewriting the whole thing to not require it, but for new builds I would think very hard about:</p>
<ul>
<li>Whether jQuery is sufficient, or you’d be better off using something like React, Vue or Angular</li>
<li>If it is sufficient, whether it’s actually necessary</li>
</ul>
<p>In all honesty, I don’t think using it when it’s technically not necessary is as much of a big deal as the issue of using it when it’s not really sufficient. Yes, dowloading a library you technically don’t need for a page is a bad practice, and it does make your site slower and harder for users on slow mobile connections, but there are ways to mitigate that such as CDN’s, caching and minification. If you build a web app using jQuery alone when React, Vue or Angular would be more suitable, you’re probably going to have to write a lot more code that will be difficult to maintain, test and understand. Things like React were created to solve the problems that arose when developers built complex client-side applications with jQuery, and are therefore a good fit for bigger applications. The complex setup does mean they have a threshold below which it’s not worth the bother of using them, but past that threshold they result in better, more maintainable, more testable and more reusable code.</p>
<h2 id="now-react-is-cool-you-hate-jquery-you-hipster-">Now React is cool, you hate jQuery, you hipster…</h2>
<p>Don’t be a prat. Bitter experience has taught me that for a lot of my own personal use cases, jQuery is insufficient. It doesn’t suck, it’s just insufficient. If for your use case, jQuery <em>is</em> sufficient, then that’s fine. All I’m saying is that when a web app becomes sufficiently complex, jQuery can begin to cause more problems than it solves, and that for a sufficiently complex web app you should consider other solutions.</p>
<p>I currently maintain a legacy application that includes thousands of lines of Javascript. Most of it is done with jQuery and some plugins, and it’s resulted in some extremely repetitive jQuery callbacks that are hard to maintain and understand, and impossible to test. Recently I was asked to add a couple of modals to the admin interface, and rather than continuing to add them using jQuery and adding more spaghetti code, I instead opted to build them with React. During the process of building the first modal, I produced a number of components for different elements of the UI. Then, when I built the second one, I refactored those components to be more generic, and moved some common functionality into a higher-order component so that it could be reused. Now, if I need to add another modal, it will be trivial because I already have those components available, and I can just create a new component for the modal, import those components that I need, wrap it in the higher-order component if necessary, and that’s all. I can also easily test those components in isolation. In short, I’ve saved myself some work in the long run by writing it to use a library that was a better fit.</p>
<p>It’s not like using jQuery inevitably results in unmaintainable code, but it does require a certain amount of discipline to avoid it. A more opinionated library such as React makes it far, far harder to create spaghetti code, and makes code reuse natural in a way that jQuery doesn’t.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[An approach to writing golden master tests for PHP web applications]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/10/08/an-approach-to-writing-golden-master-tests-for-php-web-applications/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/10/08/an-approach-to-writing-golden-master-tests-for-php-web-applications/</guid>
            <pubDate>Mon, 08 Oct 2018 10:20:53 GMT</pubDate>
            <description><![CDATA[<p>Apologies if some of the spelling or formatting on this post is off - I wrote it on a long train journey down to London, with sunlight at an inconvenient angle.</p>
<p>Recently I had to carry out some substantial changes to the legacy web app I maintain as the lion’s share of my current job. The client has several channels that represent different parts of the business that would expect to see different content on the home page, and access to content is limited first by channel, and then by location. The client wanted an additional channel added. Due to bad design earlier in the application’s lifetime that isn’t yet practical to refactor away, each type of location has its own model, so it was necessary to add a new location model. It also had to work seamlessly, in the same way as the other location types. Unfortunately, these branch types didn’t use polymorphism, and instead used large switch statements, and it wasn’t practical to refactor all that away in one go. This was therefore quite a high-risk job, especially considering the paucity of tests on a legacy code base.</p>
<p>I’d heard of the concept of a <em>golden master test</em> before. If you haven’t heard of it before, the idea is that it works by running a process, capturing the output, and then comparing the output of that known good version against future runs. It’s very much a test of last resort since, in the context of a web app, it’s potentially very brittle since it depends on the state of the application remaining the same between runs to avoid false positives. I needed a set of simple “snapshot tests”, similar to how snapshot testing works with Jest, to catch unexpected breakages in a large number of pages, and this approach seemed to fit the bill. Unfortunately, I hadn’t been able to find a good example of how to do this for PHP applications, so it took a while to figure out something that worked.</p>
<p>Here is an example base test case I used for this approach:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span> <span class="hljs-title">as</span> <span class="hljs-title">BaseTestCase</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Mink</span>\<span class="hljs-title">Driver</span>\<span class="hljs-title">GoutteDriver</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Mink</span>\<span class="hljs-title">Session</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoldenMasterTestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTestCase</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> $driver;</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $session;</td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $baseUrl = <span class="hljs-string">'http://localhost:8000'</span>;</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">protected</span> $snapshotDir = <span class="hljs-string">"tests/snapshots/"</span>;</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">$this</span>-&gt;driver = <span class="hljs-keyword">new</span> GoutteDriver();</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = <span class="hljs-keyword">new</span> Session(<span class="hljs-keyword">$this</span>-&gt;driver);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="24"></td><td></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = <span class="hljs-keyword">null</span>;</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">$this</span>-&gt;driver = <span class="hljs-keyword">null</span>;</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="30"></td><td></td><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loginAs</span><span class="hljs-params">($username, $password)</span></td><tr><td class="linenos" data-pseudo-content="32"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session-&gt;visit(<span class="hljs-keyword">$this</span>-&gt;baseUrl.<span class="hljs-string">'/login'</span>);</td><tr><td class="linenos" data-pseudo-content="34"></td><td>        $page = <span class="hljs-keyword">$this</span>-&gt;session-&gt;getPage();</td><tr><td class="linenos" data-pseudo-content="35"></td><td>        $page-&gt;fillField(<span class="hljs-string">"username"</span>, $username);</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        $page-&gt;fillField(<span class="hljs-string">"password"</span>, $password);</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        $page-&gt;pressButton(<span class="hljs-string">"Sign In"</span>);</td><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="40"></td><td></td><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goto</span><span class="hljs-params">($path)</span></td><tr><td class="linenos" data-pseudo-content="42"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="43"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session-&gt;visit(<span class="hljs-keyword">$this</span>-&gt;baseUrl.$path);</td><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNotEquals(<span class="hljs-number">404</span>, <span class="hljs-keyword">$this</span>-&gt;session-&gt;getStatusCode());</td><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td><tr><td class="linenos" data-pseudo-content="46"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="47"></td><td></td><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveHtml</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="49"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;snapshotExists()) {</td><tr><td class="linenos" data-pseudo-content="51"></td><td>            <span class="hljs-keyword">$this</span>-&gt;saveSnapshot();</td><tr><td class="linenos" data-pseudo-content="52"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="53"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td><tr><td class="linenos" data-pseudo-content="54"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="55"></td><td></td><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assertSnapshotsMatch</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="57"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="58"></td><td>        $path = <span class="hljs-keyword">$this</span>-&gt;getPath();</td><tr><td class="linenos" data-pseudo-content="59"></td><td>        $newHtml = <span class="hljs-keyword">$this</span>-&gt;processHtml(<span class="hljs-keyword">$this</span>-&gt;getHtml());</td><tr><td class="linenos" data-pseudo-content="60"></td><td>        $oldHtml = <span class="hljs-keyword">$this</span>-&gt;getOldHtml();</td><tr><td class="linenos" data-pseudo-content="61"></td><td>        $diff = <span class="hljs-string">""</span>;</td><tr><td class="linenos" data-pseudo-content="62"></td><td>        <span class="hljs-keyword">if</span> (function_exists(<span class="hljs-string">'xdiff_string_diff'</span>)) {</td><tr><td class="linenos" data-pseudo-content="63"></td><td>            $diff = xdiff_string_diff($oldHtml, $newHtml);</td><tr><td class="linenos" data-pseudo-content="64"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="65"></td><td>        $message = <span class="hljs-string">"The path $path does not match the snapshot\n$diff"</span>;</td><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">self</span>::assertThat($newHtml == $oldHtml, <span class="hljs-keyword">self</span>::isTrue(), $message);</td><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="68"></td><td></td><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHtml</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="70"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="71"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;session-&gt;getPage()-&gt;getHtml();</td><tr><td class="linenos" data-pseudo-content="72"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="73"></td><td></td><tr><td class="linenos" data-pseudo-content="74"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPath</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="75"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="76"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;session-&gt;getCurrentUrl();</td><tr><td class="linenos" data-pseudo-content="77"></td><td>        $path = parse_url($url, PHP_URL_PATH);</td><tr><td class="linenos" data-pseudo-content="78"></td><td>        $query = parse_url($url, PHP_URL_QUERY);</td><tr><td class="linenos" data-pseudo-content="79"></td><td>        $frag = parse_url($url, PHP_URL_FRAGMENT);</td><tr><td class="linenos" data-pseudo-content="80"></td><td>        <span class="hljs-keyword">return</span> $path.$query.$frag;</td><tr><td class="linenos" data-pseudo-content="81"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="82"></td><td></td><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEscapedPath</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="84"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="85"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;snapshotDir.str_replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">'_'</span>, <span class="hljs-keyword">$this</span>-&gt;getPath()).<span class="hljs-string">'.snap'</span>;</td><tr><td class="linenos" data-pseudo-content="86"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="87"></td><td></td><tr><td class="linenos" data-pseudo-content="88"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">snapshotExists</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="89"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="90"></td><td>        <span class="hljs-keyword">return</span> file_exists(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath());</td><tr><td class="linenos" data-pseudo-content="91"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="92"></td><td></td><tr><td class="linenos" data-pseudo-content="93"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processHtml</span><span class="hljs-params">($html)</span></td><tr><td class="linenos" data-pseudo-content="94"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="95"></td><td>        <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-string">'/&lt;input type="hidden"[^&gt;]+\&gt;/i'</span>, <span class="hljs-string">''</span>, $html);</td><tr><td class="linenos" data-pseudo-content="96"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="97"></td><td></td><tr><td class="linenos" data-pseudo-content="98"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveSnapshot</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="99"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="100"></td><td>        $html = <span class="hljs-keyword">$this</span>-&gt;processHtml(<span class="hljs-keyword">$this</span>-&gt;getHtml());</td><tr><td class="linenos" data-pseudo-content="101"></td><td>        file_put_contents(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath(), $html);</td><tr><td class="linenos" data-pseudo-content="102"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="103"></td><td></td><tr><td class="linenos" data-pseudo-content="104"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOldHtml</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="105"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="106"></td><td>        <span class="hljs-keyword">return</span> file_get_contents(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath());</td><tr><td class="linenos" data-pseudo-content="107"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="108"></td><td>}</td></table></code></pre>
<p>Because this application is built with Zend 1 and doesn’t have an easy way to get the HTML response without actually running the application, I was forced to use an actual HTTP client to fetch the content while the web server is running. I’ve used Mink together with Behat many times in the past, and the Goutte driver is fast and doesn’t rely on Javascript, so that was the best bet for a simple way of retrieving the HTML. Had I been taking this approach with a Laravel application, I could have populated the testing database with a common set of fixtures, and passed a request object through the application and captured the response object’s output rather than using an HTTP client, thereby eliminating the need to run a web server and making the tests faster and less brittle.</p>
<p>Another issue was CSRF handling. A CSRF token is, by definition, generated randomly each time the page is loaded, and so it broke those pages that had forms with CSRF tokens. The solution I came up with was to strip out the hidden input fields.</p>
<p>When each page is tested, the first step is to fetch the content of that page. The test case then checks to see if there’s an existing snapshot. If not, the content is saved as a new snapshot file. Otherwise, the two snapshots are compared, and the test fails if they do not match.</p>
<p>Once that base test case was in place, it was then straightforward to extend it to test multiple pages. I wrote one test to check pages that did not require login, and another to check pages that did require login, and the paths for those pages were passed through using a data provider method, as shown below:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMaster</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMasterTestCase</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoldenMasterTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GoldenMasterTestCase</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@dataProvider</span> nonAuthDataProvider</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testNonAuthPages</span><span class="hljs-params">($data)</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;goto($data)</td><tr><td class="linenos" data-pseudo-content="15"></td><td>            -&gt;saveHtml()</td><tr><td class="linenos" data-pseudo-content="16"></td><td>            -&gt;assertSnapshotsMatch();</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nonAuthDataProvider</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="22"></td><td>            [<span class="hljs-string">'/login'</span>],</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        ];</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@dataProvider</span> dataProvider</td><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPages</span><span class="hljs-params">($data)</span></td><tr><td class="linenos" data-pseudo-content="30"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;loginAs(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>)</td><tr><td class="linenos" data-pseudo-content="32"></td><td>            -&gt;goto($data)</td><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;saveHtml()</td><tr><td class="linenos" data-pseudo-content="34"></td><td>            -&gt;assertSnapshotsMatch();</td><tr><td class="linenos" data-pseudo-content="35"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="36"></td><td></td><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dataProvider</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="38"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="40"></td><td>            [<span class="hljs-string">'/foo'</span>],</td><tr><td class="linenos" data-pseudo-content="41"></td><td>            [<span class="hljs-string">'/bar'</span>],</td><tr><td class="linenos" data-pseudo-content="42"></td><td>        ];</td><tr><td class="linenos" data-pseudo-content="43"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="44"></td><td>}</td></table></code></pre>
<p>Be warned, this is <em>not</em> an approach I would advocate as a matter of course, and it should only ever be a last resort as an alternative to onerous manual testing for things that can’t be tested in their current form. It’s extremely brittle, and I’ve had to deal with a lot of false positives, although that would be easier if I could populate a testing database beforehand and use that as the basis of the tests. It’s also very slow, with each test taking three or four seconds to run, although again this would be less of an issue if I could pass through a request object and get the response HTML directly. Nonetheless, I’ve found it to be a useful technique as a test of last resort for legacy applications.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Understanding the pipeline pattern]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/10/05/understanding-the-pipeline-pattern/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/10/05/understanding-the-pipeline-pattern/</guid>
            <pubDate>Fri, 05 Oct 2018 18:36:16 GMT</pubDate>
            <description><![CDATA[<p>In a previous post, I used the pipeline pattern to demonstrate processing letters using optical recognition and machine learning. The pipeline pattern is something I’ve found very useful in recent months. For a sequential series of tasks, this approach can make your code easier to understand by allowing you to break it up into simple, logical steps which are easy to test and understand individually. If you’re familiar with pipes and redirection in Unix, you’ll be aware of how you can chain together multiple, relatively simple commands to carry out some very complex transformations on data.</p>
<p>A few months back, I was asked to build a webhook for a Facebook lead form at work. One of my colleagues was having to manually export CSV data from Facebook for the data, and then import it into a MySQL database and a Campaign Monitor mailing list, which was an onerous task, so they asked me to look at more automated solutions. I wound up building a webhook with Lumen that would go through the following steps:</p>
<ul>
<li>Get the lead ID’s from the webhook</li>
<li>Pull the leads from the Facebook API using those ID’s</li>
<li>Process the raw data into a more suitable format</li>
<li>Save the data to the database</li>
<li>Push the data to Campaign Monitor</li>
</ul>
<p>Since this involved a number of discrete steps, I chose to implement each step as a separate stage. That way, each step was easy to test in isolation, and it was easily reusable. As it turned out, this approach saved us because Facebook needed to approve this app (and ended up rejecting it - their documentation at the time wasn’t clear on implementing server-to-server apps, making it hard to meet their guidelines), so we needed an interim solution. I instead wrote an Artisan task for importing the file from a CSV, which involved the following steps:</p>
<ul>
<li>Read the rows from the CSV file</li>
<li>Format the CSV data into the desired format</li>
<li>Save the data to the database</li>
<li>Push the data to Campaign Monitor</li>
</ul>
<p>This meant that two of the existing steps could be reused, as is, without touching the code or tests. I just added two new classes to read the data and format the data, and the Artisan command, which simply called the various pipeline stages, <em>and that was all</em>. In this post, I’ll demonstrate how I implemented this.</p>
<p>While there is more than one implementation of this available, and it wouldn’t be hard to roll your own, I generally use the PHP League’s <a href="https://pipeline.thephpleague.com/">Pipeline package</a>, since it’s simple, solid and well-tested. Let’s say our application has three steps:</p>
<ul>
<li>Format the request data</li>
<li>Save the data</li>
<li>Push it to a third party service.</li>
</ul>
<p>We therefore need to write a stage for each step in the process. Each one must be a callable, such as a closure, a callback, or a class that implements the <code>__invoke()</code> magic method. I usually go for the latter as it allows you to more easily inject dependencies into the stage via its constructor, making it easier to use and test. Here’s what our first stage might look like:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FormatData</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span>: <span class="hljs-title">Collection</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-string">'name'</span> =&gt; $item-&gt;fullname,</td><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">'email'</span> =&gt; $item-&gt;email</td><tr><td class="linenos" data-pseudo-content="15"></td><td>            ];</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td>}</td></table></code></pre>
<p>This class does nothing more than receive a collection, and format the data as expected. We could have it accept a request object instead, but I opted not to because I felt it made more sense to pass the data in as a collection so it’s not tied to an HTTP request. That way, it can also handle data passed through from a CSV file using an Artisan task, and the details of how it receives the data in the first place are deferred to the class that calls the pipeline in the first place. Note this stage also returns a collection, for handling by the next step:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Lead</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SaveData</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span>: <span class="hljs-title">Collection</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            $lead = <span class="hljs-keyword">new</span> Lead;</td><tr><td class="linenos" data-pseudo-content="14"></td><td>            $lead-&gt;name = $item-&gt;name;</td><tr><td class="linenos" data-pseudo-content="15"></td><td>            $lead-&gt;email = $item-&gt;email;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>            $lead-&gt;save();</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">return</span> $lead;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></table></code></pre>
<p>This step saves each lead as an Eloquent model, and returns a collection of the saved models, which are passed to the final step:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">MailingList</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddDataToList</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $list;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(MailingList $list)</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;list = $list;</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">$this</span>-&gt;list-&gt;add([</td><tr><td class="linenos" data-pseudo-content="21"></td><td>                <span class="hljs-string">'name'</span> =&gt; $item-&gt;name,</td><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">'email'</span> =&gt; $item-&gt;email</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            ]);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></table></code></pre>
<p>This step uses a wrapper class for a mailing service, which is passed through as a dependency in the constructor. The <code>__invoke()</code> method then loops through each Eloquent model and uses it to fetch the data, which is then added to the list. With our stages complete, we can now put them together in our controller:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">FormatData</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">SaveData</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">AddDataToList</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">Pipeline</span>;</td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebhookController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request, Pipeline $pipeline, FormatData $formatData, SaveData $savedata, AddDataToList $addData)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">try</span> {</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            $data = Collection::make($request-&gt;get(<span class="hljs-string">'data'</span>));</td><tr><td class="linenos" data-pseudo-content="18"></td><td>            $pipe = $pipeline-&gt;pipe($formatData)</td><tr><td class="linenos" data-pseudo-content="19"></td><td>                -&gt;pipe($saveData)</td><tr><td class="linenos" data-pseudo-content="20"></td><td>                -&gt;pipe($addData);</td><tr><td class="linenos" data-pseudo-content="21"></td><td>            $pipe-&gt;process($data);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        } <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> $e) {</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-comment">// Handle exception</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></table></code></pre>
<p>As mentioned above, we extract the request data (assumed to be an array of data for a webhook), and convert it into a collection. Then, we put together our pipeline. Note that we use dependency injection to fetch the steps - feel free to use method or constructor injection as appropriate. We instantiate our pipeline, and call the <code>pipe()</code> method multiple times to add new stages.</p>
<p>Finally we pass the data through to our pipe for processing by calling the <code>process()</code> method, passing in the initial data. Note that we can wrap the whole thing in a <code>try...catch</code> statement to handle exceptions, so if something happens that would mean we would want to cease processing at that point, we can throw an exception in the stage and handle it outside the pipeline.</p>
<p>This means that our controller is kept very simple. It just gets the data as a collection, then puts the pipeline together and passes the data through. If we subsequently had to write an Artisan task to do something similar from the command line, we could fetch the data via a CSV reader class, and then pass it to the same pipeline. If we needed to change the format of the initial data, we could replace the <code>FormatData</code> class with a single separate class with very little trouble.</p>
<p>Another thing you can do with the League pipeline package, but I haven’t yet had the occasion to try, is use <code>League\Pipeline\PipelineBuilder</code> to build pipelines in a more dynamic fashion. You can make steps conditional, as in this example:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">PipelineBuilder</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td>$builder = (<span class="hljs-keyword">new</span> PipelineBuilder)</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    -&gt;add(<span class="hljs-keyword">new</span> FormatData);</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">if</span> ($data[<span class="hljs-string">'type'</span>] = <span class="hljs-string">'foo'</span>) {</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    $builder-&gt;add(<span class="hljs-keyword">new</span> HandleFooType);</td><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td><tr><td class="linenos" data-pseudo-content="10"></td><td>$builder-&gt;add(<span class="hljs-keyword">new</span> SaveData);</td><tr><td class="linenos" data-pseudo-content="11"></td><td>$pipeline = $builder-&gt;build();</td><tr><td class="linenos" data-pseudo-content="12"></td><td>$pipeline-&gt;process($data);</td></table></code></pre>
<p>The pipeline pattern isn’t appropriate for every situation, but for anything that involves a set of operations on the same data, it makes a lot of sense, and can make it easy to break larger operations into smaller steps that are easier to understand, test, and re-use.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Replacing switch statements with polymorphism in PHP]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/10/03/replacing-switch-statements-with-polymorphism-in-php/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/10/03/replacing-switch-statements-with-polymorphism-in-php/</guid>
            <pubDate>Wed, 03 Oct 2018 22:07:33 GMT</pubDate>
            <description><![CDATA[<p>For the last few months, I’ve been making a point of picking up on certain antipatterns, and ways to avoid or remove them. One I’ve seen a lot recently is unnecessary large switch-case or if-else statements. For instance, here is a simplified example of one of these, which renders links to different objects:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">switch</span> ($item-&gt;getType()) {</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">case</span> <span class="hljs-string">'audio'</span>:</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        $media = <span class="hljs-keyword">new</span> stdClass;</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        $media-&gt;type = <span class="hljs-string">'audio'</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        $media-&gt;duration = $item-&gt;getLength();</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        $media-&gt;name = $item-&gt;getName();</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        $media-&gt;url = $item-&gt;getUrl();</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">case</span> <span class="hljs-string">'video'</span>:</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        $media = <span class="hljs-keyword">new</span> stdClass;</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        $media-&gt;type = <span class="hljs-string">'video'</span>;</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        $media-&gt;duration = $item-&gt;getVideoLength();</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        $media-&gt;name = $item-&gt;getTitle();</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        $media-&gt;url = $item-&gt;getUrl();</td><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="'</span>.$media-&gt;url.<span class="hljs-string">'" class="'</span>.$media-&gt;type.<span class="hljs-string">'" data-duration="'</span>.$media-&gt;duration.<span class="hljs-string">'"&gt;'</span>.$media-&gt;name.<span class="hljs-string">'&lt;/a&gt;'</span>;</td></table></code></pre>
<p>There are a number of problems with this, most notably the fact that it’s doing a lot of work to try and create a new set of objects that behave consistently. Instead, your objects should be polymorphic - in other words, you should be able to treat the original objects the same.</p>
<p>While strictly speaking you don’t need one, it’s a good idea to create an interface that defines the required methods. That way, you can have those objects implement that interface, and be certain that they have all the required methods:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaItem</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLength</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span></span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span>;</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span>;</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span>;</td><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></table></code></pre>
<p>Then, you need to implement that interface in your objects. It doesn’t matter if the implementations are different, as long as the methods exist. That way, objects can define how they return a particular value, which is simpler and more logical than defining it in a large switch-case statement elsewhere. It also helps to prevent duplication. Here’s what the audio object might look like:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MediaItem</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Audio</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaItem</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLength</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;length;</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;name;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;type;</td><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="23"></td><td></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;url;</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></table></code></pre>
<p>And here’s a similar example of the video object:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MediaItem</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Video</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaItem</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLength</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;getVideoLength();</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;getTitle();</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;type;</td><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="23"></td><td></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;url;</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></table></code></pre>
<p>With that done, the code to render the links can be greatly simplified:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="'</span>.$item-&gt;getUrl().<span class="hljs-string">'" class="'</span>.$item-&gt;getType().<span class="hljs-string">'" data-duration="'</span>.$item-&gt;getLength().<span class="hljs-string">'"&gt;'</span>.$media-&gt;getName().<span class="hljs-string">'&lt;/a&gt;'</span>;</td></table></code></pre>
<p>Because we can use the exact same methods and get consistent responses, yet also allow for the different implementations within the objects, this approach allows for much more elegant and readable code. Different objects can be treated in the same way without the need for writing extensive if or switch statements.</p>
<p>I haven’t had the occasion to do so, but in theory this approach is applicable in other languages, such as Javascript or Python (although these languages don’t have the concept of interfaces). Since discovering the swtch statement antipattern and how to replace it with polymorphism, I’ve been able to remove a lot of overly complex code.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Career direction after seven years]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/09/25/career-direction-after-seven-years/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/09/25/career-direction-after-seven-years/</guid>
            <pubDate>Tue, 25 Sep 2018 21:03:29 GMT</pubDate>
            <description><![CDATA[<p>Earlier this month, I passed the seven year anniversary of starting my first web dev job. That job never really worked out, for various reasons, but since then I’ve had an interesting time of it. I’ve diversified into app development via Phonegap, and I’ve worked with frameworks that didn’t exist when I first started. So it seems a good opportunity to take stock and think about where I want to head next.</p>
<p>Sometimes these posts are where someone announces they’re leaving their current role, but that’s not the case here - I’m pretty happy where I am right now. I am maintaining a legacy project, but I do feel like I’m making a difference and it’s slowly becoming more pleasant to work with, and I’m learning a lot about applying design patterns, so I think where I am right now is a good place for me. However, it’s a useful exercise to think about what I want to do, where I want to concentrate my efforts, and what I want to learn about.</p>
<p>So, here are my thoughts about where I want to go in future:</p>
<ul>
<li>I really enjoy working with React, and I want to do so much more than I have in the past, possibly including React Native. Ditto with Redux.</li>
<li>Much as I love Django, it’s unlikely I’ll be using it again in the future, as it’s simply not in much demand where I live. In 2015, I was working at a small agency with a dev team of three, including me, and it became apparent that we needed to standardise on a single framework. I’d been using CodeIgniter on and off for several years, but it was tired and dated, yet I couldn’t justify using Django because no-one else was familiar with Python, so we settled on Laravel. Ever since, Laravel has been my go-to framework - Django does some things better (Django REST Framework remains the best way I’ve ever found to create a REST API), but Laravel does enough stuff well enough that I can use it for most things I need, so it’s a good default option.</li>
<li>I <em>really</em> don’t want to work with Wordpress often, and if I do, I’d feel a lot better about it if I used Bedrock. Just churning out boilerplate sites is anathema to me - I’d much rather do something more interesting, even if it were paid worse.</li>
<li>PHP is actually pretty nice these days (as long as you’re not dealing with a legacy application), and I generally don’t mind working with it, as long as it’s fairly modern.</li>
<li>I enjoy mentoring and coaching others, and I’d like to do that a lot more often than I have been doing. Mentoring and coaching is a big part of being a senior developer, since a good mentor can quickly bring inexperienced developers up to a much higher standard, and hugely reduces the amount of horrible legacy code that needs to be maintained. I was without an experienced mentor for much of my career, and in retrospect it held me back - having someone around to teach me about TDD and design patterns earlier would have helped no end. Also, I find it the single most rewarding part of my job.</li>
<li>I have absolutely no desire whatsoever to go into management, or leave coding behind in any way, shape or form. I’ve heard it said before that Microsoft have two separate career tracks for developers, one through people management, the other into a software architect role, and were I there, I would definitely opt for the latter.</li>
<li>I’m now less interested in learning new frameworks or languages than I am in picking up and applying new design patterns, and avoiding antipatterns - they’re the best way to improve your code quality. I’ve learned the hard way that the hallmark of a skilled developer’s code is not the complexity, but the simplicity - I can now recognise the convoluted code I wrote earlier in my career as painful to maintain, and can identify it in legacy projects.</li>
<li>I’ve always used linters and other code quality tools, and I’m eager to evangelise their usage.</li>
<li>I’ve been a proponent of TDD for several years now, and that’s going to continue - I’ve not only seen how many things it catches when you have tests, but also how painful it is when you have a large legacy project with no tests at all, and I’m absolutely staggered that anyone ever continues to write non-trivial production code without any sort of tests.</li>
<li>I want to understand the frameworks I use at a deeper level - it’s all too easy to just treat them as magic, when there are huge benefits to understanding how your framework works under the bonnet, and how to swap out the framework’s functionality for alternative implementations.</li>
<li>I’d like to get involved in more IoT-related projects - guess the 3 Raspberry Pi’s and the Arduino I have gathering dust at home need to get some more use…</li>
<li>Chat interfaces are interesting - I built an Alexa skill recently, which was fun and useful, and I’d like to do stuff like that more often.</li>
</ul>
<p>So, after seven years, that’s where I see myself going in future. I think I’m in a good place to do that right now, and I’ll probably stay where I am for a good long while yet. The first seven years of my web dev career have been interesting, and I’m eager to see what the next seven bring.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[How I'm refactoring a Zend 1 legacy project]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/09/24/how-i&apos;m-refactoring-a-zend-1-legacy-project/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/09/24/how-i&apos;m-refactoring-a-zend-1-legacy-project/</guid>
            <pubDate>Mon, 24 Sep 2018 21:30:46 GMT</pubDate>
            <description><![CDATA[<p>In my current job I’ve been maintaining and developing a Zend 1 legacy project for the best part of a year. It has to be said, it’s the worst code base I have ever seen, with textbook examples of many antipatterns, spaghetti jQuery, copy-pasted code and overly complex methods. It’s a fairly typical example of a project built on an older MVC framework by inexperienced developers (I’ve been responsible for building similar things in my CodeIgniter days).</p>
<p>In this article I’ll go through some of the steps I’ve taken to help bring this legacy project under control. Not all of them are complete as at time of writing, but they’ve all helped to make this decidedly crappy project somewhat better. In working with this legacy project, I’ve found Paul Jones’ book <em>Modernizing Legacy Applications in PHP</em> to be very useful, and if you’re working on a similar legacy project, I highly recommend investing in a copy. I’ve also found <a href="https://sourcemaking.com/">Sourcemaking</a> to be a useful resource in identifying antipatterns in use, refactoring strategies, and applicable design patterns.</p>
<h1 id="moving-to-git">Moving to Git</h1>
<p>When I first started working on the project, the repository was in Subversion, and was absolutely colossal - checking it out took two hours! Needless to say, my first action was to migrate it to Git. I used <a href="https://john.albin.net/git/convert-subversion-to-git">this post</a> as a guide, and it was pretty straightforward, but took all of my first day.</p>
<h1 id="adding-migrations">Adding migrations</h1>
<p>The next job involved making some changes to the database. Unfortunately, Zend 1 doesn’t include migrations, and no-one had added a third party solution. I therefore did some research and wound up stumbling across <a href="https://phinx.org/">Phinx</a>, which is a standalone migration package with a command-line runner. Using that, it was straightforward to start adding migrations to make any necessary changes to the database structure and fixtures.</p>
<h1 id="moving-dependencies-to-composer">Moving dependencies to Composer</h1>
<p>The project was using Composer, but only to a limited degree - the framework itself was in the <code>library/</code> folder, and several other dependencies were also stored here. The <code>vendor/</code> directory was also checked into version control. I therefore took the vendor folder out of Git, and added <code>zendframework/zendframework1</code> as a dependency. This drastically reduced the size of the repository.</p>
<h1 id="cleaning-up-commented-code">Cleaning up commented code</h1>
<p>There was an awful lot of commented code. Some of it was even commented out incorrectly (PHP code commented out with HTML comments). I’m of the school of thought that commented code is best deleted without a second thought, since it can be retrieved from version control, and it can be confusing, so I’ve been removing any commented code I come across.</p>
<h1 id="refactoring-duplicate-code">Refactoring duplicate code</h1>
<p>One of the biggest problems with the code base was the high level of duplication - a lot of code, particularly in the view layer, had been copied and pasted around. Running PHPCPD on the repository showed that, not including the views, around 12% of the code base was copied-and-pasted, which is a horrific amount. I therefore started aggressively refactoring duplicate code out into helpers and traits. As at today, the amount of duplication excluding the views is around 2.6%, which is obviously a big improvement.</p>
<h1 id="refactoring-object-creation-code-into-persisters">Refactoring object creation code into persisters</h1>
<p>There was some extremely complex code for creating and updating various objects that was jammed into the controllers, and involved a lot of duplicate code. I’ve used dedicated persister classes in the past with great effect, so I pulled that code out into persisters to centralise the logic about the creation of different objects. It’s still a lot more convoluted than I’d like, but at least now it’s out of the controllers and can be tested to some extent.</p>
<h1 id="creating-repositories">Creating repositories</h1>
<p>One of the most problematic parts of the code base is the models. Whoever was responsible for them couldn’t seem to decide whether they represented a single domain object, or a container for methods for getting those objects, so both responsibilities were mixed up in the same class. This means you had to instantiate an object, then use it to call one of the methods to get another instance of that object, as in this example:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$media = <span class="hljs-keyword">new</span> Application_Model_Media;</td><tr><td class="linenos" data-pseudo-content="2"></td><td>$media = $media-&gt;find(<span class="hljs-number">1</span>);</td></table></code></pre>
<p>I’ve therefore resolved to pull those methods out into separate repository classes, leaving the models as pure domain objects. Unfortunately, the lack of dependency injection makes it problematic to instantiate the repositories. For that reason, right now the repositories only implement static methods - it’s not ideal, but it’s better than what we have now.</p>
<p>I started out by creating interfaces for the methods I wanted to migrate, and had the models implement them. Then, I moved those methods from the model to the repository classes and amended all references to them, before removing the interfaces from the models. Now, a typical find request looks like this:</p>
<pre><code class="hljs lang-php singleline">$media = App\Repository\Media::find(<span class="hljs-number">1</span>);</code></pre>
<p>It’s not done yet, but over half of them have been migrated.</p>
<p>Once that’s done, I’ll then be in a position to look at refactoring the logic in the models to make them easier to work with - right now each model has dedicated setters and getters (as well as some horrific logic to populate them), and I’m considering amending them to allow access to the properties via the <code>__get()</code> and <code>__set()</code> magic methods. Another option is to consider migrating the database layer to Doctrine, since that way we can reuse the getters and setters, but I haven’t yet made a firm decision about that.</p>
<h1 id="adding-tests">Adding tests</h1>
<p>The poor design of this application makes it difficult to test, so right now the coverage is poor. I’ve been using Behat to produce a basic set of acceptance tests for some of the most fundamental functionality, but they’re brittle and can be broken by database changes. I’ve also added some (even more brittle) golden master tests using a technique I’ll mention in a later blog post. I have got unit tests for three of the persister classes and some utility classes I’ve added, but nowhere near the level I want.</p>
<h1 id="refactoring-code-out-of-the-fat-controllers">Refactoring code out of the fat controllers</h1>
<p>Fat controllers are an antipattern I’ve seen, and indeed been responsible for myself, in the past, and this project has them in spades - running PHP Mess Detector on them is pretty sobering. The overwhelming majority of the code base is concentrated in the controllers, and it’s going to take a long time to refactor it into other classes.</p>
<p>Zend 1 does have the concept of controller helpers, and that’s been useful for removing some duplicate code, while more shared code has been refactored out into traits. In addition, the utilities I’ve added include a Laravel-style collection class, and using that I’ve been able to refactor a lot of quite complex array handling into much simpler chained collection handling. However, this is still going to take a lot of effort.</p>
<h1 id="adding-events">Adding events</h1>
<p>The lack of a decent event system caused particular problems when I was asked to add tracking of when a user views certain resources, so I used the <a href="http://event.thephpleague.com/2.0/">PHP League’s Event package</a> for this. I’ve started moving some other functionality to event listeners too, but this is another thing that will take a long time.</p>
<h1 id="refactoring-the-front-end">Refactoring the front end</h1>
<p>Like many legacy projects, the front end is a horrible mess of jQuery spaghetti code, with some Handlebars templates thrown in here and there for good measure. It’s easily complex enough that it would benefit from a proper front-end framework, but a full rewrite is out of the question.</p>
<p>I was recently asked to add two new modals in the admin interface, and decided that it was worth taking a new approach rather than adding yet more jQuery spaghetti. Angular 1 is on its way out, so that wasn’t an option, and Angular 2+ would necessitate using Typescript, which would likely be problematic in the context of a legacy app, as well as the complexity being an issue. Vue was a possibility, but I always feel like Vue tries to do too much. Instead, I decided to go for React, because:</p>
<ul>
<li>I’ve always enjoyed working with React, even though I haven’t had much chance to do so in the past.</li>
<li>We’re using Laravel Mix for processing the CSS and JS files (it can be used on non-Laravel projects), and it has a preset for React</li>
<li>React is well-suited to being added incrementally to existing projects without the need for a full rewrite (after all, it works for Facebook…), so it was straightforward to do a single modal with it</li>
<li>It’s easy to test - you can use snapshot tests to check it remains consistent, and using Enzyme it’s straightforward to navigate the rendered component for other tests</li>
</ul>
<p>Both modals turned out very well, and went live recently. The first one took a fair while to write, and then when I wrote the second one, I had to spend some time making the sub-components more generic and pulling some functionality out into a higher order component, but now that that’s done it should be straightforward to write more.</p>
<p>In the longer term I plan to migrate more and more of the admin to React over time. The front end also has a new home page on the cards, and the plan is to use React for that too. Once the whole UI is using React, that will have eliminated most, if not all, of the problems with duplicate code in the view layer, as well as allowing for eventually turning the application into a single-page web app.</p>
<h1 id="upgrading-the-php-version-and-migrating-to-a-new-server">Upgrading the PHP version and migrating to a new server</h1>
<p>When I started work on the project, it was running on an old server running PHP 5.4, but there were plans to migrate to a new server running PHP 5.6. The lack of tests made it difficult to verify it wouldn’t break in 5.6, but using PHP Compatibility and CodeSniffer I was able to find most of the problems. I ran it on PHP 5.6 locally during development so that any new development would be done on a more modern version. In the end, the migration to the new server was fairly seamless.</p>
<p>We will have to consider migrating to a newer PHP version again, since 5.6 is no longer supported as at the end of this year, but it may be too risky for now.</p>
<h1 id="namespacing-the-code">Namespacing the code</h1>
<p>As Zend 1 predates PHP namespaces, the code wasn’t namespaced. This is something I do plan to remedy - the form and model classes should be straightforward to namespace, but the controllers are a bit more problematic. I’m waiting on completing the repositories before I look at this.</p>
<h1 id="adding-psr-3-logging">Adding PSR-3 logging</h1>
<p>The existing logging solution was not all that great. It had drivers for several different logging solutions, but nothing terribly modern - one was for the now-discontinued Firebug extension for Firefox. However, it was fairly similar to PSR-3, so it wasn’t too much work to replace it. I installed Monolog, and amended the bootstrap file to store that as the logger in the Zend registry - that way, we could set up many different handlers. I now have it logging to a dedicated Slack channel when an error occurs in staging or production, which makes it much easier to detect problems. This would also make it easy to set up many other logging handlers, such as the ELK stack.</p>
<h1 id="debugging">Debugging</h1>
<p><a href="https://underground.works/clockwork/">Clockwork</a> is my usual PHP debugging solution, and the absence of support for it in Zend 1 made it difficult to work with. Fortunately, it’s quite straightforward to implement your own <a href="https://underground.works/clockwork/extending-data-sources?#content">data sources</a> for Clockwork. I set it up to use the aforementioned logger as a data source, as well as the <a href="https://framework.zend.com/manual/1.12/en/zend.db.profiler.html">Zend 1 profiler</a>. I also added a data source for the events implementation, and added a global <code>clock()</code> helper function, as well as one for the Symfony VarDumper component. Together these give me a reasonably good debugging experience.</p>
<h1 id="adding-console-commands">Adding console commands</h1>
<p>I’ve mentioned before that I’ve been using Symfony’s console component a lot lately, and this project is why. Zend 1 does not come with any sort of console task runner, and we needed an easy way to carry out certain tasks, such as:</p>
<ul>
<li>Setting up a stored procedure</li>
<li>Anonymizing user data with Faker</li>
<li>Regenerating durations for audio and video files</li>
</ul>
<p>In addition, I wanted a Laravel Tinker-style interactive shell. I was able to accomplish this with PsySh and the console components. For legacy projects that lack a console task runner, it’s worth considering adding one.</p>
<h1 id="configuration">Configuration</h1>
<p>The configuration system in Zend 1 is downright painful - it requires that you define multiple environments in there. I have integrated DotEnv, but only part of the configuration has been migrated over, so there’s still plenty of work there.</p>
<h1 id="what-s-left-to-do">What’s left to do</h1>
<p>The code base is in a much better state than it was, but there’s still an awful lot to do. Zend 1 does apparently still work with PHP 7.1, but not with 7.2, so at some point we’ll likely need to leave Zend 1 behind entirely. This process has already started with us ditching Zend_Log for Monolog, and over time I plan to replace the various components of Zend 1 with other packages, either ones from newer versions of Zend Framework, or elsewhere. While there are many articles about migrating Zend 1 to later versions, very few of them actually seem to go into much detail - certainly nothing as useful as a step-by-step guide.</p>
<p>The database layer is particularly bad, and refactoring some of the methods into repository classes is only the first step in bringing that under control. Once that’s finished, I’m going to start going through the models and seeing if any more methods would make more sense as static methods on the repository, and possibly rename some of them. Then, we can think about the possibility of either incrementally migrating to another database interface (either a newer version of Zend DB, or Doctrine), or refactoring the existing models to have less boilerplate by using magic methods instead of getters and setters.</p>
<p>Dependency injection is a must at some point, but isn’t practical right now - Zend 1 controllers implement an interface that defines the constructor arguments, so you can’t pass in any additional parameters, so that will need to wait until the controllers no longer use Zend 1. I have been using the Zend Registry as a poor man’s DI container, since it allows sharing of a single object throughout the application, but it’s not a good solution in the long term.</p>
<p>The routing is also painful - Zend 1’s routes are all stored in the bootstrap file. I’d prefer to use something like <code>league/route</code>, which would allow for handling different HTTP methods to the same route using different controller methods, making it easier to separate out handling of GET and POST requests.</p>
<p>I also want at some point to set up a queue system for processing video and audio content - at present it’s handled by running a shell command from PHP, which means you can’t easily get feedback if something goes wrong. Migrating that to a queue system, backed with something like Redis, would help a great deal.</p>
<h1 id="share-your-stories">Share your stories</h1>
<p>I’d love to hear any similar stories about refactoring legacy applications - how you’ve solved various problems with those legacy apps (or how you’d solve the ones I’ve had), tools you’ve used, and so on. Feel free to provide details in the comments.</p>
<p>A legacy project like this can be very frustrating to work with, but it can also feel quite rewarding to bring it under control over a period of time. My experience has been that you get the best results by working in small, regular steps, and over time your experience working with the code base will improve.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Mutation testing with Infection]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/09/13/mutation-testing-with-infection/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/09/13/mutation-testing-with-infection/</guid>
            <pubDate>Thu, 13 Sep 2018 19:10:09 GMT</pubDate>
            <description><![CDATA[<p>Writing automated tests is an excellent way of catching bugs during development and maintenance of your application, not to mention the other benefits. However, it’s hard to gauge the quality of your tests, particularly when you first start out. Coverage will give you a good idea of what code was actually run during the test, but it won’t tell you if the test itself actually tests anything worthwhile.</p>
<p><a href="https://infection.github.io/">Infection</a> is a mutation testing framework. The documentation defines mutation testing as follows:</p>
<blockquote>
<p>Mutation testing involves modifying a program in small ways. Each mutated version is called a Mutant. To assess the quality of a given test set, these mutants are executed against the input test set to see if the seeded faults can be detected. If mutated program produces failing tests, this is called a killed mutant. If tests are green with mutated code, then we have an escaped mutant.</p>
</blockquote>
<p>Infection works by running the test suite, carrying out a series of mutations on the source code in order to try to break the tests, and then collecting the results. The actual mutations carried out are not random - there is a set of mutations that get carried out every time, so results should be consistent. Ideally, all mutants should be killed by your tests - escaped mutants can indicate that either the line of mutated code is not tested, or the tests for that line are not very useful.</p>
<p>I decided to add mutation testing to my <a href="https://github.com/matthewbdaly/laravel-cart">Laravel shopping cart package</a>. In order to use Infection, you need to be able to generate code coverage, which means having either XDebug or phpdbg installed. Once Infection is installed (refer to the documentation for this), you can run this command in the project directory to configure it:</p>
<pre><code class="hljs lang-bash singleline">$ infection</code></pre>
<p>Infection defaults to using PHPUnit for the tests, but it also supports PHPSpec. If you’re using PHPSpec, you will need to specify the testing framework like this:</p>
<pre><code class="hljs lang-bash singleline">$ infection --<span class="hljs-built_in">test</span>-framework=phpspec</code></pre>
<p>Since PHPSpec doesn’t support code coverage out of the box, you’ll need to install a package for that - I used <code>leanphp/phpspec-code-coverage</code>.</p>
<p>On first run, you’ll be prompted to create a configuration file. Your source directory should be straightforward to set up, but at the next step, if your project uses interfaces in the source directory, you should exclude them. The rest of the defaults should be fine.</p>
<p>I found that the first run gave a large number of uncovered results, but the second and later ones were more consistent - not sure if it’s an issue with my setup or not. Running it gave me this:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>    0 [&gt;---------------------------] &lt; 1 secRunning initial <span class="hljs-built_in">test</span> suite...</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>   27 [============================] 3 secs</td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 43/43</td><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>...................MMM...M.......M.........          (43 / 43)</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>43 mutations were generated:</td><tr><td class="linenos" data-pseudo-content="24"></td><td>      38 mutants were killed</td><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td><tr><td class="linenos" data-pseudo-content="26"></td><td>       5 covered mutants were not detected</td><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td><tr><td class="linenos" data-pseudo-content="29"></td><td></td><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 88%</td><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 88%</td><tr><td class="linenos" data-pseudo-content="34"></td><td></td><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td><tr><td class="linenos" data-pseudo-content="36"></td><td></td><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 21s. Memory: 12.00MB</td></table></code></pre>
<p>Our test run shows 5 escaped mutants, and the remaining 38 were killed. We can view the results by looking at the generated <code>infection-log.txt</code>:</p>
<pre><code class="hljs lang-txt"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Escaped mutants:</td><tr><td class="linenos" data-pseudo-content="2"></td><td>================</td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-number">1</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] DecrementInteger</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>--- Original</td><tr><td class="linenos" data-pseudo-content="8"></td><td>+++ <span class="hljs-keyword">New</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td>@@ @@</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     {</td><tr><td class="linenos" data-pseudo-content="11"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td><tr><td class="linenos" data-pseudo-content="13"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td><tr><td class="linenos" data-pseudo-content="14"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">-1</span>) {</td><tr><td class="linenos" data-pseudo-content="15"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>                 }</td><tr><td class="linenos" data-pseudo-content="17"></td><td>             }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-number">2</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] OneZeroInteger</td><tr><td class="linenos" data-pseudo-content="21"></td><td></td><tr><td class="linenos" data-pseudo-content="22"></td><td>--- Original</td><tr><td class="linenos" data-pseudo-content="23"></td><td>+++ <span class="hljs-keyword">New</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>@@ @@</td><tr><td class="linenos" data-pseudo-content="25"></td><td>     {</td><tr><td class="linenos" data-pseudo-content="26"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="27"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td><tr><td class="linenos" data-pseudo-content="28"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td><tr><td class="linenos" data-pseudo-content="29"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">1</span>) {</td><tr><td class="linenos" data-pseudo-content="30"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="31"></td><td>                 }</td><tr><td class="linenos" data-pseudo-content="32"></td><td>             }</td><tr><td class="linenos" data-pseudo-content="33"></td><td></td><tr><td class="linenos" data-pseudo-content="34"></td><td></td><tr><td class="linenos" data-pseudo-content="35"></td><td><span class="hljs-number">3</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] GreaterThan</td><tr><td class="linenos" data-pseudo-content="36"></td><td></td><tr><td class="linenos" data-pseudo-content="37"></td><td>--- Original</td><tr><td class="linenos" data-pseudo-content="38"></td><td>+++ <span class="hljs-keyword">New</span></td><tr><td class="linenos" data-pseudo-content="39"></td><td>@@ @@</td><tr><td class="linenos" data-pseudo-content="40"></td><td>     {</td><tr><td class="linenos" data-pseudo-content="41"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="42"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td><tr><td class="linenos" data-pseudo-content="43"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td><tr><td class="linenos" data-pseudo-content="44"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt;= <span class="hljs-number">0</span>) {</td><tr><td class="linenos" data-pseudo-content="45"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="46"></td><td>                 }</td><tr><td class="linenos" data-pseudo-content="47"></td><td>             }</td><tr><td class="linenos" data-pseudo-content="48"></td><td></td><tr><td class="linenos" data-pseudo-content="49"></td><td></td><tr><td class="linenos" data-pseudo-content="50"></td><td><span class="hljs-number">4</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">133</span>    [M] Assignment</td><tr><td class="linenos" data-pseudo-content="51"></td><td></td><tr><td class="linenos" data-pseudo-content="52"></td><td>--- Original</td><tr><td class="linenos" data-pseudo-content="53"></td><td>+++ <span class="hljs-keyword">New</span></td><tr><td class="linenos" data-pseudo-content="54"></td><td>@@ @@</td><tr><td class="linenos" data-pseudo-content="55"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="56"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td><tr><td class="linenos" data-pseudo-content="57"></td><td>                 <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td><tr><td class="linenos" data-pseudo-content="58"></td><td>-                    $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="59"></td><td>+                    $item[<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="60"></td><td>                 }</td><tr><td class="linenos" data-pseudo-content="61"></td><td>             }</td><tr><td class="linenos" data-pseudo-content="62"></td><td>             <span class="hljs-keyword">return</span> $item;</td><tr><td class="linenos" data-pseudo-content="63"></td><td></td><tr><td class="linenos" data-pseudo-content="64"></td><td></td><tr><td class="linenos" data-pseudo-content="65"></td><td><span class="hljs-number">5</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">197</span>    [M] OneZeroInteger</td><tr><td class="linenos" data-pseudo-content="66"></td><td></td><tr><td class="linenos" data-pseudo-content="67"></td><td>--- Original</td><tr><td class="linenos" data-pseudo-content="68"></td><td>+++ <span class="hljs-keyword">New</span></td><tr><td class="linenos" data-pseudo-content="69"></td><td>@@ @@</td><tr><td class="linenos" data-pseudo-content="70"></td><td>      */</td><tr><td class="linenos" data-pseudo-content="71"></td><td>     <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasStringKeys</span><span class="hljs-params">(array $items)</span></td><tr><td class="linenos" data-pseudo-content="72"></td><td>     </span>{</td><tr><td class="linenos" data-pseudo-content="73"></td><td>-        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">0</span>;</td><tr><td class="linenos" data-pseudo-content="74"></td><td>+        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="75"></td><td>     }</td><tr><td class="linenos" data-pseudo-content="76"></td><td>     <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="77"></td><td>      * Validate input</td><tr><td class="linenos" data-pseudo-content="78"></td><td></td><tr><td class="linenos" data-pseudo-content="79"></td><td>Timed Out mutants:</td><tr><td class="linenos" data-pseudo-content="80"></td><td>==================</td><tr><td class="linenos" data-pseudo-content="81"></td><td></td><tr><td class="linenos" data-pseudo-content="82"></td><td>Not Covered mutants:</td><tr><td class="linenos" data-pseudo-content="83"></td><td>====================</span></td></table></code></pre>
<p>This displays the mutants that escaped, and include a diff of the changed code, so we can see that all of these involve changing the comparison operators.</p>
<p>The last one can be resolved easily because the comparison is superfluous - the result of <code>count()</code> can be evaluated as true or false by itself, so removing the <code>&gt; 0</code> at the end in the test solves the problem quite neatly.</p>
<p>The other four mutations are somewhat harder. They all amend the <code>decrement</code> method’s conditions, showing that a single assertion doesn’t really fully check the behaviour. Here’s the current test for that method:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></table></code></pre>
<p>It should be possible to decrement it if the quantity is more than zero, but not to go any lower. However, our current test does not catch anything but decrementing it from 2 to 1, which doesn’t fully demonstrate this. We therefore need to add a few more assertions to cover taking it down to zero, and then trying to decrement it again. Here’s how we might do that.</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        $newerdata = $newdata;</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        $newerdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">0</span>;</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newdata);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td><tr><td class="linenos" data-pseudo-content="31"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newerdata);</td><tr><td class="linenos" data-pseudo-content="32"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></table></code></pre>
<p>If we re-run Infection, we now get a much better result:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>Running initial <span class="hljs-built_in">test</span> suite...</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>   22 [============================] 3 secs</td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 41/41</td><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>.........................................            (41 / 41)</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>41 mutations were generated:</td><tr><td class="linenos" data-pseudo-content="24"></td><td>      41 mutants were killed</td><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td><tr><td class="linenos" data-pseudo-content="26"></td><td>       0 covered mutants were not detected</td><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td><tr><td class="linenos" data-pseudo-content="29"></td><td></td><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 100%</td><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 100%</td><tr><td class="linenos" data-pseudo-content="34"></td><td></td><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td><tr><td class="linenos" data-pseudo-content="36"></td><td></td><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 19s. Memory: 12.00MB</td></table></code></pre>
<p>Code coverage only tells you what lines of code are actually executed - it doesn’t tell you much about how effectively that line of code is tested. Infection gives you a different insight into the quality of your tests, helping to write better ones. I’ve so far found it very useful for getting feedback on the quality of my tests. It’s interesting that PHPSpec tests seem to have a consistently lower proportion of escaped mutants than PHPUnit ones - perhaps the more natural workflow when writing specs with PHPSpec makes it easier to write good tests.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Switching from Vim to Neovim]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/09/09/switching-from-vim-to-neovim/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/09/09/switching-from-vim-to-neovim/</guid>
            <pubDate>Sun, 09 Sep 2018 12:40:35 GMT</pubDate>
            <description><![CDATA[<p>I honestly thought it would never happen. I’ve been using Vim since 2008, and every other editor I’ve tried (including VSCode, Emacs, Sublime Text and Atom) hasn’t come up to scratch. There were a few useful features in PHPStorm, to be fair, but nothing that justified the bother of moving. Also, I suffer from a degree of RSI from my prior career as an insurance clerk (years of using crap keyboards and mice on Windows XP took its toll…), and Vim has always been the most RSI-friendly editor I found.</p>
<p>Yet I have actually gone ahead and migrated away… to Neovim. Of course, the fact that the workflow is essentially identical helps in the migration process, as does the fact that it supports most of the same plugins.</p>
<p>My workflow has always been strongly CLI-based. I use GNU Screen and Byobu together to run multiple “tabs” in the terminal, so the lack of GUI support in Neovim doesn’t bother me in the slightest. The only change I really made was to my <code>.bash_aliases</code> so that the Vim command ran <code>screen -t Vim nvim</code>, so that it would open up Neovim rather than Vim in a new Screen tab.</p>
<p>Initially I switched straight over to using the same settings and plugins I had with Vim, and they worked seamlessly. However, after a while I decided to use the opportunity to completely overhaul the plugins and settings I used and largely start over - cull the ones I no longer needed, add some new ones, and comment it properly.</p>
<h2 id="loading-plugins">Loading plugins</h2>
<p>I used to use Pathogen to manage my Vim plugins, but it didn’t actually import the plugins itself, and just provided a structure for them. This meant that the only practical way I found to pull in third-party plugins was to set them up as Git submodules, meaning I had to store my configuration in version control and clone it recursively onto a new machine. It also made updating cumbersome.</p>
<p>Now I’ve switched to <a href="https://github.com/junegunn/vim-plug">vim-plug</a>, which makes things much easier. I can define my dependencies in my <code>.config/nvim/init.vim</code> and pull them in with <code>PlugInstall</code>. If I want to update them, I run <code>PlugUpdate</code>, or if I need to add something else, I merely add it in the file and run <code>PlugInstall</code> again. Nice and easy.</p>
<p>The first section of my configuration file loads the dependencies:</p>
<pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">call</span> plug#begin()</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">" NERDTree</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td>Plug <span class="hljs-string">'scrooloose/nerdtree'</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-comment">" Git integration</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td>Plug <span class="hljs-string">'tpope/vim-fugitive'</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td>Plug <span class="hljs-string">'airblade/vim-gitgutter'</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-comment">" Linting</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td>Plug <span class="hljs-string">'neomake/neomake'</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>Plug <span class="hljs-string">'w0rp/ale'</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-comment">" PHP-specific integration</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>Plug <span class="hljs-string">'phpactor/phpactor'</span> ,  {<span class="hljs-string">'do'</span>: <span class="hljs-string">'composer install'</span>, <span class="hljs-string">'for'</span>: <span class="hljs-string">'php'</span>}</td><tr><td class="linenos" data-pseudo-content="16"></td><td>Plug <span class="hljs-string">'ncm2/ncm2'</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>Plug <span class="hljs-string">'roxma/nvim-yarp'</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>Plug <span class="hljs-string">'phpactor/ncm2-phpactor'</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-comment">" Snippets</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td>Plug <span class="hljs-string">'SirVer/ultisnips'</span></td><tr><td class="linenos" data-pseudo-content="22"></td><td>Plug <span class="hljs-string">'honza/vim-snippets'</span></td><tr><td class="linenos" data-pseudo-content="23"></td><td></td><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-comment">" Comments</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>Plug <span class="hljs-string">'tpope/vim-commentary'</span></td><tr><td class="linenos" data-pseudo-content="26"></td><td></td><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-comment">" Search</span></td><tr><td class="linenos" data-pseudo-content="28"></td><td>Plug <span class="hljs-string">'ctrlpvim/ctrlp.vim'</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td></td><tr><td class="linenos" data-pseudo-content="30"></td><td><span class="hljs-comment">" Syntax</span></td><tr><td class="linenos" data-pseudo-content="31"></td><td>Plug <span class="hljs-string">'sheerun/vim-polyglot'</span></td><tr><td class="linenos" data-pseudo-content="32"></td><td>Plug <span class="hljs-string">'matthewbdaly/vim-filetype-settings'</span></td><tr><td class="linenos" data-pseudo-content="33"></td><td></td><tr><td class="linenos" data-pseudo-content="34"></td><td><span class="hljs-comment">" Themes</span></td><tr><td class="linenos" data-pseudo-content="35"></td><td>Plug <span class="hljs-string">'nanotech/jellybeans.vim'</span> , {<span class="hljs-string">'as'</span>: <span class="hljs-string">'jellybeans'</span>}</td><tr><td class="linenos" data-pseudo-content="36"></td><td></td><tr><td class="linenos" data-pseudo-content="37"></td><td><span class="hljs-keyword">call</span> plug#end()</td></table></code></pre>
<p>As always, it’s a good idea to comment your config and try to group things logically. Note that I have one plugin of my own listed here - this is just a collection of settings for different filetypes, such as making Javascript files use 2 spaces for indentation, and it’s easier to keep that in a repository and pull it in as a dependency.</p>
<h2 id="completion">Completion</h2>
<p>The next part of the config deals with configuration. Most of the time the default omnicompletion is pretty good, but in the process of building out this config, I discovered PHPActor, which has massively improved my development experience with PHP - it finally provides completion as good as most IDE’s, and also provides similar refactoring tools. My config for completion currently looks like this:</p>
<pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">"Completion</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">autocmd</span> FileType * <span class="hljs-keyword">setlocal</span> formatoptions-=<span class="hljs-keyword">c</span> formatoptions-=r formatoptions-=<span class="hljs-keyword">o</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">set</span> ofu=syntaxcomplete#Complete</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">autocmd</span> FileType php <span class="hljs-keyword">setlocal</span> omnifunc=phpactor#Complete</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">let</span> <span class="hljs-variable">g:phpactorOmniError</span> = <span class="hljs-variable">v:true</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">autocmd</span> BufEnter * <span class="hljs-keyword">call</span> ncm2#enable_for_buffer()</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">set</span> completeopt=noinsert,menuone,noselect</td></table></code></pre>
<h2 id="general-config">General config</h2>
<p>This is a set of standard settings for the general behaviour of the application, such as setting the colorscheme and default indentation levels. I also routinely disable the mouse because it bugs me.</p>
<pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">"General</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">syntax</span> <span class="hljs-keyword">on</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">colorscheme</span> jellybeans</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">set</span> <span class="hljs-keyword">nu</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">filetype</span> plugin <span class="hljs-built_in">indent</span> <span class="hljs-keyword">on</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">set</span> nocp</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">set</span> ruler</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">set</span> wildmenu</td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">set</span> mouse-=<span class="hljs-keyword">a</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">set</span> t_Co=<span class="hljs-number">256</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-comment">"Code folding</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">set</span> foldmethod=manual</td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-comment">"Tabs and spacing</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-keyword">set</span> autoindent</td><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-keyword">set</span> <span class="hljs-built_in">cindent</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-keyword">set</span> tabstop=<span class="hljs-number">4</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-keyword">set</span> expandtab</td><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-keyword">set</span> <span class="hljs-built_in">shiftwidth</span>=<span class="hljs-number">4</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td><span class="hljs-keyword">set</span> smarttab</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-comment">"Search</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-keyword">set</span> hlsearch</td><tr><td class="linenos" data-pseudo-content="25"></td><td><span class="hljs-keyword">set</span> incsearch</td><tr><td class="linenos" data-pseudo-content="26"></td><td><span class="hljs-keyword">set</span> ignorecase</td><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-keyword">set</span> smartcase</td><tr><td class="linenos" data-pseudo-content="28"></td><td><span class="hljs-keyword">set</span> diffopt +=iwhite</td></table></code></pre>
<h2 id="markdown-configuration">Markdown configuration</h2>
<p>This section sets the file type for Markdown. It disables the Markdown plugin included in <code>vim-polyglot</code> as I had problems with it, and sets the languages that will be highlighted in fenced code blocks. I may at some point migrate this to the filetype repository.</p>
<pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">"Syntax highlighting in Markdown</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">au</span> BufNewFile,BufReadPost *.md <span class="hljs-keyword">set</span> <span class="hljs-keyword">filetype</span>=markdown</td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">let</span> <span class="hljs-variable">g:polyglot_disabled</span> = [<span class="hljs-string">'markdown'</span>]</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">let</span> <span class="hljs-variable">g:markdown_fenced_languages</span> = [<span class="hljs-string">'bash=sh'</span>, <span class="hljs-string">'css'</span>, <span class="hljs-string">'django'</span>, <span class="hljs-string">'javascript'</span>, <span class="hljs-string">'js=javascript'</span>, <span class="hljs-string">'json=javascript'</span>, <span class="hljs-string">'perl'</span>, <span class="hljs-string">'php'</span>, <span class="hljs-string">'python'</span>, <span class="hljs-string">'ruby'</span>, <span class="hljs-string">'sass'</span>, <span class="hljs-string">'xml'</span>, <span class="hljs-string">'html'</span>, <span class="hljs-string">'vim'</span>]</td></table></code></pre>
<h2 id="neomake">Neomake</h2>
<p>I used to use Syntastic for checking my code for errors, but I’ve always found it problematic - it was slow and would often block the editor for some time. Neovim does have support for asynchronous jobs (as does Vim 8), but Syntastic doesn’t use it, so I decided to look elsewhere.</p>
<p>Neomake seemed a lot better, so I migrated over to it. It doesn’t require much configuration, and it’s really fast - unlike Syntastic, it supports asynchronous jobs. This part of the config sets it up to run on changes with no delay in writing, so I get near-instant feedback if a syntax error creeps in, and it doesn’t block the editor the way Syntastic used to.</p>
<pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">" Neomake config</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">" Full config: when writing or reading a buffer, and on changes in insert and</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">" normal mode (after 1s; no delay when writing).</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">call</span> neomake#configure#automake(<span class="hljs-string">'nrwi'</span>, <span class="hljs-number">500</span>)</td></table></code></pre>
<h2 id="phpactor">PHPActor</h2>
<p>As mentioned above, PHPActor has dramatically improved my experience when coding in PHP by providing access to features normally found only in full IDE’s. Here’s the fairly standard config I use for the refactoring functionality:</p>
<pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">" PHPActor config</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">" Include use statement</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">u</span> :<span class="hljs-keyword">call</span> phpactor#UseAdd()<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-comment">" Invoke the context menu</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span>mm :<span class="hljs-keyword">call</span> phpactor#ContextMenu()<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-comment">" Invoke the navigation menu</span></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">nn</span> :<span class="hljs-keyword">call</span> phpactor#Navigate()<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-comment">" Goto definition of class or class member under the cursor</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">o</span> :<span class="hljs-keyword">call</span> phpactor#GotoDefinition()<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-comment">" Transform the classes in the current file</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span>tt :<span class="hljs-keyword">call</span> phpactor#Transform()<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-comment">" Generate a new class (replacing the current file)</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">cc</span> :<span class="hljs-keyword">call</span> phpactor#ClassNew()<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td></td><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-comment">" Extract expression (normal mode)</span></td><tr><td class="linenos" data-pseudo-content="21"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;silent&gt;</span><span class="hljs-symbol">&lt;Leader&gt;</span>ee :<span class="hljs-keyword">call</span> phpactor#ExtractExpression(<span class="hljs-variable">v:false</span>)<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-comment">" Extract expression from selection</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-keyword">vmap</span> <span class="hljs-symbol">&lt;silent&gt;</span><span class="hljs-symbol">&lt;Leader&gt;</span>ee :<span class="hljs-symbol">&lt;C-U&gt;</span><span class="hljs-keyword">call</span> phpactor#ExtractExpression(<span class="hljs-variable">v:true</span>)<span class="hljs-symbol">&lt;CR&gt;</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td><span class="hljs-comment">" Extract method from selection</span></td><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-keyword">vmap</span> <span class="hljs-symbol">&lt;silent&gt;</span><span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">em</span> :<span class="hljs-symbol">&lt;C-U&gt;</span><span class="hljs-keyword">call</span> phpactor#ExtractMethod()<span class="hljs-symbol">&lt;CR&gt;</span></td></table></code></pre>
<h2 id="summary">Summary</h2>
<p>Vim or Neovim configuration files are never static. Your needs are always changing, and you’re constantly discovering new plugins and new settings to try out, and keeping ones that prove useful. It’s been helpful to start over and ditch some plugins I no longer needed, pull in some new ones, and organise my configuration a bit better.</p>
<p>Now that I can set the dependencies in a text file rather than pulling them in as Git submodules, it makes more sense to keep my config in a <a href="https://gist.github.com/matthewbdaly/80b777ad3db885ebeecd27687fb121cd">Github Gist</a> rather than a Git repository, and that’s where I plan to retain it for now. Feel free to fork or cannibalize it for your own purposes if you wish.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Better strings in PHP]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/07/25/better-strings-in-php/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/07/25/better-strings-in-php/</guid>
            <pubDate>Wed, 25 Jul 2018 21:25:17 GMT</pubDate>
            <description><![CDATA[<p>One of the weaknesses of PHP as a programming language is the limitations of some of the fundamental types. For instance, a string in PHP is a simple value, rather than an object, and doesn’t have any methods associated with it. Instead, to manipulate a string, you have to call all manner of functions. By comparison, in Python, not only can you call methods on a string, and receive a new string as the response, making them easily chainable, but you can also iterate through a string, as in this example:</p>
<pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span>a = <span class="hljs-string">'foo'</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span>a.upper()</td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-string">'FOO'</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span>a.lower()</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-string">'foo'</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> letter <span class="hljs-keyword">in</span> a:</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-meta">... </span>  print(letter)</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-meta">... </span></td><tr><td class="linenos" data-pseudo-content="9"></td><td>f</td><tr><td class="linenos" data-pseudo-content="10"></td><td>o</td><tr><td class="linenos" data-pseudo-content="11"></td><td>o</td></table></code></pre>
<p>A little while back, I read Adam Wathan’s excellent book <em>Refactoring to Collections</em>, which describes how you can use a collection implementation (such as the one included with Laravel) to replace convoluted array manipulation with simpler, chainable calls to a collection object. Using this approach, you can turn something like this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$result = array_filter(</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    array_map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    }, $items),</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;bar == <span class="hljs-keyword">true</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td>});</td></table></code></pre>
<p>Or, even worse, this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$result1 = array_map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">return</span> $item-&gt;get(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="3"></td><td>}, $items);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>$result2 = array_filter($result1, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">return</span> $item-&gt;bar == <span class="hljs-keyword">true</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td>});</td></table></code></pre>
<p>Into this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$result = Collection::make($items)</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    -&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    })-&gt;filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;bar == <span class="hljs-keyword">true</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    })-&gt;toArray();</td></table></code></pre>
<p>Much cleaner, more elegant, and far easier to understand.</p>
<p>A while back, after some frustration with PHP’s native strings, I started wondering how practical it would be to produce a string implementation that was more like the string objects in languages like Python and Javascript, with inspiration from collection implementations such as that used by Laravel. I soon discovered that it was very practical, and with a bit of work it’s not hard to produce your own, more elegant string class.</p>
<p>The most fundamental functionality required is to be able to create a string object, either by passing a string to the constructor or calling a static method. Our string class should be able to do both:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">protected</span> $string;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(string $string = <span class="hljs-string">''</span>)</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">$this</span>-&gt;string = $string;</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make</span><span class="hljs-params">(string $string)</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>($string);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></table></code></pre>
<h2 id="making-it-iterable">Making it iterable</h2>
<p>To be able to get the length of a string, it needs to implement the <a href="http://php.net/manual/en/class.countable.php"><code>Countable</code></a> interface:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Countable</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Countable</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">count</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">return</span> strlen(<span class="hljs-keyword">$this</span>-&gt;string);</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></table></code></pre>
<p>To access it as an array, it needs to implement the <a href="http://php.net/manual/en/class.arrayaccess.php"><code>ArrayAccess</code></a> interface:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>...</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ArrayAccess</span>;</td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Countable</span>, <span class="hljs-title">ArrayAccess</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetExists</span><span class="hljs-params">($offset)</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;string[$offset]);</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetGet</span><span class="hljs-params">($offset)</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;string[$offset]) ? <span class="hljs-keyword">$this</span>-&gt;string[$offset] : <span class="hljs-keyword">null</span>;</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="16"></td><td></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetSet</span><span class="hljs-params">($offset, $value)</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> (is_null($offset)) {</td><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">$this</span>-&gt;string[] = $value;</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        } <span class="hljs-keyword">else</span> {</td><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-keyword">$this</span>-&gt;string[$offset] = $value;</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetUnset</span><span class="hljs-params">($offset)</span></td><tr><td class="linenos" data-pseudo-content="27"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">$this</span>-&gt;string = substr_replace(<span class="hljs-keyword">$this</span>-&gt;string, <span class="hljs-string">''</span>, $offset, <span class="hljs-number">1</span>);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></table></code></pre>
<p>And to make it iterable, it needs to implement the <a href="http://php.net/manual/en/class.iterator.php"><code>Iterator</code></a> interface:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Iterator</span>;</td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Countable</span>, <span class="hljs-title">ArrayAccess</span>, <span class="hljs-title">Iterator</span></td><tr><td class="linenos" data-pseudo-content="4"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    ...</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">current</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;string[<span class="hljs-keyword">$this</span>-&gt;position];</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">key</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;position;</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        ++<span class="hljs-keyword">$this</span>-&gt;position;</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rewind</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="22"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;position = <span class="hljs-number">0</span>;</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">valid</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="27"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;string[<span class="hljs-keyword">$this</span>-&gt;position]);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></table></code></pre>
<h2 id="making-it-work-as-a-string">Making it work as a string</h2>
<p>To be useful, it also needs to be possible to actually use it as a string - for instance, you should be able to do this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$foo = Str::make(<span class="hljs-string">'I am the very model of a modern major general'</span>);</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">echo</span> $foo;</td></table></code></pre>
<p>Fortunately, the <a href="http://php.net/manual/en/language.oop5.magic.php#object.tostring"><code>__toString()</code></a> magic method allows this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;string;</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></table></code></pre>
<h2 id="adding-methods">Adding methods</h2>
<p>With that functionality in place, you can then start adding support for the methods you need in your string objects. If you’re looking to be able to use the same functionality as existing PHP methods, you can call those functions inside your methods. However, be sure to return a new instance of your string object from each method - that way, you can continually chain them:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replace</span><span class="hljs-params">($find, $replace)</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(str_replace($find, $replace, <span class="hljs-keyword">$this</span>-&gt;string));</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toUpper</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="7"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(strtoupper(<span class="hljs-keyword">$this</span>-&gt;string));</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toLower</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(strtolower(<span class="hljs-keyword">$this</span>-&gt;string));</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trim</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(trim(<span class="hljs-keyword">$this</span>-&gt;string));</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ltrim</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="22"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(ltrim(<span class="hljs-keyword">$this</span>-&gt;string));</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rtrim</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="27"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(rtrim(<span class="hljs-keyword">$this</span>-&gt;string));</td><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></table></code></pre>
<p>Now, you can write something like this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">return</span> Str::make(<span class="hljs-string">'I am the very model of a modern major general  '</span>)</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    -&gt;trim()</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    -&gt;replace(<span class="hljs-string">'modern major general'</span>, <span class="hljs-string">'scientist Salarian'</span>)</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    -&gt;toLower();</td></table></code></pre>
<p>While you could do this with PHP’s native string functions alone, it would be a lot less elegant. In addition, if you have other, more complex string manipulations that you often do in a particular application, it may make sense to write a method for that so that your string objects can encapsulate that functionality for easier reuse.</p>
<p>As our string objects are iterable, we can also do this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&gt;&gt;&gt; $foo = Str::make(<span class="hljs-string">'foo'</span>);</td><tr><td class="linenos" data-pseudo-content="2"></td><td>&gt;&gt;&gt; <span class="hljs-keyword">foreach</span> ($foo <span class="hljs-keyword">as</span> $letter) { <span class="hljs-keyword">echo</span> <span class="hljs-string">"$letter\n"</span>; }</td><tr><td class="linenos" data-pseudo-content="3"></td><td>f</td><tr><td class="linenos" data-pseudo-content="4"></td><td>o</td><tr><td class="linenos" data-pseudo-content="5"></td><td>o</td></table></code></pre>
<p>If you have an application that does some complex string manipulation, having a string utility class like this can make for much more expressive, elegant and easy-to-comprehend code than PHP’s native string functions. If you want to see a working implementation for this, check out my proof of concept collection and string utility library <a href="https://github.com/matthewbdaly/proper">Proper</a>.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Forcing SSL in CodeIgniter]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/06/23/forcing-ssl-in-codeigniter/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/06/23/forcing-ssl-in-codeigniter/</guid>
            <pubDate>Sat, 23 Jun 2018 12:03:28 GMT</pubDate>
            <description><![CDATA[<p>I haven’t started a new CodeIgniter project since 2014, and don’t intend to, but on occasion I’ve been asked to do maintenance work on legacy CodeIgniter projects. This week I was asked to help out with a situation where a CodeIgniter site was being migrated to HTTPS and there were issues resulting from the migration.</p>
<p>Back in 2012, when working on my first solo project, I’d built a website using CodeIgniter that used HTTPS, but also needed to support an affiliate marketing system that did not support it, so certain pages had to force HTTP, and others had to force HTTPS, so I’d used the hook system to create hooks to enforce this. This kind of requirement is unlikely to reoccur now because HTTPS is becoming more prevalent, but sometimes it may be easier to enforce HTTPS at application level than in the web server configuration or using htaccess. It’s relatively straightforward to do that in CodeIgniter.</p>
<p>The first step is to create the hook. Save this as <code>application/hooks/ssl.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">force_ssl</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    $CI =&amp; get_instance();</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    $CI-&gt;config-&gt;config[<span class="hljs-string">'base_url'</span>] = str_replace(<span class="hljs-string">'http://'</span>, <span class="hljs-string">'https://'</span>, $CI-&gt;config-&gt;config[<span class="hljs-string">'base_url'</span>]);</td><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">if</span> ($_SERVER[<span class="hljs-string">'SERVER_PORT'</span>] != <span class="hljs-number">443</span>) redirect($CI-&gt;uri-&gt;uri_string());</td><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-meta">?&gt;</span></td></table></code></pre>
<p>Next, we register the hook. Update <code>application/configs/hooks.php</code> as follows:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span>  <span class="hljs-keyword">if</span> ( ! defined(<span class="hljs-string">'BASEPATH'</span>)) <span class="hljs-keyword">exit</span>(<span class="hljs-string">'No direct script access allowed'</span>);</td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">/*</td><tr><td class="linenos" data-pseudo-content="3"></td><td>| -------------------------------------------------------------------------</td><tr><td class="linenos" data-pseudo-content="4"></td><td>| Hooks</td><tr><td class="linenos" data-pseudo-content="5"></td><td>| -------------------------------------------------------------------------</td><tr><td class="linenos" data-pseudo-content="6"></td><td>| This file lets you define "hooks" to extend CI without hacking the core</td><tr><td class="linenos" data-pseudo-content="7"></td><td>| files.  Please see the user guide for info:</td><tr><td class="linenos" data-pseudo-content="8"></td><td>|</td><tr><td class="linenos" data-pseudo-content="9"></td><td>|    http://codeigniter.com/user_guide/general/hooks.html</td><tr><td class="linenos" data-pseudo-content="10"></td><td>|</td><tr><td class="linenos" data-pseudo-content="11"></td><td>*/</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>$hook[<span class="hljs-string">'post_controller_constructor'</span>][] = <span class="hljs-keyword">array</span>(</td><tr><td class="linenos" data-pseudo-content="14"></td><td>                                <span class="hljs-string">'function'</span> =&gt; <span class="hljs-string">'force_ssl'</span>,</td><tr><td class="linenos" data-pseudo-content="15"></td><td>                                <span class="hljs-string">'filename'</span> =&gt; <span class="hljs-string">'ssl.php'</span>,</td><tr><td class="linenos" data-pseudo-content="16"></td><td>                                <span class="hljs-string">'filepath'</span> =&gt; <span class="hljs-string">'hooks'</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td>                                );</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-comment">/* End of file hooks.php */</span></td><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-comment">/* Location: ./application/config/hooks.php */</span></td></table></code></pre>
<p>This tells CodeIgniter that it should looks in the <code>application/hooks</code> directory for a file called <code>ssl.php</code>, and return the function <code>force_ssl</code>.</p>
<p>Finally, we enable hooks. Update <code>application/config/config.php</code>:</p>
<pre><code class="hljs lang-php singleline">$config[<span class="hljs-string">'enable_hooks'</span>] = <span class="hljs-keyword">TRUE</span>;</code></pre>
<p>If you only want to force SSL in production, not development, you may want to amend the <code>ssl.php</code> file to only perform the redirect in non-development environments, perhaps by using an environment variable via DotEnv.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Logging to the ELK stack with Laravel]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/</guid>
            <pubDate>Sun, 03 Jun 2018 15:30:54 GMT</pubDate>
            <description><![CDATA[<p>Logging to text files is the simplest and most common logging setup for web apps, and it works fine for relatively small and simple applications. However, it does have some downsides:</p>
<ul>
<li>It’s difficult to make the log files accessible - normally users have to SSH in to read them.</li>
<li>The tools used to filter and analyse log files have a fairly high technical barrier to access - grep and sed are not exactly easy for non-programmers to pick up, so business information can be hard to get.</li>
<li>It’s hard to visually identify trends in the data.</li>
<li>Log files don’t let you know immediately when something urgent happens</li>
<li>You can’t access logs for different applications through the same interface.</li>
</ul>
<p>For rare, urgent issues where you need to be informed immediately they occur, it’s straightforward to log to an instant messaging solution such as Slack or Hipchat. However, these aren’t easily searchable, and can only be used for the most important errors (otherwise, there’s a risk that important data will be lost in the noise). There are third-party services that allow you to search and filter your logs, but they can be prohibitively expensive.</p>
<p>The <a href="https://www.elastic.co/elk-stack">ELK stack</a> has recently gained a lot of attention as a sophisticated solution for logging application data. It consists of:</p>
<ul>
<li>Logstash for processing log data</li>
<li>Elasticsearch as a searchable storage backend</li>
<li>Kibana as a web interface</li>
</ul>
<p>By making the log data available using a powerful web interface, you can easily expose it to non-technical users. Kibana also comes with powerful tools to aggregate and filter the data. In addition, you can run your own instance, giving you a greater degree of control (as well as possibly being more cost-effective) compared to using a third-party service.</p>
<p>In this post I’ll show you how to configure a Laravel application to log to an instance of the ELK stack. Fortunately, Laravel uses the popular Monolog logging library by default, which is relatively easy to get to work with the ELK stack. First, we need to install support for the GELF logging format:</p>
<pre><code class="hljs lang-bash singleline">$ composer require graylog2/gelf-php</code></pre>
<p>Then, we create a custom logger class:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Logging</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Monolog</span>\<span class="hljs-title">Logger</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Monolog</span>\<span class="hljs-title">Handler</span>\<span class="hljs-title">GelfHandler</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Gelf</span>\<span class="hljs-title">Publisher</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Gelf</span>\<span class="hljs-title">Transport</span>\<span class="hljs-title">UdpTransport</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td></td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GelfLogger</span></td><tr><td class="linenos" data-pseudo-content="11"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     * Create a custom Monolog instance.</td><tr><td class="linenos" data-pseudo-content="14"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="15"></td><td>     * <span class="hljs-doctag">@param</span>  array  $config</td><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@return</span> \Monolog\Logger</td><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(array $config)</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        $handler = <span class="hljs-keyword">new</span> GelfHandler(<span class="hljs-keyword">new</span> Publisher(<span class="hljs-keyword">new</span> UdpTransport($config[<span class="hljs-string">'host'</span>], $config[<span class="hljs-string">'port'</span>])));</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Logger(<span class="hljs-string">'main'</span>, [$handler]);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="23"></td><td>}</td></table></code></pre>
<p>Finally, we configure our application to use this as our custom driver and specify the host and port in <code>config/logging.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>        <span class="hljs-string">'custom'</span> =&gt; [</td><tr><td class="linenos" data-pseudo-content="2"></td><td>            <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'custom'</span>,</td><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-string">'via'</span> =&gt; App\Logging\GelfLogger::class,</td><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'host'</span> =&gt; <span class="hljs-string">'127.0.0.1'</span>,</td><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'port'</span> =&gt; <span class="hljs-number">12201</span>,</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        ],</td></table></code></pre>
<p>You can then set up whatever logging channels you need for your application, and specify whatever log level you feel is appropriate.</p>
<p>Please note that this requires at least Laravel 5.6 - this file doesn’t exist in Laravel 5.5 and earlier, so you may have more work on your hands to integrate it with older versions.</p>
<p>If you already have an instance of the ELK stack set up on a remote server that’s already set up to accept input as GELF, then you should be able to point it at that and you’ll be ready to go. If you just want to try it out, I’ve been using a <a href="https://github.com/deviantony/docker-elk">Docker-based project</a> that makes it straightforward to run the whole stack locally. However, you will need to amend <code>logstash/pipeline/logstash.conf</code> as follows to allow it to accept log data:</p>
<pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>input {</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    tcp {</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        port =&gt; 5000</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="5"></td><td>   gelf {</td><tr><td class="linenos" data-pseudo-content="6"></td><td>       port =&gt; 12201</td><tr><td class="linenos" data-pseudo-content="7"></td><td>       type =&gt; gelf</td><tr><td class="linenos" data-pseudo-content="8"></td><td>       codec =&gt; "json"</td><tr><td class="linenos" data-pseudo-content="9"></td><td>   }</td><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td>## Add your filters / logstash plugins configuration here</td><tr><td class="linenos" data-pseudo-content="13"></td><td></td><tr><td class="linenos" data-pseudo-content="14"></td><td>output {</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    elasticsearch {</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        hosts =&gt; "elasticsearch:9200"</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td>}</td></table></code></pre>
<p>Then you can start it up using the instructions in the repository and it should be ready to go. Now, if you run the following command from Tinker:</p>
<pre><code class="hljs lang-php singleline">Log::info(<span class="hljs-string">'Just testing'</span>);</code></pre>
<p>Then if you access the web interface, you should be able to find that log message without any difficulty.</p>
<p>Now, this only covers the Laravel application logs. You may well want to pass other logs through to Logstash, such as Apache, Nginx or MySQL logs, and a quick Google should be sufficient to find ideas on how you might log for these services. Creating visualisations with Kibana is a huge subject, and the existing documentation covers that quite well, so if you’re interested in learning more about that I’d recommend reading the documentation and having a play with the dashboard.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Full-text search with MariaDB]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/05/13/full-text-search-with-mariadb/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/05/13/full-text-search-with-mariadb/</guid>
            <pubDate>Sun, 13 May 2018 13:55:42 GMT</pubDate>
            <description><![CDATA[<p>Recently I had the occasion to check out MariaDB’s implementation of full-text search. As it’s a relatively recent arrival in MySQL and MariaDB, it doesn’t seem to get all that much attention. In this post I’ll show you how to use it, with a few Laravel-specific pointers. We’ll be using the default <code>User</code> model in a new Laravel installation, which has columns for <code>name</code> and <code>email</code>.</p>
<p>Our first task is to create the fulltext index, which is necessary to perform the query. Run the following command:</p>
<pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">ADD</span> FULLTEXT (<span class="hljs-keyword">name</span>, email);</code></pre>
<p>As you can see, we can specify multiple columns in our table to index.</p>
<p>If you’re using Laravel, you’ll want to create the following migration for this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddFulltextIndexForUsers</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'ALTER TABLE users ADD FULLTEXT(name, email)'</span>);</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Reverse the migrations.</td><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">'ALTER TABLE users DROP INDEX IF EXISTS name'</span>);</td><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></table></code></pre>
<p>Note that the index is named after the first field passed to it, so when we drop it we refer to it as <code>name</code>. Then, to actually query the index, you should run a command something like this:</p>
<pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(<span class="hljs-keyword">name</span>, email) AGAINST (<span class="hljs-string">'jeff'</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">MODE</span>);</code></pre>
<p>Note that <code>NATURAL LANGUAGE MODE</code> is actually the default, so you can leave it off if you wish. We also have to specify the columns to match against.</p>
<p>If you’re using Laravel, you may want to create a reusable local scope for it:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeSearch</span><span class="hljs-params">($query, $search)</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">if</span> (!$search) {</td><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-keyword">return</span> $query;</td><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> $query-&gt;whereRaw(<span class="hljs-string">'MATCH(name, email) AGAINST (?)'</span>, [$search]);</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    }</td></table></code></pre>
<p>Then you can call it as follows:</p>
<pre><code class="hljs lang-php singleline">User::search(<span class="hljs-string">'jeff'</span>)-&gt;get();</code></pre>
<p>I personally have noticed that the query using the <code>MATCH</code> keywords seems to be far more performant, with the response time being between five and ten times less than a similar command using <code>LIKE</code>, however this observation isn’t very scientific (plus, we are talking about queries that still run in a fraction of a second). However, if you’re doing a particularly expensive query that currently uses a <code>LIKE</code> statement, it’s possible you may get better results by switching to a <code>MATCH</code> statement. Full-text search probably isn’t all that useful in this context - it’s only once we’re talking about longer text, such as blog posts, that some of the advantages like support for stopwords comes into play.</p>
<p>From what I’ve seen this implementation of full-text search is a lot simpler than in PostgreSQL, which has ups and downs. On the one hand, it’s a lot easier to implement, but conversely it’s less useful - there’s no obvious way to perform a full-text search against joined tables. However, it does seem to be superior to using a <code>LIKE</code> statement, so it’s probably a good fit for smaller sites where something like Elasticsearch would be overkill.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Building a letter classifier in PHP with Tesseract OCR and PHP ML]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/</guid>
            <pubDate>Thu, 10 May 2018 22:50:08 GMT</pubDate>
            <description><![CDATA[<p>PHP isn’t the first language that springs to mind when it comes to machine learning. However, it is practical to use PHP for machine learning purposes. In this tutorial I’ll show you how to build a pipeline for classifying letters.</p>
<h2 id="the-brief">The brief</h2>
<p>Before I was a web dev, I was a clerical worker for an FTSE-100 insurance company, doing a lot of work that nowadays is possible to automate away, if you know how. When they received a letter or other communication from a client, it would be sent to be scanned on. Once scanned, a human would have to look at it to classify it, eg was it a complaint, a request for information, a request for a quote, or something else, as well as assign it to a policy number. Let’s imagine we’ve been asked to build a proof of concept for automating this process. This is a good example of a real-world problem that machine learning can help with.</p>
<p>As this is a proof of concept we aren’t looking to build a web app for this - for simplicity’s sake this will be a command-line application. Unlike emails, letters don’t come in an easily machine-readable format, so we will be receiving them as PDF files (since they would have been scanned on, this is a reasonable assumption). Feel free to mock up your own example letters using your own classifications, but I will be classifying letters into four groups:</p>
<ul>
<li><strong>Complaints</strong> - letters expressing dissatisfaction</li>
<li><strong>Information requests</strong> - letters requesting general information</li>
<li><strong>Surrender quotes</strong> - letters requesting a surrender quote</li>
<li><strong>Surrender forms</strong> - letters requesting surrender forms</li>
</ul>
<p>Our application will therefore take in a PDF file at one end, and perform the following actions on it:</p>
<ul>
<li>Convert the PDF file to a PNG file</li>
<li>Use OCR (optical character recognition) to convert the letter to plain text</li>
<li>Strip out unwanted whitespace</li>
<li>Extract any visible policy number from the text</li>
<li>Use a machine learning library to classify the letter, having taught it using prior examples</li>
</ul>
<p>Sound interesting? Let’s get started…</p>
<h2 id="introducing-pipelines">Introducing pipelines</h2>
<p>As our application will be carrying out a series of discrete steps on our data, it makes sense to use the pipeline pattern for this project. Fortunately, the PHP League have produced a excellent <a href="http://pipeline.thephpleague.com/">package</a> implementing this. We can therefore create a single class for each step in the process and have it handle that in isolation.</p>
<p>We’ll also use the Symfony Console component to implement our command-line application. For our machine learning library we will be using <a href="https://php-ml.readthedocs.io/en/latest/">PHP ML</a>, which requires PHP 7.1 or greater. For OCR, we will be using <a href="https://github.com/thiagoalessio/tesseract-ocr-for-php">Tesseract</a>, so you will need to install the underlying Tesseract OCR library, as well as support for your language. On Ubuntu you can install these as follows:</p>
<pre><code class="hljs lang-bash singleline">$ sudo apt-get install tesseract-ocr tesseract-ocr-eng</code></pre>
<p>This assumes you are using English, however you should be able to find packages to support many other languages. Finally, we need ImageMagick to be installed in order to convert PDF files to PNG’s.</p>
<p>Your <code>composer.json</code> should look something like this:</p>
<pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/letter-classifier"</span>,</td><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Demo of classifying letters in PHP"</span>,</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"project"</span>,</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"require"</span>: {</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-attr">"league/pipeline"</span>: <span class="hljs-string">"^0.3.0"</span>,</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"thiagoalessio/tesseract_ocr"</span>: <span class="hljs-string">"^2.2"</span>,</td><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"php-ai/php-ml"</span>: <span class="hljs-string">"^0.6.2"</span>,</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">"symfony/console"</span>: <span class="hljs-string">"^4.0"</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    },</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^4.3"</span>,</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-attr">"psy/psysh"</span>: <span class="hljs-string">"^0.8.17"</span></td><tr><td class="linenos" data-pseudo-content="14"></td><td>    },</td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-attr">"Matthewbdaly\\LetterClassifier\\"</span>: <span class="hljs-string">"src/"</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    },</td><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"authors"</span>: [</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        {</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"matthewbdaly@gmail.com"</span></td><tr><td class="linenos" data-pseudo-content="25"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="26"></td><td>    ]</td><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></table></code></pre>
<p>Next, let’s write the outline of our command-line client. We’ll load a single class for our processor command. Save this as <code>app</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">#!/usr/bin/env php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/vendor/autoload.php'</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Application</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Commands</span>\<span class="hljs-title">Processor</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td>$application = <span class="hljs-keyword">new</span> Application();</td><tr><td class="linenos" data-pseudo-content="10"></td><td>$application-&gt;add(<span class="hljs-keyword">new</span> Processor());</td><tr><td class="linenos" data-pseudo-content="11"></td><td>$application-&gt;run();</td></table></code></pre>
<p>Next, we create our command. Save this as <code>src/Commands/Processor.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Commands</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Command</span>\<span class="hljs-title">Command</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputInterface</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Output</span>\<span class="hljs-title">OutputInterface</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputArgument</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">Pipeline</span>;</td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">ConvertPdfToPng</span>;</td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">ReadFile</span>;</td><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">Classify</span>;</td><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">StripTabs</span>;</td><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">GetPolicyNumber</span>;</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Processor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span></td><tr><td class="linenos" data-pseudo-content="17"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setName(<span class="hljs-string">'process'</span>)</td><tr><td class="linenos" data-pseudo-content="21"></td><td>            -&gt;setDescription(<span class="hljs-string">'Processes a file'</span>)</td><tr><td class="linenos" data-pseudo-content="22"></td><td>            -&gt;setHelp(<span class="hljs-string">'This command processes a file'</span>)</td><tr><td class="linenos" data-pseudo-content="23"></td><td>            -&gt;addArgument(<span class="hljs-string">'file'</span>, InputArgument::REQUIRED, <span class="hljs-string">'File to process'</span>);</td><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="25"></td><td></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></td><tr><td class="linenos" data-pseudo-content="27"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        $file = $input-&gt;getArgument(<span class="hljs-string">'file'</span>);</td><tr><td class="linenos" data-pseudo-content="29"></td><td>        $pipeline = (<span class="hljs-keyword">new</span> Pipeline)</td><tr><td class="linenos" data-pseudo-content="30"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> ConvertPdfToPng)</td><tr><td class="linenos" data-pseudo-content="31"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> ReadFile)</td><tr><td class="linenos" data-pseudo-content="32"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> StripTabs)</td><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> GetPolicyNumber)</td><tr><td class="linenos" data-pseudo-content="34"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> Classify);</td><tr><td class="linenos" data-pseudo-content="35"></td><td>        $response = $pipeline-&gt;process($file);</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        $output-&gt;writeln(<span class="hljs-string">"Classification is "</span>.$response[<span class="hljs-string">'classification'</span>]);</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        $output-&gt;writeln(<span class="hljs-string">"Policy number is "</span>.$response[<span class="hljs-string">'policy'</span>]);</td><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></table></code></pre>
<p>Note how our command accepts the file name as an argument. We then instantiate our pipeline and pass it through a series of classes, each of which has a single role. Finally, we retrieve our response and output it.</p>
<p>With that done, we can move on to implementing our first step. Save this as <code>src/Stages/ConvertPdfToPng.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Imagick</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConvertPdfToPng</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($file)</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        $tmp = tmpfile();</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        $uri = stream_get_meta_data($tmp)[<span class="hljs-string">'uri'</span>];</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        $img = <span class="hljs-keyword">new</span> Imagick();</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        $img-&gt;setResolution(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        $img-&gt;readImage($file);</td><tr><td class="linenos" data-pseudo-content="16"></td><td>        $img-&gt;setImageDepth(<span class="hljs-number">8</span>);</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        $img-&gt;setImageFormat(<span class="hljs-string">'png'</span>);</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        $img-&gt;writeImage($uri);</td><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> $tmp;</td><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="21"></td><td>}</td></table></code></pre>
<p>This stage fetches the file passed through, and converts it into a PNG file, stores it as a temporary file, and returns a reference to it. The output of this stage will then form the input of the next. This is how pipelines work, and it makes it easy to break up a complex process into multiple steps that can be reused in different places, facilitating easier code reuse and making your code simpler to understand and reason about.</p>
<p>Our next step carries out optical character recognition. Save this as <code>src/Stages/ReadFile.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">thiagoalessio</span>\<span class="hljs-title">TesseractOCR</span>\<span class="hljs-title">TesseractOCR</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadFile</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($file)</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        $uri = stream_get_meta_data($file)[<span class="hljs-string">'uri'</span>];</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        $ocr = <span class="hljs-keyword">new</span> TesseractOCR($uri);</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> $ocr-&gt;lang(<span class="hljs-string">'eng'</span>)-&gt;run();</td><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></table></code></pre>
<p>As you can see, this accepts the link to the temporary file as an argument, and runs Tesseract on it to retrieve the text. Note that we specify a language of <code>eng</code> - if you want to use a language other than English, you should specify it here.</p>
<p>At this point, we should have some usable text, but there may be unknown amounts of whitespace, so our next step uses a regex to strip them out. Save this as <code>src/Stages/StripTabs.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StripTabs</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($content)</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">return</span> trim(preg_replace(<span class="hljs-string">'/\s+/'</span>, <span class="hljs-string">' '</span>, $content));</td><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></table></code></pre>
<p>With our whitespace issue sorted out, we now need to retrieve the policy number the communication should be filed under. These are generally regular alphanumeric patterns, so regexes are a suitable way of matching them. As this is a proof of concept, we’ll assume a very simple pattern for policy numbers in that they will consist of between seven and nine digits. Save this as <code>src/Stages/GetPolicyNumber.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetPolicyNumber</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($content)</span></td><tr><td class="linenos" data-pseudo-content="8"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="9"></td><td>        $matches = [];</td><tr><td class="linenos" data-pseudo-content="10"></td><td>        $policyNumber = <span class="hljs-string">''</span>;</td><tr><td class="linenos" data-pseudo-content="11"></td><td>        preg_match(<span class="hljs-string">'/\d{7,9}/'</span>, $content, $matches);</td><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">if</span> (count($matches)) {</td><tr><td class="linenos" data-pseudo-content="13"></td><td>            $policyNumber = $matches[<span class="hljs-number">0</span>];</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> [</td><tr><td class="linenos" data-pseudo-content="16"></td><td>            <span class="hljs-string">'content'</span> =&gt; $content,</td><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'policy'</span> =&gt; $policyNumber</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        ];</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></table></code></pre>
<p>Finally, we’re onto the really tough part - using machine learning to classify the letters. Save this as <code>src/Stages/Classify.php</code>:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Dataset</span>\<span class="hljs-title">CsvDataset</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Dataset</span>\<span class="hljs-title">ArrayDataset</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">FeatureExtraction</span>\<span class="hljs-title">TokenCountVectorizer</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Tokenization</span>\<span class="hljs-title">WordTokenizer</span>;</td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">CrossValidation</span>\<span class="hljs-title">StratifiedRandomSplit</span>;</td><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">FeatureExtraction</span>\<span class="hljs-title">TfIdfTransformer</span>;</td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Metric</span>\<span class="hljs-title">Accuracy</span>;</td><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Classification</span>\<span class="hljs-title">SVC</span>;</td><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">SupportVectorMachine</span>\<span class="hljs-title">Kernel</span>;</td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Classify</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">protected</span> $classifier;</td><tr><td class="linenos" data-pseudo-content="18"></td><td></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">protected</span> $vectorizer;</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">protected</span> $tfIdfTransformer;</td><tr><td class="linenos" data-pseudo-content="22"></td><td></td><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="24"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;dataset = <span class="hljs-keyword">new</span> CsvDataset(<span class="hljs-string">'data/letters.csv'</span>, <span class="hljs-number">1</span>);</td><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer = <span class="hljs-keyword">new</span> TokenCountVectorizer(<span class="hljs-keyword">new</span> WordTokenizer());</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer = <span class="hljs-keyword">new</span> TfIdfTransformer();</td><tr><td class="linenos" data-pseudo-content="28"></td><td>        $samples = [];</td><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;dataset-&gt;getSamples() <span class="hljs-keyword">as</span> $sample) {</td><tr><td class="linenos" data-pseudo-content="30"></td><td>                $samples[] = $sample[<span class="hljs-number">0</span>];</td><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;fit($samples);</td><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;transform($samples);</td><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;fit($samples);</td><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;transform($samples);</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        $dataset = <span class="hljs-keyword">new</span> ArrayDataset($samples, <span class="hljs-keyword">$this</span>-&gt;dataset-&gt;getTargets());</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        $randomSplit = <span class="hljs-keyword">new</span> StratifiedRandomSplit($dataset, <span class="hljs-number">0.1</span>);</td><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;classifier = <span class="hljs-keyword">new</span> SVC(Kernel::RBF, <span class="hljs-number">10000</span>);</td><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;train($randomSplit-&gt;getTrainSamples(), $randomSplit-&gt;getTrainLabels());</td><tr><td class="linenos" data-pseudo-content="40"></td><td>        $predictedLabels = <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;predict($randomSplit-&gt;getTestSamples());</td><tr><td class="linenos" data-pseudo-content="41"></td><td>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Accuracy: '</span>.Accuracy::score($randomSplit-&gt;getTestLabels(), $predictedLabels);</td><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="43"></td><td></td><tr><td class="linenos" data-pseudo-content="44"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(array $message)</span></td><tr><td class="linenos" data-pseudo-content="45"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="46"></td><td>        $newSample = [$message[<span class="hljs-string">'content'</span>]];</td><tr><td class="linenos" data-pseudo-content="47"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;transform($newSample);</td><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;transform($newSample);</td><tr><td class="linenos" data-pseudo-content="49"></td><td>        $message[<span class="hljs-string">'classification'</span>] = <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;predict($newSample)[<span class="hljs-number">0</span>];</td><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> $message;</td><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="52"></td><td>}</td></table></code></pre>
<p>In our constructor, we train up our model by passing our sample data through the following steps:</p>
<ul>
<li>First, we use the token count vectorizer to convert our samples to a vector of token counts - replacing every word with a number and keeping track of how often that word occurs.</li>
<li>Next, we use <code>TfIdfTransformer</code> to get statistics about how important a word is in a document.</li>
<li>Then we instantiate our classifier and train it on a random subset of our data.</li>
<li>Finally, we pass our message to our now-trained classifier and see what it tells us.</li>
</ul>
<p>Now, bear in mind I don’t have a background in machine learning and this is the first time I’ve done anything with machine learning, so I can’t tell you much more than that - if you want to know more I suggest you investigate on your own. In figuring this out I was helped a great deal by <a href="https://www.sitepoint.com/how-to-analyze-tweet-sentiments-with-php-machine-learning/">this article on Sitepoint</a>, so you might want to start there.</p>
<p>The finished application is <a href="https://github.com/matthewbdaly/letter-classifier">on GitHub</a>, and the repository includes a CSV file of training data, as well as the <code>examples</code> folder, which contains some example PDF files. You can run it as follows:</p>
<pre><code class="hljs lang-bash singleline">$ php app process examples/Quote.pdf</code></pre>
<p>I found that once I had trained it up using the CSV data from the repository, it was around 70-80% accurate, which isn’t bad at all considering the comparatively small size of the dataset. If this were genuinely being used in production, there would be an extremely large dataset of historical scanned letters to use for training purposes, so it wouldn’t be unreasonable to expect much better results under those circumstances.</p>
<h2 id="exercises-for-the-reader">Exercises for the reader</h2>
<p>If you want to develop this concept further, here are some ideas:</p>
<ul>
<li>We should be able to correct the model when it’s wrong. Add a separate command to train the model by passing through a file and specifying how it should be categorised, eg <code>php app train File.pdf quote</code>.</li>
<li>Try processing information from different sources. For instance, you could replace the first two stages with a stage that pulls all unread emails from a specified mailbox using PHP’s IMAP support, or fetching data from the Twitter API. Or you could have a telephony service such as Twilio set up as your voicemail, and automatically transcribe them, then pass the text to PHP ML for classification.</li>
<li>If you’re multilingual, you could try adding a step to sort letters by language and have separate models for classifying in each language</li>
</ul>
<h2 id="summary">Summary</h2>
<p>It’s actually quite a sobering thought that <em>already</em> it’s possible to use techniques like these to produce tools that replace people in various jobs, and as the tooling matures more and more tasks involving classification are going to become amenable to automation using machine learning.</p>
<p>This was my first experience with machine learning and it’s been very interesting for me to solve a real-world problem with it. I hope it gives you some ideas about how you could use it too.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Console applications with the Symfony Console component]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/04/29/console-applications-with-the-symfony-console-component/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/04/29/console-applications-with-the-symfony-console-component/</guid>
            <pubDate>Sun, 29 Apr 2018 19:59:27 GMT</pubDate>
            <description><![CDATA[<p>Recently I’ve had the occasion to add a series of console commands to a legacy application. This can be made straightforward by using the Symfony console component. In this post I’ll demonstrate how to write a simple console command for clearing a cache folder.</p>
<p>The first step is to install the Console component:</p>
<pre><code class="hljs lang-bash singleline">$ composer require symfony/console</code></pre>
<p>Then we write the main script for the application. I usually save mine as <code>console</code> - note that we don’t want to have to type out a file extension, so instead we use the shebang:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">#!/user/bin/env php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/vendor/autoload.php'</span>;</td><tr><td class="linenos" data-pseudo-content="5"></td><td></td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Application</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td></td><tr><td class="linenos" data-pseudo-content="8"></td><td>define(<span class="hljs-string">'CONSOLE_ROOT'</span>, <span class="hljs-keyword">__DIR__</span>);</td><tr><td class="linenos" data-pseudo-content="9"></td><td>$app = <span class="hljs-keyword">new</span> Application();</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td>$app-&gt;run();</td></table></code></pre>
<p>In this case, I’ve defined <code>CONSOLE_ROOT</code> as the directory in which the console command is run - that way, the commands can use it to refer to the application root.</p>
<p>We can then run our console application as follows:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php console</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Console Tool</td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td>Usage:</td><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-built_in">command</span> [options] [arguments]</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>Options:</td><tr><td class="linenos" data-pseudo-content="8"></td><td>  -h, --<span class="hljs-built_in">help</span>            Display this <span class="hljs-built_in">help</span> message</td><tr><td class="linenos" data-pseudo-content="9"></td><td>  -q, --quiet           Do not output any message</td><tr><td class="linenos" data-pseudo-content="10"></td><td>  -V, --version         Display this application version</td><tr><td class="linenos" data-pseudo-content="11"></td><td>      --ansi            Force ANSI output</td><tr><td class="linenos" data-pseudo-content="12"></td><td>      --no-ansi         Disable ANSI output</td><tr><td class="linenos" data-pseudo-content="13"></td><td>  -n, --no-interaction  Do not ask any interactive question</td><tr><td class="linenos" data-pseudo-content="14"></td><td>  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="hljs-keyword">for</span> normal output, 2 <span class="hljs-keyword">for</span> more verbose output and 3 <span class="hljs-keyword">for</span> debug</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>Available commands:</td><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-built_in">help</span>  Displays <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> a <span class="hljs-built_in">command</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>  list  Lists commands</td></table></code></pre>
<p>This displays the available commands, but you’ll note that there are none except for <code>help</code> and <code>list</code>. We’ll remedy that. First, we’ll register a command:</p>
<pre><code class="hljs lang-php singleline">$app-&gt;add(<span class="hljs-keyword">new</span> App\Console\ClearCacheCommand);</code></pre>
<p>This has to be done in <code>console</code>, after we create <code>$app</code>, but before we run it.</p>
<p>Don’t forget to update the autoload section of your <code>composer.json</code> to register the namespace:</p>
<pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "autoload": {</td><tr><td class="linenos" data-pseudo-content="2"></td><td>        "psr-4": {</td><tr><td class="linenos" data-pseudo-content="3"></td><td>            "App\\Console\\": "src/Console/"</td><tr><td class="linenos" data-pseudo-content="4"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="5"></td><td>    },</td></table></code></pre>
<p>Then create the class for that command. This class must extend <code>Symfony\Component\Console\Command\Command</code>, and must have two methods:</p>
<ul>
<li><code>configure()</code></li>
<li><code>execute()</code></li>
</ul>
<p>In addition, the <code>execute()</code> method must accept two arguments, an instance of <code>Symfony\Component\Console\Input\InputInterface</code>, and an instance of <code>Symfony\Component\Console\Output\OutputInterface</code>. There are used to retrieve input and display output.</p>
<p>Let’s write our command:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Console</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Command</span>\<span class="hljs-title">Command</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputInterface</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Output</span>\<span class="hljs-title">OutputInterface</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClearCacheCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="12"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setName(<span class="hljs-string">'cache:clear'</span>)</td><tr><td class="linenos" data-pseudo-content="14"></td><td>             -&gt;setDescription(<span class="hljs-string">'Clears the cache'</span>)</td><tr><td class="linenos" data-pseudo-content="15"></td><td>             -&gt;setHelp(<span class="hljs-string">'This command clears the application cache'</span>);</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td></td><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></td><tr><td class="linenos" data-pseudo-content="19"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="20"></td><td>        $dir = CONSOLE_ROOT.DIRECTORY_SEPARATOR.<span class="hljs-string">'cache'</span>;</td><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">$this</span>-&gt;deleteTree($dir);</td><tr><td class="linenos" data-pseudo-content="22"></td><td>        $output-&gt;writeln(<span class="hljs-string">'Cache cleared'</span>);</td><tr><td class="linenos" data-pseudo-content="23"></td><td>    } </td><tr><td class="linenos" data-pseudo-content="24"></td><td></td><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteTree</span><span class="hljs-params">($dir)</span></td><tr><td class="linenos" data-pseudo-content="26"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="27"></td><td>        $files = array_diff(scandir($dir), <span class="hljs-keyword">array</span>(<span class="hljs-string">'.'</span>,<span class="hljs-string">'..'</span>)); </td><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">foreach</span> ($files <span class="hljs-keyword">as</span> $file) { </td><tr><td class="linenos" data-pseudo-content="29"></td><td>            (is_dir(<span class="hljs-string">"$dir/$file"</span>)) ? <span class="hljs-keyword">$this</span>-&gt;deleteTree(<span class="hljs-string">"$dir/$file"</span>) : unlink(<span class="hljs-string">"$dir/$file"</span>); </td><tr><td class="linenos" data-pseudo-content="30"></td><td>        } </td><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">return</span> rmdir($dir); </td><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></table></code></pre>
<p>As you can see, in the <code>configure()</code> method, we set the name, description and help text for the command.</p>
<p>The <code>execute()</code> method is where the actual work is done. In this case, we have some code that needs to be called recursively, so we have to pull it out into a private method. Once that’s done we use <code>$output-&gt;writeln()</code> to write a line to the output.</p>
<p>Now, if we run our console task, we should see our new command:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php console</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Console Tool</td><tr><td class="linenos" data-pseudo-content="3"></td><td></td><tr><td class="linenos" data-pseudo-content="4"></td><td>Usage:</td><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-built_in">command</span> [options] [arguments]</td><tr><td class="linenos" data-pseudo-content="6"></td><td></td><tr><td class="linenos" data-pseudo-content="7"></td><td>Options:</td><tr><td class="linenos" data-pseudo-content="8"></td><td>  -h, --<span class="hljs-built_in">help</span>            Display this <span class="hljs-built_in">help</span> message</td><tr><td class="linenos" data-pseudo-content="9"></td><td>  -q, --quiet           Do not output any message</td><tr><td class="linenos" data-pseudo-content="10"></td><td>  -V, --version         Display this application version</td><tr><td class="linenos" data-pseudo-content="11"></td><td>      --ansi            Force ANSI output</td><tr><td class="linenos" data-pseudo-content="12"></td><td>      --no-ansi         Disable ANSI output</td><tr><td class="linenos" data-pseudo-content="13"></td><td>  -n, --no-interaction  Do not ask any interactive question</td><tr><td class="linenos" data-pseudo-content="14"></td><td>  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="hljs-keyword">for</span> normal output, 2 <span class="hljs-keyword">for</span> more verbose output and 3 <span class="hljs-keyword">for</span> debug</td><tr><td class="linenos" data-pseudo-content="15"></td><td></td><tr><td class="linenos" data-pseudo-content="16"></td><td>Available commands:</td><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-built_in">help</span>         Displays <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> a <span class="hljs-built_in">command</span></td><tr><td class="linenos" data-pseudo-content="18"></td><td>  list         Lists commands</td><tr><td class="linenos" data-pseudo-content="19"></td><td> cache</td><tr><td class="linenos" data-pseudo-content="20"></td><td>  cache:clear  Clears the cache</td></table></code></pre>
<p>And we can see it in action too:</p>
<pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php console cache:clear</td><tr><td class="linenos" data-pseudo-content="2"></td><td>Cache cleared</td></table></code></pre>
<p>For commands that need to accept additional arguments, you can define them in the <code>configure()</code> method:</p>
<pre><code class="hljs lang-php singleline"><span class="hljs-keyword">$this</span>-&gt;addArgument(<span class="hljs-string">'file'</span>, InputArgument::REQUIRED, <span class="hljs-string">'Which file do you want to delete?'</span>)</code></pre>
<p>Then, you can access it in the <code>execute()</code> method using <code>InputInterface</code>:</p>
<pre><code class="hljs lang-php singleline">$file = $input-&gt;getArgument(<span class="hljs-string">'file'</span>);</code></pre>
<p>This tutorial is just skimming the surface of what you can do with the Symfony Console components - indeed, many other console interfaces, such as Laravel’s Artisan, are built on top of it. If you have a legacy application built in a framework that lacks any sort of console interface, such as CodeIgniter, then you can quite quickly produce basic console commands for working with that application. The <a href="https://symfony.com/doc/current/console.html">documentation is very good</a>, and with a little work you can soon have something up and running.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Rendering different views for mobile and desktop clients in Laravel]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/04/22/rendering-different-views-for-mobile-and-desktop-clients-in-laravel/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/04/22/rendering-different-views-for-mobile-and-desktop-clients-in-laravel/</guid>
            <pubDate>Sun, 22 Apr 2018 22:50:10 GMT</pubDate>
            <description><![CDATA[<p>This was a bit of a weird post to write. It started out explaining how I resolved an issue years ago on a CodeIgniter site, but amended to work for Laravel. In the process, I realised it made sense to implement it as middleware, and I ended up pulling it out into <a href="https://github.com/matthewbdaly/laravel-dynamic-serving">a package</a>. However, it’s still useful to understand the concept behind it, even if you prefer to just install the complete package, because your needs might be slightly different to mine.</p>
<p>On web development forums, it’s quite common to see variants of the following question:</p>
<blockquote>
<p>How do I redirect a user on a mobile device to a mobile version of the site?</p>
</blockquote>
<p>It’s quite surprising that this is still an issue that crops up. For many years, it’s been widely accepted that the correct solution for this problem is responsive design. However, there are ways in which this may not be adequate for certain applications. For instance, you may have an application where certain functionality only makes sense in a certain context, or your user interface may need to be optimised for specific environments.</p>
<p>The trouble is that a dedicated mobile site isn’t a good idea either. Among other things, it means that users can’t easily use the same bookmarks between desktop and mobile versions, and can result in at least some of the server-side logic being duplicated.</p>
<p>Fortunately, there is another way - <a href="https://developers.google.com/search/mobile-sites/mobile-seo/dynamic-serving">dynamic serving</a> allows you to render different content based on the user agent. You can also easily enable users to switch between desktop and mobile versions themselves if their client isn’t detected correctly or they just prefer the other one. I’ve implemented this years ago for a CodeIgniter site. Here’s how you might implement it in Laravel, although if you understand the principle behind it, it should be easy to adapt for any other framework.</p>
<p>Don’t try to implement mobile user agent detection yourself. Instead, find an implementation that’s actively maintained and install it with Composer. That way you can be reasonably sure that as new mobile devices come onto the market the package will detect them correctly as long as you keep it up to date. I would be inclined to go for <a href="https://github.com/jenssegers/agent">Agent</a>, since it has Laravel support baked in.</p>
<p>We could just use Agent to serve up different content based on the user agent. However, user agent strings are notoriously unreliable - if a new mobile device appears and it doesn’t show up correctly in Agent, users could find themselves forced to use the wrong UI. Instead, we need to check for a flag in the session that indicates if the session is mobile or not. If it’s not set, we set it based on the user agent. That way, if you need to offer functionality to override the detected session type, you can just update that session variable to correct that elsewhere in the application. I would be inclined to use a button in the footer that makes an AJAX request to toggle the flag, then reloads the page.</p>
<p>You also need to set the HTTP response header <code>Vary: User-Agent</code> to notify clients (including not only search engines, but also proxies at either end of the connection, such as Varnish or Squid) that the response will differ by user agent, in order to prevent users being served the wrong version.</p>
<p>Middleware is the obvious place to do this. Here’s a middleware that sets the session variable and the appropriate response headers:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td><tr><td class="linenos" data-pseudo-content="4"></td><td></td><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Jenssegers</span>\<span class="hljs-title">Agent</span>\<span class="hljs-title">Agent</span>;</td><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Session</span>\<span class="hljs-title">Session</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td></td><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DetectMobile</span></td><tr><td class="linenos" data-pseudo-content="10"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> $agent;</td><tr><td class="linenos" data-pseudo-content="12"></td><td></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $session;</td><tr><td class="linenos" data-pseudo-content="14"></td><td></td><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Agent $agent, Session $session)</span></td><tr><td class="linenos" data-pseudo-content="16"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;agent = $agent;</td><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = $session;</td><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="20"></td><td></td><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-comment">/**</td><tr><td class="linenos" data-pseudo-content="22"></td><td>     * Handle an incoming request.</td><tr><td class="linenos" data-pseudo-content="23"></td><td>     *</td><tr><td class="linenos" data-pseudo-content="24"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</span></td><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></td><tr><td class="linenos" data-pseudo-content="29"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;session-&gt;exists(<span class="hljs-string">'mobile'</span>)) {</td><tr><td class="linenos" data-pseudo-content="31"></td><td>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;agent-&gt;isMobile() || <span class="hljs-keyword">$this</span>-&gt;agent-&gt;isTablet()) {</td><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-keyword">$this</span>-&gt;session-&gt;put(<span class="hljs-string">'mobile'</span>, <span class="hljs-keyword">true</span>);</td><tr><td class="linenos" data-pseudo-content="33"></td><td>            } <span class="hljs-keyword">else</span> {</td><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-keyword">$this</span>-&gt;session-&gt;put(<span class="hljs-string">'mobile'</span>, <span class="hljs-keyword">false</span>);</td><tr><td class="linenos" data-pseudo-content="35"></td><td>            }</td><tr><td class="linenos" data-pseudo-content="36"></td><td>        }</td><tr><td class="linenos" data-pseudo-content="37"></td><td>        $response = $next($request);</td><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> $response-&gt;setVary(<span class="hljs-string">'User-Agent'</span>);</td><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="40"></td><td>}</td></table></code></pre>
<p>Now, you could then work with the session directly to retrieve the <code>mobile</code> flag, but as you may be working in the view, it makes sense to create helpers for this:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></td><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">if</span> (!function_exists(<span class="hljs-string">'is_mobile'</span>)) {</td><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_mobile</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="5"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="6"></td><td>        $session = app()-&gt;make(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> $session-&gt;get(<span class="hljs-string">'mobile'</span>) == <span class="hljs-keyword">true</span>;</td><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td><tr><td class="linenos" data-pseudo-content="10"></td><td></td><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">if</span> (!function_exists(<span class="hljs-string">'is_desktop'</span>)) {</td><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_desktop</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td>    </span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>        $session = app()-&gt;make(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> $session-&gt;get(<span class="hljs-string">'mobile'</span>) == <span class="hljs-keyword">false</span>;</td><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></table></code></pre>
<p>Now, if you want to serve up completely different views, you can use these helpers in your controllers. If you instead want to selectively show and hide parts of the UI based on the user agent, you can instead use these in the views to determine what parts of the page should be shown.</p>
<p>Agent offers more functionality than just detecting if a user agent is a mobile or desktop device, and you may find this useful as a starting point for developing middleware for detecting bots, or showing different content to users based on their device type or operating system. If you just need to detect if a user is a mobile or desktop client, this middleware should be sufficient.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Making Wordpress less shit]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/04/12/making-wordpress-less-shit/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/04/12/making-wordpress-less-shit/</guid>
            <pubDate>Thu, 12 Apr 2018 22:57:05 GMT</pubDate>
            <description><![CDATA[<p>I’m not going to sugarcoat it. As a developer, I think Wordpress is shit, and I’m not alone in that opinion. Its code base dates from a time before many of the developments of the last few years that have hugely improved PHP as a language, as well as the surrounding ecosystem such as Composer and PSR-FIG, and it’s likely it couldn’t adopt many of those without making backward-incompatible changes that would affect its own ecosystem of plugins and themes. It actively forces you to write code that is far less elegant and efficient than what you might write with a proper framework such as Laravel, and the quality of many of the plugins and themes around is dire.</p>
<p>Unfortunately, it’s also difficult to avoid. Over a quarter of all websites run Wordpress, and most developers will have to work with it at some point in their careers. However, there are ways that you can improve your experience when working with Wordpress somewhat. In this post I’m going to share some methods you can use to make Wordpress less painful to use.</p>
<p>This isn’t a post about the obvious things like “Use the most recent version of PHP you can”, “Use SSL”, “Install this plugin”, “Use Vagrant/Lando” etc - I’m assuming you already know stuff like that for bog standard Wordpress development. Nor is it about actually developing Wordpress plugins or themes. Instead, this post is about bringing your Wordpress development workflow more into line with how you develop with MVC frameworks like Laravel, so that you have a better experience working with and maintaining Wordpress sites. We can’t solve the fundamental issues with Wordpress, but we can take some steps to make it easier to work with.</p>
<h2 id="use-bedrock">Use Bedrock</h2>
<p><a href="https://roots.io/bedrock/">Bedrock</a> is still Wordpress, but reorganized so that:</p>
<ul>
<li>The Wordpress core, plugins and themes can be managed with Composer for easier updates</li>
<li>The configuration can be done with a <code>.env</code> file that can be kept out of version control, rather than putting it in <code>wp-config.php</code></li>
<li>The web root is isolated to limit access to the files</li>
</ul>
<p>In short, it optimizes Wordpress for how modern developers work. Arguably that’s at the expense of site owners, since it makes it harder for non-developers to manage the site, however for any Wordpress site that’s sufficiently complex to need development work done that’s a trade-off worth making. I’ve been involved in projects where Wordpress got used alongside an MVC framework for some custom functionality, and in my experience it caused a world of problems when updating plugins and themes because version control would get out of sync, so moving that to use Composer to manage them instead would have been a huge win.</p>
<p>Using Bedrock means that if you have a parent theme you use all the time, or custom plugins of your own, you can install them using Composer by adding the Git repositories to your <code>composer.json</code>, making it easier to re-use functionality you’ve already developed. It also makes recovery easier in the event of the site being compromised, because the files outside the vendor directory will be in version control, and you can delete the vendor directory and re-run <code>composer install</code> to replace the rest. By comparison, with a regular Wordpress install, if it’s compromised you can’t always be certain you’ve got all of the files that have been changed. Also, keeping Wordpress up to date becomes a simple matter of running <code>composer update</code> regularly, verifying it hasn’t broken anything, and then deploying it to production.</p>
<p>Bedrock uses <a href="https://wpackagist.org/">WPackagist</a>, which regularly scans the Wordpress Subversion repository for plugins and themes, so at least for plugins and themes published on the Wordpress site, it’s easy to install them. Paid plugins may be more difficult - I’d be inclined to put those in a private Git repository and install them from there, although I’d be interested to know if anyone else uses another method for that.</p>
<h2 id="if-you-can-t-use-bedrock-use-wp-cli">If you can’t use Bedrock, use WP CLI</h2>
<p>If for any reason you can’t use Bedrock for a site, then have a look at <a href="https://wp-cli.org/">WP CLI</a>. On the server, you can use it to install and manage both plugins and themes, as well as the Wordpress core.</p>
<p>It’s arguably even more useful locally, as it can be used to generate scaffolding for plugins, themes (including child themes based on an existing theme), and components such as custom post types or taxonomies. In short, if you do any non-trivial amount of development with Wordpress you’ll probably find a use for it. Even if you can use Bedrock, you’re likely to find WP CLI handy for the scaffolding.</p>
<h2 id="upgrade-the-password-encryption">Upgrade the password encryption</h2>
<p>I said this wouldn’t be about using a particular plugin, but this one is too important. Wordpress’s password hashing still relies on MD5, which is <em>far</em> too weak to be considered safe. Unfortunately, Wordpress still supports PHP versions as old as 5.2, and until they drop it they can’t really switch to something more secure.</p>
<p><a href="https://roots.io/plugins/bcrypt-password/">wp-password-bcrypt</a> overrides the password functionality of Wordpress to use Bcrypt, which is what modern PHP applications use. As a result, the hashes are considerably stronger. Given that Wordpress is a common target for hackers, it’s prudent to ensure your website is as secure as you can possibly make it.</p>
<p>If you use Bedrock, it uses this plugin by default, so it’s already taken care of for you.</p>
<h2 id="use-a-proper-templating-system">Use a proper templating system</h2>
<p>PHP is a weird hybrid of a programming language and a templating system. As such, it’s all too easy to wind up with too much logic in your view layer, so it’s a good idea to use a proper templating system if you can. Unfortunately, Wordpress doesn’t support that out of the box.</p>
<p>However, there are some third-party solutions for this. <a href="https://roots.io/sage/">Sage</a> uses Laravel’s Blade templating system (and also comes with Webpack preconfigured), while <a href="https://www.upstatement.com/timber/">Timber</a> lets you use Twig.</p>
<h2 id="use-the-wordpress-rest-api-for-ajax-where-you-can">Use the Wordpress REST API for AJAX where you can</h2>
<p>Version 4.7 of Wordpress introduced the <a href="https://v2.wp-api.org/">Wordpress REST API</a>, allowing the data to be exposed via RESTful endpoints. As a result, it should now be possible to build more complex and powerful user interfaces for that data. For instance, if you were using Wordpress to build a site for listing items for sale, you could create a single-page web app for the front end using React.js and Redux, and use the API to submit it, then show the submitted items.</p>
<p>I’m not a fan of the idea the Wordpress developers seem to have of trying to make it some kind of all-singing, all-dancing universal platform for the web, and the REST API seems to be part of that idea, but it does make it a lot easier than it was in the past to do something a bit out of the ordinary with Wordpress. In some cases it might be worth using Wordpress as the backend for a <a href="https://en.wikipedia.org/wiki/Headless_CMS">headless CMS</a>, and the REST API makes that a practical approach. For simpler applications that just need to make a few AJAX calls, using the REST API is generally going to be more elegant and practical than any other approach to AJAX with Wordpress. It’s never going to perform as well or be as elegant as a custom-built REST API, but it’s definitely a step forward compared to the hoops you used to have to jump through to handle AJAX requests in Wordpress.</p>
<h2 id="summary">Summary</h2>
<p>Wordpress is, and will remain for the foreseeable future, a pain in the backside to develop for compared to something like Laravel, and I remain completely mystified by the number of people who seem to think it’s the greatest thing since sliced bread. However, it is possible to make things better if you know how - it’s just that some of this stuff seems to be relatively obscure. In particular, discovering Bedrock is potentially game-changing because it makes it so much easier to keep the site under version control.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Using stored procedures in your web app]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/03/10/using-stored-procedures-in-your-web-app/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/03/10/using-stored-procedures-in-your-web-app/</guid>
            <pubDate>Sat, 10 Mar 2018 15:10:16 GMT</pubDate>
            <description><![CDATA[<p>In the last few days I’ve done something I’ve never done before, namely written a stored procedure for a web app. Like most web developers, I know enough about SQL to be able to formulate some fairly complex queries, but I hadn’t really touched on control flow functions or stored procedures, and in my experience they tend to be the province of the dedicated database administrator, not us web devs, who will typically delegate more complex functionality to our application code.</p>
<p>In this case, there were a number of factors influencing my decision to use a stored procedure for this:</p>
<ul>
<li>The application was a legacy application which had been worked on by developers of, shall we say, varying skill levels. As a result the database schema was badly designed, with no prospect of changing it without causing huge numbers of breakages</li>
<li>The query in question was used to generate a complex report that was quite time-consuming, therefore the optimisations from using a stored procedure were worthwhile.</li>
<li>The report required that data be grouped by a set of categories which were stored in a separate table, which meant the table had to be pivoted (transformed from rows to columns), resulting in an incredibly complex dynamic query that had to be constructed on the fly by concatenating different SQL strings. In PostgreSQL, this can be done fairly easily using the <code>crosstab</code> function, but MySQL doesn’t have native support for anything like this.</li>
</ul>
<p>Historically, one issue with using stored procedures has been that it kept business logic out of the application code, meaning they are not stored in version control. However, most modern frameworks provide some support for migrations, and since they are intended to be used to make changes to the database, they are the obvious place to define the stored procedure. This particular application was built with an older framework that didn’t come with migrations, so we’d installed <a href="https://phinx.org/">Phinx</a> to handle those for us. Initially, I defined the stored procedure inside a migration that ran a raw query to create the stored procedure, as in this example:</p>
<pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="2"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="3"></td><td>   $query = <span class="hljs-string">&lt;&lt;&lt;EOF</td><tr><td class="linenos" data-pseudo-content="4"></td><td>CREATE PROCEDURE IF NOT EXISTS foo</td><tr><td class="linenos" data-pseudo-content="5"></td><td>BEGIN</span></td><tr><td class="linenos" data-pseudo-content="6"></td><td>   SELECT * FROM foo;</td><tr><td class="linenos" data-pseudo-content="7"></td><td>END</td><tr><td class="linenos" data-pseudo-content="8"></td><td>EOF;</td><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">$this</span>-&gt;execute($query);</td><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td><tr><td class="linenos" data-pseudo-content="11"></td><td></td><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></td><tr><td class="linenos" data-pseudo-content="13"></td><td></span>{</td><tr><td class="linenos" data-pseudo-content="14"></td><td>   <span class="hljs-keyword">$this</span>-&gt;execute(<span class="hljs-string">'DROP PROCEDURE IF EXISTS foo'</span>);</td><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></table></code></pre>
<p>Once this is done, you can then use your framework’s particular support for raw queries to call <code>CALL foo()</code> whenever your stored procedure needs to be executed.</p>
<p>However, we soon ran into an issue. It turns out <code>mysqldump</code> doesn’t export stored procedures by default, so there was a risk that anyone working on the code base might import the database from an SQL file and not get the migrations. I’d used the Symfony Console component to create a simple command-line tool, reminiscent of Laravel’s Artisan, so I used that to create a command to set up the stored procedure, amended the migration to call that command, and placed a check in the application where the procedure was called so that if it was not defined the command would be called and the procedure would be created. In most cases this wouldn’t be an issue.</p>
<p>Having now had experience using stored procedures in a web application, there are a number of issues they raise:</p>
<ul>
<li>It’s hard to make queries flexible, whereas with something like Eloquent it’s straightforward to conditionally apply <code>WHERE</code> statements.</li>
<li>While storing them in migrations is a practical solution, if the database is likely to be imported rather than created from scratch during development it can be problematic.</li>
<li>They aren’t easily portable, not just between database management systems, but between different versions - the production server was using an older version of MySQL, and it failed to create the procedure. It’s therefore good practice for your migrations to check the procedure was created successfully and raise a noisy exception if they failed.</li>
</ul>
<p>Conversely, they do bring certain benefits:</p>
<ul>
<li>For particularly complex transactions that don’t change, such as generating reports, they are a good fit since they reduce the amount of data that needs to be sent to the database and allow the query to be pre-optimised somewhat.</li>
<li>If a particular query is unusually expensive, is called often, and can’t be cached, it may improve performance to make it a stored procedure.</li>
<li>Doing a query in a for loop is usually a very big no-no. However, if there really is no way to avoid it (and this should almost never happen), it would make sense to try to do it in a stored procedure using SQL rather than in application code since that would minimise the overhead.</li>
<li>If multiple applications need to work with the same database, using stored procedures for queries in more than one application removes the need to reimplement or copy over the code for the query in the second application - they can just call the same procedure, and if it needs to be changed it need only be done once.</li>
</ul>
<p>Honestly, I’m not sure I’m ever likely to again come across a scenario where using a stored procedure in a web application would be beneficial, but it’s been very interesting delving into aspects of SQL that I don’t normally touch on and I’ve picked up on some rarely-used SQL statements that I haven’t used before, such as <code>GROUP_CONCAT()</code> and <code>CASE</code>. With the widespread adoption of migrations in most frameworks, I think that the argument that using stored procedures keeps application logic out of version control no longer holds any water, since developers can generally be trusted to store changes to database structure in their migrations and not start messing them around, so the same applies for stored procedures. Report generation seems to be the ideal use case since this invariably involves complex queries that run regularly and don’t change often, and this is where I expect it would be most likely I’d have cause to use them again.</p>
]]></description>
        </item>
    </channel>
</rss>