<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/6/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">24th September 2018 10:30 pm</p><h1><a href="/blog/2018/09/24/how-i&#x27;m-refactoring-a-zend-1-legacy-project/">How I&#x27;m Refactoring a Zend 1 Legacy Project</a></h1><p>In my current job I’ve been maintaining and developing a Zend 1 legacy project for the best part of a year. It has to be said, it’s the worst code base I have ever seen, with textbook examples of many antipatterns, spaghetti jQuery, copy-pasted code and overly complex methods. It’s a fairly typical example of a project built on an older MVC framework by inexperienced developers (I’ve been responsible for building similar things in my CodeIgniter days).</p><p>In this article I’ll go through some of the steps I’ve taken to help bring this legacy project under control. Not all of them are complete as at time of writing, but they’ve all helped to make this decidedly crappy project somewhat better. In working with this legacy project, I’ve found Paul Jones’ book <em>Modernizing Legacy Applications in PHP</em> to be very useful, and if you’re working on a similar legacy project, I highly recommend investing in a copy. I’ve also found <a href="https://sourcemaking.com/">Sourcemaking</a> to be a useful resource in identifying antipatterns in use, refactoring strategies, and applicable design patterns.</p><h1 id="moving-to-git">Moving to Git</h1><p>When I first started working on the project, the repository was in Subversion, and was absolutely colossal - checking it out took two hours! Needless to say, my first action was to migrate it to Git. I used <a href="https://john.albin.net/git/convert-subversion-to-git">this post</a> as a guide, and it was pretty straightforward, but took all of my first day.</p><h1 id="adding-migrations">Adding migrations</h1><p>The next job involved making some changes to the database. Unfortunately, Zend 1 doesn’t include migrations, and no-one had added a third party solution. I therefore did some research and wound up stumbling across <a href="https://phinx.org/">Phinx</a>, which is a standalone migration package with a command-line runner. Using that, it was straightforward to start adding migrations to make any necessary changes to the database structure and fixtures.</p><h1 id="moving-dependencies-to-composer">Moving dependencies to Composer</h1><p>The project was using Composer, but only to a limited degree - the framework itself was in the <code>library/</code> folder, and several other dependencies were also stored here. The <code>vendor/</code> directory was also checked into version control. I therefore took the vendor folder out of Git, and added <code>zendframework/zendframework1</code> as a dependency. This drastically reduced the size of the repository.</p><h1 id="cleaning-up-commented-code">Cleaning up commented code</h1><p>There was an awful lot of commented code. Some of it was even commented out incorrectly (PHP code commented out with HTML comments). I’m of the school of thought that commented code is best deleted without a second thought, since it can be retrieved from version control, and it can be confusing, so I’ve been removing any commented code I come across.</p><h1 id="refactoring-duplicate-code">Refactoring duplicate code</h1><p>One of the biggest problems with the code base was the high level of duplication - a lot of code, particularly in the view layer, had been copied and pasted around. Running PHPCPD on the repository showed that, not including the views, around 12% of the code base was copied-and-pasted, which is a horrific amount. I therefore started aggressively refactoring duplicate code out into helpers and traits. As at today, the amount of duplication excluding the views is around 2.6%, which is obviously a big improvement.</p><h1 id="refactoring-object-creation-code-into-persisters">Refactoring object creation code into persisters</h1><p>There was some extremely complex code for creating and updating various objects that was jammed into the controllers, and involved a lot of duplicate code. I’ve used dedicated persister classes in the past with great effect, so I pulled that code out into persisters to centralise the logic about the creation of different objects. It’s still a lot more convoluted than I’d like, but at least now it’s out of the controllers and can be tested to some extent.</p><h1 id="creating-repositories">Creating repositories</h1><p>One of the most problematic parts of the code base is the models. Whoever was responsible for them couldn’t seem to decide whether they represented a single domain object, or a container for methods for getting those objects, so both responsibilities were mixed up in the same class. This means you had to instantiate an object, then use it to call one of the methods to get another instance of that object, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$media = <span class="hljs-keyword">new</span> Application_Model_Media;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$media = $media-&gt;find(<span class="hljs-number">1</span>);</td></tr></table></code></pre><p>I’ve therefore resolved to pull those methods out into separate repository classes, leaving the models as pure domain objects. Unfortunately, the lack of dependency injection makes it problematic to instantiate the repositories. For that reason, right now the repositories only implement static methods - it’s not ideal, but it’s better than what we have now.</p><p>I started out by creating interfaces for the methods I wanted to migrate, and had the models implement them. Then, I moved those methods from the model to the repository classes and amended all references to them, before removing the interfaces from the models. Now, a typical find request looks like this:</p><pre><code class="hljs lang-php singleline">$media = App\Repository\Media::find(<span class="hljs-number">1</span>);</code></pre><p>It’s not done yet, but over half of them have been migrated.</p><p>Once that’s done, I’ll then be in a position to look at refactoring the logic in the models to make them easier to work with - right now each model has dedicated setters and getters (as well as some horrific logic to populate them), and I’m considering amending them to allow access to the properties via the <code>__get()</code> and <code>__set()</code> magic methods. Another option is to consider migrating the database layer to Doctrine, since that way we can reuse the getters and setters, but I haven’t yet made a firm decision about that.</p><h1 id="adding-tests">Adding tests</h1><p>The poor design of this application makes it difficult to test, so right now the coverage is poor. I’ve been using Behat to produce a basic set of acceptance tests for some of the most fundamental functionality, but they’re brittle and can be broken by database changes. I’ve also added some (even more brittle) golden master tests using a technique I’ll mention in a later blog post. I have got unit tests for three of the persister classes and some utility classes I’ve added, but nowhere near the level I want.</p><h1 id="refactoring-code-out-of-the-fat-controllers">Refactoring code out of the fat controllers</h1><p>Fat controllers are an antipattern I’ve seen, and indeed been responsible for myself, in the past, and this project has them in spades - running PHP Mess Detector on them is pretty sobering. The overwhelming majority of the code base is concentrated in the controllers, and it’s going to take a long time to refactor it into other classes.</p><p>Zend 1 does have the concept of controller helpers, and that’s been useful for removing some duplicate code, while more shared code has been refactored out into traits. In addition, the utilities I’ve added include a Laravel-style collection class, and using that I’ve been able to refactor a lot of quite complex array handling into much simpler chained collection handling. However, this is still going to take a lot of effort.</p><h1 id="adding-events">Adding events</h1><p>The lack of a decent event system caused particular problems when I was asked to add tracking of when a user views certain resources, so I used the <a href="http://event.thephpleague.com/2.0/">PHP League’s Event package</a> for this. I’ve started moving some other functionality to event listeners too, but this is another thing that will take a long time.</p><h1 id="refactoring-the-front-end">Refactoring the front end</h1><p>Like many legacy projects, the front end is a horrible mess of jQuery spaghetti code, with some Handlebars templates thrown in here and there for good measure. It’s easily complex enough that it would benefit from a proper front-end framework, but a full rewrite is out of the question.</p><p>I was recently asked to add two new modals in the admin interface, and decided that it was worth taking a new approach rather than adding yet more jQuery spaghetti. Angular 1 is on its way out, so that wasn’t an option, and Angular 2+ would necessitate using Typescript, which would likely be problematic in the context of a legacy app, as well as the complexity being an issue. Vue was a possibility, but I always feel like Vue tries to do too much. Instead, I decided to go for React, because:</p><ul><li>I’ve always enjoyed working with React, even though I haven’t had much chance to do so in the past.</li><li>We’re using Laravel Mix for processing the CSS and JS files (it can be used on non-Laravel projects), and it has a preset for React</li><li>React is well-suited to being added incrementally to existing projects without the need for a full rewrite (after all, it works for Facebook…), so it was straightforward to do a single modal with it</li><li>It’s easy to test - you can use snapshot tests to check it remains consistent, and using Enzyme it’s straightforward to navigate the rendered component for other tests</li></ul><p>Both modals turned out very well, and went live recently. The first one took a fair while to write, and then when I wrote the second one, I had to spend some time making the sub-components more generic and pulling some functionality out into a higher order component, but now that that’s done it should be straightforward to write more.</p><p>In the longer term I plan to migrate more and more of the admin to React over time. The front end also has a new home page on the cards, and the plan is to use React for that too. Once the whole UI is using React, that will have eliminated most, if not all, of the problems with duplicate code in the view layer, as well as allowing for eventually turning the application into a single-page web app.</p><h1 id="upgrading-the-php-version-and-migrating-to-a-new-server">Upgrading the PHP version and migrating to a new server</h1><p>When I started work on the project, it was running on an old server running PHP 5.4, but there were plans to migrate to a new server running PHP 5.6. The lack of tests made it difficult to verify it wouldn’t break in 5.6, but using PHP Compatibility and CodeSniffer I was able to find most of the problems. I ran it on PHP 5.6 locally during development so that any new development would be done on a more modern version. In the end, the migration to the new server was fairly seamless.</p><p>We will have to consider migrating to a newer PHP version again, since 5.6 is no longer supported as at the end of this year, but it may be too risky for now.</p><h1 id="namespacing-the-code">Namespacing the code</h1><p>As Zend 1 predates PHP namespaces, the code wasn’t namespaced. This is something I do plan to remedy - the form and model classes should be straightforward to namespace, but the controllers are a bit more problematic. I’m waiting on completing the repositories before I look at this.</p><h1 id="adding-psr-3-logging">Adding PSR-3 logging</h1><p>The existing logging solution was not all that great. It had drivers for several different logging solutions, but nothing terribly modern - one was for the now-discontinued Firebug extension for Firefox. However, it was fairly similar to PSR-3, so it wasn’t too much work to replace it. I installed Monolog, and amended the bootstrap file to store that as the logger in the Zend registry - that way, we could set up many different handlers. I now have it logging to a dedicated Slack channel when an error occurs in staging or production, which makes it much easier to detect problems. This would also make it easy to set up many other logging handlers, such as the ELK stack.</p><h1 id="debugging">Debugging</h1><p><a href="https://underground.works/clockwork/">Clockwork</a> is my usual PHP debugging solution, and the absence of support for it in Zend 1 made it difficult to work with. Fortunately, it’s quite straightforward to implement your own <a href="https://underground.works/clockwork/extending-data-sources?#content">data sources</a> for Clockwork. I set it up to use the aforementioned logger as a data source, as well as the <a href="https://framework.zend.com/manual/1.12/en/zend.db.profiler.html">Zend 1 profiler</a>. I also added a data source for the events implementation, and added a global <code>clock()</code> helper function, as well as one for the Symfony VarDumper component. Together these give me a reasonably good debugging experience.</p><h1 id="adding-console-commands">Adding console commands</h1><p>I’ve mentioned before that I’ve been using Symfony’s console component a lot lately, and this project is why. Zend 1 does not come with any sort of console task runner, and we needed an easy way to carry out certain tasks, such as:</p><ul><li>Setting up a stored procedure</li><li>Anonymizing user data with Faker</li><li>Regenerating durations for audio and video files</li></ul><p>In addition, I wanted a Laravel Tinker-style interactive shell. I was able to accomplish this with PsySh and the console components. For legacy projects that lack a console task runner, it’s worth considering adding one.</p><h1 id="configuration">Configuration</h1><p>The configuration system in Zend 1 is downright painful - it requires that you define multiple environments in there. I have integrated DotEnv, but only part of the configuration has been migrated over, so there’s still plenty of work there.</p><h1 id="what-s-left-to-do">What’s left to do</h1><p>The code base is in a much better state than it was, but there’s still an awful lot to do. Zend 1 does apparently still work with PHP 7.1, but not with 7.2, so at some point we’ll likely need to leave Zend 1 behind entirely. This process has already started with us ditching Zend_Log for Monolog, and over time I plan to replace the various components of Zend 1 with other packages, either ones from newer versions of Zend Framework, or elsewhere. While there are many articles about migrating Zend 1 to later versions, very few of them actually seem to go into much detail - certainly nothing as useful as a step-by-step guide.</p><p>The database layer is particularly bad, and refactoring some of the methods into repository classes is only the first step in bringing that under control. Once that’s finished, I’m going to start going through the models and seeing if any more methods would make more sense as static methods on the repository, and possibly rename some of them. Then, we can think about the possibility of either incrementally migrating to another database interface (either a newer version of Zend DB, or Doctrine), or refactoring the existing models to have less boilerplate by using magic methods instead of getters and setters.</p><p>Dependency injection is a must at some point, but isn’t practical right now - Zend 1 controllers implement an interface that defines the constructor arguments, so you can’t pass in any additional parameters, so that will need to wait until the controllers no longer use Zend 1. I have been using the Zend Registry as a poor man’s DI container, since it allows sharing of a single object throughout the application, but it’s not a good solution in the long term.</p><p>The routing is also painful - Zend 1’s routes are all stored in the bootstrap file. I’d prefer to use something like <code>league/route</code>, which would allow for handling different HTTP methods to the same route using different controller methods, making it easier to separate out handling of GET and POST requests.</p><p>I also want at some point to set up a queue system for processing video and audio content - at present it’s handled by running a shell command from PHP, which means you can’t easily get feedback if something goes wrong. Migrating that to a queue system, backed with something like Redis, would help a great deal.</p><h1 id="share-your-stories">Share your stories</h1><p>I’d love to hear any similar stories about refactoring legacy applications - how you’ve solved various problems with those legacy apps (or how you’d solve the ones I’ve had), tools you’ve used, and so on. Feel free to provide details in the comments.</p><p>A legacy project like this can be very frustrating to work with, but it can also feel quite rewarding to bring it under control over a period of time. My experience has been that you get the best results by working in small, regular steps, and over time your experience working with the code base will improve.</p></article><article class="post"><p class="date">13th September 2018 8:10 pm</p><h1><a href="/blog/2018/09/13/mutation-testing-with-infection/">Mutation Testing With Infection</a></h1><p>Writing automated tests is an excellent way of catching bugs during development and maintenance of your application, not to mention the other benefits. However, it’s hard to gauge the quality of your tests, particularly when you first start out. Coverage will give you a good idea of what code was actually run during the test, but it won’t tell you if the test itself actually tests anything worthwhile.</p><p><a href="https://infection.github.io/">Infection</a> is a mutation testing framework. The documentation defines mutation testing as follows:</p><blockquote><p>Mutation testing involves modifying a program in small ways. Each mutated version is called a Mutant. To assess the quality of a given test set, these mutants are executed against the input test set to see if the seeded faults can be detected. If mutated program produces failing tests, this is called a killed mutant. If tests are green with mutated code, then we have an escaped mutant.</p></blockquote><p>Infection works by running the test suite, carrying out a series of mutations on the source code in order to try to break the tests, and then collecting the results. The actual mutations carried out are not random - there is a set of mutations that get carried out every time, so results should be consistent. Ideally, all mutants should be killed by your tests - escaped mutants can indicate that either the line of mutated code is not tested, or the tests for that line are not very useful.</p><p>I decided to add mutation testing to my <a href="https://github.com/matthewbdaly/laravel-cart">Laravel shopping cart package</a>. In order to use Infection, you need to be able to generate code coverage, which means having either XDebug or phpdbg installed. Once Infection is installed (refer to the documentation for this), you can run this command in the project directory to configure it:</p><pre><code class="hljs lang-bash singleline">$ infection</code></pre><p>Infection defaults to using PHPUnit for the tests, but it also supports PHPSpec. If you’re using PHPSpec, you will need to specify the testing framework like this:</p><pre><code class="hljs lang-bash singleline">$ infection --<span class="hljs-built_in">test</span>-framework=phpspec</code></pre><p>Since PHPSpec doesn’t support code coverage out of the box, you’ll need to install a package for that - I used <code>leanphp/phpspec-code-coverage</code>.</p><p>On first run, you’ll be prompted to create a configuration file. Your source directory should be straightforward to set up, but at the next step, if your project uses interfaces in the source directory, you should exclude them. The rest of the defaults should be fine.</p><p>I found that the first run gave a large number of uncovered results, but the second and later ones were more consistent - not sure if it’s an issue with my setup or not. Running it gave me this:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    0 [&gt;---------------------------] &lt; 1 secRunning initial <span class="hljs-built_in">test</span> suite...</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   27 [============================] 3 secs</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 43/43</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>...................MMM...M.......M.........          (43 / 43)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>43 mutations were generated:</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      38 mutants were killed</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       5 covered mutants were not detected</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 88%</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 88%</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 21s. Memory: 12.00MB</td></tr></table></code></pre><p>Our test run shows 5 escaped mutants, and the remaining 38 were killed. We can view the results by looking at the generated <code>infection-log.txt</code>:</p><pre><code class="hljs lang-txt"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Escaped mutants:</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>================</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-number">1</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] DecrementInteger</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">-1</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-number">2</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] OneZeroInteger</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">1</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td><span class="hljs-number">3</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] GreaterThan</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt;= <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td><span class="hljs-number">4</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">133</span>    [M] Assignment</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>                 <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>-                    $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>+                    $item[<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>             <span class="hljs-keyword">return</span> $item;</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td><span class="hljs-number">5</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">197</span>    [M] OneZeroInteger</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>      */</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasStringKeys</span><span class="hljs-params">(array $items)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>-        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>+        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>     }</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>     <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>      * Validate input</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>Timed Out mutants:</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>==================</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>Not Covered mutants:</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>====================</td></tr></table></code></pre><p>This displays the mutants that escaped, and include a diff of the changed code, so we can see that all of these involve changing the comparison operators.</p><p>The last one can be resolved easily because the comparison is superfluous - the result of <code>count()</code> can be evaluated as true or false by itself, so removing the <code>&gt; 0</code> at the end in the test solves the problem quite neatly.</p><p>The other four mutations are somewhat harder. They all amend the <code>decrement</code> method’s conditions, showing that a single assertion doesn’t really fully check the behaviour. Here’s the current test for that method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>It should be possible to decrement it if the quantity is more than zero, but not to go any lower. However, our current test does not catch anything but decrementing it from 2 to 1, which doesn’t fully demonstrate this. We therefore need to add a few more assertions to cover taking it down to zero, and then trying to decrement it again. Here’s how we might do that.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        $newerdata = $newdata;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        $newerdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newdata);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newerdata);</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>If we re-run Infection, we now get a much better result:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Running initial <span class="hljs-built_in">test</span> suite...</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   22 [============================] 3 secs</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 41/41</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>.........................................            (41 / 41)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>41 mutations were generated:</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      41 mutants were killed</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       0 covered mutants were not detected</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 100%</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 100%</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 19s. Memory: 12.00MB</td></tr></table></code></pre><p>Code coverage only tells you what lines of code are actually executed - it doesn’t tell you much about how effectively that line of code is tested. Infection gives you a different insight into the quality of your tests, helping to write better ones. I’ve so far found it very useful for getting feedback on the quality of my tests. It’s interesting that PHPSpec tests seem to have a consistently lower proportion of escaped mutants than PHPUnit ones - perhaps the more natural workflow when writing specs with PHPSpec makes it easier to write good tests.</p></article><article class="post"><p class="date">9th September 2018 1:40 pm</p><h1><a href="/blog/2018/09/09/switching-from-vim-to-neovim/">Switching from Vim to Neovim</a></h1><p>I honestly thought it would never happen. I’ve been using Vim since 2008, and every other editor I’ve tried (including VSCode, Emacs, Sublime Text and Atom) hasn’t come up to scratch. There were a few useful features in PHPStorm, to be fair, but nothing that justified the bother of moving. Also, I suffer from a degree of RSI from my prior career as an insurance clerk (years of using crap keyboards and mice on Windows XP took its toll…), and Vim has always been the most RSI-friendly editor I found.</p><p>Yet I have actually gone ahead and migrated away… to Neovim. Of course, the fact that the workflow is essentially identical helps in the migration process, as does the fact that it supports most of the same plugins.</p><p>My workflow has always been strongly CLI-based. I use GNU Screen and Byobu together to run multiple “tabs” in the terminal, so the lack of GUI support in Neovim doesn’t bother me in the slightest. The only change I really made was to my <code>.bash_aliases</code> so that the Vim command ran <code>screen -t Vim nvim</code>, so that it would open up Neovim rather than Vim in a new Screen tab.</p><p>Initially I switched straight over to using the same settings and plugins I had with Vim, and they worked seamlessly. However, after a while I decided to use the opportunity to completely overhaul the plugins and settings I used and largely start over - cull the ones I no longer needed, add some new ones, and comment it properly.</p><h2 id="loading-plugins">Loading plugins</h2><p>I used to use Pathogen to manage my Vim plugins, but it didn’t actually import the plugins itself, and just provided a structure for them. This meant that the only practical way I found to pull in third-party plugins was to set them up as Git submodules, meaning I had to store my configuration in version control and clone it recursively onto a new machine. It also made updating cumbersome.</p><p>Now I’ve switched to <a href="https://github.com/junegunn/vim-plug">vim-plug</a>, which makes things much easier. I can define my dependencies in my <code>.config/nvim/init.vim</code> and pull them in with <code>PlugInstall</code>. If I want to update them, I run <code>PlugUpdate</code>, or if I need to add something else, I merely add it in the file and run <code>PlugInstall</code> again. Nice and easy.</p><p>The first section of my configuration file loads the dependencies:</p><pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">call</span> plug#begin()</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">" NERDTree</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Plug <span class="hljs-string">'scrooloose/nerdtree'</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-comment">" Git integration</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Plug <span class="hljs-string">'tpope/vim-fugitive'</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Plug <span class="hljs-string">'airblade/vim-gitgutter'</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-comment">" Linting</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>Plug <span class="hljs-string">'neomake/neomake'</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>Plug <span class="hljs-string">'w0rp/ale'</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-comment">" PHP-specific integration</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Plug <span class="hljs-string">'phpactor/phpactor'</span> ,  {<span class="hljs-string">'do'</span>: <span class="hljs-string">'composer install'</span>, <span class="hljs-string">'for'</span>: <span class="hljs-string">'php'</span>}</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Plug <span class="hljs-string">'ncm2/ncm2'</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Plug <span class="hljs-string">'roxma/nvim-yarp'</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Plug <span class="hljs-string">'phpactor/ncm2-phpactor'</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-comment">" Snippets</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>Plug <span class="hljs-string">'SirVer/ultisnips'</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>Plug <span class="hljs-string">'honza/vim-snippets'</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-comment">" Comments</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>Plug <span class="hljs-string">'tpope/vim-commentary'</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-comment">" Search</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>Plug <span class="hljs-string">'ctrlpvim/ctrlp.vim'</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td><span class="hljs-comment">" Syntax</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>Plug <span class="hljs-string">'sheerun/vim-polyglot'</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>Plug <span class="hljs-string">'matthewbdaly/vim-filetype-settings'</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td><span class="hljs-comment">" Themes</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Plug <span class="hljs-string">'nanotech/jellybeans.vim'</span> , {<span class="hljs-string">'as'</span>: <span class="hljs-string">'jellybeans'</span>}</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td><span class="hljs-keyword">call</span> plug#end()</td></tr></table></code></pre><p>As always, it’s a good idea to comment your config and try to group things logically. Note that I have one plugin of my own listed here - this is just a collection of settings for different filetypes, such as making Javascript files use 2 spaces for indentation, and it’s easier to keep that in a repository and pull it in as a dependency.</p><h2 id="completion">Completion</h2><p>The next part of the config deals with configuration. Most of the time the default omnicompletion is pretty good, but in the process of building out this config, I discovered PHPActor, which has massively improved my development experience with PHP - it finally provides completion as good as most IDE’s, and also provides similar refactoring tools. My config for completion currently looks like this:</p><pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">"Completion</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">autocmd</span> FileType * <span class="hljs-keyword">setlocal</span> formatoptions-=<span class="hljs-keyword">c</span> formatoptions-=r formatoptions-=<span class="hljs-keyword">o</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">set</span> ofu=syntaxcomplete#Complete</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">autocmd</span> FileType php <span class="hljs-keyword">setlocal</span> omnifunc=phpactor#Complete</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">let</span> <span class="hljs-variable">g:phpactorOmniError</span> = <span class="hljs-variable">v:true</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">autocmd</span> BufEnter * <span class="hljs-keyword">call</span> ncm2#enable_for_buffer()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">set</span> completeopt=noinsert,menuone,noselect</td></tr></table></code></pre><h2 id="general-config">General config</h2><p>This is a set of standard settings for the general behaviour of the application, such as setting the colorscheme and default indentation levels. I also routinely disable the mouse because it bugs me.</p><pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">"General</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">syntax</span> <span class="hljs-keyword">on</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">colorscheme</span> jellybeans</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">set</span> <span class="hljs-keyword">nu</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">filetype</span> plugin <span class="hljs-built_in">indent</span> <span class="hljs-keyword">on</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">set</span> nocp</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">set</span> ruler</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">set</span> wildmenu</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">set</span> mouse-=<span class="hljs-keyword">a</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">set</span> t_Co=<span class="hljs-number">256</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-comment">"Code folding</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">set</span> foldmethod=manual</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-comment">"Tabs and spacing</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-keyword">set</span> autoindent</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-keyword">set</span> <span class="hljs-built_in">cindent</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-keyword">set</span> tabstop=<span class="hljs-number">4</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-keyword">set</span> expandtab</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-keyword">set</span> <span class="hljs-built_in">shiftwidth</span>=<span class="hljs-number">4</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td><span class="hljs-keyword">set</span> smarttab</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-comment">"Search</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-keyword">set</span> hlsearch</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td><span class="hljs-keyword">set</span> incsearch</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td><span class="hljs-keyword">set</span> ignorecase</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-keyword">set</span> smartcase</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td><span class="hljs-keyword">set</span> diffopt +=iwhite</td></tr></table></code></pre><h2 id="markdown-configuration">Markdown configuration</h2><p>This section sets the file type for Markdown. It disables the Markdown plugin included in <code>vim-polyglot</code> as I had problems with it, and sets the languages that will be highlighted in fenced code blocks. I may at some point migrate this to the filetype repository.</p><pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">"Syntax highlighting in Markdown</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">au</span> BufNewFile,BufReadPost *.md <span class="hljs-keyword">set</span> <span class="hljs-keyword">filetype</span>=markdown</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">let</span> <span class="hljs-variable">g:polyglot_disabled</span> = [<span class="hljs-string">'markdown'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">let</span> <span class="hljs-variable">g:markdown_fenced_languages</span> = [<span class="hljs-string">'bash=sh'</span>, <span class="hljs-string">'css'</span>, <span class="hljs-string">'django'</span>, <span class="hljs-string">'javascript'</span>, <span class="hljs-string">'js=javascript'</span>, <span class="hljs-string">'json=javascript'</span>, <span class="hljs-string">'perl'</span>, <span class="hljs-string">'php'</span>, <span class="hljs-string">'python'</span>, <span class="hljs-string">'ruby'</span>, <span class="hljs-string">'sass'</span>, <span class="hljs-string">'xml'</span>, <span class="hljs-string">'html'</span>, <span class="hljs-string">'vim'</span>]</td></tr></table></code></pre><h2 id="neomake">Neomake</h2><p>I used to use Syntastic for checking my code for errors, but I’ve always found it problematic - it was slow and would often block the editor for some time. Neovim does have support for asynchronous jobs (as does Vim 8), but Syntastic doesn’t use it, so I decided to look elsewhere.</p><p>Neomake seemed a lot better, so I migrated over to it. It doesn’t require much configuration, and it’s really fast - unlike Syntastic, it supports asynchronous jobs. This part of the config sets it up to run on changes with no delay in writing, so I get near-instant feedback if a syntax error creeps in, and it doesn’t block the editor the way Syntastic used to.</p><pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">" Neomake config</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">" Full config: when writing or reading a buffer, and on changes in insert and</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">" normal mode (after 1s; no delay when writing).</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">call</span> neomake#configure#automake(<span class="hljs-string">'nrwi'</span>, <span class="hljs-number">500</span>)</td></tr></table></code></pre><h2 id="phpactor">PHPActor</h2><p>As mentioned above, PHPActor has dramatically improved my experience when coding in PHP by providing access to features normally found only in full IDE’s. Here’s the fairly standard config I use for the refactoring functionality:</p><pre><code class="hljs lang-vim"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">" PHPActor config</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">" Include use statement</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">u</span> :<span class="hljs-keyword">call</span> phpactor#UseAdd()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-comment">" Invoke the context menu</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span>mm :<span class="hljs-keyword">call</span> phpactor#ContextMenu()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-comment">" Invoke the navigation menu</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">nn</span> :<span class="hljs-keyword">call</span> phpactor#Navigate()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-comment">" Goto definition of class or class member under the cursor</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">o</span> :<span class="hljs-keyword">call</span> phpactor#GotoDefinition()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-comment">" Transform the classes in the current file</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span>tt :<span class="hljs-keyword">call</span> phpactor#Transform()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-comment">" Generate a new class (replacing the current file)</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">cc</span> :<span class="hljs-keyword">call</span> phpactor#ClassNew()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-comment">" Extract expression (normal mode)</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td><span class="hljs-keyword">nmap</span> <span class="hljs-symbol">&lt;silent&gt;</span><span class="hljs-symbol">&lt;Leader&gt;</span>ee :<span class="hljs-keyword">call</span> phpactor#ExtractExpression(<span class="hljs-variable">v:false</span>)<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-comment">" Extract expression from selection</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-keyword">vmap</span> <span class="hljs-symbol">&lt;silent&gt;</span><span class="hljs-symbol">&lt;Leader&gt;</span>ee :<span class="hljs-symbol">&lt;C-U&gt;</span><span class="hljs-keyword">call</span> phpactor#ExtractExpression(<span class="hljs-variable">v:true</span>)<span class="hljs-symbol">&lt;CR&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td><span class="hljs-comment">" Extract method from selection</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-keyword">vmap</span> <span class="hljs-symbol">&lt;silent&gt;</span><span class="hljs-symbol">&lt;Leader&gt;</span><span class="hljs-keyword">em</span> :<span class="hljs-symbol">&lt;C-U&gt;</span><span class="hljs-keyword">call</span> phpactor#ExtractMethod()<span class="hljs-symbol">&lt;CR&gt;</span></td></tr></table></code></pre><h2 id="summary">Summary</h2><p>Vim or Neovim configuration files are never static. Your needs are always changing, and you’re constantly discovering new plugins and new settings to try out, and keeping ones that prove useful. It’s been helpful to start over and ditch some plugins I no longer needed, pull in some new ones, and organise my configuration a bit better.</p><p>Now that I can set the dependencies in a text file rather than pulling them in as Git submodules, it makes more sense to keep my config in a <a href="https://gist.github.com/matthewbdaly/80b777ad3db885ebeecd27687fb121cd">Github Gist</a> rather than a Git repository, and that’s where I plan to retain it for now. Feel free to fork or cannibalize it for your own purposes if you wish.</p></article><article class="post"><p class="date">25th July 2018 10:25 pm</p><h1><a href="/blog/2018/07/25/better-strings-in-php/">Better Strings in PHP</a></h1><p>One of the weaknesses of PHP as a programming language is the limitations of some of the fundamental types. For instance, a string in PHP is a simple value, rather than an object, and doesn’t have any methods associated with it. Instead, to manipulate a string, you have to call all manner of functions. By comparison, in Python, not only can you call methods on a string, and receive a new string as the response, making them easily chainable, but you can also iterate through a string, as in this example:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span>a = <span class="hljs-string">'foo'</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span>a.upper()</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-string">'FOO'</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span>a.lower()</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-string">'foo'</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> letter <span class="hljs-keyword">in</span> a:</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-meta">... </span>  print(letter)</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-meta">... </span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>f</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>o</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>o</td></tr></table></code></pre><p>A little while back, I read Adam Wathan’s excellent book <em>Refactoring to Collections</em>, which describes how you can use a collection implementation (such as the one included with Laravel) to replace convoluted array manipulation with simpler, chainable calls to a collection object. Using this approach, you can turn something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$result = array_filter(</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    array_map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }, $items),</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;bar == <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>});</td></tr></table></code></pre><p>Or, even worse, this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$result1 = array_map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">return</span> $item-&gt;get(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>}, $items);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>$result2 = array_filter($result1, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">return</span> $item-&gt;bar == <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>});</td></tr></table></code></pre><p>Into this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$result = Collection::make($items)</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    -&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    })-&gt;filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;bar == <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    })-&gt;toArray();</td></tr></table></code></pre><p>Much cleaner, more elegant, and far easier to understand.</p><p>A while back, after some frustration with PHP’s native strings, I started wondering how practical it would be to produce a string implementation that was more like the string objects in languages like Python and Javascript, with inspiration from collection implementations such as that used by Laravel. I soon discovered that it was very practical, and with a bit of work it’s not hard to produce your own, more elegant string class.</p><p>The most fundamental functionality required is to be able to create a string object, either by passing a string to the constructor or calling a static method. Our string class should be able to do both:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">protected</span> $string;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(string $string = <span class="hljs-string">''</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">$this</span>-&gt;string = $string;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make</span><span class="hljs-params">(string $string)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>($string);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><h2 id="making-it-iterable">Making it iterable</h2><p>To be able to get the length of a string, it needs to implement the <a href="http://php.net/manual/en/class.countable.php"><code>Countable</code></a> interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Countable</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Countable</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">count</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">return</span> strlen(<span class="hljs-keyword">$this</span>-&gt;string);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr></table></code></pre><p>To access it as an array, it needs to implement the <a href="http://php.net/manual/en/class.arrayaccess.php"><code>ArrayAccess</code></a> interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>...</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ArrayAccess</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Countable</span>, <span class="hljs-title">ArrayAccess</span></span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetExists</span><span class="hljs-params">($offset)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;string[$offset]);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetGet</span><span class="hljs-params">($offset)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;string[$offset]) ? <span class="hljs-keyword">$this</span>-&gt;string[$offset] : <span class="hljs-keyword">null</span>;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetSet</span><span class="hljs-params">($offset, $value)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> (is_null($offset)) {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">$this</span>-&gt;string[] = $value;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        } <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-keyword">$this</span>-&gt;string[$offset] = $value;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetUnset</span><span class="hljs-params">($offset)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">$this</span>-&gt;string = substr_replace(<span class="hljs-keyword">$this</span>-&gt;string, <span class="hljs-string">''</span>, $offset, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>And to make it iterable, it needs to implement the <a href="http://php.net/manual/en/class.iterator.php"><code>Iterator</code></a> interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Iterator</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Str</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Countable</span>, <span class="hljs-title">ArrayAccess</span>, <span class="hljs-title">Iterator</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">current</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;string[<span class="hljs-keyword">$this</span>-&gt;position];</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">key</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;position;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        ++<span class="hljs-keyword">$this</span>-&gt;position;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rewind</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;position = <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">valid</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;string[<span class="hljs-keyword">$this</span>-&gt;position]);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><h2 id="making-it-work-as-a-string">Making it work as a string</h2><p>To be useful, it also needs to be possible to actually use it as a string - for instance, you should be able to do this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$foo = Str::make(<span class="hljs-string">'I am the very model of a modern major general'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">echo</span> $foo;</td></tr></table></code></pre><p>Fortunately, the <a href="http://php.net/manual/en/language.oop5.magic.php#object.tostring"><code>__toString()</code></a> magic method allows this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;string;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr></table></code></pre><h2 id="adding-methods">Adding methods</h2><p>With that functionality in place, you can then start adding support for the methods you need in your string objects. If you’re looking to be able to use the same functionality as existing PHP methods, you can call those functions inside your methods. However, be sure to return a new instance of your string object from each method - that way, you can continually chain them:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replace</span><span class="hljs-params">($find, $replace)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(str_replace($find, $replace, <span class="hljs-keyword">$this</span>-&gt;string));</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toUpper</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(strtoupper(<span class="hljs-keyword">$this</span>-&gt;string));</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toLower</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(strtolower(<span class="hljs-keyword">$this</span>-&gt;string));</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trim</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(trim(<span class="hljs-keyword">$this</span>-&gt;string));</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ltrim</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(ltrim(<span class="hljs-keyword">$this</span>-&gt;string));</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rtrim</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>(rtrim(<span class="hljs-keyword">$this</span>-&gt;string));</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr></table></code></pre><p>Now, you can write something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">return</span> Str::make(<span class="hljs-string">'I am the very model of a modern major general  '</span>)</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    -&gt;trim()</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    -&gt;replace(<span class="hljs-string">'modern major general'</span>, <span class="hljs-string">'scientist Salarian'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    -&gt;toLower();</td></tr></table></code></pre><p>While you could do this with PHP’s native string functions alone, it would be a lot less elegant. In addition, if you have other, more complex string manipulations that you often do in a particular application, it may make sense to write a method for that so that your string objects can encapsulate that functionality for easier reuse.</p><p>As our string objects are iterable, we can also do this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&gt;&gt;&gt; $foo = Str::make(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>&gt;&gt;&gt; <span class="hljs-keyword">foreach</span> ($foo <span class="hljs-keyword">as</span> $letter) { <span class="hljs-keyword">echo</span> <span class="hljs-string">"$letter\n"</span>; }</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>f</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>o</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>o</td></tr></table></code></pre><p>If you have an application that does some complex string manipulation, having a string utility class like this can make for much more expressive, elegant and easy-to-comprehend code than PHP’s native string functions. If you want to see a working implementation for this, check out my proof of concept collection and string utility library <a href="https://github.com/matthewbdaly/proper">Proper</a>.</p></article><article class="post"><p class="date">23rd June 2018 1:03 pm</p><h1><a href="/blog/2018/06/23/forcing-ssl-in-codeigniter/">Forcing SSL in Codeigniter</a></h1><p>I haven’t started a new CodeIgniter project since 2014, and don’t intend to, but on occasion I’ve been asked to do maintenance work on legacy CodeIgniter projects. This week I was asked to help out with a situation where a CodeIgniter site was being migrated to HTTPS and there were issues resulting from the migration.</p><p>Back in 2012, when working on my first solo project, I’d built a website using CodeIgniter that used HTTPS, but also needed to support an affiliate marketing system that did not support it, so certain pages had to force HTTP, and others had to force HTTPS, so I’d used the hook system to create hooks to enforce this. This kind of requirement is unlikely to reoccur now because HTTPS is becoming more prevalent, but sometimes it may be easier to enforce HTTPS at application level than in the web server configuration or using htaccess. It’s relatively straightforward to do that in CodeIgniter.</p><p>The first step is to create the hook. Save this as <code>application/hooks/ssl.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">force_ssl</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    $CI =&amp; get_instance();</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    $CI-&gt;config-&gt;config[<span class="hljs-string">'base_url'</span>] = str_replace(<span class="hljs-string">'http://'</span>, <span class="hljs-string">'https://'</span>, $CI-&gt;config-&gt;config[<span class="hljs-string">'base_url'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">if</span> ($_SERVER[<span class="hljs-string">'SERVER_PORT'</span>] != <span class="hljs-number">443</span>) redirect($CI-&gt;uri-&gt;uri_string());</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-meta">?&gt;</span></td></tr></table></code></pre><p>Next, we register the hook. Update <code>application/configs/hooks.php</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span>  <span class="hljs-keyword">if</span> ( ! defined(<span class="hljs-string">'BASEPATH'</span>)) <span class="hljs-keyword">exit</span>(<span class="hljs-string">'No direct script access allowed'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">/*</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>| -------------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>| Hooks</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>| -------------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>| This file lets you define "hooks" to extend CI without hacking the core</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>| files.  Please see the user guide for info:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>|</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>|    http://codeigniter.com/user_guide/general/hooks.html</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>|</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>*/</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>$hook[<span class="hljs-string">'post_controller_constructor'</span>][] = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                                <span class="hljs-string">'function'</span> =&gt; <span class="hljs-string">'force_ssl'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                                <span class="hljs-string">'filename'</span> =&gt; <span class="hljs-string">'ssl.php'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                                <span class="hljs-string">'filepath'</span> =&gt; <span class="hljs-string">'hooks'</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                                );</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-comment">/* End of file hooks.php */</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-comment">/* Location: ./application/config/hooks.php */</span></td></tr></table></code></pre><p>This tells CodeIgniter that it should looks in the <code>application/hooks</code> directory for a file called <code>ssl.php</code>, and return the function <code>force_ssl</code>.</p><p>Finally, we enable hooks. Update <code>application/config/config.php</code>:</p><pre><code class="hljs lang-php singleline">$config[<span class="hljs-string">'enable_hooks'</span>] = <span class="hljs-keyword">TRUE</span>;</code></pre><p>If you only want to force SSL in production, not development, you may want to amend the <code>ssl.php</code> file to only perform the redirect in non-development environments, perhaps by using an environment variable via DotEnv.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></p><p><a href="/blog/2019/10/13/flexible-data-types-with-the-json-field/">Flexible Data Types With the JSON Field</a></p><p><a href="/blog/2019/09/22/storing-wordpress-configuration-in-environment-variables/">Storing Wordpress Configuration in Environment Variables</a></p><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/posts/5/">Newer</a></li><li class="page-item"><a class="page-link" href="/posts/7/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2020.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>