<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/6/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">10th March 2018 3:10 pm</p><h1><a href="/blog/2018/03/10/using-stored-procedures-in-your-web-app/">Using Stored Procedures in Your Web App</a></h1><p>In the last few days I’ve done something I’ve never done before, namely written a stored procedure for a web app. Like most web developers, I know enough about SQL to be able to formulate some fairly complex queries, but I hadn’t really touched on control flow functions or stored procedures, and in my experience they tend to be the province of the dedicated database administrator, not us web devs, who will typically delegate more complex functionality to our application code.</p><p>In this case, there were a number of factors influencing my decision to use a stored procedure for this:</p><ul><li>The application was a legacy application which had been worked on by developers of, shall we say, varying skill levels. As a result the database schema was badly designed, with no prospect of changing it without causing huge numbers of breakages</li><li>The query in question was used to generate a complex report that was quite time-consuming, therefore the optimisations from using a stored procedure were worthwhile.</li><li>The report required that data be grouped by a set of categories which were stored in a separate table, which meant the table had to be pivoted (transformed from rows to columns), resulting in an incredibly complex dynamic query that had to be constructed on the fly by concatenating different SQL strings. In PostgreSQL, this can be done fairly easily using the <code>crosstab</code> function, but MySQL doesn’t have native support for anything like this.</li></ul><p>Historically, one issue with using stored procedures has been that it kept business logic out of the application code, meaning they are not stored in version control. However, most modern frameworks provide some support for migrations, and since they are intended to be used to make changes to the database, they are the obvious place to define the stored procedure. This particular application was built with an older framework that didn’t come with migrations, so we’d installed <a href="https://phinx.org/">Phinx</a> to handle those for us. Initially, I defined the stored procedure inside a migration that ran a raw query to create the stored procedure, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   $query = <span class="hljs-string">&lt;&lt;&lt;EOF</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>CREATE PROCEDURE IF NOT EXISTS foo</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>BEGIN</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>   SELECT * FROM foo;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>END</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>EOF;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">$this</span>-&gt;execute($query);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>   <span class="hljs-keyword">$this</span>-&gt;execute(<span class="hljs-string">'DROP PROCEDURE IF EXISTS foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>Once this is done, you can then use your framework’s particular support for raw queries to call <code>CALL foo()</code> whenever your stored procedure needs to be executed.</p><p>However, we soon ran into an issue. It turns out <code>mysqldump</code> doesn’t export stored procedures by default, so there was a risk that anyone working on the code base might import the database from an SQL file and not get the migrations. I’d used the Symfony Console component to create a simple command-line tool, reminiscent of Laravel’s Artisan, so I used that to create a command to set up the stored procedure, amended the migration to call that command, and placed a check in the application where the procedure was called so that if it was not defined the command would be called and the procedure would be created. In most cases this wouldn’t be an issue.</p><p>Having now had experience using stored procedures in a web application, there are a number of issues they raise:</p><ul><li>It’s hard to make queries flexible, whereas with something like Eloquent it’s straightforward to conditionally apply <code>WHERE</code> statements.</li><li>While storing them in migrations is a practical solution, if the database is likely to be imported rather than created from scratch during development it can be problematic.</li><li>They aren’t easily portable, not just between database management systems, but between different versions - the production server was using an older version of MySQL, and it failed to create the procedure. It’s therefore good practice for your migrations to check the procedure was created successfully and raise a noisy exception if they failed.</li></ul><p>Conversely, they do bring certain benefits:</p><ul><li>For particularly complex transactions that don’t change, such as generating reports, they are a good fit since they reduce the amount of data that needs to be sent to the database and allow the query to be pre-optimised somewhat.</li><li>If a particular query is unusually expensive, is called often, and can’t be cached, it may improve performance to make it a stored procedure.</li><li>Doing a query in a for loop is usually a very big no-no. However, if there really is no way to avoid it (and this should almost never happen), it would make sense to try to do it in a stored procedure using SQL rather than in application code since that would minimise the overhead.</li><li>If multiple applications need to work with the same database, using stored procedures for queries in more than one application removes the need to reimplement or copy over the code for the query in the second application - they can just call the same procedure, and if it needs to be changed it need only be done once.</li></ul><p>Honestly, I’m not sure I’m ever likely to again come across a scenario where using a stored procedure in a web application would be beneficial, but it’s been very interesting delving into aspects of SQL that I don’t normally touch on and I’ve picked up on some rarely-used SQL statements that I haven’t used before, such as <code>GROUP_CONCAT()</code> and <code>CASE</code>. With the widespread adoption of migrations in most frameworks, I think that the argument that using stored procedures keeps application logic out of version control no longer holds any water, since developers can generally be trusted to store changes to database structure in their migrations and not start messing them around, so the same applies for stored procedures. Report generation seems to be the ideal use case since this invariably involves complex queries that run regularly and don’t change often, and this is where I expect it would be most likely I’d have cause to use them again.</p></article><article class="post"><p class="date">25th February 2018 5:22 pm</p><h1><a href="/blog/2018/02/25/check-your-code-base-is-php-7-ready-with-php-compatibility/">Check Your Code Base Is PHP 7 Ready With PHP Compatibility</a></h1><p>I’ve recently started a new job and as part of that I’m working on a rather substantial legacy code base. In fact, it was so legacy that it was still in Subversion - needless to say the very first thing I did was migrate it to Git. One of the jobs on our radar for this code base is to migrate it to from PHP 5.4 to 5.6, and subsequently to PHP 7. I’ve been using it locally in 5.6 without issue so far, but I’ve also been looking around for an automated tool to help catch potential problems.</p><p>I recently discovered <a href="https://github.com/wimg/PHPCompatibility">PHP Compatibility</a> which is a set of sniffs for PHP CodeSniffer that can be used to detect code that will be problematic in a particular PHP version. As I use CodeSniffer extensively already, it’s a good fit for my existing toolset.</p><p>To install it, add the following dependencies to your <code>composer.json</code>:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "require-dev": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "dealerdirect/phpcodesniffer-composer-installer": "^0.4.3",</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        "squizlabs/php_codesniffer": "^2.5",</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        "wimg/php-compatibility": "^8.1"</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    },</td></tr></table></code></pre><p>Then update your <code>phpcs.xml</code> to look something like this:</p><pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>The coding standard for my app.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>./<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PHPCompatibility"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">config</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"testVersion"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7.2-"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></tr></table></code></pre><p>As you can see, it’s possible to use it alongside existing coding standards such as PSR2. Note the <code>testVersion</code> config key - the value specified is the PHP version we’re testing against. Here we’re specifying PHP 7.2.</p><p>Obviously, the very best way to guard against breakages in newer versions of PHP is to have a comprehensive test suite, but legacy code bases by definition tend to have little or no tests. By using PHP Compatibility, you should at least be able to catch syntax problems without having to audit the code base manually.</p></article><article class="post"><p class="date">25th February 2018 3:50 pm</p><h1><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers</a></h1><p>In <a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">my previous post</a> I mentioned some strategies for refactoring Laravel controllers to move unnecessary functionality elsewhere. However, I didn’t cover testing them. In this post I will demonstrate the methodology I use for testing Laravel controllers.</p><p>Say we have the following method in a controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $document = <span class="hljs-keyword">new</span> Document($request-&gt;only([</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'title'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'text'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ]));</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $document-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        event(<span class="hljs-keyword">new</span> DocumentCreated($document));</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> redirect()-&gt;route(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><p>This controller method does three things:</p><ul><li>Return a response</li><li>Create a model instance</li><li>Fire an event</li></ul><p>Our tests therefore need to pass it all its external dependencies and check it carries out the required actions.</p><p>First we fake the event facade:</p><pre><code class="hljs lang-php singleline">    Event::fake();</code></pre><p>Next, we create an instance of <code>Illuminate\Http\Request</code> to represent the HTTP request passed to the controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $request = Request::create(<span class="hljs-string">'/store'</span>, <span class="hljs-string">'POST'</span>,[</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'title'</span>     =&gt;     <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'text'</span>     =&gt;     <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    ]);</td></tr></table></code></pre><p>If you’re using a custom form request class, you should instantiate that in exactly the same way.</p><p>Then, instantiate the controller, and call the method, passing it the request object:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $controller = <span class="hljs-keyword">new</span> MyController();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    $response = $controller-&gt;store($request);</td></tr></table></code></pre><p>You can then test the response from the controller. You can test the status code like this:</p><pre><code class="hljs lang-php singleline">    <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">302</span>, $response-&gt;getStatusCode());</code></pre><p>You may also need to check the content of the response matches what you expect to see, by retrieving <code>$response-&gt;getBody()-&gt;getContent()</code>.</p><p>Next, retrieve the newly created model instance, and verify it exists:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $document = Document::where(<span class="hljs-string">'title'</span>, <span class="hljs-string">'foo'</span>)-&gt;first();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">$this</span>-&gt;assertNotNull($document);</td></tr></table></code></pre><p>You can also use <code>assertEquals()</code> to check the attributes on the model if appropriate. Finally, you check the event was fired:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    Event::assertDispatched(DocumentCreated::class, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($event)</span> <span class="hljs-title">use</span> <span class="hljs-params">($document)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-keyword">return</span> $event-&gt;document-&gt;id === $document-&gt;id; </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    });</td></tr></table></code></pre><p>This test should not concern itself with any functionality triggered by the event, only that the event gets triggered. The event should have separate unit tests in which the event is triggered, and then the test verifies it carried out the required actions.</p><p>Technically, these don’t quite qualify as being unit tests because they hit the database, but they should cover the controller adequately. To make them true unit tests, you’d need to implement the repository pattern for the database queries rather than using Eloquent directly, and mock the repository, so you can assert that the mocked repository receive the right data and have it return the expected response.</p><p>Here is how you might do that with Mockery:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$mock = Mockery::mock(<span class="hljs-string">'App\Contracts\Repositories\Document'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$mock-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'title'</span>    =&gt;        <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'text'</span>    =&gt;        <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>])-&gt;once()-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>$controller = <span class="hljs-keyword">new</span> MyController($mock);</td></tr></table></code></pre><p>As long as your controllers are kept as small as possible, it’s generally not too hard to test them. Unfortunately, fat controllers become almost impossible to test, which is another good reason to avoid them.</p></article><article class="post"><p class="date">18th February 2018 6:10 pm</p><h1><a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">Put Your Laravel Controllers on a Diet</a></h1><p>MVC frameworks are a tremendously useful tool for modern web development. They offer easy ways to carry out common tasks, and enforce a certain amount of structure on a project.</p><p>However, that doesn’t mean using them makes you immune to bad practices, and it’s quite easy to wind up falling into certain anti-patterns. Probably the most common is the Fat Controller.</p><h2 id="what-is-a-fat-controller-">What is a fat controller?</h2><p>When I first started out doing professional web development, CodeIgniter 2 was the first MVC framework I used. While I hadn’t used it before, I was familiar with the general concept of MVC. However, I didn’t appreciate that when referring to the model layer as a place for business logic, that wasn’t necessarily the same thing as the database models.</p><p>As such, my controllers became a dumping ground for anything that didn’t fit into the models. If it didn’t interact with the database, I put it in the controller. They quickly became bloated, with many methods running to hundreds of lines of code. The code base became hard to understand, and when I was under the gun on projects I found myself copying and pasting functionality between controllers, making the situation even worse. Not having an experienced senior developer on hand to offer criticism and advice, it was a long time before I realised that this was a problem or how to avoid it.</p><h2 id="why-are-fat-controllers-bad-">Why are fat controllers bad?</h2><p>Controllers are meant to be simple glue code that receives requests and returns responses. Anything else should be handed off to the model layer. As noted above, however, that’s not the same as putting it in the models. Your model layer can consist of many different classes, not just your Eloquent models, and you should not fall into the trap of thinking your application should consist of little more than models, views and controllers.</p><p>Placing business logic in controllers can be bad for many reasons:</p><ul><li>Code in controllers can be difficult to write automated tests for</li><li>Any logic in a controller method may need to be repeated elsewhere if the same functionality is needed for a different route, unless it’s in a private or protected method that is called from elsewhere, in which case it’s very hard to test in isolation</li><li>Placing it in the controller makes it difficult to pull out and re-use on a different project</li><li>Making your controller methods too large makes them complex and hard to follow</li></ul><p>As a general rule of thumb, I find that 10 lines of code for any one method for a controller is where it starts getting a bit much. That said, it’s not a hard and fast rule, and for very small projects it may not be worthwhile. But if a project is large and needs to be maintained for any reasonable period of time, you should take the trouble to ensure your controllers are as skinny as is practical.</p><p>Nowadays Laravel is my go-to framework and I’ve put together a number of strategies for avoiding the fat controller anti-pattern. Here’s some examples of how I would move various parts of the application out of my controllers.</p><h2 id="validation">Validation</h2><p>Laravel has a nice, easy way of getting validation out of the controllers. Just create a custom <a href="https://laravel.com/docs/5.6/validation#form-request-validation">form request</a> for your input data, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">FormRequest</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FormRequest</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Determine if the user is authorized to make this request.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> bool</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorize</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Get the validation rules that apply to the request.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> array</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'required|email'</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Then type-hint the form request in the controller method, instead of <code>Illuminate\Http\Request</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>\<span class="hljs-title">CreateRequest</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(CreateRequest $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-comment">// Process request here..</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>}</td></tr></table></code></pre><h2 id="database-access-and-caching">Database access and caching</h2><p>For non-trivial applications I normally use <a href="/blog/2017/03/01/decorating-laravel-repositories/">decorated repositories</a> to handle caching and database access in one place. That way my caching and database layers are abstracted out into separate classes, and caching is nearly always handled seamlessly without having to do much work.</p><h2 id="complex-object-creation-logic">Complex object creation logic</h2><p>If I have a form or API endpoint that needs to:</p><ul><li>Create more than one object</li><li>Transform the incoming data in some way</li><li>Or is non-trivial in any other way</li></ul><p>I will typically pull it out into a separate persister class. First, you should create an interface for this persister class:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Persisters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Foo</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Create a new Model</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * Update the given Model</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * <span class="hljs-doctag">@param</span> Model $model</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(array $data, Model $model)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Then create the persister class itself:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Persisters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Foo</span> <span class="hljs-title">as</span> <span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Persisters</span>\<span class="hljs-title">Foo</span> <span class="hljs-title">as</span> <span class="hljs-title">FooContract</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">DatabaseManager</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Carbon</span>\<span class="hljs-title">Carbon</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FooContract</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $db;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DatabaseManager $db, Repository $repository)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db = $db;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Create a new Model</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;beginTransaction();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $model = <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>             <span class="hljs-string">'date'</span> =&gt; Carbon::parse($data[<span class="hljs-string">'date'</span>])-&gt;toDayDateTimeString(),</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;commit();</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">return</span> $model;</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     * Update the given Model</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * <span class="hljs-doctag">@param</span> Model $model</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(array $data, Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;beginTransaction();</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $updatedmodel = <span class="hljs-keyword">$this</span>-&gt;repository-&gt;update([</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>             <span class="hljs-string">'date'</span> =&gt; Carbon::parse($data[<span class="hljs-string">'date'</span>])-&gt;toDayDateTimeString(),</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>             $model</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;commit();</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-keyword">return</span> $updatedmodel;</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>}</td></tr></table></code></pre><p>Then you can set up the persister in a service provider so that type-hinting the interface returns the persister:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind(</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'App\Contracts\Persisters\Foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-string">'App\Persisters\Foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>       });</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>}</td></tr></table></code></pre><p>This approach means that complex logic, such as creating multiple related objects, can be handled in a consistent way, even if it needs to be called from multiple places.</p><h2 id="triggering-actions-as-a-result-of-something">Triggering actions as a result of something</h2><p><a href="https://laravel.com/docs/5.6/events">Events</a> are tailor-made for this use case, and Laravel documents them very well, so I won’t repeat it here. Suffice to say, if something needs to happen, but the response sent by the application doesn’t necessarily depend on it returning something immediately, then it’s probably worth considering making it an event. If it’s going to be called from multiple places, it’s even more worthwhile.</p><p>For instance, if you have a contact form, it’s worth taking the time to create an event for when a new contact is received, and handle proessing the contact within the listener for that event. Also, doing so means you can queue that event and have it handled outside the context of the application, so that it responds to the user more quickly. If you’re sending an acknowledgement email for a new user registration, you don’t need to wait for that email to be sent before you return the response, so queueing it can improve response times.</p><h2 id="interacting-with-third-party-services">Interacting with third-party services</h2><p>If you have some code that needs to interact with a third-party service or API, it can get quite complex, especially if you need to process the content in some way. It therefore makes sense to pull that functionality out into a separate class.</p><p>For instance, say you have some code in your controller that uses an HTTP client to fetch some data from a third-party API and display it in the view:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   $data = <span class="hljs-keyword">$this</span>-&gt;client-&gt;get(<span class="hljs-string">'http://api.com/api/items'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   $items = [];</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> $k =&gt; $v) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>         $item = [</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>           <span class="hljs-string">'name'</span> =&gt; $v[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>              <span class="hljs-string">'description'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'description'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>              <span class="hljs-string">'tags'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'tags'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>         ];</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>         $items[] = $item;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   <span class="hljs-keyword">return</span> view(<span class="hljs-string">'template'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>       <span class="hljs-string">'items'</span> =&gt; $items</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>   ]);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>This is a very small example (and a lot simpler than most real-world instances of this issue), but it illustrates the principle. Not only does this code bloat the controller, it might also be used elsewhere in the application, and we don’t want to copy and paste it elsewhere - therefore it makes sense to extract it to a service class.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-title">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">ClientInterface</span> <span class="hljs-title">as</span> <span class="hljs-title">GuzzleClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Api</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">protected</span> $client;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(GuzzleClient $client)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>   {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      <span class="hljs-keyword">$this</span>-&gt;client = $client;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      $data = <span class="hljs-keyword">$this</span>-&gt;client-&gt;get(<span class="hljs-string">'http://api.com/api/items'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      $items = [];</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      <span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> $k =&gt; $v) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>         $item = [</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-string">'name'</span> =&gt; $v[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-string">'description'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'description'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-string">'tags'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'tags'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>         ];</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         $items[] = $item;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>      <span class="hljs-keyword">return</span> $items;</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Our controller can then type-hint the service and refactor that functionality out of the method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(App\Services\Api $api)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">$this</span>-&gt;api = $api;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>   $items = <span class="hljs-keyword">$this</span>-&gt;api-&gt;fetch();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">return</span> view(<span class="hljs-string">'template'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>       <span class="hljs-string">'items'</span> =&gt; $items</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>   ]);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><h2 id="including-common-variables-in-the-view">Including common variables in the view</h2><p>If data is needed in more than one view (eg show the user’s name on every page when logged in), consider using <a href="https://laravel.com/docs/5.6/views#view-composers">view composers</a> to retrieve this data rather than fetching them in the controller. That way you’re not having to repeat that logic in more than one place.</p><h2 id="formatting-content-for-display">Formatting content for display</h2><p>Logically this belongs in the view layer, so you should <a href="/blog/2018/01/09/creating-laravel-helpers/">write a helper</a> to handle things like formatting dates. For more complex stuff, such as formatting HTML, you should be doing this in Blade (or another templating system, if you’re using one) - for instance, when generating an HTML table, you should consider <a href="https://laravel.com/docs/5.6/blade#rendering-views-for-collections">using a view partial</a> to loop through them. For particularly tricky functionality, you have the option of <a href="https://laravel.com/docs/5.6/blade#extending-blade">writing a custom Blade directive</a>.</p><p>The same applies for rendering other content - for rendering JSON you should consider using <a href="https://laravel.com/docs/5.6/eloquent-resources">API resources</a> or <a href="https://fractal.thephpleague.com/">Fractal</a> to get any non-trivial logic for your API responses out of the controller. Blade templates can also work for non-HTML content such as XML.</p><h2 id="anything-else-">Anything else…</h2><p>These examples are largely to get you started, and there will be occasions where something doesn’t fall into any of the above categories. However, the same principle applies. Your controllers should stick to just receiving requests and sending responses, and anything else should normally be deferred to other classes.</p><p>Fat controllers make developer’s lives very difficult, and if you want your code base to be easily maintainable, you should be willing to refactor them ruthlessly. Any functionality you can pull out of the controller becomes easier to reuse and test, and as long as you name your classes and methods sensibly, they’re easier to understand.</p></article><article class="post"><p class="date">4th February 2018 12:12 am</p><h1><a href="/blog/2018/02/04/using-lando-as-an-alternative-to-vagrant/">Using Lando As An Alternative to Vagrant</a></h1><p>Although Vagrant is very useful for ensuring consistency between development environments, it’s quite demanding on system resources. Running a virtual machine introduces quite a bit of overhead, and it can be troublesome to provision.</p><p>This week I was introduced to <a href="https://docs.devwithlando.io/">Lando</a> as an alternative to Vagrant. Rather than running a virtual machine like Vagrant does by default, Lando instead spins up Docker containers for the services you need, meaning it has considerably less overhead than Vagrant. It also includes presets for a number of frameworks and CMS’s, including:</p><ul><li>Drupal 7</li><li>Drupal 8</li><li>Wordpress</li><li>Laravel</li></ul><p>Considering that Vagrant needs quite a bit of boilerplate to set up the server for different types of projects, this gives Lando an obvious advantage. The only issue I’ve had with it is that it’s been unreliable when I’ve had to use it on Windows, which I don’t do much anyway.</p><h2 id="getting-started">Getting started</h2><p>Lando requires that you have Docker installed. Once that’s done you can download and install it fro the website. Then you can run <code>lando init</code> to set it up:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ lando init</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>? What recipe <span class="hljs-keyword">do</span> you want to use? wordpress</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>? Where is your webroot relative to the init destination? .</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>? What <span class="hljs-keyword">do</span> you want to call this app? wp-site</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>NOW WE<span class="hljs-string">'RE COOKING WITH FIRE!!!</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Your app has been initialized!</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Go to the directory where your app was initialized and run</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>`lando start` to get rolling.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>Check the LOCATION printed below if you are unsure where to go.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Here are some vitals:</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td> NAME      wp-site                                               </td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td> LOCATION  /home/matthew/Projects/wp-site                        </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td> RECIPE    wordpress                                             </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td> DOCS      https://docs.devwithlando.io/tutorials/wordpress.html </td></tr></table></code></pre><p>Here I’ve chosen the <code>wordpress</code> recipe, in the current directory, with the name <code>wp-site</code>. This generates the following file as <code>.lando.yml</code>:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-symbol">name:</span> wp-site</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-symbol">recipe:</span> wordpress</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-symbol">config:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-symbol">  webroot:</span> .</td></tr></table></code></pre><p>Then, if we run <code>lando start</code>, it will set up the required services:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ lando start</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>landoproxyhyperion5000gandalfedition_proxy_1 is up-to-date</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Creating network <span class="hljs-string">"wpsite_default"</span> with the default driver</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Creating volume <span class="hljs-string">"wpsite_appserver"</span> with default driver</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Creating volume <span class="hljs-string">"wpsite_data"</span> with default driver</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Creating volume <span class="hljs-string">"wpsite_data_database"</span> with default driver</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Creating wpsite_appserver_1 ... </td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Creating wpsite_database_1 ... </td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Creating wpsite_database_1</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>Creating wpsite_appserver_1 ... <span class="hljs-keyword">done</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                                 Dload  Upload   Total   Spent    Left  Speed</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>100 4454k  100 4454k    0     0  3288k      0  0:00:01  0:00:01 --:--:-- 3290k</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>OS:     Linux 4.13.0-32-generic <span class="hljs-comment">#35-Ubuntu SMP Thu Jan 25 09:13:46 UTC 2018 x86_64</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Shell:  </td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>PHP binary:     /usr/<span class="hljs-built_in">local</span>/bin/php</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>PHP version:    7.1.13</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>php.ini used:   </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>WP-CLI root dir:        phar://wp-cli.phar</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>WP-CLI vendor dir:      phar://wp-cli.phar/vendor</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>WP_CLI phar path:       /tmp</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>WP-CLI packages dir:</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>WP-CLI global config:   </td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>WP-CLI project config:  </td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>WP-CLI version: 1.5.0</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>BOOMSHAKALAKA!!!</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>Your app has started up correctly.</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Here are some vitals:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td> APPSERVER URLS  https://localhost:32802</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>                 http://localhost:32803</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                 http://wp-site.lndo.site</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>                 https://wp-site.lndo.site</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr></table></code></pre><p>Note the <code>APPSERVER URLS</code> section - the site can be accessed locally via HTTP or HTTPS. For this recipe, it also installs WP CLI.</p><p>If we run <code>docker ps</code>, we can see that it’s running three Docker containers:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                                                               NAMES</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>2e920e152091        devwithlando/php:7.1-apache   <span class="hljs-string">"/lando-entrypoint.s…"</span>   16 minutes ago      Up 16 minutes       0.0.0.0:32803-&gt;80/tcp, 0.0.0.0:32802-&gt;443/tcp                       wpsite_appserver_1</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>82ea60b1214f        mysql:latest                  <span class="hljs-string">"/lando-entrypoint.s…"</span>   16 minutes ago      Up 16 minutes       0.0.0.0:32801-&gt;3306/tcp                                             wpsite_database_1</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>e51d831199d7        traefik:1.3-alpine            <span class="hljs-string">"/lando-entrypoint.s…"</span>   About an hour ago   Up About an hour    0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:58086-&gt;8080/tcp   landoproxyhyperion5000gandalfedition_proxy_1</td></tr></table></code></pre><p>Apache lives in one container, MySQL in another, while the third runs Traefik, a lightweight load balancer, which listens on port 80. Traefik does the work of redirecting HTTP requests to the right place.</p><p>As I’ve been unhappy with the amount of resources Vagrant uses for a while, and I usually run Ubuntu (making using Docker straightforward), I’m planning on using Lando extensively in future. It’s lighter and faster to set up, and has sane defaults for most of the frameworks and CMS’s I use regularly, making it generally quicker and easier to work with.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/02/02/creating-your-own-dependency-injection-container-in-php/">Creating Your Own Dependency Injection Container in PHP</a></p><p><a href="/blog/2019/01/27/understanding-query-objects/">Understanding Query Objects</a></p><p><a href="/blog/2019/01/13/writing-a-custom-sniff-for-php-codesniffer/">Writing a Custom Sniff for PHP Codesniffer</a></p><p><a href="/blog/2019/01/03/you-dont-need-that-module-package/">You Don&#x27;t Need That Module Package</a></p><p><a href="/blog/2019/01/02/why-bad-code-is-bad/">Why Bad Code Is Bad</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/5/">Newer</a></li><li class="page-item"><a href="/posts/7/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>