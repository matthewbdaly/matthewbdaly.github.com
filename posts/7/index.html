<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/7/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">16th November 2017 3:15 pm</p><h1><a href="/blog/2017/11/16/creating-custom-assertions-with-phpunit/">Creating Custom Assertions With Phpunit</a></h1><p>Today I’ve been working on a library I’m building for making it easier to build RESTful API’s with Laravel. It uses an abstract RESTful controller, which inherits from the default Laravel controller, and I wanted to verify that the instantiated controller includes all the traits from the base controller.</p><p>However, there was a problem. The only practical way to verify that a class includes a trait is with the <code>class_uses()</code> function, but this doesn’t work if the class inherits from a parent that includes these traits. As the class is abstract, it can’t be instantiated directly, so you must either create a dummy class just for testing that extends it, or mock the class, and that means that <code>class_uses()</code> won’t work. As a result, I needed to first get the parent class, then call <code>class_uses()</code> on that, which is possible, but a bit verbose to do repeatedly for several tests.</p><p>Fortunately it’s quite easy to create your own custom assertions in PHPUnit. I started out by setting up the test with the assertion I wanted to have:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RestfulControllerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testTraits</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        $controller = m::mock(<span class="hljs-string">'Matthewbdaly\Harmony\Http\Controllers\RestfulController'</span>)-&gt;makePartial();</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertParentHasTrait(<span class="hljs-string">'Illuminate\Foundation\Bus\DispatchesJobs'</span>, $controller);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertParentHasTrait(<span class="hljs-string">'Illuminate\Foundation\Validation\ValidatesRequests'</span>, $controller);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertParentHasTrait(<span class="hljs-string">'Illuminate\Foundation\Auth\Access\AuthorizesRequests'</span>, $controller);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>Actually implementing the assertion is fairly straightforward. You simply add the assertion as a method on the base test case you’re using. and accept whatever arguments are required, plus a final argument of <code>$message = &#39;&#39;</code>. Then you call <code>self::assertThat()</code>, as demonstrated below:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assertParentHasTrait</span><span class="hljs-params">($trait, $class, $message = <span class="hljs-string">''</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $parent = get_parent_class($class);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        $traits = class_uses($parent);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">self</span>::assertThat(in_array($trait, $traits), <span class="hljs-keyword">self</span>::isTrue(), $message);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></tr></table></code></pre><p>In this case we’re asserting that the specified trait appears in the list of traits on the parent class. Note the use of <code>self::isTrue()</code> - this just verifies that the response is truthy.</p><p>Using this method it’s quite easy to create custom assertions, which can help make your tests less verbose and easier to read.</p></article><article class="post"><p class="date">6th November 2017 12:00 pm</p><h1><a href="/blog/2017/11/06/catching-debug-statements-in-php/">Catching Debug Statements in PHP</a></h1><p>It’s unfortunately quite easy to neglect to remove debugging statements in PHP code. I’ve done so many times myself, and it’s not unknown for these to wind up in production. After I saw it happen again recently, I decided to look around for a way to prevent it happening.</p><p><a href="/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/">As mentioned earlier</a>, I generally use PHP CodeSniffer to enforce a coding standard on my projects, and it’s easy to set it up and run it. With a little work, you can also use it to catch these unwanted debugging statements before they get committed.</p><p>First, you need to make sure <code>squizlabs/php_codesniffer</code> is included in your project’s development dependencies in <code>composer.json</code>. Then, create a <code>phpcs.xml</code> file that looks something like this:</p><pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Coding standard.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>src<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.Commenting.FunctionComment"</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.Commenting.FunctionCommentThrowTag"</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.Commenting.ClassComment"</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Squiz.PHP.ForbiddenFunctions"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"forbiddenFunctions"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"array"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"eval=&gt;NULL,dd=&gt;NULL,die=&gt;NULL,var_dump=&gt;NULL,sizeof=&gt;count,delete=&gt;unset,print=&gt;echo,create_function=&gt;NULL"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></tr></table></code></pre><p>The key is the rule <code>Squiz.PHP.ForbiddenFunctions</code>. This allows us to define a list of functions that are forbidden in our project. Typically this will be things like <code>die()</code>, <code>eval()</code>, <code>var_dump()</code> and <code>dd()</code>.</p><p>Now, this ruleset will catch the unwanted functions (as well as enforcing PSR2 and certain rules about comments), but we can’t guarantee that we’ll always remember to run it. We could run CodeSniffer in continuous integration (and this is a good idea anyway), but that doesn’t stop us from committing code with those forbidden functions. We need a way to ensure that CodeSniffer runs on every commit and doesn’t allow it to go ahead if it fails. To do that we can use a pre-commit hook. Save the following in your repository as <code>.git/hooks/pre-commit</code>:</p><pre><code class="hljs lang-bash singleline">vendor/bin/phpcs</code></pre><p>Then run the following command to make it executable:</p><pre><code class="hljs lang-bash singleline">$ chmod +x .git/hooks/pre-commit</code></pre><p>A pre-commit hook is run before every commit, and if it returns false, will not allow the commit to go ahead. That means that if CodeSniffer fails for any reason, we will have to go back and fix the problem before we can commit. If for some reason you do need to bypass this check, you can still do so by using the <code>--no-verify</code> flag with <code>git commit</code>.</p><p>The advantage of this method is that it’s not dependent on any one IDE or editor, so it’s widely applicable. However, if you’re doing this sort of thing with Git hooks, you may want to look at some of the solutions for managing hooks, since <code>.git/hooks</code> is outside the actual Git repository.</p></article><article class="post"><p class="date">29th October 2017 7:31 pm</p><h1><a href="/blog/2017/10/29/an-azure-filesystem-integration-for-laravel/">An Azure Filesystem Integration for Laravel</a></h1><p><a href="/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/">My earlier post about integrating Laravel and Azure storage</a> seems to have become something of a go-to resource on this subject (I suspect this is because very few developers actually use Laravel and Azure together). Unfortunately it hasn’t really aged terribly well - changes to the namespace and to Guzzle mean that it needs some work to integrate it.</p><p>I’ve therefore <a href="https://github.com/matthewbdaly/laravel-azure-storage">created a package for it</a>. That way, it’s easier to keep it up to date as if someone finds and fixes an issue with it, they can submit their changes back.</p></article><article class="post"><p class="date">20th October 2017 10:55 pm</p><h1><a href="/blog/2017/10/20/using-phpiredis-with-laravel/">Using Phpiredis With Laravel</a></h1><p>Laravel has support out of the box for using Redis. However, by default it uses a Redis client written in PHP, which will always be a little slower than one written in C. If you’re making heavy use of Redis, it may be worth using the <a href="https://github.com/nrk/phpiredis">phpiredis</a> extension to squeeze a little more performance out of it.</p><p>I’m using PHP 7.0 on Ubuntu Zesty and I installed the dependencies with the following command:</p><pre><code class="hljs lang-bash singleline">$ sudo apt-get install libhiredis-dev php-redis php7.0-dev</code></pre><p>Then I installed phpiredis as follows:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>git <span class="hljs-built_in">clone</span> https://github.com/nrk/phpiredis.git &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>       <span class="hljs-built_in">cd</span> phpiredis &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>       phpize &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>       ./configure --<span class="hljs-built_in">enable</span>-phpiredis &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>       make &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>       sudo make install</td></tr></table></code></pre><p>Finally, I configured Redis to use phpiredis in the <code>redis</code> section of <code>config/database.php</code> for a Laravel app:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-string">'redis'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'cluster'</span> =&gt; <span class="hljs-keyword">false</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-string">'default'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'host'</span>     =&gt; env(<span class="hljs-string">'REDIS_HOST'</span>, <span class="hljs-string">'localhost'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">'password'</span> =&gt; env(<span class="hljs-string">'REDIS_PASSWORD'</span>, <span class="hljs-keyword">null</span>),</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">'port'</span>     =&gt; env(<span class="hljs-string">'REDIS_PORT'</span>, <span class="hljs-number">6379</span>),</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-string">'database'</span> =&gt; <span class="hljs-number">0</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-string">'options'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-string">'connections'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                    <span class="hljs-string">'tcp'</span> =&gt; <span class="hljs-string">'Predis\Connection\PhpiredisStreamConnection'</span>, <span class="hljs-comment">// PHP streams</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                    <span class="hljs-string">'unix'</span> =&gt; <span class="hljs-string">'Predis\Connection\PhpiredisSocketConnection'</span>, <span class="hljs-comment">// ext-socket</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                ],</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            ]</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        ],</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    ],</td></tr></table></code></pre><p>Now, I’m going to be honest - in a casual comparison I couldn’t see much difference in terms of speed. I would probably only bother with setting this up on a site where high Redis performance was absolutely necessary. If you just want a quicker cache response it might make more sense to put Varnish in front of the site instead. However, in cases where Redis gets used heavily, it’s probably worth doing.</p></article><article class="post"><p class="date">3rd October 2017 11:56 pm</p><h1><a href="/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">Simple Fuzzy Search With Laravel and Postgresql</a></h1><p>When implementing fuzzy search, many developers reach straight for specialised tools like Elasticsearch. However, for simple implementations, this is often overkill. PostgreSQL, my relational database of choice, can natively handle fuzzy search quite easily if you know how. Here’s how you might use this with Laravel.</p><p>Suppose we have the following migration to create a <code>locations</code> table, storing towns, cities and villages:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateLocations</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-comment">// Create locations table</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'locations'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;increments(<span class="hljs-string">'id'</span>)-&gt;unsigned();</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'name'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Drop locations table</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        Schema::drop(<span class="hljs-string">'locations'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></tr></table></code></pre><p>The key to this implementation of fuzzy search is <em>trigrams</em>. A trigram is a group of three consecutive characters taken from a string. Using the <code>pg_trgm</code> module, which comes with PostgreSQL, we can break a string into as many trigrams as possible, and then return the strings with the most matching trigrams.</p><p>We can ensure that <code>pg_trgm</code> is set up on the database by creating a migration:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddTrgmExtension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">'DROP EXTENSION IF EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>Make sure you run the migration as well. Once that is done, we can make a raw fuzzy query against the <code>name</code> field as follows:</p><pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locations <span class="hljs-keyword">WHERE</span> <span class="hljs-string">'burgh'</span> % <span class="hljs-keyword">name</span>;</code></pre><p>Translating that to work with the Eloquent ORM, we can perform fuzzy queries against the <code>name</code> field as follows:</p><pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"'burgh' % name"</span>)-&gt;get();</code></pre><p>This query might match both <code>Aldeburgh</code> and <code>Edinburgh</code>. It’s also able to handle slight misspellings, as in this example:</p><pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"'hendrad' % name"</span>)-&gt;get();</code></pre><p>This query will match <code>East Hendred</code> or <code>West Hendred</code> successfully. As you can see, we can match strings at any point in the name string, and handle slight mis-spellings without any problems.</p><p>In practice, rather than using <code>whereRaw()</code> every time, you’ll probably want to create a local scope that accepts the name you want to match against. You’ll also want to use query parameters to prevent SQL injection:</p><pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"? % name"</span>, [$name])-&gt;get();</code></pre><h2 id="improving-performance-with-an-index">Improving performance with an index</h2><p>The performance of these queries isn’t that great out of the box. We can improve them by creating an index:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddTrgmExtension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        DB::statement(<span class="hljs-string">'CREATE INDEX locations_name_trigram ON locations USING gist(name gist_trgm_ops);'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        DB::statement(<span class="hljs-string">'DROP INDEX IF EXISTS locations_name_trigram'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        DB::statement(<span class="hljs-string">'DROP EXTENSION IF EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Adding an index should produce a noticeable improvement in the response time.</p><h2 id="final-thoughts">Final thoughts</h2><p>PostgreSQL’s <code>pg_trgm</code> module is a fairly straightforward way of implementing fuzzy search. It’s not much more involved than a <code>LIKE</code> or <code>ILIKE</code> clause in your query, and for many use cases, it’s more than sufficient. If you don’t have a huge number of records, it’s probably a more appropriate choice than something like Elasticsearch, and has the advantage of a simpler stack. However, if you have a larger dataset, you may be better off with a dedicated search solution. As always, if you’re unsure it’s a good idea to try both and see what works best for that particular use case.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/06/23/forcing-ssl-in-codeigniter/">Forcing SSL in Codeigniter</a></p><p><a href="/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/">Logging to the ELK Stack With Laravel</a></p><p><a href="/blog/2018/05/13/full-text-search-with-mariadb/">Full-text Search With Mariadb</a></p><p><a href="/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/">Building a Letter Classifier in PHP With Tesseract OCR and PHP ML</a></p><p><a href="/blog/2018/04/29/console-applications-with-the-symfony-console-component/">Console Applications With the Symfony Console Component</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/6/">Newer</a></li><li><a href="/posts/8/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>