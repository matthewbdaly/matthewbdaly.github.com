<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/7/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">3rd June 2018 4:30 pm</p><h1><a href="/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/">Logging to the ELK Stack With Laravel</a></h1><p>Logging to text files is the simplest and most common logging setup for web apps, and it works fine for relatively small and simple applications. However, it does have some downsides:</p><ul><li>It’s difficult to make the log files accessible - normally users have to SSH in to read them.</li><li>The tools used to filter and analyse log files have a fairly high technical barrier to access - grep and sed are not exactly easy for non-programmers to pick up, so business information can be hard to get.</li><li>It’s hard to visually identify trends in the data.</li><li>Log files don’t let you know immediately when something urgent happens</li><li>You can’t access logs for different applications through the same interface.</li></ul><p>For rare, urgent issues where you need to be informed immediately they occur, it’s straightforward to log to an instant messaging solution such as Slack or Hipchat. However, these aren’t easily searchable, and can only be used for the most important errors (otherwise, there’s a risk that important data will be lost in the noise). There are third-party services that allow you to search and filter your logs, but they can be prohibitively expensive.</p><p>The <a href="https://www.elastic.co/elk-stack">ELK stack</a> has recently gained a lot of attention as a sophisticated solution for logging application data. It consists of:</p><ul><li>Logstash for processing log data</li><li>Elasticsearch as a searchable storage backend</li><li>Kibana as a web interface</li></ul><p>By making the log data available using a powerful web interface, you can easily expose it to non-technical users. Kibana also comes with powerful tools to aggregate and filter the data. In addition, you can run your own instance, giving you a greater degree of control (as well as possibly being more cost-effective) compared to using a third-party service.</p><p>In this post I’ll show you how to configure a Laravel application to log to an instance of the ELK stack. Fortunately, Laravel uses the popular Monolog logging library by default, which is relatively easy to get to work with the ELK stack. First, we need to install support for the GELF logging format:</p><pre><code class="hljs lang-bash singleline">$ composer require graylog2/gelf-php</code></pre><p>Then, we create a custom logger class:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Logging</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Monolog</span>\<span class="hljs-title">Logger</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Monolog</span>\<span class="hljs-title">Handler</span>\<span class="hljs-title">GelfHandler</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Gelf</span>\<span class="hljs-title">Publisher</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Gelf</span>\<span class="hljs-title">Transport</span>\<span class="hljs-title">UdpTransport</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GelfLogger</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * Create a custom Monolog instance.</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     * <span class="hljs-doctag">@param</span>  array  $config</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@return</span> \Monolog\Logger</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(array $config)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $handler = <span class="hljs-keyword">new</span> GelfHandler(<span class="hljs-keyword">new</span> Publisher(<span class="hljs-keyword">new</span> UdpTransport($config[<span class="hljs-string">'host'</span>], $config[<span class="hljs-string">'port'</span>])));</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Logger(<span class="hljs-string">'main'</span>, [$handler]);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>}</td></tr></table></code></pre><p>Finally, we configure our application to use this as our custom driver and specify the host and port in <code>config/logging.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>        <span class="hljs-string">'custom'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>            <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'custom'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-string">'via'</span> =&gt; App\Logging\GelfLogger::class,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'host'</span> =&gt; <span class="hljs-string">'127.0.0.1'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'port'</span> =&gt; <span class="hljs-number">12201</span>,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ],</td></tr></table></code></pre><p>You can then set up whatever logging channels you need for your application, and specify whatever log level you feel is appropriate.</p><p>Please note that this requires at least Laravel 5.6 - this file doesn’t exist in Laravel 5.5 and earlier, so you may have more work on your hands to integrate it with older versions.</p><p>If you already have an instance of the ELK stack set up on a remote server that’s already set up to accept input as GELF, then you should be able to point it at that and you’ll be ready to go. If you just want to try it out, I’ve been using a <a href="https://github.com/deviantony/docker-elk">Docker-based project</a> that makes it straightforward to run the whole stack locally. However, you will need to amend <code>logstash/pipeline/logstash.conf</code> as follows to allow it to accept log data:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>input {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    tcp {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        port =&gt; 5000</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   gelf {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>       port =&gt; 12201</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>       type =&gt; gelf</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>       codec =&gt; "json"</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>## Add your filters / logstash plugins configuration here</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>output {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    elasticsearch {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        hosts =&gt; "elasticsearch:9200"</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>}</td></tr></table></code></pre><p>Then you can start it up using the instructions in the repository and it should be ready to go. Now, if you run the following command from Tinker:</p><pre><code class="hljs lang-php singleline">Log::info(<span class="hljs-string">'Just testing'</span>);</code></pre><p>Then if you access the web interface, you should be able to find that log message without any difficulty.</p><p>Now, this only covers the Laravel application logs. You may well want to pass other logs through to Logstash, such as Apache, Nginx or MySQL logs, and a quick Google should be sufficient to find ideas on how you might log for these services. Creating visualisations with Kibana is a huge subject, and the existing documentation covers that quite well, so if you’re interested in learning more about that I’d recommend reading the documentation and having a play with the dashboard.</p></article><article class="post"><p class="date">13th May 2018 2:55 pm</p><h1><a href="/blog/2018/05/13/full-text-search-with-mariadb/">Full-text Search With Mariadb</a></h1><p>Recently I had the occasion to check out MariaDB’s implementation of full-text search. As it’s a relatively recent arrival in MySQL and MariaDB, it doesn’t seem to get all that much attention. In this post I’ll show you how to use it, with a few Laravel-specific pointers. We’ll be using the default <code>User</code> model in a new Laravel installation, which has columns for <code>name</code> and <code>email</code>.</p><p>Our first task is to create the fulltext index, which is necessary to perform the query. Run the following command:</p><pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">ADD</span> FULLTEXT (<span class="hljs-keyword">name</span>, email);</code></pre><p>As you can see, we can specify multiple columns in our table to index.</p><p>If you’re using Laravel, you’ll want to create the following migration for this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddFulltextIndexForUsers</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'ALTER TABLE users ADD FULLTEXT(name, email)'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">'ALTER TABLE users DROP INDEX IF EXISTS name'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>Note that the index is named after the first field passed to it, so when we drop it we refer to it as <code>name</code>. Then, to actually query the index, you should run a command something like this:</p><pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(<span class="hljs-keyword">name</span>, email) AGAINST (<span class="hljs-string">'jeff'</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">MODE</span>);</code></pre><p>Note that <code>NATURAL LANGUAGE MODE</code> is actually the default, so you can leave it off if you wish. We also have to specify the columns to match against.</p><p>If you’re using Laravel, you may want to create a reusable local scope for it:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeSearch</span><span class="hljs-params">($query, $search)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">if</span> (!$search) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-keyword">return</span> $query;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> $query-&gt;whereRaw(<span class="hljs-string">'MATCH(name, email) AGAINST (?)'</span>, [$search]);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    }</td></tr></table></code></pre><p>Then you can call it as follows:</p><pre><code class="hljs lang-php singleline">User::search(<span class="hljs-string">'jeff'</span>)-&gt;get();</code></pre><p>I personally have noticed that the query using the <code>MATCH</code> keywords seems to be far more performant, with the response time being between five and ten times less than a similar command using <code>LIKE</code>, however this observation isn’t very scientific (plus, we are talking about queries that still run in a fraction of a second). However, if you’re doing a particularly expensive query that currently uses a <code>LIKE</code> statement, it’s possible you may get better results by switching to a <code>MATCH</code> statement. Full-text search probably isn’t all that useful in this context - it’s only once we’re talking about longer text, such as blog posts, that some of the advantages like support for stopwords comes into play.</p><p>From what I’ve seen this implementation of full-text search is a lot simpler than in PostgreSQL, which has ups and downs. On the one hand, it’s a lot easier to implement, but conversely it’s less useful - there’s no obvious way to perform a full-text search against joined tables. However, it does seem to be superior to using a <code>LIKE</code> statement, so it’s probably a good fit for smaller sites where something like Elasticsearch would be overkill.</p></article><article class="post"><p class="date">10th May 2018 11:50 pm</p><h1><a href="/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/">Building a Letter Classifier in PHP With Tesseract OCR and PHP ML</a></h1><p>PHP isn’t the first language that springs to mind when it comes to machine learning. However, it is practical to use PHP for machine learning purposes. In this tutorial I’ll show you how to build a pipeline for classifying letters.</p><h2 id="the-brief">The brief</h2><p>Before I was a web dev, I was a clerical worker for an FTSE-100 insurance company, doing a lot of work that nowadays is possible to automate away, if you know how. When they received a letter or other communication from a client, it would be sent to be scanned on. Once scanned, a human would have to look at it to classify it, eg was it a complaint, a request for information, a request for a quote, or something else, as well as assign it to a policy number. Let’s imagine we’ve been asked to build a proof of concept for automating this process. This is a good example of a real-world problem that machine learning can help with.</p><p>As this is a proof of concept we aren’t looking to build a web app for this - for simplicity’s sake this will be a command-line application. Unlike emails, letters don’t come in an easily machine-readable format, so we will be receiving them as PDF files (since they would have been scanned on, this is a reasonable assumption). Feel free to mock up your own example letters using your own classifications, but I will be classifying letters into four groups:</p><ul><li><strong>Complaints</strong> - letters expressing dissatisfaction</li><li><strong>Information requests</strong> - letters requesting general information</li><li><strong>Surrender quotes</strong> - letters requesting a surrender quote</li><li><strong>Surrender forms</strong> - letters requesting surrender forms</li></ul><p>Our application will therefore take in a PDF file at one end, and perform the following actions on it:</p><ul><li>Convert the PDF file to a PNG file</li><li>Use OCR (optical character recognition) to convert the letter to plain text</li><li>Strip out unwanted whitespace</li><li>Extract any visible policy number from the text</li><li>Use a machine learning library to classify the letter, having taught it using prior examples</li></ul><p>Sound interesting? Let’s get started…</p><h2 id="introducing-pipelines">Introducing pipelines</h2><p>As our application will be carrying out a series of discrete steps on our data, it makes sense to use the pipeline pattern for this project. Fortunately, the PHP League have produced a excellent <a href="http://pipeline.thephpleague.com/">package</a> implementing this. We can therefore create a single class for each step in the process and have it handle that in isolation.</p><p>We’ll also use the Symfony Console component to implement our command-line application. For our machine learning library we will be using <a href="https://php-ml.readthedocs.io/en/latest/">PHP ML</a>, which requires PHP 7.1 or greater. For OCR, we will be using <a href="https://github.com/thiagoalessio/tesseract-ocr-for-php">Tesseract</a>, so you will need to install the underlying Tesseract OCR library, as well as support for your language. On Ubuntu you can install these as follows:</p><pre><code class="hljs lang-bash singleline">$ sudo apt-get install tesseract-ocr tesseract-ocr-eng</code></pre><p>This assumes you are using English, however you should be able to find packages to support many other languages. Finally, we need ImageMagick to be installed in order to convert PDF files to PNG’s.</p><p>Your <code>composer.json</code> should look something like this:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/letter-classifier"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Demo of classifying letters in PHP"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"project"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"require"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-attr">"league/pipeline"</span>: <span class="hljs-string">"^0.3.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"thiagoalessio/tesseract_ocr"</span>: <span class="hljs-string">"^2.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"php-ai/php-ml"</span>: <span class="hljs-string">"^0.6.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">"symfony/console"</span>: <span class="hljs-string">"^4.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^4.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-attr">"psy/psysh"</span>: <span class="hljs-string">"^0.8.17"</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-attr">"Matthewbdaly\\LetterClassifier\\"</span>: <span class="hljs-string">"src/"</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"authors"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"matthewbdaly@gmail.com"</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    ]</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>Next, let’s write the outline of our command-line client. We’ll load a single class for our processor command. Save this as <code>app</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">#!/usr/bin/env php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/vendor/autoload.php'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Application</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Commands</span>\<span class="hljs-title">Processor</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>$application = <span class="hljs-keyword">new</span> Application();</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>$application-&gt;add(<span class="hljs-keyword">new</span> Processor());</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$application-&gt;run();</td></tr></table></code></pre><p>Next, we create our command. Save this as <code>src/Commands/Processor.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Commands</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Command</span>\<span class="hljs-title">Command</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Output</span>\<span class="hljs-title">OutputInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputArgument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">Pipeline</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">ConvertPdfToPng</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">ReadFile</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">Classify</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">StripTabs</span>;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">GetPolicyNumber</span>;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Processor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setName(<span class="hljs-string">'process'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            -&gt;setDescription(<span class="hljs-string">'Processes a file'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            -&gt;setHelp(<span class="hljs-string">'This command processes a file'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            -&gt;addArgument(<span class="hljs-string">'file'</span>, InputArgument::REQUIRED, <span class="hljs-string">'File to process'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $file = $input-&gt;getArgument(<span class="hljs-string">'file'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        $pipeline = (<span class="hljs-keyword">new</span> Pipeline)</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> ConvertPdfToPng)</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> ReadFile)</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> StripTabs)</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> GetPolicyNumber)</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> Classify);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        $response = $pipeline-&gt;process($file);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $output-&gt;writeln(<span class="hljs-string">"Classification is "</span>.$response[<span class="hljs-string">'classification'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $output-&gt;writeln(<span class="hljs-string">"Policy number is "</span>.$response[<span class="hljs-string">'policy'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Note how our command accepts the file name as an argument. We then instantiate our pipeline and pass it through a series of classes, each of which has a single role. Finally, we retrieve our response and output it.</p><p>With that done, we can move on to implementing our first step. Save this as <code>src/Stages/ConvertPdfToPng.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Imagick</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConvertPdfToPng</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($file)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $tmp = tmpfile();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        $uri = stream_get_meta_data($tmp)[<span class="hljs-string">'uri'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $img = <span class="hljs-keyword">new</span> Imagick();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $img-&gt;setResolution(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $img-&gt;readImage($file);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $img-&gt;setImageDepth(<span class="hljs-number">8</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $img-&gt;setImageFormat(<span class="hljs-string">'png'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $img-&gt;writeImage($uri);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> $tmp;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>}</td></tr></table></code></pre><p>This stage fetches the file passed through, and converts it into a PNG file, stores it as a temporary file, and returns a reference to it. The output of this stage will then form the input of the next. This is how pipelines work, and it makes it easy to break up a complex process into multiple steps that can be reused in different places, facilitating easier code reuse and making your code simpler to understand and reason about.</p><p>Our next step carries out optical character recognition. Save this as <code>src/Stages/ReadFile.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">thiagoalessio</span>\<span class="hljs-title">TesseractOCR</span>\<span class="hljs-title">TesseractOCR</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadFile</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($file)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $uri = stream_get_meta_data($file)[<span class="hljs-string">'uri'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        $ocr = <span class="hljs-keyword">new</span> TesseractOCR($uri);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> $ocr-&gt;lang(<span class="hljs-string">'eng'</span>)-&gt;run();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>As you can see, this accepts the link to the temporary file as an argument, and runs Tesseract on it to retrieve the text. Note that we specify a language of <code>eng</code> - if you want to use a language other than English, you should specify it here.</p><p>At this point, we should have some usable text, but there may be unknown amounts of whitespace, so our next step uses a regex to strip them out. Save this as <code>src/Stages/StripTabs.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StripTabs</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($content)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">return</span> trim(preg_replace(<span class="hljs-string">'/\s+/'</span>, <span class="hljs-string">' '</span>, $content));</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>With our whitespace issue sorted out, we now need to retrieve the policy number the communication should be filed under. These are generally regular alphanumeric patterns, so regexes are a suitable way of matching them. As this is a proof of concept, we’ll assume a very simple pattern for policy numbers in that they will consist of between seven and nine digits. Save this as <code>src/Stages/GetPolicyNumber.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetPolicyNumber</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($content)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $matches = [];</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $policyNumber = <span class="hljs-string">''</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        preg_match(<span class="hljs-string">'/\d{7,9}/'</span>, $content, $matches);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">if</span> (count($matches)) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            $policyNumber = $matches[<span class="hljs-number">0</span>];</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            <span class="hljs-string">'content'</span> =&gt; $content,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'policy'</span> =&gt; $policyNumber</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>Finally, we’re onto the really tough part - using machine learning to classify the letters. Save this as <code>src/Stages/Classify.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Dataset</span>\<span class="hljs-title">CsvDataset</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Dataset</span>\<span class="hljs-title">ArrayDataset</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">FeatureExtraction</span>\<span class="hljs-title">TokenCountVectorizer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Tokenization</span>\<span class="hljs-title">WordTokenizer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">CrossValidation</span>\<span class="hljs-title">StratifiedRandomSplit</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">FeatureExtraction</span>\<span class="hljs-title">TfIdfTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Metric</span>\<span class="hljs-title">Accuracy</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Classification</span>\<span class="hljs-title">SVC</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">SupportVectorMachine</span>\<span class="hljs-title">Kernel</span>;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Classify</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">protected</span> $classifier;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">protected</span> $vectorizer;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">protected</span> $tfIdfTransformer;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;dataset = <span class="hljs-keyword">new</span> CsvDataset(<span class="hljs-string">'data/letters.csv'</span>, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer = <span class="hljs-keyword">new</span> TokenCountVectorizer(<span class="hljs-keyword">new</span> WordTokenizer());</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer = <span class="hljs-keyword">new</span> TfIdfTransformer();</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $samples = [];</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;dataset-&gt;getSamples() <span class="hljs-keyword">as</span> $sample) {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                $samples[] = $sample[<span class="hljs-number">0</span>];</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;fit($samples);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;transform($samples);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;fit($samples);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;transform($samples);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $dataset = <span class="hljs-keyword">new</span> ArrayDataset($samples, <span class="hljs-keyword">$this</span>-&gt;dataset-&gt;getTargets());</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $randomSplit = <span class="hljs-keyword">new</span> StratifiedRandomSplit($dataset, <span class="hljs-number">0.1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;classifier = <span class="hljs-keyword">new</span> SVC(Kernel::RBF, <span class="hljs-number">10000</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;train($randomSplit-&gt;getTrainSamples(), $randomSplit-&gt;getTrainLabels());</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        $predictedLabels = <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;predict($randomSplit-&gt;getTestSamples());</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Accuracy: '</span>.Accuracy::score($randomSplit-&gt;getTestLabels(), $predictedLabels);</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(array $message)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        $newSample = [$message[<span class="hljs-string">'content'</span>]];</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;transform($newSample);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;transform($newSample);</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $message[<span class="hljs-string">'classification'</span>] = <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;predict($newSample)[<span class="hljs-number">0</span>];</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> $message;</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>}</td></tr></table></code></pre><p>In our constructor, we train up our model by passing our sample data through the following steps:</p><ul><li>First, we use the token count vectorizer to convert our samples to a vector of token counts - replacing every word with a number and keeping track of how often that word occurs.</li><li>Next, we use <code>TfIdfTransformer</code> to get statistics about how important a word is in a document.</li><li>Then we instantiate our classifier and train it on a random subset of our data.</li><li>Finally, we pass our message to our now-trained classifier and see what it tells us.</li></ul><p>Now, bear in mind I don’t have a background in machine learning and this is the first time I’ve done anything with machine learning, so I can’t tell you much more than that - if you want to know more I suggest you investigate on your own. In figuring this out I was helped a great deal by <a href="https://www.sitepoint.com/how-to-analyze-tweet-sentiments-with-php-machine-learning/">this article on Sitepoint</a>, so you might want to start there.</p><p>The finished application is <a href="https://github.com/matthewbdaly/letter-classifier">on GitHub</a>, and the repository includes a CSV file of training data, as well as the <code>examples</code> folder, which contains some example PDF files. You can run it as follows:</p><pre><code class="hljs lang-bash singleline">$ php app process examples/Quote.pdf</code></pre><p>I found that once I had trained it up using the CSV data from the repository, it was around 70-80% accurate, which isn’t bad at all considering the comparatively small size of the dataset. If this were genuinely being used in production, there would be an extremely large dataset of historical scanned letters to use for training purposes, so it wouldn’t be unreasonable to expect much better results under those circumstances.</p><h2 id="exercises-for-the-reader">Exercises for the reader</h2><p>If you want to develop this concept further, here are some ideas:</p><ul><li>We should be able to correct the model when it’s wrong. Add a separate command to train the model by passing through a file and specifying how it should be categorised, eg <code>php app train File.pdf quote</code>.</li><li>Try processing information from different sources. For instance, you could replace the first two stages with a stage that pulls all unread emails from a specified mailbox using PHP’s IMAP support, or fetching data from the Twitter API. Or you could have a telephony service such as Twilio set up as your voicemail, and automatically transcribe them, then pass the text to PHP ML for classification.</li><li>If you’re multilingual, you could try adding a step to sort letters by language and have separate models for classifying in each language</li></ul><h2 id="summary">Summary</h2><p>It’s actually quite a sobering thought that <em>already</em> it’s possible to use techniques like these to produce tools that replace people in various jobs, and as the tooling matures more and more tasks involving classification are going to become amenable to automation using machine learning.</p><p>This was my first experience with machine learning and it’s been very interesting for me to solve a real-world problem with it. I hope it gives you some ideas about how you could use it too.</p></article><article class="post"><p class="date">29th April 2018 8:59 pm</p><h1><a href="/blog/2018/04/29/console-applications-with-the-symfony-console-component/">Console Applications With the Symfony Console Component</a></h1><p>Recently I’ve had the occasion to add a series of console commands to a legacy application. This can be made straightforward by using the Symfony console component. In this post I’ll demonstrate how to write a simple console command for clearing a cache folder.</p><p>The first step is to install the Console component:</p><pre><code class="hljs lang-bash singleline">$ composer require symfony/console</code></pre><p>Then we write the main script for the application. I usually save mine as <code>console</code> - note that we don’t want to have to type out a file extension, so instead we use the shebang:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">#!/user/bin/env php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/vendor/autoload.php'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Application</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>define(<span class="hljs-string">'CONSOLE_ROOT'</span>, <span class="hljs-keyword">__DIR__</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>$app = <span class="hljs-keyword">new</span> Application();</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$app-&gt;run();</td></tr></table></code></pre><p>In this case, I’ve defined <code>CONSOLE_ROOT</code> as the directory in which the console command is run - that way, the commands can use it to refer to the application root.</p><p>We can then run our console application as follows:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php console</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Console Tool</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Usage:</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-built_in">command</span> [options] [arguments]</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Options:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  -h, --<span class="hljs-built_in">help</span>            Display this <span class="hljs-built_in">help</span> message</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  -q, --quiet           Do not output any message</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  -V, --version         Display this application version</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      --ansi            Force ANSI output</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      --no-ansi         Disable ANSI output</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  -n, --no-interaction  Do not ask any interactive question</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="hljs-keyword">for</span> normal output, 2 <span class="hljs-keyword">for</span> more verbose output and 3 <span class="hljs-keyword">for</span> debug</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Available commands:</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-built_in">help</span>  Displays <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> a <span class="hljs-built_in">command</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  list  Lists commands</td></tr></table></code></pre><p>This displays the available commands, but you’ll note that there are none except for <code>help</code> and <code>list</code>. We’ll remedy that. First, we’ll register a command:</p><pre><code class="hljs lang-php singleline">$app-&gt;add(<span class="hljs-keyword">new</span> App\Console\ClearCacheCommand);</code></pre><p>This has to be done in <code>console</code>, after we create <code>$app</code>, but before we run it.</p><p>Don’t forget to update the autoload section of your <code>composer.json</code> to register the namespace:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "autoload": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "psr-4": {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            "App\\Console\\": "src/Console/"</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    },</td></tr></table></code></pre><p>Then create the class for that command. This class must extend <code>Symfony\Component\Console\Command\Command</code>, and must have two methods:</p><ul><li><code>configure()</code></li><li><code>execute()</code></li></ul><p>In addition, the <code>execute()</code> method must accept two arguments, an instance of <code>Symfony\Component\Console\Input\InputInterface</code>, and an instance of <code>Symfony\Component\Console\Output\OutputInterface</code>. There are used to retrieve input and display output.</p><p>Let’s write our command:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Console</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Command</span>\<span class="hljs-title">Command</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Output</span>\<span class="hljs-title">OutputInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClearCacheCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setName(<span class="hljs-string">'cache:clear'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>             -&gt;setDescription(<span class="hljs-string">'Clears the cache'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>             -&gt;setHelp(<span class="hljs-string">'This command clears the application cache'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $dir = CONSOLE_ROOT.DIRECTORY_SEPARATOR.<span class="hljs-string">'cache'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">$this</span>-&gt;deleteTree($dir);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $output-&gt;writeln(<span class="hljs-string">'Cache cleared'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    } </td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteTree</span><span class="hljs-params">($dir)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        $files = array_diff(scandir($dir), <span class="hljs-keyword">array</span>(<span class="hljs-string">'.'</span>,<span class="hljs-string">'..'</span>)); </td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">foreach</span> ($files <span class="hljs-keyword">as</span> $file) { </td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            (is_dir(<span class="hljs-string">"$dir/$file"</span>)) ? <span class="hljs-keyword">$this</span>-&gt;deleteTree(<span class="hljs-string">"$dir/$file"</span>) : unlink(<span class="hljs-string">"$dir/$file"</span>); </td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        } </td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">return</span> rmdir($dir); </td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></tr></table></code></pre><p>As you can see, in the <code>configure()</code> method, we set the name, description and help text for the command.</p><p>The <code>execute()</code> method is where the actual work is done. In this case, we have some code that needs to be called recursively, so we have to pull it out into a private method. Once that’s done we use <code>$output-&gt;writeln()</code> to write a line to the output.</p><p>Now, if we run our console task, we should see our new command:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php console</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Console Tool</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Usage:</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-built_in">command</span> [options] [arguments]</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Options:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  -h, --<span class="hljs-built_in">help</span>            Display this <span class="hljs-built_in">help</span> message</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  -q, --quiet           Do not output any message</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  -V, --version         Display this application version</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      --ansi            Force ANSI output</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      --no-ansi         Disable ANSI output</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  -n, --no-interaction  Do not ask any interactive question</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="hljs-keyword">for</span> normal output, 2 <span class="hljs-keyword">for</span> more verbose output and 3 <span class="hljs-keyword">for</span> debug</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Available commands:</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-built_in">help</span>         Displays <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> a <span class="hljs-built_in">command</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  list         Lists commands</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td> cache</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  cache:clear  Clears the cache</td></tr></table></code></pre><p>And we can see it in action too:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php console cache:clear</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Cache cleared</td></tr></table></code></pre><p>For commands that need to accept additional arguments, you can define them in the <code>configure()</code> method:</p><pre><code class="hljs lang-php singleline"><span class="hljs-keyword">$this</span>-&gt;addArgument(<span class="hljs-string">'file'</span>, InputArgument::REQUIRED, <span class="hljs-string">'Which file do you want to delete?'</span>)</code></pre><p>Then, you can access it in the <code>execute()</code> method using <code>InputInterface</code>:</p><pre><code class="hljs lang-php singleline">$file = $input-&gt;getArgument(<span class="hljs-string">'file'</span>);</code></pre><p>This tutorial is just skimming the surface of what you can do with the Symfony Console components - indeed, many other console interfaces, such as Laravel’s Artisan, are built on top of it. If you have a legacy application built in a framework that lacks any sort of console interface, such as CodeIgniter, then you can quite quickly produce basic console commands for working with that application. The <a href="https://symfony.com/doc/current/console.html">documentation is very good</a>, and with a little work you can soon have something up and running.</p></article><article class="post"><p class="date">22nd April 2018 11:50 pm</p><h1><a href="/blog/2018/04/22/rendering-different-views-for-mobile-and-desktop-clients-in-laravel/">Rendering Different Views for Mobile and Desktop Clients in Laravel</a></h1><p>This was a bit of a weird post to write. It started out explaining how I resolved an issue years ago on a CodeIgniter site, but amended to work for Laravel. In the process, I realised it made sense to implement it as middleware, and I ended up pulling it out into <a href="https://github.com/matthewbdaly/laravel-dynamic-serving">a package</a>. However, it’s still useful to understand the concept behind it, even if you prefer to just install the complete package, because your needs might be slightly different to mine.</p><p>On web development forums, it’s quite common to see variants of the following question:</p><blockquote><p>How do I redirect a user on a mobile device to a mobile version of the site?</p></blockquote><p>It’s quite surprising that this is still an issue that crops up. For many years, it’s been widely accepted that the correct solution for this problem is responsive design. However, there are ways in which this may not be adequate for certain applications. For instance, you may have an application where certain functionality only makes sense in a certain context, or your user interface may need to be optimised for specific environments.</p><p>The trouble is that a dedicated mobile site isn’t a good idea either. Among other things, it means that users can’t easily use the same bookmarks between desktop and mobile versions, and can result in at least some of the server-side logic being duplicated.</p><p>Fortunately, there is another way - <a href="https://developers.google.com/search/mobile-sites/mobile-seo/dynamic-serving">dynamic serving</a> allows you to render different content based on the user agent. You can also easily enable users to switch between desktop and mobile versions themselves if their client isn’t detected correctly or they just prefer the other one. I’ve implemented this years ago for a CodeIgniter site. Here’s how you might implement it in Laravel, although if you understand the principle behind it, it should be easy to adapt for any other framework.</p><p>Don’t try to implement mobile user agent detection yourself. Instead, find an implementation that’s actively maintained and install it with Composer. That way you can be reasonably sure that as new mobile devices come onto the market the package will detect them correctly as long as you keep it up to date. I would be inclined to go for <a href="https://github.com/jenssegers/agent">Agent</a>, since it has Laravel support baked in.</p><p>We could just use Agent to serve up different content based on the user agent. However, user agent strings are notoriously unreliable - if a new mobile device appears and it doesn’t show up correctly in Agent, users could find themselves forced to use the wrong UI. Instead, we need to check for a flag in the session that indicates if the session is mobile or not. If it’s not set, we set it based on the user agent. That way, if you need to offer functionality to override the detected session type, you can just update that session variable to correct that elsewhere in the application. I would be inclined to use a button in the footer that makes an AJAX request to toggle the flag, then reloads the page.</p><p>You also need to set the HTTP response header <code>Vary: User-Agent</code> to notify clients (including not only search engines, but also proxies at either end of the connection, such as Varnish or Squid) that the response will differ by user agent, in order to prevent users being served the wrong version.</p><p>Middleware is the obvious place to do this. Here’s a middleware that sets the session variable and the appropriate response headers:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Jenssegers</span>\<span class="hljs-title">Agent</span>\<span class="hljs-title">Agent</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Session</span>\<span class="hljs-title">Session</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DetectMobile</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> $agent;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $session;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Agent $agent, Session $session)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;agent = $agent;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = $session;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * Handle an incoming request.</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;session-&gt;exists(<span class="hljs-string">'mobile'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;agent-&gt;isMobile() || <span class="hljs-keyword">$this</span>-&gt;agent-&gt;isTablet()) {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-keyword">$this</span>-&gt;session-&gt;put(<span class="hljs-string">'mobile'</span>, <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            } <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-keyword">$this</span>-&gt;session-&gt;put(<span class="hljs-string">'mobile'</span>, <span class="hljs-keyword">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $response = $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> $response-&gt;setVary(<span class="hljs-string">'User-Agent'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>}</td></tr></table></code></pre><p>Now, you could then work with the session directly to retrieve the <code>mobile</code> flag, but as you may be working in the view, it makes sense to create helpers for this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">if</span> (!function_exists(<span class="hljs-string">'is_mobile'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_mobile</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $session = app()-&gt;make(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> $session-&gt;get(<span class="hljs-string">'mobile'</span>) == <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">if</span> (!function_exists(<span class="hljs-string">'is_desktop'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_desktop</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $session = app()-&gt;make(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> $session-&gt;get(<span class="hljs-string">'mobile'</span>) == <span class="hljs-keyword">false</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>Now, if you want to serve up completely different views, you can use these helpers in your controllers. If you instead want to selectively show and hide parts of the UI based on the user agent, you can instead use these in the views to determine what parts of the page should be shown.</p><p>Agent offers more functionality than just detecting if a user agent is a mobile or desktop device, and you may find this useful as a starting point for developing middleware for detecting bots, or showing different content to users based on their device type or operating system. If you just need to detect if a user is a mobile or desktop client, this middleware should be sufficient.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></p><p><a href="/blog/2019/10/13/flexible-data-types-with-the-json-field/">Flexible Data Types With the JSON Field</a></p><p><a href="/blog/2019/09/22/storing-wordpress-configuration-in-environment-variables/">Storing Wordpress Configuration in Environment Variables</a></p><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/6/">Newer</a></li><li class="page-item"><a href="/posts/8/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>