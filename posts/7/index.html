<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/7/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">2nd January 2018 12:01 pm</p><h1><a href="/blog/2018/01/02/using-artisan-from-standalone-laravel-packages/">Using Artisan from Standalone Laravel Packages</a></h1><p>Recently I’ve been building and publishing a significant number of Laravel packages, and I thought I’d share details of some of them over the next few days.</p><p><a href="https://github/com/matthewbdaly/artisan-standalone">Artisan Standalone</a> is a package that, when installed in a standalone Laravel package (eg, not in an actual Laravel install, but in a package that you’re building that is intended for use with Laravel), allows you to use Artisan. It’s intended largely to make it quicker and easier to build functionality as separate packages by giving you access to the same generator commands as you have when working with a Laravel application. It came about largely from a need to scratch my own itch, as when building packages I was having to either run Artisan commands in a Laravel app and move them over, or copy them from existing files, which was obviously a pain in the proverbial.</p><p>You can install it with the following command:</p><pre><code class="hljs lang-bash singleline">$ composer require --dev matthewbdaly/artisan-standalone</code></pre><p>Once it’s installed, you can access Artisan as follows:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/artisan</code></pre><p>Note that it doesn’t explicitly include Laravel as a dependency - you’ll need to add that in the parent package to pull in the libraries it needs (which you should be doing anyway). It’s possible that there are some commands that won’t work in this context, but they’re almost certainly ones you won’t need here, such as the <code>migrate</code> command. As far as I can tell the generator commands, which are the only ones we’re really interested in here, all work OK.</p></article><article class="post"><p class="date">1st January 2018 4:06 pm</p><h1><a href="/blog/2018/01/01/creating-artisan-tasks-that-generate-files/">Creating Artisan Tasks That Generate Files</a></h1><p>While the documentation for creating Artisan tasks is generally pretty good, it doesn’t really touch on creating tasks that generate new files. The only way to figure it out was to go digging through the source code. In this case, I was building an Artisan command to create Fractal transformers as part of a package I’m working on.</p><p>There’s a specialised class for generating files at <code>Illuminate\Console\GeneratorCommand</code>, which your command class should extend instead of <code>Illuminate\Console\Command</code>. In addition to the usual properties such as the signature and description, you also need to specify <code>$type</code> to give the type of class being generated. Also, note that the constructor is different, so if you use <code>php artisan make:console</code> to create the boilerplate for this command, you’ll need to delete the constructor.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Commands</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">GeneratorCommand</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputArgument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformerMakeCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GeneratorCommand</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * The name and signature of the console command.</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@var</span> string</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $signature = <span class="hljs-string">'make:transformer {name : The required name of the transformer class}'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * The console command description.</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * <span class="hljs-doctag">@var</span> string</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-keyword">protected</span> $description = <span class="hljs-string">'Create a Fractal transformer'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * The type of class being generated.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@var</span> string</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">protected</span> $type = <span class="hljs-string">'Fractal transformer'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     * Get the stub file for the generator.</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     * <span class="hljs-doctag">@return</span> string</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStub</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/stubs/transformer.stub'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * Get the console command arguments.</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> array</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getArguments</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>            [<span class="hljs-string">'name'</span>, InputArgument::REQUIRED, <span class="hljs-string">'The name of the command.'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * Get the default namespace for the class.</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>     * <span class="hljs-doctag">@param</span>  string  $rootNamespace</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>     * <span class="hljs-doctag">@return</span> string</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDefaultNamespace</span><span class="hljs-params">($rootNamespace)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        <span class="hljs-keyword">return</span> $rootNamespace.<span class="hljs-string">'\Transformers'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>}</td></tr></table></code></pre><p>Note the <code>getDefaultNamespace()</code> method. If your class will live directly under the <code>app</code> folder this is not necessary. Otherwise, it needs to return the root namespace, with the folder structure you want after it. Here my class will live under <code>app\Transformers</code>, so I’ve set it to reflect that.</p><p>Also, note the <code>getStub()</code> method. This tells Artisan that it should use the specified stub file as the basis for our class. Below you’ll find the stub file I used for my transformer:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">DummyNamespace</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">BaseTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DummyClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTransformer</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $model-&gt;id,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>Note that the <code>DummyNamespace</code> and <code>DummyClass</code> fields will be overwritten with the correct values.</p><p>Once this Artisan command is registered in the usual way, you can then run it as follows:</p><pre><code class="hljs lang-bash singleline">$ php artisan make:transformer Example</code></pre><p>And it will generate a boilerplate class something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Transformers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">BaseTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTransformer</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $model-&gt;id,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>You can then replace the model with your own one as necessary, and add any further content to this class.</p></article><article class="post"><p class="date">29th December 2017 6:01 pm</p><h1><a href="/blog/2017/12/29/using-uuids-as-primary-keys-with-laravel-and-postgresql/">Using Uuids As Primary Keys With Laravel and Postgresql</a></h1><p>For many applications, using UUID’s as the primary keys on a database table can make a lot of sense. For mobile or offline apps, in particular, they mean you can create new objects locally and assign them a primary key without having to worry about it colliding with another object that was created in the meantime once it gets synchronised to the server. Also, they are less informative to nefarious users - an autoincrementing value in a URL tells a user that that value is the primary key, and means the app may potentially allow gathering of information via user enumeration (eg calling <code>/api/v1/users/1</code>, <code>/api/v1/users/2</code> etc).</p><p>It’s fairly straightforward to use UUID’s as primary keys on your models when using PostgreSQL. First, you need to set up your migrations to use the <code>uuid-ossp</code> extension and set up the <code>id</code> field as both a UUID and the primary key. You also need to set a default value manually so that if it’s left empty it will generate a UUID for it.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Schema::create(<span class="hljs-string">'items'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    $table-&gt;uuid(<span class="hljs-string">'id'</span>)-&gt;primary();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    $table-&gt;text(<span class="hljs-string">'text'</span>)-&gt;nullable();</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>DB::statement(<span class="hljs-string">'ALTER TABLE items ALTER COLUMN id SET DEFAULT uuid_generate_v4();'</span>);</td></tr></table></code></pre><p>Then, in the model definition, you need to tell Laravel to cast the <code>id</code> field to a string, and explicitly set the primary key to <code>id</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">protected</span> $casts = [</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'string'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">protected</span> $primaryKey = <span class="hljs-string">"id"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>}</td></tr></table></code></pre><p>Once this is done, the model should generate the primary keys for you as usual, except as UUID’s. If your application needs to accept UUID primary keys that were created offline, such as in a mobile app, you will probably want to add the <code>id</code> field to the <code>$fillable</code> array on the model to allow this.</p></article><article class="post"><p class="date">2nd December 2017 11:30 pm</p><h1><a href="/blog/2017/12/02/full-text-search-with-laravel-and-postgresql/">Full Text Search With Laravel and Postgresql</a></h1><p>I’ve touched on <a href="/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">using PostgreSQL to implement fuzzy search with Laravel before</a>, but another type of search that PostgreSQL can handle fairly easily is full-text search. Here I’ll show you how to use it in a Laravel application.</p><p>An obvious use case for this kind of search is a personal blogging engine. It’s unlikely something like this is going to have enough content for it to be worth using a heavier solution like Elasticsearch, but a <code>LIKE</code> or <code>ILIKE</code> statement doesn’t really cut it either, so Postgres’s full text search is a good fit. Below you’ll see a Laravel migration for the blog posts table:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreatePostsTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'posts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;increments(<span class="hljs-string">'id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'title'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;datetime(<span class="hljs-string">'pub_date'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            $table-&gt;text(<span class="hljs-string">'text'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            $table-&gt;string(<span class="hljs-string">'slug'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            $table-&gt;integer(<span class="hljs-string">'author_id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        DB::statement(<span class="hljs-string">"ALTER TABLE posts ADD COLUMN searchtext TSVECTOR"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">"UPDATE posts SET searchtext = to_tsvector('english', title || '' || text)"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        DB::statement(<span class="hljs-string">"CREATE INDEX searchtext_gin ON posts USING GIN(searchtext)"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        DB::statement(<span class="hljs-string">"CREATE TRIGGER ts_searchtext BEFORE INSERT OR UPDATE ON posts FOR EACH ROW EXECUTE PROCEDURE tsvector_update_trigger('searchtext', 'pg_catalog.english', 'title', 'text')"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        DB::statement(<span class="hljs-string">"DROP TRIGGER IF EXISTS tsvector_update_trigger ON posts"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        DB::statement(<span class="hljs-string">"DROP INDEX IF EXISTS searchtext_gin"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        DB::statement(<span class="hljs-string">"ALTER TABLE posts DROP COLUMN searchtext"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        Schema::dropIfExists(<span class="hljs-string">'posts'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>}</td></tr></table></code></pre><p>Note that after we create the basic layout of our <code>posts</code> table, we then have to drop down to raw DB statements to achieve the next steps:</p><ul><li>We add a column called <code>searchtext</code> with a type of <code>TSVECTOR</code> (unfortunately Laravel doesn’t have a convenient method to create this column type, so we need to do it with a raw statement). This column will hold our searchable document.</li><li>We use the <code>to_tsvector()</code> method to generate a document on each row that combines the title and text fields and store it in the <code>searchtext</code> column. Note also that we specify the language as the first argument. This is because Postgres’s full text search understands so-called “stopwords”, which are words that are so common as to not be worth bothering with at all, such as “the” - these will obviously differ between languages, so it’s prudent to explicitly state this so Postgres knows what stopwords to expect.</li><li>We create a <code>GIN</code> index on the <code>posts</code> table using our new <code>searchtext</code> column.</li><li>Finally we create a trigger which, when the table is amended, regenerates the search text.</li></ul><p>With that done, we can now look at actually performing a full-text search. To facilitate easy re-use, we’ll create a local scope on our <code>Post</code> model. If you haven’t used scopes in Laravel before, they essentially allow you to break queries into reusable chunks. In this case, we expect our scope to receive two arguments, the query instance (which is passed through automatically), and the search text:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $fillable = [</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-string">'title'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-string">'pub_date'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-string">'text'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-string">'slug'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-string">'author_id'</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeSearch</span><span class="hljs-params">($query, $search)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> (!$search) {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">return</span> $query;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> $query-&gt;whereRaw(<span class="hljs-string">'searchtext @@ to_tsquery(\'english\', ?)'</span>, [$search])</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            -&gt;orderByRaw(<span class="hljs-string">'ts_rank(searchtext, to_tsquery(\'english\', ?)) DESC'</span>, [$search]);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>If <code>$search</code> is empty, we just return the query object as is. Otherwise, we first of all construct a <code>WHERE</code> clause that matches our search text against the <code>searchtext</code> column. Note the syntax used here:</p><pre><code class="hljs lang-sql singleline">searchtext @@ to_tsquery('english', 'foo')</code></pre><p>We use the <code>to_tsquery()</code> method to match our text against our search document. As before, note that we specify the language.</p><p>Finally, we specify an order - we want the highest ranked matches to appear first, and this section of the query does that:</p><pre><code class="hljs lang-sql singleline">ts_rank(searchtext, to_tsquery('english', 'foo')) DESC</code></pre><p>Here we use <code>ts_rank()</code> to ensure we get our results in the appropriate order. Note that for both queries, we passed the arguments through as parameterized queries, rather than constructing a raw string - we have to watch out for SQL injection when we’re writing raw queries, but we can use PDO’s parameterized queries from Eloquent in a raw statement, which makes things a bit easier.</p><p>Now we can call our new search scope as follows:</p><pre><code class="hljs lang-php singleline">$posts = Post::search($search)-&gt;get();</code></pre><p>Because the scope receives and returns a query builder instance, you can continue to add the rest of your query, or paginate it, as necessary:</p><pre><code class="hljs lang-php singleline">$posts = Post::search($search)-&gt;where(<span class="hljs-string">'draft'</span>, <span class="hljs-keyword">false</span>)-&gt;simplePaginate(<span class="hljs-number">5</span>);</code></pre><p>If you’re working in a language that makes heavy use of accents, such as French, you might also want to install the <code>unaccent</code> extension (you can do this in the migration with <code>CREATE EXTENSION unaccent</code>). Then, any time we call <code>to_tsvector()</code>, you should pass any strings through the <code>unaccent()</code> method to strip out the accents.</p><h2 id="do-we-need-the-migrations-">Do we need the migrations?</h2><p>Technically, we could do without the additional changes to the database structure - we could create a document on the fly inside a subquery and use that to query against, which would look something like this in SQL:</p><pre><code class="hljs lang-sql"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">SELECT</span> *</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">FROM</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  (<span class="hljs-keyword">SELECT</span> *,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>          to_tsvector(<span class="hljs-string">'english'</span>, posts.title) || to_tsvector(<span class="hljs-string">'english'</span>, posts.text) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">document</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-keyword">FROM</span> <span class="hljs-string">"posts"</span>) <span class="hljs-keyword">search</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">WHERE</span> search.document @@ to_tsquery(<span class="hljs-string">'Redis'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ts_rank(search.document, to_tsquery(<span class="hljs-string">'english'</span>, <span class="hljs-string">'Redis'</span>)) <span class="hljs-keyword">DESC</span>;</td></tr></table></code></pre><p>However, the performance is likely to be significantly worse using this approach as it has to recreate the document, and doesn’t have an existing index to query against. It’s also a pig to write something like this with an ORM.</p><p>I’m currently working on a more generic solution for implementing full text search with Postgres and Laravel, however so far it looks like that solution will not only be considerably more complex than this (consistently producing a suitable query for unknown data is rather fiddly), but you can’t create a column for the vector ahead of time, meaning the query will be slower. This approach, while it requires more work than simply installing a package, is not terribly hard to implement on a per-model basis and is easy to customise for your use case.</p></article><article class="post"><p class="date">28th November 2017 11:40 am</p><h1><a href="/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/">Building a Postcode Lookup Client With Httplug and Phpspec</a></h1><p>While PHPUnit is my normal go-to PHP testing framework, for some applications I find <a href="http://www.phpspec.net/en/stable/">PHPSpec</a> superior, in particular REST API clients. I’ve found that it makes for a better flow when doing test-driven development, because it makes it very natural to write a test first, then run it, then make the test pass.</p><p>In this tutorial I’ll show you how to build a lookup API client for UK postcodes. In the process of doing so, we’ll use PHPSpec to drive our development process. We’ll also use <a href="http://docs.php-http.org/en/latest/httplug/tutorial.html">HTTPlug</a> as our underlying HTTP library. The advantage of this over using something like Guzzle is that we give library users the freedom to choose the HTTP library they feel is most appropriate to their situation.</p><h2 id="background">Background</h2><p>If you’re unfamiliar with it, the UK postcode system is our equivalent of a zip code in the US, but with two major differences:</p><ul><li>The codes themselves are alphanumeric instead of numeric, with the first part including one or two letters usually (but not always) derived from the nearest large town or city (eg L for Liverpool, B for Birmingham, OX for Oxford), or for London, based on the part of the city (eg NW for the north-west of London)</li><li>A full postcode is in two parts (eg NW1 8TQ), and the first part narrows the location down to a similar area to a US-style zip code, while the second part usually narrows it down to a street (although sometimes large organisations that receive a lot of mail will have a postcode to themselves).</li></ul><p>This means that if you have someone’s postcode and house name or address, you can use those details to look up the rest of their address details. This obviously makes it easier for users to fill out a form, such as when placing an order on an e-commerce site - you can just request those two details and then autofill the rest from them.</p><p>Unfortunately, it’s not quite that simple. The data is owned by Royal Mail, and they charge through the nose for access to the raw data, which places this data well outside the budgets of many web app developers. Fortunately, <a href="https://ideal-postcodes.co.uk/">Ideal Postcodes</a> offer a REST API for querying this data. It’s not free, but at 2.5p per request it’s not going to break the bank unless used excessively, and they offer some dummy postcodes that are free to query, which is perfectly fine for testing.</p><p>For those of you outside the UK, this may not be of much immediate use, but the underlying principles will still be useful, and you can probably build a similar client for your own nation’s postal code system. For instance, there’s a <a href="https://www.zipcodeapi.com/API">Zipcode API</a> that those of you in the US can use, and if you understand what’s going on here it shouldn’t be hard to adapt it to work with that. If you do produce a similar client for your country’s postal code system, submit a pull request to update the README with a link to it and I’ll include it.</p><h2 id="setting-up">Setting up</h2><p>First we’ll create a <code>composer.json</code> to specify our dependencies:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/postcode-client"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A postcode lookup client."</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"library"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"keywords"</span>: [<span class="hljs-string">"postcode"</span>],</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attr">"require"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"psr/http-message"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"php-http/client-implementation"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">"php-http/httplug"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-attr">"php-http/message-factory"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-attr">"php-http/discovery"</span>: <span class="hljs-string">"^1.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-attr">"psy/psysh"</span>: <span class="hljs-string">"^0.8.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^3.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-attr">"squizlabs/php_codesniffer"</span>: <span class="hljs-string">"^2.7"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-attr">"php-http/mock-client"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-attr">"php-http/message"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attr">"guzzlehttp/psr7"</span>: <span class="hljs-string">"^1.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attr">"authors"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"matthewbdaly@gmail.com"</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    ],</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-attr">"Matthewbdaly\\Postcode\\"</span>: <span class="hljs-string">"src/"</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></tr></table></code></pre><p>Note that we don’t install an actual HTTPlug client, other than the mock one, which is only useful for testing. This is deliberate - we’re giving developers working with this library the choice of working with whatever HTTP client they see fit. We do use the Guzzle PSR7 library, but that’s just for the PSR7 library.</p><p>Then we install our dependencies:</p><pre><code class="hljs lang-bash singleline">$ composer install</code></pre><p>We also need to tell PHPSpec what our namespace will be. Save this as <code>phpspec.yml</code>:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-symbol">suites:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-symbol">    test_suite:</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-symbol">        namespace:</span> Matthewbdaly\Postcode</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-symbol">        psr4_prefix:</span> Matthewbdaly\Postcode</td></tr></table></code></pre><p>Don’t forget to update the namespace in both files to whatever you’re using, which should have a vendor name and a package name.</p><p>With that done, it’s time to introduce the next component.</p><h2 id="introducing-httplug">Introducing HTTPlug</h2><p>In the past I’ve usually used either Curl or Guzzle to carry out HTTP requests. However, the problem with this approach is that you’re forcing whoever uses your library to use whatever HTTP client, and whatever version of that client, that you deem appropriate. If they’re also using another library that someone else has written and they made different choices, you could have problems.</p><p>HTTPlug is an excellent way of solving this problem. By requiring only an interface and not a concrete implementation, using HTTPlug means that you can specify that the consumer of the library must provide a suitable implementation of that library, but leave the choice of implementation up to them. This means that they can choose whatever implementation best fits their use case. There are <a href="http://docs.php-http.org/en/latest/clients.html">adapters for many different clients</a>, so it’s unlikely that they won’t be able to find one that meets their needs.</p><p>In addition, HTTPlug provides the means to automatically determine what HTTP client to use, so that if one is not explicitly provided, it can be resolved without any action on the part of the developer. As long as a suitable HTTP adapter is installed, it will be used.</p><h2 id="getting-started">Getting started</h2><p>One advantage of PHPSpec is that it will automatically generate much of the boilerplate for our client and specs. To create our client spec, run this command:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec desc Matthewbdaly/Postcode/Client</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Specification <span class="hljs-keyword">for</span> Matthewbdaly\Postcode\Client created <span class="hljs-keyword">in</span> /home/matthew/Projects/postcode-client/spec/ClientSpec.php.</td></tr></table></code></pre><p>Now that we have a spec for our client, we can generate the client itself:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  11  - it is initializable</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      class Matthewbdaly\Postcode\Client does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>1 example (1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>14ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client` <span class="hljs-keyword">for</span> you?              </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Class Matthewbdaly\Postcode\Client created <span class="hljs-keyword">in</span> /home/matthew/Projects/postcode-client/src/Client.php.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>1 example (1 passed)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>16ms</td></tr></table></code></pre><p>You will need to enter <code>Y</code> when prompted. We now have an empty class for our client.</p><p>Next, we need to make sure that the constructor for our client accepts two parameters:</p><ul><li>The HTTP client</li><li>A message factory instance, which is used to create the request</li></ul><p>Amend <code>spec/ClientSpec.php</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Client</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Client</span>\<span class="hljs-title">HttpClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageFactory</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">let</span> <span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(Client::class);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>}</td></tr></table></code></pre><p>Note the use of the <code>let()</code> method here. This lets us specify how the object is constructed, with the <code>beConstructedWith()</code> method. Also, note that <code>$this</code> refers not to the test, but to the object being tested - this takes a bit of getting used to if you’re used to working with PHPUnit.</p><p>Also, note that the objects passed through are not actual instances of those objects - instead they are mocks created automatically by PHPSpec. This makes mocking extremely easy, and you can easily set up your own expectations on those mock objects in the test. If you want to use a real object, you can instantiate it in the spec as usual. If we need any other mocks, we can typehint them in our method in exactly the same way.</p><p>If we once again use <code>vendor/bin/phpspec run</code> we can now generate a constructor:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  18  - it is initializable</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::__construct not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>1 example (1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>281ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::__construct()` <span class="hljs-keyword">for</span>    </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  you?                                                                          </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Method Matthewbdaly\Postcode\Client::__construct() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>1 example (1 passed)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>50ms</td></tr></table></code></pre><p>This will only create a placeholder for the constructor. You need to populate it yourself, so update <code>src/Client.php</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Client</span>\<span class="hljs-title">HttpClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Discovery</span>\<span class="hljs-title">HttpClientDiscovery</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageFactory</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Discovery</span>\<span class="hljs-title">MessageFactoryDiscovery</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(HttpClient $client = null, MessageFactory $messageFactory = null)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;client = $client ?: HttpClientDiscovery::find();</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;messageFactory = $messageFactory ?: MessageFactoryDiscovery::find();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>A little explanation is called for here. We need two arguments in our construct:</p><ul><li>An instance of <code>Http\Client\HttpClient</code> to send the request</li><li>An instance of <code>Http\Message\MessageFactory</code> to create the request</li></ul><p>However, we don’t want to force the user to create one. Therefore if they are not set, we use <code>Http\Discovery\HttpClientDiscovery</code> and <code>Http\Discovery\MessageFactoryDiscovery</code> to create them for us.</p><p>If we re-run PHPSpec, it should now pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>1 example (1 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>31ms</td></tr></table></code></pre><p>Next, we want to have a method for retrieving the endpoint. Add the following method to <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_retrieve_the_base_url</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getBaseUrl()-&gt;shouldReturn(<span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr></table></code></pre><p>Here we’re asserting that fetching the base URL returns the given result. Note how much simpler and more intuitive this syntax is than PHPUnit would be:</p><pre><code class="hljs lang-php singleline"><span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>, $client-&gt;getBaseUrl());</code></pre><p>Running the tests again should prompt us to create the boilerplate for the new method:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  23  - it can retrieve the base url</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::getBaseUrl not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                  50%                                     50%                    2</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>2 examples (1 passed, 1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>40ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::getBaseUrl()` <span class="hljs-keyword">for</span>     </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  you?                                                                          </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Method Matthewbdaly\Postcode\Client::getBaseUrl() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  23  - it can retrieve the base url</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      expected <span class="hljs-string">"https://api.ideal-postcod..."</span>, but got null.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                  50%                                     50%                    2</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>2 examples (1 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>72ms</td></tr></table></code></pre><p>Now we need to update that method to work as expected:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $baseUrl = <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>     ...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBaseUrl</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;baseUrl;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr></table></code></pre><p>This should make the tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       2</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>2 examples (2 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>34ms</td></tr></table></code></pre><p>Next, we need to be able to get and set the API key. Add the following to <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_get_and_set_the_key</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getKey()-&gt;shouldReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>)-&gt;shouldReturn(<span class="hljs-keyword">$this</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getKey()-&gt;shouldReturn(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></tr></table></code></pre><p>Note that we expect <code>$this-&gt;setKey(&#39;foo&#39;)</code> to return <code>$this</code>. This is an example of a <em>fluent</em> interface - by returning an instance of the object, it enables methods to be chained, eg <code>$client-&gt;setKey(&#39;foo&#39;)-&gt;get()</code>. Obviously it won’t work for anything that has to return a value, but it’s a useful way of making your classes more intuitive to use.</p><p>Next, run the tests again and agree to the prompts as before:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::getKey not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                         66%                                     33%             3</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>3 examples (2 passed, 1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>51ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::getKey()` <span class="hljs-keyword">for</span> you?    </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  Method Matthewbdaly\Postcode\Client::getKey() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      method Matthewbdaly\Postcode\Client::setKey not found.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                         66%                                     33%             3</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>3 examples (2 passed, 1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>43ms</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::setKey()` <span class="hljs-keyword">for</span> you?    </td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>  Method Matthewbdaly\Postcode\Client::setKey() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>      expected [obj:Matthewbdaly\Postcode\Client], but got null.</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>                         66%                                     33%             3</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>3 examples (2 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>52ms</td></tr></table></code></pre><p>Next, add our getter and setter for the key, as well as declaring the property <code>$key</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $key;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getKey</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;key;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setKey</span><span class="hljs-params">(string $key)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">$this</span>-&gt;key = $key;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr></table></code></pre><p>That should make the tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       3</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>3 examples (3 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>38ms</td></tr></table></code></pre><p>With that done, our final task is to be able to handle sending requests. Add the following imports at the top of <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">RequestInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">ResponseInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">StreamInterface</span>;</td></tr></table></code></pre><p>And add the following method at the bottom of the same file:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_send_the_request</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        $data = json_encode([</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'result'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>                <span class="hljs-string">"postcode"</span> =&gt; <span class="hljs-string">"SW1A 2AA"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>                <span class="hljs-string">"postcode_inward"</span> =&gt; <span class="hljs-string">"2AA"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-string">"postcode_outward"</span> =&gt; <span class="hljs-string">"SW1A"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-string">"post_town"</span> =&gt; <span class="hljs-string">"LONDON"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-string">"dependant_locality"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                <span class="hljs-string">"double_dependant_locality"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-string">"thoroughfare"</span> =&gt; <span class="hljs-string">"Downing Street"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">"dependant_thoroughfare"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                <span class="hljs-string">"building_number"</span> =&gt; <span class="hljs-string">"10"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                <span class="hljs-string">"building_name"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                <span class="hljs-string">"sub_building_name"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>                <span class="hljs-string">"po_box"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>                <span class="hljs-string">"department_name"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>                <span class="hljs-string">"organisation_name"</span> =&gt; <span class="hljs-string">"Prime Minister &amp; First Lord Of The Treasury"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                <span class="hljs-string">"udprn"</span> =&gt; <span class="hljs-number">23747771</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">"umprn"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>                <span class="hljs-string">"postcode_type"</span> =&gt; <span class="hljs-string">"L"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>                <span class="hljs-string">"su_organisation_indicator"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>                <span class="hljs-string">"delivery_point_suffix"</span> =&gt; <span class="hljs-string">"1A"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>                <span class="hljs-string">"line_1"</span> =&gt; <span class="hljs-string">"Prime Minister &amp; First Lord Of The Treasury"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>                <span class="hljs-string">"line_2"</span> =&gt; <span class="hljs-string">"10 Downing Street"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>                <span class="hljs-string">"line_3"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>                <span class="hljs-string">"premise"</span> =&gt; <span class="hljs-string">"10"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                <span class="hljs-string">"longitude"</span> =&gt; <span class="hljs-number">-0.127695242183412</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>                <span class="hljs-string">"latitude"</span> =&gt; <span class="hljs-number">51.5035398826274</span>,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-string">"eastings"</span> =&gt; <span class="hljs-number">530047</span>,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>                <span class="hljs-string">"northings"</span> =&gt; <span class="hljs-number">179951</span>,</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-string">"country"</span> =&gt; <span class="hljs-string">"England"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>                <span class="hljs-string">"traditional_county"</span> =&gt; <span class="hljs-string">"Greater London"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>                <span class="hljs-string">"administrative_county"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>                <span class="hljs-string">"postal_county"</span> =&gt; <span class="hljs-string">"London"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>                <span class="hljs-string">"county"</span> =&gt; <span class="hljs-string">"London"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>            ]</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        $response-&gt;getBody()-&gt;willReturn($stream);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        $stream-&gt;getContents()-&gt;willReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'SW1A 2AA'</span>)-&gt;shouldBeLike(json_decode($data, <span class="hljs-keyword">true</span>));</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    }</td></tr></table></code></pre><p>This test is by far the biggest so far, so it merits some degree of explanation.</p><p>Note that we don’t make a real HTTP request against the API. This may sound strange, but bear with me. We have no control whatsoever over that API, and it could in theory become inaccessible or be subject to breaking changes at any time. We also don’t want to be shelling out for a paid service just to test our API client works. All we can do is test that our implementation will send the request we expect it to send - we don’t want our test suite reporting a bug when the API goes down.</p><p>We therefore typehint not just the dependencies for the constructor, but a request, response and stream instance. We mock our our responses from those instances using the <code>willReturn()</code> method, so we have complete control over what we pass to our client. That way we can return any appropriate response or throw any exception we deem fit to test the behaviour under those circumstances. For the message factory, we specify what arguments it should receive to create the request, and return our mocked-out request object.</p><p>Also, note we use <code>shouldBeLike()</code> to verify the response - this is effectively using the <code>==</code> operator, whereas <code>shouldBe()</code> uses the <code>===</code> operator, making it stricter.</p><p>Let’s run the tests, and don’t forget the prompt:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-number">38</span>  - it can send the request</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::get not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                            <span class="hljs-number">75</span>%                                     <span class="hljs-number">25</span>%          <span class="hljs-number">4</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-number">1</span> specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-number">4</span> examples (<span class="hljs-number">3</span> passed, <span class="hljs-number">1</span> broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-number">55</span>ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-keyword">Do</span> you want me to create `Matthewbdaly\Postcode\Client::get()` <span class="hljs-keyword">for</span> you?       </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  Method Matthewbdaly\Postcode\Client::get() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-number">38</span>  - it can send the request</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      expected [<span class="hljs-keyword">array</span>:<span class="hljs-number">1</span>], but got <span class="hljs-keyword">null</span>.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                            <span class="hljs-number">75</span>%                                     <span class="hljs-number">25</span>%          <span class="hljs-number">4</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td><span class="hljs-number">1</span> specs</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-number">4</span> examples (<span class="hljs-number">3</span> passed, <span class="hljs-number">1</span> failed)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-number">56</span>ms</td></tr></table></code></pre><p>Now we can implement the <code>get()</code> method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">'GET'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            $url,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            [],</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-keyword">null</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-string">'1.1'</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> $data;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr></table></code></pre><p>We first build up our URL, before using the message factory to create a request object. We then pass the built request to our client to send, before decoding the response into the format we want.</p><p>This should make our tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       4</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>4 examples (4 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>307ms</td></tr></table></code></pre><p>Our client now works, but there are a couple of situations we need to account for. First, the API will raise a 402 if you make a request for a real postcode without having paid. We need to catch this and throw an exception. Add this to <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PaymentRequired</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_throws_an_exception_if_payment_required</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">402</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(PaymentRequired::class)-&gt;duringGet(<span class="hljs-string">'SW1A 2AA'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></tr></table></code></pre><p>With that done, run the tests again:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  87  - it throws an exception <span class="hljs-keyword">if</span> payment required</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      [exc:Prophecy\Exception\Call\UnexpectedCallException(<span class="hljs-string">"Method call:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        - getBody()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      on Double\ResponseInterface\P15 was not expected, expected calls were:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        - getStatusCode()")].</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                              80%                                     20%        5</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>5 examples (4 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>130ms</td></tr></table></code></pre><p>Let’s amend the client to throw this exception:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PaymentRequired</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-string">'GET'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            $url,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            [],</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-keyword">null</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-string">'1.1'</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">402</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PaymentRequired;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> $data;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    }</td></tr></table></code></pre><p>And let’s re-run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  87  - it throws an exception <span class="hljs-keyword">if</span> payment required</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got [obj:Error] with the</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      message: <span class="hljs-string">"Class 'Matthewbdaly\Postcode\Exceptions\PaymentRequired' not found"</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>                              80%                                     20%        5</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>5 examples (4 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>389ms</td></tr></table></code></pre><p>It fails now because the exception doesn’t exist. Let’s create it at <code>src/Exceptions/PaymentRequired.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentRequired</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td></tr></table></code></pre><p>That should be enough to make our tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       5</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>5 examples (5 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>89ms</td></tr></table></code></pre><p>We also need to raise an exception when the postcode is not found, which raises a 404 error. Add the following spec:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PostcodeNotFound</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_throws_an_exception_if_postcode_not_found</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">404</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(PostcodeNotFound::class)-&gt;duringGet(<span class="hljs-string">'SW1A 2AA'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    }</td></tr></table></code></pre><p>Run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  98  - it throws an exception <span class="hljs-keyword">if</span> postcode not found</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      [exc:Prophecy\Exception\Call\UnexpectedCallException(<span class="hljs-string">"Method call:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        - getBody()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      on Double\ResponseInterface\P20 was not expected, expected calls were:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        - getStatusCode()")].</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                                83%                                     16%      6</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>6 examples (5 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>538ms</td></tr></table></code></pre><p>This time we’ll create the exception class before updating the client. Create the following class at <code>src/Exceptions/PostcodeNotFound.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> * Postcode not found exception</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> *</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostcodeNotFound</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>And update the client:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PostcodeNotFound</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-string">'GET'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            $url,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            [],</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">null</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'1.1'</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">402</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PaymentRequired;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">404</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PostcodeNotFound;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> $data;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr></table></code></pre><p>Re-run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       6</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>6 examples (6 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>103ms</td></tr></table></code></pre><p>And our API client is feature complete! You can find the source code of the finished client <a href="https://github.com/matthewbdaly/postcode-client">here</a>.</p><h2 id="summary">Summary</h2><p>Personally, I find that while PHPSpec isn’t appropriate for every use case, it’s particularly handy for API clients and it’s generally my go-to testing solution for them. It handles producing a lot of the boilerplate for me, and it results in a much better workflow for test-driven development as it makes it very natural to write the test first, then make it pass.</p><p>HTTPlug has been a revelation for me. While it takes a bit of getting used to if you’re used to something like Guzzle, it means that you’re giving consumers of your library the freedom to choose the HTTP client of their choice, meaning they don’t have to fight with several different libraries requiring different versions of Guzzle. It also allows for easy resolution of the HTTP client, rather than having to explicitly pass through an instance when instantiating your client. I’m planning to use it extensively in the future.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/09/25/career-direction-after-seven-years/">Career Direction After Seven Years</a></p><p><a href="/blog/2018/09/24/how-i&#x27;m-refactoring-a-zend-1-legacy-project/">How I&#x27;m Refactoring a Zend 1 Legacy Project</a></p><p><a href="/blog/2018/09/13/mutation-testing-with-infection/">Mutation Testing With Infection</a></p><p><a href="/blog/2018/09/09/switching-from-vim-to-neovim/">Switching from Vim to Neovim</a></p><p><a href="/blog/2018/07/25/better-strings-in-php/">Better Strings in PHP</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/6/">Newer</a></li><li><a href="/posts/8/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>