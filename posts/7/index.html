<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/7/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">20th October 2017 10:55 pm</p><h1><a href="/blog/2017/10/20/using-phpiredis-with-laravel/">Using Phpiredis With Laravel</a></h1><p>Laravel has support out of the box for using Redis. However, by default it uses a Redis client written in PHP, which will always be a little slower than one written in C. If you’re making heavy use of Redis, it may be worth using the <a href="https://github.com/nrk/phpiredis">phpiredis</a> extension to squeeze a little more performance out of it.</p><p>I’m using PHP 7.0 on Ubuntu Zesty and I installed the dependencies with the following command:</p><pre><code class="hljs lang-bash singleline">$ sudo apt-get install libhiredis-dev php-redis php7.0-dev</code></pre><p>Then I installed phpiredis as follows:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>git <span class="hljs-built_in">clone</span> https://github.com/nrk/phpiredis.git &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>       <span class="hljs-built_in">cd</span> phpiredis &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>       phpize &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>       ./configure --enable-phpiredis &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>       make &amp;&amp; \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>       sudo make install</td></tr></table></code></pre><p>Finally, I configured Redis to use phpiredis in the <code>redis</code> section of <code>config/database.php</code> for a Laravel app:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-string">'redis'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'cluster'</span> =&gt; <span class="hljs-keyword">false</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-string">'default'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'host'</span>     =&gt; env(<span class="hljs-string">'REDIS_HOST'</span>, <span class="hljs-string">'localhost'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">'password'</span> =&gt; env(<span class="hljs-string">'REDIS_PASSWORD'</span>, <span class="hljs-keyword">null</span>),</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">'port'</span>     =&gt; env(<span class="hljs-string">'REDIS_PORT'</span>, <span class="hljs-number">6379</span>),</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-string">'database'</span> =&gt; <span class="hljs-number">0</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-string">'options'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-string">'connections'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                    <span class="hljs-string">'tcp'</span> =&gt; <span class="hljs-string">'Predis\Connection\PhpiredisStreamConnection'</span>, <span class="hljs-comment">// PHP streams</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                    <span class="hljs-string">'unix'</span> =&gt; <span class="hljs-string">'Predis\Connection\PhpiredisSocketConnection'</span>, <span class="hljs-comment">// ext-socket</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                ],</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            ]</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        ],</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    ],</td></tr></table></code></pre><p>Now, I’m going to be honest - in a casual comparison I couldn’t see much difference in terms of speed. I would probably only bother with setting this up on a site where high Redis performance was absolutely necessary. If you just want a quicker cache response it might make more sense to put Varnish in front of the site instead. However, in cases where Redis gets used heavily, it’s probably worth doing.</p></article><article class="post"><p class="date">3rd October 2017 11:56 pm</p><h1><a href="/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">Simple Fuzzy Search With Laravel and Postgresql</a></h1><p>When implementing fuzzy search, many developers reach straight for specialised tools like Elasticsearch. However, for simple implementations, this is often overkill. PostgreSQL, my relational database of choice, can natively handle fuzzy search quite easily if you know how. Here’s how you might use this with Laravel.</p><p>Suppose we have the following migration to create a <code>locations</code> table, storing towns, cities and villages:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateLocations</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-comment">// Create locations table</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'locations'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;increments(<span class="hljs-string">'id'</span>)-&gt;unsigned();</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'name'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Drop locations table</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        Schema::drop(<span class="hljs-string">'locations'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></tr></table></code></pre><p>The key to this implementation of fuzzy search is <em>trigrams</em>. A trigram is a group of three consecutive characters taken from a string. Using the <code>pg_trgm</code> module, which comes with PostgreSQL, we can break a string into as many trigrams as possible, and then return the strings with the most matching trigrams.</p><p>We can ensure that <code>pg_trgm</code> is set up on the database by creating a migration:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddTrgmExtension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">'DROP EXTENSION IF EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>Make sure you run the migration as well. Once that is done, we can make a raw fuzzy query against the <code>name</code> field as follows:</p><pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locations <span class="hljs-keyword">WHERE</span> <span class="hljs-string">'burgh'</span> % <span class="hljs-keyword">name</span>;</code></pre><p>Translating that to work with the Eloquent ORM, we can perform fuzzy queries against the <code>name</code> field as follows:</p><pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"'burgh' % name"</span>)-&gt;get();</code></pre><p>This query might match both <code>Aldeburgh</code> and <code>Edinburgh</code>. It’s also able to handle slight misspellings, as in this example:</p><pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"'hendrad' % name"</span>)-&gt;get();</code></pre><p>This query will match <code>East Hendred</code> or <code>West Hendred</code> successfully. As you can see, we can match strings at any point in the name string, and handle slight mis-spellings without any problems.</p><p>In practice, rather than using <code>whereRaw()</code> every time, you’ll probably want to create a local scope that accepts the name you want to match against. You’ll also want to use query parameters to prevent SQL injection:</p><pre><code class="hljs lang-php singleline">$location = Location::whereRaw(<span class="hljs-string">"? % name"</span>, [$name])-&gt;get();</code></pre><h2 id="improving-performance-with-an-index">Improving performance with an index</h2><p>The performance of these queries isn’t that great out of the box. We can improve them by creating an index:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddTrgmExtension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        DB::statement(<span class="hljs-string">'CREATE INDEX locations_name_trigram ON locations USING gist(name gist_trgm_ops);'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        DB::statement(<span class="hljs-string">'DROP INDEX IF EXISTS locations_name_trigram'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        DB::statement(<span class="hljs-string">'DROP EXTENSION IF EXISTS pg_trgm'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Adding an index should produce a noticeable improvement in the response time.</p><h2 id="final-thoughts">Final thoughts</h2><p>PostgreSQL’s <code>pg_trgm</code> module is a fairly straightforward way of implementing fuzzy search. It’s not much more involved than a <code>LIKE</code> or <code>ILIKE</code> clause in your query, and for many use cases, it’s more than sufficient. If you don’t have a huge number of records, it’s probably a more appropriate choice than something like Elasticsearch, and has the advantage of a simpler stack. However, if you have a larger dataset, you may be better off with a dedicated search solution. As always, if you’re unsure it’s a good idea to try both and see what works best for that particular use case.</p></article><article class="post"><p class="date">25th September 2017 10:18 pm</p><h1><a href="/blog/2017/09/25/a-generic-php-sms-library/">A Generic PHP SMS Library</a></h1><p>This weekend I published <a href="https://github.com/matthewbdaly/sms-client">sms-client</a>, a generic PHP library for sending SMS notifications. It’s intended to offer a consistent interface when sending SMS notifications by using swappable drivers. That way, if your SMS service provider suddenly goes out of business or bumps up their prices, it’s easy to switch to a new one.</p><p>Out of the box it comes with drivers for the following services:</p><ul><li>Nexmo</li><li>ClockworkSMS</li></ul><p>In addition, it provides the following test drivers:</p><ul><li>Null</li><li>Log</li><li>RequestBin</li></ul><p>Here’s an example of how you might use it with the ClockworkSMS driver:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Client</span> <span class="hljs-title">as</span> <span class="hljs-title">GuzzleClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Psr7</span>\<span class="hljs-title">Response</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">SMS</span>\<span class="hljs-title">Drivers</span>\<span class="hljs-title">Clockwork</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">SMS</span>\<span class="hljs-title">Client</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>$guzzle = <span class="hljs-keyword">new</span> GuzzleClient;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>$resp = <span class="hljs-keyword">new</span> Response;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>$driver = <span class="hljs-keyword">new</span> Clockwork($guzzle, $resp, [</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-string">'MY_CLOCKWORK_API_KEY'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>]);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$client = <span class="hljs-keyword">new</span> Client($driver);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>$msg = [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-string">'to'</span>      =&gt; <span class="hljs-string">'+44 01234 567890'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-string">'content'</span> =&gt; <span class="hljs-string">'Just testing'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>];</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>$client-&gt;send($msg);</td></tr></table></code></pre><p>If you want to roll your own driver for it, it should be easy - just create a class that implements the <code>Matthewbdaly\SMS\Contracts\Driver</code> interface. Most of the existing drivers work using Guzzle to send HTTP requests to an API, but you don’t necessarily have to do that - for instance, you could create a driver for a mail-to-SMS gateway by using Swiftmailer or the PHP mail class. If you create a driver for it, please feel free to submit a pull request so I can add it to the repository.</p><p>For Laravel or Lumen users, there’s <a href="https://github.com/matthewbdaly/laravel-sms">an integration package</a> that should make it easier to use. For users of other frameworks, it should still be fairly straightforward to integrate.</p></article><article class="post"><p class="date">8th September 2017 10:05 pm</p><h1><a href="/blog/2017/09/08/installing-nginx-unit-on-ubuntu/">Installing Nginx Unit on Ubuntu</a></h1><p>Recently Nginx announced the release of the first beta of <a href="https://www.nginx.com/products/nginx-unit/">Unit</a>, an application server that supports Python, PHP and Go, with support coming for Java, Node.js and Ruby.</p><p>The really interesting part is that not only does it support more than one language, but Unit can be configured by making HTTP requests, rather than by editing config files. This makes it potentially very interesting to web developers like myself who have worked in multiple languages - I could use it to serve a Python or PHP web app, simply by making different requests during the setup process. I can see this being a boon for SaaS providers - you could pick up the language from a file, much like the <code>runtime.txt</code> used by Heroku, and set up the application on the fly.</p><p>It’s currently in public beta, and there are packages for Ubuntu, so I decided to try it out. I’ve created the Ansible role below to set up Unit on an Ubuntu 16.04 server or VM:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>-<span class="ruby">--</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Install keys</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  apt_key: url=http://nginx.org/keys/nginx_signing.key state=present</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Setup main repo</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  apt_repository: repo='deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx' state=present</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Setup source rep</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  apt_repository: repo='deb-src http://nginx.org/packages/mainline/ubuntu/ xenial nginx' state=present</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Update system</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  apt: upgrade=full update_cache=yes</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Install dependencies</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  apt: name={{ item }} state=present</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  with_items:</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    -<span class="ruby"> nginx</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    -<span class="ruby"> unit</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    -<span class="ruby"> golang</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    -<span class="ruby"> php-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    -<span class="ruby"> libphp-embed</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    -<span class="ruby"> libphp7.<span class="hljs-number">0</span>-embed</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    -<span class="ruby"> python-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    -<span class="ruby"> python3</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    -<span class="ruby"> python3-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-cli</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-mcrypt</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-pgsql</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-sqlite3</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-opcache</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-curl</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-mbstring</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-dom</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-xml</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-zip</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-bcmath</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Copy over Nginx configuration</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>  copy: src=nginx.conf dest=/etc/nginx/sites-available/default owner=root group=root mode=0644</td></tr></table></code></pre><p>Note the section that copies over the Nginx config file. Here is that file:</p><pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute">upstream</span> unit_backend {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8300</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-section">server</span> {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server ipv6only=<span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>; </td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-attribute">root</span> /var/www/public;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">index</span> index.php index.html index.htm;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attribute">server_name</span> server_domain_or_IP;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">location</span> / { </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.php?<span class="hljs-variable">$query_string</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }   </td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /index.php =<span class="hljs-number">404</span>;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-attribute">proxy_pass</span> http://unit_backend;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }   </td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>This setup proxies all dynamic requests to the Unit backend in a similar fashion to how it would normally pass it to PHP-FPM.</p><p>There were still a few little issues. It doesn’t exactly help that the Nginx package provided with this repository isn’t quite the same as the one in Ubuntu by default - not only is it the unstable version, but it doesn’t set up the <code>sites-available</code> and <code>sites-enabled</code> folders, so I had to do that manually. I also had an issue with Systemd starting the process (at <code>/run/control.unit.sock</code>) with permissions that didn’t allow Nginx to access it. I’m not that familiar with Systemd so I wound up just setting the permissions of the file manually, but that doesn’t persist between restarts. I expect this issue isn’t that big a deal to someone more familiar with Systemd, but I haven’t been able to resolve it yet.</p><p>I decided to try it out with a Laravel application. I created a new Laravel app and set it up with the web root at <code>/var/www</code>. I then saved the following configuration for it as <code>app.json</code>:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"listeners"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-attr">"*:8300"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-attr">"application"</span>: <span class="hljs-string">"myapp"</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attr">"applications"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"myapp"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-attr">"type"</span>: <span class="hljs-string">"php"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-attr">"workers"</span>: <span class="hljs-number">20</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-attr">"user"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-attr">"group"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-attr">"root"</span>: <span class="hljs-string">"/var/www/public"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-attr">"index"</span>: <span class="hljs-string">"index.php"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>This is fairly basic, but a good example of how you configure an application with Unit. The <code>listener</code> section maps a port to an application, while the <code>applications</code> section defines an application called <code>myapp</code>. In this case, we specify that the type should be <code>php</code>. Note that each platform has slightly different options - for instance, the Python type doesn’t have the <code>index</code> or <code>root</code> options, instead having the <code>path</code> option, which specifies the path to the <code>wsgi.py</code> file.</p><p>I then ran the following command to upload the file:</p><pre><code class="hljs lang-bash singleline">$ curl -X PUT <span class="hljs-_">-d</span> @app.json --unix-socket /run/control.unit.sock http://localhost</code></pre><p>Note that we send it direct to the Unix socket file - this way we don’t have to expose the API to the outside. After this was done, the Laravel app began working as expected.</p><p>We can then make a GET request to view the configured applications:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ curl --unix-socket /run/control.unit.sock http://localhost/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">"listeners"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>                <span class="hljs-string">"*:8300"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>                        <span class="hljs-string">"application"</span>: <span class="hljs-string">"saas"</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                }</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        },</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-string">"applications"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-string">"saas"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"php"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                        <span class="hljs-string">"workers"</span>: 20,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                        <span class="hljs-string">"user"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                        <span class="hljs-string">"group"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                        <span class="hljs-string">"root"</span>: <span class="hljs-string">"/var/www/public"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                        <span class="hljs-string">"index"</span>: <span class="hljs-string">"index.php"</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>It’s also possible to update and delete existing applications via the API using PUT and DELETE requests.</p><h2 id="final-thoughts">Final thoughts</h2><p>This is <em>way</em> too early to be seriously considering using Unit in production. It’s only just been released as a public beta, and it’s a bit fiddly to set up. However, it has an enormous amount of promise.</p><p>One thing I can’t really see right now is whether it’s possible to use a virtualenv with it for Python applications. In the Python community it’s standard practice to use Virtualenv to isolate the dependencies for individual applications, and it’s not clear how I’d be able to go about using this, if it is possible. For deploying Python applications, lack of virtualenv support would be a deal breaker, and I hope this gets clarified soon.</p><p>I’d also be curious to see benchmarks of how it compares to something like PHP-FPM. It’s quite possible that it may be less performant than other solutions. However, I will keep a close eye on this in future.</p></article><article class="post"><p class="date">2nd September 2017 2:45 pm</p><h1><a href="/blog/2017/09/02/making-internal-requests-with-laravel/">Making Internal Requests With Laravel</a></h1><p>Recently I’ve been working on a Phonegap app that needs to work offline. The nature of relational databases can often make this tricky if you’re dealing with related objects and you’re trying to retrofit it to something that wasn’t built with this use case in mind.</p><p>Originally my plan was to push each request that would have been made to a queue in WebSQL, and then on reconnect, make every request individually. It quickly became apparent, however, that this approach had a few problems:</p><ul><li>If one request failed, the remaining requests had to be stopped from executing</li><li>It didn’t allow for storing the failed transactions in a way that made them easy to retrieve</li></ul><p>Instead, I decided to create a single <code>sync</code> endpoint for the API that would accept an object containing all the requests that would be made, and then step through each one. If it failed, it would get the failed request and all subsequent ones in the object, and store them in the database. That way, even if the data didn’t sync correctly, it wasn’t lost, and if necessary it could be resolved manually.</p><p>Since the necessary API endpoints already existed, and were thoroughly tested, it was not a good idea to start duplicating that functionality. Instead, I implemented the functionality to carry out internal requests, and I thought I’d share how you can do this.</p><p>For any service you may build for your Laravel applications, it’s a good idea to create an interface for it first:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MakesInternalRequests</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Make an internal request</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@param</span> string $action   The HTTP verb to use.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@param</span> string $resource The API resource to look up.</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> array  $data     The request body.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span><span class="hljs-params">(string $action, string $resource, array $data = [])</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>That way you can resolve the service using dependency injection, making it trivial to replace it with a mock when testing.</p><p>Now, actually making an internal request is pretty easy. You get the app instance (you can do so by resolving it using dependency injection as I do below, or call the <code>app()</code> helper). Then you put together the request you want to make and pass it as an argument to the app’s <code>handle()</code> method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MakesInternalRequests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Application</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">FailedInternalRequestException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> * Internal request service</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MakesInternalRequests</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * The app instance</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * <span class="hljs-doctag">@var</span> $app</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">protected</span> $app;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * Constructor</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@param</span> Application $app        The app instance.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Application $app)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app = $app;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     * Make an internal request</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     * <span class="hljs-doctag">@param</span> string $action   The HTTP verb to use.</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>     * <span class="hljs-doctag">@param</span> string $resource The API resource to look up.</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@param</span> array  $data     The request body.</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     * <span class="hljs-doctag">@throws</span> FailedInternalRequestException Request could not be synced.</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span><span class="hljs-params">(string $action, string $resource, array $data = [])</span></span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        $request = Request::create(<span class="hljs-string">'/api/'</span> . $resource, $action, $data, [], [], [</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>            <span class="hljs-string">'HTTP_Accept'</span>             =&gt; <span class="hljs-string">'application/json'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-comment">// Get response</span></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;app-&gt;handle($request);</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() &gt;= <span class="hljs-number">400</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FailedInternalRequestException($request, $response);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-comment">// Dispatch the request</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>}</td></tr></table></code></pre><p>Also note that I’ve created a custom exception, called <code>FailedInternalRequestException</code>. This is fired if the status code returned from the internal requests is greater than or equal to 400 (thus denoting an error):</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Response</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td> * Exception for when a bulk sync job fails</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FailedInternalRequestException</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * Request instance</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@var</span> $request</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> $request;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Response instance</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@var</span> $response</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">protected</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     * Constructor</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>     * <span class="hljs-doctag">@param</span> Request  $request  The request object.</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * <span class="hljs-doctag">@param</span> Response $response The response object.</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Request $request, Response $response)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">parent</span>::__construct();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">$this</span>-&gt;request = $request;</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;response = $response;</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * Get request object</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> Request</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequest</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;request;</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>     * Get response object</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * <span class="hljs-doctag">@return</span> Response</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getResponse</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;response;</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>}</td></tr></table></code></pre><p>You can catch this exception in an appropriate place and handle it as you wish. Now, if you import the internal request class as <code>$dispatcher</code>, you can just call <code>$dispatcher-&gt;request($action, $resource, $data)</code>, where <code>$action</code> is the HTTP verb, <code>$resource</code> is the API resource to send to, and <code>$data</code> is the data to send.</p><p>It’s actually quite rare to have to do this. In this case, because this was a REST API and every request made to it was changing the state of the application (there were no GET requests, only POST, PUT, PATCH and DELETE), it made sense to just break down the request body and do internal requests against the existing API, since otherwise I’d have to duplicate the existing functionality. I would not recommend this approach for something like fetching data to render a page on the server side, as there are more efficient ways of accomplishing it. In all honesty I can’t think of any other scenario where this would genuinely be the best option. However, it worked well for my use case and allowed me to implement this functionality quickly and simply.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/">Building a Letter Classifier in PHP With Tesseract OCR and PHP ML</a></p><p><a href="/blog/2018/04/29/console-applications-with-the-symfony-console-component/">Console Applications With the Symfony Console Component</a></p><p><a href="/blog/2018/04/22/rendering-different-views-for-mobile-and-desktop-clients-in-laravel/">Rendering Different Views for Mobile and Desktop Clients in Laravel</a></p><p><a href="/blog/2018/04/12/making-wordpress-less-shit/">Making Wordpress Less Shit</a></p><p><a href="/blog/2018/03/10/using-stored-procedures-in-your-web-app/">Using Stored Procedures in Your Web App</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/6/">Newer</a></li><li><a href="/posts/8/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>