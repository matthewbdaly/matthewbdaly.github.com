<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/20/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">26th March 2016 9:30 pm</p><h1><a href="/blog/2016/03/26/building-a-location-aware-web-app-with-geodjango/">Building a Location Aware Web App With Geodjango</a></h1><p>PostgreSQL has excellent support for geographical data thanks to the PostGIS extension, and Django allows you to take full advantage of it thanks to GeoDjango. In this tutorial, I’ll show you how to use GeoDjango to build a web app that allows users to search for gigs and events near them.</p><h2 id="requirements">Requirements</h2><p>I’ve made the jump to Python 3, and if you haven’t done so yet, I highly recommend it - it’s not hard, and there’s very few modules left that haven’t been ported across. As such, this tutorial assumes you’re using Python 3. You’ll also need to have Git, PostgreSQL and PostGIS installed - I’ll leave the details of doing so up to you as it varies by platform, but you can generally do so easily with a package manager on most Linux distros. On Mac OS X I recommend using Homebrew. If you’re on Windows I think your best bet is probably to use a Vagrant VM.</p><p>We’ll be using Django 1.9 - if by the time you read this a newer version of Django is out, it’s quite possible that some things may have changed and you’ll need to work around any problems caused. Generally search engines are the best place to look for this, and I’ll endeavour to keep the resulting Github repository as up to date as I can, so try those if you get stuck.</p><h2 id="getting-started">Getting started</h2><p>First of all, let’s create our database. Make sure you’re running as a user that has the required privileges to create users and databases for PostgreSQL and run the following command:</p><pre><code class="hljs lang-bash singleline">$ createdb gigfinder</code></pre><p>This creates the database. Next, we create the user:</p><pre><code class="hljs lang-bash singleline">$ createuser -s giguser -P</code></pre><p>You’ll be prompted to enter a password for the new user. Next, we want to use the <code>psql</code> command-line client to interact with our new database:</p><pre><code class="hljs lang-bash singleline">$ psql gigfinder</code></pre><p>This connects to the database. Run these commands to set up access to the database and install the PostGIS extension:</p><pre><code class="hljs lang-psql"><table><tr><td class="linenos" data-pseudo-content="1"></td><td># <span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DATABASE</span> gigfinder <span class="hljs-keyword">TO</span> giguser;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td># <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> postgis;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td># \q</td></tr></table></code></pre><p>With our database set up, it’s time to start work on our project. Let’s create our virtualenv in a new folder:</p><pre><code class="hljs lang-bash singleline">$ pyvenv venv</code></pre><p>Then activate it:</p><pre><code class="hljs lang-bash singleline">$ <span class="hljs-built_in">source</span> venv/bin/activate</code></pre><p>Then we install Django, along with a few other production dependencies:</p><pre><code class="hljs lang-bash singleline">$ pip install django-toolbelt</code></pre><p>And record our dependencies:</p><pre><code class="hljs lang-bash singleline">$ pip freeze &gt; requirements.txt</code></pre><p>Next, we create our application skeleton:</p><pre><code class="hljs lang-bash singleline">$ django-admin.py startproject gigfinder .</code></pre><p>We’ll also create a <code>.gitignore</code> file:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>venv/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>.DS_Store</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>*.swp</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>node_modules/</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>*.pyc</td></tr></table></code></pre><p>Let’s commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git init</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git add .gitignore requirements.txt manage.py gigfinder</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$ git commit -m <span class="hljs-string">'Initial commit'</span></td></tr></table></code></pre><p>Next, let’s create our first app, which we will call <code>gigs</code>:</p><pre><code class="hljs lang-bash singleline">$ python manage.py startapp gigs</code></pre><p>We need to add our new app to the <code>INSTALLED_APPS</code> setting. While we’re there we’ll also add GIS support and set up the database connection. First, add the required apps to <code>INSTALLED_APPS</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>INSTALLED_APPS = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'django.contrib.gis'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'gigs'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>]</td></tr></table></code></pre><p>Next, configure the database:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>DATABASES = {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-string">'default'</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>         <span class="hljs-string">'ENGINE'</span>: <span class="hljs-string">'django.contrib.gis.db.backends.postgis'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>         <span class="hljs-string">'NAME'</span>: <span class="hljs-string">'gigfinder'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>         <span class="hljs-string">'USER'</span>: <span class="hljs-string">'giguser'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>         <span class="hljs-string">'PASSWORD'</span>: <span class="hljs-string">'password'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>}</td></tr></table></code></pre><p>Let’s run the migrations:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py migrate</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Operations to perform:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  Apply all migrations: sessions, contenttypes, admin, auth</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Running migrations:</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  Rendering model states... DONE</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  Applying contenttypes.0001_initial... OK</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  Applying auth.0001_initial... OK</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  Applying admin.0001_initial... OK</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  Applying admin.0002_logentry_remove_auto_add... OK</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  Applying contenttypes.0002_remove_content_type_name... OK</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  Applying auth.0002_alter_permission_name_max_length... OK</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Applying auth.0003_alter_user_email_max_length... OK</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  Applying auth.0004_alter_user_username_opts... OK</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  Applying auth.0005_alter_user_last_login_null... OK</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  Applying auth.0006_require_contenttypes_0002... OK</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Applying auth.0007_alter_validators_add_error_messages... OK</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  Applying sessions.0001_initial... OK</td></tr></table></code></pre><p>And create our superuser account:</p><pre><code class="hljs lang-bash singleline">$ python manage.py createsuperuser</code></pre><p>Now, we’ll commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add gigfinder/ gigs/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Created gigs app'</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>[master e72a846] Created gigs app</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td> 8 files changed, 24 insertions(+), 3 deletions(-)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td> create mode 100644 gigs/__init__.py</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> create mode 100644 gigs/admin.py</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> create mode 100644 gigs/apps.py</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> create mode 100644 gigs/migrations/__init__.py</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td> create mode 100644 gigs/models.py</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td> create mode 100644 gigs/tests.py</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> create mode 100644 gigs/views.py</td></tr></table></code></pre><h2 id="our-first-model">Our first model</h2><p>At this point, it’s worth thinking about the models we plan for our app to have. First we’ll have a <code>Venue</code> model that contains details of an individual venue, which will include a name and a geographical location. We’ll also have an <code>Event</code> model that will represent an individual gig or event at a venue, and will include a name, date/time and a venue as a foreign key.</p><p>Before we start writing our first model, we need to write a test for it, but we also need to be able to create objects easily in our tests. We also want to be able to easily examine our objects, so we’ll install iPDB and Factory Boy:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ pip install ipdb factory-boy</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ pip freeze &gt; requirements.txt</td></tr></table></code></pre><p>Next, we write a test for the <code>Venue</code> model:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Venue</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> factory.fuzzy <span class="hljs-keyword">import</span> BaseFuzzyAttribute</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.geos <span class="hljs-keyword">import</span> Point</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">import</span> factory.django, random</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FuzzyPoint</span><span class="hljs-params">(BaseFuzzyAttribute)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuzz</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">return</span> Point(random.uniform(<span class="hljs-number">-180.0</span>, <span class="hljs-number">180.0</span>),</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                     random.uniform(<span class="hljs-number">-90.0</span>, <span class="hljs-number">90.0</span>))</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-comment"># Factories for tests</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        model = Venue</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-string">'location'</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    name = <span class="hljs-string">'Wembley Arena'</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    location = FuzzyPoint()</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_venue</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        all_venues = Venue.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        self.assertEqual(len(all_venues), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        only_venue = all_venues[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        self.assertEqual(only_venue, venue)</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        self.assertEqual(only_venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr></table></code></pre><p>Note that we randomly generate our location - this is done as suggested in <a href="http://stackoverflow.com/questions/32828890/using-factory-boy-with-geodjango-pointfields">this Stack Overflow post</a>.</p><p>Now, running our tests brings up an expected error:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>E</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ERROR: gigs.tests (unittest.loader._FailedTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>ImportError: Failed to import <span class="hljs-built_in">test</span> module: gigs.tests</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  File <span class="hljs-string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py"</span>, line 428, <span class="hljs-keyword">in</span> _find_test_path</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    module = self._get_module_from_name(name)</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  File <span class="hljs-string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py"</span>, line 369, <span class="hljs-keyword">in</span> _get_module_from_name</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    __import__(name)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 2, <span class="hljs-keyword">in</span> &lt;module&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    from gigs.models import Venue</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>ImportError: cannot import name <span class="hljs-string">'Venue'</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>Ran 1 <span class="hljs-built_in">test</span> <span class="hljs-keyword">in</span> 0.001s</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>FAILED (errors=1)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>Let’s create our <code>Venue</code> model in <code>gigs/models.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.db <span class="hljs-keyword">import</span> models</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Venue</span><span class="hljs-params">(models.Model)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    Model for a venue</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">pass</span></td></tr></table></code></pre><p>For now, we’re just creating a simple dummy model. Note that we import <code>models</code> from <code>django.contrib.gis.db</code> instead of the usual place - this gives us access to the additional geographical fields.</p><p>If we run our tests again we get an error:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py"</span>, line 64, <span class="hljs-keyword">in</span> execute</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-built_in">return</span> self.cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>psycopg2.ProgrammingError: relation <span class="hljs-string">"gigs_venue"</span> does not exist</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>LINE 1: SELECT <span class="hljs-string">"gigs_venue"</span>.<span class="hljs-string">"id"</span> FROM <span class="hljs-string">"gigs_venue"</span> ORDER BY <span class="hljs-string">"gigs_ve...</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>                                      ^</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>The above exception was the direct cause of the following exception:</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  File "manage.py<span class="hljs-string">", line 10, in &lt;module&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    execute_from_command_line(sys.argv)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py<span class="hljs-string">", line 353, in execute_from_command_line</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    utility.execute()</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py<span class="hljs-string">", line 345, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    self.fetch_command(subcommand).run_from_argv(self.argv)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py<span class="hljs-string">", line 30, in run_from_argv</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    super(Command, self).run_from_argv(argv)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py<span class="hljs-string">", line 348, in run_from_argv</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    self.execute(*args, **cmd_options)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py<span class="hljs-string">", line 74, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    super(Command, self).execute(*args, **options)</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py<span class="hljs-string">", line 399, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    output = self.handle(*args, **options)</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py<span class="hljs-string">", line 90, in handle</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    failures = test_runner.run_tests(test_labels)</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/<span class="hljs-built_in">test</span>/runner.py<span class="hljs-string">", line 532, in run_tests</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    old_config = self.setup_databases()</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/<span class="hljs-built_in">test</span>/runner.py<span class="hljs-string">", line 482, in setup_databases</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    self.parallel, **kwargs</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/<span class="hljs-built_in">test</span>/runner.py<span class="hljs-string">", line 726, in setup_databases</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    serialize=connection.settings_dict.get("TEST<span class="hljs-string">", {}).get("</span>SERIALIZE<span class="hljs-string">", True),</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py<span class="hljs-string">", line 78, in create_test_db</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    self.connection._test_serialized_contents = self.serialize_db_to_string()</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py<span class="hljs-string">", line 122, in serialize_db_to_string</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    serializers.serialize("json<span class="hljs-string">", get_objects(), indent=None, stream=out)</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/__init__.py<span class="hljs-string">", line 129, in serialize</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    s.serialize(queryset, **options)</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/base.py<span class="hljs-string">", line 79, in serialize</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    for count, obj in enumerate(queryset, start=1):</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py<span class="hljs-string">", line 118, in get_objects</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    for obj in queryset.iterator():</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/query.py<span class="hljs-string">", line 52, in __iter__</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    results = compiler.execute_sql()</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/sql/compiler.py<span class="hljs-string">", line 848, in execute_sql</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py<span class="hljs-string">", line 64, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    return self.cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/utils.py<span class="hljs-string">", line 95, in __exit__</span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    six.reraise(dj_exc_type, dj_exc_value, traceback)</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/utils/six.py<span class="hljs-string">", line 685, in reraise</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    raise value.with_traceback(tb)</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py<span class="hljs-string">", line 64, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    return self.cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>django.db.utils.ProgrammingError: relation "gigs_venue<span class="hljs-string">" does not exist</span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>LINE 1: SELECT "gigs_venue<span class="hljs-string">"."</span>id<span class="hljs-string">" FROM "</span>gigs_venue<span class="hljs-string">" ORDER BY "</span>gigs_ve...</td></tr></table></code></pre><p>Let’s update our model:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.db <span class="hljs-keyword">import</span> models</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Venue</span><span class="hljs-params">(models.Model)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    Model for a venue</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    name = models.CharField(max_length=<span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    location = models.PointField()</td></tr></table></code></pre><p>Then create our migration:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py makemigrations</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Migrations <span class="hljs-keyword">for</span> <span class="hljs-string">'gigs'</span>:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  0001_initial.py:</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    - Create model Venue</td></tr></table></code></pre><p>And run it:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py migrate</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Operations to perform:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  Apply all migrations: gigs, sessions, contenttypes, auth, admin</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Running migrations:</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  Rendering model states... DONE</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  Applying gigs.0001_initial... OK</td></tr></table></code></pre><p>Then if we run our tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Ran 1 <span class="hljs-built_in">test</span> <span class="hljs-keyword">in</span> 0.362s</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>OK</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>They should pass. Note that Django may complain about needing to delete the test database before running the tests, but this should not cause any problems. Let’s commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add requirements.txt gigs/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Venue model in place'</span></td></tr></table></code></pre><p>With our venue done, let’s turn to our <code>Event</code> model. Amend <code>gigs/tests.py</code> as follows:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Venue, Event</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> factory.fuzzy <span class="hljs-keyword">import</span> BaseFuzzyAttribute</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.geos <span class="hljs-keyword">import</span> Point</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">import</span> factory.django, random</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FuzzyPoint</span><span class="hljs-params">(BaseFuzzyAttribute)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuzz</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">return</span> Point(random.uniform(<span class="hljs-number">-180.0</span>, <span class="hljs-number">180.0</span>),</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                     random.uniform(<span class="hljs-number">-90.0</span>, <span class="hljs-number">90.0</span>))</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-comment"># Factories for tests</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        model = Venue</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-string">'location'</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    name = <span class="hljs-string">'Wembley Arena'</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    location = FuzzyPoint()</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        model = Event</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-string">'venue'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            <span class="hljs-string">'datetime'</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    name = <span class="hljs-string">'Queens of the Stone Age'</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    datetime = timezone.now()</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_venue</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        all_venues = Venue.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        self.assertEqual(len(all_venues), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        only_venue = all_venues[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        self.assertEqual(only_venue, venue)</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        self.assertEqual(only_venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_event</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>        <span class="hljs-comment"># Create the event</span></td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        event = EventFactory(venue=venue)</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        all_events = Event.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>        self.assertEqual(len(all_events), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        only_event = all_events[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        self.assertEqual(only_event, event)</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>        self.assertEqual(only_event.name, <span class="hljs-string">'Queens of the Stone Age'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        self.assertEqual(only_event.venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr></table></code></pre><p>Then we run our tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>E</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ERROR: gigs.tests (unittest.loader._FailedTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>ImportError: Failed to import <span class="hljs-built_in">test</span> module: gigs.tests</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  File <span class="hljs-string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py"</span>, line 428, <span class="hljs-keyword">in</span> _find_test_path</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    module = self._get_module_from_name(name)</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  File <span class="hljs-string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py"</span>, line 369, <span class="hljs-keyword">in</span> _get_module_from_name</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    __import__(name)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 2, <span class="hljs-keyword">in</span> &lt;module&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    from gigs.models import Venue, Event</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>ImportError: cannot import name <span class="hljs-string">'Event'</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>Ran 1 <span class="hljs-built_in">test</span> <span class="hljs-keyword">in</span> 0.001s</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>FAILED (errors=1)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>As expected, this fails, so create an empty <code>Event</code> model in <code>gigs/models.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Event</span><span class="hljs-params">(models.Model)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    Model for an event</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">pass</span></td></tr></table></code></pre><p>Running the tests now will raise an error due to the table not existing:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py"</span>, line 64, <span class="hljs-keyword">in</span> execute</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-built_in">return</span> self.cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>psycopg2.ProgrammingError: relation <span class="hljs-string">"gigs_event"</span> does not exist</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>LINE 1: SELECT <span class="hljs-string">"gigs_event"</span>.<span class="hljs-string">"id"</span> FROM <span class="hljs-string">"gigs_event"</span> ORDER BY <span class="hljs-string">"gigs_ev...</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>                                      ^</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>The above exception was the direct cause of the following exception:</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  File "manage.py<span class="hljs-string">", line 10, in &lt;module&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    execute_from_command_line(sys.argv)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py<span class="hljs-string">", line 353, in execute_from_command_line</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    utility.execute()</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py<span class="hljs-string">", line 345, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    self.fetch_command(subcommand).run_from_argv(self.argv)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py<span class="hljs-string">", line 30, in run_from_argv</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    super(Command, self).run_from_argv(argv)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py<span class="hljs-string">", line 348, in run_from_argv</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    self.execute(*args, **cmd_options)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py<span class="hljs-string">", line 74, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    super(Command, self).execute(*args, **options)</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py<span class="hljs-string">", line 399, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    output = self.handle(*args, **options)</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py<span class="hljs-string">", line 90, in handle</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    failures = test_runner.run_tests(test_labels)</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/<span class="hljs-built_in">test</span>/runner.py<span class="hljs-string">", line 532, in run_tests</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    old_config = self.setup_databases()</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/<span class="hljs-built_in">test</span>/runner.py<span class="hljs-string">", line 482, in setup_databases</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    self.parallel, **kwargs</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/<span class="hljs-built_in">test</span>/runner.py<span class="hljs-string">", line 726, in setup_databases</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    serialize=connection.settings_dict.get("TEST<span class="hljs-string">", {}).get("</span>SERIALIZE<span class="hljs-string">", True),</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py<span class="hljs-string">", line 78, in create_test_db</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    self.connection._test_serialized_contents = self.serialize_db_to_string()</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py<span class="hljs-string">", line 122, in serialize_db_to_string</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    serializers.serialize("json<span class="hljs-string">", get_objects(), indent=None, stream=out)</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/__init__.py<span class="hljs-string">", line 129, in serialize</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    s.serialize(queryset, **options)</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/base.py<span class="hljs-string">", line 79, in serialize</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    for count, obj in enumerate(queryset, start=1):</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py<span class="hljs-string">", line 118, in get_objects</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    for obj in queryset.iterator():</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/query.py<span class="hljs-string">", line 52, in __iter__</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    results = compiler.execute_sql()</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/sql/compiler.py<span class="hljs-string">", line 848, in execute_sql</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py<span class="hljs-string">", line 64, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    return self.cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/utils.py<span class="hljs-string">", line 95, in __exit__</span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    six.reraise(dj_exc_type, dj_exc_value, traceback)</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/utils/six.py<span class="hljs-string">", line 685, in reraise</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    raise value.with_traceback(tb)</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>  File "/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py<span class="hljs-string">", line 64, in execute</span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    return self.cursor.execute(sql, params)</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>django.db.utils.ProgrammingError: relation "gigs_event<span class="hljs-string">" does not exist</span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>LINE 1: SELECT "gigs_event<span class="hljs-string">"."</span>id<span class="hljs-string">" FROM "</span>gigs_event<span class="hljs-string">" ORDER BY "</span>gigs_ev...</td></tr></table></code></pre><p>So let’s populate our model:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Event</span><span class="hljs-params">(models.Model)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    Model for an event</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    name = models.CharField(max_length=<span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    datetime = models.DateTimeField()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    venue = models.ForeignKey(Venue)</td></tr></table></code></pre><p>And create our migration:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py makemigrations</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Migrations <span class="hljs-keyword">for</span> <span class="hljs-string">'gigs'</span>:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  0002_event.py:</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    - Create model Event</td></tr></table></code></pre><p>And run it:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py migrate</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Operations to perform:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  Apply all migrations: auth, admin, sessions, contenttypes, gigs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Running migrations:</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  Rendering model states... DONE</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  Applying gigs.0002_event... OK</td></tr></table></code></pre><p>And run our tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>..</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Ran 2 tests <span class="hljs-keyword">in</span> 0.033s</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>OK</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>Again, you may be prompted to delete the test database, but this should not be an issue.</p><p>With this done, let’s commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Added Event model'</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>[master 47ba686] Added Event model</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td> 3 files changed, 67 insertions(+), 1 deletion(-)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td> create mode 100644 gigs/migrations/0002_event.py</td></tr></table></code></pre><h2 id="setting-up-the-admin">Setting up the admin</h2><p>For an application like this, you’d expect the curators of the site to maintain the gigs and venues stored in the database, and that’s an obvious use case for the Django admin. So let’s set our models up to be available in the admin. Open up <code>gigs/admin.py</code> and amend it as follows:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Venue, Event</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>admin.site.register(Venue)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>admin.site.register(Event)</td></tr></table></code></pre><p>Now, if you start up the dev server as usual with <code>python manage.py runserver</code> and visit <a href="http://127.0.0.1:8000/admin/">http://127.0.0.1:8000/admin/</a>, you can see that our <code>Event</code> and <code>Venue</code> models are now available. However, the string representations of them are pretty useless. Let’s fix that. First, we amend our tests:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Venue, Event</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> factory.fuzzy <span class="hljs-keyword">import</span> BaseFuzzyAttribute</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.geos <span class="hljs-keyword">import</span> Point</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">import</span> factory.django, random</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FuzzyPoint</span><span class="hljs-params">(BaseFuzzyAttribute)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuzz</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">return</span> Point(random.uniform(<span class="hljs-number">-180.0</span>, <span class="hljs-number">180.0</span>),</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                     random.uniform(<span class="hljs-number">-90.0</span>, <span class="hljs-number">90.0</span>))</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-comment"># Factories for tests</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        model = Venue</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-string">'location'</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    name = <span class="hljs-string">'Wembley Arena'</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    location = FuzzyPoint()</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        model = Event</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-string">'venue'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            <span class="hljs-string">'datetime'</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    name = <span class="hljs-string">'Queens of the Stone Age'</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    datetime = timezone.now()</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_venue</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        all_venues = Venue.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        self.assertEqual(len(all_venues), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        only_venue = all_venues[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        self.assertEqual(only_venue, venue)</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        self.assertEqual(only_venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-comment"># Check string representation</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        self.assertEqual(only_venue.__str__(), <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_event</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        <span class="hljs-comment"># Create the event</span></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        event = EventFactory(venue=venue)</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        all_events = Event.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        self.assertEqual(len(all_events), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        only_event = all_events[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>        self.assertEqual(only_event, event)</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        self.assertEqual(only_event.name, <span class="hljs-string">'Queens of the Stone Age'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        self.assertEqual(only_event.venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        <span class="hljs-comment"># Check string representation</span></td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        self.assertEqual(only_event.__str__(), <span class="hljs-string">'Queens of the Stone Age - Wembley Arena'</span>)</td></tr></table></code></pre><p>Next, we run our tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>FF</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>FAIL: test_create_event (gigs.tests.EventTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 74, <span class="hljs-keyword">in</span> test_create_event</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    self.assertEqual(only_event.__str__(), <span class="hljs-string">'Queens of the Stone Age - Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>AssertionError: <span class="hljs-string">'Event object'</span> != <span class="hljs-string">'Queens of the Stone Age - Wembley Arena'</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>- Event object</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>+ Queens of the Stone Age - Wembley Arena</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>FAIL: test_create_venue (gigs.tests.VenueTest)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 52, <span class="hljs-keyword">in</span> test_create_venue</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    self.assertEqual(only_venue.__str__(), <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>AssertionError: <span class="hljs-string">'Venue object'</span> != <span class="hljs-string">'Wembley Arena'</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>- Venue object</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>+ Wembley Arena</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>Ran 2 tests <span class="hljs-keyword">in</span> 0.059s</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>FAILED (failures=2)</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>They fail as expected. So let’s update <code>gigs/models.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.db <span class="hljs-keyword">import</span> models</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Venue</span><span class="hljs-params">(models.Model)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    Model for a venue</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    name = models.CharField(max_length=<span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    location = models.PointField()</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__str__</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> self.name</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Event</span><span class="hljs-params">(models.Model)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    Model for an event</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    name = models.CharField(max_length=<span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    datetime = models.DateTimeField()</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    venue = models.ForeignKey(Venue)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__str__</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-string">"%s - %s"</span> % (self.name, self.venue.name)</td></tr></table></code></pre><p>For the venue, we just use the name. For the event, we use the event name and the venue name.</p><p>Now, we run our tests again:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>..</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Ran 2 tests <span class="hljs-keyword">in</span> 0.048s</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>OK</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>Time to commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Added models to admin'</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>[master 65d051f] Added models to admin</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td> 3 files changed, 15 insertions(+), 1 deletion(-)</td></tr></table></code></pre><p>Our models are now in place, so you may want to log into the admin and create a few venues and events so you can see it in action. Note that the location field for the <code>Venue</code> model creates a map widget that allows you to select a geographical location. It is a bit basic, however, so let’s make it better. Let’s install <code>django-floppyforms</code>:</p><pre><code class="hljs lang-bash singleline">$ pip install django-floppyforms</code></pre><p>And add it to our requirements:</p><pre><code class="hljs lang-bash singleline">$ pip freeze -r requirements.txt</code></pre><p>Then add it to <code>INSTALLED_APPS</code> in <code>gigfinder/setttings.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>INSTALLED_APPS = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'django.contrib.gis'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'gigs'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-string">'floppyforms'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>]</td></tr></table></code></pre><p>Now we create a custom point widget for our admin, a custom form for the venues, and a custom venue admin:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Venue, Event</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> django.forms <span class="hljs-keyword">import</span> ModelForm</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> floppyforms.gis <span class="hljs-keyword">import</span> PointWidget, BaseGMapWidget</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomPointWidget</span><span class="hljs-params">(PointWidget, BaseGMapWidget)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Media</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        js = (<span class="hljs-string">'/static/floppyforms/js/MapWidget.js'</span>,)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueAdminForm</span><span class="hljs-params">(ModelForm)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        model = Venue</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        fields = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'location'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        widgets = {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-string">'location'</span>: CustomPointWidget()</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueAdmin</span><span class="hljs-params">(admin.ModelAdmin)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    form = VenueAdminForm</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>admin.site.register(Venue, VenueAdmin)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>admin.site.register(Event)</td></tr></table></code></pre><p>Note in particular that we define the media for our widget so we can include some required Javascript. If you run the dev server again, you should see that the map widget in the admin is now provided by Google Maps, making it much easier to identify the correct location of the venue.</p><p>Time to commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add gigfinder/ gigs/ requirements.txt</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Customised location widget'</span></td></tr></table></code></pre><p>With our admin ready, it’s time to move on to the user-facing part of the web app.</p><h2 id="creating-our-views">Creating our views</h2><p>We will keep the front end for this app as simple as possible for the purposes of this tutorial, but of course you should feel free to expand upon this as you see fit. What we’ll do is create a form that uses HTML5 geolocation to get the user’s current geographical coordinates. It will then return events in the next week, ordered by how close the venue is. Please note that there are plans afoot in some browsers to prevent HTML5 geolocation from working unless content is server over HTTPS, so that may complicate things.</p><p>How do we query the database to get this data? It’s not too difficult, as shown in this example:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py shell</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Python 3.5.1 (default, Mar 25 2016, 00:17:15)</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Type <span class="hljs-string">"copyright"</span>, <span class="hljs-string">"credits"</span> or <span class="hljs-string">"license"</span> <span class="hljs-keyword">for</span> more information.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>IPython 4.1.2 -- An enhanced Interactive Python.</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>?         -&gt; Introduction and overview of IPython<span class="hljs-string">'s features.</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>%quickref -&gt; Quick reference.</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>help      -&gt; Python's own <span class="hljs-built_in">help</span> system.</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>object?   -&gt; Details about <span class="hljs-string">'object'</span>, use <span class="hljs-string">'object??'</span> <span class="hljs-keyword">for</span> extra details.</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>In [1]: from gigs.models import *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>In [2]: from django.contrib.gis.geos import Point</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>In [3]: from django.contrib.gis.db.models.functions import Distance</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>In [4]: location = Point(52.3749159, 1.1067473, srid=4326)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>In [5]: Venue.objects.all().annotate(distance=Distance(<span class="hljs-string">'location'</span>, location)).order_by(<span class="hljs-string">'distance'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>Out[5]: [&lt;Venue: Diss Corn Hall&gt;, &lt;Venue: Waterfront Norwich&gt;, &lt;Venue: UEA Norwich&gt;, &lt;Venue: Wembley Arena&gt;]</td></tr></table></code></pre><p>I’ve set up a number of venues using the admin, one round the corner, two in Norwich, and one in London. I then imported the models, the <code>Point</code> class, and the <code>Distance</code> function, and created a <code>Point</code> object. Note that the <code>Point</code> is passed three fields - the first and second are the latitude and longitude, respectively, while the <code>srid</code> field takes a value of <code>4326</code>. This field represents the <a href="https://en.wikipedia.org/wiki/SRID">Spatial Reference System Identifier</a> used for this query - we’ve gone for <a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84">WGS 84</a>, which is a common choice and is referred to with the SRID 4326.</p><p>Now, we want the user to be able to submit the form and get the 5 nearest events in the next week. We can get the date for this time next week as follows:</p><pre><code class="hljs lang-python singleline">In [<span class="hljs-number">6</span>]: next_week = timezone.now() + timezone.timedelta(weeks=<span class="hljs-number">1</span>)</code></pre><p>Then we can get the events we want, sorted by distance, like this:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>In [<span class="hljs-number">7</span>]: Event.objects.filter(datetime__gte=timezone.now()).filter(datetime__lte=next_week).annotate(distance=Distance(<span class="hljs-string">'venue__location'</span>, location)).order_by(<span class="hljs-string">'distance'</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Out[<span class="hljs-number">7</span>]: [&lt;Event: Primal Scream - UEA Norwich&gt;, &lt;Event: Queens of the Stone Age - Wembley Arena&gt;]</td></tr></table></code></pre><p>With that in mind, let’s write the test for our view. The view should contain a single form that accepts a user’s geographical coordinates - for convenience we’ll autocomplete this with HTML5 geolocation. On submit, the user should see a list of the five closest events in the next week.</p><p>First, let’s test the GET request. Amend <code>gigs/tests.py</code> as follows:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Venue, Event</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> factory.fuzzy <span class="hljs-keyword">import</span> BaseFuzzyAttribute</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.geos <span class="hljs-keyword">import</span> Point</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">import</span> factory.django, random</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> RequestFactory</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">from</span> django.core.urlresolvers <span class="hljs-keyword">import</span> reverse</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">from</span> gigs.views <span class="hljs-keyword">import</span> LookupView</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FuzzyPoint</span><span class="hljs-params">(BaseFuzzyAttribute)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuzz</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> Point(random.uniform(<span class="hljs-number">-180.0</span>, <span class="hljs-number">180.0</span>),</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                     random.uniform(<span class="hljs-number">-90.0</span>, <span class="hljs-number">90.0</span>))</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-comment"># Factories for tests</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        model = Venue</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-string">'location'</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    name = <span class="hljs-string">'Wembley Arena'</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    location = FuzzyPoint()</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventFactory</span><span class="hljs-params">(factory.django.DjangoModelFactory)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        model = Event</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        django_get_or_create = (</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            <span class="hljs-string">'venue'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            <span class="hljs-string">'datetime'</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        )</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    name = <span class="hljs-string">'Queens of the Stone Age'</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    datetime = timezone.now()</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VenueTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_venue</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        all_venues = Venue.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        self.assertEqual(len(all_venues), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        only_venue = all_venues[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        self.assertEqual(only_venue, venue)</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        self.assertEqual(only_venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment"># Check string representation</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        self.assertEqual(only_venue.__str__(), <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_event</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        <span class="hljs-comment"># Create the venue</span></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        venue = VenueFactory()</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        <span class="hljs-comment"># Create the event</span></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        event = EventFactory(venue=venue)</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>        all_events = Event.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        self.assertEqual(len(all_events), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>        only_event = all_events[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        self.assertEqual(only_event, event)</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        self.assertEqual(only_event.name, <span class="hljs-string">'Queens of the Stone Age'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        self.assertEqual(only_event.venue.name, <span class="hljs-string">'Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        <span class="hljs-comment"># Check string representation</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>        self.assertEqual(only_event.__str__(), <span class="hljs-string">'Queens of the Stone Age - Wembley Arena'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LookupViewTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>    <span class="hljs-string">"""</span></td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>    Test lookup view</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    """</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        self.factory = RequestFactory()</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>        request = self.factory.get(reverse(<span class="hljs-string">'lookup'</span>))</td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>        response = LookupView.as_view()(request)</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td>        self.assertEqual(response.status_code, <span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>        self.assertTemplateUsed(<span class="hljs-string">'gigs/lookup.html'</span>)</td></tr></table></code></pre><p>Let’s run our tests:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py test gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating test database <span class="hljs-keyword">for</span> alias <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>E</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ERROR: gigs.tests (unittest.loader._FailedTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>ImportError: Failed to <span class="hljs-keyword">import</span> test module: gigs.tests</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  File <span class="hljs-string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py"</span>, line <span class="hljs-number">428</span>, <span class="hljs-keyword">in</span> _find_test_path</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    module = self._get_module_from_name(name)</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  File <span class="hljs-string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py"</span>, line <span class="hljs-number">369</span>, <span class="hljs-keyword">in</span> _get_module_from_name</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    __import__(name)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line <span class="hljs-number">9</span>, <span class="hljs-keyword">in</span> &lt;module&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">from</span> gigs.views <span class="hljs-keyword">import</span> LookupView</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>ImportError: cannot <span class="hljs-keyword">import</span> name <span class="hljs-string">'LookupView'</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>Ran <span class="hljs-number">1</span> test <span class="hljs-keyword">in</span> <span class="hljs-number">0.000</span>s</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>FAILED (errors=<span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>Destroying test database <span class="hljs-keyword">for</span> alias <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>Our first issue is that we can’t import the view in the test. Let’s fix that by amending <code>gigs/views.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> django.views.generic.base <span class="hljs-keyword">import</span> View</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LookupView</span><span class="hljs-params">(View)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">pass</span></td></tr></table></code></pre><p>Running the tests again results in the following:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>.E.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ERROR: test_get (gigs.tests.LookupViewTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 88, <span class="hljs-keyword">in</span> test_get</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    request = self.factory.get(reverse(<span class="hljs-string">'lookup'</span>))</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/urlresolvers.py"</span>, line 600, <span class="hljs-keyword">in</span> reverse</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-built_in">return</span> force_text(iri_to_uri(resolver._reverse_with_prefix(view, prefix, *args, **kwargs)))</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/urlresolvers.py"</span>, line 508, <span class="hljs-keyword">in</span> _reverse_with_prefix</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    (lookup_view_s, args, kwargs, len(patterns), patterns))</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>django.core.urlresolvers.NoReverseMatch: Reverse <span class="hljs-keyword">for</span> <span class="hljs-string">'lookup'</span> with arguments <span class="hljs-string">'()'</span> and keyword arguments <span class="hljs-string">'{}'</span> not found. 0 pattern(s) tried: []</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Ran 3 tests <span class="hljs-keyword">in</span> 0.154s</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>FAILED (errors=1)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>We can’t resolve the URL for our new view, so we need to add it to our URLconf. First of all, save this as <code>gigs/urls.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.conf.urls <span class="hljs-keyword">import</span> url</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> gigs.views <span class="hljs-keyword">import</span> LookupView</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>urlpatterns = [</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-comment"># Lookup</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    url(<span class="hljs-string">r''</span>, LookupView.as_view(), name=<span class="hljs-string">'lookup'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>]</td></tr></table></code></pre><p>Then amend <code>gigfinder/urls.py</code> as follows:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.conf.urls <span class="hljs-keyword">import</span> url, include</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>urlpatterns = [</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    url(<span class="hljs-string">r'^admin/'</span>, admin.site.urls),</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment"># Gig URLs</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    url(<span class="hljs-string">r''</span>, include(<span class="hljs-string">'gigs.urls'</span>)),</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>]</td></tr></table></code></pre><p>Then run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>.F.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>FAIL: test_get (gigs.tests.LookupViewTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 90, <span class="hljs-keyword">in</span> test_get</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    self.assertEqual(response.status_code, 200)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>AssertionError: 405 != 200</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>Ran 3 tests <span class="hljs-keyword">in</span> 0.417s</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>FAILED (failures=1)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>We get a 405 response because the view does not accept GET requests. Let’s resolve that:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render_to_response</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> django.views.generic.base <span class="hljs-keyword">import</span> View</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LookupView</span><span class="hljs-params">(View)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span><span class="hljs-params">(self, request)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> render_to_response(<span class="hljs-string">'gigs/lookup.html'</span>)</td></tr></table></code></pre><p>If we run our tests now:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>.E.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ERROR: test_get (gigs.tests.LookupViewTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 89, <span class="hljs-keyword">in</span> test_get</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    response = LookupView.as_view()(request)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py"</span>, line 68, <span class="hljs-keyword">in</span> view</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-built_in">return</span> self.dispatch(request, *args, **kwargs)</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py"</span>, line 88, <span class="hljs-keyword">in</span> dispatch</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-built_in">return</span> handler(request, *args, **kwargs)</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/views.py"</span>, line 6, <span class="hljs-keyword">in</span> get</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-built_in">return</span> render_to_response(<span class="hljs-string">'gigs/lookup.html'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/shortcuts.py"</span>, line 39, <span class="hljs-keyword">in</span> render_to_response</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    content = loader.render_to_string(template_name, context, using=using)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py"</span>, line 96, <span class="hljs-keyword">in</span> render_to_string</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    template = get_template(template_name, using=using)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py"</span>, line 43, <span class="hljs-keyword">in</span> get_template</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    raise TemplateDoesNotExist(template_name, chain=chain)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>django.template.exceptions.TemplateDoesNotExist: gigs/lookup.html</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>Ran 3 tests <span class="hljs-keyword">in</span> 0.409s</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>FAILED (errors=1)</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>We see that the template is not defined. Save the following as <code>gigs/templates/gigs/includes/base.html</code>:</p><pre><code class="hljs lang-django"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Gig finder<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Gig Finder<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">block</span></span> content %}</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-2.2.2.min.js"</span> <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI="</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"javascript"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></td></tr></table></code></pre><p>And the following as <code>gigs/templates/gigs/lookup.html</code>:</p><pre><code class="hljs lang-django"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">extends</span></span> "gigs/includes/base.html" %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">block</span></span> content %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"form"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">csrf_token</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"latitude"</span>&gt;</span>Latitude:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id_latitude"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"latitude"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">input</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"longitude"</span>&gt;</span>Longitude:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id_longitude"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"longitude"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">input</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Submit"</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"javascript"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript"></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        navigator.geolocation.getCurrentPosition(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">position</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">var</span> lat = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'id_latitude'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-keyword">var</span> lon = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'id_longitude'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            lat.value = position.coords.latitude;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            lon.value = position.coords.longitude;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %}</span></td></tr></table></code></pre><p>Note the JavaScript to populate the latitude and longitude. Now, if we run our tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Ran 3 tests <span class="hljs-keyword">in</span> 1.814s</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>OK</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>Success! We now render our form as expected. Time to commit:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add gigs gigfinder</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Implemented GET handler'</span></td></tr></table></code></pre><h2 id="handling-post-requests">Handling POST requests</h2><p>Now we need to be able to handle POST requests and return the appropriate results. First, let’s write a test for it in our existing <code>LookupViewTest</code> class:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-comment"># Create venues to return</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        v1 = VenueFactory(name=<span class="hljs-string">'Venue1'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        v2 = VenueFactory(name=<span class="hljs-string">'Venue2'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        v3 = VenueFactory(name=<span class="hljs-string">'Venue3'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        v4 = VenueFactory(name=<span class="hljs-string">'Venue4'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        v5 = VenueFactory(name=<span class="hljs-string">'Venue5'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        v6 = VenueFactory(name=<span class="hljs-string">'Venue6'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        v7 = VenueFactory(name=<span class="hljs-string">'Venue7'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        v8 = VenueFactory(name=<span class="hljs-string">'Venue8'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        v9 = VenueFactory(name=<span class="hljs-string">'Venue9'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        v10 = VenueFactory(name=<span class="hljs-string">'Venue10'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-comment"># Create events to return</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        e1 = EventFactory(name=<span class="hljs-string">'Event1'</span>, venue=v1)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        e2 = EventFactory(name=<span class="hljs-string">'Event2'</span>, venue=v2)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        e3 = EventFactory(name=<span class="hljs-string">'Event3'</span>, venue=v3)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        e4 = EventFactory(name=<span class="hljs-string">'Event4'</span>, venue=v4)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        e5 = EventFactory(name=<span class="hljs-string">'Event5'</span>, venue=v5)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        e6 = EventFactory(name=<span class="hljs-string">'Event6'</span>, venue=v6)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        e7 = EventFactory(name=<span class="hljs-string">'Event7'</span>, venue=v7)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        e8 = EventFactory(name=<span class="hljs-string">'Event8'</span>, venue=v8)</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        e9 = EventFactory(name=<span class="hljs-string">'Event9'</span>, venue=v9)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        e10 = EventFactory(name=<span class="hljs-string">'Event10'</span>, venue=v10)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-comment"># Set parameters</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        lat = <span class="hljs-number">52.3749159</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        lon = <span class="hljs-number">1.1067473</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment"># Put together request</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        data = {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            <span class="hljs-string">'latitude'</span>: lat,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            <span class="hljs-string">'longitude'</span>: lon</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        request = self.factory.post(reverse(<span class="hljs-string">'lookup'</span>), data)</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        response = LookupView.as_view()(request)</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        self.assertEqual(response.status_code, <span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        self.assertTemplateUsed(<span class="hljs-string">'gigs/lookupresults.html'</span>)</td></tr></table></code></pre><p>If we now run this test:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>..F.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>FAIL: test_post (gigs.tests.LookupViewTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 117, <span class="hljs-keyword">in</span> test_post</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    self.assertEqual(response.status_code, 200)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>AssertionError: 405 != 200</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>Ran 4 tests <span class="hljs-keyword">in</span> 1.281s</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>FAILED (failures=1)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>We can see that it fails because the POST method is not supported. Now we can start work on implementing it. First, let’s create a form in <code>gigs/forms.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.forms <span class="hljs-keyword">import</span> Form, FloatField</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LookupForm</span><span class="hljs-params">(Form)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    latitude = FloatField()</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    longitude = FloatField()</td></tr></table></code></pre><p>Next, edit <code>gigs/views.py</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render_to_response</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> django.views.generic.edit <span class="hljs-keyword">import</span> FormView</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> gigs.forms <span class="hljs-keyword">import</span> LookupForm</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Event</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.geos <span class="hljs-keyword">import</span> Point</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.db.models.functions <span class="hljs-keyword">import</span> Distance</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LookupView</span><span class="hljs-params">(FormView)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    form_class = LookupForm</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span><span class="hljs-params">(self, request)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> render_to_response(<span class="hljs-string">'gigs/lookup.html'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">form_valid</span><span class="hljs-params">(self, form)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment"># Get data</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        latitude = form.cleaned_data[<span class="hljs-string">'latitude'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        longitude = form.cleaned_data[<span class="hljs-string">'longitude'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-comment"># Get today's date</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        now = timezone.now()</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-comment"># Get next week's date</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        next_week = now + timezone.timedelta(weeks=<span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-comment"># Get Point</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        location = Point(longitude, latitude, srid=<span class="hljs-number">4326</span>)</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-comment"># Look up events</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        events = Event.objects.filter(datetime__gte=now).filter(datetime__lte=next_week).annotate(distance=Distance(<span class="hljs-string">'venue__location'</span>, location)).order_by(<span class="hljs-string">'distance'</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-comment"># Render the template</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">return</span> render_to_response(<span class="hljs-string">'gigs/lookupresults.html'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            <span class="hljs-string">'events'</span>: events</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            })</td></tr></table></code></pre><p>Note that we’re switching from a <code>View</code> to a <code>FormView</code> so that it can more easily handle our form. We could render the form using this as well, but as it’s a simple form I decided it wasn’t worth the bother. Also, note that the longitude goes first - this caught me out as I expected the latitude to be the first argument.</p><p>Now, if we run our tests, they should complain about our missing template:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>..E.</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>======================================================================</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ERROR: test_post (gigs.tests.LookupViewTest)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Traceback (most recent call last):</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/tests.py"</span>, line 116, <span class="hljs-keyword">in</span> test_post</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    response = LookupView.as_view()(request)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py"</span>, line 68, <span class="hljs-keyword">in</span> view</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-built_in">return</span> self.dispatch(request, *args, **kwargs)</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py"</span>, line 88, <span class="hljs-keyword">in</span> dispatch</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-built_in">return</span> handler(request, *args, **kwargs)</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/edit.py"</span>, line 222, <span class="hljs-keyword">in</span> post</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-built_in">return</span> self.form_valid(form)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/gigs/views.py"</span>, line 31, <span class="hljs-keyword">in</span> form_valid</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-string">'events'</span>: events</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/shortcuts.py"</span>, line 39, <span class="hljs-keyword">in</span> render_to_response</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    content = loader.render_to_string(template_name, context, using=using)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py"</span>, line 96, <span class="hljs-keyword">in</span> render_to_string</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    template = get_template(template_name, using=using)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  File <span class="hljs-string">"/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py"</span>, line 43, <span class="hljs-keyword">in</span> get_template</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    raise TemplateDoesNotExist(template_name, chain=chain)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>django.template.exceptions.TemplateDoesNotExist: gigs/lookupresults.html</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>Ran 4 tests <span class="hljs-keyword">in</span> 0.506s</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>FAILED (errors=1)</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>So let’s create <code>gigs/templates/gigs/lookupresults.html</code>:</p><pre><code class="hljs lang-django"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">extends</span></span> "gigs/includes/base.html" %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">block</span></span> content %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> event <span class="hljs-keyword">in</span> events %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-template-variable">{{ event.name }}</span><span class="xml"> - </span><span class="hljs-template-variable">{{ event.venue.name }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %}</span></td></tr></table></code></pre><p>Now, if we run our tests, they should pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ python manage.py <span class="hljs-built_in">test</span> gigs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>....</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>----------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Ran 4 tests <span class="hljs-keyword">in</span> 0.728s</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>OK</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...</td></tr></table></code></pre><p>However, if we try actually submitting the form by hand, we get the error <code>CSRF token missing or incorrect</code>. Edit <code>views.py</code> as follows to resolve this:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render_to_response</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> django.views.generic.edit <span class="hljs-keyword">import</span> FormView</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">from</span> gigs.forms <span class="hljs-keyword">import</span> LookupForm</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> gigs.models <span class="hljs-keyword">import</span> Event</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.geos <span class="hljs-keyword">import</span> Point</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">from</span> django.contrib.gis.db.models.functions <span class="hljs-keyword">import</span> Distance</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">from</span> django.template <span class="hljs-keyword">import</span> RequestContext</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LookupView</span><span class="hljs-params">(FormView)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    form_class = LookupForm</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span><span class="hljs-params">(self, request)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">return</span> render_to_response(<span class="hljs-string">'gigs/lookup.html'</span>, RequestContext(request))</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">form_valid</span><span class="hljs-params">(self, form)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-comment"># Get data</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        latitude = form.cleaned_data[<span class="hljs-string">'latitude'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        longitude = form.cleaned_data[<span class="hljs-string">'longitude'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-comment"># Get today's date</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        now = timezone.now()</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-comment"># Get next week's date</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        next_week = now + timezone.timedelta(weeks=<span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment"># Get Point</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        location = Point(longitude, latitude, srid=<span class="hljs-number">4326</span>)</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment"># Look up events</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        events = Event.objects.filter(datetime__gte=now).filter(datetime__lte=next_week).annotate(distance=Distance(<span class="hljs-string">'venue__location'</span>, location)).order_by(<span class="hljs-string">'distance'</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-comment"># Render the template</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-keyword">return</span> render_to_response(<span class="hljs-string">'gigs/lookupresults.html'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            <span class="hljs-string">'events'</span>: events</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>            })</td></tr></table></code></pre><p>Here we’re adding the request context so that the CSRF token is available.</p><p>If you run the dev server, add a few events and venues via the admin, and submit a search, you’ll see that you’re returning events closest to you first.</p><p>Now that we can submit searches, we’re ready to commit:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add gigs/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Can now retrieve search results'</span></td></tr></table></code></pre><p>And we’re done! Of course, you may want to expand on this by plotting each gig venue on a map, or something like that, in which case there’s plenty of methods of doing so - you can retrieve the latitude and longitude in the template and use Google Maps to display them. I’ll leave doing so as an exercise for the reader.</p><p>I can’t say that working with GeoDjango isn’t a bit of a struggle at times, but being able to make spatial queries in this fashion is very useful. With more and more people carrying smartphones, you’re more likely than ever to be asked to build applications that return data based on someone’s geographical location, and GeoDjango is a great way to do this with a Django application. You can find the source on <a href="https://github.com/matthewbdaly/gigfinder">Github</a>.</p></article><article class="post"><p class="date">18th March 2016 7:42 pm</p><h1><a href="/blog/2016/03/18/my-experience-using-php-7-in-production/">My Experience Using PHP 7 in Production</a></h1><p>In the last couple of weeks I’ve been working on a PHP web app. Nothing unusual there, except this was the first time we’d used PHP 7 in production. We discussed the possibility a while back, and eventually decided that for certain projects we’d use PHP 7 without waiting another year or so (or maybe longer) for a version of Debian stable with it by default. I wanted to talk about how our experience has been using it in production.</p><h2 id="background">Background</h2><p>We’ve never really had a fixed stack that we work with at work before until recently - it was largely based on personal preferences and experience. For many jobs, especially content-based sites, we generally used WordPress - it has its issues, but it does fine for a lot of work. For more complex websites, I tended to use CodeIgniter because I’d learned it during my previous job and knew it fairly well, but I was not terribly happy with it - it’s a bit too basic and simplistic, as well as being somewhat behind the times, and I only really kept using it through inertia. For mobile app backends, I tended to use Django, partly for the admin interface, and partly because Django REST Framework makes it easy to build a REST API quickly and easily in a way that wasn’t viable with CodeIgniter.</p><p>This state of affairs couldn’t really continue. I love Python and Django, but I was the only one at work who had ever used Python, so in the event I got hit by a bus there would have been no-one who could have taken over from me. As for CodeIgniter, it was clearly falling further and further behind the curve, and I was sick of it and looking to replace it. Ideally we needed a PHP framework as both myself and my colleague knew it.</p><p>I’d also been playing around with Laravel on a few little projects, but I didn’t get the chance to use it for a new web app until autumn last year. Around the same time, we hired a third developer, who also had some experience using Laravel. In addition, the presence of Lumen meant that we could use that for smaller apps or services that were too small to use Laravel. We therefore decided to adopt Laravel as our default framework - in future we’d only use something else if there was a particular justification for it. I was rather sad to have to abandon Django for work, but pleased to have something more modern than CodeIgniter for PHP projects.</p><p>This also enabled us to standardize our new server builds. Over the last year or so I’ve been pushing to automate what we can of our server setup using Ansible. We now have two standard stacks that we plan to use for future projects. One is for WordPress sites and consists of:</p><ul><li>Debian stable</li><li>Apache</li><li>MySQL</li><li>PHP 5.6</li><li>Memcached</li><li>Varnish</li></ul><p>The other is for Laravel or Lumen web apps or APIs and consists of:</p><ul><li>Debian stable</li><li>Nginx</li><li>PHP 7</li><li>PostgreSQL</li><li>Redis</li></ul><p>It took some time to decide what we wanted to settle on, and indeed we had a mobile app backend that went up around Christmas time that we wrote with Laravel, but deployed to Apache with PHP 5.6 because when we first pushed it up PHP 7 wasn’t out yet. However, given that Laravel 5 already had good support for PHP 7, we decided we’d consider it for the next app. I tend to use PostgreSQL rather than MySQL these days because it has a lot of nifty features like JSON fields and full text search, and using an ORM minimises the learning curve in switching, and Redis is much more versatile than Memcached, so they were vital parts of our stack.</p><h2 id="our-first-php-7-app">Our first PHP 7 app</h2><p>As it happened, we had a Laravel app in the pipeline that was ideal. In the summer of last year, we were hired to make an existing site responsive. In the end, it turned out not to be viable - it was built with Zend Framework, which none of us had ever touched before, and the front end used a lot of custom widgets and fields tied together with RequireJS. The whole thing was rather unwieldy and extremely difficult to maintain and develop. In the end, we decided to tell the client it wasn’t worth developing further and offer to rewrite the whole thing from scratch using Laravel and AngularJS, with Browserify used to handle JavaScript modules - the basic idea was quite simple, it was just the implementation that was overly complex, and AngularJS made it possible to do the same kind of thing with a fraction of the code, so a rewrite in only a few weeks was perfectly viable.</p><p>I’d already built a simple prototype to demonstrate the viability of a from-scratch rewrite using Laravel and Angular, and once the client had agreed to the rewrite, we were able to work on this further. As the web app was going to be particularly useful on mobile devices, I wanted to ensure that the performance was as good as I could possibly make it. By the time we were looking at deploying it to a server, three months had passed since PHP 7 had been first released, and I figured that was long enough for the most serious issues to be resolved, and we could definitely do with the very significant speed boost we’d get from using PHP 7 for this app.</p><p>I use Jenkins to run my unit tests, and so I decided to try installing PHP 7 on the Jenkins server and using that to run the tests. The results were encouraging - nothing broke as a result of the switch. So we therefore decided that when we deployed it, we’d try it with PHP 7, and if it failed, we’d switch to PHP 5.6.</p><p>I opted to use FPM with Nginx rather than Apache and <code>mod_php</code> as since the web app was purely custom we didn’t really need things like <code>.htaccess</code>, and while the amount of static content was limited, Nginx might well perform better for this use case. The results are fairly encouraging - the document for the home page is typically being returned in under 40ms, with the uncached homepage taking around 1.5s in total to load, despite having to load several external fonts. In its current state, the web app scores a solid 93% on YSlow, which I’m very happy with. I don’t know how much of that is down to using PHP 7, but choosing to use it was definitely a good call. I have had absolutely zero issues with it during that time.</p><h2 id="summary">Summary</h2><p>As always, you should bear in mind that your needs may not be the same as mine, and it could well be that you need something that PHP 7 doesn’t yet provide. However, I have had a very good experience with PHP 7 in production. I may have had to jump through a few more hoops to get it up and running, and there may be some level of risk associated with using PHP 7 when it’s only been available for three months, but it’s more than justified by the speed we get from our web app. Using a configuration management system like Ansible means that even if you do have to jump through some extra hoops, it’s relatively easy to automate that process so it’s not as much of an issue as you might think. For me, using PHP 7 with a Laravel app has worked as well as I could have possibly hoped.</p></article><article class="post"><p class="date">26th January 2016 11:40 pm</p><h1><a href="/blog/2016/01/26/mocking-external-apis-in-python/">Mocking External Apis in Python</a></h1><p>It’s quite common to have to integrate an external API into your web app for some of your functionality. However, it’s a really bad idea to have requests be sent to the remote API when running your tests. At best, it means your tests may fail due to unexpected circumstances, such as a network outage. At worst, you could wind up making requests to paid services that will cost you money, or sending push notifications to clients. It’s therefore a good idea to mock these requests in some way, but it can be fiddly.</p><p>In this post I’ll show you several ways you can mock an external API so as to prevent requests being sent when running your test suite. I’m sure there are many others, but these have worked for me recently.</p><h2 id="mocking-the-client-library">Mocking the client library</h2><p>Nowadays many third-party services realise that providing developers with client libraries in a variety of languages is a good idea, so it’s quite common to find a library for interfacing with a third-party service. Under these circumstances, the library itself is usually already thoroughly tested, so there’s no point in you writing additional tests for that functionality. Instead, you can just mock the client library so that the request is never sent, and if you need a response, then you can specify one that will remain constant.</p><p>I recently had to integrate Stripe with a mobile app backend, and I used their client library. I needed to ensure that I got the right result back. In this case I only needed to use the <code>Token</code> object’s <code>create()</code> method. I therefore created a new <code>MockToken</code> class that inherited from <code>Token</code>, and overrode its <code>create()</code> method so that it only accepted one card number and returned a hard-coded response for it:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">from</span> stripe.resource <span class="hljs-keyword">import</span> Token, convert_to_stripe_object</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">from</span> stripe.error <span class="hljs-keyword">import</span> CardError</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockToken</span><span class="hljs-params">(Token)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-meta">    @classmethod</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span><span class="hljs-params">(cls, api_key=None, idempotency_key=None,</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>               stripe_account=None, **params):</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">if</span> params[<span class="hljs-string">'card'</span>][<span class="hljs-string">'number'</span>] != <span class="hljs-string">'4242424242424242'</span>:</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-keyword">raise</span> CardError(<span class="hljs-string">'Invalid card number'</span>, <span class="hljs-literal">None</span>, <span class="hljs-number">402</span>)</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        response = {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-string">"card"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>              <span class="hljs-string">"address_city"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>              <span class="hljs-string">"address_country"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>              <span class="hljs-string">"address_line1"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>              <span class="hljs-string">"address_line1_check"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>              <span class="hljs-string">"address_line2"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>              <span class="hljs-string">"address_state"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>              <span class="hljs-string">"address_zip"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>              <span class="hljs-string">"address_zip_check"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>              <span class="hljs-string">"brand"</span>: <span class="hljs-string">"Visa"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>              <span class="hljs-string">"country"</span>: <span class="hljs-string">"US"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>              <span class="hljs-string">"cvc_check"</span>: <span class="hljs-string">"unchecked"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>              <span class="hljs-string">"dynamic_last4"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>              <span class="hljs-string">"exp_month"</span>: <span class="hljs-number">12</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>              <span class="hljs-string">"exp_year"</span>: <span class="hljs-number">2017</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>              <span class="hljs-string">"fingerprint"</span>: <span class="hljs-string">"49gS1c4YhLaGEQbj"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>              <span class="hljs-string">"funding"</span>: <span class="hljs-string">"credit"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>              <span class="hljs-string">"id"</span>: <span class="hljs-string">"card_17XXdZGzvyST06Z022EiG1zt"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>              <span class="hljs-string">"last4"</span>: <span class="hljs-string">"4242"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>              <span class="hljs-string">"metadata"</span>: {},</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>              <span class="hljs-string">"name"</span>: <span class="hljs-literal">None</span>,</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>              <span class="hljs-string">"object"</span>: <span class="hljs-string">"card"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>              <span class="hljs-string">"tokenization_method"</span>: <span class="hljs-literal">None</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>          },</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>            <span class="hljs-string">"client_ip"</span>: <span class="hljs-string">"192.168.1.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>            <span class="hljs-string">"created"</span>: <span class="hljs-number">1453817861</span>,</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>            <span class="hljs-string">"id"</span>: <span class="hljs-string">"tok_42XXdZGzvyST06Z0LA6h5gJp"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>            <span class="hljs-string">"livemode"</span>: <span class="hljs-literal">False</span>,</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>            <span class="hljs-string">"object"</span>: <span class="hljs-string">"token"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"card"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>            <span class="hljs-string">"used"</span>: <span class="hljs-literal">False</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-keyword">return</span> convert_to_stripe_object(response, api_key, stripe_account)</td></tr></table></code></pre><p>Much of this was lifted straight from the source code for the library. I then wrote a test for the payment endpoint and patched the <code>Token</code> class:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">    @mock.patch('stripe.Token', MockToken)</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_payments</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        data = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">"number"</span>: <span class="hljs-string">'1111111111111111'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">"exp_month"</span>: <span class="hljs-number">12</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">"exp_year"</span>: <span class="hljs-number">2017</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">"cvc"</span>: <span class="hljs-string">'123'</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        response = self.client.post(reverse(<span class="hljs-string">'payments'</span>), data=data, format=<span class="hljs-string">'json'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)</td></tr></table></code></pre><p>This replaced <code>stripe.Token</code> with <code>MockToken</code> so that in this test, the response from the client library was always going to be the expected one.</p><p>If the response doesn’t matter and all you need to do is be sure that the right method would have been called, this is easier. You can just mock the method in question using <code>MagicMock</code> and assert that it has been called afterwards, as in this example:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReminderTest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_send_reminder</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-comment"># Mock PushService.create_message()</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        PushService.create_message = mock.MagicMock(name=<span class="hljs-string">"create_message"</span>)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-comment"># Call reminder task</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        send_reminder()</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-comment"># Check user would have received a push notification</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        PushService.create_message.assert_called_with([{<span class="hljs-string">'text'</span>: <span class="hljs-string">'My push'</span>, <span class="hljs-string">'conditions'</span>: [<span class="hljs-string">'UserID'</span>, <span class="hljs-string">'EQ'</span>, <span class="hljs-number">1</span>]}])</td></tr></table></code></pre><h2 id="mocking-lower-level-requests">Mocking lower-level requests</h2><p>Sometimes, no client library is available, or it’s not worth using one as you only have to make one or two requests. Under these circumstances, there are ways to mock the actual request to the external API. If you’re using the <code>requests</code> module, then there’s a <code>responses</code> module that’s ideal for mocking the API request.</p><p>Suppose we have the following code:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> json, requests</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_request_to_api</span><span class="hljs-params">(data)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-comment"># Put together the request</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    params = {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-string">'auth'</span>: settings.AUTH_KEY,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-string">'data'</span>: data</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    response = requests.post(settings.API_URL, data={<span class="hljs-string">'params'</span>: json.dumps(params)})</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">return</span> response</td></tr></table></code></pre><p>Using <code>responses</code> we can mock the response from the server in our test:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APITest</span><span class="hljs-params">(TestCase)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">    @responses.activate</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_send_request</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-comment"># Mock the API</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        responses.add(responses.POST,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            settings.API_URL,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            status=<span class="hljs-number">200</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            content_type=<span class="hljs-string">"application/json"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            body=<span class="hljs-string">'{"item_id": "12345678"}'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-comment"># Call function</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        data = {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">"surname"</span>: <span class="hljs-string">"Smith"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-string">"location"</span>: <span class="hljs-string">"London"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        send_request_to_api(data)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment"># Check request went to correct URL</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">assert</span> responses.calls[<span class="hljs-number">0</span>].request.url == settings.API_URL</td></tr></table></code></pre><p>Note the use of the <code>@responses.activate</code> decorator. We use <code>responses.add()</code> to set up each URL we want to be able to mock, and pass through details of the response we want to return. We then make the request, and check that it was made as expected.</p><p>You can find more details of the <code>responses</code> module <a href="https://github.com/getsentry/responses">here</a>.</p><h2 id="summary">Summary</h2><p>I’m pretty certain that there are other ways you can mock an external API in Python, but these ones have worked for me recently. If you use another method, please feel free to share it in the comments.</p></article><article class="post"><p class="date">18th November 2015 7:52 pm</p><h1><a href="/blog/2015/11/18/learning-more-about-react-dot-js-and-flux/">Learning More About React.js and Flux</a></h1><p>Udemy have very kindly provided some vouchers for free access to their course, <a href="https://www.udemy.com/learn-and-understand-reactjs/">“Build Web Apps with ReactJS and Flux”</a> for me to give away to subscribers. To redeem them, follow the link above and use the voucher code <code>MatthewDalysBlog</code>.</p><p>There’s only 50 in total, and they are on a first-come, first-serve basis, so I suggest you redeem them sooner rather than later.</p></article><article class="post"><p class="date">28th September 2015 8:00 pm</p><h1><a href="/blog/2015/09/28/building-a-real-time-twitter-stream-with-node-dot-js-react-dot-js-and-redis/">Building a Real-time Twitter Stream With Node.js, React.js and Redis</a></h1><p>In the last year or so, React.js has taken the world of web development by storm. A major reason for this is that it makes it possible to build <strong>isomorphic web applications</strong> - web apps where the same code can run on the client and the server. Using React.js, you can create a template that will be executed on the server when the page first loads, and then the same template can be used to re-render the content when it’s updated, whether that’s via AJAX, WebSockets or another method entirely.</p><p>In this tutorial, I’ll show you how to build a simple Twitter streaming app using Node.js. I’m actually <a href="https://scotch.io/tutorials/build-a-real-time-twitter-stream-with-node-and-react-js">not the only person to have built this to demonstrate React.js</a>, but this is my own particular take on this idea, since it’s such an obvious use case for React.</p><h2 id="what-is-react-js-">What is React.js?</h2><p>A lot of people get rather confused over this issue. It’s not correct to compare React.js with frameworks like Angular.js or Backbone.js. It’s often described as being just the V in MVC - it represents only the view layer. If you’re familiar with Backbone.js, I think it’s reasonable to compare it to Backbone’s views, albeit with it’s own templating syntax. It does not provide the following functionality like Angular and Backbone do:</p><ul><li>Support for models</li><li>Any kind of helpers for AJAX requests</li><li>Routing</li></ul><p>If you want any of this functionality, you need to look elsewhere. There are other libraries around that offer this kind of functionality, so if you want to use React as part of some kind of MVC structure, you can do so - they’re just not a part of the library itself.</p><p>React.js uses a so-called “virtual DOM” - rather than re-rendering the view from scratch when the state changes, it instead retains a virtual representation of the DOM in memory, updates that, then figures out what changes are required to update the existing DOM and applies them. This means it only needs to change what actually changes, making it faster than other client-side templating systems. Combined with the ability to render on the server side, React allows you to build high-performance apps that combine the initial speed and SEO advantages of conventional web apps with the responsiveness of single-page web apps.</p><p>To create components with React, it’s common to use an XML-like syntax called JSX. It’s not mandatory, but I highly recommend you do so as it’s much more intuitive than creating elements with Javascript.</p><h2 id="getting-started">Getting started</h2><p>You’ll need a Twitter account, and you’ll need to <a href="https://apps.twitter.com/">create a new Twitter app</a> and obtain the security credentials to let you access the Twitter Streaming API. You’ll also need to have Node.js installed (ideally using <code>nvm</code>) - at this time, however, you can’t use Node 4.0 because of issues with Redis. You will also need to install Redis and hiredis - if you’ve worked through my previous Redis tutorials you’ll have these already.</p><p>We’ll be using Gulp.js as our build system, and Bower to install some client-side packages, so they need to be installed globally:</p><pre><code class="hljs lang-bash singleline">$ npm install -g gulp bower</code></pre><p>We’ll also be using Compass to help with our stylesheets:</p><pre><code class="hljs lang-bash singleline">$ sudo gem install compass</code></pre><p>With that all done, let’s start work on our app. First, run the following command to create your <code>package.json</code>:</p><pre><code class="hljs lang-bash singleline">$ npm init</code></pre><p>I’m assuming you’re well-acquainted enough with Node.js to know what this does, and can answer the questions without difficulty. I won’t cover writing tests in this tutorial as, but set your test command to <code>gulp test</code> and you should be fine.</p><p>Next, we need to install our dependencies:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm install --save babel compression express hbs hiredis lodash morgan react redis socket.io socket.io-client twitter</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ npm install --save-dev browserify chai gulp gulp-compass gulp-coveralls gulp-istanbul gulp-jshint gulp-mocha gulp-uglify jshint-stylish reactify request vinyl-buffer vinyl-source-stream</td></tr></table></code></pre><h2 id="planning-our-app">Planning our app</h2><p>Now, it’s worth taking a few minutes to plan the architecture of our app. We want to have the app listen to the Twitter Streaming API and filter for messages with any arbitrary string in them - in this case we’ll be searching for “javascript”, but you can set it to anything you like. That means that that part needs to be listening all the time, not just when someone is using the app. Also, it doesn’t fit neatly into the usual request-response cycle - if several people visit the site at once, we could end up with multiple connections to fetch the same data, which is really not efficient, and could cause problems with duplicate tweets showing up.</p><p>Instead, we’ll have a separate <code>worker.js</code> file which runs constantly. This will listen for any matching messages on Twitter. When one appears, rather than returning it itself, it will publish it to a Redis channel, as well as persisting it. Then, the web app, which will be the <code>index.js</code> file, will be subscribed to the same channel, and will receive the tweet and push it to all current users using Socket.io.</p><p>This is a good example of a message queue, and it’s a common pattern. It allows you to create dedicated sections of your app for different tasks, and means that they will generally be more robust. In this case, if the worker goes down, users will still be able to see some tweets, and if the server goes down, the tweets will still be persisted to Redis. In theory, this would also allow you to scale your app more easily by allowing movement of different tasks to different servers, and several app servers could interface with a single worker process. The only downside I can think of is that on a platform like Heroku you’d need to have a separate dyno for the worker process - however, with Heroku’s pricing model changing recently, since this needs to be listening all the time it won’t be suitable for the free tier anyway.</p><p>First let’s create our <code>gulpfile.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> gulp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> jshint = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-jshint'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">var</span> source = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-source-stream'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">var</span> buffer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-buffer'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">var</span> browserify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'browserify'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">var</span> reactify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'reactify'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">var</span> mocha = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-mocha'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">var</span> istanbul = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-istanbul'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">var</span> coveralls = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-coveralls'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">var</span> compass = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-compass'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">var</span> uglify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-uglify'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">var</span> paths = {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attr">scripts</span>: [<span class="hljs-string">'components/*.jsx'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">styles</span>: [<span class="hljs-string">'src/sass/*.scss'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>gulp.task(<span class="hljs-string">'lint'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-keyword">return</span> gulp.src([</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      <span class="hljs-string">'index.js'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      <span class="hljs-string">'components/*.js'</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>      ])</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    .pipe(jshint())</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    .pipe(jshint.reporter(<span class="hljs-string">'jshint-stylish'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>gulp.task(<span class="hljs-string">'compass'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  gulp.src(<span class="hljs-string">'src/sass/*.scss'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    .pipe(compass({</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>      <span class="hljs-attr">css</span>: <span class="hljs-string">'static/css'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>      <span class="hljs-attr">sass</span>: <span class="hljs-string">'src/sass'</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }))</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    .pipe(gulp.dest(<span class="hljs-string">'static/css'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>});;</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>gulp.task(<span class="hljs-string">'test'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>  gulp.src(<span class="hljs-string">'index.js'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    .pipe(istanbul())</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    .pipe(istanbul.hookRequire())</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    .on(<span class="hljs-string">'finish'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>      gulp.src(<span class="hljs-string">'test/test.js'</span>, {<span class="hljs-attr">read</span>: <span class="hljs-literal">false</span>})</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        .pipe(mocha({ <span class="hljs-attr">reporter</span>: <span class="hljs-string">'spec'</span> }))</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        .pipe(istanbul.writeReports({</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>          <span class="hljs-attr">reporters</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>            <span class="hljs-string">'lcovonly'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>            <span class="hljs-string">'cobertura'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>            <span class="hljs-string">'html'</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>          ]</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        }))</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        .pipe(istanbul.enforceThresholds({ <span class="hljs-attr">thresholds</span>: { <span class="hljs-attr">global</span>: <span class="hljs-number">90</span> } }))</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        .once(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>          process.exit(<span class="hljs-number">0</span>);</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        })</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        .once(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>          process.exit(<span class="hljs-number">0</span>);</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>gulp.task(<span class="hljs-string">'coveralls'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>  gulp.src(<span class="hljs-string">'coverage/lcov.info'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    .pipe(coveralls());</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>gulp.task(<span class="hljs-string">'react'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>  <span class="hljs-keyword">return</span> browserify({ <span class="hljs-attr">entries</span>: [<span class="hljs-string">'components/index.jsx'</span>], <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span> })</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>    .transform(reactify)</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    .bundle()</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>    .pipe(source(<span class="hljs-string">'bundle.js'</span>))</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    .pipe(buffer())</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>    .pipe(uglify())</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>    .pipe(gulp.dest(<span class="hljs-string">'static/jsx/'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>gulp.task(<span class="hljs-string">'default'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>  gulp.watch(paths.scripts, [<span class="hljs-string">'react'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>  gulp.watch(paths.styles, [<span class="hljs-string">'compass'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>});</td></tr></table></code></pre><p>I’ve added tasks for the tests and JSHint if you choose to implement them, but the only ones I’ve actually used are the <code>compass</code> and <code>react</code> tasks. The <code>compass</code> task compiles our Sass files into CSS, while the <code>react</code> task uses Browserify to take our React components and various modules installed using NPM and build them for use in the browser, as well as minifying them. Note that we installed React and lodash with NPM? We’re going to be able to use them in the browser and on the server, thanks to Browserify.</p><p>Next, let’s create our <code>worker.js</code> file:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">/*jslint node: true */</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">'use strict'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-comment">// Get dependencies</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">var</span> Twitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'twitter'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-comment">// Set up Twitter client</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> Twitter({</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-attr">consumer_key</span>: process.env.TWITTER_CONSUMER_KEY,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  <span class="hljs-attr">consumer_secret</span>: process.env.TWITTER_CONSUMER_SECRET,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  <span class="hljs-attr">access_token_key</span>: process.env.TWITTER_ACCESS_TOKEN_KEY,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-attr">access_token_secret</span>: process.env.TWITTER_ACCESS_TOKEN_SECRET</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-comment">// Set up connection to Redis</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-keyword">var</span> redis;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-keyword">if</span> (process.env.REDIS_URL) {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient(process.env.REDIS_URL);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>} <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>client.stream(<span class="hljs-string">'statuses/filter'</span>, {<span class="hljs-attr">track</span>: <span class="hljs-string">'javascript'</span>, <span class="hljs-attr">lang</span>: <span class="hljs-string">'en'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stream</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  stream.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tweet</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-comment">// Log it to console</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-built_in">console</span>.log(tweet);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-comment">// Publish it</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    redis.publish(<span class="hljs-string">'tweets'</span>, <span class="hljs-built_in">JSON</span>.stringify(tweet));</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">// Persist it to a Redis list</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    redis.rpush(<span class="hljs-string">'stream:tweets'</span>, <span class="hljs-built_in">JSON</span>.stringify(tweet));</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>  <span class="hljs-comment">// Handle errors</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>  stream.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-built_in">console</span>.log(error);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>});</td></tr></table></code></pre><p>Most of this file should be fairly straightforward. We set up our connection to Twitter (you’ll need to set the various environment variables listed here using the appropriate method for your operating system), and a connection to Redis.</p><p>We then stream the Twitter statuses that match our filter. When we receive a tweet, we log it to the console (feel free to comment this out in production if desired), publish it to a Redis channel called <code>tweets</code>, and push it to the end of a Redis list called <code>stream:tweets</code>. When an error occurs, we output it to the console.</p><p>Let’s use Bootstrap to style the app. Create the following <code>.bowerrc</code> file:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-string">"directory"</span>: <span class="hljs-string">"static/bower_components"</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>}</td></tr></table></code></pre><p>Then run <code>bower init</code> to create your <code>bower.json</code> file, and install Bootstrap with <code>bower install --save sass-bootstrap</code>.</p><p>With that done, create the file <code>src/sass/style.scss</code> and enter the following:</p><pre><code class="hljs lang-scss"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">@import</span> <span class="hljs-string">"compass/css3/user-interface"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">@import</span> <span class="hljs-string">"compass/css3"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">@import</span> <span class="hljs-string">"../../static/bower_components/sass-bootstrap/lib/bootstrap.scss"</span>;</td></tr></table></code></pre><p>This includes some dependencies from Compass, as well as Bootstrap. We won’t be using any of the Javascript features of Bootstrap, so we don’t need to worry too much about that.</p><p>Next, we need to create our view files. As React will be used to render the main part of the page, these will be very basic, with just the header, footer, and a section where the content can be rendered. First, create <code>views/index.hbs</code>:</p><pre><code class="hljs lang-handlebars"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-template-variable">{{&gt; header }}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-12"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'view'</span>&gt;</span><span class="hljs-template-variable">{{{ markup }}}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"initial-state"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"application/json"</span>&gt;</span><span class="hljs-template-variable">{{{state}}}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-template-variable">{{&gt; footer }}</span></td></tr></table></code></pre><p>As promised, this a very basic layout. Note the <code>markup</code> variable, which is where the markup generated by React will be inserted when rendered on the server, and the <code>state</code> variable, which will contain the JSON representation of the data used to generate that markup. By passing that data through, you can ensure that the instance of React on the client has access to the same raw data as was passed through to the view on the server side, so that when the data needs to be re-rendered, it can be done so correctly.</p><p>We’ll also define partials for the header and footer. The header should be in <code>views/partials/header.hbs</code>:</p><pre><code class="hljs lang-handlebars"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">&lt;!--[if lt IE 7]&gt;      &lt;html class="no-js lt-ie9 lt-ie8 lt-ie7"&gt; &lt;![endif]--&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">&lt;!--[if IE 7]&gt;         &lt;html class="no-js lt-ie9 lt-ie8"&gt; &lt;![endif]--&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-comment">&lt;!--[if IE 8]&gt;         &lt;html class="no-js lt-ie9"&gt; &lt;![endif]--&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-comment">&lt;!--[if gt IE 8]&gt;&lt;!--&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"no-js"</span>&gt;</span> <span class="hljs-comment">&lt;!--&lt;![endif]--&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Tweet Stream<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">""</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-comment">&lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/css/style.css"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">&lt;!--[if lt IE 7]&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            &lt;p class="browsehappy"&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href="http://browsehappy.com/"&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        &lt;![endif]--&gt;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar navbar-inverse navbar-static-top"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"navigation"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container-fluid"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-header"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>                    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-toggle"</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">"collapse"</span> <span class="hljs-attr">data-target</span>=<span class="hljs-string">"#header-nav"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>                    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-brand"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>Tweet Stream<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"collapse navbar-collapse navbar-right"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"header-nav"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></td></tr></table></code></pre><p>The footer should be in <code>views/partials/footer.hbs</code>:</p><pre><code class="hljs lang-handlebars"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/jsx/bundle.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></td></tr></table></code></pre><p>Note that we load the Javascript file <code>/jsx/bundle.js</code> - this is the output from the command <code>gulp react</code>.</p><h2 id="creating-the-back-end">Creating the back end</h2><p>The next step is to implement the back end of the website. Add the following code as <code>index.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">/*jslint node: true */</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">'use strict'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-built_in">require</span>(<span class="hljs-string">'babel/register'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-comment">// Get dependencies</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">var</span> app = express();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">var</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">var</span> port = process.env.PORT || <span class="hljs-number">5000</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">var</span> base_url = process.env.BASE_URL || <span class="hljs-string">'http://localhost:5000'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">var</span> hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">var</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-keyword">var</span> Tweets = React.createFactory(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./components/tweets.jsx'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-comment">// Set up connection to Redis</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-keyword">var</span> redis, subscribe;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-keyword">if</span> (process.env.REDIS_URL) {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient(process.env.REDIS_URL);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient(process.env.REDIS_URL);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>} <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>  redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td><span class="hljs-comment">// Set up templating</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>app.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/views'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">"hbs"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>app.engine(<span class="hljs-string">'hbs'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>).__express);</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td><span class="hljs-comment">// Register partials</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>hbs.registerPartials(__dirname + <span class="hljs-string">'/views/partials'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td><span class="hljs-comment">// Set up logging</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>app.use(morgan(<span class="hljs-string">'combined'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td><span class="hljs-comment">// Compress responses</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>app.use(compression());</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td><span class="hljs-comment">// Set URL</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>app.set(<span class="hljs-string">'base_url'</span>, base_url);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td><span class="hljs-comment">// Serve static files</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>app.use(express.static(__dirname + <span class="hljs-string">'/static'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td><span class="hljs-comment">// Render main view</span></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>  <span class="hljs-comment">// Get tweets</span></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>  redis.lrange(<span class="hljs-string">'stream:tweets'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, tweets</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-keyword">if</span> (err) {</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>      <span class="hljs-built_in">console</span>.log(err);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    } <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>      <span class="hljs-comment">// Get tweets</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>      <span class="hljs-keyword">var</span> tweet_list = [];</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>      tweets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tweet, i</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>        tweet_list.push(<span class="hljs-built_in">JSON</span>.parse(tweet));</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>      <span class="hljs-comment">// Render page</span></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>      <span class="hljs-keyword">var</span> markup = React.renderToString(Tweets({ <span class="hljs-attr">data</span>: tweet_list.reverse() }));</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>      res.render(<span class="hljs-string">'index'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        <span class="hljs-attr">markup</span>: markup,</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        <span class="hljs-attr">state</span>: <span class="hljs-built_in">JSON</span>.stringify(tweet_list)</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td><span class="hljs-comment">// Listen</span></td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td><span class="hljs-keyword">var</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)({</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>}).listen(app.listen(port));</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td><span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Listening on port "</span> + port);</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td><span class="hljs-comment">// Handle connections</span></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>  <span class="hljs-comment">// Subscribe to the Redis channel</span></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>  subscribe.subscribe(<span class="hljs-string">'tweets'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>  <span class="hljs-comment">// Handle receiving messages</span></td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>  <span class="hljs-keyword">var</span> callback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, data</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>    socket.emit(<span class="hljs-string">'message'</span>, data);</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>  };</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>  subscribe.on(<span class="hljs-string">'message'</span>, callback);</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>  <span class="hljs-comment">// Handle disconnect</span></td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>  socket.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>    subscribe.removeListener(<span class="hljs-string">'message'</span>, callback);</td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td>});</td></tr></table></code></pre><p>Let’s go through this bit by bit:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">/*jslint node: true */</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">'use strict'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-built_in">require</span>(<span class="hljs-string">'babel/register'</span>);</td></tr></table></code></pre><p>Here we’re using Babel, which is a library that allows you to use new features in Javascript even if the interpreter doesn’t support it. It also includes support for JSX, allowing us to require JSX files in the same way we would require Javascript files.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">// Get dependencies</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">var</span> app = express();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">var</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">var</span> port = process.env.PORT || <span class="hljs-number">5000</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">var</span> base_url = process.env.BASE_URL || <span class="hljs-string">'http://localhost:5000'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">var</span> hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">var</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">var</span> Tweets = React.createFactory(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./components/tweets.jsx'</span>));</td></tr></table></code></pre><p>Here we include our dependencies. Most of this will be familiar if you’ve used Express before, but we also use React to create a factory for a React component called <code>Tweets</code>.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">// Set up connection to Redis</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> redis, subscribe;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">if</span> (process.env.REDIS_URL) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient(process.env.REDIS_URL);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient(process.env.REDIS_URL);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>} <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-comment">// Set up templating</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>app.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/views'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">"hbs"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>app.engine(<span class="hljs-string">'hbs'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>).__express);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-comment">// Register partials</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>hbs.registerPartials(__dirname + <span class="hljs-string">'/views/partials'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-comment">// Set up logging</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>app.use(morgan(<span class="hljs-string">'combined'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td><span class="hljs-comment">// Compress responses</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>app.use(compression());</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td><span class="hljs-comment">// Set URL</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>app.set(<span class="hljs-string">'base_url'</span>, base_url);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td><span class="hljs-comment">// Serve static files</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>app.use(express.static(__dirname + <span class="hljs-string">'/static'</span>));</td></tr></table></code></pre><p>This section sets up the various dependencies of our app. We set up two connections to Redis - one for handling subscriptions, the other for reading from Redis in order to populate the view.</p><p>We also set up our views, logging, compression of the HTTP response, a base URL, and serving static files.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">// Render main view</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-comment">// Get tweets</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  redis.lrange(<span class="hljs-string">'stream:tweets'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, tweets</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">if</span> (err) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      <span class="hljs-built_in">console</span>.log(err);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    } <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      <span class="hljs-comment">// Get tweets</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>      <span class="hljs-keyword">var</span> tweet_list = [];</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>      tweets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tweet, i</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        tweet_list.push(<span class="hljs-built_in">JSON</span>.parse(tweet));</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      <span class="hljs-comment">// Render page</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      <span class="hljs-keyword">var</span> markup = React.renderToString(Tweets({ <span class="hljs-attr">data</span>: tweet_list.reverse() }));</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      res.render(<span class="hljs-string">'index'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-attr">markup</span>: markup,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-attr">state</span>: <span class="hljs-built_in">JSON</span>.stringify(tweet_list)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>});</td></tr></table></code></pre><p>Our app only has a single view. When the root is loaded, we first of all fetch all of the tweets stored in the <code>stream:tweets</code> list. We then convert them into an array of objects.</p><p>Next, we render the <code>Tweets</code> component to a string, passing through our list of tweets, and store the resulting markup. We then pass through this markup and the string representation of the list of tweets to the template.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">// Listen</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)({</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>}).listen(app.listen(port));</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Listening on port "</span> + port);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-comment">// Handle connections</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="hljs-comment">// Subscribe to the Redis channel</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  subscribe.subscribe(<span class="hljs-string">'tweets'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  <span class="hljs-comment">// Handle receiving messages</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-keyword">var</span> callback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, data</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    socket.emit(<span class="hljs-string">'message'</span>, data);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  };</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  subscribe.on(<span class="hljs-string">'message'</span>, callback);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-comment">// Handle disconnect</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  socket.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    subscribe.removeListener(<span class="hljs-string">'message'</span>, callback);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>});</td></tr></table></code></pre><p>Finally, we set up Socket.io. On a connection, we subscribe to the Redis channel <code>tweets</code>. When we receive a tweet from Redis, we emit that tweet so that it can be rendered on the client side. We also handle disconnections by removing our Redis subscription.</p><h2 id="creating-our-react-components">Creating our React components</h2><p>Now it’s time to create our first React component. We’ll create a folder called <code>components</code> to hold all of our component files. Our first file is <code>components/index.jsx</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> Tweets = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./tweets.jsx'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">var</span> initialState = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'initial-state'</span>).innerHTML);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>React.render(</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tweets</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{initialState}</span> /&gt;</span></span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'view'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>);</td></tr></table></code></pre><p>First of all, we include React and the same <code>Tweets</code> component we require on the server side (note that we need to specify the <code>.jsx</code> extension). Then we fetch the initial state from the script tag we created earlier. Finally we render the <code>Tweets</code> components, passing through the initial state, and specify that it should be inserted into the element with an id of <code>view</code>. Note that we store the initial state in <code>data</code> - inside the component, this can be accessed as <code>this.props.data</code>.</p><p>This particular component is only ever used on the client side - when we render on the server side, we don’t need any of this functionality since we insert the markup into the <code>view</code> element anyway, and we don’t need to specify the initial data in the same way.</p><p>Next, we define the <code>Tweets</code> component in <code>components/tweets.jsx</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io-client'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">var</span> TweetList = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./tweetlist.jsx'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">var</span> Tweets = React.createClass({</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-attr">componentDidMount</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">// Get reference to this item</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">// Set up the connection</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">var</span> socket = io.connect(<span class="hljs-built_in">window</span>.location.href);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-comment">// Handle incoming messages</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      <span class="hljs-comment">// Insert the message</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      <span class="hljs-keyword">var</span> tweets = that.props.data;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      tweets.push(<span class="hljs-built_in">JSON</span>.parse(data));</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      tweets = _.sortBy(tweets, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> item.created_at;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>      }).reverse();</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>      that.setProps({<span class="hljs-attr">data</span>: tweets});</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>  <span class="hljs-attr">getInitialState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">return</span> {<span class="hljs-attr">data</span>: <span class="hljs-keyword">this</span>.props.data};</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Tweets<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">TweetList</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{this.props.data}</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    )</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td><span class="hljs-built_in">module</span>.exports = Tweets;</td></tr></table></code></pre><p>Let’s work our way through each section in turn:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io-client'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">var</span> TweetList = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./tweetlist.jsx'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);</td></tr></table></code></pre><p>Here we include React and the Socket.io client, as well as Lodash and our TweetList component. With React.js, it’s recommend that you break up each individual part of your interface into a single component - here <code>Tweets</code> is a wrapper for the tweets that includes a heading. <code>TweetList</code> will be a list of tweets, and <code>TweetItem</code> will be an individual tweet.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> Tweets = React.createClass({</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-attr">componentDidMount</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-comment">// Get reference to this item</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-comment">// Set up the connection</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">var</span> socket = io.connect(<span class="hljs-built_in">window</span>.location.href);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">// Handle incoming messages</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      <span class="hljs-comment">// Insert the message</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-keyword">var</span> tweets = that.props.data;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      tweets.push(<span class="hljs-built_in">JSON</span>.parse(data));</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      tweets = _.sortBy(tweets, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> item.created_at;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      }).reverse();</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      that.setProps({<span class="hljs-attr">data</span>: tweets});</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr></table></code></pre><p>Note the use of the <code>componentDidMount</code> method - this fires when a component has been rendered on the client side for the first time. You can therefore use it to set up events. Here, we’re setting up a callback so that when a new tweet is received, we get the existing tweets (stored in <code>this.props.data</code>, although we copy <code>this</code> to <code>that</code> so it works inside the callback), push the tweet to this list, sort it by the time created, and set <code>this.props.data</code> to the new value. This will result in the tweets being re-rendered.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  getInitialState: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">return</span> {<span class="hljs-attr">data</span>: <span class="hljs-keyword">this</span>.props.data};</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  },</td></tr></table></code></pre><p>Here we set the initial state of the component - it sets the value of <code>this.state</code> to the object passed through. In this case, we pass through an object with the attribute <code>data</code> defined as the value of <code>this.props.data</code>, meaning that <code>this.state.data</code> is the same as <code>this.props.data</code>.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  render: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Tweets<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">TweetList</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{this.props.data}</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    )</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-built_in">module</span>.exports = Tweets;</td></tr></table></code></pre><p>Here we define our <code>render</code> function. This can be thought of as our template. Note that we include <code>TweetList</code> inside our template and pass through the data. Afterwards, we export <code>Tweets</code> so it can be used elsewhere.</p><p>Next, let’s create <code>components/tweetlist.jsx</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> TweetItem = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./tweetitem.jsx'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">var</span> TweetList = React.createClass({</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">var</span> tweetNodes = <span class="hljs-keyword">this</span>.props.data.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item, index</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TweetItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{item.text}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">TweetItem</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>      );</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tweets list-group"</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        {tweetNodes}</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    )</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-built_in">module</span>.exports = TweetList;</td></tr></table></code></pre><p>This component is much simpler - it only has a <code>render</code> method. First, we get our individual tweets and for each one define a <code>TweetItem</code> component. Then we create an unordered list and insert the tweet items into it. We then export it as <code>TweetList</code>.</p><p>Our final component is the <code>TweetItem</code> component. Create the following file at <code>components/tweetitem.jsx</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">var</span> TweetItem = React.createClass({</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-group-item"</span>&gt;</span>{this.props.text}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    );</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-built_in">module</span>.exports = TweetItem;</td></tr></table></code></pre><p>This component is quite simple. It’s just a single list item with the text set to the value of the tweet’s <code>text</code> attribute.</p><p>That should be all of our components done. Time to compile our Sass and run Browserify:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ gulp compass</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ gulp react</td></tr></table></code></pre><p>Now, if you make sure you have set the appropriate environment variables, and then run <code>node worker.js</code> in one terminal, and <code>node index.js</code> in another, and visit <a href="http://localhost:5000/">http://localhost:5000/</a>, you should see your Twitter stream in all its glory! You can also try it with Javascript disabled, or in a text-mode browser such as Lynx, to demonstrate that it still renders the page without having to do anything on the client side - you’re only missing the constant updates.</p><h2 id="wrapping-up">Wrapping up</h2><p>I hope this gives you some idea of how you can easily use React.js on both the client and server side to make web apps that are fast and search-engine friendly while also being easy to update dynamically. You can find the source code on <a href="https://github.com/matthewbdaly/twitter-stream">GitHub</a>.</p><p>Hopefully I’ll be able to publish some later tutorials that build on this to show you how to build more substantial web apps with React.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2020/06/13/flow-typed-ajax-responses-with-react-hooks/">Flow Typed AJAX Responses With React Hooks</a></p><p><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></p><p><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></p><p><a href="/blog/2020/02/09/don&#x27;t-use-stdclass/">Don&#x27;t Use Stdclass</a></p><p><a href="/blog/2020/01/25/f***-phpstorm-man-and-the-high-horse-he-rode-in-on/">F*** Phpstorm Man and the High Horse He Rode in on</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/posts/19/">Newer</a></li><li class="page-item"><a class="page-link" href="/posts/21/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2020.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>