<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/10/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="https://www.specificfeeds.com/matthewdaly?subParam=followPub">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">29th November 2016 11:00 pm</p><h1><a href="/blog/2016/11/29/testing-laravel-middleware/">Testing Laravel Middleware</a></h1><p>It’s widely accepted that high-level integration tests alone do not make for a good test suite. Ideally each individual component of your application should have unit tests, which test that component in isolation. These unit tests are usually much quicker to run, making it easier to practice test-driven development. However, it can sometimes be hard to grasp how to test that one component on its own.</p><p>The other day I had an issue with several middleware classes for a Laravel application and I wanted to verify that they were working as expected. Sounds like a job for dedicated unit tests, but I hadn’t tested custom middleware in isolation before, and figuring out how to do so took a while.</p><p>Laravel middleware accepts an instance of <code>Illuminate\Http\Request</code>, itself based on the Symfony request object, as well as a closure for the action to take next. Depending on what the middleware does, it may return a redirect or simply amend the existing request or response. So in theory you can instantiate a request object, pass it to the middleware, and check the response. For middleware that does something simple, such as redirecting users based on certain conditions, this is fairly straightforward.</p><p>In this example we have a fairly useless piece of middleware that checks to see what the route is for a request and redirects it if it matches a certain pattern:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedirectFromAdminMiddleware</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Handle an incoming request.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">if</span> ($request-&gt;is(<span class="hljs-string">'admin*'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>}</td></tr></table></code></pre><p>While this example is of limited use, it wouldn’t take much work to develop it to redirect conditionally based on an account type, and it’s simple enough to demonstrate the principles involved. In these tests, we create instances of <code>Illuminate\Http\Request</code> and pass them to the middleware’s <code>handle()</code> method, along with an empty closure representing the response. If the middleware does not amend the request, we get the empty response from the closure. If it does amend the request, we get a redirect response.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedirectFromAdminMiddlewareTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRedirectMiddlewareCalledOnAdmin</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/admin'</span>, <span class="hljs-string">'GET'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\RedirectFromAdminMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $response = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{});</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals($response-&gt;getStatusCode(), <span class="hljs-number">302</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRedirectMiddlewareNotCalledOnNonAdmin</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/pages'</span>, <span class="hljs-string">'GET'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\RedirectFromAdminMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        $response = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{});</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals($response, <span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>For middleware that fetches the response and acts on it, things are a little more complex. For instance, this is the Etag middleware I use on many projects:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ETagMiddleware</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     * Implement Etag support</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-comment">// Get response</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $response = $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-comment">// If this was a GET request...</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">if</span> ($request-&gt;isMethod(<span class="hljs-string">'get'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            <span class="hljs-comment">// Generate Etag</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            $etag = md5($response-&gt;getContent());</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            $requestEtag = str_replace(<span class="hljs-string">'"'</span>, <span class="hljs-string">''</span>, $request-&gt;getETags());</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-comment">// Check to see if Etag has changed</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-keyword">if</span>($requestEtag &amp;&amp; $requestEtag[<span class="hljs-number">0</span>] == $etag) {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>                $response-&gt;setNotModified();</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-comment">// Set Etag</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            $response-&gt;setEtag($etag);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>}</td></tr></table></code></pre><p>This acts on the response object, so we need to pass that through as well. Fortunately, Mockery allows us to create a mock of our response object and set it up to handle only those methods we anticipate being called:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ETagMiddlewareTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Test new request not cached</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testModified</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-comment">// Create mock response</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $response = Mockery::mock(<span class="hljs-string">'Illuminate\Http\Response'</span>)-&gt;shouldReceive(<span class="hljs-string">'getContent'</span>)-&gt;once()-&gt;andReturn(<span class="hljs-string">'blah'</span>)-&gt;getMock();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $response-&gt;shouldReceive(<span class="hljs-string">'setEtag'</span>)-&gt;with(md5(<span class="hljs-string">'blah'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/admin'</span>, <span class="hljs-string">'GET'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\ETagMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $middlewareResponse = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($response)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     * Test repeated request not modified</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testNotModified</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-comment">// Create mock response</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $response = Mockery::mock(<span class="hljs-string">'Illuminate\Http\Response'</span>)-&gt;shouldReceive(<span class="hljs-string">'getContent'</span>)-&gt;once()-&gt;andReturn(<span class="hljs-string">'blah'</span>)-&gt;getMock();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $response-&gt;shouldReceive(<span class="hljs-string">'setEtag'</span>)-&gt;with(md5(<span class="hljs-string">'blah'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        $response-&gt;shouldReceive(<span class="hljs-string">'setNotModified'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/admin'</span>, <span class="hljs-string">'GET'</span>, [], [], [], [</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>            <span class="hljs-string">'ETag'</span> =&gt; md5(<span class="hljs-string">'blah'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\ETagMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        $middlewareResponse = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($response)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>            <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">teardown</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        Mockery::close();</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>}</td></tr></table></code></pre><p>In the first example we mock out the <code>getContent()</code> and <code>setEtag()</code> methods of our response to make sure they get called, and then pass the request to the middleware, along with a closure that returns the response. In the second example, we also mock out <code>setNotModified()</code> to ensure that the correct status code of 304 is set, and add an ETag to our request. In this way we can easily test our middleware in isolation, rather than having to resort to building up our entire application just to test one small method.</p><p>Middleware is a convenient place to put functionality that’s needed for many routes, but you shouldn’t neglect testing it, and ideally you shouldn’t have to resort to writing a slow integration test to test it works as expected. By mocking out your dependencies, it’s generally not too hard to test it in isolation, resulting in faster and more robust test suites.</p></article><article class="post"><p class="date">26th November 2016 9:40 pm</p><h1><a href="/blog/2016/11/26/easy-static-asset-versioning-in-php/">Easy Static Asset Versioning in PHP</a></h1><p>It’s prudent to cache static assets such as images, Javascript and CSS to improve performance, but that raises the issue of changes not being reflected in your site due to visitor’s browsers retaining the cached versions. Many content management systems and frameworks already handle this for you (such as Laravel’s Elixir build system), but what if you have to work with a legacy application that doesn’t do this?</p><p>Fortunately there’s a quite easy solution in PHP. Using the <code>filemtime()</code> function described <a href="http://php.net/manual/en/function.filemtime.php">here</a>, we can get a Unix timestamp for when a file was last altered. This is perfect to use to identify when a file last changed, because by appending a new query string to the file name when loading it, we can trick the browser into thinking it’s a new file when it’s not, as in this example for a CodeIgniter application:</p><pre><code class="hljs lang-php singleline">&lt;link rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> href=<span class="hljs-string">"&lt;?=$path?&gt;?v=&lt;?=filemtime($path)?&gt;"</span>&gt;</code></pre><p>Obviously, this is a bit repetitive, so you may want to refactor this into some kind of template helper to make it easier to use, but the underlying principle applies to most programming languages. For instance, if you wanted to do so in a Handlebars template, you might want to create a helper something like this:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">var</span> Handlebars = <span class="hljs-built_in">require</span>(<span class="hljs-string">'handlebars'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Handlebars.registerHelper(<span class="hljs-string">'version'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   <span class="hljs-keyword">return</span> path + <span class="hljs-string">'?v='</span> + fs.statSync(path).mtime.getTime();</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>});</td></tr></table></code></pre><p>Where more robust solutions such as Elixir are already available, I’d advise making full use of them. However, this technique is a quick and easy way to implement versioning for static assets in existing projects.</p></article><article class="post"><p class="date">13th November 2016 4:15 pm</p><h1><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">Building a Phonegap App With Laravel and Angular - Part 4</a></h1><p>In this instalment we’ll return to the back end. What we’ve done so far is typical of the kind of proof of concept we might do for a client early on, before going back and implementing the full set of features later on. Now we’ll go back and start to improve on that rather quick-and-dirty API by making sure we follow a few best practices.</p><p>For those of you who want to follow the Laravel Phonegap tutorials, I’ve created a dedicated category <a href="/blog/categories/laravel-phonegap-tutorial/">here</a> for those tutorials. This category include RSS and Atom feeds, so if you only want to read those posts, you can do so. I’ve also done the same for the <a href="/blog/categories/django-blog-tutorial/">Django tutorials</a>.</p><h2 id="the-repository-pattern">The Repository pattern</h2><p>One of the issues we currently have with our API is that we’re passing our Eloquent models into our controllers. This may not seem like a huge issue, but it means that our controllers are tightly coupled to the Eloquent ORM, so if we wanted to switch to another ORM, or to a completely different database such as MongoDB, we’d have to amend our controllers. That’s not good.</p><p>However, using the <a href="http://designpatternsphp.readthedocs.io/en/latest/More/Repository/README.html">Repository pattern</a> we can first of all define an interface for our repository, and then create a repository class that implements that interface. That way we can interact with the repository class in our controllers, rather than using Eloquent models directly. Then, if we want to switch databases, we merely amend the repository class to change the implementation of those methods, without having to touch our controllers. Also, it makes it much easier to test our controllers in isolation, because we can easily mock our repository class using Mockery and hard-code the response, so our tests won’t touch the database and will therefore run more quickly. We won’t touch on that this time, but it’s a very significant advantage.</p><p>If you haven’t used interfaces before in PHP, they aren’t that hard. They merely specify what methods an object implementing that method must have and what arguments they must accept, but do not specify the details of the implementation. This makes it easy to determine if a class implements an interface correctly, because it will throw an exception if it doesn’t.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PetRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>That’s all there is to it. We define it using the <code>interface</code> keyword and we specify the methods it must implement. Save this file at <code>app/Repositories/Interfaces/PetRepositoryInterface.php</code>.</p><p>Next, we implement the repository class:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Pet</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">PetRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EloquentPetRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PetRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">private</span> $pet;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Pet $pet)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;pet = $pet;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;pet-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;pet-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;pet-&gt;create($input);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>}</td></tr></table></code></pre><p>Save this to <code>app/Repositories/EloquentPetRepository.php</code>. Note how the methods closely mirror the underlying Eloquent methods, but they don’t need to - you could change the underlying implementation of each method, but the repository would still work in exactly the same way.</p><p>To make this work, we need to make a few changes elsewhere. In <code>composer.json</code>, we need to add the new <code>Repositories</code> folder to our classmap:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "autoload": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "classmap": [</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            "database",</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            "app/Repositories"</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        ],</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        "psr-4": {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            "AnimalFriend\\": "app/"</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    },</td></tr></table></code></pre><p>And in <code>app/Providers/AppServiceProvider.php</code>, we need to bind our new files:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind(</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'AnimalFriend\Repositories\Interfaces\PetRepositoryInterface'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-string">'AnimalFriend\Repositories\EloquentPetRepository'</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>}</td></tr></table></code></pre><p>With that done, we can now update <code>app/Http/Controllers/PetController.php</code> to use the repository:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">PetRepositoryInterface</span> <span class="hljs-title">as</span> <span class="hljs-title">Pet</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PetController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">private</span> $pet;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Pet $pet)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;pet = $pet;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     * Display a listing of the resource.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-comment">// Get all pets</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        $pets = <span class="hljs-keyword">$this</span>-&gt;pet-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;json($pets, <span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     * Show the form for creating a new resource.</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * Store a newly created resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * Display the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        <span class="hljs-comment">// Get pet</span></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>        $pet = <span class="hljs-keyword">$this</span>-&gt;pet-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;json($pet, <span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>     * Show the form for editing the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">edit</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>     * Update the specified resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(Request $request, $id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="92"></td><td>     * Remove the specified resource from storage.</td></tr><tr><td class="linenos" data-pseudo-content="93"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="94"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="95"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="96"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="97"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroy</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="98"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="99"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="100"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="101"></td><td>}</td></tr></table></code></pre><p>Our repository is now injected automatically into the controller. To make this work we need to run the following command:</p><pre><code class="hljs lang-bash singleline">$ composer dump-autoload</code></pre><p>Running our tests should confirm that everything is still working:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpunit</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>PHPUnit 5.5.4 by Sebastian Bergmann and contributors.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>............                                                      12 / 12 (100%)</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Time: 897 ms, Memory: 18.00MB</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>OK (12 tests, 46 assertions)</td></tr></table></code></pre><p>Let’s do the same for the User model. First we implement our interface in <code>app/Repositories/Interfaces/UserRepositoryInterface.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>Next we create our repository at <code>app/Repositories/EloquentUserRepository.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">JWTAuth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EloquentUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">private</span> $user;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $user)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;user = $user;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;user-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;user-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">$this</span>-&gt;user;</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $user-&gt;email = $input[<span class="hljs-string">'email'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        $user-&gt;name = $input[<span class="hljs-string">'name'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        $user-&gt;password = Hash::make($input[<span class="hljs-string">'password'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        $user-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-comment">// Create token</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> JWTAuth::fromUser($user);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>}</td></tr></table></code></pre><p>Note how we’ve moved much of the logic for creating a user into the <code>create()</code> method, and we return the token, not the user model. This makes sense as right now we only ever want to get a token back when we create a user. Later that may change, but there’s nothing stopping us adding a new method to implement that behaviour alongside this.</p><p>Then we update <code>app/Http/Controllers/UserController.php</code> to use our repository:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span> <span class="hljs-title">as</span> <span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">JWTAuth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">private</span> $user;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $user)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;user = $user;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Display a listing of the resource.</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * Show the form for creating a new resource.</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     * Store a newly created resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-comment">// Validate request</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $valid = <span class="hljs-keyword">$this</span>-&gt;validate($request, [</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'required|email|unique:users,email'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'required|string'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'required|confirmed'</span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-comment">// Create token</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        $token = <span class="hljs-keyword">$this</span>-&gt;user-&gt;create($request-&gt;only(</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>            <span class="hljs-string">'email'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>            <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>            <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        ));</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;json([<span class="hljs-string">'token'</span> =&gt; $token], <span class="hljs-number">201</span>);</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>     * Display the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>     * Show the form for editing the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">edit</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>     * Update the specified resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="92"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="93"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="94"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="95"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(Request $request, $id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="96"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="97"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="98"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="99"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="100"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="101"></td><td>     * Remove the specified resource from storage.</td></tr><tr><td class="linenos" data-pseudo-content="102"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="103"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="104"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="105"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="106"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroy</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="107"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="108"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="109"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="110"></td><td>}</td></tr></table></code></pre><p>And add a new binding in <code>app/Providers/AppServiceProvider.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind(</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'AnimalFriend\Repositories\Interfaces\PetRepositoryInterface'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-string">'AnimalFriend\Repositories\EloquentPetRepository'</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind(</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            <span class="hljs-string">'AnimalFriend\Repositories\Interfaces\UserRepositoryInterface'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            <span class="hljs-string">'AnimalFriend\Repositories\EloquentUserRepository'</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>Note that we bind the two sets separately - this allows Laravel to figure out which one maps to which.</p><p>Let’s run our tests to make sure nothing is broken:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpunit </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>PHPUnit 5.5.4 by Sebastian Bergmann and contributors.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>............                                                      12 / 12 (100%)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Time: 956 ms, Memory: 18.00MB</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>OK (12 tests, 46 assertions)</td></tr></table></code></pre><p>Now that we’ve got our repositories in place, we’re no longer tightly coupled to Eloquent, and have a more flexible implementation which is easier to test.</p><h2 id="separating-our-models-from-our-json-with-fractal">Separating our models from our JSON with Fractal</h2><p>Another problem with our API is that our representation of our data is tightly coupled to our underlying implementation of our models. We therefore can’t change our models without potentially changing the data returned by the API. We need to separate our representation of our data from our actual model so that we can more easily specify the exact data we want to return, regardless of the underlying database structure.</p><p>Enter <a href="http://fractal.thephpleague.com/">Fractal</a>. From the website:</p><blockquote><p>Fractal provides a presentation and transformation layer for complex data output, the like found in RESTful APIs, and works really well with JSON. Think of this as a view layer for your JSON/YAML/etc.</p></blockquote><p>In other words, Fractal lets you specify the format your data will take in one place so that it’s easier to return that data in a desired format. We’ll use Fractal to specify how we want our API responses to be formatted.</p><p>Install Fractal with the following command:</p><pre><code class="hljs lang-php singleline">$ composer <span class="hljs-keyword">require</span> league/fractal</code></pre><p>Then amend the classmap in <code>composer.json</code>:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "autoload": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "classmap": [</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            "database",</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            "app/Repositories",</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            "app/Transformers"</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ],</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        "psr-4": {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            "AnimalFriend\\": "app/"</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    },</td></tr></table></code></pre><p>Then create the folder <code>app/Transformers</code> and run <code>composer dump-autoload</code>. We’re now ready to write our first transformer. Save this as <code>app/Transformers/PetTransformer.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Transformers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Pet</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Fractal</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PetTransformer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Fractal</span>\<span class="hljs-title">TransformerAbstract</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Pet $pet)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $pet-&gt;id,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-string">'name'</span>          =&gt; (string) $pet-&gt;name,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-string">'type'</span>          =&gt; (string) $pet-&gt;type,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            <span class="hljs-string">'available'</span>     =&gt; (bool) $pet-&gt;available,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'picture'</span>       =&gt; (string) $pet-&gt;picture</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>The <code>transform</code> method specifies how we want to represent our objects with our API. We can return only those attributes we want to expose, and amend the structure as we see fit. We could easily represemt relations in whatever manner we see fit, whereas before we needed to amend our queries to return the data in the right format, which would potentially be cumbersome.</p><p>Now let’s amend <code>PetController.php</code> to use this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">PetRepositoryInterface</span> <span class="hljs-title">as</span> <span class="hljs-title">Pet</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">PetTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Fractal</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Fractal</span>\<span class="hljs-title">Manager</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PetController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">private</span> $pet, $fractal;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Pet $pet, Manager $fractal)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;pet = $pet;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fractal = $fractal;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * Display a listing of the resource.</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-comment">// Get all pets</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        $pets = <span class="hljs-keyword">$this</span>-&gt;pet-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-comment">// Format it</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        $resource = <span class="hljs-keyword">new</span> Fractal\Resource\Collection($pets, <span class="hljs-keyword">new</span> PetTransformer);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        $data = <span class="hljs-keyword">$this</span>-&gt;fractal-&gt;createData($resource)-&gt;toArray();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;json($data, <span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     * Show the form for creating a new resource.</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>     * Store a newly created resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * Display the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>        <span class="hljs-comment">// Get pet</span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        $pet = <span class="hljs-keyword">$this</span>-&gt;pet-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>        <span class="hljs-comment">// Format it</span></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        $resource = <span class="hljs-keyword">new</span> Fractal\Resource\Item($pet, <span class="hljs-keyword">new</span> PetTransformer);</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        $data = <span class="hljs-keyword">$this</span>-&gt;fractal-&gt;createData($resource)-&gt;toArray();</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;json($data, <span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>     * Show the form for editing the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">edit</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="92"></td><td>     * Update the specified resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="93"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="94"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="95"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="96"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="97"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="98"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(Request $request, $id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="99"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="100"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="101"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="102"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="103"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="104"></td><td>     * Remove the specified resource from storage.</td></tr><tr><td class="linenos" data-pseudo-content="105"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="106"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="107"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="108"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="109"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroy</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="110"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="111"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="112"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="113"></td><td>}</td></tr></table></code></pre><p>Note that by default, Fractal places our data inside a dedicated <code>data</code> namespace. This is good because it leaves a place for us to put metadata such as pagination links, but it does mean our controller test has been broken. Let’s fix it:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Testing</span>\<span class="hljs-title">DatabaseMigrations</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PetControllerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">DatabaseMigrations</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Test fetching pets when unauthorised</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingPetsWhenUnauthorised</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">// Create a Pet</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $pet = factory(AnimalFriend\Pet::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Freddie'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'pets'</span>, [<span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;call(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/pets'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">400</span>);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     * Test fetching pets when authorised</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingPets</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-comment">// Create a Pet</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $pet = factory(AnimalFriend\Pet::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Freddie'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'pets'</span>, [<span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment">// Create a User</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        $user = factory(AnimalFriend\User::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'bobsmith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'users'</span>, [<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        $token = JWTAuth::fromUser($user);</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        $headers = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>            <span class="hljs-string">'Authorization'</span> =&gt; <span class="hljs-string">'Bearer '</span>.$token</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-comment">// Send it</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">$this</span>-&gt;json(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/pets'</span>, [], $headers)</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>            -&gt;seeJsonStructure([</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>                <span class="hljs-string">'data'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>                    <span class="hljs-string">'*'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>                        <span class="hljs-string">'id'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>                        <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>                        <span class="hljs-string">'type'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>                        <span class="hljs-string">'available'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>                        <span class="hljs-string">'picture'</span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>                    ]</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>                ]</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>            ]);</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>     * Test fetching pet when unauthorised</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingPetWhenUnauthorised</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>        <span class="hljs-comment">// Create a Pet</span></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>        $pet = factory(AnimalFriend\Pet::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Freddie'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'pets'</span>, [<span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        <span class="hljs-comment">// Send request</span></td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;call(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/pets/'</span>.$pet-&gt;id);</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">400</span>);</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>     * Test fetching pet which does not exist</td></tr><tr><td class="linenos" data-pseudo-content="92"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="93"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="94"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="95"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingPetDoesNotExist</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="96"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="97"></td><td>        <span class="hljs-comment">// Create a User</span></td></tr><tr><td class="linenos" data-pseudo-content="98"></td><td>        $user = factory(AnimalFriend\User::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="99"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'bobsmith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="100"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="101"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="102"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'users'</span>, [<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="103"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="104"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="105"></td><td>        $token = JWTAuth::fromUser($user);</td></tr><tr><td class="linenos" data-pseudo-content="106"></td><td>        $headers = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="107"></td><td>            <span class="hljs-string">'Authorization'</span> =&gt; <span class="hljs-string">'Bearer '</span>.$token</td></tr><tr><td class="linenos" data-pseudo-content="108"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="109"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="110"></td><td>        <span class="hljs-comment">// Send it</span></td></tr><tr><td class="linenos" data-pseudo-content="111"></td><td>        <span class="hljs-keyword">$this</span>-&gt;json(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/pets/1'</span>, [], $headers);</td></tr><tr><td class="linenos" data-pseudo-content="112"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">404</span>);</td></tr><tr><td class="linenos" data-pseudo-content="113"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="114"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="115"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="116"></td><td>     * Test fetching pet when authorised</td></tr><tr><td class="linenos" data-pseudo-content="117"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="118"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="119"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="120"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingPet</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="121"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="122"></td><td>        <span class="hljs-comment">// Create a Pet</span></td></tr><tr><td class="linenos" data-pseudo-content="123"></td><td>        $pet = factory(AnimalFriend\Pet::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="124"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Freddie'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="125"></td><td>            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="126"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="127"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'pets'</span>, [<span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="128"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="129"></td><td>        <span class="hljs-comment">// Create a User</span></td></tr><tr><td class="linenos" data-pseudo-content="130"></td><td>        $user = factory(AnimalFriend\User::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="131"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'bobsmith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="132"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="133"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="134"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'users'</span>, [<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="135"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="136"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="137"></td><td>        $token = JWTAuth::fromUser($user);</td></tr><tr><td class="linenos" data-pseudo-content="138"></td><td>        $headers = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="139"></td><td>            <span class="hljs-string">'Authorization'</span> =&gt; <span class="hljs-string">'Bearer '</span>.$token</td></tr><tr><td class="linenos" data-pseudo-content="140"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="141"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="142"></td><td>        <span class="hljs-comment">// Send it</span></td></tr><tr><td class="linenos" data-pseudo-content="143"></td><td>        <span class="hljs-keyword">$this</span>-&gt;json(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/pets/'</span>.$pet-&gt;id, [], $headers)</td></tr><tr><td class="linenos" data-pseudo-content="144"></td><td>            -&gt;seeJsonStructure([</td></tr><tr><td class="linenos" data-pseudo-content="145"></td><td>                <span class="hljs-string">'data'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="146"></td><td>                    <span class="hljs-string">'id'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="147"></td><td>                    <span class="hljs-string">'name'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="148"></td><td>                    <span class="hljs-string">'type'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="149"></td><td>                    <span class="hljs-string">'available'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="150"></td><td>                    <span class="hljs-string">'picture'</span></td></tr><tr><td class="linenos" data-pseudo-content="151"></td><td>                ]</td></tr><tr><td class="linenos" data-pseudo-content="152"></td><td>            ]);</td></tr><tr><td class="linenos" data-pseudo-content="153"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="154"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="155"></td><td>}</td></tr></table></code></pre><p>We’re also going to amend our test settings to use the array backend for the cache, as this does not require any external dependencies, but still allows us to tag our cache keys (I’ll cover that in a future instalment). Change the cache settings in <code>phpunit.xml</code> as follows:</p><pre><code class="hljs lang-xml singleline">        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CACHE_DRIVER"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"array"</span>/&gt;</span></code></pre><p>Let’s run our tests to make sure everything’s fine:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpunit </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>PHPUnit 5.5.4 by Sebastian Bergmann and contributors.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>............                                                      12 / 12 (100%)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Time: 859 ms, Memory: 18.00MB</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>OK (12 tests, 44 assertions)</td></tr></table></code></pre><p>At present our <code>User</code> controller doesn’t actually return anything, and the auth only ever returns the token, so it’s not worth while adding a transformer now.</p><h2 id="wrapping-up">Wrapping up</h2><p>That ends this lesson. We haven’t added any functionality, but we have improved the design of our API, and we’re now ready to develop it further. As usual, the backend repository has been tagged as <code>lesson-4</code>.</p><p>Next time we’ll start adding the additional functionality we need to our API.</p></article><article class="post"><p class="date">24th October 2016 12:25 am</p><h1><a href="/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/">Creating An Azure Storage Adapter for Laravel</a></h1><p>UPDATE: This post has now been superseded by <a href="/blog/2017/10/29/an-azure-filesystem-integration-for-laravel/">this one</a> as I’ve released this integration as a package.</p><p>About a year ago I was working on my first non-trivial Laravel application. The client had, for their own reasons, wanted to use Microsoft’s Azure platform, particularly for its blob storage functionality, which is somewhat comparable to Amazon S3. Now, Laravel has the excellent <code>Storage</code> facade that allows consistent access to both local files and those stored on various file hosting services, which is built on top of <a href="https://flysystem.thephpleague.com/">Flysystem</a>. Flysystem has an Azure driver, but the Laravel storage doesn’t include support for it, so at the time I resigned myself to using Flysystem directly, which wasn’t actually that bad, but not ideal.</p><p>A few days ago I stumbled across <a href="https://laravel.com/docs/5.1/filesystem#custom-filesystems">this section of the Laravel documentation</a>, which had me kicking myself. It’s actually trivially easy to implement a custom filesystem for Laravel if it already has a Flysystem adapter, as demonstrated in their Dropbox implementation in the docs. Using this as a guide, I was able to produce the following service provider for using Azure as a storage backend very quickly:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Storage</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Flysystem</span>\<span class="hljs-title">Filesystem</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Flysystem</span>\<span class="hljs-title">Azure</span>\<span class="hljs-title">AzureAdapter</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">WindowsAzure</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">ServicesBuilder</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AzureStorageServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * Perform post-registration booting of services.</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        Storage::extend(<span class="hljs-string">'azure'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($app, $config)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            $endpoint = sprintf(</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">'DefaultEndpointsProtocol=https;AccountName=%s;AccountKey=%s'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>                $config[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>                $config[<span class="hljs-string">'key'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            $blobRestProxy = ServicesBuilder::getInstance()-&gt;createBlobService($endpoint);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Filesystem(<span class="hljs-keyword">new</span> AzureAdapter($blobRestProxy, $config[<span class="hljs-string">'container'</span>]));</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     * Register bindings in the container.</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>}</td></tr></table></code></pre><p>This should be saved as <code>app/Providers/AzureStorageServiceProvider.php</code>. You also need to add this to the list of service providers in <code>config/app.php</code>:</p><pre><code class="hljs lang-php singleline">        App\Providers\AzureStorageServiceProvider::class,</code></pre><p>And add this to <code>config/filesystems.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>        <span class="hljs-string">'azure'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>            <span class="hljs-string">'driver'</span>    =&gt; <span class="hljs-string">'azure'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-string">'name'</span>      =&gt; env(<span class="hljs-string">'STORAGE_NAME'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'key'</span>       =&gt; env(<span class="hljs-string">'STORAGE_KEY'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'container'</span> =&gt; env(<span class="hljs-string">'STORAGE_CONTAINER'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ],</td></tr></table></code></pre><p>I like to also set my storage backend using environment variables in this file, as in this example:</p><pre><code class="hljs lang-php singleline">    <span class="hljs-string">'default'</span> =&gt; env(<span class="hljs-string">'STORAGE_BACKEND'</span>, <span class="hljs-string">'local'</span>),</code></pre><p>That way we can easily set a different backend for testing, development and production so we don’t upload files when running PHPUnit. You can also keep your other config settings in your <code>.env</code> file, which is always a better idea than keeping it under version control. You also need to install the <code>microsoft/windowsazure</code> and <code>league/flysystem-azure</code> packages via Composer for this to work.</p><p>As I’ve since changed jobs it’s unlikely I’ll ever actually use this Azure integration in production - it’s not a service I’d choose of my own accord to use. However, since it’s so straightforward to implement an adapter like this I imagine I may be doing something similar - I’m currently working on a web app that uses MongoDB for some of its data and currently stores files locally, so it might make sense to create a GridFS integration along similar lines. It may also be useful for someone else, so feel free to use it if you wish.</p></article><article class="post"><p class="date">16th October 2016 6:10 pm</p><h1><a href="/blog/2016/10/16/building-a-phonegap-app-with-laravel-and-angular-part-3/">Building a Phonegap App With Laravel and Angular - Part 3</a></h1><p>Apologies for how long it’s taken for this post to appear. I’ve got a lot on my plate at present as I recently started a new job, so I haven’t been able to devote as much time to this series as I’d like.</p><p>In this instalment we’ll begin extending our app beyond the basic authentication we’ve already implemented. We’ll start by adding the means to sign up, before adding the list of pets.</p><h2 id="adding-a-signup-method-to-our-backend">Adding a signup method to our backend</h2><p>We’ll create a controller for our users in the Laravel backend. First we’ll create our tests:</p><pre><code class="hljs lang-bash singleline">$ php artisan make:<span class="hljs-built_in">test</span> UserControllerTest</code></pre><p>We’ll create three tests. The first will check to see that an invalid request raises the correct status code (422). The second will check that a valid request returns the correct status code (201) and creates the user. The third will check that trying to create a duplicate user raises an error. Here they are - they should be saved in the new <code>tests/UserControllerTest.php</code> file:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Testing</span>\<span class="hljs-title">DatabaseMigrations</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserControllerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Test creating a user - invalid</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPostingInvalidUser</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-comment">// Create a request</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $data = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Bob Smith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">$this</span>-&gt;json(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/api/users'</span>, $data);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">422</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Test creating a user</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPostingUser</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Create a request</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $data = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Bob Smith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'password'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            <span class="hljs-string">'password_confirmation'</span> =&gt; <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">$this</span>-&gt;json(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/api/users'</span>, $data);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">201</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'users'</span>, [<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        <span class="hljs-comment">// Check user exists</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        $saved = User::first();</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals($saved-&gt;email, <span class="hljs-string">'bob@example.com'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals($saved-&gt;name, <span class="hljs-string">'Bob Smith'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>     * Test creating a duplicate user</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPostingDuplicateUser</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment">// Create user</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        $user = factory(AnimalFriend\User::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Bob Smith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        <span class="hljs-keyword">$this</span>-&gt;seeInDatabase(<span class="hljs-string">'users'</span>, [<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>        <span class="hljs-comment">// Create a request</span></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        $data = <span class="hljs-keyword">array</span>(</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Bob Smith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'password'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>            <span class="hljs-string">'password_confirmation'</span> =&gt; <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>        <span class="hljs-keyword">$this</span>-&gt;json(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/api/users'</span>, $data);</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertResponseStatus(<span class="hljs-number">422</span>);</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>}</td></tr></table></code></pre><p>Note the use of <code>$this-&gt;json()</code> to make the request. This method is ideal for testing a REST API.</p><p>Running our tests should confirm that they fail:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpunit</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>PHPUnit 5.5.4 by Sebastian Bergmann and contributors.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>........FFF.                                                      12 / 12 (100%)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Time: 827 ms, Memory: 18.00MB</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>There were 3 failures:</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>1) UserControllerTest::testPostingInvalidUser</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>Expected status code 422, got 404.</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>Failed asserting that 404 matches expected 422.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>/home/matthew/Projects/mynewanimalfriend-backend/tests/UserControllerTest.php:21</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>2) UserControllerTest::testPostingUser</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Expected status code 201, got 404.</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>Failed asserting that 404 matches expected 201.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>/home/matthew/Projects/mynewanimalfriend-backend/tests/UserControllerTest.php:39</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>3) UserControllerTest::testPostingDuplicateUser</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>Expected status code 422, got 404.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>Failed asserting that 404 matches expected 422.</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>/home/matthew/Projects/mynewanimalfriend-backend/vendor/laravel/framework/src/Illuminate/Foundation/Testing/Concerns/MakesHttpRequests.php:648</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>/home/matthew/Projects/mynewanimalfriend-backend/tests/UserControllerTest.php:71</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>FAILURES!</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>Tests: 12, Assertions: 43, Failures: 3.</td></tr></table></code></pre><p>Next, we create our new controller:</p><pre><code class="hljs lang-bash singleline">$ php artisan make:controller UserController --resource</code></pre><p>Let’s populate it:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">AnimalFriend</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">JWTAuth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">private</span> $user;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $user)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;user = $user;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Display a listing of the resource.</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * Show the form for creating a new resource.</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     * Store a newly created resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-comment">// Validate request</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $valid = <span class="hljs-keyword">$this</span>-&gt;validate($request, [</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'required|email|unique:users,email'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'required|string'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'required|confirmed'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-comment">// Create user</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        $user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">$this</span>-&gt;user;</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>        $user-&gt;email = $request-&gt;input(<span class="hljs-string">'email'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        $user-&gt;name = $request-&gt;input(<span class="hljs-string">'name'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>        $user-&gt;password = Hash::make($request-&gt;input(<span class="hljs-string">'password'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        $user-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>        <span class="hljs-comment">// Create token</span></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>        $token = JWTAuth::fromUser($user);</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;json([<span class="hljs-string">'token'</span> =&gt; $token], <span class="hljs-number">201</span>);</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>     * Display the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>     * Show the form for editing the specified resource.</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">edit</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="92"></td><td>     * Update the specified resource in storage.</td></tr><tr><td class="linenos" data-pseudo-content="93"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="94"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="95"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="96"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="97"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="98"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(Request $request, $id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="99"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="100"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="101"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="102"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="103"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="104"></td><td>     * Remove the specified resource from storage.</td></tr><tr><td class="linenos" data-pseudo-content="105"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="106"></td><td>     * <span class="hljs-doctag">@param</span>  int  $id</td></tr><tr><td class="linenos" data-pseudo-content="107"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="108"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="109"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroy</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="110"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="111"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="112"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="113"></td><td>}</td></tr></table></code></pre><p>For now we’ll leave the other methods blank, but we’ll be using them later so we won’t get rid of them. At the top, note we load not only the <code>User</code> model, but also the <code>JWTAuth</code> and <code>Hash</code> facades. We use <code>JWTAuth::fromUser()</code> to return a JSON web token for the given user model.</p><p>In the <code>store()</code> method we first of all use <a href="https://laravel.com/docs/5.3/validation">Laravel’s validation support</a> to validate our input. We specify that the user must provide a unique email address, a username, and a password, which must be confirmed. Note that we don’t need to specify an action if the request is invalid, as Laravel will do that for us. Also, note that the <code>confirmed</code> rule means that the <code>password</code> field must be accompanied by a matching <code>password_confirmation</code> field.</p><p>Next, we create the user. Note that we hash the password before storing it, which is a best practice (storing passwords in plain text is a REALLY bad idea!). Then we create the token for the new user and return it. From then on, the user can use that token to authenticate their requests.</p><p>We also need to add this route in <code>routes/api.php</code>:</p><pre><code class="hljs lang-php singleline">Route::resource(<span class="hljs-string">'users'</span>, <span class="hljs-string">'UserController'</span>);</code></pre><p>Let’s check the test passes:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpunit </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>PHPUnit <span class="hljs-number">5.5</span><span class="hljs-number">.4</span> by Sebastian Bergmann <span class="hljs-keyword">and</span> contributors.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>............                                                      <span class="hljs-number">12</span> / <span class="hljs-number">12</span> (<span class="hljs-number">100</span>%)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Time: <span class="hljs-number">905</span> ms, Memory: <span class="hljs-number">20.00</span>MB</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>OK (<span class="hljs-number">12</span> tests, <span class="hljs-number">46</span> assertions)</td></tr></table></code></pre><h2 id="building-the-registration-in-the-app">Building the registration in the app</h2><p>With registration in place on the server side, we can move back to the app. We need to create another route for the registration form. Add this to <code>test/routes.spec.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  it(<span class="hljs-string">'should map register route to register controller'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    inject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$route</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>      expect($route.routes[<span class="hljs-string">'/register'</span>].controller).toBe(<span class="hljs-string">'RegisterCtrl'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expect($route.routes[<span class="hljs-string">'/register'</span>].templateUrl).toEqual(<span class="hljs-string">'templates/register.html'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  });</td></tr></table></code></pre><p>Running the tests should confirm that this fails. So next you should add this to the route provider section of <code>js/main.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  .when(<span class="hljs-string">'/register'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'templates/register.html'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">controller</span>: <span class="hljs-string">'RegisterCtrl'</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  })</td></tr></table></code></pre><p>We also need to allow the register path to be accessed when not logged in:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>.run([<span class="hljs-string">'$rootScope'</span>, <span class="hljs-string">'$location'</span>, <span class="hljs-string">'Auth'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$rootScope, $location, Auth</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  $rootScope.$on(<span class="hljs-string">'$routeChangeStart'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">if</span> (!Auth.isLoggedIn()) {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      <span class="hljs-keyword">if</span> ($location.path() !== <span class="hljs-string">'/login'</span> &amp;&amp; $location.path() !== <span class="hljs-string">'/register'</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $location.path(<span class="hljs-string">'/login'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}])</td></tr></table></code></pre><p>Our next step is to create a service representing the <code>User</code> endpoint. Here’s the test for it:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  describe(<span class="hljs-string">'User service'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">var</span> mockBackend, User;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    beforeEach(inject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">_User_, _$httpBackend_</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      User = _User_;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      mockBackend = _$httpBackend_;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    }));</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    it(<span class="hljs-string">'can create a new user'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>      mockBackend.expectPOST(<span class="hljs-string">'http://localhost:8000/api/users'</span>, <span class="hljs-string">'{"email":"bob@example.com","name":"bobsmith","password":"password","password_confirmation":"password"}'</span>).respond({<span class="hljs-attr">token</span>: <span class="hljs-string">'mytoken'</span>});</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User({</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-attr">email</span>: <span class="hljs-string">'bob@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-attr">name</span>: <span class="hljs-string">'bobsmith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-attr">password</span>: <span class="hljs-string">'password'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attr">password_confirmation</span>: <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      user.$save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        expect(response).toEqualData({<span class="hljs-attr">token</span>: <span class="hljs-string">'mytoken'</span>});</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      mockBackend.flush();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  });</td></tr></table></code></pre><p>We’re only interested in using this model to create new users at this point, so this is the full scope of this test for now. Make sure the test fails, then we’re ready to create the new service in <code>js/services.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>.factory(<span class="hljs-string">'User'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$resource</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-keyword">return</span> $resource(<span class="hljs-string">'http://localhost:8000/api/users/:id'</span>, <span class="hljs-literal">null</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'update'</span>: { <span class="hljs-attr">method</span>: <span class="hljs-string">'PATCH'</span> }</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>})</td></tr></table></code></pre><p>Note that <code>angular-resource</code> does not support the <code>PUT</code> or <code>PATCH</code> methods by default, but as shown here it’s easy to implement it ourselves. That should be sufficient to make our test pass.</p><p>Next, we need to create the controller for registration. Here’s the test for it:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  describe(<span class="hljs-string">'Register Controller'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">var</span> mockBackend, scope;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    beforeEach(inject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$rootScope, $controller, _$httpBackend_</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      mockBackend = _$httpBackend_;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      scope = $rootScope.$<span class="hljs-keyword">new</span>();</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      $controller(<span class="hljs-string">'RegisterCtrl'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">$scope</span>: scope</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }));</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-comment">// Test controller scope is defined</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    it(<span class="hljs-string">'should define the scope'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      expect(scope).toBeDefined();</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">// Test doRegister is defined</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    it(<span class="hljs-string">'should define the register method'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      expect(scope.doRegister).toBeDefined();</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-comment">// Test doRegister works</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    it(<span class="hljs-string">'should allow the user to register'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      <span class="hljs-comment">// Mock the backend</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>      mockBackend.expectPOST(<span class="hljs-string">'http://localhost:8000/api/users'</span>, <span class="hljs-string">'{"email":"user@example.com","name":"bobsmith","password":"password","password_confirmation":"password"}'</span>).respond({<span class="hljs-attr">token</span>: <span class="hljs-number">123</span>});</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>      <span class="hljs-comment">// Define login data</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>      scope.credentials = {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-attr">email</span>: <span class="hljs-string">'user@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-attr">name</span>: <span class="hljs-string">"bobsmith"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-attr">password</span>: <span class="hljs-string">'password'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-attr">password_confirmation</span>: <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>      };</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>      <span class="hljs-comment">//  Submit the request</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>      scope.doRegister();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>      <span class="hljs-comment">// Flush the backend</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>      mockBackend.flush();</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>      <span class="hljs-comment">// Check login complete</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>      expect(localStorage.getItem(<span class="hljs-string">'authHeader'</span>)).toEqual(<span class="hljs-string">'Bearer 123'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>  });</td></tr></table></code></pre><p>Make sure the test fails before proceeding. Our <code>RegisterCtrl</code> is very similar to the login controller:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>.controller(<span class="hljs-string">'RegisterCtrl'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$scope, $location, User, Auth</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  $scope.doRegister = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User($scope.credentials);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    user.$save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      <span class="hljs-keyword">if</span> (response.token) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-comment">// Set up auth service</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        Auth.setUser(response.token);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-comment">// Redirect</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $location.path(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        alert(<span class="hljs-string">'Unable to log in - please check your details are correct'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  };</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>})</td></tr></table></code></pre><p>Check the tests pass,and we’re ready to move on to creating our HTML template. Save this as <code>www/templates/register.html</code>:</p><pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&lt;md-content md-theme=<span class="hljs-string">"default"</span> layout-gt-sm=<span class="hljs-string">"row"</span> layout-padding&gt;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    &lt;div&gt;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        &lt;md-<span class="hljs-keyword">input</span>-container <span class="hljs-keyword">class</span>=<span class="hljs-string">"md-block"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            &lt;<span class="hljs-keyword">label</span>&gt;Email&lt;/<span class="hljs-keyword">label</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            &lt;<span class="hljs-keyword">input</span> ng-model=<span class="hljs-string">"credentials.email"</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"email"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        &lt;/md-<span class="hljs-keyword">input</span>-container&gt;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        &lt;md-<span class="hljs-keyword">input</span>-container <span class="hljs-keyword">class</span>=<span class="hljs-string">"md-block"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            &lt;<span class="hljs-keyword">label</span>&gt;Username&lt;/<span class="hljs-keyword">label</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            &lt;<span class="hljs-keyword">input</span> ng-model=<span class="hljs-string">"credentials.name"</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"text"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        &lt;/md-<span class="hljs-keyword">input</span>-container&gt;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        &lt;md-<span class="hljs-keyword">input</span>-container <span class="hljs-keyword">class</span>=<span class="hljs-string">"md-block"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            &lt;<span class="hljs-keyword">label</span>&gt;Password&lt;/<span class="hljs-keyword">label</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            &lt;<span class="hljs-keyword">input</span> ng-model=<span class="hljs-string">"credentials.password"</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"password"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        &lt;/md-<span class="hljs-keyword">input</span>-container&gt;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        &lt;md-<span class="hljs-keyword">input</span>-container <span class="hljs-keyword">class</span>=<span class="hljs-string">"md-block"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            &lt;<span class="hljs-keyword">label</span>&gt;<span class="hljs-keyword">Confirm</span> Password&lt;/<span class="hljs-keyword">label</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            &lt;<span class="hljs-keyword">input</span> ng-model=<span class="hljs-string">"credentials.password_confirmation"</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"password"</span>&gt;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        &lt;/md-<span class="hljs-keyword">input</span>-container&gt;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        &lt;md-button <span class="hljs-keyword">class</span>=<span class="hljs-string">"md-raised md-primary"</span> ng-click=<span class="hljs-string">"doRegister()"</span>&gt;Submit&lt;/md-button&gt;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        &lt;md-button <span class="hljs-keyword">class</span>=<span class="hljs-string">"md-raised md-primary"</span> href=<span class="hljs-string">"/login"</span>&gt;<span class="hljs-keyword">Log</span> <span class="hljs-keyword">in</span>&lt;/md-button&gt;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    &lt;/div&gt;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>&lt;/md-content&gt;</td></tr></table></code></pre><p>It’s very similar to our login template. Speaking of which, we need to add a link to this route there:</p><pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">md-content</span> <span class="hljs-attr">md-theme</span>=<span class="hljs-string">"default"</span> <span class="hljs-attr">layout-gt-sm</span>=<span class="hljs-string">"row"</span> <span class="hljs-attr">layout-padding</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-input-container</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-block"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ng-model</span>=<span class="hljs-string">"credentials.email"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">md-input-container</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-input-container</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-block"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Password<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ng-model</span>=<span class="hljs-string">"credentials.password"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">md-input-container</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-raised md-primary"</span> <span class="hljs-attr">ng-click</span>=<span class="hljs-string">"doLogin()"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">md-button</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-raised md-primary"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"register"</span>&gt;</span>Register<span class="hljs-tag">&lt;/<span class="hljs-name">md-button</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">md-content</span>&gt;</span></td></tr></table></code></pre><p>With that done, you should now be able to run the Gulp server for the app with <code>gulp</code> and the Laravel backend with <code>php artisan serve</code> and create a new user account.</p><h2 id="adding-pets-to-the-home-page">Adding pets to the home page</h2><p>Our final task for this lesson is to display a list of pets on the home page. Later we’ll refine that functionality, but for now we’ll just get a list of all current pets and display them. First we need to write a test for our <code>Pet</code> service:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  describe(<span class="hljs-string">'Pet service'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">var</span> mockBackend, Pet;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    beforeEach(inject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">_Pet_, _$httpBackend_</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      Pet = _Pet_;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      mockBackend = _$httpBackend_;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    }));</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    it(<span class="hljs-string">'can fetch pets'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>      mockBackend.expectGET(<span class="hljs-string">'http://localhost:8000/api/pets'</span>).respond([{<span class="hljs-attr">id</span>:<span class="hljs-number">1</span>,<span class="hljs-attr">name</span>:<span class="hljs-string">"Freddie"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"Cat"</span>}]);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      expect(Pet).toBeDefined();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-keyword">var</span> pets = Pet.query();</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      mockBackend.flush();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      expect(pets).toEqualData([{<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,<span class="hljs-attr">name</span>:<span class="hljs-string">"Freddie"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"Cat"</span>}]);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  });</td></tr></table></code></pre><p>Once you know that fails, it’s time to implement the service:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>.factory(<span class="hljs-string">'Pet'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$resource</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-keyword">return</span> $resource(<span class="hljs-string">'http://localhost:8000/api/pets/:id'</span>, <span class="hljs-literal">null</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'update'</span>: { <span class="hljs-attr">method</span>: <span class="hljs-string">'PATCH'</span> }</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>})</td></tr></table></code></pre><p>Next, we want to add the pets to the scope of the home controller. Amend the test for it as follows:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  describe(<span class="hljs-string">'Home Controller'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">var</span> pets, scope;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    beforeEach(inject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$rootScope, $controller, Pet</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      pets = Pet;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      scope = $rootScope.$<span class="hljs-keyword">new</span>();</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      $controller(<span class="hljs-string">'HomeCtrl'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">$scope</span>: scope,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">pets</span>: [{<span class="hljs-attr">id</span>:<span class="hljs-number">1</span>},{<span class="hljs-attr">id</span>:<span class="hljs-number">2</span>}]</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    }));</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">// Test controller scope is defined</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    it(<span class="hljs-string">'should define the scope'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      expect(scope).toBeDefined();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-comment">// Test pets</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    it(<span class="hljs-string">'should define the pets'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      expect(scope.pets).toEqualData([{<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>}, {<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>}]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  });</td></tr></table></code></pre><p>We check to see if the scope contains the <code>pets</code> variable. Once you have a failing test, amend the home controller as follows:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>.controller(<span class="hljs-string">'HomeCtrl'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$scope, Pet, pets</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  $scope.pets = pets;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>});</td></tr></table></code></pre><p>We could fetch the via AJAX inside the controller, but there’s a better way. We’ll create a loader for the pet data and have it resolve that before the page is displayed. To do so, first we need to add the loader service to <code>js/services.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>.factory(<span class="hljs-string">'PetsLoader'</span>, [<span class="hljs-string">'Pet'</span>, <span class="hljs-string">'$q'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Pet, $q</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">var</span> delay = $q.defer();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    Pet.query(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      delay.resolve(response);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      delay.reject(<span class="hljs-string">'Unable to fetch pets'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">return</span> delay.promise;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  };</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}])</td></tr></table></code></pre><p>Then we set that route up to resolve it in <code>js/main.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  .when(<span class="hljs-string">'/'</span>, {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'templates/home.html'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">controller</span>: <span class="hljs-string">'HomeCtrl'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">resolve</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      <span class="hljs-attr">pets</span>: [<span class="hljs-string">'PetsLoader'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">PetsLoader</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> PetsLoader();</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      }]</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  })</td></tr></table></code></pre><p>Now, when we load that route, it will first of all fetch those pets and populate <code>$scope.pets</code> with them.</p><p>Now, we need to have some pets in the database, so we’ll make a seeder for it. Head back to the backend and run this command:</p><pre><code class="hljs lang-bash singleline">$ php artisan make:seeder PetTableSeeder</code></pre><p>Then amend the file at <code>database/seeds/PetTableSeeder.php</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Seeder</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Carbon</span>\<span class="hljs-title">Carbon</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PetTableSeeder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Seeder</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     * Run the database seeds.</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-comment">// Add Pets</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        DB::table(<span class="hljs-string">'pets'</span>)-&gt;insert([[</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Freddie'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-string">'available'</span> =&gt; <span class="hljs-number">1</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-string">'picture'</span>   =&gt; <span class="hljs-string">'https://placekitten.com/300/300'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            <span class="hljs-string">'created_at'</span> =&gt; Carbon::now(),</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-string">'updated_at'</span> =&gt; Carbon::now(),</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        ], [</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Sophie'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'Cat'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>            <span class="hljs-string">'available'</span> =&gt; <span class="hljs-number">1</span>,</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'picture'</span>   =&gt; <span class="hljs-string">'https://placekitten.com/300/300'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-string">'created_at'</span> =&gt; Carbon::now(),</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-string">'updated_at'</span> =&gt; Carbon::now(),</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        ]]);</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>}</td></tr></table></code></pre><p>And we need to update <code>database/seeds/DatabaseSeeder.php</code> to call our seeder:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Seeder</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseSeeder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Seeder</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Run the database seeds.</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;call(UserTableSeeder::class);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;call(PetTableSeeder::class);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>For now we’ll use placeholder images, but at a later point our backend will be set up to use images uploaded from the admin. Then we need to refresh our migrations and apply the seeders:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php artisan migrate:refresh</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ php artisan db:seed</td></tr></table></code></pre><p>Now we just need to amend our home template to show the pets and we’re done for today:</p><pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">md-toolbar</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-toolbar-tools"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-button</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"Log out"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/logout"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            Log out</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">md-button</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">md-toolbar</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">layout</span>=<span class="hljs-string">"column"</span> <span class="hljs-attr">flex</span>=<span class="hljs-string">"grow"</span> <span class="hljs-attr">layout-align</span>=<span class="hljs-string">"center stretch"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">md-card</span> <span class="hljs-attr">md-theme</span>=<span class="hljs-string">"default"</span> <span class="hljs-attr">ng-repeat</span>=<span class="hljs-string">"pet in pets"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-card-title</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">md-card-title-text</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-headline"</span>&gt;</span><span class="hljs-template-variable">{{ pet.name }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-subhead"</span>&gt;</span><span class="hljs-template-variable">{{ pet.type }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-tag">&lt;/<span class="hljs-name">md-card-title-text</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">md-card-title</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">md-card-content</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"md-card-image md-media-lg"</span> <span class="hljs-attr">ng-src</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ pet.picture }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">img</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-tag">&lt;/<span class="hljs-name">md-card-content</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">md-card</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr></table></code></pre><p>Now we can see our pets in the app.</p><h2 id="wrapping-up">Wrapping up</h2><p>That’s enough for today - the fact that we can log in and out, register, and view the home page is sufficient as a proof of concept for a client. As usual, the results are on Github, tagged <code>lesson-3</code>.</p><p>Next time, we’ll concentrate exclusively on the back end. We’ll build upon what we already have using Laravel to create a full REST API for our app. In a later instalment, we’ll move on to build our admin interface for the staff, before switching back to finish off the app. I hope you’ll join me then.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/06/23/forcing-ssl-in-codeigniter/">Forcing SSL in Codeigniter</a></p><p><a href="/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/">Logging to the ELK Stack With Laravel</a></p><p><a href="/blog/2018/05/13/full-text-search-with-mariadb/">Full-text Search With Mariadb</a></p><p><a href="/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/">Building a Letter Classifier in PHP With Tesseract OCR and PHP ML</a></p><p><a href="/blog/2018/04/29/console-applications-with-the-symfony-console-component/">Console Applications With the Symfony Console Component</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/9/">Newer</a></li><li><a href="/posts/11/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>