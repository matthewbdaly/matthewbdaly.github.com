<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/10/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">25th September 2017 10:18 pm</p><h1><a href="/blog/2017/09/25/a-generic-php-sms-library/">A Generic PHP SMS Library</a></h1><p>This weekend I published <a href="https://github.com/matthewbdaly/sms-client">sms-client</a>, a generic PHP library for sending SMS notifications. It’s intended to offer a consistent interface when sending SMS notifications by using swappable drivers. That way, if your SMS service provider suddenly goes out of business or bumps up their prices, it’s easy to switch to a new one.</p><p>Out of the box it comes with drivers for the following services:</p><ul><li>Nexmo</li><li>ClockworkSMS</li></ul><p>In addition, it provides the following test drivers:</p><ul><li>Null</li><li>Log</li><li>RequestBin</li></ul><p>Here’s an example of how you might use it with the ClockworkSMS driver:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Client</span> <span class="hljs-title">as</span> <span class="hljs-title">GuzzleClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Psr7</span>\<span class="hljs-title">Response</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">SMS</span>\<span class="hljs-title">Drivers</span>\<span class="hljs-title">Clockwork</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">SMS</span>\<span class="hljs-title">Client</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>$guzzle = <span class="hljs-keyword">new</span> GuzzleClient;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>$resp = <span class="hljs-keyword">new</span> Response;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>$driver = <span class="hljs-keyword">new</span> Clockwork($guzzle, $resp, [</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-string">'MY_CLOCKWORK_API_KEY'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>]);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$client = <span class="hljs-keyword">new</span> Client($driver);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>$msg = [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-string">'to'</span>      =&gt; <span class="hljs-string">'+44 01234 567890'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-string">'content'</span> =&gt; <span class="hljs-string">'Just testing'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>];</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>$client-&gt;send($msg);</td></tr></table></code></pre><p>If you want to roll your own driver for it, it should be easy - just create a class that implements the <code>Matthewbdaly\SMS\Contracts\Driver</code> interface. Most of the existing drivers work using Guzzle to send HTTP requests to an API, but you don’t necessarily have to do that - for instance, you could create a driver for a mail-to-SMS gateway by using Swiftmailer or the PHP mail class. If you create a driver for it, please feel free to submit a pull request so I can add it to the repository.</p><p>For Laravel or Lumen users, there’s <a href="https://github.com/matthewbdaly/laravel-sms">an integration package</a> that should make it easier to use. For users of other frameworks, it should still be fairly straightforward to integrate.</p></article><article class="post"><p class="date">8th September 2017 10:05 pm</p><h1><a href="/blog/2017/09/08/installing-nginx-unit-on-ubuntu/">Installing Nginx Unit on Ubuntu</a></h1><p>Recently Nginx announced the release of the first beta of <a href="https://www.nginx.com/products/nginx-unit/">Unit</a>, an application server that supports Python, PHP and Go, with support coming for Java, Node.js and Ruby.</p><p>The really interesting part is that not only does it support more than one language, but Unit can be configured by making HTTP requests, rather than by editing config files. This makes it potentially very interesting to web developers like myself who have worked in multiple languages - I could use it to serve a Python or PHP web app, simply by making different requests during the setup process. I can see this being a boon for SaaS providers - you could pick up the language from a file, much like the <code>runtime.txt</code> used by Heroku, and set up the application on the fly.</p><p>It’s currently in public beta, and there are packages for Ubuntu, so I decided to try it out. I’ve created the Ansible role below to set up Unit on an Ubuntu 16.04 server or VM:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>-<span class="ruby">--</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Install keys</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  apt_key: url=http://nginx.org/keys/nginx_signing.key state=present</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Setup main repo</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  apt_repository: repo='deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx' state=present</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Setup source rep</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  apt_repository: repo='deb-src http://nginx.org/packages/mainline/ubuntu/ xenial nginx' state=present</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Update system</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  apt: upgrade=full update_cache=yes</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Install dependencies</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  apt: name={{ item }} state=present</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  with_items:</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    -<span class="ruby"> nginx</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    -<span class="ruby"> unit</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    -<span class="ruby"> golang</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    -<span class="ruby"> php-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    -<span class="ruby"> libphp-embed</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    -<span class="ruby"> libphp7.<span class="hljs-number">0</span>-embed</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    -<span class="ruby"> python-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    -<span class="ruby"> python3</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    -<span class="ruby"> python3-dev</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-cli</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-mcrypt</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-pgsql</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-sqlite3</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-opcache</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-curl</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-mbstring</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-dom</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-xml</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-zip</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    -<span class="ruby"> php7.<span class="hljs-number">0</span>-bcmath</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>-<span class="ruby"> <span class="hljs-symbol">name:</span> Copy over Nginx configuration</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>  copy: src=nginx.conf dest=/etc/nginx/sites-available/default owner=root group=root mode=0644</td></tr></table></code></pre><p>Note the section that copies over the Nginx config file. Here is that file:</p><pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute">upstream</span> unit_backend {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8300</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-section">server</span> {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server ipv6only=<span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>; </td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-attribute">root</span> /var/www/public;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">index</span> index.php index.html index.htm;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attribute">server_name</span> server_domain_or_IP;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">location</span> / { </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.php?<span class="hljs-variable">$query_string</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }   </td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /index.php =<span class="hljs-number">404</span>;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-attribute">proxy_pass</span> http://unit_backend;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }   </td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>This setup proxies all dynamic requests to the Unit backend in a similar fashion to how it would normally pass it to PHP-FPM.</p><p>There were still a few little issues. It doesn’t exactly help that the Nginx package provided with this repository isn’t quite the same as the one in Ubuntu by default - not only is it the unstable version, but it doesn’t set up the <code>sites-available</code> and <code>sites-enabled</code> folders, so I had to do that manually. I also had an issue with Systemd starting the process (at <code>/run/control.unit.sock</code>) with permissions that didn’t allow Nginx to access it. I’m not that familiar with Systemd so I wound up just setting the permissions of the file manually, but that doesn’t persist between restarts. I expect this issue isn’t that big a deal to someone more familiar with Systemd, but I haven’t been able to resolve it yet.</p><p>I decided to try it out with a Laravel application. I created a new Laravel app and set it up with the web root at <code>/var/www</code>. I then saved the following configuration for it as <code>app.json</code>:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"listeners"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-attr">"*:8300"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-attr">"application"</span>: <span class="hljs-string">"myapp"</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attr">"applications"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"myapp"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-attr">"type"</span>: <span class="hljs-string">"php"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-attr">"workers"</span>: <span class="hljs-number">20</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-attr">"user"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-attr">"group"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-attr">"root"</span>: <span class="hljs-string">"/var/www/public"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-attr">"index"</span>: <span class="hljs-string">"index.php"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>This is fairly basic, but a good example of how you configure an application with Unit. The <code>listener</code> section maps a port to an application, while the <code>applications</code> section defines an application called <code>myapp</code>. In this case, we specify that the type should be <code>php</code>. Note that each platform has slightly different options - for instance, the Python type doesn’t have the <code>index</code> or <code>root</code> options, instead having the <code>path</code> option, which specifies the path to the <code>wsgi.py</code> file.</p><p>I then ran the following command to upload the file:</p><pre><code class="hljs lang-bash singleline">$ curl -X PUT -d @app.json --unix-socket /run/control.unit.sock http://localhost</code></pre><p>Note that we send it direct to the Unix socket file - this way we don’t have to expose the API to the outside. After this was done, the Laravel app began working as expected.</p><p>We can then make a GET request to view the configured applications:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ curl --unix-socket /run/control.unit.sock http://localhost/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">"listeners"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>                <span class="hljs-string">"*:8300"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>                        <span class="hljs-string">"application"</span>: <span class="hljs-string">"saas"</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                }</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        },</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-string">"applications"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-string">"saas"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"php"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                        <span class="hljs-string">"workers"</span>: 20,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                        <span class="hljs-string">"user"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                        <span class="hljs-string">"group"</span>: <span class="hljs-string">"www-data"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                        <span class="hljs-string">"root"</span>: <span class="hljs-string">"/var/www/public"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                        <span class="hljs-string">"index"</span>: <span class="hljs-string">"index.php"</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>It’s also possible to update and delete existing applications via the API using PUT and DELETE requests.</p><h2 id="final-thoughts">Final thoughts</h2><p>This is <em>way</em> too early to be seriously considering using Unit in production. It’s only just been released as a public beta, and it’s a bit fiddly to set up. However, it has an enormous amount of promise.</p><p>One thing I can’t really see right now is whether it’s possible to use a virtualenv with it for Python applications. In the Python community it’s standard practice to use Virtualenv to isolate the dependencies for individual applications, and it’s not clear how I’d be able to go about using this, if it is possible. For deploying Python applications, lack of virtualenv support would be a deal breaker, and I hope this gets clarified soon.</p><p>I’d also be curious to see benchmarks of how it compares to something like PHP-FPM. It’s quite possible that it may be less performant than other solutions. However, I will keep a close eye on this in future.</p></article><article class="post"><p class="date">2nd September 2017 2:45 pm</p><h1><a href="/blog/2017/09/02/making-internal-requests-with-laravel/">Making Internal Requests With Laravel</a></h1><p>Recently I’ve been working on a Phonegap app that needs to work offline. The nature of relational databases can often make this tricky if you’re dealing with related objects and you’re trying to retrofit it to something that wasn’t built with this use case in mind.</p><p>Originally my plan was to push each request that would have been made to a queue in WebSQL, and then on reconnect, make every request individually. It quickly became apparent, however, that this approach had a few problems:</p><ul><li>If one request failed, the remaining requests had to be stopped from executing</li><li>It didn’t allow for storing the failed transactions in a way that made them easy to retrieve</li></ul><p>Instead, I decided to create a single <code>sync</code> endpoint for the API that would accept an object containing all the requests that would be made, and then step through each one. If it failed, it would get the failed request and all subsequent ones in the object, and store them in the database. That way, even if the data didn’t sync correctly, it wasn’t lost, and if necessary it could be resolved manually.</p><p>Since the necessary API endpoints already existed, and were thoroughly tested, it was not a good idea to start duplicating that functionality. Instead, I implemented the functionality to carry out internal requests, and I thought I’d share how you can do this.</p><p>For any service you may build for your Laravel applications, it’s a good idea to create an interface for it first:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MakesInternalRequests</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Make an internal request</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@param</span> string $action   The HTTP verb to use.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@param</span> string $resource The API resource to look up.</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> array  $data     The request body.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span><span class="hljs-params">(string $action, string $resource, array $data = [])</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>That way you can resolve the service using dependency injection, making it trivial to replace it with a mock when testing.</p><p>Now, actually making an internal request is pretty easy. You get the app instance (you can do so by resolving it using dependency injection as I do below, or call the <code>app()</code> helper). Then you put together the request you want to make and pass it as an argument to the app’s <code>handle()</code> method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MakesInternalRequests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Application</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">FailedInternalRequestException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> * Internal request service</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InternalRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MakesInternalRequests</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * The app instance</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * <span class="hljs-doctag">@var</span> $app</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">protected</span> $app;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * Constructor</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@param</span> Application $app        The app instance.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Application $app)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app = $app;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     * Make an internal request</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     * <span class="hljs-doctag">@param</span> string $action   The HTTP verb to use.</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>     * <span class="hljs-doctag">@param</span> string $resource The API resource to look up.</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@param</span> array  $data     The request body.</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     * <span class="hljs-doctag">@throws</span> FailedInternalRequestException Request could not be synced.</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Response</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span><span class="hljs-params">(string $action, string $resource, array $data = [])</span></span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        $request = Request::create(<span class="hljs-string">'/api/'</span> . $resource, $action, $data, [], [], [</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>            <span class="hljs-string">'HTTP_Accept'</span>             =&gt; <span class="hljs-string">'application/json'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-comment">// Get response</span></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;app-&gt;handle($request);</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() &gt;= <span class="hljs-number">400</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FailedInternalRequestException($request, $response);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-comment">// Dispatch the request</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>}</td></tr></table></code></pre><p>Also note that I’ve created a custom exception, called <code>FailedInternalRequestException</code>. This is fired if the status code returned from the internal requests is greater than or equal to 400 (thus denoting an error):</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Response</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td> * Exception for when a bulk sync job fails</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FailedInternalRequestException</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * Request instance</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@var</span> $request</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> $request;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * Response instance</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     * <span class="hljs-doctag">@var</span> $response</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">protected</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     * Constructor</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>     * <span class="hljs-doctag">@param</span> Request  $request  The request object.</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * <span class="hljs-doctag">@param</span> Response $response The response object.</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Request $request, Response $response)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">parent</span>::__construct();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">$this</span>-&gt;request = $request;</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;response = $response;</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * Get request object</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> Request</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequest</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;request;</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>     * Get response object</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * <span class="hljs-doctag">@return</span> Response</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getResponse</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;response;</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>}</td></tr></table></code></pre><p>You can catch this exception in an appropriate place and handle it as you wish. Now, if you import the internal request class as <code>$dispatcher</code>, you can just call <code>$dispatcher-&gt;request($action, $resource, $data)</code>, where <code>$action</code> is the HTTP verb, <code>$resource</code> is the API resource to send to, and <code>$data</code> is the data to send.</p><p>It’s actually quite rare to have to do this. In this case, because this was a REST API and every request made to it was changing the state of the application (there were no GET requests, only POST, PUT, PATCH and DELETE), it made sense to just break down the request body and do internal requests against the existing API, since otherwise I’d have to duplicate the existing functionality. I would not recommend this approach for something like fetching data to render a page on the server side, as there are more efficient ways of accomplishing it. In all honesty I can’t think of any other scenario where this would genuinely be the best option. However, it worked well for my use case and allowed me to implement this functionality quickly and simply.</p></article><article class="post"><p class="date">19th August 2017 3:40 pm</p><h1><a href="/blog/2017/08/19/run-your-tests-locally-with-sismo/">Run Your Tests Locally With Sismo</a></h1><p>Continuous integration is a veritable boon when working on any large software project. However, the popularity of distributed version control systems like Git over the older, more centralised ones like Subversion means that when you commit your changes, they don’t necessarily get pushed up to a remote repository immediately. While this is a good thing because it means you can commit at any stage without worrying about pushing up changes that break everyone else’s build, it has the downside that the tests aren’t automatically run on every commit, just every push, so if you get sloppy about running your tests before every commit you can more easily get caught out. In addition, a full CI server like Jenkins is a rather large piece of software that you don’t really want to run locally if you can help it, and has a lot of functionality you don’t need.</p><p><a href="https://sismo.symfony.com/">Sismo</a> is a small, simple continuous integration server, implemented in PHP, that’s ideal for running locally. You can set it up to run your tests on every commit, and it has an easy-to-use web interface. Although it’s a PHP application, there’s no reason why you couldn’t use it to run tests for projects in other languages, and because it’s focused solely on running your test suite without many of the other features of more advanced CI solutions, it’s a good fit for local use. Here I’ll show you how I use it.</p><h2 id="setting-up-sismo">Setting up Sismo</h2><p>Nowadays I don’t generally install a web server on a computer directly, preferring to use Vagrant or the dev server as appropriate, so Sismo generally doesn’t have to coexist with anything else. I normally install PHP7’s FastCGI implementation and Nginx, along with the SQLite bindings (which Sismo needs):</p><pre><code class="hljs lang-bash singleline">$ sudo apt-get install nginx php7.0-fpm php7.0-sqlite3</code></pre><p>Then we can set up our Nginx config at <code>/etc/nginx/sites-available/default</code>:</p><pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-section">server</span> {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server ipv6only=<span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attribute">root</span> /var/www/html;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">index</span> sismo.php index.html index.htm;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-attribute">server_name</span> server_domain_or_IP;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">location</span> / {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /sismo.php?<span class="hljs-variable">$query_string</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /sismo.php =<span class="hljs-number">404</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-attribute">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span>;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-attribute">fastcgi_pass</span> unix:/var/run/php/php7.0-fpm.sock;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-attribute">fastcgi_index</span> sismo.php;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SISMO_DATA_PATH <span class="hljs-string">"/home/matthew/.sismo/data"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SISMO_CONFIG_PATH <span class="hljs-string">"/home/matthew/.sismo/config.php"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-attribute">include</span> fastcgi_params;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>You’ll probably want to adjust the paths as appropriate. Then set up the required folders:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ mkdir ~/.sismo</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ mkdir ~/.sismo/data</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$ touch ~/.sismo/config.php</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>$ chmod -R a+w ~/.sismo/</td></tr></table></code></pre><p>Then, <a href="https://sismo.symfony.com/get/sismo.php">download Sismo</a> and put it in your web root (here it’s at <code>/var/www/html/sismo.php</code>).</p><p>Now, say you have a project you want to test (I’m using my <a href="https://github.com/matthewbdaly/laravel-etag-middleware">Laravel ETag middleware</a> for this example). We need to specify the projects we want to test in <code>~/.sismo/config.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$projects = <span class="hljs-keyword">array</span>();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>$notifier = <span class="hljs-keyword">new</span> Sismo\Notifier\DBusNotifier();</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Sismo\Project::setDefaultCommand(<span class="hljs-string">'if [ -f composer.json ]; then composer install; fi &amp;&amp; vendor/bin/phpunit'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>$projects[] = <span class="hljs-keyword">new</span> Sismo\GithubProject(<span class="hljs-string">'Laravel ETag Middleware'</span>, <span class="hljs-string">'/home/matthew/Projects/laravel-etag-middleware'</span>, $notifier);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">return</span> $projects;</td></tr></table></code></pre><p>Hopefully this shouldn’t be too difficult to understand. We create an array of projects, then specify a notifier (this is Linux-specific - refer to the documentation for using Growl on Mac OS). Next, we specify that by default the tests should run <code>composer install</code> followed by <code>vendor/bin/phpunit</code>. We then specify this project is a Github project - it also supports Bitbucket, or plain SSH, or the default Project, but in general it shouldn’t be a problem to use it with any repository as you can just run it against the local copy. Finally we return the list of projects.</p><p>Now, we should be able to run our tests as follows:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php /var/www/html/sismo.php build</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Building Project <span class="hljs-string">"Laravel ETag Middleware"</span> (into <span class="hljs-string">"68a087"</span>)</td></tr></table></code></pre><p>That should be working, but it doesn’t get us anything we don’t get by running the tests ourselves. To trigger the build, we need to set up a post-commit hook for our project in <code>.git/hooks/post-commit</code>:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">#!/bin/sh</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>php /var/www/html/sismo.php --quiet --force build laravel-etag-middleware `git <span class="hljs-built_in">log</span> -1 HEAD --pretty=<span class="hljs-string">"%H"</span>` &amp;&gt;/dev/null &amp;</td></tr></table></code></pre><p>You should now be able to view your project in the Sismo web interface at <a href="http://localhost">http://localhost</a>:</p><p><img src="/static/images/sismo-screenshot.png" alt="Sismo"></p><p>Clicking on the project should take you through to its build history:</p><p><img src="/static/images/sismo-screenshot2.png" alt="Sismo project page"></p><p>From here on, it should be straightforward to add new projects as and when necessary. Because you can change the command on a per-project basis, you can quite happily use it to run tests for Python or Node.js projects as well as PHP ones, and it’s not hard to configure it.</p><p>I personally find it very useful to have something in place to run my tests on every commit like this, and while you could just use a post-commit hook for that, this approach is less obtrusive because it doesn’t force you to wait around for your test suite to finish.</p></article><article class="post"><p class="date">14th August 2017 12:40 pm</p><h1><a href="/blog/2017/08/14/profiling-your-laravel-application-with-clockwork/">Profiling Your Laravel Application With Clockwork</a></h1><p>If you’re building any non-trivial application, it’s always a good idea to profile it to find performance problems. <a href="https://github.com/barryvdh/laravel-debugbar">Laravel Debugbar</a> is the usual solution for profiling Laravel web applications, but it isn’t really much use for REST API’s or single-page web apps that consume them.</p><p>Recently I was introduced to <a href="https://github.com/itsgoingd/clockwork">Clockwork</a>, which is a server-side extension for profiling PHP applications. It’s made it a whole lot easier to track down issues like excessive numbers of queries when building an API, and as a result I’ve been able to dramatically improve the performance of an API I’ve been working on. Here I’ll show you how you can use it on a project.</p><h2 id="installing-clockwork">Installing Clockwork</h2><p>Clockwork is available via Composer:</p><pre><code class="hljs lang-bash singleline">$ composer require itsgoingd/clockwork</code></pre><p>You also need to register the service provider in <code>config/app.php</code>:</p><pre><code class="hljs lang-php singleline">   Clockwork\Support\Laravel\ClockworkServiceProvider::class,</code></pre><p>And register the middleware globally in <code>app/Http/Kernel.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">protected</span> $middleware = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>      \Clockwork\Support\Laravel\ClockworkMiddleware::class,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>]</td></tr></table></code></pre><p>Note that it only works when <code>APP_DEBUG</code> is set to true in your <code>.env</code> file. This means that you can keep it in your application without worrying about exposing too much data in production, as long as debug mode is not active on your production server (which it shouldn’t be anyway).</p><p>You will also need to install the <a href="https://chrome.google.com/webstore/detail/clockwork/dmggabnehkmmfmdffgajcflpdjlnoemp?hl=en">Chrome extension</a> in order to actually work with the returned data. Clockwork works by adding its own route to your Laravel application, and this extension makes sure that it makes the appropriate request on loading a page, and then displays the data in the dev tools.</p><p>Once it’s all installed and your application is running, open the dev tools and you should see the new <strong>Clockwork</strong> tab in there. On the left of this tab is a list of requests - if you make a request, you’ll see it added to the list. When you click on each request, you’ll see the following tabs, where applicable:</p><h2 id="request">Request</h2><p><img src="/static/images/clockwork1.png" alt="Request tab"></p><p>This is similar to Chrome’s network tab in that it shows all of the headers for a given request. It’s not anything you can’t get using Chrome’s existing dev tools, but because it doesn’t show any static content it’s arguably a bit easier to navigate.</p><h2 id="timeline">Timeline</h2><p><img src="/static/images/clockwork2.png" alt="Timeline tab"></p><p>This shows how long the response takes to respond, which can be helpful in identifying slower requests.</p><p>In addition, you can create your own events using the <code>clock()</code> helper, which will appear in the timeline, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>clock()-&gt;startEvent(<span class="hljs-string">'email_sent'</span>, <span class="hljs-string">'Email sent.'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>clock()-&gt;endEvent(<span class="hljs-string">'email_sent'</span>);</td></tr></table></code></pre><h2 id="log">Log</h2><p><img src="/static/images/clockwork8.png" alt="Log tab"></p><p>The log tab is only displayed if you use the <code>clock()</code> helper to log data. You can log text or JSON objects as appropriate:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>clock(<span class="hljs-string">'Message text.'</span>); <span class="hljs-comment">// 'Message text.' appears in Clockwork log tab</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>clock([<span class="hljs-string">'hello'</span> =&gt; <span class="hljs-string">'world'</span>]); <span class="hljs-comment">// logs json representation of the array</span></td></tr></table></code></pre><p>This is arguably more convenient than using the <code>Log</code> facade to write to the application log, since it’s kept in the browser and you can easily see what request caused what message to be logged.</p><h2 id="database">Database</h2><p><img src="/static/images/clockwork3.png" alt="Database tab"></p><p>The database tab displays details of the queries made by a request. This is useful for identifying things such as:</p><ul><li>Repeated queries that should be cached</li><li>The n+1 problem (which can be resolved by use of eager loading)</li><li>Slow queries that need to be optimised</li></ul><p>Note that if a particular endpoint does not trigger a query, this tab will not be visible.</p><h2 id="cookies">Cookies</h2><p><img src="/static/images/clockwork4.png" alt="Cookies tab"></p><p>For a REST API, you shouldn’t really have much use for cookies, but if you do, this tab lets you view the cookies set on the request.</p><h2 id="session">Session</h2><p><img src="/static/images/clockwork5.png" alt="Session tab"></p><p>As with cookies, the session isn’t normally something you’d use for an API, but this tab lets you view it.</p><h2 id="views">Views</h2><p><img src="/static/images/clockwork6.png" alt="Views tab"></p><p>This tab shows the views used on the page, and all of the data passed to them.</p><h2 id="routes">Routes</h2><p><img src="/static/images/clockwork7.png" alt="Routes tab"></p><p>This tab shows all of the routes defined within your application.</p><p>Clockwork isn’t limited to Laravel - you can also use it with Lumen, Slim 2, and CodeIgniter 2.1, and it’s possible to write your own integration for other frameworks. It’s still fundamentally browser-based, so it’s difficult to use it if your API doesn’t have at least some kind of web front end (whether that’s a single page web app or Phonegap app that consumes the API, or that the API is itself browseable and returns HTML in a web browser), but I’ve found it to be superior to Laravel Debugbar for most of what I do.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></p><p><a href="/blog/2018/10/11/do-you-still-need-jquery/">Do You Still Need Jquery?</a></p><p><a href="/blog/2018/10/08/an-approach-to-writing-golden-master-tests-for-php-web-applications/">An Approach to Writing Golden Master Tests for PHP Web Applications</a></p><p><a href="/blog/2018/10/05/understanding-the-pipeline-pattern/">Understanding the Pipeline Pattern</a></p><p><a href="/blog/2018/10/03/replacing-switch-statements-with-polymorphism-in-php/">Replacing Switch Statements With Polymorphism in PHP</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/9/">Newer</a></li><li class="page-item"><a href="/posts/11/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>