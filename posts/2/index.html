<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="specificfeeds-verification-code" content="aVAjQDUDF13xlBB0Ff5l"><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/2/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="https://www.specificfeeds.com/matthewdaly?subParam=followPub">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">22nd April 2018 11:50 pm</p><h1><a href="/blog/2018/04/22/rendering-different-views-for-mobile-and-desktop-clients-in-laravel/">Rendering Different Views for Mobile and Desktop Clients in Laravel</a></h1><p>This was a bit of a weird post to write. It started out explaining how I resolved an issue years ago on a CodeIgniter site, but amended to work for Laravel. In the process, I realised it made sense to implement it as middleware, and I ended up pulling it out into <a href="https://github.com/matthewbdaly/laravel-dynamic-serving">a package</a>. However, it’s still useful to understand the concept behind it, even if you prefer to just install the complete package, because your needs might be slightly different to mine.</p><p>On web development forums, it’s quite common to see variants of the following question:</p><blockquote><p>How do I redirect a user on a mobile device to a mobile version of the site?</p></blockquote><p>It’s quite surprising that this is still an issue that crops up. For many years, it’s been widely accepted that the correct solution for this problem is responsive design. However, there are ways in which this may not be adequate for certain applications. For instance, you may have an application where certain functionality only makes sense in a certain context, or your user interface may need to be optimised for specific environments.</p><p>The trouble is that a dedicated mobile site isn’t a good idea either. Among other things, it means that users can’t easily use the same bookmarks between desktop and mobile versions, and can result in at least some of the server-side logic being duplicated.</p><p>Fortunately, there is another way - <a href="https://developers.google.com/search/mobile-sites/mobile-seo/dynamic-serving">dynamic serving</a> allows you to render different content based on the user agent. You can also easily enable users to switch between desktop and mobile versions themselves if their client isn’t detected correctly or they just prefer the other one. I’ve implemented this years ago for a CodeIgniter site. Here’s how you might implement it in Laravel, although if you understand the principle behind it, it should be easy to adapt for any other framework.</p><p>Don’t try to implement mobile user agent detection yourself. Instead, find an implementation that’s actively maintained and install it with Composer. That way you can be reasonably sure that as new mobile devices come onto the market the package will detect them correctly as long as you keep it up to date. I would be inclined to go for <a href="https://github.com/jenssegers/agent">Agent</a>, since it has Laravel support baked in.</p><p>We could just use Agent to serve up different content based on the user agent. However, user agent strings are notoriously unreliable - if a new mobile device appears and it doesn’t show up correctly in Agent, users could find themselves forced to use the wrong UI. Instead, we need to check for a flag in the session that indicates if the session is mobile or not. If it’s not set, we set it based on the user agent. That way, if you need to offer functionality to override the detected session type, you can just update that session variable to correct that elsewhere in the application. I would be inclined to use a button in the footer that makes an AJAX request to toggle the flag, then reloads the page.</p><p>You also need to set the HTTP response header <code>Vary: User-Agent</code> to notify clients (including not only search engines, but also proxies at either end of the connection, such as Varnish or Squid) that the response will differ by user agent, in order to prevent users being served the wrong version.</p><p>Middleware is the obvious place to do this. Here’s a middleware that sets the session variable and the appropriate response headers:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Jenssegers</span>\<span class="hljs-title">Agent</span>\<span class="hljs-title">Agent</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Session</span>\<span class="hljs-title">Session</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DetectMobile</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> $agent;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $session;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Agent $agent, Session $session)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;agent = $agent;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = $session;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * Handle an incoming request.</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;session-&gt;exists(<span class="hljs-string">'mobile'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;agent-&gt;isMobile() || <span class="hljs-keyword">$this</span>-&gt;agent-&gt;isTablet()) {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-keyword">$this</span>-&gt;session-&gt;put(<span class="hljs-string">'mobile'</span>, <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            } <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-keyword">$this</span>-&gt;session-&gt;put(<span class="hljs-string">'mobile'</span>, <span class="hljs-keyword">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $response = $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> $response-&gt;setVary(<span class="hljs-string">'User-Agent'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>}</td></tr></table></code></pre><p>Now, you could then work with the session directly to retrieve the <code>mobile</code> flag, but as you may be working in the view, it makes sense to create helpers for this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">if</span> (!function_exists(<span class="hljs-string">'is_mobile'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_mobile</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $session = app()-&gt;make(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> $session-&gt;get(<span class="hljs-string">'mobile'</span>) == <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">if</span> (!function_exists(<span class="hljs-string">'is_desktop'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_desktop</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $session = app()-&gt;make(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> $session-&gt;get(<span class="hljs-string">'mobile'</span>) == <span class="hljs-keyword">false</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>Now, if you want to serve up completely different views, you can use these helpers in your controllers. If you instead want to selectively show and hide parts of the UI based on the user agent, you can instead use these in the views to determine what parts of the page should be shown.</p><p>Agent offers more functionality than just detecting if a user agent is a mobile or desktop device, and you may find this useful as a starting point for developing middleware for detecting bots, or showing different content to users based on their device type or operating system. If you just need to detect if a user is a mobile or desktop client, this middleware should be sufficient.</p></article><article class="post"><p class="date">12th April 2018 11:57 pm</p><h1><a href="/blog/2018/04/12/making-wordpress-less-shit/">Making Wordpress Less Shit</a></h1><p>I’m not going to sugarcoat it. As a developer, I think Wordpress is shit, and I’m not alone in that opinion. Its code base dates from a time before many of the developments of the last few years that have hugely improved PHP as a language, as well as the surrounding ecosystem such as Composer and PSR-FIG, and it’s likely it couldn’t adopt many of those without making backward-incompatible changes that would affect its own ecosystem of plugins and themes. It actively forces you to write code that is far less elegant and efficient than what you might write with a proper framework such as Laravel, and the quality of many of the plugins and themes around is dire.</p><p>Unfortunately, it’s also difficult to avoid. Over a quarter of all websites run Wordpress, and most developers will have to work with it at some point in their careers. However, there are ways that you can improve your experience when working with Wordpress somewhat. In this post I’m going to share some methods you can use to make Wordpress less painful to use.</p><p>This isn’t a post about the obvious things like “Use the most recent version of PHP you can”, “Use SSL”, “Install this plugin”, “Use Vagrant/Lando” etc - I’m assuming you already know stuff like that for bog standard Wordpress development. Nor is it about actually developing Wordpress plugins or themes. Instead, this post is about bringing your Wordpress development workflow more into line with how you develop with MVC frameworks like Laravel, so that you have a better experience working with and maintaining Wordpress sites. We can’t solve the fundamental issues with Wordpress, but we can take some steps to make it easier to work with.</p><h2 id="use-bedrock">Use Bedrock</h2><p><a href="https://roots.io/bedrock/">Bedrock</a> is still Wordpress, but reorganized so that:</p><ul><li>The Wordpress core, plugins and themes can be managed with Composer for easier updates</li><li>The configuration can be done with a <code>.env</code> file that can be kept out of version control, rather than putting it in <code>wp-config.php</code></li><li>The web root is isolated to limit access to the files</li></ul><p>In short, it optimizes Wordpress for how modern developers work. Arguably that’s at the expense of site owners, since it makes it harder for non-developers to manage the site, however for any Wordpress site that’s sufficiently complex to need development work done that’s a trade-off worth making. I’ve been involved in projects where Wordpress got used alongside an MVC framework for some custom functionality, and in my experience it caused a world of problems when updating plugins and themes because version control would get out of sync, so moving that to use Composer to manage them instead would have been a huge win.</p><p>Using Bedrock means that if you have a parent theme you use all the time, or custom plugins of your own, you can install them using Composer by adding the Git repositories to your <code>composer.json</code>, making it easier to re-use functionality you’ve already developed. It also makes recovery easier in the event of the site being compromised, because the files outside the vendor directory will be in version control, and you can delete the vendor directory and re-run <code>composer install</code> to replace the rest. By comparison, with a regular Wordpress install, if it’s compromised you can’t always be certain you’ve got all of the files that have been changed. Also, keeping Wordpress up to date becomes a simple matter of running <code>composer update</code> regularly, verifying it hasn’t broken anything, and then deploying it to production.</p><p>Bedrock uses <a href="https://wpackagist.org/">WPackagist</a>, which regularly scans the Wordpress Subversion repository for plugins and themes, so at least for plugins and themes published on the Wordpress site, it’s easy to install them. Paid plugins may be more difficult - I’d be inclined to put those in a private Git repository and install them from there, although I’d be interested to know if anyone else uses another method for that.</p><h2 id="if-you-can-t-use-bedrock-use-wp-cli">If you can’t use Bedrock, use WP CLI</h2><p>If for any reason you can’t use Bedrock for a site, then have a look at <a href="https://wp-cli.org/">WP CLI</a>. On the server, you can use it to install and manage both plugins and themes, as well as the Wordpress core.</p><p>It’s arguably even more useful locally, as it can be used to generate scaffolding for plugins, themes (including child themes based on an existing theme), and components such as custom post types or taxonomies. In short, if you do any non-trivial amount of development with Wordpress you’ll probably find a use for it. Even if you can use Bedrock, you’re likely to find WP CLI handy for the scaffolding.</p><h2 id="upgrade-the-password-encryption">Upgrade the password encryption</h2><p>I said this wouldn’t be about using a particular plugin, but this one is too important. Wordpress’s password hashing still relies on MD5, which is <em>far</em> too weak to be considered safe. Unfortunately, Wordpress still supports PHP versions as old as 5.2, and until they drop it they can’t really switch to something more secure.</p><p><a href="https://roots.io/plugins/bcrypt-password/">wp-password-bcrypt</a> overrides the password functionality of Wordpress to use Bcrypt, which is what modern PHP applications use. As a result, the hashes are considerably stronger. Given that Wordpress is a common target for hackers, it’s prudent to ensure your website is as secure as you can possibly make it.</p><p>If you use Bedrock, it uses this plugin by default, so it’s already taken care of for you.</p><h2 id="use-a-proper-templating-system">Use a proper templating system</h2><p>PHP is a weird hybrid of a programming language and a templating system. As such, it’s all too easy to wind up with too much logic in your view layer, so it’s a good idea to use a proper templating system if you can. Unfortunately, Wordpress doesn’t support that out of the box.</p><p>However, there are some third-party solutions for this. <a href="https://roots.io/sage/">Sage</a> uses Laravel’s Blade templating system (and also comes with Webpack preconfigured), while <a href="https://www.upstatement.com/timber/">Timber</a> lets you use Twig.</p><h2 id="use-the-wordpress-rest-api-for-ajax-where-you-can">Use the Wordpress REST API for AJAX where you can</h2><p>Version 4.7 of Wordpress introduced the <a href="https://v2.wp-api.org/">Wordpress REST API</a>, allowing the data to be exposed via RESTful endpoints. As a result, it should now be possible to build more complex and powerful user interfaces for that data. For instance, if you were using Wordpress to build a site for listing items for sale, you could create a single-page web app for the front end using React.js and Redux, and use the API to submit it, then show the submitted items.</p><p>I’m not a fan of the idea the Wordpress developers seem to have of trying to make it some kind of all-singing, all-dancing universal platform for the web, and the REST API seems to be part of that idea, but it does make it a lot easier than it was in the past to do something a bit out of the ordinary with Wordpress. In some cases it might be worth using Wordpress as the backend for a <a href="https://en.wikipedia.org/wiki/Headless_CMS">headless CMS</a>, and the REST API makes that a practical approach. For simpler applications that just need to make a few AJAX calls, using the REST API is generally going to be more elegant and practical than any other approach to AJAX with Wordpress. It’s never going to perform as well or be as elegant as a custom-built REST API, but it’s definitely a step forward compared to the hoops you used to have to jump through to handle AJAX requests in Wordpress.</p><h2 id="summary">Summary</h2><p>Wordpress is, and will remain for the foreseeable future, a pain in the backside to develop for compared to something like Laravel, and I remain completely mystified by the number of people who seem to think it’s the greatest thing since sliced bread. However, it is possible to make things better if you know how - it’s just that some of this stuff seems to be relatively obscure. In particular, discovering Bedrock is potentially game-changing because it makes it so much easier to keep the site under version control.</p></article><article class="post"><p class="date">10th March 2018 3:10 pm</p><h1><a href="/blog/2018/03/10/using-stored-procedures-in-your-web-app/">Using Stored Procedures in Your Web App</a></h1><p>In the last few days I’ve done something I’ve never done before, namely written a stored procedure for a web app. Like most web developers, I know enough about SQL to be able to formulate some fairly complex queries, but I hadn’t really touched on control flow functions or stored procedures, and in my experience they tend to be the province of the dedicated database administrator, not us web devs, who will typically delegate more complex functionality to our application code.</p><p>In this case, there were a number of factors influencing my decision to use a stored procedure for this:</p><ul><li>The application was a legacy application which had been worked on by developers of, shall we say, varying skill levels. As a result the database schema was badly designed, with no prospect of changing it without causing huge numbers of breakages</li><li>The query in question was used to generate a complex report that was quite time-consuming, therefore the optimisations from using a stored procedure were worthwhile.</li><li>The report required that data be grouped by a set of categories which were stored in a separate table, which meant the table had to be pivoted (transformed from rows to columns), resulting in an incredibly complex dynamic query that had to be constructed on the fly by concatenating different SQL strings. In PostgreSQL, this can be done fairly easily using the <code>crosstab</code> function, but MySQL doesn’t have native support for anything like this.</li></ul><p>Historically, one issue with using stored procedures has been that it kept business logic out of the application code, meaning they are not stored in version control. However, most modern frameworks provide some support for migrations, and since they are intended to be used to make changes to the database, they are the obvious place to define the stored procedure. This particular application was built with an older framework that didn’t come with migrations, so we’d installed <a href="https://phinx.org/">Phinx</a> to handle those for us. Initially, I defined the stored procedure inside a migration that ran a raw query to create the stored procedure, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   $query = <span class="hljs-string">&lt;&lt;&lt;EOF</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>CREATE PROCEDURE IF NOT EXISTS foo</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>BEGIN</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>   SELECT * FROM foo;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>END</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>EOF;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">$this</span>-&gt;execute($query);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>   <span class="hljs-keyword">$this</span>-&gt;execute(<span class="hljs-string">'DROP PROCEDURE IF EXISTS foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>Once this is done, you can then use your framework’s particular support for raw queries to call <code>CALL foo()</code> whenever your stored procedure needs to be executed.</p><p>However, we soon ran into an issue. It turns out <code>mysqldump</code> doesn’t export stored procedures by default, so there was a risk that anyone working on the code base might import the database from an SQL file and not get the migrations. I’d used the Symfony Console component to create a simple command-line tool, reminiscent of Laravel’s Artisan, so I used that to create a command to set up the stored procedure, amended the migration to call that command, and placed a check in the application where the procedure was called so that if it was not defined the command would be called and the procedure would be created. In most cases this wouldn’t be an issue.</p><p>Having now had experience using stored procedures in a web application, there are a number of issues they raise:</p><ul><li>It’s hard to make queries flexible, whereas with something like Eloquent it’s straightforward to conditionally apply <code>WHERE</code> statements.</li><li>While storing them in migrations is a practical solution, if the database is likely to be imported rather than created from scratch during development it can be problematic.</li><li>They aren’t easily portable, not just between database management systems, but between different versions - the production server was using an older version of MySQL, and it failed to create the procedure. It’s therefore good practice for your migrations to check the procedure was created successfully and raise a noisy exception if they failed.</li></ul><p>Conversely, they do bring certain benefits:</p><ul><li>For particularly complex transactions that don’t change, such as generating reports, they are a good fit since they reduce the amount of data that needs to be sent to the database and allow the query to be pre-optimised somewhat.</li><li>If a particular query is unusually expensive, is called often, and can’t be cached, it may improve performance to make it a stored procedure.</li><li>Doing a query in a for loop is usually a very big no-no. However, if there really is no way to avoid it (and this should almost never happen), it would make sense to try to do it in a stored procedure using SQL rather than in application code since that would minimise the overhead.</li><li>If multiple applications need to work with the same database, using stored procedures for queries in more than one application removes the need to reimplement or copy over the code for the query in the second application - they can just call the same procedure, and if it needs to be changed it need only be done once.</li></ul><p>Honestly, I’m not sure I’m ever likely to again come across a scenario where using a stored procedure in a web application would be beneficial, but it’s been very interesting delving into aspects of SQL that I don’t normally touch on and I’ve picked up on some rarely-used SQL statements that I haven’t used before, such as <code>GROUP_CONCAT()</code> and <code>CASE</code>. With the widespread adoption of migrations in most frameworks, I think that the argument that using stored procedures keeps application logic out of version control no longer holds any water, since developers can generally be trusted to store changes to database structure in their migrations and not start messing them around, so the same applies for stored procedures. Report generation seems to be the ideal use case since this invariably involves complex queries that run regularly and don’t change often, and this is where I expect it would be most likely I’d have cause to use them again.</p></article><article class="post"><p class="date">25th February 2018 5:22 pm</p><h1><a href="/blog/2018/02/25/check-your-code-base-is-php-7-ready-with-php-compatibility/">Check Your Code Base Is PHP 7 Ready With PHP Compatibility</a></h1><p>I’ve recently started a new job and as part of that I’m working on a rather substantial legacy code base. In fact, it was so legacy that it was still in Subversion - needless to say the very first thing I did was migrate it to Git. One of the jobs on our radar for this code base is to migrate it to from PHP 5.4 to 5.6, and subsequently to PHP 7. I’ve been using it locally in 5.6 without issue so far, but I’ve also been looking around for an automated tool to help catch potential problems.</p><p>I recently discovered <a href="https://github.com/wimg/PHPCompatibility">PHP Compatibility</a> which is a set of sniffs for PHP CodeSniffer that can be used to detect code that will be problematic in a particular PHP version. As I use CodeSniffer extensively already, it’s a good fit for my existing toolset.</p><p>To install it, add the following dependencies to your <code>composer.json</code>:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "require-dev": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "dealerdirect/phpcodesniffer-composer-installer": "^0.4.3",</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        "squizlabs/php_codesniffer": "^2.5",</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        "wimg/php-compatibility": "^8.1"</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    },</td></tr></table></code></pre><p>Then update your <code>phpcs.xml</code> to look something like this:</p><pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>The coding standard for my app.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>./<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PHPCompatibility"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>   <span class="hljs-tag">&lt;<span class="hljs-name">config</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"testVersion"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7.2-"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></tr></table></code></pre><p>As you can see, it’s possible to use it alongside existing coding standards such as PSR2. Note the <code>testVersion</code> config key - the value specified is the PHP version we’re testing against. Here we’re specifying PHP 7.2.</p><p>Obviously, the very best way to guard against breakages in newer versions of PHP is to have a comprehensive test suite, but legacy code bases by definition tend to have little or no tests. By using PHP Compatibility, you should at least be able to catch syntax problems without having to audit the code base manually.</p></article><article class="post"><p class="date">25th February 2018 3:50 pm</p><h1><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers</a></h1><p>In <a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">my previous post</a> I mentioned some strategies for refactoring Laravel controllers to move unnecessary functionality elsewhere. However, I didn’t cover testing them. In this post I will demonstrate the methodology I use for testing Laravel controllers.</p><p>Say we have the following method in a controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $document = <span class="hljs-keyword">new</span> Document($request-&gt;only([</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'title'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'text'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ]));</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $document-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        event(<span class="hljs-keyword">new</span> DocumentCreated($document));</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> redirect()-&gt;route(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><p>This controller method does three things:</p><ul><li>Return a response</li><li>Create a model instance</li><li>Fire an event</li></ul><p>Our tests therefore need to pass it all its external dependencies and check it carries out the required actions.</p><p>First we fake the event facade:</p><pre><code class="hljs lang-php singleline">    Event::fake();</code></pre><p>Next, we create an instance of <code>Illuminate\Http\Request</code> to represent the HTTP request passed to the controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $request = Request::create(<span class="hljs-string">'/store'</span>, <span class="hljs-string">'POST'</span>,[</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'title'</span>     =&gt;     <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'text'</span>     =&gt;     <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    ]);</td></tr></table></code></pre><p>If you’re using a custom form request class, you should instantiate that in exactly the same way.</p><p>Then, instantiate the controller, and call the method, passing it the request object:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $controller = <span class="hljs-keyword">new</span> MyController();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    $response = $controller-&gt;store($request);</td></tr></table></code></pre><p>You can then test the response from the controller. You can test the status code like this:</p><pre><code class="hljs lang-php singleline">    <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">302</span>, $response-&gt;getStatusCode());</code></pre><p>You may also need to check the content of the response matches what you expect to see, by retrieving <code>$response-&gt;getBody()-&gt;getContent()</code>.</p><p>Next, retrieve the newly created model instance, and verify it exists:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $document = Document::where(<span class="hljs-string">'title'</span>, <span class="hljs-string">'foo'</span>)-&gt;first();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">$this</span>-&gt;assertNotNull($document);</td></tr></table></code></pre><p>You can also use <code>assertEquals()</code> to check the attributes on the model if appropriate. Finally, you check the event was fired:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    Event::assertDispatched(DocumentCreated::class, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($event)</span> <span class="hljs-title">use</span> <span class="hljs-params">($document)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-keyword">return</span> $event-&gt;document-&gt;id === $document-&gt;id; </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    });</td></tr></table></code></pre><p>This test should not concern itself with any functionality triggered by the event, only that the event gets triggered. The event should have separate unit tests in which the event is triggered, and then the test verifies it carried out the required actions.</p><p>Technically, these don’t quite qualify as being unit tests because they hit the database, but they should cover the controller adequately. To make them true unit tests, you’d need to implement the repository pattern for the database queries rather than using Eloquent directly, and mock the repository, so you can assert that the mocked repository receive the right data and have it return the expected response.</p><p>Here is how you might do that with Mockery:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$mock = Mockery::mock(<span class="hljs-string">'App\Contracts\Repositories\Document'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$mock-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'title'</span>    =&gt;        <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'text'</span>    =&gt;        <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>])-&gt;once()-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>$controller = <span class="hljs-keyword">new</span> MyController($mock);</td></tr></table></code></pre><p>As long as your controllers are kept as small as possible, it’s generally not too hard to test them. Unfortunately, fat controllers become almost impossible to test, which is another good reason to avoid them.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/06/23/forcing-ssl-in-codeigniter/">Forcing SSL in Codeigniter</a></p><p><a href="/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/">Logging to the ELK Stack With Laravel</a></p><p><a href="/blog/2018/05/13/full-text-search-with-mariadb/">Full-text Search With Mariadb</a></p><p><a href="/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/">Building a Letter Classifier in PHP With Tesseract OCR and PHP ML</a></p><p><a href="/blog/2018/04/29/console-applications-with-the-symfony-console-component/">Console Applications With the Symfony Console Component</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/1/">Newer</a></li><li><a href="/posts/3/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>