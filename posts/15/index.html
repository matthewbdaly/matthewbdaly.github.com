<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/15/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">15th March 2017 9:37 pm</p><h1><a href="/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/">Enforcing a Coding Standard With PHP Codesniffer</a></h1><p>We all start new projects with the best of intentions - it’ll be clean, fully tested and work perfectly. Sadly as deadlines loom, it’s all too easy to find yourself neglecting your code quality, and once it starts to degrade, getting it back becomes much harder. Many development teams try to adhere to a coding standard, but it can be hard to enforce on other people - it puts you in the uncomfortable position of nagging others all the time.</p><p>Fortunately, there’s an easy solution that doesn’t force everyone to use the same IDE. <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP CodeSniffer</a> is a useful package that lets you specify a coding standard and then validate your code against it. That way, you can set up continuous integration and use that to remind people of errors. Better still, it also allows many errors to be fixed automatically.</p><p>To use it on your PHP project, run the following command:</p><pre><code class="hljs lang-bash singleline">$ composer require --dev squizlabs/php_codesniffer</code></pre><p>As this will only ever be used in development, you should use the <code>--dev</code> flag. We also need to specify the settings for our project. This example is for a module to be used with a Laravel application and should be saved as <code>phpcs.xml</code>:</p><pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>The coding standard for our project.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>app<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>tests<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">exclude-pattern</span>&gt;</span>*/migrations/*<span class="hljs-tag">&lt;/<span class="hljs-name">exclude-pattern</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></tr></table></code></pre><p>Note the <code>&lt;rule /&gt;</code> tag - this specifies that this project should be validated as PSR2. Also, note the <code>&lt;file /&gt;</code> and <code>&lt;exclude-pattern /&gt;</code> tags - these specify what files should and should not be checked.</p><p>With this in place, we’re ready to run PHP CodeSniffer:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpcs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>......................</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Time: 45ms; Memory: 6Mb</td></tr></table></code></pre><p>In this case, our code validated successfully. However, if it doesn’t, there’s an easy way to tidy it up. Just run this command:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/phpcbf</code></pre><p>That will fix many of the most common problems, and any others should be straightforward to fix.</p><p>PHP CodeSniffer makes it extremely straightforward to enforce a coding style. You can write custom rulesets or just use an existing one as you prefer, and it’s easy to fix many common problems automatically. In fact, it makes it so easy that there’s very little excuse <em>not</em> to meet the coding standard.</p></article><article class="post"><p class="date">1st March 2017 11:16 pm</p><h1><a href="/blog/2017/03/01/decorating-laravel-repositories/">Decorating Laravel Repositories</a></h1><p><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">As mentioned previously</a>, when building any nontrivial Laravel application, it’s prudent to decouple our controllers from the Eloquent ORM (or any other ORM or data source we may be using) by creating an interface, and then writing a repository that implements that interface. We can then resolve the interface to our repository, and use the repository to interact with our data source. Should we need to switch to a different implementation, we then need only create the new repository and amend how Laravel resolves that interface.</p><p>The same principle applies when it comes to caching. Database queries are typically a major bottleneck in a web application, and so it’s prudent to implement some form of caching for your queries. However, it’s a bad idea to do so in your controllers, because just as with Eloquent models, you’re tying yourself to one particular implementation and won’t be able to switch without rewriting a good chunk of your controllers, as well as possibly having to maintain large amounts of duplicate code for when a query is made in several places.</p><p>Alternatively, you could implement caching within the methods of your repository, which might make sense for smaller projects. However, it means that your repository is now dependent on both the ORM and cache you chose. If you decide you want to change your ORM but retain the same caching system, or vice versa, you’re stuck with writing a new repository to handle both, duplicating work you’ve already done.</p><p>Fortunately, there’s a more elegant solution. Using the <a href="http://designpatternsphp.readthedocs.io/en/latest/Structural/Decorator/README.html">decorator pattern</a>, we can create a second repository that implements the same interface and “wraps” the original repository. Each of its methods will call its counterpart in the original, and if appropriate cache the response. That way, our caching is implemented separately from our database interactions, and we can easily create a repository for a new data source without affecting the caching in the slightest.</p><p>Say we have the following interface for our <code>User</code> model:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>And the following repository implements that interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EloquentUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">private</span> $model;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;model = $model;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        $user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">$this</span>-&gt;model;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $user-&gt;email = $input[<span class="hljs-string">'email'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $user-&gt;name = $input[<span class="hljs-string">'name'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        $user-&gt;password = Hash::make($input[<span class="hljs-string">'password'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        $user-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">return</span> $user;</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>}</td></tr></table></code></pre><p>We might implement the following repository class to handle caching:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span> <span class="hljs-title">as</span> <span class="hljs-title">Cache</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(UserRepositoryInterface $repository, Cache $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember(<span class="hljs-string">'all'</span>, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember($id, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($id)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;flush();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create($input);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Note how each method doesn’t actually do any querying. Instead, the constructor accepts an implementation of the same interface and the cache, and we defer all interactions with the database to that implementation. Each call that queries the database is wrapped in a callback so that it’s stored in Laravel’s cache when it’s returned, without touching the original implementation. When a user is created, the users tag is flushed from the cache so that stale results don’t get served.</p><p>To actually use this implementation, we need to update our service provider so that it resolves the interface to an implementation of our decorator:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;singleton(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            $baseRepo = <span class="hljs-keyword">new</span> \App\Repositories\EloquentUserRepository(<span class="hljs-keyword">new</span> \App\User);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            $cachingRepo = <span class="hljs-keyword">new</span> \App\Repositories\Decorators\CachingUserRepository($baseRepo, <span class="hljs-keyword">$this</span>-&gt;app[<span class="hljs-string">'cache.store'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-keyword">return</span> $cachingRepo;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>}</td></tr></table></code></pre><p>We instantiate the base repository, passing it the appropriate model. Then we instantiate the decorator, passing it the base repository and the cache, and return it. Now our controllers will start using the new decorator.</p><h2 id="testing-the-decorator">Testing the decorator</h2><p>Now that we have a working decorator, how do we test it? Just as with the decorator itself, we want our tests to be completely decoupled from any particular implementation of the dependencies. If in future we’re asked to migrate the database to MongoDB, say, we’ll have plenty of work writing our new database repositories, so we don’t want to have to rewrite the tests for our decorator as well. Fortunately, using Mockery we can just mock the interface for the repository, and pass that mock into the constructor of the decorator in our test. That way we can have the mock return a known response and not involve either the database repository or the underlying models in any way.</p><p>We will also want to mock the cache itself, as this is a unit test and so as far as possible it should not be testing anything outside of the repository class. Here’s an example of how we might test the above decorator.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>\<span class="hljs-title">CachingUserRepository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * Test fetching all items</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingAll</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'all'</span>)-&gt;andReturn([]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn([]);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $items = $repository-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertCount(<span class="hljs-number">0</span>, $items);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     * Test fetching a single item</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFindOrFail</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'findOrFail'</span>)-&gt;with(<span class="hljs-number">1</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        $item = $repository-&gt;findOrFail(<span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNull($item);</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>     * Test creating a single item</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreate</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>])-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'usersUser'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'flush'</span>)-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>        $item = $repository-&gt;create([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertTrue($item);</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        m::close();</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>        <span class="hljs-keyword">parent</span>::tearDown();</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>}</td></tr></table></code></pre><p>As you can see, all we care about is that the underlying repository interface receives the correct method calls and arguments, nothing more. That way our test is fast and repository-agnositc.</p><h2 id="other-applications">Other applications</h2><p>Here I’ve used this technique to cache the queries, but that’s not the only use case for decorating a repository. For instance, you could decorate a repository to fire events when certain methods are called, and write different decorators when reusing these repositories for different applications. You could create one to log interactions with the repository, or you could use an external library to cache your queries, all without touching your existing repository. Should we need to switch back to our base repository, it’s just a matter of amending the service provider accordingly as both the decorator and the repository implement the same interface.</p><p>Creating decorators does mean you have to implement all of the interface’s methods again, but if you have a base repository that your other ones inherit from, you can easily create a base decorator in a similar fashion that wraps methods common to all the repositories, and then just implement the additional methods for each decorator as required. Also, each method is likely to be fairly limited in scope so it’s not generally too onerous.</p></article><article class="post"><p class="date">19th February 2017 3:50 pm</p><h1><a href="/blog/2017/02/19/my-first-laravel-package/">My First Laravel Package</a></h1><p>For some time now I’ve had a Laravel middleware I use extensively to add ETags to HTTP requests. I often use it for work projects, but obviously copying and pasting it all the time was a pain. I always meant to create a package for it, but I didn’t want to do so until such time as I had some proper tests for it. Now I’ve finally figured out how to test middleware in isolation and I’ve got around to adding tests and creating a proper package for it.</p><p>It’s available on <a href="https://github.com/matthewbdaly/laravel-etag-middleware">Github</a> and <a href="https://packagist.org/packages/matthewbdaly/laravel-etag-middleware">Packagist</a> if you want to use it.</p></article><article class="post"><p class="date">18th February 2017 9:25 pm</p><h1><a href="/blog/2017/02/18/integrating-behat-with-laravel/">Integrating Behat With Laravel</a></h1><p>The Gherkin format used by tools like Cucumber is a really great way of specifying how your application will work. It’s easy for even non-technical stakeholders to understand, it makes it natural to break your tests into easily reusable steps, and it encourages you to think about the application from an end-user’s perspective. It’s also one of the easiest ways to get started writing automated tests when you first start out - it’s much more intuitive to a junior developer than lower-level unit tests, and is easier to add to a legacy project that may not have been built with testability in mind - if you can drive a browser, you can test it.</p><p><a href="http://behat.org/en/latest/">Behat</a> is a PHP equivalent. Combined with <a href="http://mink.behat.org/en/latest/">Mink</a>, it allows for easy automated acceptance tests of a PHP application. However, out of the box it doesn’t integrate well with Laravel. There is <a href="https://github.com/laracasts/Behat-Laravel-Extension">Jeffrey Way’s Behat Laravel extension</a>, but it doesn’t seem to be actively maintained and seems to be overkill for this purpose. I wanted something that I could use to run integration tests using PHPUnit’s assertions and Laravel’s testing utilities, and crucially, I wanted to do so as quickly as possible. That meant running a web server and using an automated web browser wasn’t an option. Also, I often work on REST API’s, and browser testing isn’t appropriate for those - in API tests I’m more interested in setting up the fixtures, making a single request, and verifying that it does what it’s meant to do, as quickly as possible.</p><p>As it turns out, integrating Behat and Laravel isn’t that hard. When using Behat, your <code>FeatureContext.php</code> file must implement the <code>Behat\Behat\Context\Context</code> interface, but as this interface does not implement any methods, you can extend any existing class and declare that it implements that interface. That means we can just extend the existing <code>Tests\TestCase</code> class in Laravel 5.4 and gain access to all the same testing utilities we have in our regular Laravel tests.</p><p>Then, in the constructor we can set environment variables using <code>putenv()</code> so that we can set it up to use an in-memory SQLite database for faster tests. We also use the <code>@BeforeScenario</code> hook to migrate the database before each scenario, and the <code>@AfterScenario</code> hook to roll it back afterwards.</p><p>Here’s the finished example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Behat</span>\<span class="hljs-title">Context</span>\<span class="hljs-title">Context</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Gherkin</span>\<span class="hljs-title">Node</span>\<span class="hljs-title">PyStringNode</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Gherkin</span>\<span class="hljs-title">Node</span>\<span class="hljs-title">TableNode</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Behat</span>\<span class="hljs-title">Tester</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">PendingException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Testing</span>\<span class="hljs-title">DatabaseMigrations</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Behat</span>\<span class="hljs-title">Hook</span>\<span class="hljs-title">Scope</span>\<span class="hljs-title">BeforeScenarioScope</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Behat</span>\<span class="hljs-title">Hook</span>\<span class="hljs-title">Scope</span>\<span class="hljs-title">AfterScenarioScope</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Kernel</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td> * Defines application features from the specific context.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeatureContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Context</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">DatabaseMigrations</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">protected</span> $content;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Initializes context.</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * Every scenario gets its own context instance.</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * You can also pass arbitrary arguments to the</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     * context constructor through behat.yml.</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        putenv(<span class="hljs-string">'DB_CONNECTION=sqlite'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        putenv(<span class="hljs-string">'DB_DATABASE=:memory:'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-keyword">parent</span>::setUp();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-comment">/** <span class="hljs-doctag">@BeforeScenario</span> */</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">before</span><span class="hljs-params">(BeforeScenarioScope $scope)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        <span class="hljs-keyword">$this</span>-&gt;artisan(<span class="hljs-string">'migrate'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app[Kernel::class]-&gt;setArtisan(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    <span class="hljs-comment">/** <span class="hljs-doctag">@AfterScenario</span> */</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">after</span><span class="hljs-params">(AfterScenarioScope $scope)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;artisan(<span class="hljs-string">'migrate:rollback'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>     * <span class="hljs-doctag">@Given</span> I visit the path :path</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iVisitThePath</span><span class="hljs-params">($path)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">200</span>, $response-&gt;getStatusCode());</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-keyword">$this</span>-&gt;content = $response-&gt;getContent();</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * <span class="hljs-doctag">@Then</span> I should see the text :text</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iShouldSeeTheText</span><span class="hljs-params">($text)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertContains($text, <span class="hljs-keyword">$this</span>-&gt;content);</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>     * <span class="hljs-doctag">@Given</span> a user called :user exists</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aUserCalledExists</span><span class="hljs-params">($user)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        $user = factory(App\User::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>            <span class="hljs-string">'name'</span> =&gt; $user,</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>     * <span class="hljs-doctag">@Given</span> I am logged in as :user</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iAmLoggedInAs</span><span class="hljs-params">($user)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>        $user = User::where(<span class="hljs-string">'name'</span>, $user)-&gt;first();</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        <span class="hljs-keyword">$this</span>-&gt;be($user);</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>}</td></tr></table></code></pre><p>Note that I’ve added a few basic example methods for our tests. As you can see, we can call the same methods we normally use in Laravel tests to make assertions and HTTP requests. If you’re using Dusk, you can also call that in the same way you usually would.</p><p>We might then write the following feature file to demonstrate our application at work:</p><pre><code class="hljs lang-gherkin"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">Feature</span>: Login</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">Background</span>:</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">Given</span> a user called <span class="hljs-string">"Alan"</span> exists</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">And</span> a user called <span class="hljs-string">"Bob"</span> exists</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">And</span> a user called <span class="hljs-string">"Clare"</span> exists</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">And</span> a user called <span class="hljs-string">"Derek"</span> exists</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">And</span> a user called <span class="hljs-string">"Eric"</span> exists</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">Scenario</span>: Log in as Alan</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">Given</span> I am logged in as <span class="hljs-string">"Alan"</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">And</span> I visit the path <span class="hljs-string">"/"</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">Then</span> I should see the text <span class="hljs-string">"Laravel"</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">Scenario</span>: Log in as Bob</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">Given</span> I am logged in as <span class="hljs-string">"Bob"</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">And</span> I visit the path <span class="hljs-string">"/"</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">Then</span> I should see the text <span class="hljs-string">"Laravel"</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">Scenario</span>: Log in as Clare</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">Given</span> I am logged in as <span class="hljs-string">"Clare"</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">And</span> I visit the path <span class="hljs-string">"/"</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">Then</span> I should see the text <span class="hljs-string">"Laravel"</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">Scenario</span>: Log in as Derek</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">Given</span> I am logged in as <span class="hljs-string">"Derek"</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">And</span> I visit the path <span class="hljs-string">"/"</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">Then</span> I should see the text <span class="hljs-string">"Laravel"</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">Scenario</span>: Log in as Eric</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">Given</span> I am logged in as <span class="hljs-string">"Eric"</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">And</span> I visit the path <span class="hljs-string">"/"</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">Then</span> I should see the text <span class="hljs-string">"Laravel"</span></td></tr></table></code></pre><p>We can then run these tests with <code>vendor/bin/behat</code>:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/behat </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Feature: Login</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  Background:                         <span class="hljs-comment"># features/auth.feature:3</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    Given a user called <span class="hljs-string">"Alan"</span> exists <span class="hljs-comment"># FeatureContext::aUserCalledExists()</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    And a user called <span class="hljs-string">"Bob"</span> exists    <span class="hljs-comment"># FeatureContext::aUserCalledExists()</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    And a user called <span class="hljs-string">"Clare"</span> exists  <span class="hljs-comment"># FeatureContext::aUserCalledExists()</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    And a user called <span class="hljs-string">"Derek"</span> exists  <span class="hljs-comment"># FeatureContext::aUserCalledExists()</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    And a user called <span class="hljs-string">"Eric"</span> exists   <span class="hljs-comment"># FeatureContext::aUserCalledExists()</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  Scenario: Log <span class="hljs-keyword">in</span> as Alan               <span class="hljs-comment"># features/auth.feature:10</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    Given I am logged <span class="hljs-keyword">in</span> as <span class="hljs-string">"Alan"</span>       <span class="hljs-comment"># FeatureContext::iAmLoggedInAs()</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    And I visit the path <span class="hljs-string">"/"</span>             <span class="hljs-comment"># FeatureContext::iVisitThePath()</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    Then I should see the text <span class="hljs-string">"Laravel"</span> <span class="hljs-comment"># FeatureContext::iShouldSeeTheText()</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Scenario: Log <span class="hljs-keyword">in</span> as Bob                <span class="hljs-comment"># features/auth.feature:15</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    Given I am logged <span class="hljs-keyword">in</span> as <span class="hljs-string">"Bob"</span>        <span class="hljs-comment"># FeatureContext::iAmLoggedInAs()</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    And I visit the path <span class="hljs-string">"/"</span>             <span class="hljs-comment"># FeatureContext::iVisitThePath()</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    Then I should see the text <span class="hljs-string">"Laravel"</span> <span class="hljs-comment"># FeatureContext::iShouldSeeTheText()</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  Scenario: Log <span class="hljs-keyword">in</span> as Clare              <span class="hljs-comment"># features/auth.feature:20</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    Given I am logged <span class="hljs-keyword">in</span> as <span class="hljs-string">"Clare"</span>      <span class="hljs-comment"># FeatureContext::iAmLoggedInAs()</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    And I visit the path <span class="hljs-string">"/"</span>             <span class="hljs-comment"># FeatureContext::iVisitThePath()</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    Then I should see the text <span class="hljs-string">"Laravel"</span> <span class="hljs-comment"># FeatureContext::iShouldSeeTheText()</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>  Scenario: Log <span class="hljs-keyword">in</span> as Derek              <span class="hljs-comment"># features/auth.feature:25</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    Given I am logged <span class="hljs-keyword">in</span> as <span class="hljs-string">"Derek"</span>      <span class="hljs-comment"># FeatureContext::iAmLoggedInAs()</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    And I visit the path <span class="hljs-string">"/"</span>             <span class="hljs-comment"># FeatureContext::iVisitThePath()</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    Then I should see the text <span class="hljs-string">"Laravel"</span> <span class="hljs-comment"># FeatureContext::iShouldSeeTheText()</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>  Scenario: Log <span class="hljs-keyword">in</span> as Eric               <span class="hljs-comment"># features/auth.feature:30</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    Given I am logged <span class="hljs-keyword">in</span> as <span class="hljs-string">"Eric"</span>       <span class="hljs-comment"># FeatureContext::iAmLoggedInAs()</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    And I visit the path <span class="hljs-string">"/"</span>             <span class="hljs-comment"># FeatureContext::iVisitThePath()</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    Then I should see the text <span class="hljs-string">"Laravel"</span> <span class="hljs-comment"># FeatureContext::iShouldSeeTheText()</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>5 scenarios (5 passed)</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>40 steps (40 passed)</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>0m0.50s (19.87Mb)</td></tr></table></code></pre><p>Higher level tests can get very tedious if you’re not careful - you wind up setting up the same fixtures and making the same requests many times over. By using Behat in this way, not only are you writing your tests in a way that is easy to understand, but you’re also breaking it down into logical, repeatable steps, and by passing arguments in each step you limit the amount of repetition. It’s also fast if you aren’t running browser-based tests, making it particularly well-suited to API testing.</p></article><article class="post"><p class="date">29th November 2016 11:00 pm</p><h1><a href="/blog/2016/11/29/testing-laravel-middleware/">Testing Laravel Middleware</a></h1><p>It’s widely accepted that high-level integration tests alone do not make for a good test suite. Ideally each individual component of your application should have unit tests, which test that component in isolation. These unit tests are usually much quicker to run, making it easier to practice test-driven development. However, it can sometimes be hard to grasp how to test that one component on its own.</p><p>The other day I had an issue with several middleware classes for a Laravel application and I wanted to verify that they were working as expected. Sounds like a job for dedicated unit tests, but I hadn’t tested custom middleware in isolation before, and figuring out how to do so took a while.</p><p>Laravel middleware accepts an instance of <code>Illuminate\Http\Request</code>, itself based on the Symfony request object, as well as a closure for the action to take next. Depending on what the middleware does, it may return a redirect or simply amend the existing request or response. So in theory you can instantiate a request object, pass it to the middleware, and check the response. For middleware that does something simple, such as redirecting users based on certain conditions, this is fairly straightforward.</p><p>In this example we have a fairly useless piece of middleware that checks to see what the route is for a request and redirects it if it matches a certain pattern:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedirectFromAdminMiddleware</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Handle an incoming request.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">if</span> ($request-&gt;is(<span class="hljs-string">'admin*'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>}</td></tr></table></code></pre><p>While this example is of limited use, it wouldn’t take much work to develop it to redirect conditionally based on an account type, and it’s simple enough to demonstrate the principles involved. In these tests, we create instances of <code>Illuminate\Http\Request</code> and pass them to the middleware’s <code>handle()</code> method, along with an empty closure representing the response. If the middleware does not amend the request, we get the empty response from the closure. If it does amend the request, we get a redirect response.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedirectFromAdminMiddlewareTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRedirectMiddlewareCalledOnAdmin</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/admin'</span>, <span class="hljs-string">'GET'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\RedirectFromAdminMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $response = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{});</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals($response-&gt;getStatusCode(), <span class="hljs-number">302</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRedirectMiddlewareNotCalledOnNonAdmin</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/pages'</span>, <span class="hljs-string">'GET'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\RedirectFromAdminMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        $response = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{});</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals($response, <span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>For middleware that fetches the response and acts on it, things are a little more complex. For instance, this is the Etag middleware I use on many projects:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ETagMiddleware</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     * Implement Etag support</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-comment">// Get response</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $response = $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-comment">// If this was a GET request...</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">if</span> ($request-&gt;isMethod(<span class="hljs-string">'get'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            <span class="hljs-comment">// Generate Etag</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            $etag = md5($response-&gt;getContent());</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            $requestEtag = str_replace(<span class="hljs-string">'"'</span>, <span class="hljs-string">''</span>, $request-&gt;getETags());</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-comment">// Check to see if Etag has changed</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-keyword">if</span>($requestEtag &amp;&amp; $requestEtag[<span class="hljs-number">0</span>] == $etag) {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>                $response-&gt;setNotModified();</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-comment">// Set Etag</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            $response-&gt;setEtag($etag);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-comment">// Send response</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>}</td></tr></table></code></pre><p>This acts on the response object, so we need to pass that through as well. Fortunately, Mockery allows us to create a mock of our response object and set it up to handle only those methods we anticipate being called:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ETagMiddlewareTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>     * Test new request not cached</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testModified</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-comment">// Create mock response</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $response = Mockery::mock(<span class="hljs-string">'Illuminate\Http\Response'</span>)-&gt;shouldReceive(<span class="hljs-string">'getContent'</span>)-&gt;once()-&gt;andReturn(<span class="hljs-string">'blah'</span>)-&gt;getMock();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $response-&gt;shouldReceive(<span class="hljs-string">'setEtag'</span>)-&gt;with(md5(<span class="hljs-string">'blah'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/admin'</span>, <span class="hljs-string">'GET'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\ETagMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $middlewareResponse = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($response)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     * Test repeated request not modified</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testNotModified</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-comment">// Create mock response</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $response = Mockery::mock(<span class="hljs-string">'Illuminate\Http\Response'</span>)-&gt;shouldReceive(<span class="hljs-string">'getContent'</span>)-&gt;once()-&gt;andReturn(<span class="hljs-string">'blah'</span>)-&gt;getMock();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $response-&gt;shouldReceive(<span class="hljs-string">'setEtag'</span>)-&gt;with(md5(<span class="hljs-string">'blah'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        $response-&gt;shouldReceive(<span class="hljs-string">'setNotModified'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        <span class="hljs-comment">// Create request</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        $request = Request::create(<span class="hljs-string">'http://example.com/admin'</span>, <span class="hljs-string">'GET'</span>, [], [], [], [</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>            <span class="hljs-string">'ETag'</span> =&gt; md5(<span class="hljs-string">'blah'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-comment">// Pass it to the middleware</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        $middleware = <span class="hljs-keyword">new</span> App\Http\Middleware\ETagMiddleware();</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        $middlewareResponse = $middleware-&gt;handle($request, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($response)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>            <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">teardown</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        Mockery::close();</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>}</td></tr></table></code></pre><p>In the first example we mock out the <code>getContent()</code> and <code>setEtag()</code> methods of our response to make sure they get called, and then pass the request to the middleware, along with a closure that returns the response. In the second example, we also mock out <code>setNotModified()</code> to ensure that the correct status code of 304 is set, and add an ETag to our request. In this way we can easily test our middleware in isolation, rather than having to resort to building up our entire application just to test one small method.</p><p>Middleware is a convenient place to put functionality that’s needed for many routes, but you shouldn’t neglect testing it, and ideally you shouldn’t have to resort to writing a slow integration test to test it works as expected. By mocking out your dependencies, it’s generally not too hard to test it in isolation, resulting in faster and more robust test suites.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></p><p><a href="/blog/2019/10/13/flexible-data-types-with-the-json-field/">Flexible Data Types With the JSON Field</a></p><p><a href="/blog/2019/09/22/storing-wordpress-configuration-in-environment-variables/">Storing Wordpress Configuration in Environment Variables</a></p><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/posts/14/">Newer</a></li><li class="page-item"><a class="page-link" href="/posts/16/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2020.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>