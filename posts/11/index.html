<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/11/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">2nd January 2018 12:12 pm</p><h1><a href="/blog/2018/01/02/a-laravel-package-boilerplate/">A Laravel Package Boilerplate</a></h1><p>The second package I’ve been working on recently is <a href="https://github.com/matthewbdaly/laravel-package-boilerplate">Laravel Package Boilerplate</a>. It’s a basic starter boilerplate for building your own Laravel packages.</p><p>It’s not meant to be installed as a project dependency. Instead, run the following command to create a new project boilerplate with it:</p><pre><code class="hljs lang-bash singleline">composer create-project --prefer-dist matthewbdaly/laravel-package-boilerplate &lt;YOUR_NEW_PACKAGE_DIRECTORY&gt;</code></pre><p>This will create a new folder that includes a <code>src</code> folder containing a service provider, and a <code>tests</code> folder containing a preconfigured base test case, as well as a simple test case for tests that don’t need the full application instantiated, in order to help keep your test suite as fast as possible.</p><p>In addition, it includes configuration files for:</p><ul><li>PHPUnit</li><li>PHP CodeSniffer</li><li>Travis CI</li></ul><p>That way you can start your project off the right way with very little effort.</p><p>I’ve also added my Artisan Standalone project as a dependency - that way you can access any Artisan commands you need to generate files you need as follows:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/artisan</code></pre><p>Hopefully this package should make it a lot easier to create new Laravel packages in future.</p></article><article class="post"><p class="date">2nd January 2018 12:01 pm</p><h1><a href="/blog/2018/01/02/using-artisan-from-standalone-laravel-packages/">Using Artisan from Standalone Laravel Packages</a></h1><p>Recently I’ve been building and publishing a significant number of Laravel packages, and I thought I’d share details of some of them over the next few days.</p><p><a href="https://github/com/matthewbdaly/artisan-standalone">Artisan Standalone</a> is a package that, when installed in a standalone Laravel package (eg, not in an actual Laravel install, but in a package that you’re building that is intended for use with Laravel), allows you to use Artisan. It’s intended largely to make it quicker and easier to build functionality as separate packages by giving you access to the same generator commands as you have when working with a Laravel application. It came about largely from a need to scratch my own itch, as when building packages I was having to either run Artisan commands in a Laravel app and move them over, or copy them from existing files, which was obviously a pain in the proverbial.</p><p>You can install it with the following command:</p><pre><code class="hljs lang-bash singleline">$ composer require --dev matthewbdaly/artisan-standalone</code></pre><p>Once it’s installed, you can access Artisan as follows:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/artisan</code></pre><p>Note that it doesn’t explicitly include Laravel as a dependency - you’ll need to add that in the parent package to pull in the libraries it needs (which you should be doing anyway). It’s possible that there are some commands that won’t work in this context, but they’re almost certainly ones you won’t need here, such as the <code>migrate</code> command. As far as I can tell the generator commands, which are the only ones we’re really interested in here, all work OK.</p></article><article class="post"><p class="date">1st January 2018 4:06 pm</p><h1><a href="/blog/2018/01/01/creating-artisan-tasks-that-generate-files/">Creating Artisan Tasks That Generate Files</a></h1><p>While the documentation for creating Artisan tasks is generally pretty good, it doesn’t really touch on creating tasks that generate new files. The only way to figure it out was to go digging through the source code. In this case, I was building an Artisan command to create Fractal transformers as part of a package I’m working on.</p><p>There’s a specialised class for generating files at <code>Illuminate\Console\GeneratorCommand</code>, which your command class should extend instead of <code>Illuminate\Console\Command</code>. In addition to the usual properties such as the signature and description, you also need to specify <code>$type</code> to give the type of class being generated. Also, note that the constructor is different, so if you use <code>php artisan make:console</code> to create the boilerplate for this command, you’ll need to delete the constructor.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Commands</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">GeneratorCommand</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputArgument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformerMakeCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GeneratorCommand</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     * The name and signature of the console command.</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@var</span> string</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $signature = <span class="hljs-string">'make:transformer {name : The required name of the transformer class}'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * The console command description.</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * <span class="hljs-doctag">@var</span> string</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-keyword">protected</span> $description = <span class="hljs-string">'Create a Fractal transformer'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * The type of class being generated.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@var</span> string</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">protected</span> $type = <span class="hljs-string">'Fractal transformer'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     * Get the stub file for the generator.</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     * <span class="hljs-doctag">@return</span> string</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStub</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/stubs/transformer.stub'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * Get the console command arguments.</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> array</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getArguments</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>            [<span class="hljs-string">'name'</span>, InputArgument::REQUIRED, <span class="hljs-string">'The name of the command.'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * Get the default namespace for the class.</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>     * <span class="hljs-doctag">@param</span>  string  $rootNamespace</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>     * <span class="hljs-doctag">@return</span> string</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDefaultNamespace</span><span class="hljs-params">($rootNamespace)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        <span class="hljs-keyword">return</span> $rootNamespace.<span class="hljs-string">'\Transformers'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>}</td></tr></table></code></pre><p>Note the <code>getDefaultNamespace()</code> method. If your class will live directly under the <code>app</code> folder this is not necessary. Otherwise, it needs to return the root namespace, with the folder structure you want after it. Here my class will live under <code>app\Transformers</code>, so I’ve set it to reflect that.</p><p>Also, note the <code>getStub()</code> method. This tells Artisan that it should use the specified stub file as the basis for our class. Below you’ll find the stub file I used for my transformer:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">DummyNamespace</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">BaseTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DummyClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTransformer</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $model-&gt;id,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>Note that the <code>DummyNamespace</code> and <code>DummyClass</code> fields will be overwritten with the correct values.</p><p>Once this Artisan command is registered in the usual way, you can then run it as follows:</p><pre><code class="hljs lang-bash singleline">$ php artisan make:transformer Example</code></pre><p>And it will generate a boilerplate class something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Transformers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">MyPackage</span>\<span class="hljs-title">Transformers</span>\<span class="hljs-title">BaseTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTransformer</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'id'</span>            =&gt; (int) $model-&gt;id,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>You can then replace the model with your own one as necessary, and add any further content to this class.</p></article><article class="post"><p class="date">29th December 2017 6:01 pm</p><h1><a href="/blog/2017/12/29/using-uuids-as-primary-keys-with-laravel-and-postgresql/">Using Uuids As Primary Keys With Laravel and Postgresql</a></h1><p>For many applications, using UUID’s as the primary keys on a database table can make a lot of sense. For mobile or offline apps, in particular, they mean you can create new objects locally and assign them a primary key without having to worry about it colliding with another object that was created in the meantime once it gets synchronised to the server. Also, they are less informative to nefarious users - an autoincrementing value in a URL tells a user that that value is the primary key, and means the app may potentially allow gathering of information via user enumeration (eg calling <code>/api/v1/users/1</code>, <code>/api/v1/users/2</code> etc).</p><p>It’s fairly straightforward to use UUID’s as primary keys on your models when using PostgreSQL. First, you need to set up your migrations to use the <code>uuid-ossp</code> extension and set up the <code>id</code> field as both a UUID and the primary key. You also need to set a default value manually so that if it’s left empty it will generate a UUID for it.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>DB::statement(<span class="hljs-string">'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Schema::create(<span class="hljs-string">'items'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    $table-&gt;uuid(<span class="hljs-string">'id'</span>)-&gt;primary();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    $table-&gt;text(<span class="hljs-string">'text'</span>)-&gt;nullable();</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>});</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>DB::statement(<span class="hljs-string">'ALTER TABLE items ALTER COLUMN id SET DEFAULT uuid_generate_v4();'</span>);</td></tr></table></code></pre><p>Then, in the model definition, you need to tell Laravel to cast the <code>id</code> field to a string, and explicitly set the primary key to <code>id</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">protected</span> $casts = [</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'string'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">protected</span> $primaryKey = <span class="hljs-string">"id"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>}</td></tr></table></code></pre><p>Once this is done, the model should generate the primary keys for you as usual, except as UUID’s. If your application needs to accept UUID primary keys that were created offline, such as in a mobile app, you will probably want to add the <code>id</code> field to the <code>$fillable</code> array on the model to allow this.</p></article><article class="post"><p class="date">2nd December 2017 11:30 pm</p><h1><a href="/blog/2017/12/02/full-text-search-with-laravel-and-postgresql/">Full Text Search With Laravel and Postgresql</a></h1><p>I’ve touched on <a href="/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">using PostgreSQL to implement fuzzy search with Laravel before</a>, but another type of search that PostgreSQL can handle fairly easily is full-text search. Here I’ll show you how to use it in a Laravel application.</p><p>An obvious use case for this kind of search is a personal blogging engine. It’s unlikely something like this is going to have enough content for it to be worth using a heavier solution like Elasticsearch, but a <code>LIKE</code> or <code>ILIKE</code> statement doesn’t really cut it either, so Postgres’s full text search is a good fit. Below you’ll see a Laravel migration for the blog posts table:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreatePostsTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'posts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;increments(<span class="hljs-string">'id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'title'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;datetime(<span class="hljs-string">'pub_date'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            $table-&gt;text(<span class="hljs-string">'text'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            $table-&gt;string(<span class="hljs-string">'slug'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            $table-&gt;integer(<span class="hljs-string">'author_id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        DB::statement(<span class="hljs-string">"ALTER TABLE posts ADD COLUMN searchtext TSVECTOR"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        DB::statement(<span class="hljs-string">"UPDATE posts SET searchtext = to_tsvector('english', title || '' || text)"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        DB::statement(<span class="hljs-string">"CREATE INDEX searchtext_gin ON posts USING GIN(searchtext)"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        DB::statement(<span class="hljs-string">"CREATE TRIGGER ts_searchtext BEFORE INSERT OR UPDATE ON posts FOR EACH ROW EXECUTE PROCEDURE tsvector_update_trigger('searchtext', 'pg_catalog.english', 'title', 'text')"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        DB::statement(<span class="hljs-string">"DROP TRIGGER IF EXISTS tsvector_update_trigger ON posts"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        DB::statement(<span class="hljs-string">"DROP INDEX IF EXISTS searchtext_gin"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        DB::statement(<span class="hljs-string">"ALTER TABLE posts DROP COLUMN searchtext"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        Schema::dropIfExists(<span class="hljs-string">'posts'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>}</td></tr></table></code></pre><p>Note that after we create the basic layout of our <code>posts</code> table, we then have to drop down to raw DB statements to achieve the next steps:</p><ul><li>We add a column called <code>searchtext</code> with a type of <code>TSVECTOR</code> (unfortunately Laravel doesn’t have a convenient method to create this column type, so we need to do it with a raw statement). This column will hold our searchable document.</li><li>We use the <code>to_tsvector()</code> method to generate a document on each row that combines the title and text fields and store it in the <code>searchtext</code> column. Note also that we specify the language as the first argument. This is because Postgres’s full text search understands so-called “stopwords”, which are words that are so common as to not be worth bothering with at all, such as “the” - these will obviously differ between languages, so it’s prudent to explicitly state this so Postgres knows what stopwords to expect.</li><li>We create a <code>GIN</code> index on the <code>posts</code> table using our new <code>searchtext</code> column.</li><li>Finally we create a trigger which, when the table is amended, regenerates the search text.</li></ul><p>With that done, we can now look at actually performing a full-text search. To facilitate easy re-use, we’ll create a local scope on our <code>Post</code> model. If you haven’t used scopes in Laravel before, they essentially allow you to break queries into reusable chunks. In this case, we expect our scope to receive two arguments, the query instance (which is passed through automatically), and the search text:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $fillable = [</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-string">'title'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-string">'pub_date'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-string">'text'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-string">'slug'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-string">'author_id'</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scopeSearch</span><span class="hljs-params">($query, $search)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> (!$search) {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">return</span> $query;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> $query-&gt;whereRaw(<span class="hljs-string">'searchtext @@ to_tsquery(\'english\', ?)'</span>, [$search])</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            -&gt;orderByRaw(<span class="hljs-string">'ts_rank(searchtext, to_tsquery(\'english\', ?)) DESC'</span>, [$search]);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>If <code>$search</code> is empty, we just return the query object as is. Otherwise, we first of all construct a <code>WHERE</code> clause that matches our search text against the <code>searchtext</code> column. Note the syntax used here:</p><pre><code class="hljs lang-sql singleline">searchtext @@ to_tsquery('english', 'foo')</code></pre><p>We use the <code>to_tsquery()</code> method to match our text against our search document. As before, note that we specify the language.</p><p>Finally, we specify an order - we want the highest ranked matches to appear first, and this section of the query does that:</p><pre><code class="hljs lang-sql singleline">ts_rank(searchtext, to_tsquery('english', 'foo')) DESC</code></pre><p>Here we use <code>ts_rank()</code> to ensure we get our results in the appropriate order. Note that for both queries, we passed the arguments through as parameterized queries, rather than constructing a raw string - we have to watch out for SQL injection when we’re writing raw queries, but we can use PDO’s parameterized queries from Eloquent in a raw statement, which makes things a bit easier.</p><p>Now we can call our new search scope as follows:</p><pre><code class="hljs lang-php singleline">$posts = Post::search($search)-&gt;get();</code></pre><p>Because the scope receives and returns a query builder instance, you can continue to add the rest of your query, or paginate it, as necessary:</p><pre><code class="hljs lang-php singleline">$posts = Post::search($search)-&gt;where(<span class="hljs-string">'draft'</span>, <span class="hljs-keyword">false</span>)-&gt;simplePaginate(<span class="hljs-number">5</span>);</code></pre><p>If you’re working in a language that makes heavy use of accents, such as French, you might also want to install the <code>unaccent</code> extension (you can do this in the migration with <code>CREATE EXTENSION unaccent</code>). Then, any time we call <code>to_tsvector()</code>, you should pass any strings through the <code>unaccent()</code> method to strip out the accents.</p><h2 id="do-we-need-the-migrations-">Do we need the migrations?</h2><p>Technically, we could do without the additional changes to the database structure - we could create a document on the fly inside a subquery and use that to query against, which would look something like this in SQL:</p><pre><code class="hljs lang-sql"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">SELECT</span> *</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">FROM</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  (<span class="hljs-keyword">SELECT</span> *,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>          to_tsvector(<span class="hljs-string">'english'</span>, posts.title) || to_tsvector(<span class="hljs-string">'english'</span>, posts.text) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">document</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-keyword">FROM</span> <span class="hljs-string">"posts"</span>) <span class="hljs-keyword">search</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">WHERE</span> search.document @@ to_tsquery(<span class="hljs-string">'Redis'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ts_rank(search.document, to_tsquery(<span class="hljs-string">'english'</span>, <span class="hljs-string">'Redis'</span>)) <span class="hljs-keyword">DESC</span>;</td></tr></table></code></pre><p>However, the performance is likely to be significantly worse using this approach as it has to recreate the document, and doesn’t have an existing index to query against. It’s also a pig to write something like this with an ORM.</p><p>I’m currently working on a more generic solution for implementing full text search with Postgres and Laravel, however so far it looks like that solution will not only be considerably more complex than this (consistently producing a suitable query for unknown data is rather fiddly), but you can’t create a column for the vector ahead of time, meaning the query will be slower. This approach, while it requires more work than simply installing a package, is not terribly hard to implement on a per-model basis and is easy to customise for your use case.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><p><a href="/blog/2019/07/28/skipping-environment-specific-phpunit-tests/">Skipping Environment Specific Phpunit Tests</a></p><p><a href="/blog/2019/06/19/powering-up-git-bisect-with-the-run-command/">Powering Up Git Bisect With the Run Command</a></p><p><a href="/blog/2019/05/14/writing-golden-master-tests-for-laravel-applications/">Writing Golden Master Tests for Laravel Applications</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/10/">Newer</a></li><li class="page-item"><a href="/posts/12/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>