<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/9/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">19th August 2017 3:40 pm</p><h1><a href="/blog/2017/08/19/run-your-tests-locally-with-sismo/">Run Your Tests Locally With Sismo</a></h1><p>Continuous integration is a veritable boon when working on any large software project. However, the popularity of distributed version control systems like Git over the older, more centralised ones like Subversion means that when you commit your changes, they don’t necessarily get pushed up to a remote repository immediately. While this is a good thing because it means you can commit at any stage without worrying about pushing up changes that break everyone else’s build, it has the downside that the tests aren’t automatically run on every commit, just every push, so if you get sloppy about running your tests before every commit you can more easily get caught out. In addition, a full CI server like Jenkins is a rather large piece of software that you don’t really want to run locally if you can help it, and has a lot of functionality you don’t need.</p><p><a href="https://sismo.symfony.com/">Sismo</a> is a small, simple continuous integration server, implemented in PHP, that’s ideal for running locally. You can set it up to run your tests on every commit, and it has an easy-to-use web interface. Although it’s a PHP application, there’s no reason why you couldn’t use it to run tests for projects in other languages, and because it’s focused solely on running your test suite without many of the other features of more advanced CI solutions, it’s a good fit for local use. Here I’ll show you how I use it.</p><h2 id="setting-up-sismo">Setting up Sismo</h2><p>Nowadays I don’t generally install a web server on a computer directly, preferring to use Vagrant or the dev server as appropriate, so Sismo generally doesn’t have to coexist with anything else. I normally install PHP7’s FastCGI implementation and Nginx, along with the SQLite bindings (which Sismo needs):</p><pre><code class="hljs lang-bash singleline">$ sudo apt-get install nginx php7.0-fpm php7.0-sqlite3</code></pre><p>Then we can set up our Nginx config at <code>/etc/nginx/sites-available/default</code>:</p><pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-section">server</span> {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server ipv6only=<span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attribute">root</span> /var/www/html;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">index</span> sismo.php index.html index.htm;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-attribute">server_name</span> server_domain_or_IP;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">location</span> / {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /sismo.php?<span class="hljs-variable">$query_string</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /sismo.php =<span class="hljs-number">404</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-attribute">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span>;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-attribute">fastcgi_pass</span> unix:/var/run/php/php7.0-fpm.sock;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-attribute">fastcgi_index</span> sismo.php;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SISMO_DATA_PATH <span class="hljs-string">"/home/matthew/.sismo/data"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SISMO_CONFIG_PATH <span class="hljs-string">"/home/matthew/.sismo/config.php"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-attribute">include</span> fastcgi_params;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>You’ll probably want to adjust the paths as appropriate. Then set up the required folders:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ mkdir ~/.sismo</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ mkdir ~/.sismo/data</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$ touch ~/.sismo/config.php</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>$ chmod -R a+w ~/.sismo/</td></tr></table></code></pre><p>Then, <a href="https://sismo.symfony.com/get/sismo.php">download Sismo</a> and put it in your web root (here it’s at <code>/var/www/html/sismo.php</code>).</p><p>Now, say you have a project you want to test (I’m using my <a href="https://github.com/matthewbdaly/laravel-etag-middleware">Laravel ETag middleware</a> for this example). We need to specify the projects we want to test in <code>~/.sismo/config.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$projects = <span class="hljs-keyword">array</span>();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>$notifier = <span class="hljs-keyword">new</span> Sismo\Notifier\DBusNotifier();</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Sismo\Project::setDefaultCommand(<span class="hljs-string">'if [ -f composer.json ]; then composer install; fi &amp;&amp; vendor/bin/phpunit'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>$projects[] = <span class="hljs-keyword">new</span> Sismo\GithubProject(<span class="hljs-string">'Laravel ETag Middleware'</span>, <span class="hljs-string">'/home/matthew/Projects/laravel-etag-middleware'</span>, $notifier);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">return</span> $projects;</td></tr></table></code></pre><p>Hopefully this shouldn’t be too difficult to understand. We create an array of projects, then specify a notifier (this is Linux-specific - refer to the documentation for using Growl on Mac OS). Next, we specify that by default the tests should run <code>composer install</code> followed by <code>vendor/bin/phpunit</code>. We then specify this project is a Github project - it also supports Bitbucket, or plain SSH, or the default Project, but in general it shouldn’t be a problem to use it with any repository as you can just run it against the local copy. Finally we return the list of projects.</p><p>Now, we should be able to run our tests as follows:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ php /var/www/html/sismo.php build</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Building Project <span class="hljs-string">"Laravel ETag Middleware"</span> (into <span class="hljs-string">"68a087"</span>)</td></tr></table></code></pre><p>That should be working, but it doesn’t get us anything we don’t get by running the tests ourselves. To trigger the build, we need to set up a post-commit hook for our project in <code>.git/hooks/post-commit</code>:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">#!/bin/sh</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>php /var/www/html/sismo.php --quiet --force build laravel-etag-middleware `git <span class="hljs-built_in">log</span> -1 HEAD --pretty=<span class="hljs-string">"%H"</span>` &amp;&gt;/dev/null &amp;</td></tr></table></code></pre><p>You should now be able to view your project in the Sismo web interface at <a href="http://localhost">http://localhost</a>:</p><p><img src="/static/images/sismo-screenshot.png" alt="Sismo"></p><p>Clicking on the project should take you through to its build history:</p><p><img src="/static/images/sismo-screenshot2.png" alt="Sismo project page"></p><p>From here on, it should be straightforward to add new projects as and when necessary. Because you can change the command on a per-project basis, you can quite happily use it to run tests for Python or Node.js projects as well as PHP ones, and it’s not hard to configure it.</p><p>I personally find it very useful to have something in place to run my tests on every commit like this, and while you could just use a post-commit hook for that, this approach is less obtrusive because it doesn’t force you to wait around for your test suite to finish.</p></article><article class="post"><p class="date">14th August 2017 12:40 pm</p><h1><a href="/blog/2017/08/14/profiling-your-laravel-application-with-clockwork/">Profiling Your Laravel Application With Clockwork</a></h1><p>If you’re building any non-trivial application, it’s always a good idea to profile it to find performance problems. <a href="https://github.com/barryvdh/laravel-debugbar">Laravel Debugbar</a> is the usual solution for profiling Laravel web applications, but it isn’t really much use for REST API’s or single-page web apps that consume them.</p><p>Recently I was introduced to <a href="https://github.com/itsgoingd/clockwork">Clockwork</a>, which is a server-side extension for profiling PHP applications. It’s made it a whole lot easier to track down issues like excessive numbers of queries when building an API, and as a result I’ve been able to dramatically improve the performance of an API I’ve been working on. Here I’ll show you how you can use it on a project.</p><h2 id="installing-clockwork">Installing Clockwork</h2><p>Clockwork is available via Composer:</p><pre><code class="hljs lang-bash singleline">$ composer require itsgoingd/clockwork</code></pre><p>You also need to register the service provider in <code>config/app.php</code>:</p><pre><code class="hljs lang-php singleline">   Clockwork\Support\Laravel\ClockworkServiceProvider::class,</code></pre><p>And register the middleware globally in <code>app/Http/Kernel.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">protected</span> $middleware = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>      \Clockwork\Support\Laravel\ClockworkMiddleware::class,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>]</td></tr></table></code></pre><p>Note that it only works when <code>APP_DEBUG</code> is set to true in your <code>.env</code> file. This means that you can keep it in your application without worrying about exposing too much data in production, as long as debug mode is not active on your production server (which it shouldn’t be anyway).</p><p>You will also need to install the <a href="https://chrome.google.com/webstore/detail/clockwork/dmggabnehkmmfmdffgajcflpdjlnoemp?hl=en">Chrome extension</a> in order to actually work with the returned data. Clockwork works by adding its own route to your Laravel application, and this extension makes sure that it makes the appropriate request on loading a page, and then displays the data in the dev tools.</p><p>Once it’s all installed and your application is running, open the dev tools and you should see the new <strong>Clockwork</strong> tab in there. On the left of this tab is a list of requests - if you make a request, you’ll see it added to the list. When you click on each request, you’ll see the following tabs, where applicable:</p><h2 id="request">Request</h2><p><img src="/static/images/clockwork1.png" alt="Request tab"></p><p>This is similar to Chrome’s network tab in that it shows all of the headers for a given request. It’s not anything you can’t get using Chrome’s existing dev tools, but because it doesn’t show any static content it’s arguably a bit easier to navigate.</p><h2 id="timeline">Timeline</h2><p><img src="/static/images/clockwork2.png" alt="Timeline tab"></p><p>This shows how long the response takes to respond, which can be helpful in identifying slower requests.</p><p>In addition, you can create your own events using the <code>clock()</code> helper, which will appear in the timeline, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>clock()-&gt;startEvent(<span class="hljs-string">'email_sent'</span>, <span class="hljs-string">'Email sent.'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>clock()-&gt;endEvent(<span class="hljs-string">'email_sent'</span>);</td></tr></table></code></pre><h2 id="log">Log</h2><p><img src="/static/images/clockwork8.png" alt="Log tab"></p><p>The log tab is only displayed if you use the <code>clock()</code> helper to log data. You can log text or JSON objects as appropriate:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>clock(<span class="hljs-string">'Message text.'</span>); <span class="hljs-comment">// 'Message text.' appears in Clockwork log tab</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>clock([<span class="hljs-string">'hello'</span> =&gt; <span class="hljs-string">'world'</span>]); <span class="hljs-comment">// logs json representation of the array</span></td></tr></table></code></pre><p>This is arguably more convenient than using the <code>Log</code> facade to write to the application log, since it’s kept in the browser and you can easily see what request caused what message to be logged.</p><h2 id="database">Database</h2><p><img src="/static/images/clockwork3.png" alt="Database tab"></p><p>The database tab displays details of the queries made by a request. This is useful for identifying things such as:</p><ul><li>Repeated queries that should be cached</li><li>The n+1 problem (which can be resolved by use of eager loading)</li><li>Slow queries that need to be optimised</li></ul><p>Note that if a particular endpoint does not trigger a query, this tab will not be visible.</p><h2 id="cookies">Cookies</h2><p><img src="/static/images/clockwork4.png" alt="Cookies tab"></p><p>For a REST API, you shouldn’t really have much use for cookies, but if you do, this tab lets you view the cookies set on the request.</p><h2 id="session">Session</h2><p><img src="/static/images/clockwork5.png" alt="Session tab"></p><p>As with cookies, the session isn’t normally something you’d use for an API, but this tab lets you view it.</p><h2 id="views">Views</h2><p><img src="/static/images/clockwork6.png" alt="Views tab"></p><p>This tab shows the views used on the page, and all of the data passed to them.</p><h2 id="routes">Routes</h2><p><img src="/static/images/clockwork7.png" alt="Routes tab"></p><p>This tab shows all of the routes defined within your application.</p><p>Clockwork isn’t limited to Laravel - you can also use it with Lumen, Slim 2, and CodeIgniter 2.1, and it’s possible to write your own integration for other frameworks. It’s still fundamentally browser-based, so it’s difficult to use it if your API doesn’t have at least some kind of web front end (whether that’s a single page web app or Phonegap app that consumes the API, or that the API is itself browseable and returns HTML in a web browser), but I’ve found it to be superior to Laravel Debugbar for most of what I do.</p></article><article class="post"><p class="date">17th June 2017 2:12 pm</p><h1><a href="/blog/2017/06/17/snapshot-test-your-vue-components-with-jest/">Snapshot Test Your Vue Components With Jest</a></h1><p>At work I’ve recently started using <a href="https://vuejs.org/">Vue</a> as my main front-end framework instead of Angular 1. It has a relatively shallow learning curve and has enough similarities with both React and Angular 1 that if you’re familiar with one or both of them it feels quite familiar. We’re a Laravel shop and Laravel comes out of the box with a basic scaffolding for using Vue, so not only is it the path of least resistance, but many of my colleagues knew it already and it’s used on some existing projects (one of which I’ve been helping out on this week), so it made sense to learn it. Add to that the fact that the main alternative is Angular 2, which I vehemently dislike, and learning Vue was a no-brainer.</p><p><a href="https://facebook.github.io/jest/docs/snapshot-testing.html">Snapshot tests</a> are a really useful way of making sure your user interface doesn’t change unexpectedly. Facebook introduced them to their Jest testing framework last year, and they’ve started to appear in other testing frameworks too. In their words…</p><blockquote><p>A typical snapshot test case for a mobile app renders a UI component, takes a screenshot, then compares it to a reference image stored alongside the test. The test will fail if the two images do not match: either the change is unexpected, or the screenshot needs to be updated to the new version of the UI component.</p></blockquote><p>This makes it easy to make sure than a UI component, such as a React or Vue component, does not unexpectedly change how it is rendered. In the event that it does change, it will fail the test, and it’s up to the developer to confirm whether or not that’s expected - if so they can generate a new version of the snapshot and be on their way. Without it, you’re stuck manually testing that the right HTML tags get generated, which is a chore.</p><p>Jest’s documentation is aimed pretty squarely at React, but it’s not hard to adapt it to work with Vue components. Here I’ll show you how I got it working with Vue.</p><h2 id="setting-up-a-new-project">Setting up a new project</h2><p>I used the <a href="https://github.com/vuejs/vue-cli">Vue CLI</a> boilerplate generator to set up my initial dependencies for this project. I then had to install some further packages:</p><pre><code class="hljs lang-bash singleline">$ npm install --save-dev jest babel-jest jest-vue-preprocessor</code></pre><p>After that, I had to configure Jest to work with Vue. The finished <code>package.json</code> looked like this:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"myproject"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A project"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-attr">"author"</span>: <span class="hljs-string">"Matthew Daly &lt;matthew@matthewdaly.co.uk&gt;"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  <span class="hljs-attr">"private"</span>: <span class="hljs-literal">true</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-attr">"scripts"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"node build/dev-server.js"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node build/dev-server.js"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"node build/build.js"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">"lint"</span>: <span class="hljs-string">"eslint --ext .js,.vue src"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"jest __test__/ --coverage"</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  <span class="hljs-attr">"dependencies"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">"vue"</span>: <span class="hljs-string">"^2.3.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attr">"vue-router"</span>: <span class="hljs-string">"^2.3.1"</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-attr">"devDependencies"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-attr">"autoprefixer"</span>: <span class="hljs-string">"^6.7.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-attr">"babel-core"</span>: <span class="hljs-string">"^6.22.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"babel-eslint"</span>: <span class="hljs-string">"^7.1.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attr">"babel-jest"</span>: <span class="hljs-string">"^20.0.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-attr">"babel-loader"</span>: <span class="hljs-string">"^6.2.10"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-attr">"babel-plugin-transform-runtime"</span>: <span class="hljs-string">"^6.22.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-attr">"babel-preset-env"</span>: <span class="hljs-string">"^1.3.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-attr">"babel-preset-stage-2"</span>: <span class="hljs-string">"^6.22.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-attr">"babel-register"</span>: <span class="hljs-string">"^6.22.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-attr">"chalk"</span>: <span class="hljs-string">"^1.1.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-attr">"connect-history-api-fallback"</span>: <span class="hljs-string">"^1.3.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-attr">"copy-webpack-plugin"</span>: <span class="hljs-string">"^4.0.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-attr">"css-loader"</span>: <span class="hljs-string">"^0.28.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-attr">"eslint"</span>: <span class="hljs-string">"^3.19.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-attr">"eslint-config-standard"</span>: <span class="hljs-string">"^6.2.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-attr">"eslint-friendly-formatter"</span>: <span class="hljs-string">"^2.0.7"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-attr">"eslint-loader"</span>: <span class="hljs-string">"^1.7.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-attr">"eslint-plugin-html"</span>: <span class="hljs-string">"^2.0.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-attr">"eslint-plugin-promise"</span>: <span class="hljs-string">"^3.4.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    <span class="hljs-attr">"eslint-plugin-standard"</span>: <span class="hljs-string">"^2.0.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    <span class="hljs-attr">"eventsource-polyfill"</span>: <span class="hljs-string">"^0.9.6"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.14.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-attr">"extract-text-webpack-plugin"</span>: <span class="hljs-string">"^2.0.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-attr">"file-loader"</span>: <span class="hljs-string">"^0.11.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    <span class="hljs-attr">"friendly-errors-webpack-plugin"</span>: <span class="hljs-string">"^1.1.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>    <span class="hljs-attr">"html-webpack-plugin"</span>: <span class="hljs-string">"^2.28.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    <span class="hljs-attr">"http-proxy-middleware"</span>: <span class="hljs-string">"^0.17.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-attr">"jest"</span>: <span class="hljs-string">"^20.0.4"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    <span class="hljs-attr">"jest-vue-preprocessor"</span>: <span class="hljs-string">"^1.0.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-attr">"opn"</span>: <span class="hljs-string">"^4.0.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    <span class="hljs-attr">"optimize-css-assets-webpack-plugin"</span>: <span class="hljs-string">"^1.3.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>    <span class="hljs-attr">"ora"</span>: <span class="hljs-string">"^1.2.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    <span class="hljs-attr">"rimraf"</span>: <span class="hljs-string">"^2.6.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>    <span class="hljs-attr">"semver"</span>: <span class="hljs-string">"^5.3.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-attr">"shelljs"</span>: <span class="hljs-string">"^0.7.6"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>    <span class="hljs-attr">"url-loader"</span>: <span class="hljs-string">"^0.5.8"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    <span class="hljs-attr">"vue-loader"</span>: <span class="hljs-string">"^12.1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-attr">"vue-style-loader"</span>: <span class="hljs-string">"^3.0.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    <span class="hljs-attr">"vue-template-compiler"</span>: <span class="hljs-string">"^2.3.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>    <span class="hljs-attr">"webpack"</span>: <span class="hljs-string">"^2.6.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-attr">"webpack-bundle-analyzer"</span>: <span class="hljs-string">"^2.2.1"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>    <span class="hljs-attr">"webpack-dev-middleware"</span>: <span class="hljs-string">"^1.10.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    <span class="hljs-attr">"webpack-hot-middleware"</span>: <span class="hljs-string">"^2.18.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>    <span class="hljs-attr">"webpack-merge"</span>: <span class="hljs-string">"^4.1.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>  <span class="hljs-attr">"engines"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    <span class="hljs-attr">"node"</span>: <span class="hljs-string">"&gt;= 4.0.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>    <span class="hljs-attr">"npm"</span>: <span class="hljs-string">"&gt;= 3.0.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>  <span class="hljs-attr">"browserslist"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-string">"&gt; 1%"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>    <span class="hljs-string">"last 2 versions"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>    <span class="hljs-string">"not ie &lt;= 8"</span></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>  ],</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>  <span class="hljs-attr">"jest"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>    <span class="hljs-attr">"testRegex"</span>: <span class="hljs-string">"spec.js$"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>    <span class="hljs-attr">"moduleFileExtensions"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>      <span class="hljs-string">"js"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>      <span class="hljs-string">"vue"</span></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>    ],</td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>    <span class="hljs-attr">"transform"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>      <span class="hljs-attr">"^.+\\.js$"</span>: <span class="hljs-string">"&lt;rootDir&gt;/node_modules/babel-jest"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>      <span class="hljs-attr">".*\\.(vue)$"</span>: <span class="hljs-string">"&lt;rootDir&gt;/node_modules/jest-vue-preprocessor"</span></td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>}</td></tr></table></code></pre><p>I won’t include things like the Webpack config, because that’s all generated by Vue CLI. Note that we need to tell Jest what file extensions it should work with, including <code>.vue</code>, and we need to specify the appropriate transforms for different types of files. We use <code>jest-vue-preprocessor</code> for <code>.vue</code> files and <code>babel-jest</code> for <code>.js</code> files.</p><p>With that done, we can create a basic component. We’ll assume we’re writing a simple issue tracker here, and our first component will be at <code>src/components/Issue.vue</code>:</p><pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>An Issue<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  data () {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">return</span> {}</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="undefined"></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></td></tr></table></code></pre><p>Next, we create a simple test for this component. Save this as <code>__test__/components/issue.spec.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> Issue <span class="hljs-keyword">from</span> <span class="hljs-string">'../../src/components/Issue.vue'</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">const</span> Constructor = Vue.extend(Issue)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> Constructor().$mount()</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>describe(<span class="hljs-string">'Issue'</span>, () =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  it(<span class="hljs-string">'should render'</span>, () =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    expect(vm.$el.querySelector(<span class="hljs-string">'h1'</span>).textContent).toEqual(<span class="hljs-string">'An Issue'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  it(<span class="hljs-string">'should match the snapshot'</span>, () =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    expect(vm.$el).toMatchSnapshot()</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>});</td></tr></table></code></pre><p><code>Constructor</code> is what creates our Vue component, while <code>vm</code> is our actual newly-mounted Vue component. We can refer to the HTML inside the component through <code>vm.$el</code>, so we can then work with the virtual DOM easily.</p><p>In the first test we use the more traditional method of verifying our UI component has worked as expected - we fetch an HTML tag inside it and verify that the content inside is what we expect. This is fine for a small component, but as the components get larger we’ll find it more of a chore.</p><p>The second test is much simpler and more concise. We simply assert that it matches the snapshot. Not only is that easier, but it can scale to components of any size because we don’t have to check every little element.</p><p>Let’s run our tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> PASS  __test__/components/issue.spec.js</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  Issue</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    ✓ should render (46ms)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    ✓ should match the snapshot (14ms)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>Snapshot Summary</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td> › 1 snapshot written <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Test Suites: 1 passed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Tests:       2 passed, 2 total</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Snapshots:   1 added, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Time:        8.264s</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>All files                                                  |    96.15 |       50 |      100 |       96 |                |</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr></table></code></pre><p>Note this section:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Snapshot Summary</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td> › 1 snapshot written <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite.</td></tr></table></code></pre><p>This tells us that the snapshot has been successfully written. If we run the tests again we should see that it checks against the existing snapshot:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> PASS  __test__/components/issue.spec.js</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  Issue</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    ✓ should render (40ms)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    ✓ should match the snapshot (12ms)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>Test Suites: 1 passed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>Tests:       2 passed, 2 total</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>Snapshots:   1 passed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Time:        3.554s</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>All files                                                  |    96.15 |       50 |      100 |       96 |                |</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr></table></code></pre><p>Great stuff. Now, if we make a minor change to our component, such as changing the text from <code>An Issue</code> to <code>My Issue</code>, does it pick that up?</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> FAIL  __test__/components/issue.spec.js (5.252s)</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  ● Issue › should render</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    expect(received).toEqual(expected)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    Expected value to equal:</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-string">"An Issue"</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    Received:</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      <span class="hljs-string">"My Issue"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:9:52)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  ● Issue › should match the snapshot</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    expect(value).toMatchSnapshot()</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    Received value does not match stored snapshot 1.</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    - Snapshot</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    + Received</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     &lt;div&gt;</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>       &lt;h1&gt;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    -    An Issue</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    +    My Issue</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>       &lt;/h1&gt;</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     &lt;/div&gt;</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:13:20)</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>  Issue</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    ✕ should render (48ms)</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    ✕ should match the snapshot (25ms)</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>Snapshot Summary</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td> › 1 snapshot <span class="hljs-built_in">test</span> failed <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite. Inspect your code changes or run with `npm <span class="hljs-built_in">test</span> -- -u` to update them.</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>Test Suites: 1 failed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>Tests:       2 failed, 2 total</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>Snapshots:   1 failed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>Time:        7.082s</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>All files                                                  |    96.15 |       50 |      100 |       96 |                |</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr></table></code></pre><p>Yes, we can see that it’s picked up on the change and thrown an error. Note this line:</p><pre><code class="hljs lang-bash singleline"> › 1 snapshot <span class="hljs-built_in">test</span> failed <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite. Inspect your code changes or run with `npm <span class="hljs-built_in">test</span> -- -u` to update them.</code></pre><p>Jest is telling us that our snapshot has changed, but if we expect that, we can just run <code>npm test -- -u</code> to replace the existing one with our new one. Then, our tests will pass again.</p><p>Now, this component is pretty useless. It doesn’t accept any external input whatsoever, so the response is always going to be the same. How do we test a more dynamic component? Amend the component to look like this:</p><pre><code class="hljs lang-html"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-template-variable">{{ issue.name }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-attr">props</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attr">issue</span>: <span class="hljs-built_in">Object</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  },</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  data () {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">return</span> {}</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="undefined"></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></td></tr></table></code></pre><p>We’re now passing the <code>issue</code> object into our component as a prop, and getting the name from that. That will break our test, so we need to amend it to pass through the props:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> Issue <span class="hljs-keyword">from</span> <span class="hljs-string">'../../src/components/Issue.vue'</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">const</span> Constructor = Vue.extend(Issue)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">const</span> issue = {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  <span class="hljs-attr">name</span>: <span class="hljs-string">'My Issue'</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> Constructor({</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-attr">propsData</span>: { <span class="hljs-attr">issue</span>: issue }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}).$mount()</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>describe(<span class="hljs-string">'Issue'</span>, () =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  it(<span class="hljs-string">'should render'</span>, () =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    expect(vm.$el.querySelector(<span class="hljs-string">'h1'</span>).textContent).toEqual(<span class="hljs-string">'My Issue'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  it(<span class="hljs-string">'should match the snapshot'</span>, () =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    expect(vm.$el).toMatchSnapshot()</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>});</td></tr></table></code></pre><p>Here we pass our prop into the constructor for the component. Now, let’s run the tests again:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> FAIL  __test__/components/issue.spec.js</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  ● Issue › should match the snapshot</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    expect(value).toMatchSnapshot()</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    Received value does not match stored snapshot 1.</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    - Snapshot</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    + Received</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     &lt;div&gt;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>       &lt;h1&gt;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    -    An Issue</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    +    My Issue</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>       &lt;/h1&gt;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     &lt;/div&gt;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:18:20)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>  Issue</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    ✓ should render (39ms)</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    ✕ should match the snapshot (25ms)</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Snapshot Summary</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td> › 1 snapshot <span class="hljs-built_in">test</span> failed <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite. Inspect your code changes or run with `npm <span class="hljs-built_in">test</span> -- -u` to update them.</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>Test Suites: 1 failed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>Tests:       1 failed, 1 passed, 2 total</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Snapshots:   1 failed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>Time:        3.717s</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>All files                                                  |     96.3 |       50 |      100 |    96.15 |                |</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr></table></code></pre><p>Jest has picked up on our changes and thrown an error. However, because we know the UI has changed, we’re happy with this situation, so we can tell Jest to replace the prior snapshot with <code>npm test -- -u</code> as mentioned earlier:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ npm <span class="hljs-built_in">test</span> -- -u</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>&gt; myproject@1.0.0 <span class="hljs-built_in">test</span> /home/matthew/Projects/myproject</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt; jest __test__/ --coverage <span class="hljs-string">"-u"</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> PASS  __test__/components/issue.spec.js</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  Issue</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    ✓ should render (39ms)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    ✓ should match the snapshot (14ms)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>Snapshot Summary</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td> › 1 snapshot updated <span class="hljs-keyword">in</span> 1 <span class="hljs-built_in">test</span> suite.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Test Suites: 1 passed, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Tests:       2 passed, 2 total</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>Snapshots:   1 updated, 1 total</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Time:        3.668s</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Ran all <span class="hljs-built_in">test</span> suites matching <span class="hljs-string">"__test__/"</span>.</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>All files                                                  |     96.3 |       50 |      100 |    96.15 |                |</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td> root                                                      |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>  unknown                                                  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td> root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td> root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>-----------------------------------------------------------|----------|----------|----------|----------|----------------|</td></tr></table></code></pre><p>Great, we now have a passing test suite again! That’s all we need to make sure that any regressions in the generated HTML of a component get caught.</p><p>Of course, this won’t help with the actual functionality of the component. However, Jest is pretty easy to use to write tests for the actual functionality of the application. If you prefer another testing framework, it’s possible to do the same with them, although I will leave setting them up as an exercise for the reader.</p></article><article class="post"><p class="date">15th March 2017 9:37 pm</p><h1><a href="/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/">Enforcing a Coding Standard With PHP Codesniffer</a></h1><p>We all start new projects with the best of intentions - it’ll be clean, fully tested and work perfectly. Sadly as deadlines loom, it’s all too easy to find yourself neglecting your code quality, and once it starts to degrade, getting it back becomes much harder. Many development teams try to adhere to a coding standard, but it can be hard to enforce on other people - it puts you in the uncomfortable position of nagging others all the time.</p><p>Fortunately, there’s an easy solution that doesn’t force everyone to use the same IDE. <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP CodeSniffer</a> is a useful package that lets you specify a coding standard and then validate your code against it. That way, you can set up continuous integration and use that to remind people of errors. Better still, it also allows many errors to be fixed automatically.</p><p>To use it on your PHP project, run the following command:</p><pre><code class="hljs lang-bash singleline">$ composer require --dev squizlabs/php_codesniffer</code></pre><p>As this will only ever be used in development, you should use the <code>--dev</code> flag. We also need to specify the settings for our project. This example is for a module to be used with a Laravel application and should be saved as <code>phpcs.xml</code>:</p><pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_CodeSniffer"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>The coding standard for our project.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>app<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>tests<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">exclude-pattern</span>&gt;</span>*/migrations/*<span class="hljs-tag">&lt;/<span class="hljs-name">exclude-pattern</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"np"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"PSR2"</span>/&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></tr></table></code></pre><p>Note the <code>&lt;rule /&gt;</code> tag - this specifies that this project should be validated as PSR2. Also, note the <code>&lt;file /&gt;</code> and <code>&lt;exclude-pattern /&gt;</code> tags - these specify what files should and should not be checked.</p><p>With this in place, we’re ready to run PHP CodeSniffer:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpcs</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>......................</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Time: 45ms; Memory: 6Mb</td></tr></table></code></pre><p>In this case, our code validated successfully. However, if it doesn’t, there’s an easy way to tidy it up. Just run this command:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/phpcbf</code></pre><p>That will fix many of the most common problems, and any others should be straightforward to fix.</p><p>PHP CodeSniffer makes it extremely straightforward to enforce a coding style. You can write custom rulesets or just use an existing one as you prefer, and it’s easy to fix many common problems automatically. In fact, it makes it so easy that there’s very little excuse <em>not</em> to meet the coding standard.</p></article><article class="post"><p class="date">1st March 2017 11:16 pm</p><h1><a href="/blog/2017/03/01/decorating-laravel-repositories/">Decorating Laravel Repositories</a></h1><p><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">As mentioned previously</a>, when building any nontrivial Laravel application, it’s prudent to decouple our controllers from the Eloquent ORM (or any other ORM or data source we may be using) by creating an interface, and then writing a repository that implements that interface. We can then resolve the interface to our repository, and use the repository to interact with our data source. Should we need to switch to a different implementation, we then need only create the new repository and amend how Laravel resolves that interface.</p><p>The same principle applies when it comes to caching. Database queries are typically a major bottleneck in a web application, and so it’s prudent to implement some form of caching for your queries. However, it’s a bad idea to do so in your controllers, because just as with Eloquent models, you’re tying yourself to one particular implementation and won’t be able to switch without rewriting a good chunk of your controllers, as well as possibly having to maintain large amounts of duplicate code for when a query is made in several places.</p><p>Alternatively, you could implement caching within the methods of your repository, which might make sense for smaller projects. However, it means that your repository is now dependent on both the ORM and cache you chose. If you decide you want to change your ORM but retain the same caching system, or vice versa, you’re stuck with writing a new repository to handle both, duplicating work you’ve already done.</p><p>Fortunately, there’s a more elegant solution. Using the <a href="http://designpatternsphp.readthedocs.io/en/latest/Structural/Decorator/README.html">decorator pattern</a>, we can create a second repository that implements the same interface and “wraps” the original repository. Each of its methods will call its counterpart in the original, and if appropriate cache the response. That way, our caching is implemented separately from our database interactions, and we can easily create a repository for a new data source without affecting the caching in the slightest.</p><p>Say we have the following interface for our <code>User</code> model:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>And the following repository implements that interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EloquentUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">private</span> $model;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;model = $model;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        $user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">$this</span>-&gt;model;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $user-&gt;email = $input[<span class="hljs-string">'email'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $user-&gt;name = $input[<span class="hljs-string">'name'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        $user-&gt;password = Hash::make($input[<span class="hljs-string">'password'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        $user-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">return</span> $user;</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>}</td></tr></table></code></pre><p>We might implement the following repository class to handle caching:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span> <span class="hljs-title">as</span> <span class="hljs-title">Cache</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(UserRepositoryInterface $repository, Cache $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember(<span class="hljs-string">'all'</span>, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember($id, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($id)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;flush();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create($input);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Note how each method doesn’t actually do any querying. Instead, the constructor accepts an implementation of the same interface and the cache, and we defer all interactions with the database to that implementation. Each call that queries the database is wrapped in a callback so that it’s stored in Laravel’s cache when it’s returned, without touching the original implementation. When a user is created, the users tag is flushed from the cache so that stale results don’t get served.</p><p>To actually use this implementation, we need to update our service provider so that it resolves the interface to an implementation of our decorator:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;singleton(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            $baseRepo = <span class="hljs-keyword">new</span> \App\Repositories\EloquentUserRepository(<span class="hljs-keyword">new</span> \App\User);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            $cachingRepo = <span class="hljs-keyword">new</span> \App\Repositories\Decorators\CachingUserRepository($baseRepo, <span class="hljs-keyword">$this</span>-&gt;app[<span class="hljs-string">'cache.store'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-keyword">return</span> $cachingRepo;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>}</td></tr></table></code></pre><p>We instantiate the base repository, passing it the appropriate model. Then we instantiate the decorator, passing it the base repository and the cache, and return it. Now our controllers will start using the new decorator.</p><h2 id="testing-the-decorator">Testing the decorator</h2><p>Now that we have a working decorator, how do we test it? Just as with the decorator itself, we want our tests to be completely decoupled from any particular implementation of the dependencies. If in future we’re asked to migrate the database to MongoDB, say, we’ll have plenty of work writing our new database repositories, so we don’t want to have to rewrite the tests for our decorator as well. Fortunately, using Mockery we can just mock the interface for the repository, and pass that mock into the constructor of the decorator in our test. That way we can have the mock return a known response and not involve either the database repository or the underlying models in any way.</p><p>We will also want to mock the cache itself, as this is a unit test and so as far as possible it should not be testing anything outside of the repository class. Here’s an example of how we might test the above decorator.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>\<span class="hljs-title">CachingUserRepository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * Test fetching all items</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingAll</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'all'</span>)-&gt;andReturn([]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn([]);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $items = $repository-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertCount(<span class="hljs-number">0</span>, $items);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     * Test fetching a single item</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFindOrFail</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'findOrFail'</span>)-&gt;with(<span class="hljs-number">1</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        $item = $repository-&gt;findOrFail(<span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNull($item);</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>     * Test creating a single item</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreate</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>])-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'usersUser'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'flush'</span>)-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>        $item = $repository-&gt;create([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertTrue($item);</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        m::close();</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>        <span class="hljs-keyword">parent</span>::tearDown();</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>}</td></tr></table></code></pre><p>As you can see, all we care about is that the underlying repository interface receives the correct method calls and arguments, nothing more. That way our test is fast and repository-agnositc.</p><h2 id="other-applications">Other applications</h2><p>Here I’ve used this technique to cache the queries, but that’s not the only use case for decorating a repository. For instance, you could decorate a repository to fire events when certain methods are called, and write different decorators when reusing these repositories for different applications. You could create one to log interactions with the repository, or you could use an external library to cache your queries, all without touching your existing repository. Should we need to switch back to our base repository, it’s just a matter of amending the service provider accordingly as both the decorator and the repository implement the same interface.</p><p>Creating decorators does mean you have to implement all of the interface’s methods again, but if you have a base repository that your other ones inherit from, you can easily create a base decorator in a similar fashion that wraps methods common to all the repositories, and then just implement the additional methods for each decorator as required. Also, each method is likely to be fairly limited in scope so it’s not generally too onerous.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/09/09/switching-from-vim-to-neovim/">Switching from Vim to Neovim</a></p><p><a href="/blog/2018/07/25/better-strings-in-php/">Better Strings in PHP</a></p><p><a href="/blog/2018/06/23/forcing-ssl-in-codeigniter/">Forcing SSL in Codeigniter</a></p><p><a href="/blog/2018/06/03/logging-to-the-elk-stack-with-laravel/">Logging to the ELK Stack With Laravel</a></p><p><a href="/blog/2018/05/13/full-text-search-with-mariadb/">Full-text Search With Mariadb</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/8/">Newer</a></li><li><a href="/posts/10/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>