<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/3/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">27th January 2019 11:10 pm</p><h1><a href="/blog/2019/01/27/understanding-query-objects/">Understanding Query Objects</a></h1><p>The project I’ve been maintaining for the last year has inherited a rather dubious database structure that would currently be very difficult to refactor, which also makes many queries more convoluted than they should be. At present, I’m involved in building a whole new home page, which has necessitated adding some new queries. Since some of these involve carrying out unions between several similar tables (that should have been one table, grr…), they can involve some quite large chunks for each query.</p><p>As a result, it’s made sense to break those queries down further. Since Zend 1 doesn’t have anything analogous to scopes in Eloquent, I don’t really have an easy way to break these queries up in the models (and I’m trying to get the query logic out of the models at present anyway), so I opted to make them into query objects instead, which is a pattern I hadn’t used before (but probably should have).</p><p>A query object is pretty much what it says on the tin - it’s a PHP object that executes a single, very specific query. This may seem like overkill, but it’s only really useful for the most complex and convoluted of queries. It can accept parameters, as you’d expect, and some parts of the query may be optional based on that, but fundamentally it should build and run only one single query.</p><p>In this post I’ll go through how you might create one, how it relates to the repository pattern, and when to create one.</p><h1 id="creating-a-query-object-class">Creating a query object class</h1><p>I’m a big fan of the <code>__invoke()</code> magic method in PHP. For the uninitiated, it lets you instantiate the class, and then use it in the same way you would a function, making it very useful for callbacks. This also brings some other advantages:</p><ul><li>Unlike with a function, you can create private methods to do other parts of the work, making it easier to understand the main method.</li><li>It can have a constructor, and can therefore both accept dependencies via the constructor, and be instantiated via dependency injection, simplifying setup and testing when compared to using a callback.</li><li>Since <code>__invoke()</code> is an innate part of the PHP language, it makes more sense for classes that have a single responsibility to use that method name to do that, rather than picking something like <code>handle()</code> or <code>run()</code>.</li></ul><p>As a result, my query objects generally use the <code>__invoke()</code> method to trigger the query.</p><p>Since Zend 1 is no longer supported, I won’t bother displaying how I’d write the query in that specific context. I have yet to use this pattern with Laravel, but if I did, it would look something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Queries</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">DatabaseManager</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardItems</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $db;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DatabaseManager $db)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db = $db;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(int $days = <span class="hljs-number">7</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;fooTable()</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            -&gt;union(<span class="hljs-keyword">$this</span>-&gt;barTable())</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            -&gt;whereRaw(<span class="hljs-string">'start_date &gt;= (NOW() - INTERVAL ? DAY)'</span>, [$days]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            -&gt;get();</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fooTable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;table(<span class="hljs-string">'foo'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            -&gt;where(<span class="hljs-string">'type'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'fooType'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">barTable</span><span class="hljs-params">(int $days)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;table(<span class="hljs-string">'bar'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;where(<span class="hljs-string">'type'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'barType'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>Note that we break each one of the tables we want to perform a <code>UNION</code> on into a private method. This is probably the biggest advantage of query objects - it lets you break particularly unwieldy queries up into logical steps, making them more readable. You could do this by adding private methods on a repository class too, but I’d be reluctant to add private methods to a repository that were only used in one query - to my mind, a query object is a better home for that.</p><h1 id="what-about-repositories-">What about repositories?</h1><p>I regularly use the repository pattern in my code bases, whether that’s for Laravel projects or the current Zend 1-based legacy project. It’s an ongoing effort to refactor it so that all the queries are called from repository classes, leaving the models to act as containers for the data. So how do query objects fit in here?</p><p>It’s important to note that while a repository represents all queries relating to a table, a query object represents only a single query, and so the repository should still be the place where the query is called from. However, the repository should just defer the actual querying to the query object. The relevant parts of the application structure for my current application look a bit like this:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>└── app</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ├── Queries</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    │   └── DashboardItems.php</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    └── Repositories</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        └── DashboardRepository.php</td></tr></table></code></pre><p>And the repository might call the query object as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Queries</span>\<span class="hljs-title">DashboardItems</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardRepository</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dashboardItems</span><span class="hljs-params">(int $days = <span class="hljs-number">7</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $query = <span class="hljs-keyword">new</span> DashboardItems;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> $query($days);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></tr></table></code></pre><p>At present my repositories all use static methods as I’m still in the process of migrating the queries over to the repository classes. That also means I can’t easily use dependency injection. For a Laravel application, a similar call might look like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Queries</span>\<span class="hljs-title">DashboardItems</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardRepository</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $dashboardQuery;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DashboardItems $dashboardQuery)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;dashboardQuery = $dashboardQuery;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dashboardItems</span><span class="hljs-params">(int $days = <span class="hljs-number">7</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;dashboardQuery($days);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>The only real difference is that we can instantiate the query object out of the container, simplifying setup.</p><h1 id="when-to-use-query-objects">When to use query objects</h1><p>I think it probably goes without saying, but it should be a rare query that actually needs to be implemented as a query object, especially if you’re using an ORM like Eloquent that provides features like scopes, and as yet I only have two using this pattern, as well as two others that were implemented as “reporter” classes, but could be query objects instead. So far, my experience has been that the sort of queries that are large enough to be worth considering include:</p><ul><li>Queries that generate reports, particularly if they have various options</li><li>Queries that use unions, as in the above example, since it makes sense to use a private method to fetch each table</li><li>Queries with multiple complex joins</li></ul><p>Smaller queries will typically fit happily inside a single method in your repository classes. If that’s the case, then they can live there without trouble. However, if you have a query that’s becoming too big to fit inside a single method, rather than adding private methods to your repository class, it may make more sense to refactor it out into a query object in its own right. You can still call it via the same method on your repository class, but the repository can just defer to the query object. As I usually use decorators to cache the responses from my repository classes anyway, then it makes sense to stick with this approach to keep caching consistent too.</p><p>Query objects only really offer any value for particularly large queries. However, they can be invaluable in those circumstances. By enabling you to break those big queries up into a series of steps, they help make them easier to understand.</p></article><article class="post"><p class="date">13th January 2019 6:50 pm</p><h1><a href="/blog/2019/01/13/writing-a-custom-sniff-for-php-codesniffer/">Writing a Custom Sniff for PHP Codesniffer</a></h1><p>I’ve recently come around to the idea that <a href="https://matthiasnoback.nl/2018/09/final-classes-by-default-why/">in PHP all classes should be final by default</a>, and have started doing so as a matter of course. However, when you start doing something like this it’s easy to miss a few files that haven’t been updated, or forget to do it, so I wanted a way to detect PHP classes that are not set as either abstract or final, and if possible, set them as final automatically. I’ve mentioned before that I use PHP CodeSniffer extensively, and that has the capability to both find and resolve deviations from a coding style, so last night I started looking into the possibility of creating a coding standard for this. It took a little work to understand how to do this so I thought I’d use this sniff as a simple example.</p><p>The first part is to set out the directory structure. There’s a very specific layout you have to follow for PHP CodeSniffer:</p><ul><li>The folder for the standard must have the name of the standard, and be in the source folder set by Composer (in this case, <code>src/AbstractOrFinalClassesOnly</code>.</li><li>This folder must contain a <code>ruleset.xml</code> file defining the name and description of the standard, and any other required content.</li><li>Any defined sniffs must be in a <code>Sniffs</code> folder.</li></ul><p>The <code>ruleset.xml</code> file was fairly simple in this case, as this is a very simple standard:</p><pre><code class="hljs lang-xml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">ruleset</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"AbstractOrFinalClassesOnly"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Checks all classes are marked as either abstract or final.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">ruleset</span>&gt;</span></td></tr></table></code></pre><p>The sniff is intended to do the following:</p><ul><li>Check all classes have either the <code>final</code> keyword or the <code>abstract</code> keyword set</li><li>When running the fixer, make all classes without the <code>abstract</code> keyword final</li></ul><p>First of all, our class must implement the interface <code>PHP_CodeSniffer\Sniffs\Sniff</code>, which requires the following methods:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span>: <span class="hljs-title">array</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">(File $file, $position)</span>: <span class="hljs-title">void</span></span>;</td></tr></table></code></pre><p>Note that <code>File</code> here is an instance of <code>PHP_CodeSniffer\Files\File</code>. The first method registers the code the sniff should operate on. Here we’re only interested in classes, so we return an array containing <code>T_CLASS</code>. This is defined in the <a href="https://secure.php.net/manual/en/tokens.php">list of parser tokens used by PHP</a>, and represents classes and objects:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span>: <span class="hljs-title">array</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">return</span> [T_CLASS];</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr></table></code></pre><p>For the <code>process()</code> method, we receive two arguments, the file itself, and the position. We need to keep a record of the tokens we check for, so we do so in a private property:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">private</span> $tokens = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        T_ABSTRACT,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        T_FINAL,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    ];</td></tr></table></code></pre><p>Then, we need to find the error:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>        <span class="hljs-keyword">if</span> (!$file-&gt;findPrevious(<span class="hljs-keyword">$this</span>-&gt;tokens, $position)) {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>            $file-&gt;addFixableError(</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>                <span class="hljs-string">'All classes should be declared using either the "abstract" or "final" keyword'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>                $position - <span class="hljs-number">1</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>                <span class="hljs-keyword">self</span>::class</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        }</td></tr></table></code></pre><p>We use <code>$file</code> to get the token before <code>class</code>, and pass the <code>$tokens</code> property as a list of acceptable values. If the preceding token is not either <code>abstract</code> or <code>final</code>, we add a fixable error. The first argument is the string error message, the second is the location, and the third is the class of the sniff that has failed.</p><p>That will catch the issue, but won’t actually fix it. To do that, we need to get the fixer from the file object, and call its <code>addContent()</code> method to add the <code>final</code> keyword. We amend <code>process()</code> to extract the fixer, add it as a property, and then call the <code>fix()</code> method when we come across a fixable error:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">(File $file, $position)</span>: <span class="hljs-title">void</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fixer = $file-&gt;fixer;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;position = $position;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">if</span> (!$file-&gt;findPrevious(<span class="hljs-keyword">$this</span>-&gt;tokens, $position)) {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            $file-&gt;addFixableError(</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>                <span class="hljs-string">'All classes should be declared using either the "abstract" or "final" keyword'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                $position - <span class="hljs-number">1</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-keyword">self</span>::class</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">$this</span>-&gt;fix();</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr></table></code></pre><p>Then we define the <code>fix()</code> method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fix</span><span class="hljs-params">()</span>: <span class="hljs-title">void</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fixer-&gt;addContent(<span class="hljs-keyword">$this</span>-&gt;position - <span class="hljs-number">1</span>, <span class="hljs-string">'final '</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr></table></code></pre><p>Here’s the finished class:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">AbstractOrFinalClassesOnly</span>\<span class="hljs-title">Sniffs</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PHP_CodeSniffer</span>\<span class="hljs-title">Sniffs</span>\<span class="hljs-title">Sniff</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PHP_CodeSniffer</span>\<span class="hljs-title">Files</span>\<span class="hljs-title">File</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td> * Sniff for catching classes not marked as abstract or final</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractOrFinalSniff</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Sniff</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">private</span> $tokens = [</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        T_ABSTRACT,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        T_FINAL,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">private</span> $fixer;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">private</span> $position;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span>: <span class="hljs-title">array</span></span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">return</span> [T_CLASS];</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">(File $file, $position)</span>: <span class="hljs-title">void</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fixer = $file-&gt;fixer;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;position = $position;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">if</span> (!$file-&gt;findPrevious(<span class="hljs-keyword">$this</span>-&gt;tokens, $position)) {</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            $file-&gt;addFixableError(</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-string">'All classes should be declared using either the "abstract" or "final" keyword'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>                $position - <span class="hljs-number">1</span>,</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>                <span class="hljs-keyword">self</span>::class</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>            <span class="hljs-keyword">$this</span>-&gt;fix();</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fix</span><span class="hljs-params">()</span>: <span class="hljs-title">void</span></span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fixer-&gt;addContent(<span class="hljs-keyword">$this</span>-&gt;position - <span class="hljs-number">1</span>, <span class="hljs-string">'final '</span>);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>}</td></tr></table></code></pre><p>I’ve made the resulting standard <a href="https://github.com/matthewbdaly/abstract-or-final-sniff">available via Github</a>.</p><p>This is a bit rough and ready and I’ll probably refactor it a bit when I have time. In addition, it’s not quite displaying the behaviour I want as it should, since ideally it should only be looking for the <code>abstract</code> and <code>final</code> keywords in classes that implement an interface. However, it’s proven fairly easy to create this sniff, except for the fact I had to go rooting around various tutorials that weren’t all that clear. Hopefully this example is a bit simpler and easier to follow.</p></article><article class="post"><p class="date">3rd January 2019 11:55 pm</p><h1><a href="/blog/2019/01/03/you-dont-need-that-module-package/">You Don&#x27;t Need That Module Package</a></h1><p>Lately I’ve seen a number of Laravel packages being posted on places like Reddit that offer ways to make your project more modular by letting you break their classes out of the usual structure and place them in a separate folder called something like <code>packages/</code> or <code>modules/</code>. However, these packages are completely redundant, and it requires very little work to achieve the same thing with Composer alone. In addition, much of it is not specific to Laravel and can also be applied to any other framework that uses Composer.</p><p>There are two main approaches I’m aware of - keeping it in a single project, and moving the modules to separate Composer packages.</p><h1 id="single-project">Single project</h1><p>Suppose we have a brand new Laravel project with the namespace left as the default <code>App</code>. This is what the <code>autoload</code> section of the <code>composer.json</code> file will look like:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "autoload": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "psr-4": {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            "App\\": "app/"</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        },</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        "classmap": [</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            "database/seeds",</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            "database/factories"</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        ]</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    },</td></tr></table></code></pre><p>Composer allows for numerous ways to autoload classes and you can add additional namespaces as you wish. Probably the best approach is to use PSR-4 autoloading, as in this example:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    "autoload": {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        "psr-4": {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            "App\\": "app/",</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            "Packages\\": "packages"</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        },</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        "classmap": [</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            "database/seeds",</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            "database/factories"</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        ]</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    },</td></tr></table></code></pre><p>Now, if you put the model <code>Post.php</code> in the folder, <code>packages/Blog/Models/</code>, then this will map to the namespace <code>Packages\Blog\Models\Post</code>, and if you set the namespace to this in the file, and run <code>composer dump-autoload</code>, you should be able to import it from that namespace without trouble. As with the <code>App\</code> namespace, because it’s using PSR-4 you’re only specifying the top-level namespace and the folders and files underneath have to mirror the namespace, so for instance, <code>Packages\Foo\Bar</code> maps to <code>packages/Foo/Bar.php</code>. If for some reason PSR-4 autoloading doesn’t map well to what you want to do, then there are other methods you can use - refer to the <a href="https://getcomposer.org/doc/04-schema.md#autoload">relevant section of the Composer documentation</a> for the other methods available.</p><p>The controllers are the toughest part, because by default Laravel’s routing works on the assumption that the controllers are all under the <code>App\Http\Controllers</code> namespace, so you can shorten the namespace used. There are two ways around this I’m aware of. One is to specify the full namespace when referencing each controller:</p><pre><code class="hljs lang-php singleline">Route::get(<span class="hljs-string">'/'</span>, <span class="hljs-string">'\App\Modules\Http\Controllers\FooController@index'</span>);</code></pre><p>The other option is to update the <code>RouteServiceProvider.php</code>‘s namespace property. It defaults to this:</p><pre><code class="hljs lang-php singleline"><span class="hljs-keyword">protected</span> $namespace = <span class="hljs-string">'App\Http\Controllers'</span>;</code></pre><p>If there’s a more convenient namespace you want to place all your controllers under, then you can replace this, and it will become the default namespace applied in your route files.</p><p>Other application components such as migrations, routes and views can be loaded from a service provider very easily. Just create a service provider for your module, register it in <code>config/app.php</code>, and set up the <code>boot()</code> method to load whichever components you want from the appropriate place, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>        <span class="hljs-keyword">$this</span>-&gt;loadMigrationsFrom(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../database/migrations'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-keyword">$this</span>-&gt;loadRoutesFrom(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../routes.php'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;loadViewsFrom(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../views'</span>, <span class="hljs-string">'comments'</span>);</td></tr></table></code></pre><h1 id="separate-packages">Separate packages</h1><p>The above approach works particularly well in the initial stages of a project, when you may need to jump around a lot to edit different parts of the project. However, later on, once many parts of the project have stabilised, it may make more sense to pull the modules out into separate repositories and use Composer to pull them in as dependencies, using its support for private repositories. I’ve also often taken this approach right from the start without issue.</p><p>This approach has a number of advantages. It makes it easier to reuse parts of the project in other projects if need be. Also, if you put your tests in the packages containing the components they test, it means that rather than running one monolithic test suite for the whole project, you can instead run each module’s tests each time you change it, and limit the test suite of the main project to those integration and acceptance tests that verify the whole thing, along with any unit tests for code that remains in the main repository, resulting in quicker test runs.</p><p>Don’t get me wrong, making your code more modular is definitely a good thing and I’m wholly in favour of it. However, it only takes a little knowledge of Composer to be able to achieve this without any third party package at all, which is good because you’re no longer dependent on a package that may at any time fall behind the curve or be abandoned.</p></article><article class="post"><p class="date">2nd January 2019 11:00 pm</p><h1><a href="/blog/2019/01/02/why-bad-code-is-bad/">Why Bad Code Is Bad</a></h1><p>This may sound a little trite, but why is it bad to write bad code?</p><p>Suppose you’re a client, or a line manager for a team of developers. You work with developers regularly, but when they say that a code base is bad, what are the consequences of that, and how can you justify spending time and money to fix it? I’ve often heard the refrain “If it works, it doesn’t matter”, which may have a grain of truth, but is somewhat disingenuous. In this post, I’ll explain some of the consequences when your code base is bad. It can be hard to put a definitive price tag on the costs associated with delivering bad code, but this should give some idea of the sort of issues you should take into account.</p><h1 id="bad-code-kills-developer-productivity">Bad code kills developer productivity</h1><p>Bad code is harder to understand, navigate and reason about than good code. Developers are not superhuman, and we can only hold so much in our heads at one time, which is why many of the principles behind a clean and maintainable code base can essentially be boiled down to “break it into bite-sized chunks so developers can understand each one in isolation before seeing how they fit together”.</p><p>If one particular class or function gets too big and starts doing too much, it quickly becomes very, very hard to get your head around what that code does. Developers typically have to build a mental model of how a class or function works before they can use it effectively, and the smaller and simpler you can keep each unit of code, the less time and effort it takes to do so. The mark of a skilled developer is not the complexity of their code bases, but their simplicity - they’ve learned to make their code as small, simple, and readable as possible. A clean and well laid-out code base makes it easy for developers to get into the mental state called “flow” that is significantly more productive.</p><p>In addition, if an application doesn’t conform to accepted conventions in some way, such as using inappropriate HTTP verbs (eg <code>GET</code> to change the state of something), then quite apart from the fact that it won’t play well with proxy servers, it imposes an additional mental load on developers by forcing them to drop a reasonable set of assumptions about how the application works. If the application used the correct HTTP verbs, experienced developers would know without being told that to create a new report, you’d send a <code>POST</code> request to the <code>reports</code> API endpoint.</p><p>During the initial stages of a project, functionality can be delivered quite quickly, but if the code quality is poor, then over time developer velocity can decrease. Ensuring a higher quality code base helps to maintain velocity at a consistent level as it gets bigger. This also means estimates will be more accurate, so if you quote a given number of hours for a feature, you’re more likely to deliver inside that number of hours.</p><h1 id="bad-code-is-bad-for-developer-welfare">Bad code is bad for developer welfare</h1><p>A code base that’s repetitive, badly organised, overly complex and hard to read is a recipe for stressed developers, making burnout more likely. If a developer suffers burnout, their productivity will drop substantially.</p><p>In the longer term, if developer burnout isn’t managed correctly, it could easily increase developer turnover as stressed developers quit. It’s also harder to recruit new developers if they’re faced with the prospect of dealing with a messy, stressful code base.</p><h1 id="bad-code-hampers-your-ability-to-pivot">Bad code hampers your ability to pivot</h1><p>If the quality of your code base is poor, it can mean that if functionality needs to be changed or added, then more work is involved. Repetitive code can mean something has to be updated in more than one place, and if it becomes too onerous, it can make it too time-consuming or expensive to justify the changes.</p><h1 id="bad-code-may-threaten-the-long-term-viability-of-your-project">Bad code may threaten the long-term viability of your project</h1><p>One thing that is certain in our industry is that things change. Libraries, languages and frameworks are constantly being updated, and sometimes there will be potentially breaking changes to some of these. On occasion, a library or framework will be discontinued, making it necessary to migrate to a replacement.</p><p>Bad code is often tightly coupled to a particular framework or library, and sometimes even to a particular version, making it harder to migrate if it becomes necessary. If a project was written with a language or framework version that had a serious issue, and was too tightly coupled to migrate to a newer version, it might be too risky to keep it running, or it might be necessary to run an insecure application in spite of the risks it posed.</p><h1 id="bad-code-is-more-brittle">Bad code is more brittle</h1><p>A poor code base will break, a lot, and often in ways that are clearly visible to end users. Duplicate code makes it easy to miss cases where something needs to be updated in more than one place, and if the code base lacks tests, a serious error may not be noticed for a long time, especially if it’s something comparatively subtle.</p><h1 id="bad-code-is-hard-if-not-impossible-to-write-automated-tests-for">Bad code is hard, if not impossible, to write automated tests for</h1><p>If a particular class or function does too much, it becomes <em>much</em> harder to write automated tests for it because there are more variables going in and more expected outcomes. A sufficiently messy code base may only really be testable by automating the browser, which tends to be very slow and brittle, making test-driven development impractical. Manual testing is no substitute for a proper suite of automated tests, since it’s slower, less consistent and not repeatable in the same way, and it’s only sufficient by itself for the most trivial of web apps.</p><h1 id="bad-code-is-often-insecure">Bad code is often insecure</h1><p>A bad code base may inadvertently expose user’s data, or be at risk from all kinds of attacks such as cross-site scripting and SQL injection attacks that can also potentially expose too much data.</p><p>For any business with EU-based users, the risks of exposing user’s data are very serious. Under the GDPR, there’s a potential fine of up to &euro;20 million, or 4% of turnover. That’s potentially an existential risk for many companies.</p><p>In addition, a bad code base is often more vulnerable to denial-of-service attacks. If it has poor or no caching, excessive queries, or inefficient queries, then every time a page loads it will carry out more queries than a more optimised site would. Given the same server specs, the inefficient site will be overwhelmed quicker than the efficient one.</p><h1 id="summary">Summary</h1><p>It’s all too easy to focus solely on delivering a working product and not worry about the quality of the code base when time spent cleaning it up doesn’t pay the bills, and it can be hard to justify the cost of cleaning it up later to clients.</p><p>There are tools you can use to help keep up code quality, such as linters and static analysers, and it’s never a bad idea to investigate the ones available for the language(s) you work in. For best results they should form part of your continuous integration pipeline, so you can monitor changes over time and prompt developers who check in problematic code to fix the issues. Code reviews are another good way to avoid bad code, since they allow developers to find problematic code and offer more elegant solutions.</p><p>I’m not suggesting that a code base that has a few warts has no value, or that you should sink huge amounts of developer time into refactoring messy code when money is tight, as commercial concerns do have to come first. But a bad code base does cause serious issues that have financial implications, and it’s prudent to recognise the problems it could cause, and take action to resolve them, or better yet, prevent them occurring in the first place.</p></article><article class="post"><p class="date">27th December 2018 6:37 pm</p><h1><a href="/blog/2018/12/27/improving-search-in-vim-and-neovim-with-fzf-and-ripgrep/">Improving Search in Vim and Neovim With FZF and Ripgrep</a></h1><p>A while back I was asked to make some changes to a legacy project that was still using Subversion. This was troublesome because my usual method of searching in files is to use Tim Pope’s Fugitive Vim plugin as a frontend for <code>git grep</code>, and so it would be harder than usual to navigate the project. I therefore started looking around for alternative search systems, and one combination that kept on coming up was FZF and Ripgrep, so I decided to give them a try. FZF is a fuzzy file finder, written in Go, while Ripgrep is an extremely fast grep, written in Rust, that respects gitignore rules by default. Both have proven so useful they’re now a permanent part of my setup.</p><p>On Mac OS X, both are available via Homebrew, so they’re easy to install. On Ubuntu, Ripgrep is in the repositories, but FZF isn’t, so it was necessary to install it in my home directory. There’s a <a href="https://github.com/junegunn/fzf.vim">Vim plugin for FZF and Ripgrep integration</a>, which, since I use vim-plugged, I could install by adding the following to my <code>init.vim</code>, then running <code>PlugUpdate</code> from Neovim:</p><pre><code class="hljs lang-viml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-string">" Search</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Plug '~/.fzf'</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Plug 'junegunn/fzf.vim'</td></tr></table></code></pre><p>The plugin exposes a number of commands that are very useful, and I’ll go through the ones I use most often:</p><ul><li><code>:Files</code> is for finding files by name. I used to use Ctrl-P for this, but FZF is so much better and quicker that I ditched Ctrl-P almost immediately (though you can map <code>:Files</code> to it if you want to use the same key).</li><li><code>:Rg</code> uses Ripgrep to search for content in files, so you can search for a specific string. This makes it an excellent replacement for the <code>Ggrep</code> command from Fugitive.</li><li><code>:Snippets</code> works with Ultisnips to provide a filterable list of available snippets you can insert, making it much more useful</li><li><code>:Tags</code> allows you to filter and search tags in the project as a whole</li><li><code>:BTags</code> does the same, but solely in the current buffer</li><li><code>:Lines</code> allows you to find lines in the project and navigate to them.</li><li><code>:BLines</code> does the same, but solely in the current buffer.</li></ul><p>In addition to being useful in Neovim, FZF can also be helpful in Bash. You can use <code>Ctrl-T</code> to find file paths, and it enhances the standard <code>Ctrl-R</code> history search, making it faster and more easily navigable. The performance of both is also excellent - they work very fast, even on the very large legacy project I maintain, or on slower machines, and I never find myself waiting for them to finish. Both tools have quickly become an indispensible part of my workflow.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/09/22/storing-wordpress-configuration-in-environment-variables/">Storing Wordpress Configuration in Environment Variables</a></p><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><p><a href="/blog/2019/07/28/skipping-environment-specific-phpunit-tests/">Skipping Environment Specific Phpunit Tests</a></p><p><a href="/blog/2019/06/19/powering-up-git-bisect-with-the-run-command/">Powering Up Git Bisect With the Run Command</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/2/">Newer</a></li><li class="page-item"><a href="/posts/4/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>