<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/3/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">21st September 2019 11:30 am</p><h1><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></h1><p>Laravel Mix is a really convenient front end scaffold, and not just in the context of a Laravel application. Last year, I added it to a legacy application I maintain, with positive results, and I’m including it in a CMS I’m working on.</p><p>However, I’ve always had issues trying to implement versioning outside a Laravel application. I’ve used the timestamp technique described <a href="https://matthewdaly.co.uk/blog/2016/11/26/easy-static-asset-versioning-in-php/">here</a> a lot in the past, but nowadays I do most of my work in a Lando container, and I’ve had a lot of issues with timestamp changes not being picked up, forcing me to restart my container regularly when working on front-end assets. Switching to using Mix versioning seemed like a good way to resolve that issue, but of course the <code>mix()</code> helper isn’t available elsewhere.</p><p>Fortunately, its not all that hard to implement your own solution. Under the bonnet, Mix versioning works as follows:</p><ul><li>The build generates an array of compiled static assets, with the key being the path to the asset, and the value being the path with a query string appended, and then saves it as <code>mix-manifest.json</code></li><li>The <code>mix()</code> helper loads the <code>mix-manifest.json</code> file, converts it to JSON, fetches the array entry by path, and then returns the appropriate value for passing back from the helper</li></ul><p>With that in mind, I wrote the following Twig filter to handle assets versioned with Mix:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Project</span>\<span class="hljs-title">Core</span>\<span class="hljs-title">Views</span>\<span class="hljs-title">Filters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Exception</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mix</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(string $path)</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $manifest = json_decode(file_get_contents(<span class="hljs-string">'mix-manifest.json'</span>), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">if</span> (! array_key_exists(<span class="hljs-string">"/"</span> . $path, $manifest)) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">"Unable to locate Mix file: {$path}"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">if</span> (!file_exists($path)) {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-string">'Included file does not exist'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> $manifest[<span class="hljs-string">"/"</span> . $path];</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>}</td></tr></table></code></pre><p>This works on the basis that the web root is set in the <code>public/</code> folder, and that the compiled CSS and Javascript files are placed there - if that’s not the case you may need to adapt this accordingly.</p><p>You also need to add the <code>version()</code> call to your <code>webpack.mix.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">const</span> mix = <span class="hljs-built_in">require</span>(<span class="hljs-string">'laravel-mix'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">/*</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td> |--------------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td> | Mix Asset Management</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> |--------------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> |</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> | Mix provides a clean, fluent API for defining some Webpack build steps</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td> | for your Laravel application. By default, we are compiling the Sass</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td> | file for the application as well as bundling up all the JS files.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> |</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>mix</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  .setPublicPath(<span class="hljs-string">'public/'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  .js(<span class="hljs-string">'resources/js/app.js'</span>, <span class="hljs-string">'public/js'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  .sass(<span class="hljs-string">'resources/sass/app.scss'</span>, <span class="hljs-string">'public/css'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  .version();</td></tr></table></code></pre><p>Then, when you instantiate Twig, you can add the new filter using something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$twig = <span class="hljs-keyword">new</span> Environment($container-&gt;get(<span class="hljs-string">'Twig\Loader\FilesystemLoader'</span>), $config);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$mix = $container-&gt;get(<span class="hljs-string">'Project\Core\Views\Filters\Mix'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$twig-&gt;addFilter(<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'mix'</span>, $mix));</td></tr></table></code></pre><p>Now, the filter should be usable in your Twig views as shown:</p><pre><code class="hljs lang-twig"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-meta-keyword">html</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ 'css/app.css'| mix }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span> /&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-template-variable">{{ title }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-keyword">include</span></span> 'header.html' %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-keyword">block</span></span> body %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-keyword">endblock</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ 'js/app.js'| mix }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></td></tr></table></code></pre><p>If you’re using a different framework or templating system, there should be a way to create helpers, and it should be possible to implement this technique fairly easily. I was able to do so in the context of a legacy Zend application, so it should be possible with other legacy frameworks like CodeIgniter.</p></article><article class="post"><p class="date">7th September 2019 8:16 pm</p><h1><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></h1><p>Sometimes when writing a test, you come across a situation where you need to set a private field that’s not accessible through any existing route. For instance, I’ve been working with Doctrine a bit lately, and since the ID on an entity is generated automatically, it should not be possible to change it via a setter, but at the same time, we sometimes have the need to set it in a test.</p><p>Fortunately, there is a way to do that. Using PHP’s reflection API, you can temporarily mark a property on an object as accessible, so as to be able to set it without either passing it to the constructor or creating a setter method that will only ever be used by the test. We first create a <code>ReflectionClass</code> instance from the object, then get the property. We mark it as accessible, and then set the value on the instance, as shown below:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Project</span>\<span class="hljs-title">Document</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetId</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $doc = <span class="hljs-keyword">new</span> Document();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $reflect = <span class="hljs-keyword">new</span> ReflectionClass($doc);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $id = $reflect-&gt;getProperty(<span class="hljs-string">'id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $id-&gt;setAccessible(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $id-&gt;setValue($doc, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">1</span>, $doc-&gt;getId());</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>If you’re likely to need this in more than one place, you may want to pull this functionality out into a trait for reuse:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Traits</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">trait</span> SetsPrivateProperties</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Sets a private property</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> mixed $object</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@param</span> string $property</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@param</span> mixed $value</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPrivateProperty</span><span class="hljs-params">($object, string $property, $value)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $reflect = <span class="hljs-keyword">new</span> ReflectionClass($object);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $prop = $reflect-&gt;getProperty($property);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $prop-&gt;setAccessible(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $prop-&gt;setValue($object, $value);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $prop-&gt;setAccessible(<span class="hljs-keyword">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Then your test can be simplified as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Project</span>\<span class="hljs-title">Document</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Traits</span>\<span class="hljs-title">SetsPrivateProperties</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">SetsPrivateProperties</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetId</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $doc = <span class="hljs-keyword">new</span> Document();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setPrivateProperty($doc, <span class="hljs-string">'id'</span>, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">1</span>, $doc-&gt;getId());</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>While this is a slightly contrived and limited example, and this situation is quite rare, I’ve found it to be a useful technique under certain circumstances.</p></article><article class="post"><p class="date">28th July 2019 8:55 pm</p><h1><a href="/blog/2019/07/28/skipping-environment-specific-phpunit-tests/">Skipping Environment Specific Phpunit Tests</a></h1><p>If you’re doing client work, you don’t generally have to worry too much about working with any services other than those that will be installed in your production environment. For instance, if you’re using Memcached as your cache backend, you needn’t go to the trouble of checking that it works with Redis too unless the project actively switches. However, for more general purpose software that may be deployed to a variety of different environments, you may have to test it in all of those environments, which can be a chore.</p><p>Lately I’ve been working on a micro CMS for a personal project, and ran into a bit of an issue. This CMS uses the Stash caching library, and I wanted it to actively support all of the cache backends Stash provides. The CMS is configured using YAML, and I’d written a factory class that takes in the cache configuration and returns an adapter. The problem was that there are three adapters that require additional software to be installed, namely the APC, Redis and Memcached adapters. Installing all the packages to use all three of the adapters is onerous, and while it’s a good idea to test them all, it’s generally not worth the bother of adding all of them to your local development environment where you need your tests to run as fast as possible. Instead you’re better off deferring those tests that require additional dependencies to your continuous integration server, which can afford to be a lot slower.</p><p>Fortunately, PHPUnit allows you to mark a test as skipped by calling <code>markTestSkipped()</code>. In the past I’ve used this or the similar <code>markTestIncomplete()</code> method when a test wasn’t finished, but it’s also useful for skipping tests based on the environment. We can either test for the presence of the dependency and mark the test as skipped if it’s not present, or set the test up inside a try…catch block and call <code>markTestSkipped()</code> if the test throws an exception due to a missing dependency, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Factories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Factories</span>\<span class="hljs-title">CacheFactory</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Stash</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">RuntimeException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheFactoryTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRedis</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $factory = <span class="hljs-keyword">new</span> CacheFactory;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">try</span> {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            $pool = $factory-&gt;make([</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'redis'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>                <span class="hljs-string">'servers'</span> =&gt; [[</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>                    <span class="hljs-string">'127.0.0.1'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>                    <span class="hljs-string">'6379'</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                ]]</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            ]);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        } <span class="hljs-keyword">catch</span> (RuntimeException $e) {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-keyword">$this</span>-&gt;markTestSkipped(<span class="hljs-string">'Dependency not installed'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(<span class="hljs-string">'Stash\Pool'</span>, $pool);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(<span class="hljs-string">'Stash\Driver\Redis'</span>, $pool-&gt;getDriver());</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>}</td></tr></table></code></pre><p>As a general rule of thumb, when running your tests locally, it’s more important that your test suite run quickly than provide 100% coverage. Tests that are slower or require multiple services to be installed can still be run by your continuous integration server, which can afford to be slower since it’s not a blocker in the same way. In addition, I’m only ever really interested in coverage stats on the CI server, since enabling that slows PHPUnit down a lot, so since coverage is a non-issue locally we can happily leave covering that dependency to our CI server. In this case, the project is hosted on Github and uses Travis CI for running the tests and Coveralls for recording coverage, so we can leave the full test suite to be run on Travis CI, ensuring full coverage, while skipping those tests that require Redis, Memcached or APC locally.</p><p>Having a comprehensive test suite, and running it regularly during development, is important, but that doesn’t mean it’s compulsory you run every test regularly. In a case like this, where there are multiple adapters for the same basic functionality, you can often afford to avoid running those that test adapters with more exacting requirements.</p></article><article class="post"><p class="date">19th June 2019 10:00 pm</p><h1><a href="/blog/2019/06/19/powering-up-git-bisect-with-the-run-command/">Powering Up Git Bisect With the Run Command</a></h1><p>The <code>bisect</code> command in Git can be very useful when trying to catch any regressions. If you know that a bug was not present at some point in the past, and now is, you can often use <code>bisect</code> to track it down quickly and easily.</p><p>The basic functionality is fairly simple. You start the process by tracking down a known “good” commit in the past, and a known “bad” commit, which will usually be the head of the branch. Then, you start bisecting:</p><pre><code class="hljs lang-bash singleline">$ git bisect start</code></pre><p>You then specify your bad commit:</p><pre><code class="hljs lang-bash singleline">$ git bisect bad HEAD</code></pre><p>And your good commit</p><pre><code class="hljs lang-bash singleline">$ git bisect good fe0616f0cd523455a0e5bc536c09bfb1d8fd0c3f</code></pre><p>And it will then step through the commits in between. Note that not every commit is loaded - it instead picks a commit between those you entered, and from there quickly narrows down the range. For each commit, you test it and mark it as good or bad with <code>git bisect good</code> or <code>git bisect bad</code> as appropriate. Once it’s tracked down the commit that introduced the problem, it will tell you what that commit was, making any remaining debugging much easier. There are situations that are more difficult to handle, such as when database migrations have been created and run in the intervening period, but for many cases <code>bisect</code> can be a very valuable tool.</p><p>However, it can still be a chore to step through those commits manually. Fortunately, in situations where you can produce some sort of script to determine if the issue is present or not, there’s an easy way to automate it with the <code>bisect run</code> command.</p><p>One of the personal projects I have on the go right now is a micro-CMS intended primarily for brochure-style sites. It includes an AJAX search that uses Fuse.js on the front end, the index for which is generated by a console task built on top of the Symfony Console component. Recently I noticed that although the unit tests still passed, the console task to generate the index no longer worked as expected due to an issue with Flysystem. Since it threw an error in the console, that could be used as input to <code>git bisect</code>. I was therefore able to automate the process of finding the bug by running this command:</p><pre><code class="hljs lang-bash singleline">$ git bisect run php console index:generate</code></pre><p>This was pretty rare in that it was an ideal situation - the problem was the console command throwing an explicit error, which was perfect as input to <code>bisect run</code>. A more likely scenario in many cases is that if you want to automate catching the error, you’ll need to create an automated test to reproduce that error, and run that test with <code>git bisect run</code>. Given that TDD already recommends writing a test to reproduce a bug before fixing it, it’s prudent to write the test first, then use it to run the bisect command, before fixing the bug and committing both the fix and the new test, so as to not only minimise the manual work required, but also ensure it won’t crop up again.</p><p>Certain classes of issues are more difficult to automate in this way - for example, visual regressions in CSS. If you’re using a library like React or Vue, snapshot testing may be a good way to automate the bisect process for HTML rendered by components, or you could try the approach I’ve mentioned before for snapshot testing PHP applications. For legacy applications that can’t create and tear down a database for testing purposes due to gaps in the migration history, it can also be tricky and time-consuming to ensure consistency between runs. However, if you can do it, automating the bisect command makes it much quicker, and leaves you with a test you can retain to ensure that bug never returns again.</p></article><article class="post"><p class="date">14th May 2019 12:15 pm</p><h1><a href="/blog/2019/05/14/writing-golden-master-tests-for-laravel-applications/">Writing Golden Master Tests for Laravel Applications</a></h1><p>Last year I wrote <a href="https://matthewdaly.co.uk/blog/2018/10/08/an-approach-to-writing-golden-master-tests-for-php-web-applications/">a post illustrating how to write golden master tests for PHP applications in general</a>. This approach works, but has a number of issues:</p><ul><li>Because it uses a headless browser such as Goutte, it’s inevitably slow (a typical test run for the legacy application I wrote those tests for is 3-4 minutes)</li><li>It can’t allow for differing content, so any changes to the content will break the tests</li></ul><p>These factors limit its utility for many PHP applications. However, for a Laravel application you’re in a much better position:</p><ul><li>You can use Browserkit rather than a headless browser, resulting in much faster response times</li><li>You can set up a testing database, and populate it with the same data each time, ensuring that the only thing that can change is how that data is processed to create the required HTML</li></ul><p>Here I’ll show you how to adapt that approach to work with a Laravel application.</p><p>We rely on Browserkit testing for this approach, so you need to install that:</p><pre><code class="hljs lang-bash singleline">$ composer require --dev laravel/browser-kit-testing</code></pre><p>Next, we need to create our base golden master test case:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">BrowserTestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoldenMasterTestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BrowserTestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">CreatesApplication</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> $baseUrl = <span class="hljs-string">'http://localhost'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $snapshotDir = <span class="hljs-string">"tests/snapshots/"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">protected</span> $path;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goto</span><span class="hljs-params">($path)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">$this</span>-&gt;path = $path;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">$this</span>-&gt;response = <span class="hljs-keyword">$this</span>-&gt;call(<span class="hljs-string">'GET'</span>, $path);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNotEquals(<span class="hljs-number">404</span>, <span class="hljs-keyword">$this</span>-&gt;response-&gt;status());</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveHtml</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;snapshotExists()) {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-keyword">$this</span>-&gt;saveSnapshot();</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assertSnapshotsMatch</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $path = <span class="hljs-keyword">$this</span>-&gt;getPath();</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        $newHtml = <span class="hljs-keyword">$this</span>-&gt;processHtml(<span class="hljs-keyword">$this</span>-&gt;getHtml());</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        $oldHtml = <span class="hljs-keyword">$this</span>-&gt;getOldHtml();</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        $diff = <span class="hljs-string">""</span>;</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        <span class="hljs-keyword">if</span> (function_exists(<span class="hljs-string">'xdiff_string_diff'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>            $diff = xdiff_string_diff($oldHtml, $newHtml);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        $message = <span class="hljs-string">"The path $path does not match the snapshot\n$diff"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-keyword">self</span>::assertThat($newHtml == $oldHtml, <span class="hljs-keyword">self</span>::isTrue(), $message);</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHtml</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;response-&gt;getContent();</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPath</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;path;</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEscapedPath</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;snapshotDir.str_replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">'_'</span>, <span class="hljs-keyword">$this</span>-&gt;getPath()).<span class="hljs-string">'.snap'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">snapshotExists</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        <span class="hljs-keyword">return</span> file_exists(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath());</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processHtml</span><span class="hljs-params">($html)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-string">'/(&lt;input type="hidden"[^&gt;]+\&gt;|&lt;meta name="csrf-token" content="([a-zA-Z0-9]+)"&gt;)/i'</span>, <span class="hljs-string">''</span>, $html);</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveSnapshot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>        $html = <span class="hljs-keyword">$this</span>-&gt;processHtml(<span class="hljs-keyword">$this</span>-&gt;getHtml());</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        file_put_contents(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath(), $html);</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOldHtml</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>        <span class="hljs-keyword">return</span> file_get_contents(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath());</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>}</td></tr></table></code></pre><p>The <code>goto()</code> method sets the current path on the object, then fetches the page. It verifies the page was found, and then returns an instance of the object, to allow for method chaining.</p><p>Another method of note is the <code>saveHtml()</code> method. This checks to see if the snapshot exists - if not, it saves it. The snapshot is essentially just the HTML returned from that route, but certain content may need to be stripped out, which is done in the <code>processHtml()</code> method. In this case we’ve stripped out hidden fields and the CSRF token meta tag, as CSRF tokens are generated anew each time and will break the snapshots.</p><p>The last method we’ll look at is the <code>assertSnapshotsMatch()</code> method. This will get the current HTML, and that for any snapshot for that route, and then compare them. If they differ, it will fail the assertion. In addition, if <code>xdiff_string_diff</code> is available, it will show a diff of the two files - be warned, these can sometimes be large, but they can be helpful in debugging.</p><p>Also, note our snapshots directory - <code>tests/snapshots</code>. If you do make a breaking change and want to delete a snapshot, then you can find it in there - the format replaces forward slashes with underscores, and appends a file extension of <code>.snap</code>, but feel free to customise this to your needs.</p><p>Next, we’ll create a test for routes that don’t require authentication, at <code>tests/GoldenMaster/ExampleTest.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMaster</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMasterTestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Testing</span>\<span class="hljs-title">RefreshDatabase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExampleTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GoldenMasterTestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">RefreshDatabase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@dataProvider</span> nonAuthDataProvider</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testNonAuthPages</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;goto($data)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            -&gt;saveHtml()</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            -&gt;assertSnapshotsMatch();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nonAuthDataProvider</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>            [<span class="hljs-string">'/register'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            [<span class="hljs-string">'/login'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Note the use of the data provider. We want to be able to step through a list of routes, and verify each in turn, so it makes sense to set up a data provider method as <code>nonAuthDataProvider()</code>, which will return an array of routes. If you haven’t used data providers before, they are an easy way to reduce boilerplate in your tests when you need to test the same thing over and over with different data, and you can learn more <a href="https://tighten.co/blog/tidying-up-your-phpunit-tests-with-data-providers">here</a>.</p><p>Now, having seen the methods used, it should be easy to understand <code>testNonAuthPages()</code>. It goes through the following steps:</p><ul><li>Visit the route passed through, eg <code>/register</code></li><li>Save the HTML to a snapshot, if not already saved</li><li>Assert that the current content matches the snapshot</li></ul><p>Using this method, you can test a lot of routes for unexpected changes quite easily. If you’ve used snapshot tests with something like Jest, this is a similar approach.</p><h2 id="authenticated-routes">Authenticated routes</h2><p>This won’t quite work with authenticated routes, so a few more changes are required. You’ll get a response, but if you look at the HTML it will clearly show the user is being redirected for all of them, so there’s not much point in testing them.</p><p>If your content does not differ between users, you can add the trait <code>Illuminate\Foundation\Testing\WithoutMiddleware</code> to your test to disable the authentication and allow the test to get the content without being redirected.</p><p>If, however, your content does differ between users, you need to instead create a user object, and use the <code>actingAs()</code> method already available in Laravel tests to set the user, as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMaster</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMasterTestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Testing</span>\<span class="hljs-title">RefreshDatabase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExampleTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GoldenMasterTestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">RefreshDatabase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@dataProvider</span> authDataProvider</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testAuthPages</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $user = factory(User::class)-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'eric@example.com'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Eric Smith'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'password'</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;actingAs($user)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            -&gt;goto($data)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            -&gt;saveHtml()</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>            -&gt;assertSnapshotsMatch();</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authDataProvider</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            [<span class="hljs-string">'/'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>This will allow us to visit a specific page as a user, without being redirected.</p><h2 id="summary">Summary</h2><p>This can be a useful technique to catch unexpected breakages in applications, particularly ones which have little or no conventional test coverage. While I originated this technique on a Zend 1 legacy code base, leveraging the tools available in Laravel makes this technique much faster and more useful. If your existing Laravel application is not as well tested as you’d like, and you have some substantial changes to make that risk breaking some of the functionality, having these sorts of golden master tests set up can be a quick and easy way of catching any problems as soon as possible.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/">Lightweight Laravel - Deconstructing a Full Stack Framework</a></p><p><a href="/blog/2020/09/28/what-i-want-in-a-php-cms/">What I Want in a PHP CMS</a></p><p><a href="/blog/2020/06/13/flow-typed-ajax-responses-with-react-hooks/">Flow Typed AJAX Responses With React Hooks</a></p><p><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></p><p><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/posts/2/">Newer</a></li><li class="page-item"><a class="page-link" href="/posts/4/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2021.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>