<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/1/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">4th March 2019 9:26 pm</p><h1><a href="/blog/2019/03/04/how-much-difference-does-adding-an-index-to-a-database-table-make/">How Much Difference Does Adding An Index to a Database Table Make?</a></h1><p>For the last few weeks, I’ve been kept busy at work building out a new homepage for the legacy intranet system I maintain. The new homepage is built virtually from scratch with React, and has a completely new set of queries. In addition, I’ve also rebuilt the UI for the navigation to use React too. This has allowed me to bypass a lot of the worst code in the whole code base with the intent to get rid of it once the new home page is live - something I’m very pleased about!</p><p>As part of this, I built some new functionality to show items added in the last seven days. This section of the home page can be sorted by several parameters, including popularity. I also added the facility to expand that to 31 days via an AJAX request. However, the AJAX request was painfully slow, often taking 20-30 seconds. Also, the home page was quite slow to load in the first place, and examining the query time in Clockwork indicated that the culprit was the query for the new items.</p><p>Further examination of the query behind the new items (both on initial page load and the 31 day AJAX request) indicated that the problem was a join. Last year, one of my first tasks had been to add the facility to record a track for any media item when it was visited. This was accomplished using a polymorphic relationship. While Zend 1 doesn’t have the kind of out-of-the-box support for polymorphic relationships that Laravel has, it’s possible to fake it so I created a <code>tracks</code> table whose columns included <code>trackable_id</code> for the primary key of the tracked object, <code>trackable_type</code> for its class, and <code>user_id</code> for the ID of the user who visited it. Now, I was using that same table to determine the number of times each item had been viewed by joining it on each of the media items, which was the first time it was being read for anything other than a report generated in the admin, and performance was dog slow.</p><p>Once I’d established that removing that join from the query removed the performance issue, then it became apparent I was going to need to add an index to the <code>tracks</code> table. The table had got fairly large (low hundreds of thousands), so it had a lot to sort through. As the join used the <code>trackable_id</code> field to join onto the items added, that seemed like a good candidate, so I added the index there.</p><p>The results were dramatic, to put it mildly. The initial page load time dropped from 4.44s to 1.29s - around a third of the previous amount. For the AJAX request to fetch the last 31 day’s new items, the results were even more impressive - the loading time dropped from 22.44s to 1.61s. Overall, figuring out which part of the query was causing the poor performance and resolving it took about ten minutes, and resulted in a staggering improvement.</p><p>If you don’t have a particularly strong theoretical background with relational databases, knowledge of indices can fall by the wayside somewhat. However, as you can see from this example, if you have a particularly slow query, then adding an index can make a staggering difference, so it’s really worth taking the time to understand a bit more about indices and when they can be useful.</p></article><article class="post"><p class="date">20th February 2019 5:25 pm</p><h1><a href="/blog/2019/02/20/searching-content-with-fuse-dot-js/">Searching Content With Fuse.js</a></h1><p>Search is a problem I’m currently taking a big interest in. The legacy project I maintain has an utterly abominable search facility, one that I’m eager to replace with something like Elasticsearch. But smaller sites that are too small for Elasticsearch to be worth the bother can still benefit from having a decent search implementation. Despite some recent improvements, relational databases aren’t generally that good a fit for search because they don’t really understand the concept of relevance - you can’t easily order something by how good a match it is, and your database may not deal with fuzzy matching well.</p><p>I’m currently working on a small flat-file CMS as a personal project. It’s built with PHP, but it’s intended to be as simple as possible, with no database, no caching service, and certainly no search service, so it needs something small and simple, but still effective for search.</p><p>In the past I’ve used Lunr.js on my own site, and it works very well for this use case. However, it’s problematic for this case as the index needs to be generated in Javascript on the server side, and adding Node.js to the stack for a flat-file PHP CMS is not really an option. What I needed was something where I could generate the index in any language I chose, load it via AJAX, and search it on the client side. I recently happened to stumble across <a href="https://fusejs.io/">Fuse.js</a>, which was pretty much exactly what I was after.</p><p>Suppose we have the following index:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>[  </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>   {  </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>      <span class="hljs-attr">"title"</span>:<span class="hljs-string">"About me"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      <span class="hljs-attr">"path"</span>:<span class="hljs-string">"about/"</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   },</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>   {  </td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      <span class="hljs-attr">"title"</span>:<span class="hljs-string">"Meet the team"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      <span class="hljs-attr">"path"</span>:<span class="hljs-string">"about/meet-the-team/"</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   },</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>   {  </td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      <span class="hljs-attr">"title"</span>:<span class="hljs-string">"Alice"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-attr">"path"</span>:<span class="hljs-string">"about/meet-the-team/alice/"</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   },</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>   {  </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      <span class="hljs-attr">"title"</span>:<span class="hljs-string">"Bob"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      <span class="hljs-attr">"path"</span>:<span class="hljs-string">"about/meet-the-team/bob/"</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>   },</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>   {  </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      <span class="hljs-attr">"title"</span>:<span class="hljs-string">"Chris"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      <span class="hljs-attr">"path"</span>:<span class="hljs-string">"about/meet-the-team/chris/"</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>   },</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>   {  </td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>      <span class="hljs-attr">"title"</span>:<span class="hljs-string">"Home"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      <span class="hljs-attr">"path"</span>:<span class="hljs-string">"index/"</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>]</td></tr></table></code></pre><p>This index can be generated in any way you see fit. In this case, the page content is stored in Markdown files with YAML front matter, so I wrote a Symfony console command which gets all the Markdown files in the content folder, parses them to get the titles, and retrieves the path. You could also retrieve other items in front matter such as categories or tags, and the page content, and include that in the index. The data then gets converted to JSON and saved to the index file. As you can see, there’s nothing special about this JSON - these two fields happen to be the ones I’ve chosen.</p><p>Now we can load the JSON file via AJAX, and pass it to a new Fuse instance. You can search the index using the <code>.search()</code> method, as shown below:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> Fuse <span class="hljs-keyword">from</span> <span class="hljs-string">'fuse.js'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-built_in">window</span>.$ = <span class="hljs-built_in">window</span>.jQuery = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-built_in">window</span>.$.getJSON(<span class="hljs-string">'/storage/index.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">const</span> fuse = <span class="hljs-keyword">new</span> Fuse(response, {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      <span class="hljs-attr">keys</span>: [<span class="hljs-string">'title'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      <span class="hljs-attr">shouldSort</span>: <span class="hljs-literal">true</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    $(<span class="hljs-string">'#search'</span>).on(<span class="hljs-string">'keyup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      <span class="hljs-keyword">let</span> result = fuse.search($(<span class="hljs-keyword">this</span>).val());</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      <span class="hljs-comment">// Output it</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      <span class="hljs-keyword">let</span> resultdiv = $(<span class="hljs-string">'ul.searchresults'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      <span class="hljs-keyword">if</span> (result.length === <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">// Hide results</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        resultdiv.hide();</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      } <span class="hljs-keyword">else</span> {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-comment">// Show results</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        resultdiv.empty();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">in</span> result.slice(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>          <span class="hljs-keyword">let</span> searchitem = <span class="hljs-string">'&lt;li&gt;&lt;a href="/'</span> + result[item].path + <span class="hljs-string">'"&gt;'</span> + result[item].title + <span class="hljs-string">'&lt;/a&gt;&lt;/li&gt;'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>          resultdiv.append(searchitem);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        resultdiv.show();</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    });</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  });</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>});</td></tr></table></code></pre><p>The really great thing about Fuse.js is that it can search just about any JSON content, making it extremely flexible. For a site with a MySQL database, you could generate the JSON from one or more tables in the database, cache it in Redis or Memcached indefinitely until such time as the content changes again, and only regenerate it then, making for an extremely efficient client-side search that doesn’t need to hit the database during normal operation. Or you could generate it from static files, as in this example. It also means the backend language is not an issue, since you can easily generate the JSON file in PHP, Javascript, Python or any other language.</p><p>As you can see, it’s pretty straightforward to use Fuse.js to create a working search field out of the box, but the website lists a number of options allowing you to customise the search for your particular use case, and I’d recommend looking through these if you’re planning on using it on a project.</p></article><article class="post"><p class="date">16th February 2019 7:00 pm</p><h1><a href="/blog/2019/02/16/higher-order-components-in-react/">Higher-order Components in React</a></h1><p>In the last few weeks I’ve been working on a big rebuild of the homepage of the legacy application I maintain. As I’ve been slowly transitioning it to use React on the front end, I used that, and it’s by far the largest React project I’ve worked on to date. This has pushed me to use some more advanced React techniques I hadn’t touched on before. I’ve also had to create some different components that have common functionality.</p><p>React used to use mixins to share common functionality, but the consensus is now that <a href="https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html">mixins are considered harmful</a>, so they have been removed. Instead, developers are encouraged to create higher-order components to contain the shared functionality.</p><p>A higher-order component is a function that accepts a React component as an argument, and then returns another component that wraps the provided one. The shared functionality is defined inside the wrapping component, and so any state or methods defined in the wrapping component can then be passed as props into the wrapped one, as in this simple example:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React, { Component } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hocExample</span>(<span class="hljs-params">WrappedComponent</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hocExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">constructor</span>(props) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>      <span class="hljs-keyword">this</span>.state = {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">foo</span>: <span class="hljs-literal">false</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      };</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>      <span class="hljs-keyword">this</span>.doStuff = <span class="hljs-keyword">this</span>.doStuff.bind(<span class="hljs-keyword">this</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    doStuff() {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-keyword">this</span>.setState({</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-attr">foo</span>: <span class="hljs-literal">true</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    render() {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> <span class="hljs-attr">foo</span>=<span class="hljs-string">{this.state.foo}</span> <span class="hljs-attr">doStuff</span>=<span class="hljs-string">{this.doStuff}</span> /&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      );</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  return hocExample;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>}</td></tr></table></code></pre><p>If you’ve been working with React for a while, even if you haven’t written a higher-order component, you’ve probably used one. For instance, <code>withRouter()</code> from <code>react-router</code> is a good example of a higher-order component that forms part of an existing library.</p><h1 id="a-real-world-example">A real-world example</h1><p>A very common use case I’ve come across is handling a click outside of a component. For instance, if you have a sidebar or popup component, it’s common to want to close it when the user clicks outside the component. As such, it’s worth taking the time to refactor it to make it reusable.</p><p>In principle you can achieve this on any component as follows:</p><ul><li>The component should accept two props - an <code>active</code> prop that denotes whether the component is active or not, and an <code>onClickOutside()</code> prop method that is called on a click outside</li><li>On mount, an event listener should be added to the document to listen for <code>mousedown</code> events, and it should be removed on unmount</li><li>When the event listener is fired, it should use a ref on the component to determine if the ref contains the event target. If so, and the status is active, the <code>onClickOutside()</code> method should be called</li></ul><p>Moving this to a higher order component makes a couple of issues slightly more complex, but not very. We can’t easily get a ref of the wrapped component, so I had to resort to using <code>ReactDOM.findDOMNode()</code> instead, which is potentially a bit dodgy as they’re talking about deprecating that.</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React, { Component } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> { findDOMNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clicksOutside</span>(<span class="hljs-params">WrappedComponent</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">clicksOutside</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">constructor</span>(props) {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      <span class="hljs-keyword">super</span>(props);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      <span class="hljs-keyword">this</span>.setWrapperRef = <span class="hljs-keyword">this</span>.setWrapperRef.bind(<span class="hljs-keyword">this</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>      <span class="hljs-keyword">this</span>.handleClickOutside = <span class="hljs-keyword">this</span>.handleClickOutside.bind(<span class="hljs-keyword">this</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    componentDidMount() {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mousedown'</span>, <span class="hljs-keyword">this</span>.handleClickOutside);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    componentWillUnmount() {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      <span class="hljs-built_in">document</span>.removeEventListener(<span class="hljs-string">'mousedown'</span>, <span class="hljs-keyword">this</span>.handleClickOutside);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    setWrapperRef(node) {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      <span class="hljs-keyword">this</span>.wrapperRef = node;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    handleClickOutside(event) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>      <span class="hljs-keyword">const</span> {target} = event;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.wrapperRef &amp;&amp; target <span class="hljs-keyword">instanceof</span> Node) {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">const</span> ref = findDOMNode(<span class="hljs-keyword">this</span>.wrapperRef);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">if</span> (ref &amp;&amp; !ref.contains(target) &amp;&amp; <span class="hljs-keyword">this</span>.props.active === <span class="hljs-literal">true</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>          <span class="hljs-keyword">this</span>.props.onClickOutside();</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    render() {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>      <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> {<span class="hljs-attr">...this.props</span>} <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.setWrapperRef}</span> /&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>      );</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>  };</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>  return clicksOutside;</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>}</td></tr></table></code></pre><p>Now we can use this as follows:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React, { Component } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> Sidebar <span class="hljs-keyword">from</span> <span class="hljs-string">'./src/Components/Sidebar'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> clicksOutside <span class="hljs-keyword">from</span> <span class="hljs-string">'./src/Components/clicksOutside'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">const</span> SidebarComponent = clicksOutside(Sidebar);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleClickOutside</span>(<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  alert(<span class="hljs-string">'You have clicked outside'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>ReactDOM.render(</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SidebarComponent</span> </span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attr">links</span>=<span class="hljs-string">{links}</span> </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">active</span>=<span class="hljs-string">{true}</span> </td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attr">onClickOutside</span>=<span class="hljs-string">{handleClickOutside}</span> </td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  /&gt;,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  document.getElementById('root')</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>);</td></tr></table></code></pre><p>Higher order components sound a lot harder than they actually are. In reality, they’re actually quite simple to implement, but I’m not sure the <a href="https://reactjs.org/docs/higher-order-components.html">documentation</a> is necessarily the best example to use since it’s a bit on the complex side.</p></article><article class="post"><p class="date">2nd February 2019 8:45 pm</p><h1><a href="/blog/2019/02/02/creating-your-own-dependency-injection-container-in-php/">Creating Your Own Dependency Injection Container in PHP</a></h1><p>Dependency injection can be a difficult concept to understand in the early stages. Even when you’re using it all the time, it can often seem like magic. However, it’s really not all that complicated once you actually get into the nuts and bolts of it, and building your own container is a good way to learn more about how it works and how to use it.</p><p>In this tutorial, I’ll walk you through creating a simple, minimal dependency injection container, using PHPSpec as part of a TDD workflow. While the end result isn’t necessarily something I’d be happy using in a production environment, it’s sufficient to understand the basic concept and make it feel less like a black box. Our container will be called Ernie (if you want to know why, it’s a reference to a 90’s era video game that had a character based on Eric Cantona called Ernie Container).</p><p>The first thing we need to do is set up our dependencies. Our container will implement PSR-11, so we need to include the interface that defines that. We’ll also use PHP CodeSniffer to ensure code quality, and PHPSpec for testing. Your <code>composer.json</code> should look something like this:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/ernie"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Simple DI container"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"library"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-attr">"squizlabs/php_codesniffer"</span>: <span class="hljs-string">"^3.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^5.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"psr/container"</span>: <span class="hljs-string">"^1.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">"authors"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"450801+matthewbdaly@users.noreply.github.com"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    ],</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-attr">"require"</span>: {},</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-attr">"Matthewbdaly\\Ernie\\"</span>: <span class="hljs-string">"src/"</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>}</td></tr></table></code></pre><p>We also need to put this in our <code>phpspec.yml</code> file:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>suites:</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    test_suite:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">namespace</span>: <span class="hljs-symbol">Matthewbdaly</span>\<span class="hljs-symbol">Ernie</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-symbol">psr4_prefix</span>: <span class="hljs-symbol">Matthewbdaly</span>\<span class="hljs-symbol">Ernie</span></td></tr></table></code></pre><p>With that done, we can start working on our implementation.</p><h1 id="creating-the-exceptions">Creating the exceptions</h1><p>The PSR-11 specification defines two interfaces for exceptions, which we will implement before actually moving on to the container itself. The first of these is <code>Psr\Container\ContainerExceptionInterface</code>. Run the following command to create a basic spec for the exception:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/phpspec desc Matthewbdaly/Ernie/Exceptions/ContainerException</code></pre><p>The generated specification for it at <code>spec/Exceptions/ContainerExceptionSpec.php</code> will look something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">ContainerException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContainerExceptionSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(ContainerException::class);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>This is not sufficient for our needs. Our exception must also implement two interfaces:</p><ul><li><code>Throwable</code></li><li><code>Psr\Container\ContainerExceptionInterface</code></li></ul><p>The former can be resolved by inheriting from <code>Exception</code>, while the latter doesn’t require any additional methods. Let’s expand our spec to check for these:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">ContainerException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContainerExceptionSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(ContainerException::class);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_implements_interface</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldImplement(<span class="hljs-string">'Psr\Container\ContainerExceptionInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_implements_throwable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldImplement(<span class="hljs-string">'Throwable'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Now run the spec and PHPSpec will generate the boilerplate exception for you:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Ernie/Exceptions/ContainerException                                </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  11  - it is initializable</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      class Matthewbdaly\Ernie\Exceptions\ContainerException does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Matthewbdaly/Ernie/Exceptions/ContainerException                                  </td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  16  - it implements interface</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      class Matthewbdaly\Ernie\Exceptions\ContainerException does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>Matthewbdaly/Ernie/Exceptions/ContainerException                                </td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  21  - it implements throwable</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      class Matthewbdaly\Ernie\Exceptions\ContainerException does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                                      100%                                       3</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>3 examples (3 broken)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>23ms</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  Do you want me to create `Matthewbdaly\Ernie\Exceptions\ContainerException`   </td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  <span class="hljs-keyword">for</span> you?                                                                      </td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                                                                         [Y/n]</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>Class Matthewbdaly\Ernie\Exceptions\ContainerException created <span class="hljs-keyword">in</span> /home/matthew/Projects/ernie-clone/src/Exceptions/ContainerException.php.</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>Matthewbdaly/Ernie/Exceptions/ContainerException                                </td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  16  - it implements interface</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>      expected an instance of Psr\Container\ContainerExceptionInterface, but got</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>      [obj:Matthewbdaly\Ernie\Exceptions\ContainerException].</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>Matthewbdaly/Ernie/Exceptions/ContainerException                                </td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>  21  - it implements throwable</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>      expected an instance of Throwable, but got</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>      [obj:Matthewbdaly\Ernie\Exceptions\ContainerException].</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>            33%                                     66%                          3</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>3 examples (1 passed, 2 failed)</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>36ms</td></tr></table></code></pre><p>It’s failing, but we expect that. We need to update our exception to extend the base PHP exception, and implement <code>Psr\Container\ContainerExceptionInterface</code>. Let’s do that now:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">ContainerExceptionInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Exception</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContainerException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContainerExceptionInterface</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr></table></code></pre><p>Let’s re-run the spec:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       3</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>3 examples (3 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>24ms</td></tr></table></code></pre><p>The second exception we need to implement is <code>Psr\Container\NotFoundExceptionInterface</code> and it’s a similar story. Run the following command to create the spec:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/phpspec desc Matthewbdaly/Ernie/Exceptions/NotFoundException</code></pre><p>Again, the spec needs to be amended to verify that it’s a throwable and implements the required interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">NotFoundException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotFoundExceptionSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(NotFoundException::class);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_implements_interface</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldImplement(<span class="hljs-string">'Psr\Container\NotFoundExceptionInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_implements_throwable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldImplement(<span class="hljs-string">'Throwable'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>For the sake of brevity I’ve left out the output, but if you run <code>vendor/bin/phpspec run</code> you’ll see it fail due to the fact that the generated class doesn’t implement the required interfaces. Amend <code>src/Exceptions/NotFoundException</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">NotFoundExceptionInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Exception</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">NotFoundExceptionInterface</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>}</td></tr></table></code></pre><p>Running <code>vendor/bin/phpspec run</code> should now see it pass. Now let’s move on to the container class…</p><h1 id="building-the-container">Building the container</h1><p>Run the following command to create the container spec:</p><pre><code class="hljs lang-bash singleline">$ vendor/bin/phpspec desc Matthewbdaly/Ernie/Container</code></pre><p>However, the default generated spec isn’t sufficient. We need to check it implements the required interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Container</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContainerSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(Container::class);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_implements_interface</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldImplement(<span class="hljs-string">'Psr\Container\ContainerInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>Now, if we run PHPSpec, we’ll generate our class:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  11  - it is initializable</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      class Matthewbdaly\Ernie\Container does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Matthewbdaly/Ernie/Container                                                      </td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  16  - it implements interface</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      class Matthewbdaly\Ernie\Container does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                            75%                                     25%          8</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>3 specs</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>8 examples (6 passed, 2 broken)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>404ms</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Do you want me to create `Matthewbdaly\Ernie\Container` <span class="hljs-keyword">for</span> you?              </td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>Class Matthewbdaly\Ernie\Container created <span class="hljs-keyword">in</span> /home/matthew/Projects/ernie-clone/src/Container.php.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>Matthewbdaly/Ernie/Container                                                      </td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>  16  - it implements interface</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>      expected an instance of Psr\Container\ContainerInterface, but got</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      [obj:Matthewbdaly\Ernie\Container].</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>                                 87%                                     12%     8</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>3 specs</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>8 examples (7 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>40ms</td></tr></table></code></pre><p>Now, as we can see, this class doesn’t implement the interface. Let’s remedy that:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">ContainerInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Container</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContainerInterface</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td></tr></table></code></pre><p>Now, if we run the tests, they should fail because the class needs to add the required methods:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>✘ Fatal error happened <span class="hljs-keyword">while</span> executing the following </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    it is initializable </td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    Class Matthewbdaly\Ernie\Container contains 2 abstract methods and must therefore be declared abstract or implement the remaining methods (Psr\Container\ContainerInterface::get, Psr\Container\ContainerInterface::has) <span class="hljs-keyword">in</span> /home/matthew/Projects/ernie-clone/src/Container.php on line 7 </td></tr></table></code></pre><p>If you use an editor or IDE that allows you to implement an interface automatically, you can run it to add the required methods. I use PHPActor with Neovim, and used the option in the Transform menu to implement the contract:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">ContainerInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Container</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContainerInterface</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>}</td></tr></table></code></pre><p>Running <code>vendor/bin/phpspec run</code> should now make the spec pass, but the methods don’t actually do anything yet. If you read the spec for PSR-11, you’ll see that <code>has()</code> returns a boolean to indicate whether a class can be instantiated or not, while <code>get()</code> will either return an instance of the specified class, or throw an exception. We will add specs that check that built-in classes can be returned by both, and unknown classes display the expected behaviour. We’ll do both at once, because in both cases, the functionality to actually resolve the required class will be deferred to a single resolver method, and these methods will not do all that much as a result:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_has_simple_classes</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;has(<span class="hljs-string">'DateTime'</span>)-&gt;shouldReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_does_not_have_unknown_classes</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">$this</span>-&gt;has(<span class="hljs-string">'UnknownClass'</span>)-&gt;shouldReturn(<span class="hljs-keyword">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_get_simple_classes</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'DateTime'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_returns_not_found_exception_if_class_cannot_be_found</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(<span class="hljs-string">'Matthewbdaly\Ernie\Exceptions\NotFoundException'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            -&gt;duringGet(<span class="hljs-string">'UnknownClass'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr></table></code></pre><p>These tests verify that:</p><ul><li><code>has()</code> returns <code>true</code> when called with the always-present <code>DateTime</code> class</li><li><code>has()</code> returns <code>false</code> for the undefined <code>UnknownClass</code></li><li><code>get()</code> successfully instantiates an instance of <code>DateTime</code></li><li><code>get()</code> throws an exception if you try to instantiate the undefined <code>UnknownClass</code></li></ul><p>Running the specs will raise errors:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Ernie/Container                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  21  - it has simple classes</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected <span class="hljs-literal">true</span>, but got null.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  26  - it does not have unknown classes</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      expected <span class="hljs-literal">false</span>, but got null.</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  31  - it can get simple classes</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      expected an instance of DateTime, but got null.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  36  - it returns not found exception <span class="hljs-keyword">if</span> class cannot be found</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      expected to get exception / throwable, none got.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>                         66%                                     33%             12</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>3 specs</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>12 examples (8 passed, 4 failed)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>98ms</td></tr></table></code></pre><p>Let’s populate these empty methods:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">ContainerInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">NotFoundException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Container</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ContainerInterface</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;resolve($id);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;getInstance($item);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">try</span> {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            $item = <span class="hljs-keyword">$this</span>-&gt;resolve($id);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        } <span class="hljs-keyword">catch</span> (NotFoundException $e) {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;isInstantiable();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">try</span> {</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> ReflectionClass($id));</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        } <span class="hljs-keyword">catch</span> (ReflectionException $e) {</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotFoundException($e-&gt;getMessage(), $e-&gt;getCode(), $e);</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(ReflectionClass $item)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;newInstance();</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>}</td></tr></table></code></pre><p>As you can see, both the <code>has()</code> and <code>get()</code> methods need to resolve a string ID to an actual class, so that common functionality is stored in a private method called <code>resolve()</code>. This uses the <a href="http://php.net/manual/en/book.reflection.php">PHP Reflection API</a> to resolve the class name to an actual class. We pass the string ID into a constructor of <code>ReflectionClass</code>, and the <code>resolve()</code> method will either return the created instance of <code>ReflectionClass</code>, or throw an exception.</p><p>For the uninitiated, <code>ReflectionClass</code> allows you to reflect on the object whose fully qualified class name is passed to the constructor, in order to interact with that class programmatically. The methods we will use include:</p><ul><li><code>isInstantiable</code> - confirms whether or not the class can be instantiated (for instance, traits and abstract classes can’t)</li><li><code>newInstance</code> - creates a new instance of the item in question, as long as it has no dependencies in the constructor</li><li><code>newInstanceArgs</code> - creates a new instance, using the arguments passed in</li><li><code>getConstructor</code> - allows you to get information about the constructor</li></ul><p>The Reflection API is pretty comprehensive, and I would recommend reading the documentation linked to above if you want to know more.</p><p>For the <code>has()</code> method, we check that the resolved class is instantiable, and return the result of that. For the <code>get()</code> method, we use <code>getInstance()</code> to instantiate the item and return that, throwing an exception if that fails.</p><h1 id="registering-objects">Registering objects</h1><p>In its current state, the container doesn’t allow you to set an item. To be useful, we need to be able to specify that an interface or string should be resolved to a given class, or for cases where we need to pass in scalar parameters, such as a database object, to specify how a concrete instance of that class should be instantiated. To that end, we’ll create a new <code>set()</code> public method that will allow a dependency to be set. Here are the revised specs including this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Container</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">DateTime</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContainerSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(Container::class);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_implements_interface</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldImplement(<span class="hljs-string">'Psr\Container\ContainerInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_has_simple_classes</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">$this</span>-&gt;has(<span class="hljs-string">'DateTime'</span>)-&gt;shouldReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_does_not_have_unknown_classes</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">$this</span>-&gt;has(<span class="hljs-string">'UnknownClass'</span>)-&gt;shouldReturn(<span class="hljs-keyword">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_get_simple_classes</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'DateTime'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_returns_not_found_exception_if_class_cannot_be_found</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(<span class="hljs-string">'Matthewbdaly\Ernie\Exceptions\NotFoundException'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>            -&gt;duringGet(<span class="hljs-string">'UnknownClass'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_register_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve)-&gt;shouldReturn(<span class="hljs-keyword">$this</span>);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_invokable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DateTime;</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_callable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        $toResolve = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DateTime;</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_if_registered_dependencies_instantiable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>        <span class="hljs-keyword">$this</span>-&gt;has(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>}</td></tr></table></code></pre><p>This needs to handle quite a few scenarios, so there are several tests we have in place. These verify that:</p><ul><li>The <code>set()</code> method returns an instance of the container class, to allow for method chaining</li><li>When a dependency is set, calling <code>get()</code> returns an instance of that class</li><li>When a concrete class that has the <code>__invoke()</code> magic method set is passed to <code>set()</code>, it is invoked and the response returned.</li><li>When the value passed through is a callback, the callback is resolved and the response returned</li><li>When a dependency is set, calling <code>has()</code> for it returns the right value</li></ul><p>Note that we use anonymous classes for testing - I’ve written about these before and they’re very useful in this context because they allow us to create a simple class inline for testing purposes.</p><p>Running the specs should result in us being prompted to generate the <code>set()</code> method, and failing afterwards:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  42  - it can register dependencies</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span> not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  49  - it can resolve registered dependencies</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>      method Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span> not found.</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  57  - it can resolve registered invokable</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      method Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span> not found.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  68  - it can resolve registered callable</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      method Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span> not found.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  77  - it can resolve <span class="hljs-keyword">if</span> registered dependencies instantiable</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      method Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span> not found.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                          70%                                     29%            17</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>3 specs</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>17 examples (12 passed, 5 broken)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>316ms</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  Do you want me to create `Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span>()` <span class="hljs-keyword">for</span> you?       </td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>                                                                         [Y/n]</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>  Method Matthewbdaly\Ernie\Container::<span class="hljs-built_in">set</span>() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>  42  - it can register dependencies</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>      expected [obj:Matthewbdaly\Ernie\Container], but got null.</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>  49  - it can resolve registered dependencies</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>      exception [exc:Matthewbdaly\Ernie\Exceptions\NotFoundException(<span class="hljs-string">"Class Foo\Bar does not exist"</span>)] has been thrown.</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>  57  - it can resolve registered invokable</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>      exception [exc:Matthewbdaly\Ernie\Exceptions\NotFoundException(<span class="hljs-string">"Class Foo\Bar does not exist"</span>)] has been thrown.</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>  68  - it can resolve registered callable</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>      exception [exc:Matthewbdaly\Ernie\Exceptions\NotFoundException(<span class="hljs-string">"Class Foo\Bar does not exist"</span>)] has been thrown.</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>  77  - it can resolve <span class="hljs-keyword">if</span> registered dependencies instantiable</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>      expected <span class="hljs-literal">true</span>, but got <span class="hljs-literal">false</span>.</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>                          70%                              11%        17%        17</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>3 specs</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>17 examples (12 passed, 2 failed, 3 broken)</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>90ms</td></tr></table></code></pre><p>First, we need to set up the <code>set()</code> method properly, and define a property to contain the stored services:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">private</span> $services = [];</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span><span class="hljs-params">(string $key, $value)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;services[$key] = $value;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    }</td></tr></table></code></pre><p>This fixes the first spec, but the resolver needs to be amended to handle cases where the ID is set manually:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">try</span> {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            $name = $id;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;services[$id])) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                $name = <span class="hljs-keyword">$this</span>-&gt;services[$id];</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>                <span class="hljs-keyword">if</span> (is_callable($name)) {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>                    <span class="hljs-keyword">return</span> $name();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                }</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> ReflectionClass($name));</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        } <span class="hljs-keyword">catch</span> (ReflectionException $e) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotFoundException($e-&gt;getMessage(), $e-&gt;getCode(), $e);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr></table></code></pre><p>This will allow us to resolve classes set with <code>set()</code>. However, we also want to resolve any callables, such as callbacks or classes that implement the <code>__invoke()</code> magic method, which means that sometimes <code>resolve()</code> will return the result of the callable instead of an instance of <code>ReflectionClass</code>. Under those circumstances we should return the item directly:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;resolve($id);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">if</span> (!($item <span class="hljs-keyword">instanceof</span> ReflectionClass)) {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-keyword">return</span> $item;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;getInstance($item);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr></table></code></pre><p>Note that because the <code>__invoke()</code> method is automatically called in any concrete class specified in the second argument to <code>set()</code>, it’s only possible to resolve classes that define an <code>__invoke()</code> method if they are passed in as string representations. The following PsySh session should make it clear what this means:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&gt;&gt;&gt; <span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Ernie</span>\<span class="hljs-title">Container</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>&gt;&gt;&gt; $c = <span class="hljs-keyword">new</span> Container;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>=&gt; Matthewbdaly\Ernie\Container {<span class="hljs-comment">#2307}</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>&gt;&gt;&gt; <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestClass</span> </span>{ <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Called"</span>; }}</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>&gt;&gt;&gt; $c-&gt;get(<span class="hljs-string">'TestClass'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>=&gt; TestClass {<span class="hljs-comment">#2319}</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>&gt;&gt;&gt; $c-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, <span class="hljs-string">'TestClass'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>=&gt; Matthewbdaly\Ernie\Container {<span class="hljs-comment">#2307}</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>&gt;&gt;&gt; $c-&gt;get(<span class="hljs-string">'Foo\Bar'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>=&gt; TestClass {<span class="hljs-comment">#2309}</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>&gt;&gt;&gt; $c-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, <span class="hljs-keyword">new</span> TestClass);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>=&gt; Matthewbdaly\Ernie\Container {<span class="hljs-comment">#2307}</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>&gt;&gt;&gt; $c-&gt;get(<span class="hljs-string">'Foo\Bar'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>=&gt; <span class="hljs-string">"Called"</span></td></tr></table></code></pre><p>As you can see, if we pass in the fully qualified class name of a class that defines an <code>__invoke()</code> method, it can be resolved as expected. However, if we pass a concrete instance of it to <code>set()</code>, it will be called and will return the response from that. This may not be the behaviour you want for your own container.</p><p>According to <a href="https://github.com/thephpleague/container/issues/113">this issue on the PHP League’s Container implementation</a>, it was also an issue for them, so seeing as this is just a toy example I’m not going to lose any sleep over it. Just something to be aware of if you use this post as the basis for writing your own container.</p><h1 id="resolving-dependencies">Resolving dependencies</h1><p>One thing is missing from our container. Right now it should be able to instantiate pretty much any class that has no dependencies, but these are quite firmly in the minority. To be useful, a container should be able to resolve all of the dependencies for a class automatically.</p><p>Let’s add a spec for that:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    function it_can_resolve_dependencies()</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $toResolve = get_class(new class(new DateTime) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            public $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            public function __construct(DateTime $datetime)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>                $this-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $this-&gt;set('Foo\Bar', $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $this-&gt;get('Foo\Bar')-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr></table></code></pre><p>Here we have to be a bit crafty. Anonymous classes are defined and instantiated at the same time, so we can’t pass it in as an anonymous class in the test. Instead, we call the anonymous class and get its name, then set that as the second argument to <code>set()</code>. Then we can verify that the returned object is an instance of the same class.</p><p>Running this throws an error:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Ernie/Container                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-number">86</span>  - it can resolve dependencies</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      <span class="hljs-keyword">exception</span> [err:ArgumentCountError(<span class="hljs-string">"Too few arguments to function class@anonymous::__construct(), 0 passed and exactly 1 expected"</span>)] has been thrown.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                                    <span class="hljs-number">94</span>%                                          <span class="hljs-number">18</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-number">3</span> specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-number">18</span> examples (<span class="hljs-number">17</span> passed, <span class="hljs-number">1</span> broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-number">60</span>ms</td></tr></table></code></pre><p>This is expected. Our test class accepts an instance of <code>DateTime</code> in the constructor as a mandatory dependency, so instantiating it fails. We need to update the <code>getInstance()</code> method so that it can handle pulling in any dependencies:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(ReflectionClass $item)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $constructor = $item-&gt;getConstructor();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">if</span> (is_null($constructor) || $constructor-&gt;getNumberOfRequiredParameters() == <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-keyword">return</span> $item-&gt;newInstance();</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $params = [];</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">foreach</span> ($constructor-&gt;getParameters() <span class="hljs-keyword">as</span> $param) {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">if</span> ($type = $param-&gt;getType()) {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                $params[] = <span class="hljs-keyword">$this</span>-&gt;get($type-&gt;getName());</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;newInstanceArgs($params);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr></table></code></pre><p>Here, we use the Reflection API to get the constructor. If there’s no constructor, or it has no required parameters, we just return a new instance of the reflected class as before.</p><p>Otherwise, we loop through the required parameters. For each parameter, we get the string representation of the type specified for that parameter, and retrieve an instance of it from the container. Afterwards, we use those parameters to instantiate the object.</p><p>Let’s run the specs again:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       18</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>3 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>18 examples (18 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>51ms</td></tr></table></code></pre><p>Our container is now complete. We can:</p><ul><li>Resolve simple classes out of the box</li><li>Set arbitrary keys to resolve to particular classes, or the result of callables, so as to enable mapping interfaces to concrete implementations, or resolve classes that require specific non-object parameters, such as PDO</li><li>Resolve complex classes with multiple dependencies</li></ul><p>Not too bad for just over 100 lines of PHP…</p><h1 id="final-thoughts">Final thoughts</h1><p>As I’ve said, this is a pretty minimal example of a dependency injection container, and I wouldn’t advise using this in production when there are so many existing, mature solutions available. I have no idea how the performance would stack up against existing solutions, or whether there are any issues with it, and quite frankly that’s besides the point - this is intended as a learning exercise to understand how dependency injection containers in general work, not as an actual useful piece of code for production. If you want an off-the-shelf container, I’d point you in the direction of <code>league/container</code>, which has served me well.</p><p>You can find the code for this tutorial on <a href="https://github.com/matthewbdaly/ernie">GitHub</a>, so if you have any problems, you should take a look there to see where the problem lies. Of course, if you go on to create your own kick-ass container based on this, do let me know!</p></article><article class="post"><p class="date">27th January 2019 11:10 pm</p><h1><a href="/blog/2019/01/27/understanding-query-objects/">Understanding Query Objects</a></h1><p>The project I’ve been maintaining for the last year has inherited a rather dubious database structure that would currently be very difficult to refactor, which also makes many queries more convoluted than they should be. At present, I’m involved in building a whole new home page, which has necessitated adding some new queries. Since some of these involve carrying out unions between several similar tables (that should have been one table, grr…), they can involve some quite large chunks for each query.</p><p>As a result, it’s made sense to break those queries down further. Since Zend 1 doesn’t have anything analogous to scopes in Eloquent, I don’t really have an easy way to break these queries up in the models (and I’m trying to get the query logic out of the models at present anyway), so I opted to make them into query objects instead, which is a pattern I hadn’t used before (but probably should have).</p><p>A query object is pretty much what it says on the tin - it’s a PHP object that executes a single, very specific query. This may seem like overkill, but it’s only really useful for the most complex and convoluted of queries. It can accept parameters, as you’d expect, and some parts of the query may be optional based on that, but fundamentally it should build and run only one single query.</p><p>In this post I’ll go through how you might create one, how it relates to the repository pattern, and when to create one.</p><h1 id="creating-a-query-object-class">Creating a query object class</h1><p>I’m a big fan of the <code>__invoke()</code> magic method in PHP. For the uninitiated, it lets you instantiate the class, and then use it in the same way you would a function, making it very useful for callbacks. This also brings some other advantages:</p><ul><li>Unlike with a function, you can create private methods to do other parts of the work, making it easier to understand the main method.</li><li>It can have a constructor, and can therefore both accept dependencies via the constructor, and be instantiated via dependency injection, simplifying setup and testing when compared to using a callback.</li><li>Since <code>__invoke()</code> is an innate part of the PHP language, it makes more sense for classes that have a single responsibility to use that method name to do that, rather than picking something like <code>handle()</code> or <code>run()</code>.</li></ul><p>As a result, my query objects generally use the <code>__invoke()</code> method to trigger the query.</p><p>Since Zend 1 is no longer supported, I won’t bother displaying how I’d write the query in that specific context. I have yet to use this pattern with Laravel, but if I did, it would look something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Queries</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">DatabaseManager</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardItems</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $db;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DatabaseManager $db)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db = $db;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(int $days = <span class="hljs-number">7</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;fooTable()</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            -&gt;union(<span class="hljs-keyword">$this</span>-&gt;barTable())</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            -&gt;whereRaw(<span class="hljs-string">'start_date &gt;= (NOW() - INTERVAL ? DAY)'</span>, [$days]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            -&gt;get();</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fooTable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;table(<span class="hljs-string">'foo'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            -&gt;where(<span class="hljs-string">'type'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'fooType'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">barTable</span><span class="hljs-params">(int $days)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;table(<span class="hljs-string">'bar'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;where(<span class="hljs-string">'type'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'barType'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>Note that we break each one of the tables we want to perform a <code>UNION</code> on into a private method. This is probably the biggest advantage of query objects - it lets you break particularly unwieldy queries up into logical steps, making them more readable. You could do this by adding private methods on a repository class too, but I’d be reluctant to add private methods to a repository that were only used in one query - to my mind, a query object is a better home for that.</p><h1 id="what-about-repositories-">What about repositories?</h1><p>I regularly use the repository pattern in my code bases, whether that’s for Laravel projects or the current Zend 1-based legacy project. It’s an ongoing effort to refactor it so that all the queries are called from repository classes, leaving the models to act as containers for the data. So how do query objects fit in here?</p><p>It’s important to note that while a repository represents all queries relating to a table, a query object represents only a single query, and so the repository should still be the place where the query is called from. However, the repository should just defer the actual querying to the query object. The relevant parts of the application structure for my current application look a bit like this:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>└── app</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ├── Queries</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    │   └── DashboardItems.php</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    └── Repositories</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        └── DashboardRepository.php</td></tr></table></code></pre><p>And the repository might call the query object as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Queries</span>\<span class="hljs-title">DashboardItems</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardRepository</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dashboardItems</span><span class="hljs-params">(int $days = <span class="hljs-number">7</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $query = <span class="hljs-keyword">new</span> DashboardItems;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> $query($days);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></tr></table></code></pre><p>At present my repositories all use static methods as I’m still in the process of migrating the queries over to the repository classes. That also means I can’t easily use dependency injection. For a Laravel application, a similar call might look like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Queries</span>\<span class="hljs-title">DashboardItems</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardRepository</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $dashboardQuery;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DashboardItems $dashboardQuery)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;dashboardQuery = $dashboardQuery;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dashboardItems</span><span class="hljs-params">(int $days = <span class="hljs-number">7</span>)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;dashboardQuery($days);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>The only real difference is that we can instantiate the query object out of the container, simplifying setup.</p><h1 id="when-to-use-query-objects">When to use query objects</h1><p>I think it probably goes without saying, but it should be a rare query that actually needs to be implemented as a query object, especially if you’re using an ORM like Eloquent that provides features like scopes, and as yet I only have two using this pattern, as well as two others that were implemented as “reporter” classes, but could be query objects instead. So far, my experience has been that the sort of queries that are large enough to be worth considering include:</p><ul><li>Queries that generate reports, particularly if they have various options</li><li>Queries that use unions, as in the above example, since it makes sense to use a private method to fetch each table</li><li>Queries with multiple complex joins</li></ul><p>Smaller queries will typically fit happily inside a single method in your repository classes. If that’s the case, then they can live there without trouble. However, if you have a query that’s becoming too big to fit inside a single method, rather than adding private methods to your repository class, it may make more sense to refactor it out into a query object in its own right. You can still call it via the same method on your repository class, but the repository can just defer to the query object. As I usually use decorators to cache the responses from my repository classes anyway, then it makes sense to stick with this approach to keep caching consistent too.</p><p>Query objects only really offer any value for particularly large queries. However, they can be invaluable in those circumstances. By enabling you to break those big queries up into a series of steps, they help make them easier to understand.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/03/04/how-much-difference-does-adding-an-index-to-a-database-table-make/">How Much Difference Does Adding An Index to a Database Table Make?</a></p><p><a href="/blog/2019/02/20/searching-content-with-fuse-dot-js/">Searching Content With Fuse.js</a></p><p><a href="/blog/2019/02/16/higher-order-components-in-react/">Higher-order Components in React</a></p><p><a href="/blog/2019/02/02/creating-your-own-dependency-injection-container-in-php/">Creating Your Own Dependency Injection Container in PHP</a></p><p><a href="/blog/2019/01/27/understanding-query-objects/">Understanding Query Objects</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>