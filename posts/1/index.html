<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/posts/1/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">11th March 2020 9:20 pm</p><h1><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></h1><p>A couple of years ago I posted <a href="https://matthewdaly.co.uk/blog/2018/01/12/creating-a-caching-user-provider-for-laravel/">this article</a> about constructing a caching user provider for Laravel. It worked, but with the benefit of hindsight I can now see that there were a number of issues with this solution:</p><ul><li>Because it extended the existing Eloquent user provider, it was dependent on the internals of that remaining largely the same - any change in how that worked could potentially break it</li><li>For the same reason, if you wanted to switch to a different user provider, you’d need to add the same functionality to that provider, either by writing a new provider from scratch or extending an existing one</li></ul><p>I’ve used the decorator pattern a few times in the past, and it’s a good fit for situations like this where you want to add functionality to something that implements an interface. It allows you to separate out one part of the functionality (in this case, caching) into its own layer, so it’s not dependent on any one implementation and can wrap any other implementation of that same interface you wish. Also, as long as the interface remains the same, there likely won’t be any need to change it when the implementation that is wrapped changes. Here I’ll demonstrate how to create a decorator to wrap the existing user providers.</p><p>If we only want to cache the <code>retrieveById()</code> method, like the previous implementation, the decorator class might look something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Auth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">Authenticatable</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">UserProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProviderDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@var</span> UserProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">private</span> $provider;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     * <span class="hljs-doctag">@var</span> Repository</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">private</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(UserProvider $provider, Repository $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;provider = $provider;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveById</span><span class="hljs-params">($identifier)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;remember(<span class="hljs-string">'id-'</span> . $identifier, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($identifier)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;retrieveById($identifier);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveByToken</span><span class="hljs-params">($identifier, $token)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;retrieveById($identifier, $token);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateRememberToken</span><span class="hljs-params">(Authenticatable $user, $token)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;updateRememberToken($user, $token);</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveByCredentials</span><span class="hljs-params">(array $credentials)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;retrieveByCredentials($credentials);</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateCredentials</span><span class="hljs-params">(Authenticatable $user, array $credentials)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;validateCredentials($user, $credentials);</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>}</td></tr></table></code></pre><p>It implements the same interface as the user providers, but accepts two arguments in the constructor, which are injected and stored as properties:</p><ul><li>Another instance of <code>Illuminate\Contracts\Auth\UserProvider</code></li><li>An instance of the cache repository <code>Illuminate\Contracts\Cache\Repository</code></li></ul><p>Most of the methods just defer to their counterparts on the wrapped instance - in this example I have cached the response to <code>retrieveById()</code> only, but you can add caching to the other methods easily enough if need be. You do of course still need to flush the cache at appropriate times, which is out of scope for this example, but can be handled by model events as appropriate, as described in the prior article.</p><p>Then you add the new decorator as a custom user provider, but crucially, you need to first resolve the provider you’re going to use, then wrap it in the decorator:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Gate</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Providers</span>\<span class="hljs-title">AuthServiceProvider</span> <span class="hljs-title">as</span> <span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">UserProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Auth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">EloquentUserProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">UserProviderDecorator</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * The policy mappings for the application.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * <span class="hljs-doctag">@var</span> array</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">protected</span> $policies = [</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-string">'App\Model'</span> =&gt; <span class="hljs-string">'App\Policies\ModelPolicy'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * Register any authentication / authorization services.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;registerPolicies();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        Auth::provider(<span class="hljs-string">'cached'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($app, array $config)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            $provider = <span class="hljs-keyword">new</span> EloquentUserProvider($app[<span class="hljs-string">'hash'</span>], $config[<span class="hljs-string">'model'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            $cache = $app-&gt;make(Repository::class);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UserProviderDecorator($provider, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Finally, set up the config to use the caching provider:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-string">'providers'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'users'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'cached'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'model'</span> =&gt; App\Eloquent\Models\User::class,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        ],</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    ],</td></tr></table></code></pre><p>This is pretty rough and ready, and could possibly be improved upon by allowing you to specify a particular provider to wrap in the config, as well as caching more of the methods, but it demonstrates the principle effectively.</p><p>By wrapping the existing providers, you can change the behaviour of the user provider without touching the existing implementation, which is in line with the idea of composition over inheritance. Arguably it’s more complex, but it’s also more flexible - if need be you can swap out the wrapped user provider easily, and still retain the same caching functionality.</p></article><article class="post"><p class="date">12th February 2020 10:40 pm</p><h1><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></h1><p>I’ve always been a big fan in general of tools that provide feedback about the quality of my code. The development role in which I spent the most time was one in which I had no peer feedback or mentoring at all, and while I could definitely have done with more peer review than I had, automated tools helped fill the gap a little bit. When I started building my first Phonegap app, about a year after I started programming professionally, it used <em>far</em> more Javascript than I’d ever used before, and JSLint was very helpful in instilling good practices at that early stage in my career.</p><p>In addition, I often find that using an automated tool largely eliminates the issue of ego - if your colleague Bob tells you something is a bad practice, you can potentially dismiss it as “That’s just Bob’s preferences”, whereas an automated tool is potentially much more objective. Nowadays, my typical set of static analysis tools on a project includes:</p><ul><li>ESLint</li><li>Flow</li><li>PHP CodeSniffer</li><li>Psalm</li></ul><p>However, I’m always dubious of using any static analysis tool that’s tightly integrated with a particular editor or IDE. In this post, I will explain my reasoning.</p><h1 id="in-editor-feedback">In-editor feedback</h1><p>Having instant feedback on the quality of your code is tremendously useful. Sure, you can run something like CodeSniffer from the command line and see what the problems are, but that’s nowhere near as useful as having it actually <em>in</em> your code. If you work on a legacy code base, there’s no way in hell you can wade through a long list of output in the terminal and fix them without losing the will to live. By comparison, actually seeing something flagged as an error where it actually occurs makes the mental cost of fixing it much smaller - you can see it in context, and can usually therefore resolve it more easily.</p><p>However, that doesn’t explicitly require that any one tool form an integral part of the editor. Most editors can hand off linting and static analysis to other, standalone tools, and doing so offers the following advantages:</p><ul><li>Less dependence on a given development environment - it’s always a struggle if you wind up stuck using a development environment you dislike (I grew to utterly despise Netbeans in my first role), but if you can use generic feedback tools that can be integrated with just about any editor, your team can use the development environment that suits them most, while still all benefiting from the feedback these tools provide</li><li>These tools tend to be open source, meaning you have the security of knowing that if the creator ceases maintaining it, either someone else may pick up the baton, or you can choose to fork it yourself. If a commercial IDE provider ceases trading, it’s likely you won’t be able to use their offering at all at some point in the future.</li></ul><p>Nowadays I use vim-ale in Neovim, and that provides real-time feedback for a number of linters and static analysis tools, including all those I mentioned above. I have comprehensive information on any issues in my code, and because any configuration is in simple text files that form part of the repository, it’s easy to update those settings for all developers working on the project to ensure consistency.</p><p>It’s possible that an integrated solution <em>might</em> offer a few advantages in terms of tighter integration with autocompletion and other functionality allowing for it, but whether they outweigh the tradeoffs mentioned here is dependent entirely on the implementation and how useful it is for any one team.</p><h1 id="continous-integration-to-the-rescue">Continous integration to the rescue</h1><p>There’s another issue I have with this sort of tightly integrated static analysis, which is probably the biggest, and that is that the feedback is available only at the level of an individual developer, not the team.</p><p>It’s great providing all this feedback to developers, but what if they just ignore it? Not all developers have had the sort of experience that leads one to really appreciate the value of coding standards and type hints, particularly if they’ve worked primarily on small or greenfield projects, or in environments where the emphasis was on churning out large quantities of work, and getting developers to tidy up the sort of issues these tools identify can sometimes be a tough sell when faced with code which, at least superficially, works.</p><p>Suppose you take on a new developer and ask them to work alone on a particular project for several months. Due to your own workload you can’t easily schedule code reviews with them, so you don’t see what they’re writing until they’re done. Then you take a look at what they’ve written and it’s full of issues that the IDE caught, but the developer either didn’t bother to fix, or didn’t know how to. What they’ve done may well work, but they’ve introduced a huge morass of technical debt that will slow down future development for the foreseeable future.</p><p>If your static analysis tools work only in the context of a given editor or IDE, then if the new dev introduce issues in the code base and doesn’t resolve them because they don’t know how, or don’t see the value, then the first you knows about it is when you clone the repo yourself and open it up. With a solution that runs in a CI environment, you can catch any reduction in code quality when it’s pushed. Sure, code reviews can do that too, but that requires manual input in a way that not every team is willing to spare, whereas a CI server, once set up, is largely self sustaining. And you could run one tool locally and another in a CI environment, but you can’t be sure they’ll necessarily catch all the same issues.</p><p>Now consider the same scenario if you’re using a separate code quality tool that’s integrated both into the editor, and your continuous integration workflow. Obviously, it will depend on your personal CI setup, but once code quality either begins to drop, or drops below a given level, the CI server will mark the build as failed, and you’ll be alerted. You can therefore then raise the issue with the new dev before it gets out of hand, and provide whatever support they need to resolve the problem there and then.</p><p>I personally maintain a legacy project in which, at one point prior to my arrival, a junior dev introduced an enormous amount of technical debt after working on it alone for six months. An integrated linter or static analysis tool probably wouldn’t have stopped that from happening, for the reasons stated above, but if a similar tool were part of the CI workflow, it could have been flagged as an issue much earlier and dealt with. Yes, leaving a junior dev unsupported and unsupervised for that length of time isn’t a great idea, but it happens, particularly in busy environments such as agencies. A good CI setup lets you see if someone is adding these kinds of issues, and act to nip it in the bud before it becomes too much of a problem, which is ultimately good for that developer’s career.</p><p>Peer pressure can also be a strong motivating factor under these circumstances. By simply displaying a metric, you encourage people’s natural competitiveness, so displaying code quality stats in your CI dashboard will encourage your team to do better in this regard, and no-one wants to be visibly seen to be letting the team down by producing substandard code.</p><p>For these reasons, where possible for feedback on code quality, I would always prefer to rely on a standalone tool that can be integrated with an editor, or used as part of a continuous integration workflow, as opposed to any IDE-specific functionality.</p></article><article class="post"><p class="date">9th February 2020 10:10 am</p><h1><a href="/blog/2020/02/09/don&#x27;t-use-stdclass/">Don&#x27;t Use Stdclass</a></h1><p>The digital agency I work for specialises in marketing, so some of my work tends to relate to mailing lists. This week I was asked to look at an issue on a Laravel-based export system built by a co-worker who left a few months ago. This particular application pulled data from the Campaign Monitor API about campaigns, and it returned the data as instances of <code>stdClass</code>, something that I’m not terribly happy about.</p><p>Now, this was an implementation detail of the Campaign Monitor PHP SDK, which is old and creaky (to say the least…) and doesn’t exactly abide by modern best practices. However, the legacy application I maintain also does this (there’s a <em>lot</em> of stuff that needs sorting out on it, and sadly replacing the <code>stdClass</code> instances is a <em>long</em> way down the list), so I thought it was an interesting subject for a blog post. I consider using <code>stdClass</code>, even just as a dumb container for data, to be an antipattern, and I thought it would be useful to explain my thoughts on this.</p><h1 id="why-shouldn-t-i-use-stdclass-">Why shouldn’t I use stdClass?</h1><h2 id="readability">Readability</h2><p>One of the first things I learned about throwing exceptions is that they should be meaningful. It’s trivial to define a named exception and use that to specify the type of exception, and you can then capture exceptions to handle them differently elsewhere in the application. For instance, a validation error is entirely due to a user submitting the wrong details, and should therefore be handled in an entirely different manner to the database going down.</p><p>The same is applicable to an object. If an API client returns an instance of <code>stdClass</code>, that doesn’t tell me anything about what that object is. If I need to pass it elsewhere in a large application, it may become very difficult to understand what it represents without tracking it back to where it came from, which will slow me down. If instead I use a named class, the name can convey what it represents. It may seem like overkill to create a class that adds no new functionality, but the mere fact that it has a name makes your code more meaningful and easier to understand. I can also add DocBlock comments to describe it further.</p><p>Of course, just giving something a generic name like <code>Container</code> isn’t much of an improvement, and coming up with meaningful names for classes and methods is notoriously hard. As always, give some serious thoughts into what your objects represent and attempt to give them names that will make it easy to understand what they are if you look at the code base again six months down the line.</p><h2 id="type-hinting">Type hinting</h2><p>A related argument is that it makes type hinting more useful. You <em>can</em> type hint <code>stdClass</code>, but as noted above it tells someone working on the code receiving it very little about where it’s come from, or what it represents, and it doesn’t offer much value since an <code>stdClass</code> could mean anything, and could be created anywhere in the appication.</p><p>By contrast, named classes provides much more information about what the type hinted parameter represents. For instance, naming your class something such as <code>App\Api\Response\Item</code>, makes it much clearer that that object represents an individual item returned from an API, and others developers working on the same code base (including your future self, who may not necessarily remember all of the details of how you’re implementing it now), will have less trouble understanding what is going on. There’s also a much-reduced likelihood of the same class being used to represent completely different types of data.</p><h2 id="new-functionality">New functionality</h2><p>Finally, are you sure you don’t want to add any functionality? PHP includes a number of interfaces that can be <em>extremely</em> useful for working with this sort of data.</p><p>First off, the <code>ArrayAccess</code> interface allows you to access an object’s values using array syntax, which can be useful. Also, implementing either <code>Iterator</code> or <code>IteratorAggregate</code> will allow you to iterate over the object using a <code>foreach</code> loop. The <code>Countable</code> interface is less useful, since all it does is let you get the number of items, but it’s sometimes handy. Finally, the <code>Serializable</code> interface lets you serialize an object so it can be stored in a suitable medium, which can sometimes be useful.</p><p>The same also applies to some of the magic methods. The <code>__toString()</code> method, in particular, can be useful for returning a suitable string-based representation of an object - for instance, if it represents an item in a database, it might be appropriate to use this to return the ID of the item, or a text representation of it (eg title for a blog post, or product name for a product in an e-commerce site). The <code>__get()</code> and <code>__set()</code> magic methods may be a bit more dubious, but they can be useful if your object is intended to just be a dumb container as they allow you to make the properties on the object private, but keep them accessible without writing explicit getters and setters. I’d also suggest adding <code>__debugInfo()</code> to objects unless you have a good reason not to, as when you’re debugging it can be hard to see the wood for the trees, and returning only the most pertinent data can make your job a <em>lot</em> easier.</p><p>Of course, you don’t have to implement all this functionality from scratch for every class. It often makes sense to create an abstract class that implements this sort of basic container functionality, and then base all your container classes on that, overriding it when necessary.</p><h2 id="summary">Summary</h2><p>Hopefully, this has made it clear how compelling it is to use named classes instead of <code>stdClass</code>, and how much benefit you can get from not just using named classes, but creating your own base container class for them. I’m of the opinion that PHP should probably make <code>stdClass</code> abstract to prevent them from being used like this, and indeed I’m seriously considering the idea of creating a Codesniffer sniff to detect instances of <code>stdClass</code> being instantiated and raise them as an error.</p></article><article class="post"><p class="date">25th January 2020 10:25 pm</p><h1><a href="/blog/2020/01/25/f***-phpstorm-man-and-the-high-horse-he-rode-in-on/">F*** Phpstorm Man and the High Horse He Rode in on</a></h1><p>There’s a particularly unpleasant type of programmer that exists, and you’ve probably met him, either online or in person. I call him <strong>PHPStorm Man</strong>.</p><p>NB: Despite the name I’ve chosen, I’m not singling out users of PHPStorm in particular about this. The first time I encountered PHPStorm Man in person, he was using Sublime Text, and you will find PHPStorm Men using all different editors and IDEs. PHPStorm Man is an archetype defined not by any particular piece of software, but by a common bad attitude, and given that I work primarily with PHP these days, I’ve most often encountered this kind of behaviour from PHPStorm users (or at least, people claiming to be PHPStorm users, since at least online you can’t discount the possibility that they’re trolls). Users of other languages may well see this behaviour most prominently from those who use some other editor or IDE, but the same underlying phenomenon is at work, whether we call him PHPStorm Man, Eclipse Man, Vim Man or PyCharm Man.</p><h2 id="who-is-phpstorm-man-">Who is PHPStorm Man?</h2><p><img src="/static/images/phpstorm-man.jpg" alt="The hero we really, really don&#39;t need"></p><p>PHPStorm Man (and he <em>will</em> almost certainly be a man - while it could be just because our industry is male-dominated, I’ve <em>never</em> known a woman to behave like this, and I strongly suspect it’s nothing more than an industry-specific example of the common phenomenon of <a href="https://en.wikipedia.org/wiki/Mansplaining">mansplaining</a>) doesn’t know squat about your editor or IDE. He just knows his is superior, and he wants you to know it, regardless of the evidence.</p><p>His knowledge of your editor is probably either non-existent, grossly outdated, plain ill-informed or second-hand (probably from another PHPStorm Man). If he’s advocating an IDE, he’ll likely equate all text editors with Notepad - he may claim the advantages of his one over yours include such fundamentals as syntax highlighting and autocompletion.</p><p>He’ll boast about some feature his editor has that yours doesn’t, even if it does. If your editor lacks that functionality out of the box, but can add it via a plugin, apparently that doesn’t count because although you’re intelligent enough to build a working web app, somehow installing and configuring that plugin is an insurmountable burden (yet mysteriously turning off all the stuff you don’t need in <em>his</em> editor is quick and easy). If it does do that out of the box, he’ll probably find some bullshit reason why his editor’s implementation is better, even if it’s something as pointless and irrelevant as “it’s been around longer”. He’ll likely claim, with absolutely no evidence whatsoever, or indeed in the presence of evidence to the contrary, that you’d be more productive if you only used his editor.</p><p>In short, if you aren’t using his editor or IDE of choice, you’re a troglodyte living in a dung hut.</p><h2 id="phpstorm-man-in-the-wild">PHPStorm man in the wild</h2><p>I had an encounter with PHPStorm Man in person a while back. Just over two years ago I started a new job, which as it turned out didn’t last long after I caught the flu that was going around in late 2017 my first week. On the second day, shortly after going over something with me, the senior dev sent me the following message on Slack:</p><blockquote><p>I noticed you’re using Vim. Have you tried using Sublime Text?</p></blockquote><p>I responded that I had, and chose not to use it. There followed a long string of messages along the following lines:</p><blockquote><p>Him: Sublime Text has X!</p></blockquote><blockquote><p>Me: I have that</p></blockquote><blockquote><p>Him: Well Sublime Text also has Y!</p></blockquote><blockquote><p>Me: I have that too, via a plugin</p></blockquote><blockquote><p>Him: Well, Sublime Text doesn’t need a plugin for that</p></blockquote><blockquote><p>Me: Irrelevant since the plugin is already installed and configured, and I know how to use it</p></blockquote><blockquote><p>Him: Well, what about this?</p></blockquote><blockquote><p>Me: That sounds cool, so I just found a plugin to do that and installed it</p></blockquote><blockquote><p>Him: And this?</p></blockquote><blockquote><p>Me: I have absolutely no need for that</p></blockquote><blockquote><p>Him: Well, Vim is old, Sublime Text is new!</p></blockquote><blockquote><p>Me: Actually, this is Neovim, which is technically newer than Sublime Text</p></blockquote><blockquote><p>Him: Well, Sublime Text is a GUI application</p></blockquote><blockquote><p>Me: Exactly. That makes it slower and forces me to use the mouse, aggravating my RSI. I use the terminal because it’s more efficient</p></blockquote><blockquote><p>Him: Well, I don’t mind what you use…(despite the evidence of that entire conversation)</p></blockquote><p>With the benefit of hindsight, what I <em>should</em> have responded with was this:</p><blockquote><p>I’m an experienced, professional web developer of over six years, and I chose my editor based on years of personal experience, and have chosen my plugins and configuration based on what’s useful to me, and continue to do so to this day. I don’t appreciate you talking down to me like a child.</p></blockquote><h2 id="why-i-personally-don-t-use-an-ide">Why I personally don’t use an IDE</h2><p>In my case, I have a particularly good reason not to use <em>any</em> GUI application to develop in. Before I was a developer, I worked for an insurance company in a customer service role, and I didn’t have access to the sort of decent quality keyboards and mice developers habitually use, as well as having output goals linked to discipline and bonus/salary raises and having to use custom internal applications on Windows XP, with dreadful keyboard support. As a result I developed a degree of RSI in both hands, which I’ve found is aggravated by using any application that requires me to use a mouse extensively - I’m generally OK if I only have to type, but reaching for the mouse all the time quickly becomes tiring, and soon after painful.</p><p>For that reason I’ve developed a workflow that’s strongly dependent on the command line - I use Neovim in the terminal, alongside Byobu so that I can run multiple tabs and switch between them quickly without touching the mouse. Moving to a more GUI-oriented workflow would require me to use the mouse more than I do now, which would probably become physically painful quite quickly. Using an editor or IDE which I found made me more prone to further flare-ups of RSI could have serious consequences for my long-term health, and could potentially be career-ending. If I worked somewhere that mandated a particular IDE that didn’t work well for me, I’d <em>have</em> to either negotiate an exception on health and safety grounds or quit.</p><p>I’m also of the personal opinion that much of the functionality of an IDE should not be, in principle, tied to that IDE, but should instead be the province of more general purpose tools that can used, not merely in any editor or IDE but, where appropriate, on a continuous integration server. For instance, language servers provide a tool-agnostic way for any IDE or editor to implement functionality such as completion or navigation, and linters such as ESLint can integrate into any half-decent editor or run in a CI environment. Since these tend to be open source projects, whereas IDE’s are normally commercial offerings, they’re less vulnerable to suddenly disappearing and leaving users high and dry.</p><p>There’s also a lot of functionality in an IDE that I rarely, if ever, use. There’s no point including and starting up an FTP client as part of my editor if I’m never going to use it, as it slows the application down, and nor should I have to root around trying to turn off functionality I’m never going to have to use. For a lot of other functionality, there are more powerful standalone applications that I’m used to such as Postman or MySQL Workbench, and I’ll use them as and when I need them - I gain nothing by having them integrated with my editor.</p><p>I also like to be able to use the same editor everywhere. I still occasionally dabble in Python, so a language-specific IDE wouldn’t be suitable when switching between languages. I also sometimes work on personal projects on an HP Stream netbook running Xubuntu, which is fine for small PHP projects that don’t require a database server or any web server other than the PHP dev server. I can happily run Neovim on that, but there’s no way it could run an IDE at an acceptable speed.</p><p>Last of all, screen real estate is an issue. I don’t like interfaces that are too busy - I <em>cannot stand</em> having anything, <em>at all</em> on my desktop for any length of time at all, and any interface that has too much on screen at once is distracting. I will typically have Neovim open in a terminal, with the NERDTree file finder open on the left, and two panels split in the main body, and that’s all. A big factor in my productivity is how much code I can see at once, and having too much screen real estate taken up by menus and sidebars is counterproductive - with Neovim there’s almost nothing getting in the way.</p><p>I personally have had to give this sort of explanation many, many times as to why I use first Vim and then Neovim, and indeed part of the motivation behind writing this post is that I’m sick to death of having to explain myself over and over again and will now be able to merely direct them to this article. Thanks to tools like PHPActor, vim-ale and FZF, I don’t feel like there’s anything I’m missing out on that an IDE would give me, and Psalm is very good at catching type errors without being tied to any one IDE, but that doesn’t stop people telling me I’m missing out on features I already have. Any time I come across a feature I think is cool, I go through the following process:</p><ul><li>Find cool feature</li><li>Find plugin that implements said feature</li><li>Install plugin by adding a single line to my Neovim config and running <code>:PlugUpdate</code></li><li>Add a few lines of config</li><li>Start using feature</li></ul><p>Using an IDE <em>would</em> eliminate the middle three steps, but I don’t find those onerous - we’re talking about the work of five minutes, which is insignificant compared to the time taken to learn to use the feature effectively. And a feature you don’t use is one that you still have to start up if it’s present, so making it an opt-in plugin is often a better way to go.</p><p>Every other developer will have their own version of this story. Some will have stayed mostly static in their editor choices, while others will be changing all the time - indeed, I’ve sometimes used other editors for specific tasks in the past. In short, everyone has their own reasons for using their editor of choice, and it’s <em>appallingly</em> arrogant to assume that their reasons for using a particular one are less valid than yours.</p><h2 id="am-i-phpstorm-man-">Am I PHPStorm Man?</h2><p>As I’ve said before, this behaviour is not confined to PHPStorm users, nor is it in any way universal among them. If you use PHPStorm and enjoy it, then fine, rock on. If you use a different editor or IDE, then that’s fine too - I don’t have a problem with that, and nor should your colleagues or line manager. Using any one editor or IDE <em>does not</em> make you PHPStorm Man. What makes you PHPStorm Man is the patronising attitude.</p><p>In the example given above, what made the senior dev PHPStorm Man was not the initial enquiry as to whether I’d tried Sublime Text, but the fact that he wouldn’t leave it be when confronted with evidence that I either had, could easily obtain, or didn’t need the functionality of his editor in mine, and that he was talking down to an experienced developer like a child.</p><p>Obviously, this isn’t a new development - editor wars have long been a feature of our industry, as has the divide between IDE and editor users. But that doesn’t mean I, and no doubt others, don’t get utterly sick of it.</p><h2 id="how-not-to-be-phpstorm-man">How not to be PHPStorm Man</h2><p>When talking to users of other editors or IDE’s about the subject of those tools, you should always bear this in mind:</p><ul><li>If they use a different tool to you, they probably know a hell of a lot more about it than you do, and are unlikely to take kindly to you ignorantly telling them what it can and can’t do</li><li>Mastering an editor or IDE can take years, and if they’re already invested in one, it’s incredibly arrogant to just assume that they’re less productive in it than they would be in yours - even if they would (and that’s almost certainly debatable), it would take some time to adjust.</li><li>They’ve probably had this conversation many times before, and are sick of hearing it, especially if they have a few years experience under their belt</li><li>Not every feature you use is useful to them</li><li>No-one minds seeing a cool feature, so feel free to demonstrate it, but bear in mind that it’s almost certainly not limited to that platform - if it’s suffficiently cool, someone <em>will</em> have made it available as a plugin on most of the major editors and IDE’s. If they like it, the most likely scenario is that they’ll look to add that feature to their own editor via a plugin</li><li>Just because it makes you more productive, doesn’t mean that it would make them more productive</li><li>It’s perfectly possible to enforce consistent code styles and catch errors using standalone tools such as PHP CodeSniffer, Psalm, or ESLint, and these tools can be integrated in <em>any</em> editor, triggered with Git hooks, or run with continuous integration.</li></ul><p>Now, it has to be said that sometimes there <em>are</em> some people who plod on with painfully outdated tools, like Notepad. But those tools tend to be limited to either commercial offerings that are no longer mainained or supported, or ones that lack any sort of plugin or extension system, making them limited in terms of how they can integrate with other services, so they’re fairly easy to spot. However, making a particular editor or IDE compulsory is going to be disruptive. If you’re in a leadership position, one way to resolve this is to simply require that everyone’s editor have certain functionality - for instance, if you specify that everyone’s editor must allow integration with PHP CodeSniffer and support for <code>.editorconfig</code>, then anyone using a legacy editor that can’t support those will need to move away from it, but they’ll be able to pick one that suits them, rather than be forced into one they may well dislike. Editors and IDE’s don’t produce proprietary formats the way word processors do - they work with common formats, and if prominent open-source projects can enforce a consistent coding standard with many different editors there’s absolutely no reason why your colleagues can’t do so too,</p><h2 id="summary">Summary</h2><p>This post is a bit of an angry rant, but at the same time it shouldn’t be taken <em>too</em> seriously. As I said, despite the name <em>PHPStorm Man</em>, it’s not specifically about users of any one editor or IDE, but about the widespread, patronising attitude many developers have about editors and IDE’s other than their own in general.</p><p>Someone using a different IDE or editor is absolutely none of your business unless you’re their line manager or you work on the same code base, and even then it should only be an issue if it causes a clear effect on their productivity or the quality of their code. If that’s not the case, keep your nose out.</p></article><article class="post"><p class="date">27th October 2019 9:20 pm</p><h1><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></h1><p>Like many developers who use React.js, I’ve been eager to explore the Hooks API in the last year or so. They allow for easier ways to share functionality between components, and can allow for a more expressive syntax that’s a better fit for Javascript than class-based components. Unfortunately, they became production ready around the time I rolled out a new React-based home page, so I didn’t want to jump on them immediately in the context of a legacy application. I’m now finding myself with a bit of breathing space, so I’ve begun refactoring these components, and converting some to use hooks, in order to more easily reuse some code that currently resides in a big higher-order component.</p><p>The <code>useState</code> and <code>useEffect</code> hooks are by far the most common hooks in most applications. However, I’ve found that the React documentation, while OK at explaining how to use these individually, is not so good at explaining how to use them together, particularly in the case of an input component, which is a common use case when looking to convert existing components. For that reason, I’m going to provide a short example of how you might use them together for that use case.</p><h2 id="a-simple-function-component">A simple function component</h2><p>A basic component for an input might look like this:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>//@flow</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">type</span> Props = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-type">name</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  id: string,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">value</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  placeholder: string</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>const Input = (props: Props) =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>="text" <span class="hljs-type">name</span>={props.name} id={props.id} <span class="hljs-keyword">value</span>={props.<span class="hljs-keyword">value</span>} placeholder={props.placeholder} /&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>export <span class="hljs-keyword">default</span> <span class="hljs-keyword">Input</span>;</td></tr></table></code></pre><p>Note I’m using Flow annotations to type the arguments passed to my components. If you prefer Typescript it should be straightforward to convert to that.</p><p>As you can see, this component accepts a name, ID, value and placeholder as props. If you add this to an existing React app, or use <code>create-react-app</code> to create one and add this to it, you can include it in another component as follows:</p><pre><code class="hljs lang-jsx singleline">&lt;Input <span class="hljs-attribute">name</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attribute">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attribute">value</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attribute">placeholder</span>=<span class="hljs-string">"foo"</span> /&gt;</code></pre><h2 id="adding-state">Adding state</h2><p>This will render, but as the value will never change it’s not actually of any use in a form. If you’ve written class-based React components before, you’ll know that the usual way to handle this is to move the value of the input from props to state. Prior to the introduction of the Hooks API, while you could create a function component, you couldn’t use state with it, making situations like this difficult to handle. Fortunately, the <code>useState</code> hook now allows you to add state to a function component as follows:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>//@flow</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">type</span> Props = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-type">name</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  id: string,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">value</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  placeholder: string</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>const Input = (props: Props) =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  const [<span class="hljs-keyword">value</span>, setValue] = useState(props.<span class="hljs-keyword">value</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>="text" <span class="hljs-type">name</span>={props.name} id={props.id} <span class="hljs-keyword">value</span>={<span class="hljs-keyword">value</span>} placeholder={props.placeholder} onChange={(e) =&gt; setValue(e.target.<span class="hljs-keyword">value</span>)} /&gt;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>export <span class="hljs-keyword">default</span> <span class="hljs-keyword">Input</span>;</td></tr></table></code></pre><p>We import the <code>useState</code> hook at the top, as usual. Then, within the body of the component, we call <code>useState()</code>, passing in the initial value of <code>props.value</code>, and get back two variables in response:</p><ul><li><code>value</code> is the value of the state variable, and can be thought of as equivalent to what <code>this.state.value</code> would be in a class-based component</li><li><code>setValue</code> is a function for updating <code>value</code> - rather than explicitly defining a function for this, we can just get one back from <code>useState()</code></li></ul><p>Now we can set the value with <code>value={value}</code>. We also need to handle changes in the state, so we add <code>onChange={(e) =&gt; setValue(e.target.value)}</code> to call <code>setValue()</code> on a change event on the input.</p><h2 id="handling-effects">Handling effects</h2><p>The component will now allow you to edit the value. However, one problem remains. If you open the React dev tools, go to the props for this component, and set <code>value</code> manually, it won’t be reflected in the input’s value, because the state has diverged from the initial value passed in as a prop. We need to be able to pick up on changes in the props and pass them through as state.</p><p>In class-based components, there are lifecycle methods that fire at certain times, such as <code>componentDidMount()</code> and <code>componentDidUpdate()</code>, and we would use those to handle that situation. Hooks condense these into a single <code>useEffect</code> hook that is more widely useful. Here’s how we might overcome this problem in our component:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>//@flow</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">type</span> Props = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-type">name</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  id: string,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">value</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  placeholder: string</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>const Input = (props: Props) =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  const [<span class="hljs-keyword">value</span>, setValue] = useState(props.<span class="hljs-keyword">value</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  useEffect(() =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    setValue(props.<span class="hljs-keyword">value</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  }, [props.<span class="hljs-keyword">value</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>="text" <span class="hljs-type">name</span>={props.name} id={props.id} <span class="hljs-keyword">value</span>={<span class="hljs-keyword">value</span>} placeholder={props.placeholder} onChange={(e) =&gt; setValue(e.target.<span class="hljs-keyword">value</span>)}/&gt;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>export <span class="hljs-keyword">default</span> <span class="hljs-keyword">Input</span>;</td></tr></table></code></pre><p><code>useEffect</code> takes one compulsory argument, in the form of a callback. Here we’re using that callback to set our state variable back to the value of the prop passed through.</p><p>Note the second argument, which is an array of variables that should be watched for changes. If we had used the following code instead:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  useEffect(() =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    setValue(<span class="hljs-name">props</span>.value)<span class="hljs-comment">;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  })<span class="hljs-comment">;</span></td></tr></table></code></pre><p>Then the callback would fire after every render, reverting the value back and possibly causing an infinite loop. For that reason, we pass through the second argument, which tells React to only fire the callback if one of the specified variables has changed. Here we only want to override the state when the value props passed down to the component changes, so we pass that prop in as an argument.</p><h2 id="summary">Summary</h2><p>This is only a simple example, but it does show how simple and expressive hooks can make your React components, and how to use the <code>useEffect</code> and <code>useState</code> hooks together, which was something I found the documentation didn’t make clear. These two hooks cover a large chunk of the functionality of React, and knowledge of them is essential to using React effectively.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></p><p><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></p><p><a href="/blog/2020/02/09/don&#x27;t-use-stdclass/">Don&#x27;t Use Stdclass</a></p><p><a href="/blog/2020/01/25/f***-phpstorm-man-and-the-high-horse-he-rode-in-on/">F*** Phpstorm Man and the High Horse He Rode in on</a></p><p><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2020.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>