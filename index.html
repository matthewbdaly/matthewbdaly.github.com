<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">2nd January 2019 11:00 pm</p><h1><a href="/blog/2019/01/02/why-bad-code-is-bad/">Why Bad Code Is Bad</a></h1><p>This may sound a little trite, but why is it bad to write bad code?</p><p>Suppose you’re a client, or a line manager for a team of developers. You work with developers regularly, but when they say that a code base is bad, what are the consequences of that, and how can you justify spending time and money to fix it? I’ve often heard the refrain “If it works, it doesn’t matter”, which may have a grain of truth, but is somewhat disingenuous. In this post, I’ll explain some of the consequences when your code base is bad. It can be hard to put a definitive price tag on the costs associated with delivering bad code, but this should give some idea of the sort of issues you should take into account.</p><h1 id="bad-code-kills-developer-productivity">Bad code kills developer productivity</h1><p>Bad code is harder to understand, navigate and reason about than good code. Developers are not superhuman, and we can only hold so much in our heads at one time, which is why many of the principles behind a clean and maintainable code base can essentially be boiled down to “break it into bite-sized chunks so developers can understand each one in isolation before seeing how they fit together”.</p><p>If one particular class or function gets too big and starts doing too much, it quickly becomes very, very hard to get your head around what that code does. Developers typically have to build a mental model of how a class or function works before they can use it effectively, and the smaller and simpler you can keep each unit of code, the less time and effort it takes to do so. The mark of a skilled developer is not the complexity of their code bases, but their simplicity - they’ve learned to make their code as small, simple, and readable as possible. A clean and well laid-out code base makes it easy for developers to get into the mental state called “flow” that is significantly more productive.</p><p>In addition, if an application doesn’t conform to accepted conventions in some way, such as using inappropriate HTTP verbs (eg <code>GET</code> to change the state of something), then quite apart from the fact that it won’t play well with proxy servers, it imposes an additional mental load on developers by forcing them to drop a reasonable set of assumptions about hot the application works. If the application used the correct HTTP verbs, experienced developers would know without being told that to create a new report, you’d send a <code>POST</code> request to the <code>reports</code> API endpoint.</p><p>During the initial stages of a project, functionality can be delivered quite quickly, but if the code quality is poor, then over time developer velocity can decrease. Ensuring a higher quality code base helps to maintain velocity at a consistent level as it gets bigger. This also means estimates will be more accurate, so if you quote a given number of hours for a feature, you’re more likely to deliver inside that number of hours.</p><h1 id="bad-code-is-bad-for-developer-welfare">Bad code is bad for developer welfare</h1><p>A code base that’s repetitive, badly organised, overly complex and hard to read is a recipe for stressed developers, making burnout more likely. If a developer suffers burnout, their productivity will drop substantially.</p><p>In the longer term, if developer burnout isn’t managed correctly, it could easily increase developer turnover as stressed developers quit. It’s also harder to recruit new developers if they’re faced with the prospect of dealing with a messy, stressful code base.</p><h1 id="bad-code-hampers-your-ability-to-pivot">Bad code hampers your ability to pivot</h1><p>If the quality of your code base is poor, it can mean that if functionality needs to be changed or added, then more work is involved. Repetitive code can mean something has to be updated in more than one place, and if it becomes too onerous, it can make it too time-consuming or expensive to justify the changes.</p><h1 id="bad-code-may-threaten-the-long-term-viability-of-your-project">Bad code may threaten the long-term viability of your project</h1><p>One thing that is certain in our industry is that things change. Libraries, languages and frameworks are constantly being updated, and sometimes there will be potentially breaking changes to some of these. On occasion, a library or framework will be discontinued, making it necessary to migrate to a replacement.</p><p>Bad code is often tightly coupled to a particular framework or library, and sometimes even to a particular version, making it harder to migrate if it becomes necessary. If a project was written with a language or framework version that had a serious issue, and was too tightly coupled to migrate to a newer version, it might be too risky to keep it running, or it might be necessary to run an insecure application in spite of the risks it posed.</p><h1 id="bad-code-is-more-brittle">Bad code is more brittle</h1><p>A poor code base will break, a lot, and often in ways that are clearly visible to end users. Duplicate code makes it easy to miss cases where something needs to be updated in more than one place, and if the code base lacks tests, a serious error may not be noticed for a long time, especially if it’s something comparatively subtle.</p><h1 id="bad-code-is-hard-if-not-impossible-to-write-automated-tests-for">Bad code is hard, if not impossible, to write automated tests for</h1><p>If a particular class or function does too much, it becomes <em>much</em> harder to write automated tests for it because there are more variables going in and more expected outcomes. A sufficiently messy code base may only really be testable by automating the browser, which tends to be very slow and brittle, making test-driven development impractical. Manual testing is no substitute for a proper suite of automated tests, since it’s slower, less consistent and not repeatable in the same way, and it’s only sufficient by itself for the most trivial of web apps.</p><h1 id="bad-code-is-often-insecure">Bad code is often insecure</h1><p>A bad code base may inadvertently expose user’s data, or be at risk from all kinds of attacks such as cross-site scripting and SQL injection attacks that can also potentially expose too much data.</p><p>For any business with EU-based users, the risks of exposing user’s data are very serious. Under the GDPR, there’s a potential fine of up to &euro;20 million, or 4% of turnover. That’s potentially an existential risk for many companies.</p><p>In addition, a bad code base is often more vulnerable to denial-of-service attacks. If it has poor or no caching, excessive queries, or inefficient queries, then every time a page loads it will carry out more queries than a more optimised site would. Given the same servers specs, the inefficient site will be overwhelmed quicker than the efficient one.</p><h1 id="summary">Summary</h1><p>It’s all too easy to focus solely on delivering a working product and not worry about the quality of the code base when time spent cleaning it up doesn’t pay the bills, and it can be hard to justify the cost of cleaning it up later to clients.</p><p>There are tools you can use to help keep up code quality, such as linters and static analysers, and it’s never a bad idea to investigate the ones available for the language(s) you work in. For best results they should form part of your continuous integration pipeline, so you can monitor changes over time and prompt developers who check in problematic code to fix the issues. Code reviews are another good way to avoid bad code, since they allow developers to find problematic code and offer more elegant solutions.</p><p>I’m not suggesting that a code base that has a few warts has no value, or that you should sink huge amounts of developer time into refactoring messy code when money is tight, as commercial concerns do have to come first. But a bad code base does cause serious issues that have financial implications, and it’s prudent to recognise the problems it could cause, and take action to resolve them, or better yet, prevent them occurring in the first place.</p></article><article class="post"><p class="date">27th December 2018 6:37 pm</p><h1><a href="/blog/2018/12/27/improving-search-in-vim-and-neovim-with-fzf-and-ripgrep/">Improving Search in Vim and Neovim With FZF and Ripgrep</a></h1><p>A while back I was asked to make some changes to a legacy project that was still using Subversion. This was troublesome because my usual method of searching in files is to use Tim Pope’s Fugitive Vim plugin as a frontend for <code>git grep</code>, and so it would be harder than usual to navigate the project. I therefore started looking around for alternative search systems, and one combination that kept on coming up was FZF and Ripgrep, so I decided to give them a try. FZF is a fuzzy file finder, written in Go, while Ripgrep is an extremely fast grep, written in Rust, that respects gitignore rules by default. Both have proven so useful they’re now a permanent part of my setup.</p><p>On Mac OS X, both are available via Homebrew, so they’re easy to install. On Ubuntu, Ripgrep is in the repositories, but FZF isn’t, so it was necessary to install it in my home directory. There’s a <a href="https://github.com/junegunn/fzf.vim">Vim plugin for FZF and Ripgrep integration</a>, which, since I use vim-plugged, I could install by adding the following to my <code>init.vim</code>, then running <code>PlugUpdate</code> from Neovim:</p><pre><code class="hljs lang-viml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-string">" Search</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Plug '~/.fzf'</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Plug 'junegunn/fzf.vim'</td></tr></table></code></pre><p>The plugin exposes a number of commands that are very useful, and I’ll go through the ones I use most often:</p><ul><li><code>:Files</code> is for finding files by name. I used to use Ctrl-P for this, but FZF is so much better and quicker that I ditched Ctrl-P almost immediately (though you can map <code>:Files</code> to it if you want to use the same key).</li><li><code>:Rg</code> uses Ripgrep to search for content in files, so you can search for a specific string. This makes it an excellent replacement for the <code>Ggrep</code> command from Fugitive.</li><li><code>:Snippets</code> works with Ultisnips to provide a filterable list of available snippets you can insert, making it much more useful</li><li><code>:Tags</code> allows you to filter and search tags in the project as a whole</li><li><code>:BTags</code> does the same, but solely in the current buffer</li><li><code>:Lines</code> allows you to find lines in the project and navigate to them.</li><li><code>:BLines</code> does the same, but solely in the current buffer.</li></ul><p>In addition to being useful in Neovim, FZF can also be helpful in Bash. You can use <code>Ctrl-T</code> to find file paths, and it enhances the standard <code>Ctrl-R</code> history search, making it faster and more easily navigable. The performance of both is also excellent - they work very fast, even on the very large legacy project I maintain, or on slower machines, and I never find myself waiting for them to finish. Both tools have quickly become an indispensible part of my workflow.</p></article><article class="post"><p class="date">6th December 2018 6:34 pm</p><h1><a href="/blog/2018/12/06/decorating-service-classes/">Decorating Service Classes</a></h1><p>I’ve written before about using decorators to extend the functionality of existing classes, in the context of the repository pattern when working with Eloquent. However, the same practice is applicable in many other contexts.</p><p>Recently, I was asked to add RSS feeds to the home page of the legacy project that is my main focus these days. The resulting service class looked something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Rss</span>\<span class="hljs-title">Feed</span>\<span class="hljs-title">Reader</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">FeedFetcher</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RssFetcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeedFetcher</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> Reader::import($url);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></tr></table></code></pre><p>In accordance with the principle of loose coupling, I also created an interface for it:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FeedFetcher</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>}</td></tr></table></code></pre><p>I was recently able to add dependency injection to the project using PHP-DI, so now I can inject an instance of the feed fetcher into the controller by typehinting the interface and having it resolve to the <code>RssFetcher</code> class.</p><p>However, there was an issue. I didn’t want the application to make multiple HTTP requests to fetch those feeds every time the page loads. At the same time, it was also a bit much to have a scheduled task running to fetch those feeds and store them in the database, since many times that would be unnecessary. The obvious solution was to cache the feed content for a specified length of time, in this case five minutes.</p><p>I <em>could</em> have integrated the caching into the service class itself, but that wasn’t the best practice, because it would be tied to that implementation. If in future we needed to switch to a different feed handler, we’d have to re-implement the caching functionality. So I decided it made sense to decorate the service class.</p><p>The decorator class implemented the same interface as the feed fetcher, and accepted another instance of that interface in the constructor, along with a PSR6-compliant caching library. It looked something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">FeedFetcher</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">CacheItemPoolInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FetcherCachingDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeedFetcher</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $fetcher;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(FeedFetcher $fetcher, CacheItemPoolInterface $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fetcher = $fetcher;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;cache-&gt;getItem(<span class="hljs-string">'feed_'</span>.$url);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">if</span> (!$item-&gt;isHit()) {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            $item-&gt;set(<span class="hljs-keyword">$this</span>-&gt;fetcher-&gt;fetch($url));</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-keyword">$this</span>-&gt;cache-&gt;save($item);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get();</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>}</td></tr></table></code></pre><p>Now, when you instantiate the feed fetcher, you wrap it in the decorator as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$fetcher = <span class="hljs-keyword">new</span> FetcherCachingDecorator(</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">new</span> App\Services\RssFetcher,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        $cache</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>);</td></tr></table></code></pre><p>As you can see, this solves our problem quite nicely. By wrapping our feed fetcher in this decorator, we keep the caching layer completely separate from any one implementation of the fetcher, so in the event we need to swap the current one out for another implementation, we don’t have to touch the caching layer at all. As long as we’re using dependency injection to resolve this interface, we’re only looking at a little more code to instantiate it.</p><p>In addition, this same approach can be applied for other purposes, and you can wrap the service class as many times as necessary. For instance, if we wanted to log all the responses we got, we could write a logging decorator something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">FeedFetcher</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Log</span>\<span class="hljs-title">LoggerInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeedLoggingDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FeedFetcher</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $fetcher;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $logger;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(FeedFetcher $fetcher, LoggerInterface $logger)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;fetcher = $fetcher;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;logger = $logger;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;fetcher-&gt;fetch($url);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;logger-&gt;info($response);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">return</span> $response;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></tr></table></code></pre><p>The same idea can be applied to an API client. For instance, say we have the following interface for an API client:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Contracts</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Objects</span>\<span class="hljs-title">Item</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Objects</span>\<span class="hljs-title">ItemCollection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Client</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAll</span><span class="hljs-params">()</span>: <span class="hljs-title">ItemCollection</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span><span class="hljs-params">(int $id)</span>: <span class="hljs-title">Item</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span>: <span class="hljs-title">Item</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(int $id, array $data)</span>: <span class="hljs-title">Item</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span><span class="hljs-params">(int $id)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>Now, of course any good API client should respect HTTP headers and use those to do some caching itself, but depending on the use case, you may also want to cache these requests yourself. For instance, if the only changes to the entities stored by the third party API will be ones you’ve made, or they don’t need to be 100% up to date, you may be better off caching those responses before they reach the actual API client. Under those circumstances, you might write a decorator like this to do the caching:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Client</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">CacheItemPoolInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Client</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $client;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Client $client, CacheItemPoolInterface $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;client = $client;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAll</span><span class="hljs-params">()</span>: <span class="hljs-title">ItemCollection</span></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;cache-&gt;getItem(<span class="hljs-string">'item_all'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">if</span> (!$item-&gt;isHit()) {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            $item-&gt;set(<span class="hljs-keyword">$this</span>-&gt;client-&gt;getAll());</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-keyword">$this</span>-&gt;cache-&gt;save($item);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get();</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span><span class="hljs-params">(int $id)</span>: <span class="hljs-title">Item</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $item = <span class="hljs-keyword">$this</span>-&gt;cache-&gt;getItem(<span class="hljs-string">'item_'</span>.$id);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">if</span> (!$item-&gt;isHit()) {</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            $item-&gt;set(<span class="hljs-keyword">$this</span>-&gt;client-&gt;find($id));</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            <span class="hljs-keyword">$this</span>-&gt;cache-&gt;save($item);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> $item-&gt;get();</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span>: <span class="hljs-title">Item</span></span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;clear();</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;client-&gt;create($data);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(int $id, array $data)</span>: <span class="hljs-title">Item</span></span></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;clear();</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;client-&gt;update($id, $data);</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span><span class="hljs-params">(int $id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;clear();</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;client-&gt;delete($id);</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>}</td></tr></table></code></pre><p>Any methods that change the state of the data on the remote API will clear the cache, while any that fetch data will first check the cache, only explicitly fetching data from the API when the cache is empty, and caching it again. I won’t go into how you might write a logging decorator for this, but it should be straightforward to figure out for yourself.</p><p>The decorator pattern is a very powerful way of adding functionality to a class without tying it to a specific implementation. If you’re familiar with how middleware works, decorators work in a very similar fashion in that you can wrap your service in as many layers as you wish in order to accomplish specific tasks, and they adhere to the single responsibility principle by allowing you to use different decorators for different tasks.</p></article><article class="post"><p class="date">20th October 2018 2:48 pm</p><h1><a href="/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/">Simplify Your Tests With Anonymous Classes</a></h1><p>Anonymous classes were added in PHP7, but so far I haven’t made all that much use of them. However, recently I’ve been working on building a simple dependency injection container for learning purposes. This uses the PHP Reflection API to determine how to resolve dependencies. For instance, if it’s asked for a class for which one of the dependencies required by the constructor is an instance of the <code>DateTime</code> class, it should create an instance, and then pass it into the constructor automatically when instantiating the class. Then it should return the newly created class.</p><p>Mocking isn’t really a suitable approach for this use case because the container needs to return a concrete class instance to do its job properly. You could just create a series of fixture classes purely for testing purposes, but that would mean either defining more than one class in a file (violating PSR-2), or defining a load of fixture classes in separate files, meaning you’d have to write a lot of boilerplate, and you’d have to move between several different files to understand what’s going on in the test.</p><p>Anonymous classes allow you a means to write simple classes for tests inline, as in this example for retrieving a very basic class. The tests use PHPSpec:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>\<span class="hljs-title">MyClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">DateTime</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>You can also define your own methods inline. Here we implement the <code>invoke()</code> magic method so that the class is a callable:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_invokable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DateTime;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>You can also define a constructor. Here, we’re getting the class name of a newly created anonymous class that accepts an instance of <code>DateTime</code> as an argument to the constructor. Then, we can resolve a new instance out of the container:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-title">new</span> <span class="hljs-title">DateTime</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DateTime $datetime)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-keyword">$this</span>-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>For classes that will extend an existing class or implement an interface, you can define those inline too. Or you can include a trait:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-title">new</span> <span class="hljs-title">DateTime</span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Bar</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DateTime $datetime)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-keyword">$this</span>-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-keyword">use</span> <span class="hljs-title">MyTrait</span>;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>In cases where the functionality is contained in a trait or abstract class, and you might need to add little or no additional functionality, this is a lot less verbose than creating a class the conventional way.</p><p>None of this is stuff you can’t do without anonymous classes, but by defining these sort of disposable fixture classes inline in your tests, you’re writing the minimum amount of code necessary to implement your test, and it’s logical to define it inline since it’s only ever used in the tests. One thing to bear in mind is that anonymous classes are created and instantiated at the same time, so you can’t easily create a class and then instantiate an instance of it separately. However, you can instantiate one, then use the <code>get_class()</code> function to get its class name and use that to resolve it, which worked well for my use case.</p><p>Another use case for anonymous classes is testing traits or abstract classes. I generally use Mockery as my mocking solution with PHPUnit tests, but I’ve sometimes missed the <code>getMockForTrait()</code> method from PHPUnit. However, another option is to instantiate an anonymous class that includes that trait for testing purposes:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$item = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>() </span>{</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">MyTrait</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>};</td></tr></table></code></pre><p>This way, your test class is as minimal as possible, and you can test the trait/abstract class in a fairly isolated fashion.</p></article><article class="post"><p class="date">16th October 2018 9:00 am</p><h1><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></h1><p>The project I’m currently working on is a textbook example of what happens when a project uses jQuery when it really ought to use a proper Javascript framework, or it starts out just using jQuery and grows out of all proportion. It’s also not helped by the fact that historically it’s just been worked on when new functionality needs to be added, meaning that rather than refactoring the code base, it’s been copied-and-pasted. As a result, there’s lots of repetitive code in desparate need of refactoring, and huge reams of horrible jQuery spaghetti code.</p><p>When I first took over responsibility for the project, I integrated Laravel Mix into it so that I had the means to refactor some of the common functionality into separate files and require them during the build process, as well as use ES6. However, this was only the first step, as it didn’t sort out the fundamental problem of repetitive boilerplate code being copied and pasted. What I needed was a refactor to use something more opinionated. As it happened, I was asked to add a couple of modals to the admin, and since the modals were one of the worst parts of the admin in terms of repetitive code, they were a strong candidate for implementing using a more suitable library.</p><p>I looked at a few options:</p><ul><li>I’ve used Angular 1 quite successfully in the past, but I didn’t really want to use a framework that was being killed off, and it would be difficult to retrofit into a legacy application</li><li>Angular 2+ is actively maintained, but it would again be difficult to retrofit it into a legacy application. In addition, the need for TypeScript would make it problematic.</li><li>Vue was a possibility, but it did a bit too much for this use case, and it wasn’t all that clear how to retrofit it to an existing application</li></ul><p>Eventually, I settled on React.js, for the following reasons:</p><ul><li>It has a preset in Laravel Mix, making it easy to get started with it.</li><li>It has a very limited target - React is closely focused on the view layer, dealing only with rendering and event handling, so it does just what I needed in this case.</li><li>It has a strong record of use with legacy applications - after all, it was created by Facebook and they added it incrementally.</li><li>It’s easy to test - Jest’s snapshot tests make it easy to verify the rendered content hasn’t changed, and using Enzyme it’s straightforward to test interactions with the component</li><li>Higher order components provide a straightforward way to share functionality between components, which I needed to allow different modals to deal with another modal in the same way.</li><li>By creating a series of components for common user interface elements, I could then re-use those components in future work, saving time and effort.</li></ul><p>However, it wasn’t entirely clear how I might go about integrating React into a legacy application. In the end, I managed to figure out an approach which worked.</p><p>Normally, I would create a single root for my application, something like this:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/App'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ReactDOM.render(</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    document.getElementById('root')</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>);</td></tr></table></code></pre><p>However, that wasn’t an option here. The existing modals were using jQuery and Bootstrap, and the new modals had to work with them. I therefore needed to have only certain parts of the UI managed with React, and the rest wouldn’t be touched. Here’s an example of how I rendered the modal in the end:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> higherOrderComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/higherOrderComponent'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> modalComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/modalComponent'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">const</span> Modal = higherOrderComponent(modalComponent);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-built_in">window</span>.componentWrapper = ReactDOM.render(</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> /&gt;</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  document.getElementById('modalTarget')</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>window.componentWrapper.setState({</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  foo: 'bar'</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>});</td></tr></table></code></pre><p>By extracting the duplicate functionality into a higher order component, I could easily wrap the new modals in that component and share that functionality between the modals. I could then render each component in a different target element, and assign it to a variable in the <code>window</code> namespace. The div with a ID of <code>modalTarget</code> needed to be added in the appropriate place, but otherwise the HTML didn’t need to be touched, since the required markup was in the React component instead.</p><p>Then, when I needed to change a value int the statee of the component, I could just call <code>window.componentWrapper.setState({})</code>, passing through the values to set, and these would propogate down to the child components as usual. I could also render multiple different modal components on the page, and refer to each one separately in order to set the state.</p><p>This isn’t an approach I’d recommend on a greenfield project - state isn’t really something you should be setting from outside a component like this, and normally I wouldn’t do it. However, it seemed to be the easiest way for this particular use case. Over time I’ll port more and more of the UI over to React, and eventually it won’t be necessary as I’ll be storing the application state in something like Redux.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/01/02/why-bad-code-is-bad/">Why Bad Code Is Bad</a></p><p><a href="/blog/2018/12/27/improving-search-in-vim-and-neovim-with-fzf-and-ripgrep/">Improving Search in Vim and Neovim With FZF and Ripgrep</a></p><p><a href="/blog/2018/12/06/decorating-service-classes/">Decorating Service Classes</a></p><p><a href="/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/">Simplify Your Tests With Anonymous Classes</a></p><p><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>