<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">30th December 2020 5:00 pm</p><h1><a href="/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/">Lightweight Laravel - Deconstructing a Full Stack Framework</a></h1><p>Back when I used to work with Django, I read the book <a href="https://www.oreilly.com/library/view/lightweight-django/9781491946275/">Lightweight Django</a>, and it completely changed the way I thought about building web applications. For years I’d heard the same lines parroted about how Django was too large and bloated, and something like Flask was a better bet for many applications, and this book completely blew this misconception away. By demonstrating how it was possible to break the framework apart, use just what you need, and leave out what you don’t, it showed how I could benefit from my familiarity with Django, while making it more suitable for smaller applications.</p><p>Laravel, like Django, is a full stack framework, and is often subject to similar misconceptions about bloat. But just because the framework ships with all this stuff, doesn’t mean you’re obliged to use it all. If you know you aren’t going to need all of a framework’s functionality, there’s nothing stopping you getting rid of what you don’t need, or even replacing it with something else. In this article, I’ll show you how to apply the same methodology to a Laravel application to remove what you don’t need. As part of this, we’ll be building a simple placeholder image service. This was used in Lightweight Django as it’s a good example of an application that is completely stateless, and doesn’t need sessions or a database, so it’s often seen as a bad fit for a full stack framework. Since the same applies here, it’s a good example for us too.</p><h2 id="getting-started">Getting started</h2><p>Run the following command in the shell to create a new Laravel application:</p><pre><code class="hljs lang-bash singleline">$ composer create-project --prefer-dist laravel/laravel lightweight-laravel</code></pre><p>What this actually does is as follows:</p><ul><li>Resolve the latest release of the package <code>laravel/laravel</code> that will work on your system</li><li>Copy it from the <a href="https://github.com/laravel/laravel">repository</a> to the specified location</li><li>Carry out any post-install scripts specified, such as creating the <code>.env</code> file and generating a key</li></ul><p>However, that’s just a standardised boilerplate for Laravel applications. Most of the functionality of the framework is in the package <code>laravel/framework</code>, which is included as a dependency in your <code>composer.json</code>. This makes sense, because by keeping as much of the actual framework out of the starter boilerplate and in a separate repository, it minimises the work required to update the application to a new version. It also means you can strip that boilerplate down to remove references to things you don’t need, and even create your own custom boilerplates to save you work in future.</p><h2 id="stripping-down-the-boilerplate">Stripping down the boilerplate</h2><p>Let’s start stripping out the things we don’t need. Since our application is stateless, we have no need whatsoever of a database, so we can delete the <code>app/Models</code> and <code>database</code> folders. We’ll want to support Redis for the cache, so we can’t delete the file <code>config/database.php</code>, but we can remove any references to the database other than Redis from that file. We can delete some other files from the <code>config/</code> folder, namely <code>auth.php</code>, <code>broadcasting.php</code>, <code>filesystems.php</code>, <code>mail.php</code>, <code>queue.php</code>, <code>services.php</code> and <code>session.php</code>.</p><p>We also don’t need a lot of the middleware that ships with Laravel. If you go into the file <code>app/Http/Kernel.php</code> you’ll see that it assigns some middleware as global, some to the <code>web</code> and <code>api</code> groups, and some as optional route middleware. In this file:</p><ul><li>We don’t need to make any POST requests to this application, so we can lose the <code>ValidatePostSize</code> middleware from the global middleware entirely</li><li>The <code>web</code> group relates to cookies, sessions, CSRF, authentication and handling routing with substitute bindings. Since we don’t need any of that we can empty this group entirely</li><li>The <code>auth</code>, <code>auth.basic</code>, <code>can</code>, <code>guest</code>, <code>password.confirm</code>, and <code>verified</code> route middleware is also surplus to requirements and can go</li></ul><p>As this change is a bit fiddly, here’s a patch, which may be easier to read:</p><pre><code class="hljs lang-patch"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>From <span class="hljs-number">6</span>bc87e9602e839d5635963b6d740279b2dbcf16b Mon Sep <span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">2001</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-name">From</span>: Matthew Daly &lt;Matthew Daly <span class="hljs-number">450801</span>+matthewbdaly@users.noreply.github.com&gt;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-name">Date</span>: Wed, <span class="hljs-number">30</span> Dec <span class="hljs-number">2020</span> <span class="hljs-number">11</span>:<span class="hljs-number">54</span>:<span class="hljs-number">56</span> +<span class="hljs-number">0000</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-name">Subject</span>: [PATCH] Removed unwanted middleware</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-comment">---</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> app/Http/Kernel.php | <span class="hljs-number">14</span> <span class="hljs-comment">--------------</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> <span class="hljs-number">1</span> file changed, <span class="hljs-number">14</span> deletions(-)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>diff <span class="hljs-comment">--git a/app/Http/Kernel.php b/app/Http/Kernel.php</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>index <span class="hljs-number">30020</span>a5.<span class="hljs-number">.10e150</span>d <span class="hljs-number">100644</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-comment">--- a/app/Http/Kernel.php</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>+++ b/app/Http/Kernel.php</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>@@ <span class="hljs-number">-18</span>,<span class="hljs-number">7</span> +<span class="hljs-number">18</span>,<span class="hljs-number">6</span> @@ <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kernel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpKernel</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>         \App\Http\Middleware\TrustProxies::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>         \Fruitcake\Cors\<span class="hljs-name">HandleCors</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>         \App\Http\Middleware\PreventRequestsDuringMaintenance::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>-        \Illuminate\Foundation\Http\Middleware\<span class="hljs-name">ValidatePostSize</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>         \App\Http\Middleware\TrimStrings::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>         \Illuminate\Foundation\Http\Middleware\<span class="hljs-name">ConvertEmptyStringsToNull</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     ];</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>@@ <span class="hljs-number">-30</span>,<span class="hljs-number">13</span> +<span class="hljs-number">29</span>,<span class="hljs-number">6</span> @@ <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kernel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpKernel</span></span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>      */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     protected $middlewareGroups = [</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>         <span class="hljs-string">'web'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>-            \App\Http\Middleware\EncryptCookies::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>-            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>-            \Illuminate\Session\Middleware\StartSession::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>-            // \Illuminate\Session\Middleware\AuthenticateSession::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>-            \Illuminate\View\Middleware\ShareErrorsFromSession::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>-            \App\Http\Middleware\VerifyCsrfToken::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>-            \Illuminate\Routing\Middleware\SubstituteBindings::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         ],</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>         <span class="hljs-string">'api'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>@@ <span class="hljs-number">-53</span>,<span class="hljs-number">14</span> +<span class="hljs-number">45</span>,<span class="hljs-number">8</span> @@ <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kernel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpKernel</span></span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>      * @var array</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>      */</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     protected $routeMiddleware = [</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>-        <span class="hljs-string">'auth'</span> =&gt; \App\Http\Middleware\Authenticate::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>-        <span class="hljs-string">'auth.basic'</span> =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>         <span class="hljs-string">'cache.headers'</span> =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>-        <span class="hljs-string">'can'</span> =&gt; \Illuminate\Auth\Middleware\Authorize::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>-        <span class="hljs-string">'guest'</span> =&gt; \App\Http\Middleware\RedirectIfAuthenticated::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>-        <span class="hljs-string">'password.confirm'</span> =&gt; \Illuminate\Auth\Middleware\RequirePassword::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>         <span class="hljs-string">'signed'</span> =&gt; \Illuminate\Routing\Middleware\ValidateSignature::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>         <span class="hljs-string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>-        <span class="hljs-string">'verified'</span> =&gt; \Illuminate\Auth\Middleware\EnsureEmailIsVerified::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>     ];</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td> }</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td><span class="hljs-comment">-- </span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td><span class="hljs-number">2.28</span><span class="hljs-number">.0</span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td></td></tr></table></code></pre><p>These changes also mean a lot of the service providers and facades are now redundant and can be removed from the application. If you go into <code>config/app.php</code> you can remove <code>AuthServiceProvider</code>, <code>BroadcastServiceProvider</code>, <code>CookieServiceProvider</code>, <code>MailServiceProvider</code>, <code>NotificationServiceProvider</code>, <code>PaginationServiceProvider</code>, <code>PasswordResetServiceProvider</code>, <code>SessionServiceProvider</code> and <code>TranslationServiceProvider</code> from the providers section, as well as the commented-out local <code>BroadcastServiceProvider</code>. You can also delete the facades for <code>Auth</code>, <code>Cookie</code>, <code>DB</code>, <code>Eloquent</code>, <code>Gate</code>, <code>Lang</code>, <code>Mail</code>, <code>Notification</code>, <code>Password</code>, <code>Queue</code>, <code>Schema</code>, <code>Session</code>, and <code>Storage</code>.</p><p>Again, here’s a patch of the required changes:</p><pre><code class="hljs lang-patch"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-type">From</span> <span class="hljs-number">66</span>be3b836706ef488b890cdae6e97d4fc6195dd6 <span class="hljs-type">Mon</span> <span class="hljs-type">Sep</span> <span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">2001</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-type">From</span>: <span class="hljs-type">Matthew</span> <span class="hljs-type">Daly</span> &lt;<span class="hljs-type">Matthew</span> <span class="hljs-type">Daly</span> <span class="hljs-number">450801</span>+matthewbdaly<span class="hljs-meta">@users</span>.noreply.github.com&gt;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-type">Date</span>: <span class="hljs-type">Wed</span>, <span class="hljs-number">30</span> <span class="hljs-type">Dec</span> <span class="hljs-number">2020</span> <span class="hljs-number">12</span>:<span class="hljs-number">10</span>:<span class="hljs-number">25</span> +<span class="hljs-number">0000</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-type">Subject</span>: [<span class="hljs-type">PATCH</span>] <span class="hljs-type">Removed</span> unused service providers and facades</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>---</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> config/app.php | <span class="hljs-number">26</span> --------------------------</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> <span class="hljs-number">1</span> file changed, <span class="hljs-number">26</span> deletions(-)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>diff --git a/config/app.php b/config/app.php</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>index <span class="hljs-number">2</span>a2f0eb..b7a38c8 <span class="hljs-number">100644</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>--- a/config/app.php</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>+++ b/config/app.php</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>@@ <span class="hljs-number">-139</span>,<span class="hljs-number">26</span> +<span class="hljs-number">139</span>,<span class="hljs-number">17</span> @@ <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>         <span class="hljs-comment">/*</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>          * Laravel Framework Service Providers...</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>          */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Auth</span>\<span class="hljs-type">AuthServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Broadcasting</span>\<span class="hljs-type">BroadcastServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Bus</span>\<span class="hljs-type">BusServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Cache</span>\<span class="hljs-type">CacheServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Foundation</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">ConsoleSupportServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Cookie</span>\<span class="hljs-type">CookieServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Database</span>\<span class="hljs-type">DatabaseServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Encryption</span>\<span class="hljs-type">EncryptionServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Filesystem</span>\<span class="hljs-type">FilesystemServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Foundation</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">FoundationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Hashing</span>\<span class="hljs-type">HashServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Mail</span>\<span class="hljs-type">MailServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Notifications</span>\<span class="hljs-type">NotificationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Pagination</span>\<span class="hljs-type">PaginationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Pipeline</span>\<span class="hljs-type">PipelineServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Queue</span>\<span class="hljs-type">QueueServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Redis</span>\<span class="hljs-type">RedisServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Auth</span>\<span class="hljs-type">Passwords</span>\<span class="hljs-type">PasswordResetServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Session</span>\<span class="hljs-type">SessionServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Translation</span>\<span class="hljs-type">TranslationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Validation</span>\<span class="hljs-type">ValidationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">View</span>\<span class="hljs-type">ViewServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>@@ <span class="hljs-number">-170</span>,<span class="hljs-number">9</span> +<span class="hljs-number">161</span>,<span class="hljs-number">6</span> @@ <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>          * <span class="hljs-type">Application</span> <span class="hljs-type">Service</span> <span class="hljs-type">Providers</span>...</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>          */</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>         <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">AppServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>-        <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">AuthServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>-        <span class="hljs-comment">// App\Providers\BroadcastServiceProvider::class,</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>-        <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">EventServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>         <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">RouteServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>     ],</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>@@ <span class="hljs-number">-193</span>,<span class="hljs-number">35</span> +<span class="hljs-number">181</span>,<span class="hljs-number">21</span> @@ <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>         <span class="hljs-symbol">'Ap</span>p' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">App</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>         <span class="hljs-symbol">'Ar</span>r' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Arr</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>         <span class="hljs-symbol">'Artisa</span>n' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Artisan</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>-        <span class="hljs-symbol">'Aut</span>h' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Auth</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>         <span class="hljs-symbol">'Blad</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Blade</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>         <span class="hljs-symbol">'Broadcas</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Broadcast</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>         <span class="hljs-symbol">'Bu</span>s' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Bus</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>         <span class="hljs-symbol">'Cach</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Cache</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>         <span class="hljs-symbol">'Confi</span>g' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Config</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>-        <span class="hljs-symbol">'Cooki</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Cookie</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>         <span class="hljs-symbol">'Cryp</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Crypt</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>-        <span class="hljs-symbol">'D</span>B' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">DB</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>-        <span class="hljs-symbol">'Eloquen</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Database</span>\<span class="hljs-type">Eloquent</span>\<span class="hljs-type">Model</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>-        <span class="hljs-symbol">'Even</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Event</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>         <span class="hljs-symbol">'Fil</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">File</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>-        <span class="hljs-symbol">'Gat</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Gate</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>         <span class="hljs-symbol">'Has</span>h' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Hash</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>         <span class="hljs-symbol">'Htt</span>p' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Http</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>-        <span class="hljs-symbol">'Lan</span>g' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Lang</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>         <span class="hljs-symbol">'Lo</span>g' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Log</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>-        <span class="hljs-symbol">'Mai</span>l' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Mail</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>-        <span class="hljs-symbol">'Notificatio</span>n' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Notification</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>-        <span class="hljs-symbol">'Passwor</span>d' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Password</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>-        <span class="hljs-symbol">'Queu</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Queue</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>         <span class="hljs-symbol">'Redirec</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Redirect</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>         <span class="hljs-comment">// 'Redis' =&gt; Illuminate\Support\Facades\Redis::class,</span></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>         <span class="hljs-symbol">'Reques</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Request</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>         <span class="hljs-symbol">'Respons</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Response</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>         <span class="hljs-symbol">'Rout</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Route</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>-        <span class="hljs-symbol">'Schem</span>a' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Schema</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>-        <span class="hljs-symbol">'Sessio</span>n' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Session</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>-        <span class="hljs-symbol">'Storag</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Storage</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>         <span class="hljs-symbol">'St</span>r' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Str</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>         <span class="hljs-symbol">'UR</span>L' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">URL</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>         <span class="hljs-symbol">'Validato</span>r' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Validator</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>-- </td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td><span class="hljs-number">2.28</span><span class="hljs-number">.0</span></td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td></td></tr></table></code></pre><p>There are a few service providers that ideally we’d strip out but are tightly integrated into the framework. For instance, the database and queue service providers are both used by some Artisan commands, and it’s not very practical to disable only those commands, so removing them will stop Artisan from working. If you don’t mind running the development server manually, you can go ahead and remove these.</p><h2 id="building-the-application">Building the application</h2><p>Now, let’s set out how our application will work. We will have two routes:</p><ul><li>A route that accepts width and height parameters in the route itself, and responds with a PNG response sized accordingly</li><li>A route that returns a simple HTML homepage</li></ul><p>You’ve no doubt seen various novelty placeholder sites like <a href="http://placekitten.com/">placekitten.com</a> for use in web projects, and this will be similar to that. We’ll use a simple black image with the dimensions in white text, but you should be able to use this as the basis of a more sophisticated placeholder service, such as if you wanted to use branded images for a particular client.</p><p>Since the home page will be fairly straightforward, let’s do that first. Delete the existing <code>resources/views/welcome.blade.php</code> file and save this to <code>resources/views/home.blade.php</code>:</p><pre><code class="hljs lang-blade.php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Laravel Placeholder Images<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ mix('css/app.css') }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Laravel Placeholder Images<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>This server can be used for serving placeholder</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    images for any web page.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>To request a placeholder image of a given width and height</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    simply include an image with the source pointing to</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>/image/<span class="hljs-symbol">&amp;lt;</span>width<span class="hljs-symbol">&amp;gt;</span>x<span class="hljs-symbol">&amp;lt;</span>height<span class="hljs-symbol">&amp;gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    on this server such as:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-symbol">&amp;lt;</span>img src="<span class="hljs-template-variable">{{ $example }}</span><span class="xml">" <span class="hljs-symbol">&amp;gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Examples<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{{ route('placeholder', ['width' =&gt; 50, 'height' =&gt; 50]) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{{ route('placeholder', ['width' =&gt; 100, 'height' =&gt; 50]) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{{ route('placeholder', ['width' =&gt; 50, 'height' =&gt; 100]) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></td></tr></table></code></pre><p>Note we’re using the <code>route()</code> helper to add some example images, even though it’s not in place yet. Add this route to your <code>routes/web.php</code> as well:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Route::get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">return</span> view(<span class="hljs-string">'home'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'example'</span> =&gt; route(<span class="hljs-string">'placeholder'</span>, [<span class="hljs-string">'width'</span> =&gt; <span class="hljs-number">50</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-number">50</span>]),</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    ]);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>});</td></tr></table></code></pre><p>Again, note that we’re using the <code>route()</code> helper to get the URL for the placeholder image. Next, we need to create the outline of the route for getting the placeholders:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>})-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    -&gt;name(<span class="hljs-string">'placeholder'</span>);</td></tr></table></code></pre><p>Due to the limited scope of this application, we won’t bother with full controllers, but you can add them if you wish. Note we’ve specified the name <code>placeholder</code> and set a regex to validate the <code>width</code> and <code>height</code> parameters.</p><p>Now let’s populate the callback to generate a PNG file.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        abort();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    ob_start();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    imagepng($img);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    $file = ob_get_contents();</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    ob_end_clean();</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    ]);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>})-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    -&gt;name(<span class="hljs-string">'placeholder'</span>);</td></tr></table></code></pre><p>We’ll also add some very basic CSS to the provided CSS file:</p><pre><code class="hljs lang-css"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-selector-tag">body</span> {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attribute">text-align</span>: center;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-selector-tag">ul</span> {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attribute">list-type</span>: none;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-selector-tag">li</span> {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">display</span>: inline-block;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>Don’t forget to build this with <code>npm install &amp;&amp; npm run production</code> too.</p><p>If you now run <code>php artisan serve</code> you should be able to see that it works - the homepage renders, and the embedded images are pulled in OK. However, there are three potential issues:</p><ul><li>The images themselves are regenerated each time. Since they never change, it’s a no-brainer to cache them indefinitely for the best performance, and if we do need to change them in the future we can just flush the cache to resolve this</li><li>Similarly, we should use ETags to allow the application to tell the browser when the image has changed</li><li>There’s no limit on how large images can be, so a malicious user could request a huge image to break the system</li></ul><p>Let’s tackle these in order. First, let’s create some middleware to handle the caching:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Cache</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheImages</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * Handle an incoming request.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(Request $request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $key = sprintf(<span class="hljs-string">"%d.%d"</span>, $request-&gt;width, $request-&gt;height);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> Cache::rememberForever($key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($next, $request)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-keyword">return</span> $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>We construct a cache key from the request width and height, and use the <code>Cache::rememberForever()</code> method to cache the response. We then register this middleware as route middleware in <code>app\Http\Kernel.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $routeMiddleware = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'cache.headers'</span> =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::class,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'signed'</span> =&gt; \Illuminate\Routing\Middleware\ValidateSignature::class,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-string">'cache.images'</span> =&gt; \App\Http\Middleware\CacheImages::class,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    ];</td></tr></table></code></pre><p>And apply it to the image route:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        abort();</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    ob_start();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    imagepng($img);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    $file = ob_get_contents();</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    ob_end_clean();</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    ]);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>})-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  -&gt;name(<span class="hljs-string">'placeholder'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  -&gt;middleware(<span class="hljs-string">'cache.images'</span>);</td></tr></table></code></pre><p>Next, let’s set ETags on our images. Laravel comes with the <code>cache.headers</code> middleware, which we can easily wrap around our placeholder route:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Route::middleware(<span class="hljs-string">'cache.headers:public;etag'</span>)-&gt;group(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            abort();</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        ob_start();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        imagepng($img);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $file = ob_get_contents();</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        ob_end_clean();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    })-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      -&gt;name(<span class="hljs-string">'placeholder'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      -&gt;middleware(<span class="hljs-string">'cache.images'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>});</td></tr></table></code></pre><p>Finally, let’s handle the dimensions issue. Again, this is something that is probably best handled in middleware since that way it can be rejected before the point it gets to the route handler. All we need to do is to check to see if the width and height parameters exceed the intended value, and throw an error in the middleware:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Validation</span>\<span class="hljs-title">ValidationException</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateImageDimensions</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * Handle an incoming request.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     * <span class="hljs-doctag">@param</span>  \Closure  $next</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@return</span> mixed</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(Request $request, Closure $next)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">if</span> ($request-&gt;width &gt; <span class="hljs-number">2000</span> || $request-&gt;height &gt; <span class="hljs-number">2000</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            abort(<span class="hljs-number">422</span>, <span class="hljs-string">'Height and width cannot exceed 2000 pixels'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> $next($request);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Register this middleware in <code>app/Http/Kernel.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $routeMiddleware = [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'cache.headers'</span> =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::class,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'signed'</span> =&gt; \Illuminate\Routing\Middleware\ValidateSignature::class,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-string">'cache.images'</span> =&gt; \App\Http\Middleware\CacheImages::class,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-string">'validate.images'</span> =&gt; \App\Http\Middleware\ValidateImageDimensions::class,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    ];</td></tr></table></code></pre><p>And apply it to the image route:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Route::middleware(<span class="hljs-string">'cache.headers:public;etag'</span>)-&gt;group(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            abort();</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        ob_start();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        imagepng($img);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $file = ob_get_contents();</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        ob_end_clean();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    })-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      -&gt;name(<span class="hljs-string">'placeholder'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      -&gt;middleware([<span class="hljs-string">'validate.images'</span>, <span class="hljs-string">'cache.images'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>});</td></tr></table></code></pre><p>And we’re done! We now have a basic, but functional, stateless Laravel application that’s been stripped of a lot of the unnecessary functionality. There are a few further changes that could be made to expand this if necessary, such as:</p><ul><li>Amend the project to allow requesting different image formats using an additional route parameter (hint - you’ll want to use something like <a href="http://image.intervention.io/">Intervention for this</a>)</li><li>Serve different images, either by using one as a starting template so they are all branded the same, or specifying one from several options in the URL, such as with <a href="https://www.placecage.com/">PlaceCage</a></li></ul><p>However, I will leave these as an exercise for the reader. The code for this project is available on <a href="https://github.com/matthewbdaly/lightweight-laravel">Github</a> if you get stuck at any point.</p><p>Hopefully, this article has given you some food for thought about how you can use Laravel for applications you might have previously considered too small to use it for. Don’t worry too much about removing something that you need to add later - version control means you can always retrieve it if it turns out you do need it later. I’d also add that potentially the same approach can be applied to other full stack PHP frameworks, though you’ll have to do some exploring on your own to determine this.</p></article><article class="post"><p class="date">28th September 2020 3:50 pm</p><h1><a href="/blog/2020/09/28/what-i-want-in-a-php-cms/">What I Want in a PHP CMS</a></h1><p>I maintain a custom PHP legacy CMS for a client, and have also been building a micro-CMS as a learning project, so I’ve spent quite a lot of time in the last few years thinking about how content should be managed, and how applications to manage it should work.</p><p>I’ve also at least tinkered with a few different content management systems down the years, and I’ve found it depressing how many times Wordpress has been the default choice, despite it being probably the worst CMS I’ve ever had the gross misfortune to use. The argument that “it’s easy to install and use” doesn’t really hold water given that in my experience most users setting up a new Wordpress site don’t go through the five-minute install, but use their shared hosting provider’s setup wizard, which typically also supports several other content management systems. Also, it just does not make sense to optimise a short five minute install that will never be repeated for that site over the rest of the workflow for maintaining the site, possibly for years - I’d rather have something that takes a bit more time to do the initial set up, but is easier to maintain.</p><p>So, what do I want in a PHP CMS? Here’s my thoughts on my ideal CMS solution.</p><h2 id="managed-entirely-with-composer">Managed entirely with Composer</h2><p>Creating a new site using a CMS should be as simple as running something like the following command:</p><pre><code class="hljs lang-bash singleline">$ composer create-project --prefer-dist my/cms newsite</code></pre><p>And updating it should be as simple as running the following:</p><pre><code class="hljs lang-bash singleline">$ composer update</code></pre><p>Installing a plugin should be a case of running this:</p><pre><code class="hljs lang-bash singleline">$ composer require my/plugin-foo</code></pre><p>It should then be possible to activate the plugin simply by listing it in a config file.</p><p>As far as possible, <em>all</em> of the functionality of the CMS should be contained in a single “core” package, and plugins should be their own Composer packages that can be installed, and then switched on and off in a simple config file. The initial creation step should be a case of checking out a boilerplate that contains only the absolute minimum - a front controller, a starting configuration, front end tooling, and some views - and gets the rest of the functionality from the core package.</p><h2 id="allow-creating-custom-site-boilerplates">Allow creating custom site boilerplates</h2><p>It should be possible to create and publish alternative boilerplates.</p><p>For instance, if a CMS provides a default starting boilerplate that ships with Bootstrap, VueJS and Laravel Mix, I should be able to fork it, replace Bootstrap with Tailwind and Vue with React, and then use my version for future projects without having to spend a lot of time maintaining the fork.</p><p>Similarly, if there are certain plugins I use all the time, it should be possible to include those plugins as dependencies in my <code>composer.json</code> so that when I create a new project from my boilerplate, they’re present right from the start and I don’t have to faff around downloading and configuring them manually.</p><h2 id="plugin-api-should-work-like-a-framework">Plugin API should work like a framework</h2><p>The best practices we’ve all spent years learning shouldn’t go out the window when working with a CMS. A good CMS should feel familiar if you’ve got some experience working in MVC frameworks, and it should embrace PSR standards. Adding a route should largely be a matter of writing a controller, mapping it to a route, and adding a view file, just as it would be in a framework</p><p>There’s always going to be some things that need to be CMS-specific, because registering things like routes is more complex in a general purpose CMS than a custom web app as they can be defined in multiple arbitrary places. These can be handled by triggering events at various points in the CMS application’s lifecycle, so that plugin authors can set up listeners to do things such as register routes, add new view helpers and so on.</p><h2 id="focused-exclusively-on-content-not-presentation">Focused exclusively on content, not presentation</h2><p>I’m increasingly convinced that the ability to amend presentation in a CMS is a misfeature. The purpose of a CMS is to manage content, not presentation, and making it able to amend presentation potentially gives unskilled site owners enough rope to hang themselves with, while making it actively harder for us devs.</p><p>I’ve certainly seen enough sites that a client has completely messed up after being given access to change the presentation in Wordpress, and because it’s stored in the database it’s not possible to roll back the changes easily the way it would be if the styling was stored in version control. And it’s definitely quicker for an experienced front end developer to edit a CSS file than to use Wordpress’s own tools for amending styling.</p><h2 id="use-a-proper-templating-system">Use a proper templating system</h2><p>As a templating language, PHP <em>sucks</em>:</p><ul><li>It’s too easy to overlook escaping variables properly</li><li>Handling partials is difficult</li><li>There’s always the temptation to put in more logic than is advisable in the view layer, especially when deadlines are tight</li></ul><p>Using a dedicated templating language, rather than a full programming language, in the view layer, means that entire classes of issues can be completely eradicated from the layer of the application that the developers who work with the CMS have the most dealings with. Developers are forced to move more complex logic into dedicated helpers, and can’t just leave it in the template “until we have time to clear it up”, which is often never.</p><p>Twig is solid, reliable, fast, easy to extend, and similar enough to other templating languages such as Handlebars and Django’s templates that if you’ve used any of those you can adapt easily, and it should probably be your first choice. Blade is also a solid choice, and if you want something whose syntax is not dissimilar to PHP you should probably consider Plates.</p><h2 id="configuration-with-version-control-in-mind">Configuration with version control in mind</h2><p>Wordpress does this particularly badly because it actively encourages storing sensitive data, such as database credentials, in a PHP file (which is then kept in the web root…). A good, solid way to store configuration details in PHP is to store generic details (for instance, a list of the active plugins, which will be the same for production and the local copy developers run) for that project in either a YAML or PHP file, and store install-specific details in either a <code>.env</code> file, or as environment variables.</p><h2 id="custom-content-types">Custom content types</h2><p>It should be easy to create a new content type, and define specific fields for that content type. For instance, if I’m building a recipe site, I should be able to define a Recipe type that has the following attributes:</p><ul><li>Ingredients</li><li>Cover image</li><li>Title</li><li>Method</li></ul><p>Then all Recipe instances should have those attributes, and it shouldn’t be necessary to bastardise a different content type to make it work properly. It should also be possible to lock down the ability to create custom content types so it’s either limited to admins, or they’re defined in code, so end users can’t create arbitrary content types.</p><h2 id="custom-taxonomies">Custom taxonomies</h2><p>It should be possible to define your own custom taxonomies for content. Continuing the Recipe example above, we should be able to define three sorts of taxonomy:</p><ul><li>Dietary requirements (eg vegetarian, vegan, gluten-free etc)</li><li>Meal (eg breakfast, lunch, dinner, snacks)</li><li>Region (eg Indian, Chinese, Italian)</li></ul><p>A taxonomy should be appropriately named, and again it shouldn’t be necessary to abuse generic categories and tags to categorise content. As with the content types, it should also be possible to lock them down.</p><h2 id="a-better-solution-than-rich-text-for-managing-content">A better solution than rich text for managing content</h2><p>Rich text is not a great solution for more complex page layouts, and tends to be abused horribly to do all sorts of things. There’s a tendency to dump things like snippets for Google Maps, tables, galleries, Javascript widgets and many more into rich text. This means that it also loses the semantic value of the content - rather than being a paragraph, then a map of the local area, then a photo carousel, then another paragraph, it’s just a single blob of text. This can’t be easily migrated to another solution if, say, you decide to swap Google Maps for Open Streetmap, and change one carousel for another, without going through and manually replacing every map and carousel, which is a chore.</p><p>Wagtail isn’t a PHP CMS, but <a href="https://torchbox.com/blog/rich-text-fields-and-faster-horses/">it has an interesting approach to rich text handling</a> for complex content, inspired by <a href="https://madebymany.github.io/sir-trevor-js/">Sir Trevor</a>, based around blocks of different types. The Gutenberg editor in Wordpress 5.0 and up isn’t a million miles away from this, either. For simpler sites, it’s probably better to limit users to a Markdown editor and add helpers for adding more complex functionality directly in the template, such as a gallery helper.</p><h2 id="a-decent-command-line-runner">A decent command-line runner</h2><p>There are always going to be certain tasks that are best done from the command line. A decent CMS should have a command line tool that:</p><ul><li>Allows appropriate admin tasks, such as going into maintenance mode and flushing caches, to be done from the command line</li><li>Can be easily extended by plugin authors to add their own commands</li><li>Assists developers when working locally, such as by generating boilerplate when necessary (so, for instance, you can run a command to generate the skeleton for a new plugin)</li></ul><p>There’s no excuse not to do this when building a CMS. Symfony’s console component is solid, easy to work with, and a good base for whatever commands you need to write.</p><h2 id="headless-as-an-option">Headless as an option</h2><p>The rise of headless CMS’s, both as a service and as software packages, hasn’t surprised me. Nowadays it’s quite common to have to publish the same content to multiple channels, which might be one or more websites, as well as mobile apps, and it makes sense to be able to centralise that content in one place rather than have to copy it in some fashion.</p><p>It’s therefore very useful to have an API that can retrieve that content for republishing. The same API can also be used with Javascript libraries like React and Vue to build sophisticated frontends that consume that data.</p><h2 id="which-solutions-do-this-best-">Which solutions do this best?</h2><p>You’ll probably have got the idea at this point that Wordpress isn’t my first choice. It was created in a different era, and hasn’t kept up well compared to many of its contemporaries, and there are many technical issues with it that are at this point effectively impossible to ever fix. For instance, you could potentially store the post meta in the same table as the rest of the post data by using a JSON field in current versions of MySQL, which would make it more performant, but it seems unlikely it could ever be migrated across to use that solution.</p><p>Frustratingly, its mindshare means it’s erroneously seen as some kind of “gold standard” by inexperienced developers and non-technical clients, and there seems to be a common misconception that it’s the only solution that lets users update the content themselves (when in fact that’s the whole point of ANY CMS). Using Bedrock and a theme system like Sage that supports a proper templating system helps solve some of the problems with Wordpress, but not all.</p><p>I have tried a few solutions that come very close to what I want:</p><ul><li><a href="https://bolt.cm/">Bolt</a> seems from what I’ve seen so far to be effectively a “better Wordpress” in that the interface and functionality is broadly familiar to anyone already used to Wordpress, but it uses Twig, is built in Symfony, and has a proper command-line runner. I haven’t tried it since version 4 was released a few days back, so I will probably give it a spin before long.</li><li><a href="https://getgrav.org/">Grav</a> looks like a great solution for brochure sites. I’ve long thought that these sites, which often run on shared hosting, don’t really need a database-backed solution, and a flat-file solution is probably a better bet in most cases. Grav is simple to set up and configure, has a decent admin interface, and uses Twig for the views, making it easy to theme.</li><li><a href="https://statamic.com/">Statamic</a> is my current favourite and ticks almost all of the boxes mentioned above. It’s built on Laravel, and can be added to an existing Laravel site if required. It also allows you access to the full power of the underlying framework if you need it, and ships with a decent front-end boilerplate that includes Tailwind. The only downside compared to Wordpress is that it’s a paid-for solution, but the price is entirely reasonable, and if it’s for a client build you’ll not only save on all the premium plugins you don’t need, but you’ll probably save time on the site build.</li></ul><p>Payment shouldn’t be an issue if you’re doing client work, unless the cost is huge. You’re getting paid for building something, and if buying an off-the-shelf product saves you time, it’s well worth it. Back when Laravel Nova was first released, a lot of people were complaining that it wasn’t free, but that was neither here nor there - the cost is only equivalent to a few hours of an experienced developer’s time, and it would take a lot longer to build out the same functionality, and the same is true of any half-decent CMS. In the early days of the web, one company I used to work for sold <a href="http://www.wordserver.co.uk/">a CMS that was considered cheap by the standards of the time</a> at £495, plus £96 a year, for the entry level version - Statamic is significantly cheaper than that.</p><p>It’s always a good idea to be aware of the various CMS options around. Wordpress isn’t a great solution and there are plenty of options that are technically better, easier to use, more secure, and work out cheaper when you consider the total cost of ownership. I’ll probably be favouring Statamic for the foreseeable future when building content-based websites, but that doesn’t mean I won’t look elsewhere from time to time.</p></article><article class="post"><p class="date">13th June 2020 1:50 pm</p><h1><a href="/blog/2020/06/13/flow-typed-ajax-responses-with-react-hooks/">Flow Typed AJAX Responses With React Hooks</a></h1><p>I’m a big fan of type systems in general. Using Psalm to find missing type declarations and incorrect calls in PHP has helped me out tremendously. However, I’m not a big fan of Typescript. The idea of creating a whole new language, primarily just to add types to Javascript, strikes me as a fundamentally bad idea given how many languages that compile to Javascript have fallen by the wayside. Flow seems like a much better approach since it adds types to the language rather than creating a new language, and I’ve been using it on my React components for a good while now. However, there are a few edge cases that can be difficult to figure out, and one of those is any generic AJAX component that may be reused for different requests.</p><p>A while back I wrote the following custom hook, loosely inspired by axios-hooks (but using the Fetch API) to make a query to a GraphQL endpoint:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> { useCallback, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useFetch</span>(<span class="hljs-params">url, query</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>  <span class="hljs-keyword">const</span> [data, setData] = useState(<span class="hljs-literal">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-keyword">const</span> [loading, setLoading] = useState(<span class="hljs-literal">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  <span class="hljs-keyword">const</span> [error, setError] = useState(<span class="hljs-literal">false</span>)</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="hljs-keyword">const</span> fetchData = useCallback(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    setLoading(<span class="hljs-literal">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    fetch(url, {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      <span class="hljs-attr">headers</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'application/json'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      },</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">query</span>: query})</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json())</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      .then(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        setData(data.data);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        setLoading(<span class="hljs-literal">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        setError(<span class="hljs-literal">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>  }, [url, query]);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    fetchData();</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  }, [url, query, fetchData]);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>  <span class="hljs-keyword">return</span> [{</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-attr">data</span>: data,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-attr">loading</span>: loading,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-attr">error</span>: error</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>  }, fetchData];</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useFetch;</td></tr></table></code></pre><p>When called, the hook receives two parameters, the URL to hit, and the query to make, and returns an array that contains a function for reloading, and an object containing the following values:</p><ul><li><code>loading</code> - a boolean that specifies if the hook is loading right now</li><li><code>error</code> - a boolean that specifies if an error has occurred</li><li><code>data</code> - the response data from the endpoint, or null</li></ul><p>Using this hook, it was then possible to make an AJAX request when a component was loaded to populate the data, as in this example:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> useFetch <span class="hljs-keyword">from</span> <span class="hljs-string">'./Hooks/useFetch'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> marked <span class="hljs-keyword">from</span> <span class="hljs-string">'marked'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> <span class="hljs-string">'./App.css'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">const</span> url = <span class="hljs-string">`/graphql`</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="hljs-keyword">const</span> query = <span class="hljs-string">`query {</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    posts {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>      title</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>      slug</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>      content</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      tags {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        name</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  }`;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  <span class="hljs-keyword">const</span> [{data, loading, error}] = useFetch(url, query);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>  <span class="hljs-keyword">if</span> (loading) {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>  <span class="hljs-keyword">if</span> (error) {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Error!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>  <span class="hljs-keyword">const</span> posts = data ? data.posts.map(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> (</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.slug}</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{item.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{{__html:</span> <span class="hljs-attr">marked</span>(<span class="hljs-attr">item.content</span>)}} /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>  )) : [];</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"App"</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>      {posts}</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App;</td></tr></table></code></pre><p>This hook is simple, and easy to reuse. However, it’s difficult to type the value of <code>data</code> correctly, since it will be different for different endpoints, and given that it may be reused for almost any endpoint, you can’t cover <em>all</em> the acceptable response types. We need to be able to specify the response that is acceptable in that particular context.</p><h2 id="generics-to-the-rescue">Generics to the rescue</h2><p>Flow provides a solution for this in the shape of <a href="https://flow.org/en/docs/types/generics/">generic types</a>. By passing in a polymorphic type using <code>&lt;T&gt;</code> in the function declaration, we can then refer to that type when specifying what <code>data</code> should look like:</p><pre><code class="hljs lang-flow"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">//@flow</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> { useCallback, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useFetch</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, query: <span class="hljs-built_in">string</span></span>): [</span>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  data: ?T,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  loading: <span class="hljs-built_in">boolean</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  error: <span class="hljs-built_in">boolean</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>}, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">void</span>] {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  <span class="hljs-keyword">const</span> [data, setData]: [?T, <span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params">?T =&gt; ?T</span>) | ?T</span>) =&gt;</span> <span class="hljs-built_in">void</span>] = useState(<span class="hljs-literal">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  <span class="hljs-keyword">const</span> [loading, setLoading]: [<span class="hljs-built_in">boolean</span>, <span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-built_in">boolean</span> =&gt; <span class="hljs-built_in">boolean</span></span>) | <span class="hljs-built_in">boolean</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>] = useState(<span class="hljs-literal">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  <span class="hljs-keyword">const</span> [error, setError]: [<span class="hljs-built_in">boolean</span>, <span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-built_in">boolean</span> =&gt; <span class="hljs-built_in">boolean</span></span>) | <span class="hljs-built_in">boolean</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>] = useState(<span class="hljs-literal">false</span>)</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  <span class="hljs-keyword">const</span> fetchData = useCallback(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    setLoading(<span class="hljs-literal">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    fetch(url, {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>      method: <span class="hljs-string">'POST'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>      headers: {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'application/json'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      },</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>      body: <span class="hljs-built_in">JSON</span>.stringify({query: query})</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json())</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>      .then(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        setData(data.data);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        setLoading(<span class="hljs-literal">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        setError(<span class="hljs-literal">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>      });</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>  }, [url, query]);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    fetchData();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>  }, [url, query, fetchData]);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>  <span class="hljs-keyword">return</span> [{</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    data: data,</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    loading: loading,</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    error: error</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>  }, fetchData];</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useFetch;</td></tr></table></code></pre><p>Then, when calling the hook, we can define a type that represents the expected shape of the data (here called <code>&lt;Data&gt;</code>, and specify that type when calling the hook, as in this example:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">//@flow</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> useFetch <span class="hljs-keyword">from</span> <span class="hljs-string">'./Hooks/useFetch'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> marked <span class="hljs-keyword">from</span> <span class="hljs-string">'marked'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">import</span> <span class="hljs-string">'./App.css'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>type Data = {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="hljs-attr">posts</span>: <span class="hljs-built_in">Array</span>&lt;{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attr">title</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attr">slug</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">content</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-attr">name</span>: <span class="hljs-built_in">Array</span>&lt;string&gt;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  }&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params"></span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-keyword">const</span> url = <span class="hljs-string">`/graphql`</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-keyword">const</span> query = <span class="hljs-string">`query {</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    posts {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      title</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>      slug</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>      content</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>      tags {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        name</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  }`;</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>  <span class="hljs-keyword">const</span> [{data, loading, error}] = useFetch&lt;Data&gt;(url, query);</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>  <span class="hljs-keyword">if</span> (loading) {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>  <span class="hljs-keyword">if</span> (error) {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Error!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>);</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>  }</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>  <span class="hljs-keyword">const</span> posts = data ? data.posts.map(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> (</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.slug}</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{item.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{{__html:</span> <span class="hljs-attr">marked</span>(<span class="hljs-attr">item.content</span>)}} /&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>  )) : [];</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"App"</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>      {posts}</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App;</td></tr></table></code></pre><p>That way, we can specify a completely different shape for our response data every time we call a different endpoint, without creating a different hook for every different endpoint, and still enjoy properly typed responses from our hook.</p><p>Generics can be useful for many other purposes, such as specifying the contents of collections. For instance, if you had a <code>Collection</code> object, you could use a generic type to specify that any one instance must consist of instances of a given type. Flow would then flag it as an error if you assigned an item of the wrong type to that collection, thus making some unit tests redundant.</p></article><article class="post"><p class="date">11th March 2020 9:20 pm</p><h1><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></h1><p>A couple of years ago I posted <a href="https://matthewdaly.co.uk/blog/2018/01/12/creating-a-caching-user-provider-for-laravel/">this article</a> about constructing a caching user provider for Laravel. It worked, but with the benefit of hindsight I can now see that there were a number of issues with this solution:</p><ul><li>Because it extended the existing Eloquent user provider, it was dependent on the internals of that remaining largely the same - any change in how that worked could potentially break it</li><li>For the same reason, if you wanted to switch to a different user provider, you’d need to add the same functionality to that provider, either by writing a new provider from scratch or extending an existing one</li></ul><p>I’ve used the decorator pattern a few times in the past, and it’s a good fit for situations like this where you want to add functionality to something that implements an interface. It allows you to separate out one part of the functionality (in this case, caching) into its own layer, so it’s not dependent on any one implementation and can wrap any other implementation of that same interface you wish. Also, as long as the interface remains the same, there likely won’t be any need to change it when the implementation that is wrapped changes. Here I’ll demonstrate how to create a decorator to wrap the existing user providers.</p><p>If we only want to cache the <code>retrieveById()</code> method, like the previous implementation, the decorator class might look something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Auth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">Authenticatable</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">UserProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProviderDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@var</span> UserProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">private</span> $provider;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     * <span class="hljs-doctag">@var</span> Repository</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">private</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(UserProvider $provider, Repository $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">$this</span>-&gt;provider = $provider;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveById</span><span class="hljs-params">($identifier)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;remember(<span class="hljs-string">'id-'</span> . $identifier, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($identifier)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;retrieveById($identifier);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveByToken</span><span class="hljs-params">($identifier, $token)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;retrieveById($identifier, $token);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateRememberToken</span><span class="hljs-params">(Authenticatable $user, $token)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;updateRememberToken($user, $token);</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveByCredentials</span><span class="hljs-params">(array $credentials)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;retrieveByCredentials($credentials);</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * {<span class="hljs-doctag">@inheritDoc</span>}</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateCredentials</span><span class="hljs-params">(Authenticatable $user, array $credentials)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;provider-&gt;validateCredentials($user, $credentials);</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>}</td></tr></table></code></pre><p>It implements the same interface as the user providers, but accepts two arguments in the constructor, which are injected and stored as properties:</p><ul><li>Another instance of <code>Illuminate\Contracts\Auth\UserProvider</code></li><li>An instance of the cache repository <code>Illuminate\Contracts\Cache\Repository</code></li></ul><p>Most of the methods just defer to their counterparts on the wrapped instance - in this example I have cached the response to <code>retrieveById()</code> only, but you can add caching to the other methods easily enough if need be. You do of course still need to flush the cache at appropriate times, which is out of scope for this example, but can be handled by model events as appropriate, as described in the prior article.</p><p>Then you add the new decorator as a custom user provider, but crucially, you need to first resolve the provider you’re going to use, then wrap it in the decorator:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Gate</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Providers</span>\<span class="hljs-title">AuthServiceProvider</span> <span class="hljs-title">as</span> <span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">UserProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Auth</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">EloquentUserProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Auth</span>\<span class="hljs-title">UserProviderDecorator</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * The policy mappings for the application.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * <span class="hljs-doctag">@var</span> array</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">protected</span> $policies = [</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-string">'App\Model'</span> =&gt; <span class="hljs-string">'App\Policies\ModelPolicy'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * Register any authentication / authorization services.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;registerPolicies();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        Auth::provider(<span class="hljs-string">'cached'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($app, array $config)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            $provider = <span class="hljs-keyword">new</span> EloquentUserProvider($app[<span class="hljs-string">'hash'</span>], $config[<span class="hljs-string">'model'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>            $cache = $app-&gt;make(Repository::class);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UserProviderDecorator($provider, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Finally, set up the config to use the caching provider:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-string">'providers'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'users'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'cached'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'model'</span> =&gt; App\Eloquent\Models\User::class,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        ],</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    ],</td></tr></table></code></pre><p>This is pretty rough and ready, and could possibly be improved upon by allowing you to specify a particular provider to wrap in the config, as well as caching more of the methods, but it demonstrates the principle effectively.</p><p>By wrapping the existing providers, you can change the behaviour of the user provider without touching the existing implementation, which is in line with the idea of composition over inheritance. Arguably it’s more complex, but it’s also more flexible - if need be you can swap out the wrapped user provider easily, and still retain the same caching functionality.</p></article><article class="post"><p class="date">12th February 2020 10:40 pm</p><h1><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></h1><p>I’ve always been a big fan in general of tools that provide feedback about the quality of my code. The development role in which I spent the most time was one in which I had no peer feedback or mentoring at all, and while I could definitely have done with more peer review than I had, automated tools helped fill the gap a little bit. When I started building my first Phonegap app, about a year after I started programming professionally, it used <em>far</em> more Javascript than I’d ever used before, and JSLint was very helpful in instilling good practices at that early stage in my career.</p><p>In addition, I often find that using an automated tool largely eliminates the issue of ego - if your colleague Bob tells you something is a bad practice, you can potentially dismiss it as “That’s just Bob’s preferences”, whereas an automated tool is potentially much more objective. Nowadays, my typical set of static analysis tools on a project includes:</p><ul><li>ESLint</li><li>Flow</li><li>PHP CodeSniffer</li><li>Psalm</li></ul><p>However, I’m always dubious of using any static analysis tool that’s tightly integrated with a particular editor or IDE. In this post, I will explain my reasoning.</p><h1 id="in-editor-feedback">In-editor feedback</h1><p>Having instant feedback on the quality of your code is tremendously useful. Sure, you can run something like CodeSniffer from the command line and see what the problems are, but that’s nowhere near as useful as having it actually <em>in</em> your code. If you work on a legacy code base, there’s no way in hell you can wade through a long list of output in the terminal and fix them without losing the will to live. By comparison, actually seeing something flagged as an error where it actually occurs makes the mental cost of fixing it much smaller - you can see it in context, and can usually therefore resolve it more easily.</p><p>However, that doesn’t explicitly require that any one tool form an integral part of the editor. Most editors can hand off linting and static analysis to other, standalone tools, and doing so offers the following advantages:</p><ul><li>Less dependence on a given development environment - it’s always a struggle if you wind up stuck using a development environment you dislike (I grew to utterly despise Netbeans in my first role), but if you can use generic feedback tools that can be integrated with just about any editor, your team can use the development environment that suits them most, while still all benefiting from the feedback these tools provide</li><li>These tools tend to be open source, meaning you have the security of knowing that if the creator ceases maintaining it, either someone else may pick up the baton, or you can choose to fork it yourself. If a commercial IDE provider ceases trading, it’s likely you won’t be able to use their offering at all at some point in the future.</li></ul><p>Nowadays I use vim-ale in Neovim, and that provides real-time feedback for a number of linters and static analysis tools, including all those I mentioned above. I have comprehensive information on any issues in my code, and because any configuration is in simple text files that form part of the repository, it’s easy to update those settings for all developers working on the project to ensure consistency.</p><p>It’s possible that an integrated solution <em>might</em> offer a few advantages in terms of tighter integration with autocompletion and other functionality allowing for it, but whether they outweigh the tradeoffs mentioned here is dependent entirely on the implementation and how useful it is for any one team.</p><h1 id="continuous-integration-to-the-rescue">Continuous integration to the rescue</h1><p>There’s another issue I have with this sort of tightly integrated static analysis, which is probably the biggest, and that is that the feedback is available only at the level of an individual developer, not the team.</p><p>It’s great providing all this feedback to developers, but what if they just ignore it? Not all developers have had the sort of experience that leads one to really appreciate the value of coding standards and type hints, particularly if they’ve worked primarily on small or greenfield projects, or in environments where the emphasis was on churning out large quantities of work, and getting developers to tidy up the sort of issues these tools identify can sometimes be a tough sell when faced with code which, at least superficially, works.</p><p>Suppose you take on a new developer and ask them to work alone on a particular project for several months. Due to your own workload you can’t easily schedule code reviews with them, so you don’t see what they’re writing until they’re done. Then you take a look at what they’ve written and it’s full of issues that the IDE caught, but the developer either didn’t bother to fix, or didn’t know how to. What they’ve done may well work, but they’ve introduced a huge morass of technical debt that will slow down future development for the foreseeable future.</p><p>If your static analysis tools work only in the context of a given editor or IDE, then if the new dev introduce issues in the code base and doesn’t resolve them because they don’t know how, or don’t see the value, then the first you knows about it is when you clone the repo yourself and open it up. With a solution that runs in a CI environment, you can catch any reduction in code quality when it’s pushed. Sure, code reviews can do that too, but that requires manual input in a way that not every team is willing to spare, whereas a CI server, once set up, is largely self sustaining. And you could run one tool locally and another in a CI environment, but you can’t be sure they’ll necessarily catch all the same issues.</p><p>Now consider the same scenario if you’re using a separate code quality tool that’s integrated both into the editor, and your continuous integration workflow. Obviously, it will depend on your personal CI setup, but once code quality either begins to drop, or drops below a given level, the CI server will mark the build as failed, and you’ll be alerted. You can therefore then raise the issue with the new dev before it gets out of hand, and provide whatever support they need to resolve the problem there and then.</p><p>I personally maintain a legacy project in which, at one point prior to my arrival, a junior dev introduced an enormous amount of technical debt after working on it alone for six months. An integrated linter or static analysis tool probably wouldn’t have stopped that from happening, for the reasons stated above, but if a similar tool were part of the CI workflow, it could have been flagged as an issue much earlier and dealt with. Yes, leaving a junior dev unsupported and unsupervised for that length of time isn’t a great idea, but it happens, particularly in busy environments such as agencies. A good CI setup lets you see if someone is adding these kinds of issues, and act to nip it in the bud before it becomes too much of a problem, which is ultimately good for that developer’s career.</p><p>Peer pressure can also be a strong motivating factor under these circumstances. By simply displaying a metric, you encourage people’s natural competitiveness, so displaying code quality stats in your CI dashboard will encourage your team to do better in this regard, and no-one wants to be visibly seen to be letting the team down by producing substandard code.</p><p>For these reasons, where possible for feedback on code quality, I would always prefer to rely on a standalone tool that can be integrated with an editor, or used as part of a continuous integration workflow, as opposed to any IDE-specific functionality.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/">Lightweight Laravel - Deconstructing a Full Stack Framework</a></p><p><a href="/blog/2020/09/28/what-i-want-in-a-php-cms/">What I Want in a PHP CMS</a></p><p><a href="/blog/2020/06/13/flow-typed-ajax-responses-with-react-hooks/">Flow Typed AJAX Responses With React Hooks</a></p><p><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></p><p><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2021.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>