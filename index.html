<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">5th October 2018 7:36 pm</p><h1><a href="/blog/2018/10/05/understanding-the-pipeline-pattern/">Understanding the Pipeline Pattern</a></h1><p>In a previous post, I used the pipeline pattern to demonstrate processing letters using optical recognition and machine learning. The pipeline pattern is something I’ve found very useful in recent months. For a sequential series of tasks, this approach can make your code easier to understand by allowing you to break it up into simple, logical steps which are easy to test and understand individually. If you’re familiar with pipes and redirection in Unix, you’ll be aware of how you can chain together multiple, relatively simple commands to carry out some very complex transformations on data.</p><p>A few months back, I was asked to build a webhook for a Facebook lead form at work. One of my colleagues was having to manually export CSV data from Facebook for the data, and then import it into a MySQL database and a Campaign Monitor mailing list, which was an onerous task, so they asked me to look at more automated solutions. I wound up building a webhook with Lumen that would go through the following steps:</p><ul><li>Get the lead ID’s from the webhook</li><li>Pull the leads from the Facebook API using those ID’s</li><li>Process the raw data into a more suitable format</li><li>Save the data to the database</li><li>Push the data to Campaign Monitor</li></ul><p>Since this involved a number of discrete steps, I chose to implement each step as a separate stage. That way, each step was easy to test in isolation, and it was easily reusable. As it turned out, this approach saved us because Facebook needed to approve this app (and ended up rejecting it - their documentation at the time wasn’t clear on implementing server-to-server apps, making it hard to meet their guidelines), so we needed an interim solution. I instead wrote an Artisan task for importing the file from a CSV, which involved the following steps:</p><ul><li>Read the rows from the CSV file</li><li>Format the CSV data into the desired format</li><li>Save the data to the database</li><li>Push the data to Campaign Monitor</li></ul><p>This meant that two of the existing steps could be reused, as is, without touching the code or tests. I just added two new classes to read the data and format the data, and the Artisan command, which simply called the various pipeline stages, <em>and that was all</em>. In this post, I’ll demonstrate how I implemented this.</p><p>While there is more than one implementation of this available, and it wouldn’t be hard to roll your own, I generally use the PHP League’s <a href="https://pipeline.thephpleague.com/">Pipeline package</a>, since it’s simple, solid and well-tested. Let’s say our application has three steps:</p><ul><li>Format the request data</li><li>Save the data</li><li>Push it to a third party service.</li></ul><p>We therefor need to write a stage for each step in the process. Each one must be a callable, such as a closure, a callback, or a class that implements the <code>__invoke()</code> magic method. I usually go for the latter as it allows you to more easily inject dependencies into the stage via its constructor, making it easier to use and test. Here’s what our first stage might look like:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FormatData</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span>: <span class="hljs-title">Collection</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-string">'name'</span> =&gt; $item-&gt;fullname,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">'email'</span> =&gt; $item-&gt;email</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            ];</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>}</td></tr></table></code></pre><p>This class does nothing more than receive a collection, and format the data as expected. We could have it accept a request object instead, but I opted not to because I felt it made more sense to pass the data in as a collection so it’s not tied to an HTTP request. That way, it can also handle data passed through from a CSV file using an Artisan task, and the details of how it receives the data in the first place are deferred to the class that calls the pipeline in the first place. Note this stage also returns a collection, for handling by the next step:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Lead</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SaveData</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span>: <span class="hljs-title">Collection</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            $lead = <span class="hljs-keyword">new</span> Lead;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            $lead-&gt;name = $item-&gt;name;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            $lead-&gt;email = $item-&gt;email;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            $lead-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">return</span> $lead;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>This step saves each lead as an Eloquent model, and returns a collection of the saved models, which are passed to the final step:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">MailingList</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddDataToList</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $list;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(MailingList $list)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;list = $list;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">$this</span>-&gt;list-&gt;add([</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                <span class="hljs-string">'name'</span> =&gt; $item-&gt;name,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">'email'</span> =&gt; $item-&gt;email</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            ]);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></tr></table></code></pre><p>This step uses a wrapper class for a mailing service, which is passed through as a dependency in the constructor. The <code>__invoke()</code> method then loops through each Eloquent model and uses it to fetch the data, which is then added to the list. With our stages complete, we can now put them together in our controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">FormatData</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">SaveData</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">AddDataToList</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">Pipeline</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebhookController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request, Pipeline $pipeline, FormatData $formatData, SaveData $savedata, AddDataToList $addData)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">try</span> {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $data = Collection::make($request-&gt;get(<span class="hljs-string">'data'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $pipe = $pipeline-&gt;pipe($formatData)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>                -&gt;pipe($saveData)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>                -&gt;pipe($addData);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            $pipe-&gt;process($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        } <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> $e) {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-comment">// Handle exception</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></tr></table></code></pre><p>As mentioned above, we extract the request data (assumed to be an array of data for a webhook), and convert it into a collection. Then, we put together our pipeline. Note that we use dependency injection to fetch the steps - feel free to use method or constructor injection as appropriate. We instantiate our pipeline, and call the <code>pipe()</code> method multiple times to add new stages.</p><p>Finally we pass the data through to our pipe for processing by calling the <code>process()</code> method, passing in the initial data. Note that we can wrap the whole thing in a <code>try...catch</code> statement to handle exceptions, so if something happens that would mean we would want to cease processing at that point, we can throw an exception in the stage and handle it outside the pipeline.</p><p>This means that our controller is kept very simple. It just gets the data as a collection, then puts the pipeline together and passes the data through. If we subsequently had to write an Artisan task to do something similar from the command line, we could fetch the data via a CSV reader class, and then pass it to the same pipeline. If we needed to change the format of the initial data, we could replace the <code>FormatData</code> class with a single separate class with very little trouble.</p><p>Another thing you can do with the League pipeline package, but I haven’t yet had the occasion to try, is use <code>League\Pipeline\PipelineBuilder</code> to build pipelines in a more dynamic fashion. You can make steps conditional, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">PipelineBuilder</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>$builder = (<span class="hljs-keyword">new</span> PipelineBuilder)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    -&gt;add(<span class="hljs-keyword">new</span> FormatData);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">if</span> ($data[<span class="hljs-string">'type'</span>] = <span class="hljs-string">'foo'</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    $builder-&gt;add(<span class="hljs-keyword">new</span> HandleFooType);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>$builder-&gt;add(<span class="hljs-keyword">new</span> SaveData);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$pipeline = $builder-&gt;build();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>$pipeline-&gt;process($data);</td></tr></table></code></pre><p>The pipeline pattern isn’t appropriate for every situation, but for anything that involves a set of operations on the same data, it makes a lot of sense, and can make it easy to break larger operations into smaller steps that are easier to understand, test, and re-use.</p></article><article class="post"><p class="date">3rd October 2018 11:07 pm</p><h1><a href="/blog/2018/10/03/replacing-switch-statements-with-polymorphism-in-php/">Replacing Switch Statements With Polymorphism in PHP</a></h1><p>For the last few months, I’ve been making a point of picking up on certain antipatterns, and ways to avoid or remove them. One I’ve seen a lot recently is unnecessary large switch-case or if-else statements. For instance, here is a simplified example of one of these, which renders links to different objects:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">switch</span> ($item-&gt;getType()) {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">case</span> <span class="hljs-string">'audio'</span>:</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        $media = <span class="hljs-keyword">new</span> stdClass;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $media-&gt;type = <span class="hljs-string">'audio'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $media-&gt;duration = $item-&gt;getLength();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        $media-&gt;name = $item-&gt;getName();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $media-&gt;url = $item-&gt;getUrl();</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">case</span> <span class="hljs-string">'video'</span>:</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $media = <span class="hljs-keyword">new</span> stdClass;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        $media-&gt;type = <span class="hljs-string">'video'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $media-&gt;duration = $item-&gt;getVideoLength();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $media-&gt;name = $item-&gt;getTitle();</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $media-&gt;url = $item-&gt;getUrl();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td><span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="'</span>.$media-&gt;url.<span class="hljs-string">'" class="'</span>.$media-&gt;type.<span class="hljs-string">'" data-duration="'</span>.$media-&gt;duration.<span class="hljs-string">'"&gt;'</span>.$media-&gt;name.<span class="hljs-string">'&lt;/a&gt;'</span>;</td></tr></table></code></pre><p>There are a number of problems with this, most notably the fact that it’s doing a lot of work to try and create a new set of objects that behave consistently. Instead, your objects should be polymorphic - in other words, you should be able to treat the original objects the same.</p><p>While strictly speaking you don’t need one, it’s a good idea to create an interface that defines the required methods. That way, you can have those objects implement that interface, and be certain that they have all the required methods:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaItem</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLength</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></tr></table></code></pre><p>Then, you need to implement that interface in your objects. It doesn’t matter if the implementations are different, as long as the methods exist. That way, objects can define how they return a particular value, which is simpler and more logical than defining it in a large switch-case statement elsewhere. It also helps to prevent duplication. Here’s what the audio object might look like:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MediaItem</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Audio</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaItem</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLength</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;length;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;name;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;type;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;url;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>And here’s a similar example of the video object:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">MediaItem</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Video</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaItem</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLength</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;getVideoLength();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;getTitle();</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;type;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;url;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>}</td></tr></table></code></pre><p>With that done, the code to render the links can be greatly simplified:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="'</span>.$item-&gt;getUrl().<span class="hljs-string">'" class="'</span>.$item-&gt;getType().<span class="hljs-string">'" data-duration="'</span>.$item-&gt;getLength().<span class="hljs-string">'"&gt;'</span>.$media-&gt;getName().<span class="hljs-string">'&lt;/a&gt;'</span>;</td></tr></table></code></pre><p>Because we can use the exact same methods and get consistent responses, yet also allow for the different implementations within the objects, this approach allows for much more elegant and readable code. Different objects can be treated in the same way without the need for writing extensive if or switch statements.</p><p>I haven’t had the occasion to do so, but in theory this approach is applicable in other languages, such as Javascript or Python (although these languages don’t have the concept of interfaces). Since discovering the swtch statement antipattern and how to replace it with polymorphism, I’ve been able to remove a lot of overly complex code.</p></article><article class="post"><p class="date">25th September 2018 10:03 pm</p><h1><a href="/blog/2018/09/25/career-direction-after-seven-years/">Career Direction After Seven Years</a></h1><p>Earlier this month, I passed the seven year anniversary of starting my first web dev job. That job never really worked out, for various reasons, but since then I’ve had an interesting time of it. I’ve diversified into app development via Phonegap, and I’ve worked with frameworks that didn’t exist when I first started. So it seems a good opportunity to take stock and think about where I want to head next.</p><p>Sometimes these posts are where someone announces they’re leaving their current role, but that’s not the case here - I’m pretty happy where I am right now. I am maintaining a legacy project, but I do feel like I’m making a difference and it’s slowly becoming more pleasant to work with, and I’m learning a lot about applying design patterns, so I think where I am right now is a good place for me. However, it’s a useful exercise to think about what I want to do, where I want to concentrate my efforts, and what I want to learn about.</p><p>So, here are my thoughts about where I want to go in future:</p><ul><li>I really enjoy working with React, and I want to do so much more than I have in the past, possibly including React Native. Ditto with Redux.</li><li>Much as I love Django, it’s unlikely I’ll be using it again in the future, as it’s simply not in much demand where I live. In 2015, I was working at a small agency with a dev team of three, including me, and it became apparent that we needed to standardise on a single framework. I’d been using CodeIgniter on and off for several years, but it was tired and dated, yet I couldn’t justify using Django because no-one else was familiar with Python, so we settled on Laravel. Ever since, Laravel has been my go-to framework - Django does some things better (Django REST Framework remains the best way I’ve ever found to create a REST API), but Laravel does enough stuff well enough that I can use it for most things I need, so it’s a good default option.</li><li>I <em>really</em> don’t want to work with Wordpress often, and if I do, I’d feel a lot better about it if I used Bedrock. Just churning out boilerplate sites is anathema to me - I’d much rather do something more interesting, even if it were paid worse.</li><li>PHP is actually pretty nice these days (as long as you’re not dealing with a legacy application), and I generally don’t mind working with it, as long as it’s fairly modern.</li><li>I enjoy mentoring and coaching others, and I’d like to do that a lot more often than I have been doing. Mentoring and coaching is a big part of being a senior developer, since a good mentor can quickly bring inexperienced developers up to a much higher standard, and hugely reduces the amount of horrible legacy code that needs to be maintained. I was without an experienced mentor for much of my career, and in retrospect it held me back - having someone around to teach me about TDD and design patterns earlier would have helped no end. Also, I find it the single most rewarding part of my job.</li><li>I have absolutely no desire whatsoever to go into management, or leave coding behind in any way, shape or form. I’ve heard it said before that Microsoft have two separate career tracks for developers, one through people management, the other into a software architect role, and were I there, I would definitely opt for the latter.</li><li>I’m now less interested in learning new frameworks or languages than I am in picking up and applying new design patterns, and avoiding antipatterns - they’re the best way to improve your code quality. I’ve learned the hard way that the hallmark of a skilled developer’s code is not the complexity, but the simplicity - I can now recognise the convoluted code I wrote earlier in my career as painful to maintain, and can identify it in legacy projects.</li><li>I’ve always used linters and other code quality tools, and I’m eager to evangelise their usage.</li><li>I’ve been a proponent of TDD for several years now, and that’s going to continue - I’ve not only seen how many things it catches when you have tests, but also how painful it is when you have a large legacy project with no tests at all, and I’m absolutely staggered that anyone ever continues to write non-trivial production code without any sort of tests.</li><li>I want to understand the frameworks I use at a deeper level - it’s all too easy to just treat them as magic, when there are huge benefits to understanding how your framework works under the bonnet, and how to swap out the framework’s functionality for alternative implementations.</li><li>I’d like to get involved in more IoT-related projects - guess the 3 Raspberry Pi’s and the Arduino I have gathering dust at home need to get some more use…</li><li>Chat interfaces are interesting - I built an Alexa skill recently, which was fun and useful, and I’d like to do stuff like that more often.</li></ul><p>So, after seven years, that’s where I see myself going in future. I think I’m in a good place to do that right now, and I’ll probably stay where I am for a good long while yet. The first seven years of my web dev career have been interesting, and I’m eager to see what the next seven bring.</p></article><article class="post"><p class="date">24th September 2018 10:30 pm</p><h1><a href="/blog/2018/09/24/how-i&#x27;m-refactoring-a-zend-1-legacy-project/">How I&#x27;m Refactoring a Zend 1 Legacy Project</a></h1><p>In my current job I’ve been maintaining and developing a Zend 1 legacy project for the best part of a year. It has to be said, it’s the worst code base I have ever seen, with textbook examples of many antipatterns, spaghetti jQuery, copy-pasted code and overly complex methods. It’s a fairly typical example of a project built on an older MVC framework by inexperienced developers (I’ve been responsible for building similar things in my CodeIgniter days).</p><p>In this article I’ll go through some of the steps I’ve taken to help bring this legacy project under control. Not all of them are complete as at time of writing, but they’ve all helped to make this decidedly crappy project somewhat better. In working with this legacy project, I’ve found Paul Jones’ book <em>Modernizing Legacy Applications in PHP</em> to be very useful, and if you’re working on a similar legacy project, I highly recommend investing in a copy. I’ve also found <a href="https://sourcemaking.com/">Sourcemaking</a> to be a useful resource in identifying antipatterns in use, refactoring strategies, and applicable design patterns.</p><h1 id="moving-to-git">Moving to Git</h1><p>When I first started working on the project, the repository was in Subversion, and was absolutely colossal - checking it out took two hours! Needless to say, my first action was to migrate it to Git. I used <a href="https://john.albin.net/git/convert-subversion-to-git">this post</a> as a guide, and it was pretty straightforward, but took all of my first day.</p><h1 id="adding-migrations">Adding migrations</h1><p>The next job involved making some changes to the database. Unfortunately, Zend 1 doesn’t include migrations, and no-one had added a third party solution. I therefore did some research and wound up stumbling across <a href="https://phinx.org/">Phinx</a>, which is a standalone migration package with a command-line runner. Using that, it was straightforward to start adding migrations to make any necessary changes to the database structure and fixtures.</p><h1 id="moving-dependencies-to-composer">Moving dependencies to Composer</h1><p>The project was using Composer, but only to a limited degree - the framework itself was in the <code>library/</code> folder, and several other dependencies were also stored here. The <code>vendor/</code> directory was also checked into version control. I therefore took the vendor folder out of Git, and added <code>zendframework/zendframework1</code> as a dependency. This drastically reduced the size of the repository.</p><h1 id="cleaning-up-commented-code">Cleaning up commented code</h1><p>There was an awful lot of commented code. Some of it was even commented out incorrectly (PHP code commented out with HTML comments). I’m of the school of thought that commented code is best deleted without a second thought, since it can be retrieved from version control, and it can be confusing, so I’ve been removing any commented code I come across.</p><h1 id="refactoring-duplicate-code">Refactoring duplicate code</h1><p>One of the biggest problems with the code base was the high level of duplication - a lot of code, particularly in the view layer, had been copied and pasted around. Running PHPCPD on the repository showed that, not including the views, around 12% of the code base was copied-and-pasted, which is a horrific amount. I therefore started aggressively refactoring duplicate code out into helpers and traits. As at today, the amount of duplication excluding the views is around 2.6%, which is obviously a big improvement.</p><h1 id="refactoring-object-creation-code-into-persisters">Refactoring object creation code into persisters</h1><p>There was some extremely complex code for creating and updating various objects that was jammed into the controllers, and involved a lot of duplicate code. I’ve used dedicated persister classes in the past with great effect, so I pulled that code out into persisters to centralise the logic about the creation of different objects. It’s still a lot more convoluted than I’d like, but at least now it’s out of the controllers and can be tested to some extent.</p><h1 id="creating-repositories">Creating repositories</h1><p>One of the most problematic parts of the code base is the models. Whoever was responsible for them couldn’t seem to decide whether they represented a single domain object, or a container for methods for getting those objects, so both responsibilities were mixed up in the same class. This means you had to instantiate an object, then use it to call one of the methods to get another instance of that object, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$media = <span class="hljs-keyword">new</span> Application_Model_Media;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$media = $media-&gt;find(<span class="hljs-number">1</span>);</td></tr></table></code></pre><p>I’ve therefore resolved to pull those methods out into separate repository classes, leaving the models as pure domain objects. Unfortunately, the lack of dependency injection makes it problematic to instantiate the repositories. For that reason, right now the repositories only implement static methods - it’s not ideal, but it’s better than what we have now.</p><p>I started out by creating interfaces for the methods I wanted to migrate, and had the models implement them. Then, I moved those methods from the model to the repository classes and amended all references to them, before removing the interfaces from the models. Now, a typical find request looks like this:</p><pre><code class="hljs lang-php singleline">$media = App\Repository\Media::find(<span class="hljs-number">1</span>);</code></pre><p>It’s not done yet, but over half of them have been migrated.</p><p>Once that’s done, I’ll then be in a position to look at refactoring the logic in the models to make them easier to work with - right now each model has dedicated setters and getters (as well as some horrific logic to populate them), and I’m considering amending them to allow access to the properties via the <code>__get()</code> and <code>__set()</code> magic methods. Another option is to consider migrating the database layer to Doctrine, since that way we can reuse the getters and setters, but I haven’t yet made a firm decision about that.</p><h1 id="adding-tests">Adding tests</h1><p>The poor design of this application makes it difficult to test, so right now the coverage is poor. I’ve been using Behat to produce a basic set of acceptance tests for some of the most fundamental functionality, but they’re brittle and can be broken by database changes. I’ve also added some (even more brittle) golden master tests using a technique I’ll mention in a later blog post. I have got unit tests for three of the persister classes and some utility classes I’ve added, but nowhere near the level I want.</p><h1 id="refactoring-code-out-of-the-fat-controllers">Refactoring code out of the fat controllers</h1><p>Fat controllers are an antipattern I’ve seen, and indeed been responsible for myself, in the past, and this project has them in spades - running PHP Mess Detector on them is pretty sobering. The overwhelming majority of the code base is concentrated in the controllers, and it’s going to take a long time to refactor it into other classes.</p><p>Zend 1 does have the concept of controller helpers, and that’s been useful for removing some duplicate code, while more shared code has been refactored out into traits. In addition, the utilities I’ve added include a Laravel-style collection class, and using that I’ve been able to refactor a lot of quite complex array handling into much simpler chained collection handling. However, this is still going to take a lot of effort.</p><h1 id="adding-events">Adding events</h1><p>The lack of a decent event system caused particular problems when I was asked to add tracking of when a user views certain resources, so I used the <a href="http://event.thephpleague.com/2.0/">PHP League’s Event package</a> for this. I’ve started moving some other functionality to event listeners too, but this is another thing that will take a long time.</p><h1 id="refactoring-the-front-end">Refactoring the front end</h1><p>Like many legacy projects, the front end is a horrible mess of jQuery spaghetti code, with some Handlebars templates thrown in here and there for good measure. It’s easily complex enough that it would benefit from a proper front-end framework, but a full rewrite is out of the question.</p><p>I was recently asked to add two new modals in the admin interface, and decided that it was worth taking a new approach rather than adding yet more jQuery spaghetti. Angular 1 is on its way out, so that wasn’t an option, and Angular 2+ would necessitate using Typescript, which would likely be problematic in the context of a legacy app, as well as the complexity being an issue. Vue was a possibility, but I always feel like Vue tries to do too much. Instead, I decided to go for React, because:</p><ul><li>I’ve always enjoyed working with React, even though I haven’t had much chance to do so in the past.</li><li>We’re using Laravel Mix for processing the CSS and JS files (it can be used on non-Laravel projects), and it has a preset for React</li><li>React is well-suited to being added incrementally to existing projects without the need for a full rewrite (after all, it works for Facebook…), so it was straightforward to do a single modal with it</li><li>It’s easy to test - you can use snapshot tests to check it remains consistent, and using Enzyme it’s straightforward to navigate the rendered component for other tests</li></ul><p>Both modals turned out very well, and went live recently. The first one took a fair while to write, and then when I wrote the second one, I had to spend some time making the sub-components more generic and pulling some functionality out into a higher order component, but now that that’s done it should be straightforward to write more.</p><p>In the longer term I plan to migrate more and more of the admin to React over time. The front end also has a new home page on the cards, and the plan is to use React for that too. Once the whole UI is using React, that will have eliminated most, if not all, of the problems with duplicate code in the view layer, as well as allowing for eventually turning the application into a single-page web app.</p><h1 id="upgrading-the-php-version-and-migrating-to-a-new-server">Upgrading the PHP version and migrating to a new server</h1><p>When I started work on the project, it was running on an old server running PHP 5.4, but there were plans to migrate to a new server running PHP 5.6. The lack of tests made it difficult to verify it wouldn’t break in 5.6, but using PHP Compatibility and CodeSniffer I was able to find most of the problems. I ran it on PHP 5.6 locally during development so that any new development would be done on a more modern version. In the end, the migration to the new server was fairly seamless.</p><p>We will have to consider migrating to a newer PHP version again, since 5.6 is no longer supported as at the end of this year, but it may be too risky for now.</p><h1 id="namespacing-the-code">Namespacing the code</h1><p>As Zend 1 predates PHP namespaces, the code wasn’t namespaced. This is something I do plan to remedy - the form and model classes should be straightforward to namespace, but the controllers are a bit more problematic. I’m waiting on completing the repositories before I look at this.</p><h1 id="adding-psr-3-logging">Adding PSR-3 logging</h1><p>The existing logging solution was not all that great. It had drivers for several different logging solutions, but nothing terribly modern - one was for the now-discontinued Firebug extension for Firefox. However, it was fairly similar to PSR-3, so it wasn’t too much work to replace it. I installed Monolog, and amended the bootstrap file to store that as the logger in the Zend registry - that way, we could set up many different handlers. I now have it logging to a dedicated Slack channel when an error occurs in staging or production, which makes it much easier to detect problems. This would also make it easy to set up many other logging handlers, such as the ELK stack.</p><h1 id="debugging">Debugging</h1><p><a href="https://underground.works/clockwork/">Clockwork</a> is my usual PHP debugging solution, and the absence of support for it in Zend 1 made it difficult to work with. Fortunately, it’s quite straightforward to implement your own <a href="https://underground.works/clockwork/extending-data-sources?#content">data sources</a> for Clockwork. I set it up to use the aforementioned logger as a data source, as well as the <a href="https://framework.zend.com/manual/1.12/en/zend.db.profiler.html">Zend 1 profiler</a>. I also added a data source for the events implementation, and added a global <code>clock()</code> helper function, as well as one for the Symfony VarDumper component. Together these give me a reasonably good debugging experience.</p><h1 id="adding-console-commands">Adding console commands</h1><p>I’ve mentioned before that I’ve been using Symfony’s console component a lot lately, and this project is why. Zend 1 does not come with any sort of console task runner, and we needed an easy way to carry out certain tasks, such as:</p><ul><li>Setting up a stored procedure</li><li>Anonymizing user data with Faker</li><li>Regenerating durations for audio and video files</li></ul><p>In addition, I wanted a Laravel Tinker-style interactive shell. I was able to accomplish this with PsySh and the console components. For legacy projects that lack a console task runner, it’s worth considering adding one.</p><h1 id="configuration">Configuration</h1><p>The configuration system in Zend 1 is downright painful - it requires that you define multiple environments in there. I have integrated DotEnv, but only part of the configuration has been migrated over, so there’s still plenty of work there.</p><h1 id="what-s-left-to-do">What’s left to do</h1><p>The code base is in a much better state than it was, but there’s still an awful lot to do. Zend 1 does apparently still work with PHP 7.1, but not with 7.2, so at some point we’ll likely need to leave Zend 1 behind entirely. This process has already started with us ditching Zend_Log for Monolog, and over time I plan to replace the various components of Zend 1 with other packages, either ones from newer versions of Zend Framework, or elsewhere. While there are many articles about migrating Zend 1 to later versions, very few of them actually seem to go into much detail - certainly nothing as useful as a step-by-step guide.</p><p>The database layer is particularly bad, and refactoring some of the methods into repository classes is only the first step in bringing that under control. Once that’s finished, I’m going to start going through the models and seeing if any more methods would make more sense as static methods on the repository, and possibly rename some of them. Then, we can think about the possibility of either incrementally migrating to another database interface (either a newer version of Zend DB, or Doctrine), or refactoring the existing models to have less boilerplate by using magic methods instead of getters and setters.</p><p>Dependency injection is a must at some point, but isn’t practical right now - Zend 1 controllers implement an interface that defines the constructor arguments, so you can’t pass in any additional parameters, so that will need to wait until the controllers no longer use Zend 1. I have been using the Zend Registry as a poor man’s DI container, since it allows sharing of a single object throughout the application, but it’s not a good solution in the long term.</p><p>The routing is also painful - Zend 1’s routes are all stored in the bootstrap file. I’d prefer to use something like <code>league/route</code>, which would allow for handling different HTTP methods to the same route using different controller methods, making it easier to separate out handling of GET and POST requests.</p><p>I also want at some point to set up a queue system for processing video and audio content - at present it’s handled by running a shell command from PHP, which means you can’t easily get feedback if something goes wrong. Migrating that to a queue system, backed with something like Redis, would help a great deal.</p><h1 id="share-your-stories">Share your stories</h1><p>I’d love to hear any similar stories about refactoring legacy applications - how you’ve solved various problems with those legacy apps (or how you’d solve the ones I’ve had), tools you’ve used, and so on. Feel free to provide details in the comments.</p><p>A legacy project like this can be very frustrating to work with, but it can also feel quite rewarding to bring it under control over a period of time. My experience has been that you get the best results by working in small, regular steps, and over time your experience working with the code base will improve.</p></article><article class="post"><p class="date">13th September 2018 8:10 pm</p><h1><a href="/blog/2018/09/13/mutation-testing-with-infection/">Mutation Testing With Infection</a></h1><p>Writing automated tests is an excellent way of catching bugs during development and maintenance of your application, not to mention the other benefits. However, it’s hard to gauge the quality of your tests, particularly when you first start out. Coverage will give you a good idea of what code was actually run during the test, but it won’t tell you if the test itself actually tests anything worthwhile.</p><p><a href="https://infection.github.io/">Infection</a> is a mutation testing framework. The documentation defines mutation testing as follows:</p><blockquote><p>Mutation testing involves modifying a program in small ways. Each mutated version is called a Mutant. To assess the quality of a given test set, these mutants are executed against the input test set to see if the seeded faults can be detected. If mutated program produces failing tests, this is called a killed mutant. If tests are green with mutated code, then we have an escaped mutant.</p></blockquote><p>Infection works by running the test suite, carrying out a series of mutations on the source code in order to try to break the tests, and then collecting the results. The actual mutations carried out are not random - there is a set of mutations that get carried out every time, so results should be consistent. Ideally, all mutants should be killed by your tests - escaped mutants can indicate that either the line of mutated code is not tested, or the tests for that line are not very useful.</p><p>I decided to add mutation testing to my <a href="https://github.com/matthewbdaly/laravel-cart">Laravel shopping cart package</a>. In order to use Infection, you need to be able to generate code coverage, which means having either XDebug or phpdbg installed. Once Infection is installed (refer to the documentation for this), you can run this command in the project directory to configure it:</p><pre><code class="hljs lang-bash singleline">$ infection</code></pre><p>Infection defaults to using PHPUnit for the tests, but it also supports PHPSpec. If you’re using PHPSpec, you will need to specify the testing framework like this:</p><pre><code class="hljs lang-bash singleline">$ infection --<span class="hljs-built_in">test</span>-framework=phpspec</code></pre><p>Since PHPSpec doesn’t support code coverage out of the box, you’ll need to install a package for that - I used <code>leanphp/phpspec-code-coverage</code>.</p><p>On first run, you’ll be prompted to create a configuration file. Your source directory should be straightforward to set up, but at the next step, if your project uses interfaces in the source directory, you should exclude them. The rest of the defaults should be fine.</p><p>I found that the first run gave a large number of uncovered results, but the second and later ones were more consistent - not sure if it’s an issue with my setup or not. Running it gave me this:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    0 [&gt;---------------------------] &lt; 1 secRunning initial <span class="hljs-built_in">test</span> suite...</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   27 [============================] 3 secs</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 43/43</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>...................MMM...M.......M.........          (43 / 43)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>43 mutations were generated:</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      38 mutants were killed</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       5 covered mutants were not detected</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 88%</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 88%</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 21s. Memory: 12.00MB</td></tr></table></code></pre><p>Our test run shows 5 escaped mutants, and the remaining 38 were killed. We can view the results by looking at the generated <code>infection-log.txt</code>:</p><pre><code class="hljs lang-txt"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Escaped mutants:</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>================</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-number">1</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] DecrementInteger</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">-1</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-number">2</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] OneZeroInteger</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">1</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td><span class="hljs-number">3</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] GreaterThan</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt;= <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td><span class="hljs-number">4</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">133</span>    [M] Assignment</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>                 <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>-                    $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>+                    $item[<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>             <span class="hljs-keyword">return</span> $item;</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td><span class="hljs-number">5</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">197</span>    [M] OneZeroInteger</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>      */</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasStringKeys</span><span class="hljs-params">(array $items)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>-        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>+        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>     }</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>     <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>      * Validate input</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>Timed Out mutants:</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>==================</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>Not Covered mutants:</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>====================</td></tr></table></code></pre><p>This displays the mutants that escaped, and include a diff of the changed code, so we can see that all of these involve changing the comparison operators.</p><p>The last one can be resolved easily because the comparison is superfluous - the result of <code>count()</code> can be evaluated as true or false by itself, so removing the <code>&gt; 0</code> at the end in the test solves the problem quite neatly.</p><p>The other four mutations are somewhat harder. They all amend the <code>decrement</code> method’s conditions, showing that a single assertion doesn’t really fully check the behaviour. Here’s the current test for that method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>It should be possible to decrement it if the quantity is more than zero, but not to go any lower. However, our current test does not catch anything but decrementing it from 2 to 1, which doesn’t fully demonstrate this. We therefore need to add a few more assertions to cover taking it down to zero, and then trying to decrement it again. Here’s how we might do that.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        $newerdata = $newdata;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        $newerdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newdata);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newerdata);</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>If we re-run Infection, we now get a much better result:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Running initial <span class="hljs-built_in">test</span> suite...</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   22 [============================] 3 secs</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 41/41</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>.........................................            (41 / 41)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>41 mutations were generated:</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      41 mutants were killed</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       0 covered mutants were not detected</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 100%</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 100%</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 19s. Memory: 12.00MB</td></tr></table></code></pre><p>Code coverage only tells you what lines of code are actually executed - it doesn’t tell you much about how effectively that line of code is tested. Infection gives you a different insight into the quality of your tests, helping to write better ones. I’ve so far found it very useful for getting feedback on the quality of my tests. It’s interesting that PHPSpec tests seem to have a consistently lower proportion of escaped mutants than PHPUnit ones - perhaps the more natural workflow when writing specs with PHPSpec makes it easier to write good tests.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/10/05/understanding-the-pipeline-pattern/">Understanding the Pipeline Pattern</a></p><p><a href="/blog/2018/10/03/replacing-switch-statements-with-polymorphism-in-php/">Replacing Switch Statements With Polymorphism in PHP</a></p><p><a href="/blog/2018/09/25/career-direction-after-seven-years/">Career Direction After Seven Years</a></p><p><a href="/blog/2018/09/24/how-i&#x27;m-refactoring-a-zend-1-legacy-project/">How I&#x27;m Refactoring a Zend 1 Legacy Project</a></p><p><a href="/blog/2018/09/13/mutation-testing-with-infection/">Mutation Testing With Infection</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>