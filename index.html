<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">27th October 2019 9:20 pm</p><h1><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></h1><p>Like many developers who use React.js, I’ve been eager to explore the Hooks API in the last year or so. They allow for easier ways to share functionality between components, and can allow for a more expressive syntax that’s a better fit for Javascript than class-based components. Unfortunately, they became production ready around the time I rolled out a new React-based home page, so I didn’t want to jump on them immediately in the context of a legacy application. I’m now finding myself with a bit of breathing space, so I’ve begun refactoring these components, and converting some to use hooks, in order to more easily reuse some code that currently resides in a big higher-order component.</p><p>The <code>useState</code> and <code>useEffect</code> hooks are by far the most common hooks in most applications. However, I’ve found that the React documentation, while OK at explaining how to use these individually, is not so good at explaining how to use them together, particularly in the case of an input component, which is a common use case when looking to convert existing components. For that reason, I’m going to provide a short example of how you might use them together for that use case.</p><h2 id="a-simple-function-component">A simple function component</h2><p>A basic component for an input might look like this:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>//@flow</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">type</span> Props = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-type">name</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  id: string,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">value</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  placeholder: string</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>const Input = (props: Props) =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>="text" <span class="hljs-type">name</span>={props.name} id={props.id} <span class="hljs-keyword">value</span>={props.<span class="hljs-keyword">value</span>} placeholder={props.placeholder} /&gt;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>export <span class="hljs-keyword">default</span> <span class="hljs-keyword">Input</span>;</td></tr></table></code></pre><p>Note I’m using Flow annotations to type the arguments passed to my components. If you prefer Typescript it should be straightforward to convert to that.</p><p>As you can see, this component accepts a name, ID, value and placeholder as props. If you add this to an existing React app, or use <code>create-react-app</code> to create one and add this to it, you can include it in another component as follows:</p><pre><code class="hljs lang-jsx singleline">&lt;Input <span class="hljs-attribute">name</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attribute">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attribute">value</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attribute">placeholder</span>=<span class="hljs-string">"foo"</span> /&gt;</code></pre><h2 id="adding-state">Adding state</h2><p>This will render, but as the value will never change it’s not actually of any use in a form. If you’ve written class-based React components before, you’ll know that the usual way to handle this is to move the value of the input from props to state. Prior to the introduction of the Hooks API, while you could create a function component, you couldn’t use state with it, making situations like this difficult to handle. Fortunately, the <code>useState</code> hook now allows you to add state to a function component as follows:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>//@flow</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">type</span> Props = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-type">name</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  id: string,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">value</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  placeholder: string</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>const Input = (props: Props) =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  const [<span class="hljs-keyword">value</span>, setValue] = useState(props.<span class="hljs-keyword">value</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>="text" <span class="hljs-type">name</span>={props.name} id={props.id} <span class="hljs-keyword">value</span>={<span class="hljs-keyword">value</span>} placeholder={props.placeholder} onChange={(e) =&gt; setValue(e.target.<span class="hljs-keyword">value</span>)} /&gt;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>export <span class="hljs-keyword">default</span> <span class="hljs-keyword">Input</span>;</td></tr></table></code></pre><p>We import the <code>useState</code> hook at the top, as usual. Then, within the body of the component, we call <code>useState()</code>, passing in the initial value of <code>props.value</code>, and get back two variables in response:</p><ul><li><code>value</code> is the value of the state variable, and can be thought of as equivalent to what <code>this.state.value</code> would be in a class-based component</li><li><code>setValue</code> is a function for updating <code>value</code> - rather than explicitly defining a function for this, we can just get one back from <code>useState()</code></li></ul><p>Now we can set the value with <code>value={value}</code>. We also need to handle changes in the state, so we add <code>onChange={(e) =&gt; setValue(e.target.value)}</code> to call <code>setValue()</code> on a change event on the input.</p><h2 id="handling-effects">Handling effects</h2><p>The component will now allow you to edit the value. However, one problem remains. If you open the React dev tools, go to the props for this component, and set <code>value</code> manually, it won’t be reflected in the input’s value, because the state has diverged from the initial value passed in as a prop. We need to be able to pick up on changes in the props and pass them through as state.</p><p>In class-based components, there are lifecycle methods that fire at certain times, such as <code>componentDidMount()</code> and <code>componentDidUpdate()</code>, and we would use those to handle that situation. Hooks condense these into a single <code>useEffect</code> hook that is more widely useful. Here’s how we might overcome this problem in our component:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>//@flow</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> React, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">type</span> Props = {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>  <span class="hljs-type">name</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>  id: string,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>  <span class="hljs-keyword">value</span>: string,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  placeholder: string</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>};</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>const Input = (props: Props) =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  const [<span class="hljs-keyword">value</span>, setValue] = useState(props.<span class="hljs-keyword">value</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>  useEffect(() =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    setValue(props.<span class="hljs-keyword">value</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  }, [props.<span class="hljs-keyword">value</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-keyword">return</span> (</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>="text" <span class="hljs-type">name</span>={props.name} id={props.id} <span class="hljs-keyword">value</span>={<span class="hljs-keyword">value</span>} placeholder={props.placeholder} onChange={(e) =&gt; setValue(e.target.<span class="hljs-keyword">value</span>)}/&gt;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>  );</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>export <span class="hljs-keyword">default</span> <span class="hljs-keyword">Input</span>;</td></tr></table></code></pre><p><code>useEffect</code> takes one compulsory argument, in the form of a callback. Here we’re using that callback to set our state variable back to the value of the prop passed through.</p><p>Note the second argument, which is an array of variables that should be watched for changes. If we had used the following code instead:</p><pre><code class="hljs lang-jsx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>  useEffect(() =&gt; {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    setValue(<span class="hljs-name">props</span>.value)<span class="hljs-comment">;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  })<span class="hljs-comment">;</span></td></tr></table></code></pre><p>Then the callback would fire after every render, reverting the value back and possibly causing an infinite loop. For that reason, we pass through the second argument, which tells React to only fire the callback if one of the specified variables has changed. Here we only want to override the state when the value props passed down to the component changes, so we pass that prop in as an argument.</p><h2 id="summary">Summary</h2><p>This is only a simple example, but it does show how simple and expressive hooks can make your React components, and how to use the <code>useEffect</code> and <code>useState</code> hooks together, which was something I found the documentation didn’t make clear. These two hooks cover a large chunk of the functionality of React, and knowledge of them is essential to using React effectively.</p></article><article class="post"><p class="date">13th October 2019 11:10 pm</p><h1><a href="/blog/2019/10/13/flexible-data-types-with-the-json-field/">Flexible Data Types With the JSON Field</a></h1><p>Relational databases have many advantages over other data stores. They’re (mostly) solid, mature products, they have the means to prevent data duplication while still allowing related data to be accessed, and they allow for easy enforcement of data types. However, the latter point has also historically made them less flexible compared to document databases such as MongoDB, which allow for fields to be set dynamically, making it much easier to set content arbitrarily.</p><p>One area in which this has caused particular problems is with content management systems, where you might want to be able to set custom content types that need to be treated the same in some circumstances, and have some fields in common, but store different data. If you want to be able to store arbitrary data against a particular entity, historically the main way to do that is to create a meta table to contain keys and values, and set the entity ID as a foreign key in the new table.</p><p>Wordpress is a common example of this. Any piece of content is stored in the <code>wp_posts</code> table, which in addition to the generic structure of a post, also includes the <code>post_type</code> field. It’s possible to create and register your own post types, but it’s not possible to store additional custom data in that table. Instead, it’s stored as keys and values in the <code>wp_postmeta</code> table, meaning you need to do a join to retrieve that content at the same time, making for more complex queries.</p><p>Another approach is to have a generic entity table that contains the common fields, and separate tables for the rest, and then set up a one-to-one relationship between them. However, that can be fiddly too because it doesn’t allow for custom types in the same way, so it may not fit with your use case if you need to be able to create arbitrary content types, such as for a CMS that allowed for custom content types.</p><h2 id="introducing-json-fields">Introducing JSON fields</h2><p>JSON fields allow you to bring some of the flexibility of document databases to the relational world. They allow you to store whatever arbitrary text data you wish as JSON, and retrieve it as usual. More importantly, they also allow you to query by that data, so you can easily filter by fields that need not be set in stone with a database schema.</p><p>This means that in the above example of a CMS, instead of having a separate meta table, you can instead store the meta values in a JSON field, thus removing the need for a join and simplifying querying by those values.</p><p>PostgreSQL has had this capability for a long time, but it’s only comparatively recently that MySQL and MariaDB versions that support it have become widespread. Here I’ll show you how you might use it in a Laravel application.</p><p>The example will be a content management system with flexible content types. The first step is to create the migration to add the new content table:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">Migration</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Schema</span>\<span class="hljs-title">Blueprint</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateContent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Run the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        Schema::create(<span class="hljs-string">'content'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $table-&gt;bigIncrements(<span class="hljs-string">'id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $table-&gt;string(<span class="hljs-string">'type'</span>, <span class="hljs-number">20</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            $table-&gt;json(<span class="hljs-string">'attributes'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            $table-&gt;timestamps();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     * Reverse the migrations.</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        Schema::dropIfExists(<span class="hljs-string">'content'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></tr></table></code></pre><p>Here we’re specifying the following fields:</p><ul><li>An auto-incrementing ID (feel free to swap this out for a UUID if it makes sense for your application)</li><li>A string denoting the content type. If you want to limit the values these can accept, you can replace it with an <code>ENUM</code> field</li><li>The JSON field, named <code>attributes</code></li><li>The standard Laravel timestamp fields, <code>created_at</code> and <code>updated_at</code></li></ul><p>If there are certain fields that are common to all of your content types, it would also make sense to define them as fields in the usual way, rather than use the JSON field, since compulsory fields should be enforced by the database.</p><p>Next, we’ll create the model:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Content</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">protected</span> $table = <span class="hljs-string">'content'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> $casts = [</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-string">'attributes'</span> =&gt; <span class="hljs-string">'array'</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    ];</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>}</td></tr></table></code></pre><p>Note that we cast the <code>attributes</code> field to an array. If we didn’t do this, we’d need to manually run <code>json_encode()</code> and <code>json_decode()</code> on the field to get it back in a usable form. As it is, we can now easily retrieve fields using array access.</p><p>With that done, we can now set up some data:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$c = <span class="hljs-keyword">new</span> App\Content;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$c-&gt;type = <span class="hljs-string">'page'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>$c-&gt;attributes = [ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"info"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-string">"title"</span> =&gt; <span class="hljs-string">"Terms"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-string">"content"</span> =&gt; <span class="hljs-string">"Our Terms"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-string">"layout"</span> =&gt; <span class="hljs-string">"info"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>];</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>$c-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$c = <span class="hljs-keyword">new</span> App\Content;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>$c-&gt;type = <span class="hljs-string">'link'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>$c-&gt;attributes = [ </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"external"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-string">"link"</span> =&gt; <span class="hljs-string">"http://example.com"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>];</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>$c-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>$c = <span class="hljs-keyword">new</span> App\Content;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>$c-&gt;type = <span class="hljs-string">'page'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>$c-&gt;attributes = [ </td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"promotional"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-string">"title"</span> =&gt; <span class="hljs-string">"My page"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-string">"content"</span> =&gt; <span class="hljs-string">"This is my page"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-string">"layout"</span> =&gt; <span class="hljs-string">"default"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>];</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>$c-&gt;save();</td></tr></table></code></pre><p>As you can see, we’ve been able to set out whatever arbitrary fields we wish on these items. We can then call <code>toArray()</code> on a model to get all the fields, including the attributes, or we can call <code>$c-&gt;attributes</code> to get all those attributes together. We can also get a field via array access, eg <code>$c-&gt;attributes[&#39;type&#39;]</code>.</p><h2 id="querying-the-data">Querying the data</h2><p>The syntax for querying JSON fields is a little bit fiddly:</p><pre><code class="hljs lang-sql singleline"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-string">`content`</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">attributes</span> -&gt; <span class="hljs-string">'$.type'</span> = <span class="hljs-string">'promotional'</span>;</code></pre><p>Fortunately, Eloquent makes it much simpler:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Content::where(<span class="hljs-string">'attributes-&gt;type'</span>, <span class="hljs-string">'promotional'</span>)-&gt;get();</td></tr></table></code></pre><p>It’s also possible to order by a JSON field value, but at the time of writing there’s no neat syntax for it, so you have to drop down to writing it using <code>orderByRaw</code> in Eloquent:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Content::orderByRaw(<span class="hljs-string">"attributes-&gt; '$.type'"</span>)-&gt;get();</td></tr></table></code></pre><p>Eloquent also supports a few other JSON query types, such as querying if an array contains a value, and I suggest <a href="https://laravel.com/docs/6.x/queries#json-where-clauses">referring to the documentation</a> if you want to know more.</p><h2 id="other-applications">Other applications</h2><p>There are many other scenarios where this approach can be useful. For instance, e-commerce sites often sell many different products that may have arbitrary properties, and it may be necessary to sort and filter by different properties for different types of products. A store that sells, among other things, shoes and storage containers, might need a colour and capacity field for storage containers, and a colour and size field for shoes. Using this approach, you can set up your database in such a way that those arbitrary fields can be set up when needed, and used for filtering.</p><p>This approach is not without its downsides. Any data that’s stored in a JSON field can’t be validated by the database in the same way, so the burden of ensuring that it remains in a consistent state is moved to your application code. However, it’s no worse than it would be if you used a document database, and unlike with a document database you can combine JSON and more traditional fields as you see fit.</p></article><article class="post"><p class="date">22nd September 2019 7:00 pm</p><h1><a href="/blog/2019/09/22/storing-wordpress-configuration-in-environment-variables/">Storing Wordpress Configuration in Environment Variables</a></h1><p>Wordpress configuration can be a serious pain in the proverbial. Hard-coding configuration details in a PHP file is not a terribly safe way of storing the details for your database, as if the server is misconfigured they can be exposed. In addition, it can be a chore to copy and populate the <code>wp-config.php</code> file to a new deploy.</p><p>A fundamental principle of <a href="https://12factor.net/">The Twelve-Factor App</a> is that config should be stored in the environment. While Wordpress does predate this, there’s no reason why we can’t abide by this. Storing Wordpress configuration in environment variables rather than the <code>wp-config.php</code> file has the following advantages:</p><ul><li>It’s more secure since the config is not stored in a file in the web root, but in the web server config</li><li>It makes managing the <code>wp-config.php</code> file less of a chore - it can be safely committed to version control, and you won’t need to change it to match your local configuration, running the risk of accidentally committing and pushing to production with broken config</li><li>Deployment to new servers is simpler because there’s no need to update the <code>wp-config.php</code></li><li>The risk of neglecting to change the database details and accidentally messing up the production database when working locally is virtually eliminated</li></ul><p>I’ve seen solutions for this that use DotEnv, but you don’t actually need to install that to be able to use environment variables with Wordpress. In fact, in some way it’s better if you don’t as too many developers use <code>.env</code> files in production. PHP natively has the ability to get data from environment variables using the <code>getenv()</code> function, so it’s easier to use that than to pull in a third-party library.</p><p>Here’s an abbreviated example of a <code>wp-config.php</code> file that’s been updated to pull the settings from environment variables:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment">// ** MySQL settings - You can get this info from your web host ** //</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">/** The name of the database for WordPress */</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>define( <span class="hljs-string">'DB_NAME'</span>, getenv(<span class="hljs-string">'DB_NAME'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-comment">/** MySQL database username */</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>define( <span class="hljs-string">'DB_USER'</span>, getenv(<span class="hljs-string">'DB_USER'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-comment">/** MySQL database password */</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>define( <span class="hljs-string">'DB_PASSWORD'</span>, getenv(<span class="hljs-string">'DB_PASSWORD'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-comment">/** MySQL hostname */</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>define( <span class="hljs-string">'DB_HOST'</span>, getenv(<span class="hljs-string">'DB_HOST'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-comment">/** Database Charset to use in creating database tables. */</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>define( <span class="hljs-string">'DB_CHARSET'</span>, <span class="hljs-string">'utf8'</span> );</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-comment">/** The Database Collate type. Don't change this if in doubt. */</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>define( <span class="hljs-string">'DB_COLLATE'</span>, <span class="hljs-string">''</span> );</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>define( <span class="hljs-string">'AUTH_KEY'</span>,         getenv(<span class="hljs-string">'AUTH_KEY'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>define( <span class="hljs-string">'SECURE_AUTH_KEY'</span>,  getenv(<span class="hljs-string">'SECURE_AUTH_KEY'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>define( <span class="hljs-string">'LOGGED_IN_KEY'</span>,    getenv(<span class="hljs-string">'LOGGED_IN_KEY'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>define( <span class="hljs-string">'NONCE_KEY'</span>,        getenv(<span class="hljs-string">'NONCE_KEY'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>define( <span class="hljs-string">'AUTH_SALT'</span>,        getenv(<span class="hljs-string">'AUTH_SALT'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>define( <span class="hljs-string">'SECURE_AUTH_SALT'</span>, getenv(<span class="hljs-string">'SECURE_AUTH_SALT'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>define( <span class="hljs-string">'LOGGED_IN_SALT'</span>,   getenv(<span class="hljs-string">'LOGGED_IN_SALT'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>define( <span class="hljs-string">'NONCE_SALT'</span>,       getenv(<span class="hljs-string">'NONCE_SALT'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>$table_prefix = <span class="hljs-string">'wp_'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>define( <span class="hljs-string">'WP_DEBUG'</span>, getenv(<span class="hljs-string">'WP_DEBUG'</span>) );</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td><span class="hljs-comment">/* That's all, stop editing! Happy publishing. */</span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td><span class="hljs-comment">/** Absolute path to the WordPress directory. */</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td><span class="hljs-keyword">if</span> ( ! defined( <span class="hljs-string">'ABSPATH'</span> ) ) {</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    define( <span class="hljs-string">'ABSPATH'</span>, dirname( <span class="hljs-keyword">__FILE__</span> ) . <span class="hljs-string">'/'</span> );</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td><span class="hljs-comment">/** Sets up WordPress vars and included files. */</span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td><span class="hljs-keyword">require_once</span>( ABSPATH . <span class="hljs-string">'wp-settings.php'</span> );</td></tr></table></code></pre><p>If you’re using Lando for local development, you will need to specify a file to include that contains the environment variables you wish to set, as in this example:</p><pre><code class="hljs lang-yaml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attr">name:</span> <span class="hljs-string">wordpress</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-attr">recipe:</span> <span class="hljs-string">wordpress</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-attr">config:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-attr">  webroot:</span> <span class="hljs-string">.</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-attr">env_file:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-bullet">  -</span> <span class="hljs-string">.env</span></td></tr></table></code></pre><p>This filename can be any arbitrarily chosen name. Then, you define the values for those variables in the same way you normally would in a <code>.env</code> file. Here’s an abbreviated example that excludes the crypto settings (though those should be placed here too):</p><pre><code class="hljs lang-env"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute">DB_NAME</span>=wordpress</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-attribute">DB_USER</span>=wordpress</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-attribute">DB_PASSWORD</span>=wordpress</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-attribute">DB_HOST</span>=database</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-attribute">WP_DEBUG</span>=<span class="hljs-literal">true</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-built_in">..</span>.</td></tr></table></code></pre><p>This will work fine during local development, but in production, or if you’re using something like Vagrant for local development, you’ll want to set the environment variables in the server configuration. For Apache, this is best set in the Virtualhost configuration, although you should be able to set it in an <code>.htaccess</code> file if all else fails. You need to use the <code>SetEnv</code> directive, as in this example:</p><pre><code class="hljs lang-apache"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute"><span class="hljs-nomarkup">SetEnv</span></span> DB_NAME wordpress</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-attribute"><span class="hljs-nomarkup">SetEnv</span></span> DB_USER wordpress</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-attribute"><span class="hljs-nomarkup">SetEnv</span></span> DB_PASSWORD wordpress</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-attribute"><span class="hljs-nomarkup">SetEnv</span></span> DB_HOST database</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-attribute"><span class="hljs-nomarkup">SetEnv</span></span> WP_DEBUG true</td></tr></table></code></pre><p>For Nginx, assuming you’re using FastCGI, you need to set it in the server configuration for that site using the <code>fastcgi_param</code> directive, as shown below:</p><pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute">fastcgi_param</span> DB_NAME wordpress;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-attribute">fastcgi_param</span> DB_USER wordpress;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-attribute">fastcgi_param</span> DB_PASSWORD wordpress;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-attribute">fastcgi_param</span> DB_HOST database;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-attribute">fastcgi_param</span> WP_DEBUG <span class="hljs-literal">true</span>;</td></tr></table></code></pre><p>Since Wordpress doesn’t ship with any kind of command-line task runner, this should be sufficient for most installs. However, if you’re using WP CLI, that will break it as it won’t have access to environment variables set by Apache or Nginx, so you’ll also need to set them for the user that runs WP CLI by adding them to their Bash config in the usual way.</p></article><article class="post"><p class="date">21st September 2019 11:30 am</p><h1><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></h1><p>Laravel Mix is a really convenient front end scaffold, and not just in the context of a Laravel application. Last year, I added it to a legacy application I maintain, with positive results, and I’m including it in a CMS I’m working on.</p><p>However, I’ve always had issues trying to implement versioning outside a Laravel application. I’ve used the timestamp technique described <a href="https://matthewdaly.co.uk/blog/2016/11/26/easy-static-asset-versioning-in-php/">here</a> a lot in the past, but nowadays I do most of my work in a Lando container, and I’ve had a lot of issues with timestamp changes not being picked up, forcing me to restart my container regularly when working on front-end assets. Switching to using Mix versioning seemed like a good way to resolve that issue, but of course the <code>mix()</code> helper isn’t available elsewhere.</p><p>Fortunately, its not all that hard to implement your own solution. Under the bonnet, Mix versioning works as follows:</p><ul><li>The build generates an array of compiled static assets, with the key being the path to the asset, and the value being the path with a query string appended, and then saves it as <code>mix-manifest.json</code></li><li>The <code>mix()</code> helper loads the <code>mix-manifest.json</code> file, converts it to JSON, fetches the array entry by path, and then returns the appropriate value for passing back from the helper</li></ul><p>With that in mind, I wrote the following Twig filter to handle assets versioned with Mix:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Project</span>\<span class="hljs-title">Core</span>\<span class="hljs-title">Views</span>\<span class="hljs-title">Filters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Exception</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mix</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(string $path)</span>: <span class="hljs-title">string</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $manifest = json_decode(file_get_contents(<span class="hljs-string">'mix-manifest.json'</span>), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">if</span> (! array_key_exists(<span class="hljs-string">"/"</span> . $path, $manifest)) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">"Unable to locate Mix file: {$path}"</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">if</span> (!file_exists($path)) {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-string">'Included file does not exist'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> $manifest[<span class="hljs-string">"/"</span> . $path];</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>}</td></tr></table></code></pre><p>This works on the basis that the web root is set in the <code>public/</code> folder, and that the compiled CSS and Javascript files are placed there - if that’s not the case you may need to adapt this accordingly.</p><p>You also need to add the <code>version()</code> call to your <code>webpack.mix.js</code>:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">const</span> mix = <span class="hljs-built_in">require</span>(<span class="hljs-string">'laravel-mix'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment">/*</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td> |--------------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td> | Mix Asset Management</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> |--------------------------------------------------------------------------</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> |</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> | Mix provides a clean, fluent API for defining some Webpack build steps</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td> | for your Laravel application. By default, we are compiling the Sass</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td> | file for the application as well as bundling up all the JS files.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td> |</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>mix</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  .setPublicPath(<span class="hljs-string">'public/'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  .js(<span class="hljs-string">'resources/js/app.js'</span>, <span class="hljs-string">'public/js'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  .sass(<span class="hljs-string">'resources/sass/app.scss'</span>, <span class="hljs-string">'public/css'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  .version();</td></tr></table></code></pre><p>Then, when you instantiate Twig, you can add the new filter using something like this:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$twig = <span class="hljs-keyword">new</span> Environment($container-&gt;get(<span class="hljs-string">'Twig\Loader\FilesystemLoader'</span>), $config);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$mix = $container-&gt;get(<span class="hljs-string">'Project\Core\Views\Filters\Mix'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$twig-&gt;addFilter(<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'mix'</span>, $mix));</td></tr></table></code></pre><p>Now, the filter should be usable in your Twig views as shown:</p><pre><code class="hljs lang-twig"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"><span class="hljs-meta">&lt;!doctype html&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ 'css/app.css'| mix }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span> /&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-template-variable">{{ title }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-keyword">include</span></span> 'header.html' %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-keyword">block</span></span> body %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-keyword">endblock</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ 'js/app.js'| mix }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></td></tr></table></code></pre><p>If you’re using a different framework or templating system, there should be a way to create helpers, and it should be possible to implement this technique fairly easily. I was able to do so in the context of a legacy Zend application, so it should be possible with other legacy frameworks like CodeIgniter.</p></article><article class="post"><p class="date">7th September 2019 8:16 pm</p><h1><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></h1><p>Sometimes when writing a test, you come across a situation where you need to set a private field that’s not accessible through any existing route. For instance, I’ve been working with Doctrine a bit lately, and since the ID on an entity is generated automatically, it should not be possible to change it via a setter, but at the same time, we sometimes have the need to set it in a test.</p><p>Fortunately, there is a way to do that. Using PHP’s reflection API, you can temporarily mark a property on an object as accessible, so as to be able to set it without either passing it to the constructor or creating a setter method that will only ever be used by the test. We first create a <code>ReflectionClass</code> instance from the object, then get the property. We mark it as accessible, and then set the value on the instance, as shown below:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Project</span>\<span class="hljs-title">Document</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetId</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $doc = <span class="hljs-keyword">new</span> Document();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $reflect = <span class="hljs-keyword">new</span> ReflectionClass($doc);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $id = $reflect-&gt;getProperty(<span class="hljs-string">'id'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $id-&gt;setAccessible(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $id-&gt;setValue($doc, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">1</span>, $doc-&gt;getId());</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>If you’re likely to need this in more than one place, you may want to pull this functionality out into a trait for reuse:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Traits</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">trait</span> SetsPrivateProperties</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Sets a private property</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> mixed $object</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@param</span> string $property</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@param</span> mixed $value</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPrivateProperty</span><span class="hljs-params">($object, string $property, $value)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $reflect = <span class="hljs-keyword">new</span> ReflectionClass($object);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $prop = $reflect-&gt;getProperty($property);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $prop-&gt;setAccessible(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $prop-&gt;setValue($object, $value);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $prop-&gt;setAccessible(<span class="hljs-keyword">false</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Then your test can be simplified as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types = <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Project</span>\<span class="hljs-title">Document</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Traits</span>\<span class="hljs-title">SetsPrivateProperties</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">SetsPrivateProperties</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetId</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $doc = <span class="hljs-keyword">new</span> Document();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setPrivateProperty($doc, <span class="hljs-string">'id'</span>, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">1</span>, $doc-&gt;getId());</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>While this is a slightly contrived and limited example, and this situation is quite rare, I’ve found it to be a useful technique under certain circumstances.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></p><p><a href="/blog/2019/10/13/flexible-data-types-with-the-json-field/">Flexible Data Types With the JSON Field</a></p><p><a href="/blog/2019/09/22/storing-wordpress-configuration-in-environment-variables/">Storing Wordpress Configuration in Environment Variables</a></p><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>