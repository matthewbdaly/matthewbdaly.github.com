<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">25th February 2018 3:50 pm</p><h1><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers</a></h1><p>In <a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">my previous post</a> I mentioned some strategies for refactoring Laravel controllers to move unnecessary functionality elsewhere. However, I didn’t cover testing them. In this post I will demonstrate the methodology I use for testing Laravel controllers.</p><p>Say we have the following method in a controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $document = <span class="hljs-keyword">new</span> Document($request-&gt;only([</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'title'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'text'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ]));</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $document-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        event(<span class="hljs-keyword">new</span> DocumentCreated($document));</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> redirect()-&gt;route(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><p>This controller method does three things:</p><ul><li>Return a response</li><li>Create a model instance</li><li>Fire an event</li></ul><p>Our tests therefore need to pass it all its external dependencies and check it carries out the required actions.</p><p>First we fake the event facade:</p><pre><code class="hljs lang-php singleline">    Event::fake();</code></pre><p>Next, we create an instance of <code>Illuminate\Http\Request</code> to represent the HTTP request passed to the controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $request = Request::create(<span class="hljs-string">'/store'</span>, <span class="hljs-string">'POST'</span>,[</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'title'</span>     =&gt;     <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'text'</span>     =&gt;     <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    ]);</td></tr></table></code></pre><p>If you’re using a custom form request class, you should instantiate that in exactly the same way.</p><p>Then, instantiate the controller, and call the method, passing it the request object:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $controller = <span class="hljs-keyword">new</span> MyController();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    $response = $controller-&gt;store($request);</td></tr></table></code></pre><p>You can then test the response from the controller. You can test the status code like this:</p><pre><code class="hljs lang-php singleline">    <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">302</span>, $response-&gt;getStatusCode());</code></pre><p>You may also need to check the content of the response matches what you expect to see, by retrieving <code>$response-&gt;getBody()-&gt;getContent()</code>.</p><p>Next, retrieve the newly created model instance, and verify it exists:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $document = Document::where(<span class="hljs-string">'title'</span>, <span class="hljs-string">'foo'</span>)-&gt;first();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">$this</span>-&gt;assertNotNull($document);</td></tr></table></code></pre><p>You can also use <code>assertEquals()</code> to check the attributes on the model if appropriate. Finally, you check the event was fired:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    Event::assertDispatched(DocumentCreated::class, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($event)</span> <span class="hljs-title">use</span> <span class="hljs-params">($document)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-keyword">return</span> $event-&gt;document-&gt;id === $document-&gt;id; </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    });</td></tr></table></code></pre><p>This test should not concern itself with any functionality triggered by the event, only that the event gets triggered. The event should have separate unit tests in which the event is triggered, and then the test verifies it carried out the required actions.</p><p>Technically, these don’t quite qualify as being unit tests because they hit the database, but they should cover the controller adequately. To make them true unit tests, you’d need to implement the repository pattern for the database queries rather than using Eloquent directly, and mock the repository, so you can assert that the mocked repository receive the right data and have it return the expected response.</p><p>Here is how you might do that with Mockery:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$mock = Mockery::mock(<span class="hljs-string">'App\Contracts\Repositories\Document'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$mock-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'title'</span>    =&gt;        <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'text'</span>    =&gt;        <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>])-&gt;once()-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>$controller = <span class="hljs-keyword">new</span> MyController($mock);</td></tr></table></code></pre><p>As long as your controllers are kept as small as possible, it’s generally not too hard to test them. Unfortunately, fat controllers become almost impossible to test, which is another good reason to avoid them.</p></article><article class="post"><p class="date">18th February 2018 6:10 pm</p><h1><a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">Put Your Laravel Controllers on a Diet</a></h1><p>MVC frameworks are a tremendously useful tool for modern web development. They offer easy ways to carry out common tasks, and enforce a certain amount of structure on a project.</p><p>However, that doesn’t mean using them makes you immune to bad practices, and it’s quite easy to wind up falling into certain anti-patterns. Probably the most common is the Fat Controller.</p><h2 id="what-is-a-fat-controller-">What is a fat controller?</h2><p>When I first started out doing professional web development, CodeIgniter 2 was the first MVC framework I used. While I hadn’t used it before, I was familiar with the general concept of MVC. However, I didn’t appreciate that when referring to the model layer as a place for business logic, that wasn’t necessarily the same thing as the database models.</p><p>As such, my controllers became a dumping ground for anything that didn’t fit into the models. If it didn’t interact with the database, I put it in the controller. They quickly became bloated, with many methods running to hundreds of lines of code. The code base became hard to understand, and when I was under the gun on projects I found myself copying and pasting functionality between controllers, making the situation even worse. Not having an experienced senior developer on hand to offer criticism and advice, it was a long time before I realised that this was a problem or how to avoid it.</p><h2 id="why-are-fat-controllers-bad-">Why are fat controllers bad?</h2><p>Controllers are meant to be simple glue code that receives requests and returns responses. Anything else should be handed off to the model layer. As noted above, however, that’s not the same as putting it in the models. Your model layer can consist of many different classes, not just your Eloquent models, and you should not fall into the trap of thinking your application should consist of little more than models, views and controllers.</p><p>Placing business logic in controllers can be bad for many reasons:</p><ul><li>Code in controllers can be difficult to write automated tests for</li><li>Any logic in a controller method may need to be repeated elsewhere if the same functionality is needed for a different route, unless it’s in a private or protected method that is called from elsewhere, in which case it’s very hard to test in isolation</li><li>Placing it in the controller makes it difficult to pull out and re-use on a different project</li><li>Making your controller methods too large makes them complex and hard to follow</li></ul><p>As a general rule of thumb, I find that 10 lines of code for any one method for a controller is where it starts getting a bit much. That said, it’s not a hard and fast rule, and for very small projects it may not be worthwhile. But if a project is large and needs to be maintained for any reasonable period of time, you should take the trouble to ensure your controllers are as skinny as is practical.</p><p>Nowadays Laravel is my go-to framework and I’ve put together a number of strategies for avoiding the fat controller anti-pattern. Here’s some examples of how I would move various parts of the application out of my controllers.</p><h2 id="validation">Validation</h2><p>Laravel has a nice, easy way of getting validation out of the controllers. Just create a custom <a href="https://laravel.com/docs/5.6/validation#form-request-validation">form request</a> for your input data, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">FormRequest</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FormRequest</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Determine if the user is authorized to make this request.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> bool</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorize</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Get the validation rules that apply to the request.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> array</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'required|email'</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Then type-hint the form request in the controller method, instead of <code>Illuminate\Http\Request</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>\<span class="hljs-title">CreateRequest</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(CreateRequest $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-comment">// Process request here..</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>}</td></tr></table></code></pre><h2 id="database-access-and-caching">Database access and caching</h2><p>For non-trivial applications I normally use <a href="/blog/2017/03/01/decorating-laravel-repositories/">decorated repositories</a> to handle caching and database access in one place. That way my caching and database layers are abstracted out into separate classes, and caching is nearly always handled seamlessly without having to do much work.</p><h2 id="complex-object-creation-logic">Complex object creation logic</h2><p>If I have a form or API endpoint that needs to:</p><ul><li>Create more than one object</li><li>Transform the incoming data in some way</li><li>Or is non-trivial in any other way</li></ul><p>I will typically pull it out into a separate persister class. First, you should create an interface for this persister class:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Persisters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Foo</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Create a new Model</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * Update the given Model</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * <span class="hljs-doctag">@param</span> Model $model</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(array $data, Model $model)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Then create the persister class itself:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Persisters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Foo</span> <span class="hljs-title">as</span> <span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Persisters</span>\<span class="hljs-title">Foo</span> <span class="hljs-title">as</span> <span class="hljs-title">FooContract</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">DatabaseManager</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Carbon</span>\<span class="hljs-title">Carbon</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FooContract</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $db;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DatabaseManager $db, Repository $repository)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db = $db;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Create a new Model</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;beginTransaction();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $model = <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>             <span class="hljs-string">'date'</span> =&gt; Carbon::parse($data[<span class="hljs-string">'date'</span>])-&gt;toDayDateTimeString(),</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;commit();</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">return</span> $model;</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     * Update the given Model</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * <span class="hljs-doctag">@param</span> Model $model</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(array $data, Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;beginTransaction();</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $updatedmodel = <span class="hljs-keyword">$this</span>-&gt;repository-&gt;update([</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>             <span class="hljs-string">'date'</span> =&gt; Carbon::parse($data[<span class="hljs-string">'date'</span>])-&gt;toDayDateTimeString(),</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>             $model</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;commit();</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-keyword">return</span> $updatedmodel;</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>}</td></tr></table></code></pre><p>Then you can set up the persister in a service provider so that type-hinting the interface returns the persister:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind(</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'App\Contracts\Persisters\Foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-string">'App\Persisters\Foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>       });</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>}</td></tr></table></code></pre><p>This approach means that complex logic, such as creating multiple related objects, can be handled in a consistent way, even if it needs to be called from multiple places.</p><h2 id="triggering-actions-as-a-result-of-something">Triggering actions as a result of something</h2><p><a href="https://laravel.com/docs/5.6/events">Events</a> are tailor-made for this use case, and Laravel documents them very well, so I won’t repeat it here. Suffice to say, if something needs to happen, but the response sent by the application doesn’t necessarily depend on it returning something immediately, then it’s probably worth considering making it an event. If it’s going to be called from multiple places, it’s even more worthwhile.</p><p>For instance, if you have a contact form, it’s worth taking the time to create an event for when a new contact is received, and handle proessing the contact within the listener for that event. Also, doing so means you can queue that event and have it handled outside the context of the application, so that it responds to the user more quickly. If you’re sending an acknowledgement email for a new user registration, you don’t need to wait for that email to be sent before you return the response, so queueing it can improve response times.</p><h2 id="interacting-with-third-party-services">Interacting with third-party services</h2><p>If you have some code that needs to interact with a third-party service or API, it can get quite complex, especially if you need to process the content in some way. It therefore makes sense to pull that functionality out into a separate class.</p><p>For instance, say you have some code in your controller that uses an HTTP client to fetch some data from a third-party API and display it in the view:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   $data = <span class="hljs-keyword">$this</span>-&gt;client-&gt;get(<span class="hljs-string">'http://api.com/api/items'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   $items = [];</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> $k =&gt; $v) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>         $item = [</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>           <span class="hljs-string">'name'</span> =&gt; $v[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>              <span class="hljs-string">'description'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'description'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>              <span class="hljs-string">'tags'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'tags'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>         ];</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>         $items[] = $item;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   <span class="hljs-keyword">return</span> view(<span class="hljs-string">'template'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>       <span class="hljs-string">'items'</span> =&gt; $items</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>   ]);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>This is a very small example (and a lot simpler than most real-world instances of this issue), but it illustrates the principle. Not only does this code bloat the controller, it might also be used elsewhere in the application, and we don’t want to copy and paste it elsewhere - therefore it makes sense to extract it to a service class.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-title">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">ClientInterface</span> <span class="hljs-title">as</span> <span class="hljs-title">GuzzleClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Api</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">protected</span> $client;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(GuzzleClient $client)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>   {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      <span class="hljs-keyword">$this</span>-&gt;client = $client;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      $data = <span class="hljs-keyword">$this</span>-&gt;client-&gt;get(<span class="hljs-string">'http://api.com/api/items'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      $items = [];</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      <span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> $k =&gt; $v) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>         $item = [</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-string">'name'</span> =&gt; $v[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-string">'description'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'description'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-string">'tags'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'tags'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>         ];</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         $items[] = $item;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>      <span class="hljs-keyword">return</span> $items;</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Our controller can then type-hint the service and refactor that functionality out of the method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(App\Services\Api $api)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">$this</span>-&gt;api = $api;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>   $items = <span class="hljs-keyword">$this</span>-&gt;api-&gt;fetch();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">return</span> view(<span class="hljs-string">'template'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>       <span class="hljs-string">'items'</span> =&gt; $items</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>   ]);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><h2 id="including-common-variables-in-the-view">Including common variables in the view</h2><p>If data is needed in more than one view (eg show the user’s name on every page when logged in), consider using <a href="https://laravel.com/docs/5.6/views#view-composers">view composers</a> to retrieve this data rather than fetching them in the controller. That way you’re not having to repeat that logic in more than one place.</p><h2 id="formatting-content-for-display">Formatting content for display</h2><p>Logically this belongs in the view layer, so you should <a href="/blog/2018/01/09/creating-laravel-helpers/">write a helper</a> to handle things like formatting dates. For more complex stuff, such as formatting HTML, you should be doing this in Blade (or another templating system, if you’re using one) - for instance, when generating an HTML table, you should consider <a href="https://laravel.com/docs/5.6/blade#rendering-views-for-collections">using a view partial</a> to loop through them. For particularly tricky functionality, you have the option of <a href="https://laravel.com/docs/5.6/blade#extending-blade">writing a custom Blade directive</a>.</p><p>The same applies for rendering other content - for rendering JSON you should consider using <a href="https://laravel.com/docs/5.6/eloquent-resources">API resources</a> or <a href="https://fractal.thephpleague.com/">Fractal</a> to get any non-trivial logic for your API responses out of the controller. Blade templates can also work for non-HTML content such as XML.</p><h2 id="anything-else-">Anything else…</h2><p>These examples are largely to get you started, and there will be occasions where something doesn’t fall into any of the above categories. However, the same principle applies. Your controllers should stick to just receiving requests and sending responses, and anything else should normally be deferred to other classes.</p><p>Fat controllers make developer’s lives very difficult, and if you want your code base to be easily maintainable, you should be willing to refactor them ruthlessly. Any functionality you can pull out of the controller becomes easier to reuse and test, and as long as you name your classes and methods sensibly, they’re easier to understand.</p></article><article class="post"><p class="date">4th February 2018 12:12 am</p><h1><a href="/blog/2018/02/04/using-lando-as-an-alternative-to-vagrant/">Using Lando As An Alternative to Vagrant</a></h1><p>Although Vagrant is very useful for ensuring consistency between development environments, it’s quite demanding on system resources. Running a virtual machine introduces quite a bit of overhead, and it can be troublesome to provision.</p><p>This week I was introduced to <a href="https://docs.devwithlando.io/">Lando</a> as an alternative to Vagrant. Rather than running a virtual machine like Vagrant does by default, Lando instead spins up Docker containers for the services you need, meaning it has considerably less overhead than Vagrant. It also includes presets for a number of frameworks and CMS’s, including:</p><ul><li>Drupal 7</li><li>Drupal 8</li><li>Wordpress</li><li>Laravel</li></ul><p>Considering that Vagrant needs quite a bit of boilerplate to set up the server for different types of projects, this gives Lando an obvious advantage. The only issue I’ve had with it is that it’s been unreliable when I’ve had to use it on Windows, which I don’t do much anyway.</p><h2 id="getting-started">Getting started</h2><p>Lando requires that you have Docker installed. Once that’s done you can download and install it fro the website. Then you can run <code>lando init</code> to set it up:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ lando init</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>? What recipe <span class="hljs-keyword">do</span> you want to use? wordpress</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>? Where is your webroot relative to the init destination? .</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>? What <span class="hljs-keyword">do</span> you want to call this app? wp-site</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>NOW WE<span class="hljs-string">'RE COOKING WITH FIRE!!!</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Your app has been initialized!</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Go to the directory where your app was initialized and run</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>`lando start` to get rolling.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>Check the LOCATION printed below if you are unsure where to go.</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>Here are some vitals:</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td> NAME      wp-site                                               </td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td> LOCATION  /home/matthew/Projects/wp-site                        </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td> RECIPE    wordpress                                             </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td> DOCS      https://docs.devwithlando.io/tutorials/wordpress.html</td></tr></table></code></pre><p>Here I’ve chosen the <code>wordpress</code> recipe, in the current directory, with the name <code>wp-site</code>. This generates the following file as <code>.lando.yml</code>:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-symbol">name:</span> wp-site</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-symbol">recipe:</span> wordpress</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-symbol">config:</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-symbol">  webroot:</span> .</td></tr></table></code></pre><p>Then, if we run <code>lando start</code>, it will set up the required services:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ lando start</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>landoproxyhyperion5000gandalfedition_proxy_1 is up-to-date</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>Creating network <span class="hljs-string">"wpsite_default"</span> with the default driver</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>Creating volume <span class="hljs-string">"wpsite_appserver"</span> with default driver</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>Creating volume <span class="hljs-string">"wpsite_data"</span> with default driver</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>Creating volume <span class="hljs-string">"wpsite_data_database"</span> with default driver</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>Creating wpsite_appserver_1 ... </td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>Creating wpsite_database_1 ... </td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Creating wpsite_database_1</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>Creating wpsite_appserver_1 ... <span class="hljs-keyword">done</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                                 Dload  Upload   Total   Spent    Left  Speed</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>100 4454k  100 4454k    0     0  3288k      0  0:00:01  0:00:01 --:--:-- 3290k</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>OS:     Linux 4.13.0-32-generic <span class="hljs-comment">#35-Ubuntu SMP Thu Jan 25 09:13:46 UTC 2018 x86_64</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Shell:  </td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>PHP binary:     /usr/<span class="hljs-built_in">local</span>/bin/php</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>PHP version:    7.1.13</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>php.ini used:   </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>WP-CLI root dir:        phar://wp-cli.phar</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>WP-CLI vendor dir:      phar://wp-cli.phar/vendor</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>WP_CLI phar path:       /tmp</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>WP-CLI packages dir:</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>WP-CLI global config:   </td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>WP-CLI project config:  </td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>WP-CLI version: 1.5.0</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>BOOMSHAKALAKA!!!</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>Your app has started up correctly.</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Here are some vitals:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td> APPSERVER URLS  https://localhost:32802</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>                 http://localhost:32803</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                 http://wp-site.lndo.site</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>                 https://wp-site.lndo.site</td></tr></table></code></pre><p>Note the <code>APPSERVER URLS</code> section - the site can be accessed locally via HTTP or HTTPS. For this recipe, it also installs WP CLI.</p><p>If we run <code>docker ps</code>, we can see that it’s running three Docker containers:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                                                               NAMES</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>2e920e152091        devwithlando/php:7.1-apache   <span class="hljs-string">"/lando-entrypoint.s…"</span>   16 minutes ago      Up 16 minutes       0.0.0.0:32803-&gt;80/tcp, 0.0.0.0:32802-&gt;443/tcp                       wpsite_appserver_1</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>82ea60b1214f        mysql:latest                  <span class="hljs-string">"/lando-entrypoint.s…"</span>   16 minutes ago      Up 16 minutes       0.0.0.0:32801-&gt;3306/tcp                                             wpsite_database_1</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>e51d831199d7        traefik:1.3-alpine            <span class="hljs-string">"/lando-entrypoint.s…"</span>   About an hour ago   Up About an hour    0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:58086-&gt;8080/tcp   landoproxyhyperion5000gandalfedition_proxy_1</td></tr></table></code></pre><p>Apache lives in one container, MySQL in another, while the third runs Traefik, a lightweight load balancer, which listens on port 80. Traefik does the work of redirecting HTTP requests to the right place.</p><p>As I’ve been unhappy with the amount of resources Vagrant uses for a while, and I usually run Ubuntu (making using Docker straightforward), I’m planning on using Lando extensively in future. It’s lighter and faster to set up, and has sane defaults for most of the frameworks and CMS’s I use regularly, making it generally quicker and easier to work with.</p></article><article class="post"><p class="date">29th January 2018 10:00 pm</p><h1><a href="/blog/2018/01/29/how-i-deploy-laravel-apps/">How I Deploy Laravel Apps</a></h1><p>A while back I provided details of the web server setup I used for Django applications. Nowadays I tend to use Laravel most of the time, so I thought I’d share an example of the sort of setup I use to deploy that.</p><h2 id="server-os">Server OS</h2><p>As before I generally prefer Debian Stable where possible. If that’s not possible for any reason then the current Ubuntu LTS is an acceptable substitute.</p><h2 id="web-server">Web server</h2><p>My usual web server these days is Nginx with PHP 7 or better via FPM. I generally use HTTP2 where possible, with SSL via Let’s Encrypt.</p><p>Here’s my typical Nginx config:</p><pre><code class="hljs lang-nginx"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-attribute">fastcgi_cache_path</span> /etc/nginx/cache levels=<span class="hljs-number">1</span>:<span class="hljs-number">2</span> keys_zone=my-app:<span class="hljs-number">100m</span> inactive=<span class="hljs-number">60m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-attribute">fastcgi_cache_key</span> <span class="hljs-string">"<span class="hljs-variable">$scheme</span><span class="hljs-variable">$request_method</span><span class="hljs-variable">$host</span><span class="hljs-variable">$request_uri</span>"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-attribute">add_header</span> Content-Security-Policy <span class="hljs-string">"default-src 'self'; script-src 'self'; img-src 'self' https://placehold.it; style-src 'self' https://fonts.googleapis.com ; font-src 'self' https://themes.googleusercontent.com; frame-src 'none'; object-src 'none'"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-section">server</span> {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-attribute">server_name</span> my-app.domain;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://<span class="hljs-variable">$server_name</span><span class="hljs-variable">$request_uri</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-section">server</span> {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl http2;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-attribute">include</span> snippets/ssl-my-app.domain.conf;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-attribute">include</span> snippets/ssl-params.conf;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">50M</span>;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-attribute">fastcgi_param</span> HTTP_PROXY <span class="hljs-string">""</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-attribute">root</span> /var/www/my-app.domain/current/public;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-attribute">index</span> index.php index.html index.htm;</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-attribute">server_name</span> my-app.domain;</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-attribute">location</span> / {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.php?<span class="hljs-variable">$query_string</span>;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.php$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> /index.php =<span class="hljs-number">404</span>;</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-attribute">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span>;</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-attribute">fastcgi_pass</span> unix:/var/run/php/php7.0-fpm-my-app.sock;</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-attribute">fastcgi_index</span> index.php;</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-attribute">include</span> fastcgi_params;</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        <span class="hljs-attribute">fastcgi_cache</span> my-app;</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        <span class="hljs-attribute">fastcgi_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">60m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /.well-known</span> {</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-attribute">allow</span> all;</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:manifest|appcache|html?|xml|json)$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        <span class="hljs-attribute">expires</span> -<span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        <span class="hljs-attribute">gzip_types</span> application/json text/xml application/xml;</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:rss|atom)$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-attribute">expires</span> <span class="hljs-number">1h</span>;</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>        <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">"public"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>        <span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        <span class="hljs-attribute">gzip_types</span> application/xml+rss;</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc)$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        <span class="hljs-attribute">expires</span> <span class="hljs-number">1M</span>;</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">"public"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:css|js)$</span> {</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-attribute">expires</span> <span class="hljs-number">1y</span>;</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>        <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">"public"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>        <span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>;</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>        <span class="hljs-attribute">gzip_types</span> text/css application/javascript text/javascript;</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>}</td></tr></table></code></pre><p>The times for FastCGI caching tend to vary in practice - sometimes it’s not appropriate to use it all, while for others it can be cached for some time.</p><p>It’s generally fairly safe to cache CSS and JS for a long time with a Laravel app if you’re using Mix to version those assets, so I feel comfortable caching them for a year. Images are a bit dicier, but still don’t change often so a month seems good enough.</p><p>I’ll typically give each application its own pool, which means copying the file at <code>/etc/php/7.0/fpm/pool.d/www.conf</code> to another file in the same directory, amending the pool name and path to set a new location for the socket, and then restarting Nginx and PHP-FPM. Here are the fields that should be changed:</p><pre><code class="hljs lang-ini"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>; Start a new pool named 'www'.</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>; the variable $pool can be used in any directive and will be replaced by the</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>; pool name ('www' here)</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>[my-app.domain]</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>...</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>listen = /var/run/php/php7.0-fpm-my-app.sock</td></tr></table></code></pre><h2 id="database">Database</h2><p>I’m a fan of PostgreSQL - it’s stricter than MySQL/MariaDB, and has some very useful additional field types, so where possible I prefer to use it over MySQL or MariaDB.</p><h2 id="cache-and-session-backend">Cache and session backend</h2><p>Redis is my usual choice here - I make heavy use of cache tags so I need a backend for the cache that supports them, and Memcached doesn’t seem to have as much inertia as Redis these days. Neither needs much in the way of configuration, but you can get a slight speed boost by using phpiredis.</p><h2 id="queue">Queue</h2><p>I sometimes use Redis for this too, but it can be problematic if you’re using Redis as the queue and broadcast backend, so these days I’m more likely to use Beanstalk and keep Redis for other stuff. I use Supervisor for running the queue worker, and this is an example of the sort of configuration I would use:</p><pre><code class="hljs lang-ini"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-section">[program:laravel-worker]</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-attr">process_name</span>=%(program_name)s_%(process_num)<span class="hljs-number">02</span>d</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-attr">command</span>=php /var/www/artisan queue:work --sleep=<span class="hljs-number">3</span> --tries=<span class="hljs-number">3</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-attr">user</span>=www-data</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-attr">numprocs</span>=<span class="hljs-number">8</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-attr">stdout_logfile</span>=/var/log/worker.log</td></tr></table></code></pre><p>This is fairly standard for Laravel applications.</p><h2 id="scheduler">Scheduler</h2><p>I often make use of the Laravel scheduled tasks system. Here’s the typical cron job that would be used for that:</p><pre><code class="hljs lang-cron singleline"><span class="hljs-bullet">* </span><span class="hljs-bullet">* *</span> <span class="hljs-bullet">* *</span> php /var/www/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1</code></pre><p>Again, this is standard for Laravel applications. It runs the scheduler every minute, and the scheduler then determines if it needs to do something.</p><h2 id="provisioning">Provisioning</h2><p>To set all this up, I’ll generally use Ansible. In addition to this, I’ll generally also set up fail2ban to block various attacks via both HTTP and SSH.</p></article><article class="post"><p class="date">28th January 2018 8:20 pm</p><h1><a href="/blog/2018/01/28/why-the-speed-of-your-mvc-framework-is-usually-a-red-herring/">Why the Speed of Your MVC Framework Is Usually a Red Herring</a></h1><p>Skim through any programming-related forum and you’ll often find statements along the lines of the following:</p><ul><li>“I chose Lumen for my website because the benchmarks show it’s faster than Laravel”</li><li>“I’m using raw queries because they’re faster than using an ORM”</li><li>“I wrote the site in pure PHP to avoid the overhead of a framework”</li></ul><p>Making my web apps performant is something I care deeply about. Yet every time I see something like this I cringe. Why? Because statements like these are full of wild misconceptions about the real performance bottlenecks in modern web applications. I don’t blame framework vendors for publishing benchmarks of their applications, since the performance of web apps <em>is</em> a big issue, but they are often misleading even when they’re correct, and it’s all too easy for inexperienced developers to think that performance is a matter of picking the fastest framework, rather than following a methodology of identifying and dealing with performance bottlenecks.</p><p>In this post I’ll explain why the performance of the framework, while not a non-issue, should come way down the list of factors involved in choosing a framework (or not to use one at all), behind functionality and developer productivity, and how many other factors not related to the choice of framework are involved.</p><h2 id="benchmarks-don-t-include-real-world-optimisations">Benchmarks don’t include real-world optimisations</h2><p>When benchmarking a number of frameworks together, you’ll typically be testing some fairly basic behaviour such as rendering a view, and maybe making a database query. It’s rare for them to also include things such as caching queries or sending the correct HTTP caching headers.</p><p>Also, it’s quite common for the party creating the benchmark to have their own preference they’re more familiar with, in which case they’ll have a better idea of how to optimise that one. If they don’t know how to optimise all of them to the same extent, the end results is going to be biased. For example, in the case of Laravel, running <code>php artisan optimize</code> can significantly improve application performance by caching large chunks of the application.</p><p>In addition, the configuration for the web server is quite likely to be suboptimal compared to a production server. For instance, they may not have the opcode cache installed, or Nginx may not set the right headers on static assets. Under these circumstances the benchmarks are very likely to be misleading. Ultimately, if you chose to completely rewrite an entire application from scratch in a new framework to claw back a few milliseconds, how do you know you’ll actually see that translate into better performance in production for your particular use case?</p><p>And if you’re even <em>considering</em> running a supposedly performance-critical application on shared hosting, you should hang your head in shame…</p><h2 id="your-from-scratch-implementation-of-functionality-is-probably-slower-than-an-existing-one">Your from-scratch implementation of functionality is probably slower than an existing one</h2><p>If you’re building some functionality from scratch instead of using an off-the-shelf library on the basis of performance, just stop. Existing libraries have usually had a great deal of attention already, should have working test suites, and depending on how active the developer community around them is, they may well have found and resolved the most egregious performance bottlenecks. Yours, on the other hand, will be new, untested, and could easily have serious bottlenecks if you haven’t profiled it extensively. It’s therefore very, very unlikely that you’ll be able to produce something more performant than the existing solutions, unless those existing solutions are old, barely maintained ones.</p><p>The <em>only</em> time this might be worthwhile is if all the existing implementations have boatloads of functionality, and you only need a small portion of that functionality. Even then, you should consider if it’s worth your while for a tiny speed boost. Or if you want to write a new library for it, go ahead - just don’t kid yourself about it being for the sake of performance.</p><h2 id="smaller-frameworks-are-faster-because-they-do-less">Smaller frameworks are faster because they do less</h2><p>Microframeworks such as Lumen <em>are</em> generally faster (at least in the artificial world of benchmarks), but that’s because they leave out functionality that’s not necessary for their targeted use case. Lumen is aimed at building microservices, and it leaves out things like templating, file handling, and other functionality not focused solely on building microservices. That means it’s less useful for other use cases. Any code that gets added to the application will make it marginally slower just by virtue of being there.</p><p>Under these circumstances it’s blindingly obvious that the framework that has to do less setup (eg instantiate fewer services, perform less operations on the request and response), is nearly always going to respond faster, regardless of suitability for more complex work.</p><p>If you start building a site with Lumen, but then discover that you need some functionality that Laravel has and Lumen doesn’t, you have two choices:</p><ul><li>Switch to Laravel</li><li>Add that functionality to your application (either through additional packages or rolling it yourself)</li></ul><p>I’ve often had plans to use Lumen for a project in the past, but then discovered that it would benefit from some of Laravel’s functionality. Under those circumstances I’ve switched straight over to Laravel - my time is too valuable to my employer to waste reimplementing functionality Laravel already has, and that functionality will inevitably have some overhead. Put it this way - I do a lot of Phonegap work, so building APIs is a big part of what I do, but I’ve only ever finished one project using Lumen (a push notification microservice). Every other time, sooner or later I’ve run into a situation where the additional functionality of Laravel would be useful and switched over.</p><p>There are occasions when a lighter framework like Lumen makes sense, but only when I simply don’t need the additional functionality of Laravel. It just doesn’t make sense to go for Lumen and then start adding functionality Laravel already has - any new implementation isn’t likely to be as solid, well-tested and performant as Laravel’s implementation.</p><h2 id="framework-performance-is-often-less-relevant-if-you-re-using-varnish">Framework performance is often less relevant if you’re using Varnish</h2><p>In my experience, if you have a site or API that is under heavy load, then if it’s possible to use Varnish with it, that will have a far more significant effect on performance than switching between PHP frameworks.</p><p>Because Varnish sits in front of your web server, when you’re serving cached content, anything after Varnish is completely irrelevant to the performance- it won’t hit the backend again until the cached content has expired. Varnish is effectively a key-value store, and is written in C, so it’s far more performant than just about any backend in any framework you could possibly write. And it’s configurable enough that with sufficient experience it can usually be helpful for most applications.</p><p>Varnish isn’t appropriate for every use case, and it doesn’t help with uncached requests (except by reducing the load on the application) but where high performance is necessary it can be a very big help indeed. The speed boost from having Varnish in front of your site and properly configured dwarfs any boost of a few milliseconds from switching PHP framework.</p><p>There are other HTTP caching servers available too - for instance, it’s possible to use Nginx as a web cache, and Cloudflare is a hosted service that offers similar performance benefits. Regardless, the same applies - if you can handle a request using the caching server rather than the application behind it, the performance will be immensely better, without having to change your application code.</p><h2 id="orm-vs-raw-queries-is-a-drop-in-the-ocean">ORM vs raw queries is a drop in the ocean</h2><p>There will always be <em>some</em> overhead from using any ORM. However, this is nearly always so minor as to be a non-issue.</p><p>For example, while there might be some slight performance increase from writing raw SQL instead of using an ORM, it’s generally dwarfed by the cost of making the query in the first place. You can get a far, far bigger improvement in performance by efficiently caching the responses than by rewriting ORM queries in raw SQL.</p><p>An ORM does make certain types of slow inefficient queries more likely, as well as making “hidden” queries (such as in Laravel when it fetches the user from the session), but that’s something that can be resolved by using a profiler like Clockwork to identify the slow or unnecessary queries and refactoring them. Most ORM’s have tools to handle things like the N+1 problem - for instance, Eloquent has the <code>with()</code> method to eager-load related tables, which is generally a lot more convenient than explicitly writing a query to do the eager-loading for you.</p><p>Using an ORM also comes with significant benefits to developers:</p><ul><li>It’s generally easier to express relations between tables</li><li>It helps avoid the mental context switch between PHP and SQL</li><li>It does a lot of the work of sanitizing data for you</li><li>It helps make your application portable between different databases (eg so you can run your tests using an in-memory SQLite database but use MySQL in production)</li><li>Where you have logic that can’t be expressed using the ORM, it’s generally easy to drop down to writing raw SQL for that part</li></ul><p>In my experience, querying the database is almost always the single biggest bottleneck (the only other thing that can be as bad is if you’re making requests to a slow third-party API), and any overhead from the ORM is a drop in the ocean in comparison. If you have a slow query in a web application, then rewriting it as a raw query is probably the very last thing you should consider doing, after:</p><ul><li>Refactoring the query or queries to be more efficient/remove unnecessary queries</li><li>Making sure the appropriate indices are set on your database</li><li>Caching the responses</li></ul><p>Caching in particular is quite hard to do - it’s difficult to come up with a reliable and reusable strategy for caching responses without serving stale content, but once you can do so, it makes a huge difference to application performance.</p><p>Writing all your queries as raw queries is a micro-optimisation - it’s a lot of work for not that much payback, and it’s hardly ever worth the bother. Even if you have a single, utterly horrendous query or set of queries that has a huge overhead, there are better ways to deal with it - under those circumstances I’d be inclined to create a stored procedure in a migration and call that rather than making the query directly.</p><h2 id="summary">Summary</h2><p>So to sum it up, if someone tells you you should use framework X because it’s faster than framework Y, they might be <em>somewhat</em> right, but that misses the point completely. Benchmarks are so artificial as to be almost useless for determining how your production code will perform. Any half-decent framework will give you the tools you need to optimise performance, and your use of those tools will have a far, far more signficant effect on the response time of your application than picking between different frameworks. I’ve never found a single MVC framework whose core is slow enough that I can’t make it fast enough with the capabilities provided.</p><p>Also, considering that these days server hardware is dirt cheap (at time of writing US$5 gets you a Digital Ocean droplet with 1GB of RAM for a month), whereas developers are far, far more expensive, it’s more cost effective to optimise for the <em>developer’s time</em>, not server time, so it makes sense to pick a framework that makes <em>you</em> productive, not one that makes the <em>application</em> productive. That’s no excuse for slow, shitty applications, but when all else fails, spinning up additional servers is a far more cost-effective solution than spending days on end rewriting your entire application in a different framework that benchmarks show might perform better by a few milliseconds.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers</a></p><p><a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">Put Your Laravel Controllers on a Diet</a></p><p><a href="/blog/2018/02/04/using-lando-as-an-alternative-to-vagrant/">Using Lando As An Alternative to Vagrant</a></p><p><a href="/blog/2018/01/29/how-i-deploy-laravel-apps/">How I Deploy Laravel Apps</a></p><p><a href="/blog/2018/01/28/why-the-speed-of-your-mvc-framework-is-usually-a-red-herring/">Why the Speed of Your MVC Framework Is Usually a Red Herring</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>