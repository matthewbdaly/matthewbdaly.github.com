<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="web,development,python,javascript,php,programming"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">20th October 2018 2:48 pm</p><h1><a href="/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/">Simplify Your Tests With Anonymous Classes</a></h1><p>Anonymous classes were added in PHP7, but so far I haven’t made all that much use of them. However, recently I’ve been working on building a simple dependency injection container for learning purposes. This uses the PHP Reflection API to determine how to resolve dependencies. For instance, if it’s asked for a class for which one of the dependencies required by the constructor is an instance of the <code>DateTime</code> class, it should create an instance, and then pass it into the constructor automatically when instantiating the class. Then it should return the newly created class.</p><p>Mocking isn’t really a suitable approach for this use case because the container needs to return a concrete class instance to do its job properly. You could just create a series of fixture classes purely for testing purposes, but that would mean either defining more than one class in a file (violating PSR-2), or defining a load of fixture classes in separate files, meaning you’d have to write a lot of boilerplate, and you’d have to move between several different files to understand what’s going on in the test.</p><p>Anonymous classes allow you a means to write simple classes for tests inline, as in this example for retrieving a very basic class. The tests use PHPSpec:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>\<span class="hljs-title">MyClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">DateTime</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>You can also define your own methods inline. Here we implement the <code>invoke()</code> magic method so that the class is a callable:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_invokable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DateTime;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>You can also define a constructor. Here, we’re getting the class name of a newly created anonymous class that accepts an instance of <code>DateTime</code> as an argument to the constructor. Then, we can resolve a new instance out of the container:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&lt;?php</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>class MyClassSpec extends ObjectBehavior</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    function it_can_resolve_dependencies()</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(new class(new DateTime) {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            public $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            public function __construct(DateTime $datetime)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                $this-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $this-&gt;set('Foo\Bar', $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $this-&gt;get('Foo\Bar')-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>For classes that will extend an existing class or implement an interface, you can define those inline too. Or you can include a trait:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&lt;?php</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>class MyClassSpec extends ObjectBehavior</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    function it_can_resolve_dependencies()</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(new class(new DateTime) extends Foo implements Bar {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            public $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            public function __construct(DateTime $datetime)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                $this-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            use MyTrait;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $this-&gt;set('Foo\Bar', $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $this-&gt;get('Foo\Bar')-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>In cases where the functionality is contained in a trait or abstract class, and you might need to add little or no additional functionality, this is a lot less verbose than creating a class the conventional way.</p><p>None of this is stuff you can’t do without anonymous classes, but by defining these sort of disposable fixture classes inline in your tests, you’re writing the minimum amount of code necessary to implement your test, and it’s logical to define it inline since it’s only ever used in the tests. One thing to bear in mind is that anonymous classes are created and instantiated at the same time, so you can’t easily create a class and then instantiate an instance of it separately. However, you can instantiate one, then use the <code>get_class()</code> function to get its class name and use that to resolve it, which worked well for my use case.</p><p>Another use case for anonymous classes is testing traits or abstract classes. I generally use Mockery as my mocking solution with PHPUnit tests, but I’ve sometimes missed the <code>getMockForTrait()</code> method from PHPUnit. However, another option is to instantiate an anonymous class that includes that trait for testing purposes:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>&lt;?php</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$item = new class() {</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    use MyTrait;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>};</td></tr></table></code></pre><p>This way, your test class is as minimal as possible, and you can test the trait/abstract class in a fairly isolated fashion.</p></article><article class="post"><p class="date">16th October 2018 9:00 am</p><h1><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></h1><p>The project I’m currently working on is a textbook example of what happens when a project uses jQuery when it really ought to use a proper Javascript framework, or it starts out just using jQuery and grows out of all proportion. It’s also not helped by the fact that historically it’s just been worked on when new functionality needs to be added, meaning that rather than refactoring the code base, it’s been copied-and-pasted. As a result, there’s lots of repetitive code in desparate need of refactoring, and huge reams of horrible jQuery spaghetti code.</p><p>When I first took over responsibility for the project, I integrated Laravel Mix into it so that I had the means to refactor some of the common functionality into separate files and require them during the build process, as well as use ES6. However, this was only the first step, as it didn’t sort out the fundamental problem of repetitive boilerplate code being copied and pasted. What I needed was a refactor to use something more opinionated. As it happened, I was asked to add a couple of modals to the admin, and since the modals were one of the worst parts of the admin in terms of repetitive code, they were a strong candidate for implementing using a more suitable library.</p><p>I looked at a few options:</p><ul><li>I’ve used Angular 1 quite successfully in the past, but I didn’t really want to use a framework that was being killed off, and it would be difficult to retrofit into a legacy application</li><li>Angular 2+ is actively maintained, but it would again be difficult to retrofit it into a legacy application. In addition, the need for TypeScript would make it problematic.</li><li>Vue was a possibility, but it did a bit too much for this use case, and it wasn’t all that clear how to retrofit it to an existing application</li></ul><p>Eventually, I settled on React.js, for the following reasons:</p><ul><li>It has a preset in Laravel Mix, making it easy to get started with it.</li><li>It has a very limited target - React is closely focused on the view layer, dealing only with rendering and event handling, so it does just what I needed in this case.</li><li>It has a strong record of use with legacy applications - after all, it was created by Facebook and they added it incrementally.</li><li>It’s easy to test - Jest’s snapshot tests make it easy to verify the rendered content hasn’t changed, and using Enzyme it’s straightforward to test interactions with the component</li><li>Higher order components provide a straightforward way to share functionality between components, which I needed to allow different modals to deal with another modal in the same way.</li><li>By creating a series of components for common user interface elements, I could then re-use those components in future work, saving time and effort.</li></ul><p>However, it wasn’t entirely clear how I might go about integrating React into a legacy application. In the end, I managed to figure out an approach which worked.</p><p>Normally, I would create a single root for my application, something like this:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/App'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>ReactDOM.render(</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    document.getElementById('root')</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>);</td></tr></table></code></pre><p>However, that wasn’t an option here. The existing modals were using jQuery and Bootstrap, and the new modals had to work with them. I therefore needed to have only certain parts of the UI managed with React, and the rest wouldn’t be touched. Here’s an example of how I rendered the modal in the end:</p><pre><code class="hljs lang-javascript"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">import</span> higherOrderComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/higherOrderComponent'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> modalComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/modalComponent'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">const</span> Modal = higherOrderComponent(modalComponent);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-built_in">window</span>.componentWrapper = ReactDOM.render(</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> /&gt;</span>,</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>  document.getElementById('modalTarget')</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>window.componentWrapper.setState({</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  foo: 'bar'</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>});</td></tr></table></code></pre><p>By extracting the duplicate functionality into a higher order component, I could easily wrap the new modals in that component and share that functionality between the modals. I could then render each component in a different target element, and assign it to a variable in the <code>window</code> namespace. The div with a ID of <code>modalTarget</code> needed to be added in the appropriate place, but otherwise the HTML didn’t need to be touched, since the required markup was in the React component instead.</p><p>Then, when I needed to change a value int the statee of the component, I could just call <code>window.componentWrapper.setState({})</code>, passing through the values to set, and these would propogate down to the child components as usual. I could also render multiple different modal components on the page, and refer to each one separately in order to set the state.</p><p>This isn’t an approach I’d recommend on a greenfield project - state isn’t really something you should be setting from outside a component like this, and normally I wouldn’t do it. However, it seemed to be the easiest way for this particular use case. Over time I’ll port more and more of the UI over to React, and eventually it won’t be necessary as I’ll be storing the application state in something like Redux.</p></article><article class="post"><p class="date">11th October 2018 9:21 am</p><h1><a href="/blog/2018/10/11/do-you-still-need-jquery/">Do You Still Need Jquery?</a></h1><p>There was a time not so long ago when jQuery was ubiquitous. It was used on almost every website as a matter of course, to the point that many HTML boilerplates included a reference to the CDN.</p><p>However, more and more I think it’s probably unnecessary for two main use cases:</p><h2 id="jquery-is-probably-unnecessary-for-many-web-apps-with-simple-javascript">jQuery is probably unnecessary for many web apps with simple Javascript</h2><p>When jQuery first appeared, IE6 was commonplace, and browser API’s were notoriously inconsistent. jQuery was very useful in ironing out those inconsistencies and helping to make</p><p>Nowadays, that’s no longer the case. Internet Explorer is on its way out, with IE11 being the only version still supported by Microsoft, and it’s becoming increasingly hard to justify support for older versions, especially with mobile browsers forming a bigger than ever chunk of the market. We’ll probably need to continue supporting IE11 for a good long while, and possibly IE10 for some time too, but these aren’t anything like as bad to work with as IE6. It’s worth noting that newer versions of jQuery are also dropping support for these older browsers, so in many ways it actually does less than it used to.</p><p><a href="http://lmgtfy.com/?q=do+you+still+need+jquery">This is the usual thrust of articles on whether you should still be using jQuery</a> so I’m not going to go over this matter , but for many smaller web apps, jQuery is no longer necessary, and a lot of developers have a tendency to keep using it when it’s probably not required.</p><h2 id="jquery-is-insufficient-for-web-apps-with-complex-javascript">jQuery is insufficient for web apps with complex Javascript</h2><p>Nowadays, there’s a lot of web applications that have moved big chunks of functionality from the server side to the client side. Beyond a certain (and quite small) level of complexity, jQuery just doesn’t do enough to cut it. For me personally, the nature of the projects I work on means that this is a far, far bigger issue than the first one.</p><p>I used to work predominantly with Phonegap, which meant that a lot of functionality traditionally done on the server side had to be moved to the client side, and for that jQuery was never sufficient. My first Phonegap app started out using jQuery, but it quickly became obvious that it was going to be problematic. It wound up as a huge mass of jQuery callbacks and Handlebars templates, which was almost impossible to test and hard to maintain. Given this experience, I resolved to switch to a full-fledged Javascript framework next time I built a mobile app, and for the next one I chose Backbone.js, which still used jQuery as a dependency, but made things more maintainable by giving a structure that it didn’t have before, which was the crucial difference.</p><p>The more modern generation of Javascript frameworks such as Vue and React, go further in making jQuery redundant. Both of these implement a so-called Virtual DOM, which is used to calculate the minimum changes required to re-render the element in question. Subsequently using jQuery to mutate the DOM would cause problems because it would get out of sync with the Virtual DOM - in fact, in order to get a jQuery plugin working in the context of a React component, you have to actively prevent React from touching the DOM, thereby losing most of the benefits of using React in the first place. You usually see better results from using a React component designed for that purpose (or writing one, which React makes surprisingly simple), than from trying to shoehorn a jQuery plugin into it.</p><p>They also make a lot of things that jQuery does trivially easy - for instance, if you want to conditionally show and hide content in a React component, it’s just a case of building it to hide that content based on a particular value in the props or state, or filtering a list is just a case of applying a filter to the array containing the data and setting the state as appropriate.</p><p>In short, for single-page web apps or other ones with a lot of Javascript, you should look at other solutions first, and not just blithely assume jQuery will be up to the task. It’s technically possible to build this sort of web app using jQuery, but it’s apt to turn into a morass of spaghetti code unless approached with a great deal of discipline, one that sadly many developers don’t have, and it doesn’t exactly make it easy to promote code reuse. These days, I prefer React for complex web apps, because it makes it extremely intuitive to break my user interface up into reusable components, and test them individually. Using React would be overkill on brochure-style sites (unless you wanted to build it with something like Gatsby), but for more complex apps it’s often a better fit than jQuery.</p><h2 id="so-when-should-you-use-jquery-">So when should you use jQuery?</h2><p>In truth, I’m finding it harder and harder to justify using it at all on new builds. I use it on my personal site because that’s built on Bootstrap 3 and so depends on jQuery, but for bigger web apps I’m generally finding myself moving to React, which renders it not just unnecessary for DOM manipulation, but counter-productive to use it. Most of what I do is big enough to justify something like React, and it generally results in code that is more declarative, easier to test and reason about, and less repetitive. Using jQuery for an application like this is probably a bad idea, because it’s difficult (not impossible, mind, if you follow some of the advice <a href="https://learn.jquery.com/code-organization/">here</a>, use a linter and consider using a proper client-side templating system alongside jQuery) to build an elegant and maintainable Javascript-heavy application.</p><p>As a rule of thumb, I find anything which is likely to require more than a few hundred lines of Javascript to be written, is probably complex enough that jQuery isn’t sufficient, and I should instead consider something like React.</p><p>I doubt it’d be worth the bother of ripping jQuery out of a legacy application and rewriting the whole thing to not require it, but for new builds I would think very hard about:</p><ul><li>Whether jQuery is sufficient, or you’d be better off using something like React, Vue or Angular</li><li>If it is sufficient, whether it’s actually necessary</li></ul><p>In all honesty, I don’t think using it when it’s technically not necessary is as much of a big deal as the issue of using it when it’s not really sufficient. Yes, dowloading a library you technically don’t need for a page is a bad practice, and it does make your site slower and harder for users on slow mobile connections, but there are ways to mitigate that such as CDN’s, caching and minification. If you build a web app using jQuery alone when React, Vue or Angular would be more suitable, you’re probably going to have to write a lot more code that will be difficult to maintain, test and understand. Things like React were created to solve the problems that arose when developers built complex client-side applications with jQuery, and are therefore a good fit for bigger applications. The complex setup does mean they have a threshold below which it’s not worth the bother of using them, but past that threshold they result in better, more maintainable, more testable and more reusable code.</p><h2 id="now-react-is-cool-you-hate-jquery-you-hipster-">Now React is cool, you hate jQuery, you hipster…</h2><p>Don’t be a prat. Bitter experience has taught me that for a lot of my own personal use cases, jQuery is insufficient. It doesn’t suck, it’s just insufficient. If for your use case, jQuery <em>is</em> sufficient, then that’s fine. All I’m saying is that when a web app becomes sufficiently complex, jQuery can begin to cause more problems than it solves, and that for a sufficiently complex web app you should consider other solutions.</p><p>I currently maintain a legacy application that includes thousands of lines of Javascript. Most of it is done with jQuery and some plugins, and it’s resulted in some extremely repetitive jQuery callbacks that are hard to maintain and understand, and impossible to test. Recently I was asked to add a couple of modals to the admin interface, and rather than continuing to add them using jQuery and adding more spaghetti code, I instead opted to build them with React. During the process of building the first modal, I produced a number of components for different elements of the UI. Then, when I built the second one, I refactored those components to be more generic, and moved some common functionality into a higher-order component so that it could be reused. Now, if I need to add another modal, it will be trivial because I already have those components available, and I can just create a new component for the modal, import those components that I need, wrap it in the higher-order component if necessary, and that’s all. I can also easily test those components in isolation. In short, I’ve saved myself some work in the long run by writing it to use a library that was a better fit.</p><p>It’s not like using jQuery inevitably results in unmaintainable code, but it does require a certain amount of discipline to avoid it. A more opinionated library such as React makes it far, far harder to create spaghetti code, and makes code reuse natural in a way that jQuery doesn’t.</p></article><article class="post"><p class="date">8th October 2018 11:20 am</p><h1><a href="/blog/2018/10/08/an-approach-to-writing-golden-master-tests-for-php-web-applications/">An Approach to Writing Golden Master Tests for PHP Web Applications</a></h1><p>Apologies if some of the spelling or formatting on this post is off - I wrote it on a long train journey down to London, with sunlight at an inconvenient angle.</p><p>Recently I had to carry out some substantial changes to the legacy web app I maintain as the lion’s share of my current job. The client has several channels that represent different parts of the business that would expect to see different content on the home page, and access to content is limited first by channel, and then by location. The client wanted an additional channel added. Due to bad design earlier in the application’s lifetime that isn’t yet practical to refactor away, each type of location has its own model, so it was necessary to add a new location model. It also had to work seamlessly, in the same way as the other location types. Unfortunately, these branch types didn’t use polymorphism, and instead used large switch statements, and it wasn’t practical to refactor all that away in one go. This was therefore quite a high-risk job, especially considering the paucity of tests on a legacy code base.</p><p>I’d heard of the concept of a <em>golden master test</em> before. If you haven’t heard of it before, the idea is that it works by running a process, capturing the output, and then comparing the output of that known good version against future runs. It’s very much a test of last resort since, in the context of a web app, it’s potentially very brittle since it depends on the state of the application remaining the same between runs to avoid false positives. I needed a set of simple “snapshot tests”, similar to how snapshot testing works with Jest, to catch unexpected breakages in a large number of pages, and this approach seemed to fit the bill. Unfortunately, I hadn’t been able to find a good example of how to do this for PHP applications, so it took a while to figure out something that worked.</p><p>Here is an example base test case I used for this approach:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span> <span class="hljs-title">as</span> <span class="hljs-title">BaseTestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Mink</span>\<span class="hljs-title">Driver</span>\<span class="hljs-title">GoutteDriver</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Behat</span>\<span class="hljs-title">Mink</span>\<span class="hljs-title">Session</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoldenMasterTestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">protected</span> $driver;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $session;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $baseUrl = <span class="hljs-string">'http://localhost:8000'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">protected</span> $snapshotDir = <span class="hljs-string">"tests/snapshots/"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">$this</span>-&gt;driver = <span class="hljs-keyword">new</span> GoutteDriver();</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = <span class="hljs-keyword">new</span> Session(<span class="hljs-keyword">$this</span>-&gt;driver);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session = <span class="hljs-keyword">null</span>;</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-keyword">$this</span>-&gt;driver = <span class="hljs-keyword">null</span>;</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loginAs</span><span class="hljs-params">($username, $password)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session-&gt;visit(<span class="hljs-keyword">$this</span>-&gt;baseUrl.<span class="hljs-string">'/login'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        $page = <span class="hljs-keyword">$this</span>-&gt;session-&gt;getPage();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        $page-&gt;fillField(<span class="hljs-string">"username"</span>, $username);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $page-&gt;fillField(<span class="hljs-string">"password"</span>, $password);</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $page-&gt;pressButton(<span class="hljs-string">"Sign In"</span>);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goto</span><span class="hljs-params">($path)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        <span class="hljs-keyword">$this</span>-&gt;session-&gt;visit(<span class="hljs-keyword">$this</span>-&gt;baseUrl.$path);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNotEquals(<span class="hljs-number">404</span>, <span class="hljs-keyword">$this</span>-&gt;session-&gt;getStatusCode());</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveHtml</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;snapshotExists()) {</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>            <span class="hljs-keyword">$this</span>-&gt;saveSnapshot();</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assertSnapshotsMatch</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>        $path = <span class="hljs-keyword">$this</span>-&gt;getPath();</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>        $newHtml = <span class="hljs-keyword">$this</span>-&gt;processHtml(<span class="hljs-keyword">$this</span>-&gt;getHtml());</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>        $oldHtml = <span class="hljs-keyword">$this</span>-&gt;getOldHtml();</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>        $diff = <span class="hljs-string">""</span>;</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>        <span class="hljs-keyword">if</span> (function_exists(<span class="hljs-string">'xdiff_string_diff'</span>)) {</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>            $diff = xdiff_string_diff($oldHtml, $newHtml);</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>        $message = <span class="hljs-string">"The path $path does not match the snapshot\n$diff"</span>;</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-keyword">self</span>::assertThat($newHtml == $oldHtml, <span class="hljs-keyword">self</span>::isTrue(), $message);</td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHtml</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;session-&gt;getPage()-&gt;getHtml();</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPath</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;session-&gt;getCurrentUrl();</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>        $path = parse_url($url, PHP_URL_PATH);</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>        $query = parse_url($url, PHP_URL_QUERY);</td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>        $frag = parse_url($url, PHP_URL_FRAGMENT);</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>        <span class="hljs-keyword">return</span> $path.$query.$frag;</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEscapedPath</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;snapshotDir.str_replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">'_'</span>, <span class="hljs-keyword">$this</span>-&gt;getPath()).<span class="hljs-string">'.snap'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">snapshotExists</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="89"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="90"></td><td>        <span class="hljs-keyword">return</span> file_exists(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath());</td></tr><tr><td class="linenos" data-pseudo-content="91"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="92"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="93"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processHtml</span><span class="hljs-params">($html)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="94"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="95"></td><td>        <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-string">'/&lt;input type="hidden"[^&gt;]+\&gt;/i'</span>, <span class="hljs-string">''</span>, $html);</td></tr><tr><td class="linenos" data-pseudo-content="96"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="97"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="98"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveSnapshot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="99"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="100"></td><td>        $html = <span class="hljs-keyword">$this</span>-&gt;processHtml(<span class="hljs-keyword">$this</span>-&gt;getHtml());</td></tr><tr><td class="linenos" data-pseudo-content="101"></td><td>        file_put_contents(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath(), $html);</td></tr><tr><td class="linenos" data-pseudo-content="102"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="103"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="104"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOldHtml</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="105"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="106"></td><td>        <span class="hljs-keyword">return</span> file_get_contents(<span class="hljs-keyword">$this</span>-&gt;getEscapedPath());</td></tr><tr><td class="linenos" data-pseudo-content="107"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="108"></td><td>}</td></tr></table></code></pre><p>Because this application is built with Zend 1 and doesn’t have an easy way to get the HTML response without actually running the application, I was forced to use an actual HTTP client to fetch the content while the web server is running. I’ve used Mink together with Behat many times in the past, and the Goutte driver is fast and doesn’t rely on Javascript, so that was the best bet for a simple way of retrieving the HTML. Had I been taking this approach with a Laravel application, I could have populated the testing database with a common set of fixtures, and passed a request object through the application and captured the response object’s output rather than using an HTTP client, thereby eliminating the need to run a web server and making the tests faster and less brittle.</p><p>Another issue was CSRF handling. A CSRF token is, by definition, generated randomly each time the page is loaded, and so it broke those pages that had forms with CSRF tokens. The solution I came up with was to strip out the hidden input fields.</p><p>When each page is tested, the first step is to fetch the content of that page. The test case then checks to see if there’s an existing snapshot. If not, the content is saved as a new snapshot file. Otherwise, the two snapshots are compared, and the test fails if they do not match.</p><p>Once that base test case was in place, it was then straightforward to extend it to test multiple pages. I wrote one test to check pages that did not require login, and another to check pages that did require login, and the paths for those pages were passed through using a data provider method, as shown below:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMaster</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">GoldenMasterTestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoldenMasterTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GoldenMasterTestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * <span class="hljs-doctag">@dataProvider</span> nonAuthDataProvider</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testNonAuthPages</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;goto($data)</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            -&gt;saveHtml()</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            -&gt;assertSnapshotsMatch();</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nonAuthDataProvider</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            [<span class="hljs-string">'/login'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@dataProvider</span> dataProvider</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPages</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;loginAs(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            -&gt;goto($data)</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;saveHtml()</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            -&gt;assertSnapshotsMatch();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dataProvider</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>            [<span class="hljs-string">'/foo'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>            [<span class="hljs-string">'/bar'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>}</td></tr></table></code></pre><p>Be warned, this is <em>not</em> an approach I would advocate as a matter of course, and it should only ever be a last resort as an alternative to onerous manual testing for things that can’t be tested in their current form. It’s extremely brittle, and I’ve had to deal with a lot of false positives, although that would be easier if I could populate a testing database beforehand and use that as the basis of the tests. It’s also very slow, with each test taking three or four seconds to run, although again this would be less of an issue if I could pass through a request object and get the response HTML directly. Nonetheless, I’ve found it to be a useful technique as a test of last resort for legacy applications.</p></article><article class="post"><p class="date">5th October 2018 7:36 pm</p><h1><a href="/blog/2018/10/05/understanding-the-pipeline-pattern/">Understanding the Pipeline Pattern</a></h1><p>In a previous post, I used the pipeline pattern to demonstrate processing letters using optical recognition and machine learning. The pipeline pattern is something I’ve found very useful in recent months. For a sequential series of tasks, this approach can make your code easier to understand by allowing you to break it up into simple, logical steps which are easy to test and understand individually. If you’re familiar with pipes and redirection in Unix, you’ll be aware of how you can chain together multiple, relatively simple commands to carry out some very complex transformations on data.</p><p>A few months back, I was asked to build a webhook for a Facebook lead form at work. One of my colleagues was having to manually export CSV data from Facebook for the data, and then import it into a MySQL database and a Campaign Monitor mailing list, which was an onerous task, so they asked me to look at more automated solutions. I wound up building a webhook with Lumen that would go through the following steps:</p><ul><li>Get the lead ID’s from the webhook</li><li>Pull the leads from the Facebook API using those ID’s</li><li>Process the raw data into a more suitable format</li><li>Save the data to the database</li><li>Push the data to Campaign Monitor</li></ul><p>Since this involved a number of discrete steps, I chose to implement each step as a separate stage. That way, each step was easy to test in isolation, and it was easily reusable. As it turned out, this approach saved us because Facebook needed to approve this app (and ended up rejecting it - their documentation at the time wasn’t clear on implementing server-to-server apps, making it hard to meet their guidelines), so we needed an interim solution. I instead wrote an Artisan task for importing the file from a CSV, which involved the following steps:</p><ul><li>Read the rows from the CSV file</li><li>Format the CSV data into the desired format</li><li>Save the data to the database</li><li>Push the data to Campaign Monitor</li></ul><p>This meant that two of the existing steps could be reused, as is, without touching the code or tests. I just added two new classes to read the data and format the data, and the Artisan command, which simply called the various pipeline stages, <em>and that was all</em>. In this post, I’ll demonstrate how I implemented this.</p><p>While there is more than one implementation of this available, and it wouldn’t be hard to roll your own, I generally use the PHP League’s <a href="https://pipeline.thephpleague.com/">Pipeline package</a>, since it’s simple, solid and well-tested. Let’s say our application has three steps:</p><ul><li>Format the request data</li><li>Save the data</li><li>Push it to a third party service.</li></ul><p>We therefor need to write a stage for each step in the process. Each one must be a callable, such as a closure, a callback, or a class that implements the <code>__invoke()</code> magic method. I usually go for the latter as it allows you to more easily inject dependencies into the stage via its constructor, making it easier to use and test. Here’s what our first stage might look like:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FormatData</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span>: <span class="hljs-title">Collection</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-string">'name'</span> =&gt; $item-&gt;fullname,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">'email'</span> =&gt; $item-&gt;email</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            ];</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>}</td></tr></table></code></pre><p>This class does nothing more than receive a collection, and format the data as expected. We could have it accept a request object instead, but I opted not to because I felt it made more sense to pass the data in as a collection so it’s not tied to an HTTP request. That way, it can also handle data passed through from a CSV file using an Artisan task, and the details of how it receives the data in the first place are deferred to the class that calls the pipeline in the first place. Note this stage also returns a collection, for handling by the next step:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Lead</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SaveData</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span>: <span class="hljs-title">Collection</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            $lead = <span class="hljs-keyword">new</span> Lead;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            $lead-&gt;name = $item-&gt;name;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            $lead-&gt;email = $item-&gt;email;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            $lead-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">return</span> $lead;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>This step saves each lead as an Eloquent model, and returns a collection of the saved models, which are passed to the final step:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">MailingList</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddDataToList</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $list;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(MailingList $list)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;list = $list;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(Collection $data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> $data-&gt;each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">$this</span>-&gt;list-&gt;add([</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                <span class="hljs-string">'name'</span> =&gt; $item-&gt;name,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">'email'</span> =&gt; $item-&gt;email</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            ]);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></tr></table></code></pre><p>This step uses a wrapper class for a mailing service, which is passed through as a dependency in the constructor. The <code>__invoke()</code> method then loops through each Eloquent model and uses it to fetch the data, which is then added to the list. With our stages complete, we can now put them together in our controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">FormatData</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">SaveData</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">AddDataToList</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">Pipeline</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Collection</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebhookController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request, Pipeline $pipeline, FormatData $formatData, SaveData $savedata, AddDataToList $addData)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">try</span> {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            $data = Collection::make($request-&gt;get(<span class="hljs-string">'data'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>            $pipe = $pipeline-&gt;pipe($formatData)</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>                -&gt;pipe($saveData)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>                -&gt;pipe($addData);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            $pipe-&gt;process($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        } <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> $e) {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-comment">// Handle exception</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>}</td></tr></table></code></pre><p>As mentioned above, we extract the request data (assumed to be an array of data for a webhook), and convert it into a collection. Then, we put together our pipeline. Note that we use dependency injection to fetch the steps - feel free to use method or constructor injection as appropriate. We instantiate our pipeline, and call the <code>pipe()</code> method multiple times to add new stages.</p><p>Finally we pass the data through to our pipe for processing by calling the <code>process()</code> method, passing in the initial data. Note that we can wrap the whole thing in a <code>try...catch</code> statement to handle exceptions, so if something happens that would mean we would want to cease processing at that point, we can throw an exception in the stage and handle it outside the pipeline.</p><p>This means that our controller is kept very simple. It just gets the data as a collection, then puts the pipeline together and passes the data through. If we subsequently had to write an Artisan task to do something similar from the command line, we could fetch the data via a CSV reader class, and then pass it to the same pipeline. If we needed to change the format of the initial data, we could replace the <code>FormatData</code> class with a single separate class with very little trouble.</p><p>Another thing you can do with the League pipeline package, but I haven’t yet had the occasion to try, is use <code>League\Pipeline\PipelineBuilder</code> to build pipelines in a more dynamic fashion. You can make steps conditional, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">PipelineBuilder</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>$builder = (<span class="hljs-keyword">new</span> PipelineBuilder)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    -&gt;add(<span class="hljs-keyword">new</span> FormatData);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">if</span> ($data[<span class="hljs-string">'type'</span>] = <span class="hljs-string">'foo'</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    $builder-&gt;add(<span class="hljs-keyword">new</span> HandleFooType);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>$builder-&gt;add(<span class="hljs-keyword">new</span> SaveData);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$pipeline = $builder-&gt;build();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>$pipeline-&gt;process($data);</td></tr></table></code></pre><p>The pipeline pattern isn’t appropriate for every situation, but for anything that involves a set of operations on the same data, it makes a lot of sense, and can make it easy to break larger operations into smaller steps that are easier to understand, test, and re-use.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/">Simplify Your Tests With Anonymous Classes</a></p><p><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></p><p><a href="/blog/2018/10/11/do-you-still-need-jquery/">Do You Still Need Jquery?</a></p><p><a href="/blog/2018/10/08/an-approach-to-writing-golden-master-tests-for-php-web-applications/">An Approach to Writing Golden Master Tests for PHP Web Applications</a></p><p><a href="/blog/2018/10/05/understanding-the-pipeline-pattern/">Understanding the Pipeline Pattern</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a href="/posts/2/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>