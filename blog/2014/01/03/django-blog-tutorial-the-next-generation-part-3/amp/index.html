<!doctype html><html amp lang="en"><head><meta charset="utf-8"><title>Django Blog Tutorial - the Next Generation - Part 3 - Matthew Daly&#x27;s Blog</title><link rel="canonical" href="https://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link href="/favicon.ico" rel="icon"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#252525"><script type="application/ld+json">{
         "@context": "http://schema.org",
         "@type": "BlogPosting",
         "mainEntityOfPage": "https://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/",
         "headline": "Django Blog Tutorial - the Next Generation - Part 3",
         "datePublished": "2014-01-03T12:57:30.000Z",
         "dateModified": "2014-01-03T12:57:30.000Z",
         "description": "&lt;p&gt;Hello again! In this instalment, we’re going to do the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Add support for fl...",
         "author": {
              "@type": "Person",
              "name": "Matthew Daly"
         },
         "publisher": {
            "@type": "Organization",
            "name": "Matthew Daly&#x27;s Blog",
            "logo": {
               "@type": "ImageObject",
               "url": "https://matthewdaly.co.uk/favicon.ico",
               "height": 16,
               "width": 16
            }
         },
         "image": {
            "@type": "ImageObject",
            "url": "https://matthewdaly.co.uk/logo.png",
            "height": 120,
            "width": 1200
         }
      }</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet" type="text/css"><style amp-custom>body {
   background-color: #252525;
}
      div.container {
         background-color: #f8f8f8;
         width: 100%;
      }
      p, h1, h2, h3, h4, h5, h6, li, nav a {
         font-family: "PT Serif","Georgia","Helvetica Neue",Arial,sans-serif;
         text-rendering: optimizelegibility;
      }
      p, li {
         font-size: 1.4em;
         line-height: 1.5em;
      }
      header {
         padding: 20px;
         color: #505050;
      }
      header h1 {
         font-size: 3em;
         line-height: 1.2em;
         color: #7f7f7f;
      }
      header h2 {
         font-size: 1.5em;
         color: #7f7f7f;
      }
      h1 a {
         text-decoration: none;
         color: #7f7f7f;
      }
      code {
         white-space: pre-wrap;
         word-wrap: break-word;
         font-family: Menlo, Monaco, "Andale Mono", "Ubuntu Mono", "lucida console", monospace;
         background-color: #cfcfcf;
         padding: 5px;
         border-radius: 3px;
      }
      pre {
         white-space: pre-wrap;
         word-wrap: break-word;
      }
      pre code {
         display: block;
         overflow-wrap: normal;
         word-wrap: normal;
         white-space: pre;
         font-size: 1.2em;
      }
      article {
         padding: 20px;
      }
      section {
         margin-top: 10px;
         margin-bottom: 10px;
      }
      amp-img {
         background-color: gray;
         border: 1px solid black;
      }
      .hljs {
         display: block;
         overflow-x: auto;
         padding: 0.5em;
         background: #474949;
         color: #d1d9e1;
      }
      .hljs-comment,
      .hljs-quote {
         color: #969896;
         font-style: italic;
      }
      .hljs-keyword,
      .hljs-selector-tag,
      .hljs-literal,
      .hljs-type,
      .hljs-addition {
         color: #cc99cc;
      }
      .hljs-number,
      .hljs-selector-attr,
      .hljs-selector-pseudo {
         color: #f99157;
      }
      .hljs-string,
      .hljs-doctag,
      .hljs-regexp {
         color: #8abeb7;
      }
      .hljs-title,
      .hljs-name,
      .hljs-section,
      .hljs-built_in {
         color: #b5bd68;
      }
      .hljs-variable,
      .hljs-template-variable,
      .hljs-selector-id,
      .hljs-class .hljs-title {
         color: #ffcc66;
      }
      .hljs-section,
      .hljs-name,
      .hljs-strong {
         font-weight: bold;
      }
      .hljs-symbol,
      .hljs-bullet,
      .hljs-subst,
      .hljs-meta,
      .hljs-link {
         color: #f99157;
      }
      .hljs-deletion {
         color: #dc322f;
      }
      .hljs-formula {
         background: #eee8d5;
      }
      .hljs-attr,
      .hljs-attribute {
         color: #81a2be;
      }
      .hljs-emphasis {
         font-style: italic;
      }
      ul.categories {
         padding-left: 0px;
         margin-bottom: 20px;
      }
      ul.categories li {
         list-style-type: none;
         display: inline-block;
         margin-right: 20px;
      }
      ul.categories li a {
         background-color: #303030;
         border-radius: 3px;
         padding: 3px;
         color: #fff;
         text-decoration: none;
      }
      a.commentlink, a.postlink {
         background-color: #303030;
         border-radius: 3px;
         padding: 3px;
         color: #fff;
         text-decoration: none;
      }
      blockquote {
         font-style: italic;
         border-left: 2px solid #cfcfcf;
      }
      blockquote p {
         font-size: 2.2em;
      }</style><script async src="https://cdn.ampproject.org/v0.js"></script><script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script></head><body><header><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></header><div class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">3rd January 2014 12:57 pm</p><h1>Django Blog Tutorial - the Next Generation - Part 3</h1><p>Hello again! In this instalment, we’re going to do the following:</p><ul><li>Add support for flat pages</li><li>Add support for multiple authors</li><li>Add a third-party comment system</li></ul><h2 id="flat-pages">Flat pages</h2><p>Django ships with a number of useful apps - we’ve already used the admin interface. The flat pages app is another very handy app that comes with Django, and we’ll use it to allow the blog author to create a handful of flat pages.</p><p>First of all, you’ll need to install the flatpages app. Edit the <code>INSTALLED_APPS</code> setting as follows:</p><pre><code class="lang-python">INSTALLED_APPS = (
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;south&#39;,
    &#39;blogengine&#39;,
    &#39;django.contrib.sites&#39;,
    &#39;django.contrib.flatpages&#39;,
)
</code></pre><p>Note that we needed to enable the <code>sites</code> framework as well. You’ll also need to set the <code>SITE_ID</code> setting:</p><pre><code class="lang-python">SITE_ID = 1
</code></pre><p>With that done, run <code>python manage.py syncdb</code> to create the required database tables. Now, let’s use the <code>sqlall</code> command to take a look at the database structure generated for the flat pages:</p><pre><code class="lang-sql">BEGIN;
CREATE TABLE &quot;django_flatpage_sites&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;flatpage_id&quot; integer NOT NULL,
    &quot;site_id&quot; integer NOT NULL REFERENCES &quot;django_site&quot; (&quot;id&quot;),
    UNIQUE (&quot;flatpage_id&quot;, &quot;site_id&quot;)
)
;
CREATE TABLE &quot;django_flatpage&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;url&quot; varchar(100) NOT NULL,
    &quot;title&quot; varchar(200) NOT NULL,
    &quot;content&quot; text NOT NULL,
    &quot;enable_comments&quot; bool NOT NULL,
    &quot;template_name&quot; varchar(70) NOT NULL,
    &quot;registration_required&quot; bool NOT NULL
)
;
CREATE INDEX &quot;django_flatpage_sites_872c4601&quot; ON &quot;django_flatpage_sites&quot; (&quot;flatpage_id&quot;);
CREATE INDEX &quot;django_flatpage_sites_99732b5c&quot; ON &quot;django_flatpage_sites&quot; (&quot;site_id&quot;);
CREATE INDEX &quot;django_flatpage_c379dc61&quot; ON &quot;django_flatpage&quot; (&quot;url&quot;);

COMMIT;
</code></pre><p>As mentioned previously, all models in Django have an <code>id</code> attribute by default. Each flat page also has a URL, title, and content.</p><p>Also note the separate <code>django_flatpage_sites</code> table, which maps sites to flat pages. Django can run multiple sites from the same web app, and so flat pages must be allocated to a specific site. This relationship is a many-to-many relationship, so one flat page can appear on more than one site.</p><p>The other fields <a href="http://127.0.0.1:8000/admin/flatpages/flatpage/add/">are hidden by default in the admin</a> and can be ignored. Let’s have a go with Django’s handy shell to explore the flatpage. Run <code>python manage.py shell</code> and you’ll be able to interact with your Django application interactively:</p><pre><code class="lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py shell
Python 2.7.6 (default, Nov 23 2013, 13:53:45)
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
(InteractiveConsole)
&gt;&gt;&gt; from django.contrib.flatpages.models import *
&gt;&gt;&gt; FlatPage
&lt;class &#39;django.contrib.flatpages.models.FlatPage&#39;&gt;
&gt;&gt;&gt; from django.contrib.sites.models import Site
&gt;&gt;&gt; Site.objects.all()
[&lt;Site: example.com&gt;]
</code></pre><p>As you can see, <code>flatpages</code> is a Django app similar to the <code>blogengine</code> one, with its own models, as is <code>sites</code>. You can see that the <code>FlatPage</code> class is a model. We can create an instance of it and save it interactively:</p><pre><code class="lang-python">&gt;&gt;&gt; f = FlatPage()
&gt;&gt;&gt; f.url = &#39;/about/&#39;
&gt;&gt;&gt; f.title = &#39;About me&#39;
&gt;&gt;&gt; f.content = &#39;All about me&#39;
&gt;&gt;&gt; f.save()
&gt;&gt;&gt; f.sites.add(Site.objects.all()[0])
&gt;&gt;&gt; f.save()
</code></pre><p>Note that because the relationship between the site and the flat page is a many-to-many relationship, we need to save it first, then use the <code>add</code> method to add the site to the list of sites.</p><p>We can retrieve it:</p><pre><code class="lang-python">&gt;&gt;&gt; FlatPage.objects.all()
[&lt;FlatPage: /about/ -- About me&gt;]
&gt;&gt;&gt; FlatPage.objects.all()[0]
&lt;FlatPage: /about/ -- About me&gt;
&gt;&gt;&gt; FlatPage.objects.all()[0].title
u&#39;About me&#39;
</code></pre><p>This command is often handy for debugging problems with your models interactively. If you now run the server and visit the admin, you should notice that the Flatpages app is now visible there, and the ‘About me’ flat page is now shown in there.</p><p>Let’s also take a look at the SQL required for the <code>Site</code> model. Run <code>python manage.py sqlall sites</code>:</p><pre><code class="lang-sql">BEGIN;
CREATE TABLE &quot;django_site&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;domain&quot; varchar(100) NOT NULL,
    &quot;name&quot; varchar(50) NOT NULL
)
;

COMMIT;
</code></pre><p>Again, very simple - just a domain and a name.</p><p>So, now that we have a good idea of how the flat page system works, we can write a test for it. We don’t need to write unit tests for the model because Django already does that, but we do need to write an acceptance test to ensure we can create flat pages and they will be where we expect them to be. Add the following to the top of the test file:</p><pre><code class="lang-python">from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
</code></pre><p>Now, before we write this test, there’s some duplication to resolve. We have two tests that subclass <code>LiveServerTestCase</code>, and both have the same method, <code>setUp</code>. We can save ourselves some hassle by creating a new class containing this method and having both these tests inherit from it. We’ll do that now because the flat page test can also be based on it. Create the following class just after <code>PostTest</code>:</p><pre><code class="lang-python">class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()
</code></pre><p>Then remove the setUp method from each of the two tests based on <code>LiveServerTestCase</code>, and change their parent class to <code>BaseAcceptanceTest</code>:</p><pre><code class="lang-python">class AdminTest(BaseAcceptanceTest):

class PostViewTest(BaseAcceptanceTest):
</code></pre><p>With that done, run the tests and they should pass. Commit your changes:</p><pre><code class="lang-bash">$ git add blogengine/tests.py django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Added flatpages to installed apps&#39;
</code></pre><p>Now we can get started in earnest on our test for the flat pages:</p><pre><code class="lang-python">class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):
        # Create flat page
        page = FlatPage()
        page.url = &#39;/about/&#39;
        page.title = &#39;About me&#39;
        page.content = &#39;All about me&#39;
        page.save()

        # Add the site
        page.sites.add(Site.objects.all()[0])
        page.save()

        # Check new page saved
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), 1)
        only_page = all_pages[0]
        self.assertEquals(only_page, page)

        # Check data correct
        self.assertEquals(only_page.url, &#39;/about/&#39;)
        self.assertEquals(only_page.title, &#39;About me&#39;)
        self.assertEquals(only_page.content, &#39;All about me&#39;)

        # Get URL
        page_url = only_page.get_absolute_url()

        # Get the page
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, 200)

        # Check title and content in response
        self.assertTrue(&#39;About me&#39; in response.content)
        self.assertTrue(&#39;All about me&#39; in response.content)
</code></pre><p>Let’s run our tests:</p><pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
......F..
======================================================================
FAIL: test_create_flat_page (blogengine.tests.FlatPageViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 272, in test_create_flat_page
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 9 tests in 2.760s

FAILED (failures=1)
</code></pre><p>We can see why it’s failed - in our flat page test, the status code is 404, indicating the page was not found. This just means we haven’t put flat page support into our URLconf. So let’s fix that:</p><pre><code class="lang-python">from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns(&#39;&#39;,
    # Examples:
    # url(r&#39;^$&#39;, &#39;django_tutorial_blog_ng.views.home&#39;, name=&#39;home&#39;),
    # url(r&#39;^blog/&#39;, include(&#39;blog.urls&#39;)),

    url(r&#39;^admin/&#39;, include(admin.site.urls)),

    # Blog URLs
    url(r&#39;&#39;, include(&#39;blogengine.urls&#39;)),

    # Flat pages
    url(r&#39;&#39;, include(&#39;django.contrib.flatpages.urls&#39;)),
)
</code></pre><p>Let’s run our tests again:</p><pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
......E..
======================================================================
ERROR: test_create_flat_page (blogengine.tests.FlatPageViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 276, in test_create_flat_page
    response = self.client.get(page_url)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py&quot;, line 473, in get
    response = super(Client, self).get(path, data=data, **extra)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py&quot;, line 280, in get
    return self.request(**r)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py&quot;, line 444, in request
    six.reraise(*exc_info)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/handlers/base.py&quot;, line 114, in get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/flatpages/views.py&quot;, line 45, in flatpage
    return render_flatpage(request, f)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/decorators.py&quot;, line 99, in _wrapped_view
    response = view_func(request, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/flatpages/views.py&quot;, line 60, in render_flatpage
    t = loader.get_template(DEFAULT_TEMPLATE)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/template/loader.py&quot;, line 138, in get_template
    template, origin = find_template(template_name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/template/loader.py&quot;, line 131, in find_template
    raise TemplateDoesNotExist(name)
TemplateDoesNotExist: flatpages/default.html

----------------------------------------------------------------------
Ran 9 tests in 3.557s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre><p>Our test still fails, but we can easily see why - the template <code>flatpages/default.html</code> doesn’t exist. So we create it:</p><pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ flatpage.title }}&lt;/h1&gt;
        {{ flatpage.content|custom_markdown }}
        &lt;/div&gt;

    {% endblock %}
</code></pre><p>This template is based on the blog post one, and just changes a handful of variable names. Note that it can still inherit from the blogengine base template, and in this case we’re using that for the sake of consistency.</p><p>If you run your tests, you should now see that they pass, so we’ll commit our changes:</p><pre><code class="lang-bash">$ git add templates/ django_tutorial_blog_ng/ blogengine/
$ git commit -m &#39;Implemented flat page support&#39;
</code></pre><h2 id="multiple-authors">Multiple authors</h2><p>Next we’ll add support for multiple authors. Now, Django already has a User model, and we’ll leverage that to represent the authors. But first we’ll write our test:</p><pre><code class="lang-python">from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
from django.contrib.auth.models import User
import markdown

# Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, &#39;testuser&#39;)
        self.assertEquals(only_post.author.email, &#39;user@example.com&#39;)

class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()


class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)

class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)


class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):
        # Create flat page
        page = FlatPage()
        page.url = &#39;/about/&#39;
        page.title = &#39;About me&#39;
        page.content = &#39;All about me&#39;
        page.save()

        # Add the site
        page.sites.add(Site.objects.all()[0])
        page.save()

        # Check new page saved
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), 1)
        only_page = all_pages[0]
        self.assertEquals(only_page, page)

        # Check data correct
        self.assertEquals(only_page.url, &#39;/about/&#39;)
        self.assertEquals(only_page.title, &#39;About me&#39;)
        self.assertEquals(only_page.content, &#39;All about me&#39;)

        # Get URL
        page_url = str(only_page.get_absolute_url())

        # Get the page
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, 200)

        # Check title and content in response
        self.assertTrue(&#39;About me&#39; in response.content)
        self.assertTrue(&#39;All about me&#39; in response.content)
</code></pre><p>Here we create a <code>User</code> object to represent the author. Note the <code>create_user</code> convenience method for creating new users quickly and easily.</p><p>We’re going to exclude the author field from the admin - instead it’s going to be automatically populated based on the session data, so that when a user creates a post they are automatically set as the author. We therefore don’t need to make any changes for the acceptance tests for posts - our changes to the unit tests for the <code>Post</code> model are sufficient.</p><p>Run the tests, and they should fail:</p><pre><code class="lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
E........
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 45, in test_create_post
    self.assertEquals(only_post.author.username, &#39;testuser&#39;)
AttributeError: &#39;Post&#39; object has no attribute &#39;author&#39;

----------------------------------------------------------------------
Ran 9 tests in 3.620s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre><p>Let’s add the missing <code>author</code> attribute:</p><pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre><p>Next, create the migrations:</p><pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
</code></pre><p>You’ll be prompted to either quit or provide a default author ID - select option 2 to provide the ID, then enter 1, which should be your own user account ID. Then run the migrations:</p><pre><code class="lang-bash">$ python manage.py migrate
</code></pre><p>Let’s run our tests again:</p><pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.F.F.....
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 118, in test_create_post
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 154, in test_edit_post
    self.assertTrue(&#39;changed successfully&#39; in response.content)
AssertionError: False is not true

----------------------------------------------------------------------
Ran 9 tests in 3.390s

FAILED (failures=2)
Destroying test database for alias &#39;default&#39;...
</code></pre><p>Our test still fails because the author field isn’t set automatically. So we’ll amend the admin to automatically set the author when the <code>Post</code> object is saved:</p><pre><code class="lang-python">import models
from django.contrib import admin
from django.contrib.auth.models import User

class PostAdmin(admin.ModelAdmin):
    prepopulated_fields = {&quot;slug&quot;: (&quot;title&quot;,)}
    exclude = (&#39;author&#39;,)

    def save_model(self, request, obj, form, change):
        obj.author = request.user
        obj.save()

admin.site.register(models.Post, PostAdmin)
</code></pre><p>This tells the admin to exclude the <code>author</code> field from any form for a post, and when the model is saved, to set the author to the user making the HTTP request. Now run the tests, and they should pass:</p><pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.........
----------------------------------------------------------------------
Ran 9 tests in 4.086s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre><p>Time to commit again:</p><pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Added author field&#39;
</code></pre><h2 id="comments">Comments</h2><p>The <a href="http://matthewdaly.co.uk/blog/2012/03/29/yet-another-tutorial-for-building-a-blog-using-python-and-django-part-4/">previous version of this tutorial</a> implemented comments using Django’s own comment system. However, this has since been deprecated from Django and turned into <a href="https://github.com/django/django-contrib-comments">a separate project</a>. So we have two options for how to implement comments:</p><ul><li>We can use <a href="http://django-contrib-comments.readthedocs.org/en/latest/">the comments system</a></li><li>We can use a third-party comments system</li></ul><p>Now, if you want to use the Django comment system, you can do so, and it shouldn’t be too hard to puzzle out how to implement it using the documentation and my prior post. However, in my humble opinion, using a third-party comment system is the way to go for blog comments - they make it extremely easy for people to log in with multiple services without you having to write lots of additional code. They also make it significantly easier to moderate comments, and they’re generally pretty good at handling comment spam.</p><p>Some of the available providers include:</p><ul><li><a href="http://disqus.com/">Disqus</a></li><li><a href="http://intensedebate.com/">IntenseDebate</a></li><li><a href="https://developers.facebook.com/docs/plugins/comments/">Facebook</a></li></ul><p>For demonstration purposes, we’ll use Facebook comments, but this shouldn’t require much work to adapt it to the other providers.</p><p>First of all, we need to include the Facebook JavaScript SDK:</p><pre><code class="lang-django">        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;navbar-inner&quot;&gt;
                &lt;div class=&quot;container&quot;&gt;
                    &lt;a class=&quot;btn btn-navbar&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.nav-collapse&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/a&gt;
                    &lt;a class=&quot;brand&quot; href=&quot;/&quot;&gt;My Django Blog&lt;/a&gt;
                    &lt;div class=&quot;nav-collapse collapse&quot;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
</code></pre><p>Now, the Facebook comment system requires that you pass through the absolute page URL when initialising the comments. At present we can’t do that without hard-coding the domain name in our template, which we want to avoid. So, we need to add a site field to each post to identify the site it’s associated with.</p><p>As usual, we update our tests first:</p><pre><code class="lang-python">from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
from django.contrib.auth.models import User
import markdown

# Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.site.name, &#39;example.com&#39;)
        self.assertEquals(only_post.site.domain, &#39;example.com&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, &#39;testuser&#39;)
        self.assertEquals(only_post.author.email, &#39;user@example.com&#39;)

class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()


class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;,
            &#39;site&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.site = site
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)

class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)


class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):
        # Create flat page
        page = FlatPage()
        page.url = &#39;/about/&#39;
        page.title = &#39;About me&#39;
        page.content = &#39;All about me&#39;
        page.save()

        # Add the site
        page.sites.add(Site.objects.all()[0])
        page.save()

        # Check new page saved
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), 1)
        only_page = all_pages[0]
        self.assertEquals(only_page, page)

        # Check data correct
        self.assertEquals(only_page.url, &#39;/about/&#39;)
        self.assertEquals(only_page.title, &#39;About me&#39;)
        self.assertEquals(only_page.content, &#39;All about me&#39;)

        # Get URL
        page_url = str(only_page.get_absolute_url())

        # Get the page
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, 200)

        # Check title and content in response
        self.assertTrue(&#39;About me&#39; in response.content)
        self.assertTrue(&#39;All about me&#39; in response.content)
</code></pre><p>All we’ve done here is to add the <code>site</code> attribute when creating a new post using the Django database API, and when we create one via the admin, we add an additional <code>site</code> aparameter to the HTTP POST request with a value of 1. Run the tests and they should fail:</p><pre><code class="lang-bash">Creating test database for alias &#39;default&#39;...
E........
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 46, in test_create_post
    self.assertEquals(only_post.site.name, &#39;example.com&#39;)
AttributeError: &#39;Post&#39; object has no attribute &#39;site&#39;

----------------------------------------------------------------------
Ran 9 tests in 4.313s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre><p>So we need to add the <code>site</code> attribute to the <code>Post</code> model. Let’s do that:</p><pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User
from django.contrib.sites.models import Site

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre><p>Now create and run the migrations - you’ll be prompted to create a default value for the site attribute as well:</p><pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py schemamigration --auto blogengine
 ? The field &#39;Post.site&#39; does not have a default specified, yet is NOT NULL.
 ? Since you are adding this field, you MUST specify a default
 ? value to use for existing rows. Would you like to:
 ?  1. Quit now, and add a default to the field in models.py
 ?  2. Specify a one-off value to use for existing columns now
 ? Please select a choice: 2
 ? Please enter Python code for your one-off default value.
 ? The datetime module is available, so you can do e.g. datetime.date.today()
 &gt;&gt;&gt; 1
 + Added field site on blogengine.Post
Created 0005_auto__add_field_post_site.py. You can now apply this migration with: ./manage.py migrate blogengine
(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py migrate
Running migrations for blogengine:
 - Migrating forwards to 0005_auto__add_field_post_site.
 &gt; blogengine:0005_auto__add_field_post_site
 - Loading initial data for blogengine.
Installed 0 object(s) from 0 fixture(s)
</code></pre><p>Our tests should then pass:</p><pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.........
----------------------------------------------------------------------
Ran 9 tests in 4.261s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre><p>Now we can include our full page URL on the post detail page:</p><pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ object.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ object.pub_date }}&lt;/h3&gt;
        {{ object.text|custom_markdown }}

        &lt;h4&gt;Comments&lt;/h4&gt;
        &lt;div class=&quot;fb-comments&quot; data-href=&quot;http://{{ post.site }}{{ post.get_absolute_url }}&quot; data-width=&quot;470&quot; data-num-posts=&quot;10&quot;&gt;&lt;/div&gt;

        &lt;/div&gt;

    {% endblock %}
</code></pre><p>If you want to customise the comments, take a look at <a href="https://developers.facebook.com/docs/plugins/comments/">the documentation for Facebook Comments</a>.</p><p>With that done, we can commit our changes:</p><pre><code class="lang-bash">$ git add blogengine/ templates/
$ git commit -m &#39;Implemented Facebook comments&#39;
</code></pre><p>And that wraps up this lesson. As usual, you can easily switch to today’s lesson with <code>git checkout lesson-3</code>. Next time we’ll implement categories and tags, and create an RSS feed for our blog posts.</p><section><ul class="categories"><li><a href="/blog/categories/python/">python</a></li><li><a href="/blog/categories/django/">django</a></li><li><a href="/blog/categories/tdd/">tdd</a></li><li><a href="/blog/categories/django-blog-tutorial/">django-blog-tutorial</a></li></ul></section><section><a class="commentlink" href="https://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/">View the article with comments</a></section><section><a class="postlink" href="/blog/2014/01/25/my-first-yeoman-generator/amp/">My First Yeoman Generator</a> <a class="postlink" href="/blog/2014/01/02/django-blog-tutorial-the-next-generation-part-2/amp/">Django Blog Tutorial - the Next Generation - Part 2</a></section></article></div></div></div><amp-analytics type="googleanalytics" id="analytics1"><script type="application/json">{
					"vars": {
						"account": "UA-17043630-1"
					},
					"triggers": {
						"trackPageview": {
							"on": "visible",
							"request": "pageview"
						}
					}
				}</script></amp-analytics></body></html>