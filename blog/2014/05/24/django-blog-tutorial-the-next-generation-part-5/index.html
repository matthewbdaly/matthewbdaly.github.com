<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Oxfordshire. This is my blog..."><meta name="keywords" content="python,django,tdd,django-blog-tutorial"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2014/05/24/django-blog-tutorial-the-next-generation-part-5/amp/"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2014/05/24/django-blog-tutorial-the-next-generation-part-5/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Django Blog Tutorial - the Next Generation - Part 5 - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Oxfordshire. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">24th May 2014 8:15 pm</p><h1>Django Blog Tutorial - the Next Generation - Part 5</h1><p>Hello again! I was originally planning to cover implementing a search system, adding more feeds, and tidying up the front end in this instalment. However, I felt it was time for a change of pace, so instead, we’re going to look at:</p><ul><li>Checking code coverage and getting it to 100%</li><li>Using continuous integration</li><li>Deploying to Heroku</li></ul><p>Don’t worry, the original lesson isn’t going anywhere. We’ll still be implementing all of that later on, but today is the day we get your Django blog up and running on the web. That way, you can get a better idea of how Django works in the wild, and you have something concrete to show for your efforts.</p><h1 id="continuous-integration">Continuous integration</h1><p>If you’re not familiar with continuous integration, it’s basically a process that carries out some tasks automatically when you push a new commit to the repository. These tasks may include running unit tests, linting your code, and checking it to see what percentage of the code base is covered by the tests (after all, if your tests don’t actually cover every scenario, then there’s more of a chance that something might slip through the net. It’s also possible to implement hooks to automatically deploy your application only if the tests pass.</p><p>Typically, you will have a continuous integration server running somewhere that regularly polls your Git repository for changes, and when it finds a new commit, will check it out and run the tests (or whatever other task you configure it to). One of the most popular continuous integration servers around is <a href="http://jenkins-ci.org/">Jenkins</a> - I use it at work and can highly recommend it. However, we aren’t going to cover using Jenkins here because setting it up is quite a big deal and it really is best kept on a server of its own (although feel free to use it if you prefer). Instead, we’re going to use <a href="https://travis-ci.org/">Travis CI</a>, which integrates nicely with GitHub and is free for open source projects. If you don’t mind your code being publicly available on GitHub, then Travis is a really great way to dip your toe into continuous integration.</p><p>NB: You don’t have to use continuous integration at all if you don’t want to - this isn’t a big project so you don’t really need it. If you don’t want to put your code on GitHub, then feel free to just follow along and not bother pushing your code to GitHub and configuring Travis.</p><h1 id="code-coverage">Code coverage</h1><p>As mentioned above, code coverage is a measure of the percentage of the code that is covered by tests. While not infallible, it’s a fairly good guide to how comprehensive your tests are. If you have 100% code coverage, you can be fairly confident that your tests are comprehensive enough to catch most errors, so it’s a good rule of thumb to aim for 100% test coverage on a project.</p><p>So how do we check our test coverage? The <code>coverage</code> Python module is the most common tool for this. There’s also a handy Django module called <code>django-jenkins</code>, which is designed to work with Jenkins, but can be used with any continuous integration server, that can not only run your tests, but also check code coverage at the same time. So, make sure your virtualenv is up and running:</p><pre><code class="hljs lang-bash singleline">$ <span class="hljs-built_in">source</span> venv/bin/activate</code></pre><p>Then, run the following command:</p><pre><code class="hljs lang-bash singleline">$ pip install coverage django-jenkins</code></pre><p>Once that’s done, add these to our requirements file:</p><pre><code class="hljs lang-bash singleline">$ pip freeze &gt; requirements.txt</code></pre><p>We now need to configure our Django project to use <code>django-jenkins</code>. Add the following to the bottom of the settings file:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>INSTALLED_APPS += (<span class="hljs-string">'django_jenkins'</span>,)</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>JENKINS_TASKS = (</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'django_jenkins.tasks.run_pylint'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'django_jenkins.tasks.with_coverage'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>PROJECT_APPS = [<span class="hljs-string">'blogengine'</span>]</td></tr></table></code></pre><p>This adds <code>django-jenkins</code> to our installed apps and tells it to include two additional tasks, besides running the tests. The first task runs Pylint to check our code quality (but we aren’t really concerned about that at this point). The second checks the coverage. Finally, we tell <code>django-jenkins</code> that the <code>blogengine</code> app is the only one to be tested.</p><p>You’ll also want to add the following lines to your <code>.gitignore</code>:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>reports/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>htmlcov/</td></tr></table></code></pre><p>These are the reports generated by <code>django-jenkins</code>, and should not be kept under version control. With that done, it’s time to commit:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add .gitignore django_tutorial_blog_ng/ requirements.txt</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Added coverage checking using django-jenkins'</span></td></tr></table></code></pre><p>Now, let’s run our tests. From now on, you’ll use the following command to run your tests:</p><pre><code class="hljs lang-bash singleline">$ python manage.py jenkins</code></pre><p>This ensures we check the coverage at the same time. Now, you’ll notice that the <code>reports</code> folder has been created, and it will contain three files, including one called <code>coverage.xml</code>. However, XML isn’t a very friendly format. Happily, we can easily generate reports in HTML instead:</p><pre><code class="hljs lang-bash singleline">$ python manage.py jenkins --coverage-html-report=htmlcov</code></pre><p>Running this command will create another folder called <code>htmlcov/</code>, and in here you will find your report, nicely formatted as HTML. Open up <code>index.html</code> in your web browser and you should see a file-by-file breakdown of your code coverage. Nice, huh?</p><p>Now, if your code so far is largely identical to mine, you’ll notice that the model and view files don’t have 100% coverage yet. If you click on each one, you’ll see a handy line-by-line breakdown of the test coverage for each file. You’ll notice that in the views file, the areas of the code for when tags and categories don’t exist are highlighted in pink - this tells you that these lines of code are never executed during the tests. So let’s fix that.</p><p>First, our template needs to be able to handle empty lists.</p><pre><code class="hljs lang-django"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="xml"></span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">extends</span></span> "blogengine/includes/base.html" %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">load</span></span> custom_markdown %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">block</span></span> content %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> object_list %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> post <span class="hljs-keyword">in</span> object_list %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post"</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ post.get_absolute_url }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span></span><span class="hljs-template-variable">{{ post.title }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span><span class="hljs-template-variable">{{ post.pub_date }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-template-variable">{{ post.text|custom_markdown }}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ post.category.get_absolute_url }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span></span><span class="hljs-template-variable">{{ post.category.name }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> tag <span class="hljs-keyword">in</span> post.tags.all %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span><span class="hljs-template-variable">{{ tag.get_absolute_url }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span></span><span class="hljs-template-variable">{{ tag.name }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">else</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>No posts found<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> page_obj.has_previous %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/</span></span><span class="hljs-template-variable">{{ page_obj.previous_page_number }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">/"</span>&gt;</span>Previous Page<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> page_obj.has_next %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/</span></span><span class="hljs-template-variable">{{ page_obj.next_page_number }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">/"</span>&gt;</span>Next Page<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml"></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %}</span><span class="xml"></span></td></tr></table></code></pre><p>Let’s commit the changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add templates/blogengine/post_list.html</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Added a "No posts found" message to post list template'</span></td></tr></table></code></pre><p>Next, we need to write tests to check that we get a “No posts found” message when we view a tag or category that does not exist. Add the following methods to the class <code>PostViewTest()</code>:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_nonexistent_category_page</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        category_url = <span class="hljs-string">'/category/blah/'</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        response = self.client.get(category_url)</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        self.assertTrue(<span class="hljs-string">'No posts found'</span> <span class="hljs-keyword">in</span> response.content)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_nonexistent_tag_page</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        tag_url = <span class="hljs-string">'/tag/blah/'</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        response = self.client.get(tag_url)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        self.assertTrue(<span class="hljs-string">'No posts found'</span> <span class="hljs-keyword">in</span> response.content)</td></tr></table></code></pre><p>Now, let’s run our tests again:</p><pre><code class="hljs lang-bash singleline">$ python manage.py jenkins --coverage-html-report=htmlcov</code></pre><p>Assuming they all pass as expected, then your coverage reports will be regenerated. If you reload the coverage report, you should see that your views now have 100% test coverage. Let’s commit again:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add blogengine/tests.py</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Views file now has 100% coverage'</span></td></tr></table></code></pre><p>Now, our models still don’t have 100% coverage yet. If you look at the breakdown for <code>models.py</code>, you’ll see that the line <code>if not self.slug:</code> has only partial coverage, because we missed out setting a slug for the categories and tags in our test. So, let’s fix that. In <code>PostTest()</code>, amend the <code>test_create_category()</code> and <code>test_create_tag()</code> methods as follows:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_category</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-comment"># Create the category</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        category = Category()</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-comment"># Add attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        category.name = <span class="hljs-string">'python'</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        category.description = <span class="hljs-string">'The Python programming language'</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        category.slug = <span class="hljs-string">'python'</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-comment"># Save it</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        category.save()</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        all_categories = Category.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        self.assertEquals(len(all_categories), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        only_category = all_categories[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        self.assertEquals(only_category, category)</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        self.assertEquals(only_category.name, <span class="hljs-string">'python'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        self.assertEquals(only_category.description, <span class="hljs-string">'The Python programming language'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        self.assertEquals(only_category.slug, <span class="hljs-string">'python'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_tag</span><span class="hljs-params">(self)</span>:</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-comment"># Create the tag</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        tag = Tag()</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        <span class="hljs-comment"># Add attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        tag.name = <span class="hljs-string">'python'</span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        tag.description = <span class="hljs-string">'The Python programming language'</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        tag.slug = <span class="hljs-string">'python'</span></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-comment"># Save it</span></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        tag.save()</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-comment"># Check we can find it</span></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        all_tags = Tag.objects.all()</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        self.assertEquals(len(all_tags), <span class="hljs-number">1</span>)</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        only_tag = all_tags[<span class="hljs-number">0</span>]</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        self.assertEquals(only_tag, tag)</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment"># Check attributes</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        self.assertEquals(only_tag.name, <span class="hljs-string">'python'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        self.assertEquals(only_tag.description, <span class="hljs-string">'The Python programming language'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        self.assertEquals(only_tag.slug, <span class="hljs-string">'python'</span>)</td></tr></table></code></pre><p>Run the tests again:</p><pre><code class="hljs lang-bash singleline">$ python manage.py jenkins --coverage-html-report=htmlcov</code></pre><p>Then refresh your coverage page, and we should have hit 100% coverage. Excellent news! This means that we can be confident that if any problems get introduced in future, we can pick them up easily. To demonstrate this, let’s upgrade our Django install to the latest version and check everything still works as expected:</p><pre><code class="hljs lang-bash singleline">$ pip install Django --upgrade</code></pre><p>This will upgrade the copy of Django in our virtualenv to the latest version. Then we can run our tests again:</p><pre><code class="hljs lang-bash singleline">$ python manage.py jenkins --coverage-html-report=htmlcov</code></pre><p>Our tests should still pass, indicating that the upgrade to our Django version does not appear to have broken any functionality. Let’s update our <code>requirements.txt</code>:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ pip freeze &gt; requirements.txt</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git add requirements.txt</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$ git commit -m <span class="hljs-string">'Upgraded Django version'</span></td></tr></table></code></pre><h1 id="preparing-our-web-app-for-deployment-to-heroku">Preparing our web app for deployment to Heroku</h1><p>As mentioned previously, I’m going to assume you plan to deploy your site on <a href="https://www.heroku.com/">Heroku</a>. It has good Django support, and you can quite happily host a blog there using their free tariff. If you’d prefer to use another hosting provider, then you should be able to adapt these instructions accordingly.</p><p>Now, so far we’ve used SQLite as our database for development purposes. However, SQLite isn’t really suitable for production purposes. Heroku provide a Postgresql database for each web app, so we will use that. To configure it, open up <code>settings.py</code> and amend the database configuration section to look like this:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>DATABASES = {</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-string">'default'</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'ENGINE'</span>: <span class="hljs-string">'django.db.backends.'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-string">'NAME'</span>: <span class="hljs-string">''</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>}</td></tr></table></code></pre><p>Then, add the following at the end of the file:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-comment"># Heroku config</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-comment"># Parse database configuration from $DATABASE_URL</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">import</span> dj_database_url</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>DATABASES[<span class="hljs-string">'default'</span>] =  dj_database_url.config(default=<span class="hljs-string">"sqlite:///db.sqlite3"</span>)</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-comment"># Honor the 'X-Forwarded-Proto' header for request.is_secure()</span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>SECURE_PROXY_SSL_HEADER = (<span class="hljs-string">'HTTP_X_FORWARDED_PROTO'</span>, <span class="hljs-string">'https'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-comment"># Allow all host headers</span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>ALLOWED_HOSTS = [<span class="hljs-string">'*'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-comment"># Static asset configuration</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>STATIC_ROOT = <span class="hljs-string">'staticfiles'</span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>STATICFILES_DIRS = (</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    os.path.join(BASE_DIR, <span class="hljs-string">'static'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>)</td></tr></table></code></pre><p>A little explanation is called for. Remember when we first started out, we installed the <code>django-toolbelt</code> package, which included <code>dj-database-url</code>? Well, here we use the <code>dj_database_url</code> module to get the database from an environment variable set on Heroku. We set a default value so as to fall back to SQLite when that variable is not set. The other settings are required by Heroku.</p><p>You may want to run your tests again to ensure everything is still working before committing:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add django_tutorial_blog_ng/settings.py</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Amended settings to work on desktop and Heroku'</span></td></tr></table></code></pre><h1 id="setting-up-continuous-integration-and-coverage">Setting up Continuous Integration and coverage</h1><p>Now, as mentioned previously, I’ll be demonstrating how to set up Travis CI for our project. Travis CI is only free for open-source projects, so if you don’t want to make your code publicly accessible, you may want to use Jenkins instead. I’ll leave setting that up and running it as an exercise for the reader, but I recommend a plugin called Cobertura which allows you to publish details of your code’s test coverage.</p><p>Unfortunately, Travis CI doesn’t have the capability to publish your coverage results. Fortunately, you can use <a href="https://coveralls.io/">Coveralls.io</a> to pick up the slack. Like Travis, it’s free for open-source projects, and if you host your code on GitHub, it’s pretty easy to use.</p><p>You can find instructions on setting up a project on Travis CI <a href="http://docs.travis-ci.com/user/getting-started/">here</a>. Once you’ve configured it, you’ll need to set up your <code>.travis.yml</code> file. This is a simple text file that tells Travis CI how to run your tests. Put the following content in the file:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">language</span>: <span class="hljs-keyword">python</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">python</span>:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>- <span class="hljs-string">"2.7"</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td># <span class="hljs-keyword">command</span> <span class="hljs-keyword">to</span> install dependencies</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>instal<span class="hljs-variable">l:</span> <span class="hljs-string">"pip install -r requirements.txt"</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td># <span class="hljs-keyword">command</span> <span class="hljs-keyword">to</span> run tests</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">scrip</span><span class="hljs-variable">t:</span> coverage run --include=<span class="hljs-string">"blogengine/*"</span> --omit=<span class="hljs-string">"blogengine/migrations/*"</span> manage.<span class="hljs-keyword">py</span> test blogengine</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>after_succes<span class="hljs-variable">s:</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    coveralls</td></tr></table></code></pre><p>Now, this tells Travis that this is a Python application, and we should be using Python 2.7. Please note you can test against multiple versions of Python if you wish - just add another line with the Python version you want to test against.</p><p>Then, we see that we use Pip to install our requirements. Finally we run our tests with Coverage, in order to generate coverage data, and afterwards call <code>coveralls</code> to pass the coverage data to Coveralls.io.</p><p>We also need to install the <code>coveralls</code> module:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ pip install coveralls</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ pip freeze &gt; requirements.txt</td></tr></table></code></pre><p>And we need to keep our coverage data out of version control:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>env/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>*.pyc</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>db.sqlite3</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>blogengine/static/bower_components/</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>reports/</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>htmlcov/</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>.coverage</td></tr></table></code></pre><p>You’ll also want to set up your project on Coveralls, as described <a href="https://coveralls.io/docs">here</a> - please note that this requires your project be in a public GitHub repository.</p><p>With that done, let’s commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add .gitignore .travis.yml requirements.txt</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Added Travis config file and Coveralls support'</span></td></tr></table></code></pre><p>With that done, assuming you have Travis CI and Coveralls configured, and your code is already hosted on GitHub, then you should be able to just push your code up to trigger the build:</p><pre><code class="hljs lang-bash singleline">$ git push origin master</code></pre><p>If you keep an eye on Travis in your browser, you can watch what happens as your tests are run. If for any reason the build fails, then it shouldn’t be too hard to figure out what has gone wrong using the documentation for Travis and Coveralls - both services are pretty easy to use.</p><p>Congratulations - you’re now using Continuous Integration! That wasn’t so hard, was it? Now, every time you push to GitHub, Travis will run your tests, and you’ll get an email if they fail, giving you early warning of any problems, and you can check your coverage at the same time. Both Travis and Coveralls offer badges that you can place in your README file on GitHub to show off your coverage and build status - feel free to add these to your repo.</p><p>You may want to try making a change that breaks your tests and committing it, then pushing it up, so that you can see what happens when the build breaks.</p><h1 id="deploying-to-heroku">Deploying to Heroku</h1><p>Our final task today is deploying our blog to Heroku so we can see it in action. First of all, if you don’t already have an account with Heroku, you’ll need to sign up <a href="https://www.heroku.com/">here</a>. You should also be prompted to install the Heroku toolbelt. Once that’s done, run the following command:</p><pre><code class="hljs lang-bash singleline">$ heroku login</code></pre><p>You’ll be prompted for your credentials - enter these and you should be able to log in successfully.</p><p>Now, in order to run our Django app on Heroku, we’ll need to add a <code>Procfile</code> to tell Heroku what command to run in order to start your app. In this case, we will be using Gunicorn as our web server. Assuming our project is called <code>django_tutorial_blog_ng</code>, this is what you need to put in this file:</p><pre><code class="hljs lang-bash singleline">web: gunicorn django_tutorial_blog_ng.wsgi</code></pre><p>That tells Heroku that the file we need to run for this application is <code>django_tutorial_blog_ng/wsgi.py</code>. To test it, run the following command:</p><pre><code class="hljs lang-bash singleline">$ foreman start</code></pre><p>That will start our web server on port 5000, using Gunicorn rather than the Django development server. You should be able to see it in action <a href="http://127.0.0.1:5000/">here</a>, but you’ll notice a very serious issue - namely that the static files aren’t being served. Now, Django has a command called <code>collectstatic</code> that collects all the static files and drops them into one convenient folder. Heroku will run this command automatically, so we need to ensure our static files are available. Amend your <code>.gitignore</code> file so it no longer excludes our static files:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>venv/</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>*.pyc</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>db.sqlite3</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>reports/</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>htmlcov/</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>.coverage</td></tr></table></code></pre><p>We also need to amend our wsgi.py to serve static files:</p><pre><code class="hljs lang-python"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">import</span> os</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>os.environ.setdefault(<span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span>, <span class="hljs-string">"django_tutorial_blog_ng.settings"</span>)</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">from</span> django.core.wsgi <span class="hljs-keyword">import</span> get_wsgi_application</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">from</span> dj_static <span class="hljs-keyword">import</span> Cling</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>application = Cling(get_wsgi_application())</td></tr></table></code></pre><p>This should solve our problem. Let’s commit our changes:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ git add django_tutorial_blog_ng/wsgi.py Procfile blogengine/static/ .gitignore</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ git commit -m <span class="hljs-string">'Configured app for deployment on Heroku'</span></td></tr></table></code></pre><p>Now we’re ready to deploy our app!</p><h1 id="deployment">Deployment</h1><p>Every Heroku app needs a unique name. If you don’t specify one, then Heroku will generate one for you. Your app will have the domain name <code>appname.herokuapp.com</code> - however, if you already have a domain name lined up for your blog, you can point that domain name at the Heroku app if you wish. I’m going to deploy mine with the name <code>blog-shellshocked-info</code>.</p><p>You also need to consider where you want to deploy it. Heroku has two regions - North America and EU. By default it will deploy to North America, but as I’m in the EU, that’s where I want to deploy my app to - obviously if you’re in the Americas, you may be better off sticking with North America.</p><p>So, let’s create our app. Here’s the command you need to run:</p><pre><code class="hljs lang-bash singleline">$ heroku apps:create blog-shellshocked-info --region eu</code></pre><p>You will want to change the app name, or remove it entirely if you’re happy for Heroku to generate one for you. If you want to host it in North America, drop the <code>--region eu</code> section.</p><p>Once completed, this will have created your new app, and added a Git remote for it, but will not have deployed it. To deploy your app, run this command:</p><pre><code class="hljs lang-bash singleline">$ git push heroku master</code></pre><p>That will push your code up to Heroku. Please note that building the app may take a little while. Once it’s done, you can run <code>heroku open</code> to open it in your web browser. You should see an error message stating that the relation <code>blogengine_post</code> does not exist. That’s because we need to create our database structure. Heroku allows you to easily run commands on your app with <code>heroku run</code>, so let’s create our database and run our migrations:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ heroku run python manage.py syncdb</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$ heroku run python manage.py migrate</td></tr></table></code></pre><p>These are exactly the same commands you would run locally to create your database, but prefaced with <code>heroku run</code> so that they get run by Heroku. As usual, you will be prompted to create a superuser - you’ll want to do this so you can log into the admin.</p><p>That’s all for today! We’ve finally got our site up and running on Heroku, and set up continuous integration so our tests will get run for us. You can see an example of the site working <a href="http://blog.shellshocked.info/">here</a>. As usual, you can check out the latest version of the code with <code>git checkout lesson-5</code>. If you’d like a homework assignment, then take a look at <a href="http://docs.travis-ci.com/user/deployment/heroku/">automating deployment to Heroku on successful builds</a> and see if you can get it set up successfully.</p><p>Next time around, we’ll get back to implementing our search and tidying up the front end. See you then!</p><ul class="categorylist"><li><a href="/blog/categories/python/">python</a></li><li><a href="/blog/categories/django/">django</a></li><li><a href="/blog/categories/tdd/">tdd</a></li><li><a href="/blog/categories/django-blog-tutorial/">django-blog-tutorial</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2014/05/24/django-blog-tutorial-the-next-generation-part-5/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2014/05/24/django-blog-tutorial-the-next-generation-part-5/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2017/10/29/an-azure-filesystem-integration-for-laravel/">An Azure Filesystem Integration for Laravel</a></p><p><a href="/blog/2017/10/20/using-phpiredis-with-laravel/">Using Phpiredis With Laravel</a></p><p><a href="/blog/2017/10/03/simple-fuzzy-search-with-laravel-and-postgresql/">Simple Fuzzy Search With Laravel and Postgresql</a></p><p><a href="/blog/2017/09/25/a-generic-php-sms-library/">A Generic PHP SMS Library</a></p><p><a href="/blog/2017/09/08/installing-nginx-unit-on-ubuntu/">Installing Nginx Unit on Ubuntu</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/blog/2014/02/15/django-blog-tutorial-the-next-generation-part-4/"><span class="glyphicon glyphicon-chevron-left"></span> Django Blog Tutorial - the Next Generation - Part 4</a></li><li><a href="/blog/2014/05/25/django-blog-tutorial-the-next-generation-part-6/">Django Blog Tutorial - the Next Generation - Part 6 <span class="glyphicon glyphicon-chevron-right"></span></a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2017.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>