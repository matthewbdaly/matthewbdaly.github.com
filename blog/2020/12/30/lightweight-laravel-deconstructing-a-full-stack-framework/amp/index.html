<!doctype html><html amp lang="en"><head><meta charset="utf-8"><title>Lightweight Laravel - Deconstructing a Full Stack Framework - Matthew Daly&#x27;s Blog</title><link rel="canonical" href="https://matthewdaly.co.uk/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link href="/favicon.ico" rel="icon"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#252525"><script type="application/ld+json">{
         "@context": "http://schema.org",
         "@type": "BlogPosting",
         "mainEntityOfPage": "https://matthewdaly.co.uk/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/",
         "headline": "Lightweight Laravel - Deconstructing a Full Stack Framework",
         "datePublished": "2020-12-30T17:00:00.000Z",
         "dateModified": "2020-12-30T17:00:00.000Z",
         "description": "&lt;p&gt;Back when I used to work with Django, I read the book &lt;a href&#x3D;&quot;https://www.oreilly.com/library/view/lightweight-django/9781491946275/...",
         "author": {
              "@type": "Person",
              "name": "Matthew Daly"
         },
         "publisher": {
            "@type": "Organization",
            "name": "Matthew Daly&#x27;s Blog",
            "logo": {
               "@type": "ImageObject",
               "url": "https://matthewdaly.co.uk/favicon.ico",
               "height": 16,
               "width": 16
            }
         },
         "image": {
            "@type": "ImageObject",
            "url": "https://matthewdaly.co.uk/logo.png",
            "height": 120,
            "width": 1200
         }
      }</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet" type="text/css"><style amp-custom>body {
   background-color: #252525;
}
      div.container {
         background-color: #f8f8f8;
         width: 100%;
      }
      p, h1, h2, h3, h4, h5, h6, li, nav a {
         font-family: "PT Serif","Georgia","Helvetica Neue",Arial,sans-serif;
         text-rendering: optimizelegibility;
      }
      p, li {
         font-size: 1.4em;
         line-height: 1.5em;
      }
      header {
         padding: 20px;
         color: #505050;
      }
      header h1 {
         font-size: 3em;
         line-height: 1.2em;
         color: #7f7f7f;
      }
      header h2 {
         font-size: 1.5em;
         color: #7f7f7f;
      }
      h1 a {
         text-decoration: none;
         color: #7f7f7f;
      }
      code {
         white-space: pre-wrap;
         word-wrap: break-word;
         font-family: Menlo, Monaco, "Andale Mono", "Ubuntu Mono", "lucida console", monospace;
         background-color: #cfcfcf;
         padding: 5px;
         border-radius: 3px;
      }
      pre {
         white-space: pre-wrap;
         word-wrap: break-word;
      }
      pre code {
         display: block;
         overflow-wrap: normal;
         word-wrap: normal;
         white-space: pre;
         font-size: 1.2em;
      }
      article {
         padding: 20px;
      }
      section {
         margin-top: 10px;
         margin-bottom: 10px;
      }
      amp-img {
         background-color: gray;
         border: 1px solid black;
      }
      .hljs {
         display: block;
         overflow-x: auto;
         padding: 0.5em;
         background: #474949;
         color: #d1d9e1;
      }
      .hljs-comment,
      .hljs-quote {
         color: #969896;
         font-style: italic;
      }
      .hljs-keyword,
      .hljs-selector-tag,
      .hljs-literal,
      .hljs-type,
      .hljs-addition {
         color: #cc99cc;
      }
      .hljs-number,
      .hljs-selector-attr,
      .hljs-selector-pseudo {
         color: #f99157;
      }
      .hljs-string,
      .hljs-doctag,
      .hljs-regexp {
         color: #8abeb7;
      }
      .hljs-title,
      .hljs-name,
      .hljs-section,
      .hljs-built_in {
         color: #b5bd68;
      }
      .hljs-variable,
      .hljs-template-variable,
      .hljs-selector-id,
      .hljs-class .hljs-title {
         color: #ffcc66;
      }
      .hljs-section,
      .hljs-name,
      .hljs-strong {
         font-weight: bold;
      }
      .hljs-symbol,
      .hljs-bullet,
      .hljs-subst,
      .hljs-meta,
      .hljs-link {
         color: #f99157;
      }
      .hljs-deletion {
         color: #dc322f;
      }
      .hljs-formula {
         background: #eee8d5;
      }
      .hljs-attr,
      .hljs-attribute {
         color: #81a2be;
      }
      .hljs-emphasis {
         font-style: italic;
      }
      ul.categories {
         padding-left: 0px;
         margin-bottom: 20px;
      }
      ul.categories li {
         list-style-type: none;
         display: inline-block;
         margin-right: 20px;
      }
      ul.categories li a {
         background-color: #303030;
         border-radius: 3px;
         padding: 3px;
         color: #fff;
         text-decoration: none;
      }
      a.commentlink, a.postlink {
         background-color: #303030;
         border-radius: 3px;
         padding: 3px;
         color: #fff;
         text-decoration: none;
      }
      blockquote {
         font-style: italic;
         border-left: 2px solid #cfcfcf;
      }
      blockquote p {
         font-size: 2.2em;
      }</style><script async src="https://cdn.ampproject.org/v0.js"></script><script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script></head><body><header><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></header><div class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">30th December 2020 5:00 pm</p><h1>Lightweight Laravel - Deconstructing a Full Stack Framework</h1><p>Back when I used to work with Django, I read the book <a href="https://www.oreilly.com/library/view/lightweight-django/9781491946275/">Lightweight Django</a>, and it completely changed the way I thought about building web applications. For years I’d heard the same lines parroted about how Django was too large and bloated, and something like Flask was a better bet for many applications, and this book completely blew this misconception away. By demonstrating how it was possible to break the framework apart, use just what you need, and leave out what you don’t, it showed how I could benefit from my familiarity with Django, while making it more suitable for smaller applications.</p><p>Laravel, like Django, is a full stack framework, and is often subject to similar misconceptions about bloat. But just because the framework ships with all this stuff, doesn’t mean you’re obliged to use it all. If you know you aren’t going to need all of a framework’s functionality, there’s nothing stopping you getting rid of what you don’t need, or even replacing it with something else. In this article, I’ll show you how to apply the same methodology to a Laravel application to remove what you don’t need. As part of this, we’ll be building a simple placeholder image service. This was used in Lightweight Django as it’s a good example of an application that is completely stateless, and doesn’t need sessions or a database, so it’s often seen as a bad fit for a full stack framework. Since the same applies here, it’s a good example for us too.</p><h2 id="getting-started">Getting started</h2><p>Run the following command in the shell to create a new Laravel application:</p><pre><code class="hljs lang-bash">$ composer create-project --prefer-dist laravel/laravel lightweight-laravel
</code></pre><p>What this actually does is as follows:</p><ul><li>Resolve the latest release of the package <code>laravel/laravel</code> that will work on your system</li><li>Copy it from the <a href="https://github.com/laravel/laravel">repository</a> to the specified location</li><li>Carry out any post-install scripts specified, such as creating the <code>.env</code> file and generating a key</li></ul><p>However, that’s just a standardised boilerplate for Laravel applications. Most of the functionality of the framework is in the package <code>laravel/framework</code>, which is included as a dependency in your <code>composer.json</code>. This makes sense, because by keeping as much of the actual framework out of the starter boilerplate and in a separate repository, it minimises the work required to update the application to a new version. It also means you can strip that boilerplate down to remove references to things you don’t need, and even create your own custom boilerplates to save you work in future.</p><h2 id="stripping-down-the-boilerplate">Stripping down the boilerplate</h2><p>Let’s start stripping out the things we don’t need. Since our application is stateless, we have no need whatsoever of a database, so we can delete the <code>app/Models</code> and <code>database</code> folders. We’ll want to support Redis for the cache, so we can’t delete the file <code>config/database.php</code>, but we can remove any references to the database other than Redis from that file. We can delete some other files from the <code>config/</code> folder, namely <code>auth.php</code>, <code>broadcasting.php</code>, <code>filesystems.php</code>, <code>mail.php</code>, <code>queue.php</code>, <code>services.php</code> and <code>session.php</code>.</p><p>We also don’t need a lot of the middleware that ships with Laravel. If you go into the file <code>app/Http/Kernel.php</code> you’ll see that it assigns some middleware as global, some to the <code>web</code> and <code>api</code> groups, and some as optional route middleware. In this file:</p><ul><li>We don’t need to make any POST requests to this application, so we can lose the <code>ValidatePostSize</code> middleware from the global middleware entirely</li><li>The <code>web</code> group relates to cookies, sessions, CSRF, authentication and handling routing with substitute bindings. Since we don’t need any of that we can empty this group entirely</li><li>The <code>auth</code>, <code>auth.basic</code>, <code>can</code>, <code>guest</code>, <code>password.confirm</code>, and <code>verified</code> route middleware is also surplus to requirements and can go</li></ul><p>As this change is a bit fiddly, here’s a patch, which may be easier to read:</p><pre><code class="hljs lang-patch">From <span class="hljs-number">6</span>bc87e9602e839d5635963b6d740279b2dbcf16b Mon Sep <span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">2001</span>
<span class="hljs-name">From</span>: Matthew Daly &lt;Matthew Daly <span class="hljs-number">450801</span>+matthewbdaly@users.noreply.github.com&gt;
<span class="hljs-name">Date</span>: Wed, <span class="hljs-number">30</span> Dec <span class="hljs-number">2020</span> <span class="hljs-number">11</span>:<span class="hljs-number">54</span>:<span class="hljs-number">56</span> +<span class="hljs-number">0000</span>
<span class="hljs-name">Subject</span>: [PATCH] Removed unwanted middleware

<span class="hljs-comment">---</span>
 app/Http/Kernel.php | <span class="hljs-number">14</span> <span class="hljs-comment">--------------</span>
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">14</span> deletions(-)

diff <span class="hljs-comment">--git a/app/Http/Kernel.php b/app/Http/Kernel.php</span>
index <span class="hljs-number">30020</span>a5.<span class="hljs-number">.10e150</span>d <span class="hljs-number">100644</span>
<span class="hljs-comment">--- a/app/Http/Kernel.php</span>
+++ b/app/Http/Kernel.php
@@ <span class="hljs-number">-18</span>,<span class="hljs-number">7</span> +<span class="hljs-number">18</span>,<span class="hljs-number">6</span> @@ <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kernel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpKernel</span></span>
         \App\Http\Middleware\TrustProxies::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         \Fruitcake\Cors\<span class="hljs-name">HandleCors</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         \App\Http\Middleware\PreventRequestsDuringMaintenance::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        \Illuminate\Foundation\Http\Middleware\<span class="hljs-name">ValidatePostSize</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         \App\Http\Middleware\TrimStrings::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         \Illuminate\Foundation\Http\Middleware\<span class="hljs-name">ConvertEmptyStringsToNull</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
     ];
@@ <span class="hljs-number">-30</span>,<span class="hljs-number">13</span> +<span class="hljs-number">29</span>,<span class="hljs-number">6</span> @@ <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kernel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpKernel</span></span>
      */
     protected $middlewareGroups = [
         <span class="hljs-string">'web'</span> =&gt; [
-            \App\Http\Middleware\EncryptCookies::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-            \Illuminate\Session\Middleware\StartSession::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-            // \Illuminate\Session\Middleware\AuthenticateSession::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-            \Illuminate\View\Middleware\ShareErrorsFromSession::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-            \App\Http\Middleware\VerifyCsrfToken::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-            \Illuminate\Routing\Middleware\SubstituteBindings::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         ],

         <span class="hljs-string">'api'</span> =&gt; [
@@ <span class="hljs-number">-53</span>,<span class="hljs-number">14</span> +<span class="hljs-number">45</span>,<span class="hljs-number">8</span> @@ <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kernel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpKernel</span></span>
      * @var array
      */
     protected $routeMiddleware = [
-        <span class="hljs-string">'auth'</span> =&gt; \App\Http\Middleware\Authenticate::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-string">'auth.basic'</span> =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-string">'cache.headers'</span> =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-string">'can'</span> =&gt; \Illuminate\Auth\Middleware\Authorize::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-string">'guest'</span> =&gt; \App\Http\Middleware\RedirectIfAuthenticated::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-string">'password.confirm'</span> =&gt; \Illuminate\Auth\Middleware\RequirePassword::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-string">'signed'</span> =&gt; \Illuminate\Routing\Middleware\ValidateSignature::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-string">'verified'</span> =&gt; \Illuminate\Auth\Middleware\EnsureEmailIsVerified::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
     ];
 }
<span class="hljs-comment">-- </span>
<span class="hljs-number">2.28</span><span class="hljs-number">.0</span>

</code></pre><p>These changes also mean a lot of the service providers and facades are now redundant and can be removed from the application. If you go into <code>config/app.php</code> you can remove <code>AuthServiceProvider</code>, <code>BroadcastServiceProvider</code>, <code>CookieServiceProvider</code>, <code>MailServiceProvider</code>, <code>NotificationServiceProvider</code>, <code>PaginationServiceProvider</code>, <code>PasswordResetServiceProvider</code>, <code>SessionServiceProvider</code> and <code>TranslationServiceProvider</code> from the providers section, as well as the commented-out local <code>BroadcastServiceProvider</code>. You can also delete the facades for <code>Auth</code>, <code>Cookie</code>, <code>DB</code>, <code>Eloquent</code>, <code>Gate</code>, <code>Lang</code>, <code>Mail</code>, <code>Notification</code>, <code>Password</code>, <code>Queue</code>, <code>Schema</code>, <code>Session</code>, and <code>Storage</code>.</p><p>Again, here’s a patch of the required changes:</p><pre><code class="hljs lang-patch"><span class="hljs-type">From</span> <span class="hljs-number">66</span>be3b836706ef488b890cdae6e97d4fc6195dd6 <span class="hljs-type">Mon</span> <span class="hljs-type">Sep</span> <span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">2001</span>
<span class="hljs-type">From</span>: <span class="hljs-type">Matthew</span> <span class="hljs-type">Daly</span> &lt;<span class="hljs-type">Matthew</span> <span class="hljs-type">Daly</span> <span class="hljs-number">450801</span>+matthewbdaly<span class="hljs-meta">@users</span>.noreply.github.com&gt;
<span class="hljs-type">Date</span>: <span class="hljs-type">Wed</span>, <span class="hljs-number">30</span> <span class="hljs-type">Dec</span> <span class="hljs-number">2020</span> <span class="hljs-number">12</span>:<span class="hljs-number">10</span>:<span class="hljs-number">25</span> +<span class="hljs-number">0000</span>
<span class="hljs-type">Subject</span>: [<span class="hljs-type">PATCH</span>] <span class="hljs-type">Removed</span> unused service providers and facades

---
 config/app.php | <span class="hljs-number">26</span> --------------------------
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">26</span> deletions(-)

diff --git a/config/app.php b/config/app.php
index <span class="hljs-number">2</span>a2f0eb..b7a38c8 <span class="hljs-number">100644</span>
--- a/config/app.php
+++ b/config/app.php
@@ <span class="hljs-number">-139</span>,<span class="hljs-number">26</span> +<span class="hljs-number">139</span>,<span class="hljs-number">17</span> @@ <span class="hljs-keyword">return</span> [
         <span class="hljs-comment">/*
          * Laravel Framework Service Providers...
          */</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Auth</span>\<span class="hljs-type">AuthServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Broadcasting</span>\<span class="hljs-type">BroadcastServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Bus</span>\<span class="hljs-type">BusServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Cache</span>\<span class="hljs-type">CacheServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Foundation</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">ConsoleSupportServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Cookie</span>\<span class="hljs-type">CookieServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Database</span>\<span class="hljs-type">DatabaseServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Encryption</span>\<span class="hljs-type">EncryptionServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Filesystem</span>\<span class="hljs-type">FilesystemServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Foundation</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">FoundationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Hashing</span>\<span class="hljs-type">HashServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Mail</span>\<span class="hljs-type">MailServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Notifications</span>\<span class="hljs-type">NotificationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Pagination</span>\<span class="hljs-type">PaginationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Pipeline</span>\<span class="hljs-type">PipelineServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Queue</span>\<span class="hljs-type">QueueServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Redis</span>\<span class="hljs-type">RedisServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Auth</span>\<span class="hljs-type">Passwords</span>\<span class="hljs-type">PasswordResetServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Session</span>\<span class="hljs-type">SessionServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Translation</span>\<span class="hljs-type">TranslationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Validation</span>\<span class="hljs-type">ValidationServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">Illuminate</span>\<span class="hljs-type">View</span>\<span class="hljs-type">ViewServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>

@@ <span class="hljs-number">-170</span>,<span class="hljs-number">9</span> +<span class="hljs-number">161</span>,<span class="hljs-number">6</span> @@ <span class="hljs-keyword">return</span> [
          * <span class="hljs-type">Application</span> <span class="hljs-type">Service</span> <span class="hljs-type">Providers</span>...
          */
         <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">AppServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">AuthServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-comment">// App\Providers\BroadcastServiceProvider::class,</span>
-        <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">EventServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-type">App</span>\<span class="hljs-type">Providers</span>\<span class="hljs-type">RouteServiceProvider</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>

     ],
@@ <span class="hljs-number">-193</span>,<span class="hljs-number">35</span> +<span class="hljs-number">181</span>,<span class="hljs-number">21</span> @@ <span class="hljs-keyword">return</span> [
         <span class="hljs-symbol">'Ap</span>p' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">App</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Ar</span>r' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Arr</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Artisa</span>n' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Artisan</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Aut</span>h' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Auth</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Blad</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Blade</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Broadcas</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Broadcast</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Bu</span>s' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Bus</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Cach</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Cache</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Confi</span>g' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Config</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Cooki</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Cookie</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Cryp</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Crypt</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'D</span>B' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">DB</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Eloquen</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Database</span>\<span class="hljs-type">Eloquent</span>\<span class="hljs-type">Model</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Even</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Event</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Fil</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">File</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Gat</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Gate</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Has</span>h' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Hash</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Htt</span>p' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Http</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Lan</span>g' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Lang</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Lo</span>g' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Log</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Mai</span>l' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Mail</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Notificatio</span>n' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Notification</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Passwor</span>d' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Password</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Queu</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Queue</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Redirec</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Redirect</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-comment">// 'Redis' =&gt; Illuminate\Support\Facades\Redis::class,</span>
         <span class="hljs-symbol">'Reques</span>t' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Request</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Respons</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Response</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Rout</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Route</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Schem</span>a' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Schema</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Sessio</span>n' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Session</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-        <span class="hljs-symbol">'Storag</span>e' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Storage</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'St</span>r' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Str</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'UR</span>L' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">URL</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
         <span class="hljs-symbol">'Validato</span>r' =&gt; <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Support</span>\<span class="hljs-type">Facades</span>\<span class="hljs-type">Validator</span>::<span class="hljs-class"><span class="hljs-keyword">class</span>,</span>
-- 
<span class="hljs-number">2.28</span><span class="hljs-number">.0</span>

</code></pre><p>There are a few service providers that ideally we’d strip out but are tightly integrated into the framework. For instance, the database and queue service providers are both used by some Artisan commands, and it’s not very practical to disable only those commands, so removing them will stop Artisan from working. If you don’t mind running the development server manually, you can go ahead and remove these.</p><h2 id="building-the-application">Building the application</h2><p>Now, let’s set out how our application will work. We will have two routes:</p><ul><li>A route that accepts width and height parameters in the route itself, and responds with a PNG response sized accordingly</li><li>A route that returns a simple HTML homepage</li></ul><p>You’ve no doubt seen various novelty placeholder sites like <a href="http://placekitten.com/">placekitten.com</a> for use in web projects, and this will be similar to that. We’ll use a simple black image with the dimensions in white text, but you should be able to use this as the basis of a more sophisticated placeholder service, such as if you wanted to use branded images for a particular client.</p><p>Since the home page will be fairly straightforward, let’s do that first. Delete the existing <code>resources/views/welcome.blade.php</code> file and save this to <code>resources/views/home.blade.php</code>:</p><pre><code class="hljs lang-blade.php"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Laravel Placeholder Images<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{ mix('css/app.css') }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Laravel Placeholder Images<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>This server can be used for serving placeholder
    images for any web page.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>To request a placeholder image of a given width and height
    simply include an image with the source pointing to
    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>/image/<span class="hljs-symbol">&amp;lt;</span>width<span class="hljs-symbol">&amp;gt;</span>x<span class="hljs-symbol">&amp;lt;</span>height<span class="hljs-symbol">&amp;gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span>
    on this server such as:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>
        <span class="hljs-symbol">&amp;lt;</span>img src="</span><span class="hljs-template-variable">{{ $example }}</span><span class="xml">" <span class="hljs-symbol">&amp;gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Examples<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{{ route('placeholder', ['width' =&gt; 50, 'height' =&gt; 50]) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{{ route('placeholder', ['width' =&gt; 100, 'height' =&gt; 50]) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{{ route('placeholder', ['width' =&gt; 50, 'height' =&gt; 100]) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
</code></pre><p>Note we’re using the <code>route()</code> helper to add some example images, even though it’s not in place yet. Add this route to your <code>routes/web.php</code> as well:</p><pre><code class="hljs lang-php">Route::get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> view(<span class="hljs-string">'home'</span>, [
        <span class="hljs-string">'example'</span> =&gt; route(<span class="hljs-string">'placeholder'</span>, [<span class="hljs-string">'width'</span> =&gt; <span class="hljs-number">50</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-number">50</span>]),
    ]);
});
</code></pre><p>Again, note that we’re using the <code>route()</code> helper to get the URL for the placeholder image. Next, we need to create the outline of the route for getting the placeholders:</p><pre><code class="hljs lang-php">Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{
})-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])
    -&gt;name(<span class="hljs-string">'placeholder'</span>);
</code></pre><p>Due to the limited scope of this application, we won’t bother with full controllers, but you can add them if you wish. Note we’ve specified the name <code>placeholder</code> and set a regex to validate the <code>width</code> and <code>height</code> parameters.</p><p>Now let’s populate the callback to generate a PNG file.</p><pre><code class="hljs lang-php">Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{
    <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {
        abort();
    }
    $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);
    imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);
    ob_start();
    imagepng($img);
    $file = ob_get_contents();
    ob_end_clean();
    <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [
        <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span>
    ]);
})-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])
    -&gt;name(<span class="hljs-string">'placeholder'</span>);
</code></pre><p>We’ll also add some very basic CSS to the provided CSS file:</p><pre><code class="hljs lang-css"><span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">text-align</span>: center;
}

<span class="hljs-selector-tag">ul</span> {
    <span class="hljs-attribute">list-type</span>: none;
}

<span class="hljs-selector-tag">li</span> {
    <span class="hljs-attribute">display</span>: inline-block;
}
</code></pre><p>Don’t forget to build this with <code>npm install &amp;&amp; npm run production</code> too.</p><p>If you now run <code>php artisan serve</code> you should be able to see that it works - the homepage renders, and the embedded images are pulled in OK. However, there are three potential issues:</p><ul><li>The images themselves are regenerated each time. Since they never change, it’s a no-brainer to cache them indefinitely for the best performance, and if we do need to change them in the future we can just flush the cache to resolve this</li><li>Similarly, we should use ETags to allow the application to tell the browser when the image has changed</li><li>There’s no limit on how large images can be, so a malicious user could request a huge image to break the system</li></ul><p>Let’s tackle these in order. First, let’s create some middleware to handle the caching:</p><pre><code class="hljs lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Cache</span>;

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheImages</span>
</span>{
    <span class="hljs-comment">/**
     * Handle an incoming request.
     *
     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request
     * <span class="hljs-doctag">@param</span>  \Closure  $next
     * <span class="hljs-doctag">@return</span> mixed
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(Request $request, Closure $next)</span>
    </span>{
        $key = sprintf(<span class="hljs-string">"%d.%d"</span>, $request-&gt;width, $request-&gt;height);
        <span class="hljs-keyword">return</span> Cache::rememberForever($key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($next, $request)</span> </span>{
            <span class="hljs-keyword">return</span> $next($request);
        });
    }
}
</code></pre><p>We construct a cache key from the request width and height, and use the <code>Cache::rememberForever()</code> method to cache the response. We then register this middleware as route middleware in <code>app\Http\Kernel.php</code>:</p><pre><code class="hljs lang-php">    <span class="hljs-keyword">protected</span> $routeMiddleware = [
        <span class="hljs-string">'cache.headers'</span> =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::class,
        <span class="hljs-string">'signed'</span> =&gt; \Illuminate\Routing\Middleware\ValidateSignature::class,
        <span class="hljs-string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,
        <span class="hljs-string">'cache.images'</span> =&gt; \App\Http\Middleware\CacheImages::class,
    ];
</code></pre><p>And apply it to the image route:</p><pre><code class="hljs lang-php">Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{
    <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {
        abort();
    }
    $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);
    imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);
    ob_start();
    imagepng($img);
    $file = ob_get_contents();
    ob_end_clean();
    <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [
        <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span>
    ]);
})-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])
  -&gt;name(<span class="hljs-string">'placeholder'</span>)
  -&gt;middleware(<span class="hljs-string">'cache.images'</span>);
</code></pre><p>Next, let’s set ETags on our images. Laravel comes with the <code>cache.headers</code> middleware, which we can easily wrap around our placeholder route:</p><pre><code class="hljs lang-php">Route::middleware(<span class="hljs-string">'cache.headers:public;etag'</span>)-&gt;group(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{
        <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {
            abort();
        }
        $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);
        imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);
        ob_start();
        imagepng($img);
        $file = ob_get_contents();
        ob_end_clean();
        <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [
            <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span>
        ]);
    })-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])
      -&gt;name(<span class="hljs-string">'placeholder'</span>)
      -&gt;middleware(<span class="hljs-string">'cache.images'</span>);
});
</code></pre><p>Finally, let’s handle the dimensions issue. Again, this is something that is probably best handled in middleware since that way it can be rejected before the point it gets to the route handler. All we need to do is to check to see if the width and height parameters exceed the intended value, and throw an error in the middleware:</p><pre><code class="hljs lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Validation</span>\<span class="hljs-title">ValidationException</span>;

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateImageDimensions</span>
</span>{
    <span class="hljs-comment">/**
     * Handle an incoming request.
     *
     * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request
     * <span class="hljs-doctag">@param</span>  \Closure  $next
     * <span class="hljs-doctag">@return</span> mixed
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(Request $request, Closure $next)</span>
    </span>{
        <span class="hljs-keyword">if</span> ($request-&gt;width &gt; <span class="hljs-number">2000</span> || $request-&gt;height &gt; <span class="hljs-number">2000</span>) {
            abort(<span class="hljs-number">422</span>, <span class="hljs-string">'Height and width cannot exceed 2000 pixels'</span>);
        }
        <span class="hljs-keyword">return</span> $next($request);
    }
}
</code></pre><p>Register this middleware in <code>app/Http/Kernel.php</code>:</p><pre><code class="hljs lang-php">    <span class="hljs-keyword">protected</span> $routeMiddleware = [
        <span class="hljs-string">'cache.headers'</span> =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::class,
        <span class="hljs-string">'signed'</span> =&gt; \Illuminate\Routing\Middleware\ValidateSignature::class,
        <span class="hljs-string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,
        <span class="hljs-string">'cache.images'</span> =&gt; \App\Http\Middleware\CacheImages::class,
        <span class="hljs-string">'validate.images'</span> =&gt; \App\Http\Middleware\ValidateImageDimensions::class,
    ];
</code></pre><p>And apply it to the image route:</p><pre><code class="hljs lang-php">Route::middleware(<span class="hljs-string">'cache.headers:public;etag'</span>)-&gt;group(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    Route::get(<span class="hljs-string">'/placeholder/{width}x{height}'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(int $width, int $height)</span> </span>{
        <span class="hljs-keyword">if</span> (!$img = imagecreatetruecolor($width, $height)) {
            abort();
        }
        $textColour = imagecolorallocate($img, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);
        imagestring($img, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"$width X $height"</span>, $textColour);
        ob_start();
        imagepng($img);
        $file = ob_get_contents();
        ob_end_clean();
        <span class="hljs-keyword">return</span> response()-&gt;make($file, <span class="hljs-number">200</span>, [
            <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'image/png'</span>
        ]);
    })-&gt;where([<span class="hljs-string">'width'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-string">'[0-9]+'</span>])
      -&gt;name(<span class="hljs-string">'placeholder'</span>)
      -&gt;middleware([<span class="hljs-string">'validate.images'</span>, <span class="hljs-string">'cache.images'</span>]);
});
</code></pre><p>And we’re done! We now have a basic, but functional, stateless Laravel application that’s been stripped of a lot of the unnecessary functionality. There are a few further changes that could be made to expand this if necessary, such as:</p><ul><li>Amend the project to allow requesting different image formats using an additional route parameter (hint - you’ll want to use something like <a href="http://image.intervention.io/">Intervention for this</a>)</li><li>Serve different images, either by using one as a starting template so they are all branded the same, or specifying one from several options in the URL, such as with <a href="https://www.placecage.com/">PlaceCage</a></li></ul><p>However, I will leave these as an exercise for the reader. The code for this project is available on <a href="https://github.com/matthewbdaly/lightweight-laravel">Github</a> if you get stuck at any point.</p><p>Hopefully, this article has given you some food for thought about how you can use Laravel for applications you might have previously considered too small to use it for. Don’t worry too much about removing something that you need to add later - version control means you can always retrieve it if it turns out you do need it later. I’d also add that potentially the same approach can be applied to other full stack PHP frameworks, though you’ll have to do some exploring on your own to determine this.</p><section><ul class="categories"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/laravel/">laravel</a></li></ul></section><section><a class="commentlink" href="https://matthewdaly.co.uk/blog/2020/12/30/lightweight-laravel-deconstructing-a-full-stack-framework/">View the article with comments</a></section><section><a class="postlink" href="/blog/2020/09/28/what-i-want-in-a-php-cms/amp/">What I Want in a PHP CMS</a></section></article></div></div></div><amp-analytics type="googleanalytics" id="analytics1"><script type="application/json">{
					"vars": {
						"account": "UA-17043630-1"
					},
					"triggers": {
						"trackPageview": {
							"on": "visible",
							"request": "pageview"
						}
					}
				}</script></amp-analytics></body></html>