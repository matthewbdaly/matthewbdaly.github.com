<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>tdd | Matthew Daly&apos;s Blog</title>
        <link>https://matthewdaly.co.uk/blog/categories/tdd/</link>
        <description>tdd | I&apos;m a web developer in Norfolk. This is my blog...</description>
        <lastBuildDate>Sun, 13 Jan 2019 18:53:55 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <generator>grunt-blogbuilder https://github.com/matthewbdaly/grunt-blogbuilder</generator>
        <copyright>Matthew Daly 2019</copyright>
        <item>
            <title><![CDATA[Unit testing your Laravel controllers]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/02/25/unit-testing-your-laravel-controllers/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/02/25/unit-testing-your-laravel-controllers/</guid>
            <pubDate>Sun, 25 Feb 2018 15:50:44 GMT</pubDate>
            <description><![CDATA[<p>In <a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">my previous post</a> I mentioned some strategies for refactoring Laravel controllers to move unnecessary functionality elsewhere. However, I didn’t cover testing them. In this post I will demonstrate the methodology I use for testing Laravel controllers.</p>
<p>Say we have the following method in a controller:</p>
<pre><code class="lang-php">public function store(Request $request)
{    
        $document = new Document($request-&gt;only([
            &#39;title&#39;, 
            &#39;text&#39;, 
        ]));
        $document-&gt;save();

        event(new DocumentCreated($document));

        return redirect()-&gt;route(&#39;/&#39;);
}
</code></pre>
<p>This controller method does three things:</p>
<ul>
<li>Return a response</li>
<li>Create a model instance</li>
<li>Fire an event</li>
</ul>
<p>Our tests therefore need to pass it all its external dependencies and check it carries out the required actions.</p>
<p>First we fake the event facade:</p>
<pre><code class="lang-php">    Event::fake();
</code></pre>
<p>Next, we create an instance of <code>Illuminate\Http\Request</code> to represent the HTTP request passed to the controller:</p>
<pre><code class="lang-php">    $request = Request::create(&#39;/store&#39;, &#39;POST&#39;,[
        &#39;title&#39;     =&gt;     &#39;foo&#39;,
        &#39;text&#39;     =&gt;     &#39;bar&#39;,
    ]);
</code></pre>
<p>If you’re using a custom form request class, you should instantiate that in exactly the same way.</p>
<p>Then, instantiate the controller, and call the method, passing it the request object:</p>
<pre><code class="lang-php">    $controller = new MyController();
    $response = $controller-&gt;store($request);
</code></pre>
<p>You can then test the response from the controller. You can test the status code like this:</p>
<pre><code class="lang-php">    $this-&gt;assertEquals(302, $response-&gt;getStatusCode());
</code></pre>
<p>You may also need to check the content of the response matches what you expect to see, by retrieving <code>$response-&gt;getBody()-&gt;getContent()</code>.</p>
<p>Next, retrieve the newly created model instance, and verify it exists:</p>
<pre><code class="lang-php">    $document = Document::where(&#39;title&#39;, &#39;foo&#39;)-&gt;first();
    $this-&gt;assertNotNull($document);
</code></pre>
<p>You can also use <code>assertEquals()</code> to check the attributes on the model if appropriate. Finally, you check the event was fired:</p>
<pre><code class="lang-php">    Event::assertDispatched(DocumentCreated::class, function ($event) use ($document) { 
        return $event-&gt;document-&gt;id === $document-&gt;id; 
    });
</code></pre>
<p>This test should not concern itself with any functionality triggered by the event, only that the event gets triggered. The event should have separate unit tests in which the event is triggered, and then the test verifies it carried out the required actions.</p>
<p>Technically, these don’t quite qualify as being unit tests because they hit the database, but they should cover the controller adequately. To make them true unit tests, you’d need to implement the repository pattern for the database queries rather than using Eloquent directly, and mock the repository, so you can assert that the mocked repository receive the right data and have it return the expected response.</p>
<p>Here is how you might do that with Mockery:</p>
<pre><code class="lang-php">$mock = Mockery::mock(&#39;App\Contracts\Repositories\Document&#39;);
$mock-&gt;shouldReceive(&#39;create&#39;)-&gt;with([
    &#39;title&#39;    =&gt;        &#39;foo&#39;,
    &#39;text&#39;    =&gt;        &#39;bar&#39;,
])-&gt;once()-&gt;andReturn(true);
$controller = new MyController($mock);
</code></pre>
<p>As long as your controllers are kept as small as possible, it’s generally not too hard to test them. Unfortunately, fat controllers become almost impossible to test, which is another good reason to avoid them.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[More tricks for speeding up your Laravel test suite]]></title>
            <link>https://matthewdaly.co.uk/blog/2018/01/07/more-tricks-for-speeding-up-your-laravel-test-suite/</link>
            <guid>https://matthewdaly.co.uk/blog/2018/01/07/more-tricks-for-speeding-up-your-laravel-test-suite/</guid>
            <pubDate>Sun, 07 Jan 2018 16:32:03 GMT</pubDate>
            <description><![CDATA[<p>When you first start doing test-driven development with Laravel, it can be quite hard to produce a test suite that runs quickly enough. The first time I used Laravel for a large project, I had a test suite that at one time, took over seven minutes to run, which was pretty awful considering that the ideal time for a test suite to take to run is no more than ten seconds.</p>
<p>Fortunately, with experience you can pick up some techniques which can quite drastically speed up your test suite. Here are some of the ones I’ve learned that can be useful.</p>
<p>Note that some of these are contradictory, and what works for one use case won’t necessarily work for another, so my advice is to try these and see what makes a difference for your use case.</p>
<h2 id="reduce-the-cost-of-hashing">Reduce the cost of hashing</h2>
<p>Inside the <code>createApplication()</code> method of <code>tests\CreatesApplication.php</code>, place the following statement:</p>
<pre><code class="lang-php">        Hash::setRounds(4);
</code></pre>
<p>This makes hashing passwords quicker and less demanding, and since you don’t care about the security of a password in a test, you’re not losing out in any way by doing so.</p>
<p>This, by itself, can <em>massively</em> reduce the time taken by your test suite - your mileage may vary, but I’ve personally seen it cut to a third of the previous time by using this. In fact, it’s recently been added to Laravel by default.</p>
<h2 id="if-you-re-creating-a-lot-of-fixtures-for-tests-do-so-in-a-transaction">If you’re creating a lot of fixtures for tests, do so in a transaction</h2>
<p>Sometimes, your application requires a lot of data to be added to the database just to be usable, and it’s quite common to use seeders for this purpose. However, it can take some time to insert a lot of data, especially if it has to be re-run for every test. If you do have to insert a lot of data before a test, you can cut down the time substantially by wrapping the seeder calls in a transaction:</p>
<pre><code class="lang-php">&lt;?php

use Illuminate\Database\Seeder;
use Illuminate\Database\Eloquent\Model;
use DB;

class DatabaseSeeder extends Seeder
{
    /**
     * Run the database seeds.
     *
     * @return void
     */
    public function run()
    {
        Model::unguard();

        DB::beginTransaction();
        $this-&gt;call(GroupTableSeeder::class);
        $this-&gt;call(UserTableSeeder::class);
        $this-&gt;call(ProjectTableSeeder::class);
        DB::commit();

        Model::reguard();
    }
}
`
</code></pre>
<p>I’ve personally seen this trick cut the insert time by over half, every single time the database is seeded. If you don’t have much data to insert, it may not help, but for large amounts of data it can make a big difference.</p>
<h2 id="if-a-lot-of-tests-need-the-same-data-migrate-and-seed-it-first-then-wrap-the-tests-in-transactions-and-roll-them-back-afterwards">If a lot of tests need the same data, migrate and seed it first, then wrap the tests in transactions and roll them back afterwards</h2>
<p>If multiple tests need to work with the same dataset, you should consider running the migrations and seeders before the first test, and then wrapping each test inside a transaction. That way the data will only be inserted once, and will be rolled back to that initial good state after each test.</p>
<pre><code class="lang-php">    protected static $migrated = false;

    public function setUp()
    {
        parent::setUp();
        DB::beginTransaction();
    }

    public function tearDown()
    {
        DB::rollback();
        parent::tearDown();
    }

    public static function setUpBeforeClass()
    {
        if (!self::$migrated) {
            Artisan::call(&#39;migrate:fresh&#39;);
            Artisan::call(&#39;db:seed&#39;);
            self::$migrated = true;
        }
    }
</code></pre>
<p>Using something like this instead of one of the existing testing traits may be a better fit under those circumstances. However, if your application uses transactions for some functionality this might cause problems.</p>
<h2 id="don-t-create-a-full-instance-of-the-laravel-application-unless-you-have-to">Don’t create a full instance of the Laravel application unless you have to</h2>
<p>Not every test requires that you instantiate the full Laravel application, and doing so slows your tests down. If you don’t absolutely need the full application instantiated in the test, consider having your test inherit from the below simple test case class instead:</p>
<pre><code class="lang-php">&lt;?php

namespace Tests;

use Mockery\Adapter\Phpunit\MockeryPHPUnitIntegration;
use PHPUnit\Framework\TestCase as BaseTestCase;

class SimpleTestCase extends BaseTestCase
{
    use MockeryPHPUnitIntegration;
}
</code></pre>
<p>For properly isolated unit tests, using this base class instead can have a noticeable effect on performance.</p>
<h2 id="if-you-can-use-an-in-memory-sqlite-database-for-testing">If you can, use an in-memory SQLite database for testing</h2>
<p>This isn’t an option if you’re relying on the features of another database, but if it is, this is usually the fastest way to go. Configure it as follows in <code>phpunit.xml</code>:</p>
<pre><code class="lang-xml">        &lt;env name=&quot;DB_CONNECTION&quot; value=&quot;sqlite&quot;/&gt;
        &lt;env name=&quot;DB_DATABASE&quot; value=&quot;:memory:&quot;/&gt;
</code></pre>
<h2 id="use-the-new-refresh-database-trait">Use the new Refresh Database trait</h2>
<pre><code class="lang-php">   use RefreshDatabase;
</code></pre>
<p>This testing trait is generally more efficient than migrating down and up, because it empties the database afterwards rather than stepping through the changes of each migration. If you have a non-trivial number of migrations, it will almost certainly be quicker than migrating down, then back up for the next test.</p>
<h2 id="mock-what-you-can-t-control">Mock what you can’t control</h2>
<p>You should never, ever be making calls to external APIs in your test suite, because you can’t control whether those external API’s work - if a third-party API goes down, you may get a failed test run even if your application is working perfectly, not to mention it will add the time taken to send the request and receive a response to the test time. Instead, mock the calls to the third-party API.</p>
<h2 id="for-large-applications-consider-moving-parts-into-a-separate-package">For large applications, consider moving parts into a separate package</h2>
<p>If you have a particularly large application, it’s worth considering moving parts of it out into standalone packages and requiring them using Composer’s support for private Git repositories. That way, those packages can have their own test suites, and the main application’s test suite can cover the remaining functionality.</p>
<p>For instance, it’s fairly straightforward to pull out your models and migrations and put them in a separate package, and the tests for them can go with them to that package.</p>
<p>You should also consider whether parts of your application would be useful as standalone packages, and if so pull them out along with their tests. That way, not only are you making your test suite quicker, but you’re also saving yourself work by creating a reusable solution for a problem you might encounter again in the future.</p>
<h2 id="turn-off-xdebug">Turn off XDebug</h2>
<p>XDebug has a horrendous effect on the performance of the test suite. Turn it off unless you need it to generate test coverage. Better yet, set up continuous integration and have that generate the coverage for you.</p>
<h2 id="summary">Summary</h2>
<p>When you first start using Laravel, it can be hard to keep your test suite lean, and the longer a test suite takes to run, the less likely it is to actually get run regularly. To practice TDD properly, your test suite should not take long enough that your mind starts to wander, and ten seconds is a good target to aim for in this regard - you need to be able to run it several times a minute without problem. Obviously things like having a faster computer or an SSD will help, but there’s a lot you can do to make your test suite more efficient, even when running on a quite basic machine.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Building a postcode lookup client with HTTPlug and PHPSpec]]></title>
            <link>https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/</link>
            <guid>https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/</guid>
            <pubDate>Tue, 28 Nov 2017 11:40:39 GMT</pubDate>
            <description><![CDATA[<p>While PHPUnit is my normal go-to PHP testing framework, for some applications I find <a href="http://www.phpspec.net/en/stable/">PHPSpec</a> superior, in particular REST API clients. I’ve found that it makes for a better flow when doing test-driven development, because it makes it very natural to write a test first, then run it, then make the test pass.</p>
<p>In this tutorial I’ll show you how to build a lookup API client for UK postcodes. In the process of doing so, we’ll use PHPSpec to drive our development process. We’ll also use <a href="http://docs.php-http.org/en/latest/httplug/tutorial.html">HTTPlug</a> as our underlying HTTP library. The advantage of this over using something like Guzzle is that we give library users the freedom to choose the HTTP library they feel is most appropriate to their situation.</p>
<h2 id="background">Background</h2>
<p>If you’re unfamiliar with it, the UK postcode system is our equivalent of a zip code in the US, but with two major differences:</p>
<ul>
<li>The codes themselves are alphanumeric instead of numeric, with the first part including one or two letters usually (but not always) derived from the nearest large town or city (eg L for Liverpool, B for Birmingham, OX for Oxford), or for London, based on the part of the city (eg NW for the north-west of London)</li>
<li>A full postcode is in two parts (eg NW1 8TQ), and the first part narrows the location down to a similar area to a US-style zip code, while the second part usually narrows it down to a street (although sometimes large organisations that receive a lot of mail will have a postcode to themselves).</li>
</ul>
<p>This means that if you have someone’s postcode and house name or address, you can use those details to look up the rest of their address details. This obviously makes it easier for users to fill out a form, such as when placing an order on an e-commerce site - you can just request those two details and then autofill the rest from them.</p>
<p>Unfortunately, it’s not quite that simple. The data is owned by Royal Mail, and they charge through the nose for access to the raw data, which places this data well outside the budgets of many web app developers. Fortunately, <a href="https://ideal-postcodes.co.uk/">Ideal Postcodes</a> offer a REST API for querying this data. It’s not free, but at 2.5p per request it’s not going to break the bank unless used excessively, and they offer some dummy postcodes that are free to query, which is perfectly fine for testing.</p>
<p>For those of you outside the UK, this may not be of much immediate use, but the underlying principles will still be useful, and you can probably build a similar client for your own nation’s postal code system. For instance, there’s a <a href="https://www.zipcodeapi.com/API">Zipcode API</a> that those of you in the US can use, and if you understand what’s going on here it shouldn’t be hard to adapt it to work with that. If you do produce a similar client for your country’s postal code system, submit a pull request to update the README with a link to it and I’ll include it.</p>
<h2 id="setting-up">Setting up</h2>
<p>First we’ll create a <code>composer.json</code> to specify our dependencies:</p>
<pre><code class="lang-json">{
    &quot;name&quot;: &quot;matthewbdaly/postcode-client&quot;,
    &quot;description&quot;: &quot;A postcode lookup client.&quot;,
    &quot;type&quot;: &quot;library&quot;,
    &quot;keywords&quot;: [&quot;postcode&quot;],
    &quot;require&quot;: {
        &quot;psr/http-message&quot;: &quot;^1.0&quot;,
        &quot;php-http/client-implementation&quot;: &quot;^1.0&quot;,
        &quot;php-http/httplug&quot;: &quot;^1.0&quot;,
        &quot;php-http/message-factory&quot;: &quot;^1.0&quot;,
        &quot;php-http/discovery&quot;: &quot;^1.0&quot;
    },
    &quot;require-dev&quot;: {
        &quot;psy/psysh&quot;: &quot;^0.8.0&quot;,
        &quot;phpspec/phpspec&quot;: &quot;^3.2&quot;,
        &quot;squizlabs/php_codesniffer&quot;: &quot;^2.7&quot;,
        &quot;php-http/mock-client&quot;: &quot;^1.0&quot;,
        &quot;php-http/message&quot;: &quot;^1.0&quot;,
        &quot;guzzlehttp/psr7&quot;: &quot;^1.0&quot;
    },
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;authors&quot;: [
        {
            &quot;name&quot;: &quot;Matthew Daly&quot;,
            &quot;email&quot;: &quot;matthewbdaly@gmail.com&quot;
        }
    ],
    &quot;autoload&quot;: {
        &quot;psr-4&quot;: {
            &quot;Matthewbdaly\\Postcode\\&quot;: &quot;src/&quot;
        }
    }
}
</code></pre>
<p>Note that we don’t install an actual HTTPlug client, other than the mock one, which is only useful for testing. This is deliberate - we’re giving developers working with this library the choice of working with whatever HTTP client they see fit. We do use the Guzzle PSR7 library, but that’s just for the PSR7 library.</p>
<p>Then we install our dependencies:</p>
<pre><code class="lang-bash">$ composer install
</code></pre>
<p>We also need to tell PHPSpec what our namespace will be. Save this as <code>phpspec.yml</code>:</p>
<pre><code class="lang-yml">suites:
    test_suite:
        namespace: Matthewbdaly\Postcode
        psr4_prefix: Matthewbdaly\Postcode
</code></pre>
<p>Don’t forget to update the namespace in both files to whatever you’re using, which should have a vendor name and a package name.</p>
<p>With that done, it’s time to introduce the next component.</p>
<h2 id="introducing-httplug">Introducing HTTPlug</h2>
<p>In the past I’ve usually used either Curl or Guzzle to carry out HTTP requests. However, the problem with this approach is that you’re forcing whoever uses your library to use whatever HTTP client, and whatever version of that client, that you deem appropriate. If they’re also using another library that someone else has written and they made different choices, you could have problems.</p>
<p>HTTPlug is an excellent way of solving this problem. By requiring only an interface and not a concrete implementation, using HTTPlug means that you can specify that the consumer of the library must provide a suitable implementation of that library, but leave the choice of implementation up to them. This means that they can choose whatever implementation best fits their use case. There are <a href="http://docs.php-http.org/en/latest/clients.html">adapters for many different clients</a>, so it’s unlikely that they won’t be able to find one that meets their needs.</p>
<p>In addition, HTTPlug provides the means to automatically determine what HTTP client to use, so that if one is not explicitly provided, it can be resolved without any action on the part of the developer. As long as a suitable HTTP adapter is installed, it will be used.</p>
<h2 id="getting-started">Getting started</h2>
<p>One advantage of PHPSpec is that it will automatically generate much of the boilerplate for our client and specs. To create our client spec, run this command:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec desc Matthewbdaly/Postcode/Client
Specification for Matthewbdaly\Postcode\Client created in /home/matthew/Projects/postcode-client/spec/ClientSpec.php.
</code></pre>
<p>Now that we have a spec for our client, we can generate the client itself:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                    
  11  - it is initializable
      class Matthewbdaly\Postcode\Client does not exist.

                                      100%                                       1
1 specs
1 example (1 broken)
14ms


  Do you want me to create `Matthewbdaly\Postcode\Client` for you?              
                                                                         [Y/n] 
y
Class Matthewbdaly\Postcode\Client created in /home/matthew/Projects/postcode-client/src/Client.php.

                                      100%                                       1
1 specs
1 example (1 passed)
16ms
</code></pre>
<p>You will need to enter <code>Y</code> when prompted. We now have an empty class for our client.</p>
<p>Next, we need to make sure that the constructor for our client accepts two parameters:</p>
<ul>
<li>The HTTP client</li>
<li>A message factory instance, which is used to create the request</li>
</ul>
<p>Amend <code>spec/ClientSpec.php</code> as follows:</p>
<pre><code class="lang-php">&lt;?php

namespace spec\Matthewbdaly\Postcode;

use Matthewbdaly\Postcode\Client;
use PhpSpec\ObjectBehavior;
use Prophecy\Argument;
use Http\Client\HttpClient;
use Http\Message\MessageFactory;

class ClientSpec extends ObjectBehavior
{
    function let (HttpClient $client, MessageFactory $messageFactory)
    {
        $this-&gt;beConstructedWith($client, $messageFactory);
    }

    function it_is_initializable()
    {
        $this-&gt;shouldHaveType(Client::class);
    }
}
</code></pre>
<p>Note the use of the <code>let()</code> method here. This lets us specify how the object is constructed, with the <code>beConstructedWith()</code> method. Also, note that <code>$this</code> refers not to the test, but to the object being tested - this takes a bit of getting used to if you’re used to working with PHPUnit.</p>
<p>Also, note that the objects passed through are not actual instances of those objects - instead they are mocks created automatically by PHPSpec. This makes mocking extremely easy, and you can easily set up your own expectations on those mock objects in the test. If you want to use a real object, you can instantiate it in the spec as usual. If we need any other mocks, we can typehint them in our method in exactly the same way.</p>
<p>If we once again use <code>vendor/bin/phpspec run</code> we can now generate a constructor:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                    
  18  - it is initializable
      method Matthewbdaly\Postcode\Client::__construct not found.

                                      100%                                       1
1 specs
1 example (1 broken)
281ms


  Do you want me to create `Matthewbdaly\Postcode\Client::__construct()` for    
  you?                                                                          
                                                                         [Y/n] 
y
  Method Matthewbdaly\Postcode\Client::__construct() has been created.

                                      100%                                       1
1 specs
1 example (1 passed)
50ms
</code></pre>
<p>This will only create a placeholder for the constructor. You need to populate it yourself, so update <code>src/Client.php</code> as follows:</p>
<pre><code class="lang-php">&lt;?php

namespace Matthewbdaly\Postcode;

use Http\Client\HttpClient;
use Http\Discovery\HttpClientDiscovery;
use Http\Message\MessageFactory;
use Http\Discovery\MessageFactoryDiscovery;

class Client
{
    public function __construct(HttpClient $client = null, MessageFactory $messageFactory = null)
    {
        $this-&gt;client = $client ?: HttpClientDiscovery::find();
        $this-&gt;messageFactory = $messageFactory ?: MessageFactoryDiscovery::find();
    }
}
</code></pre>
<p>A little explanation is called for here. We need two arguments in our construct:</p>
<ul>
<li>An instance of <code>Http\Client\HttpClient</code> to send the request</li>
<li>An instance of <code>Http\Message\MessageFactory</code> to create the request</li>
</ul>
<p>However, we don’t want to force the user to create one. Therefore if they are not set, we use <code>Http\Discovery\HttpClientDiscovery</code> and <code>Http\Discovery\MessageFactoryDiscovery</code> to create them for us.</p>
<p>If we re-run PHPSpec, it should now pass:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
                                      100%                                       1
1 specs
1 example (1 passed)
31ms
</code></pre>
<p>Next, we want to have a method for retrieving the endpoint. Add the following method to <code>spec/ClientSpec.php</code>:</p>
<pre><code class="lang-php">    function it_can_retrieve_the_base_url()
    {
        $this-&gt;getBaseUrl()-&gt;shouldReturn(&#39;https://api.ideal-postcodes.co.uk/v1/postcodes/&#39;);
    }
</code></pre>
<p>Here we’re asserting that fetching the base URL returns the given result. Note how much simpler and more intuitive this syntax is than PHPUnit would be:</p>
<pre><code class="lang-php">$this-&gt;assertEquals(&#39;https://api.ideal-postcodes.co.uk/v1/postcodes/&#39;, $client-&gt;getBaseUrl());
</code></pre>
<p>Running the tests again should prompt us to create the boilerplate for the new method:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                      
  23  - it can retrieve the base url
      method Matthewbdaly\Postcode\Client::getBaseUrl not found.

                  50%                                     50%                    2
1 specs
2 examples (1 passed, 1 broken)
40ms


  Do you want me to create `Matthewbdaly\Postcode\Client::getBaseUrl()` for     
  you?                                                                          
                                                                         [Y/n] 
y
  Method Matthewbdaly\Postcode\Client::getBaseUrl() has been created.

Matthewbdaly/Postcode/Client                                                      
  23  - it can retrieve the base url
      expected &quot;https://api.ideal-postcod...&quot;, but got null.

                  50%                                     50%                    2
1 specs
2 examples (1 passed, 1 failed)
72ms
</code></pre>
<p>Now we need to update that method to work as expected:</p>
<pre><code class="lang-php">    protected $baseUrl = &#39;https://api.ideal-postcodes.co.uk/v1/postcodes/&#39;;

     ...

    public function getBaseUrl()
    {
        return $this-&gt;baseUrl;
    }
</code></pre>
<p>This should make the tests pass:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
                                      100%                                       2
1 specs
2 examples (2 passed)
34ms
</code></pre>
<p>Next, we need to be able to get and set the API key. Add the following to <code>spec/ClientSpec.php</code>:</p>
<pre><code class="lang-php">    function it_can_get_and_set_the_key()
    {
        $this-&gt;getKey()-&gt;shouldReturn(null);
        $this-&gt;setKey(&#39;foo&#39;)-&gt;shouldReturn($this);
        $this-&gt;getKey()-&gt;shouldReturn(&#39;foo&#39;);
    }
</code></pre>
<p>Note that we expect <code>$this-&gt;setKey(&#39;foo&#39;)</code> to return <code>$this</code>. This is an example of a <em>fluent</em> interface - by returning an instance of the object, it enables methods to be chained, eg <code>$client-&gt;setKey(&#39;foo&#39;)-&gt;get()</code>. Obviously it won’t work for anything that has to return a value, but it’s a useful way of making your classes more intuitive to use.</p>
<p>Next, run the tests again and agree to the prompts as before:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                      
  28  - it can get and set the key
      method Matthewbdaly\Postcode\Client::getKey not found.

                         66%                                     33%             3
1 specs
3 examples (2 passed, 1 broken)
51ms


  Do you want me to create `Matthewbdaly\Postcode\Client::getKey()` for you?    
                                                                         [Y/n] 
y
  Method Matthewbdaly\Postcode\Client::getKey() has been created.

Matthewbdaly/Postcode/Client                                                      
  28  - it can get and set the key
      method Matthewbdaly\Postcode\Client::setKey not found.

                         66%                                     33%             3
1 specs
3 examples (2 passed, 1 broken)
43ms


  Do you want me to create `Matthewbdaly\Postcode\Client::setKey()` for you?    
                                                                         [Y/n] 
y
  Method Matthewbdaly\Postcode\Client::setKey() has been created.

Matthewbdaly/Postcode/Client                                                      
  28  - it can get and set the key
      expected [obj:Matthewbdaly\Postcode\Client], but got null.

                         66%                                     33%             3
1 specs
3 examples (2 passed, 1 failed)
52ms
</code></pre>
<p>Next, add our getter and setter for the key, as well as declaring the property <code>$key</code>:</p>
<pre><code class="lang-php">    protected $key;

    public function getKey()
    {
        return $this-&gt;key;
    }

    public function setKey(string $key)
    {
        $this-&gt;key = $key;
        return $this;
    }
</code></pre>
<p>That should make the tests pass:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
                                      100%                                       3
1 specs
3 examples (3 passed)
38ms
</code></pre>
<p>With that done, our final task is to be able to handle sending requests. Add the following imports at the top of <code>spec/ClientSpec.php</code>:</p>
<pre><code class="lang-php">use Psr\Http\Message\RequestInterface;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\StreamInterface;
</code></pre>
<p>And add the following method at the bottom of the same file:</p>
<pre><code class="lang-php">    function it_can_send_the_request(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)
    {
        $this-&gt;beConstructedWith($client, $messageFactory);
        $this-&gt;setKey(&#39;foo&#39;);
        $data = json_encode([
            &#39;result&#39; =&gt; [
                &quot;postcode&quot; =&gt; &quot;SW1A 2AA&quot;,
                &quot;postcode_inward&quot; =&gt; &quot;2AA&quot;,
                &quot;postcode_outward&quot; =&gt; &quot;SW1A&quot;,
                &quot;post_town&quot; =&gt; &quot;LONDON&quot;,
                &quot;dependant_locality&quot; =&gt; &quot;&quot;,
                &quot;double_dependant_locality&quot; =&gt; &quot;&quot;,
                &quot;thoroughfare&quot; =&gt; &quot;Downing Street&quot;,
                &quot;dependant_thoroughfare&quot; =&gt; &quot;&quot;,
                &quot;building_number&quot; =&gt; &quot;10&quot;,
                &quot;building_name&quot; =&gt; &quot;&quot;,
                &quot;sub_building_name&quot; =&gt; &quot;&quot;,
                &quot;po_box&quot; =&gt; &quot;&quot;,
                &quot;department_name&quot; =&gt; &quot;&quot;,
                &quot;organisation_name&quot; =&gt; &quot;Prime Minister &amp; First Lord Of The Treasury&quot;,
                &quot;udprn&quot; =&gt; 23747771,
                &quot;umprn&quot; =&gt; &quot;&quot;,
                &quot;postcode_type&quot; =&gt; &quot;L&quot;,
                &quot;su_organisation_indicator&quot; =&gt; &quot;&quot;,
                &quot;delivery_point_suffix&quot; =&gt; &quot;1A&quot;,
                &quot;line_1&quot; =&gt; &quot;Prime Minister &amp; First Lord Of The Treasury&quot;,
                &quot;line_2&quot; =&gt; &quot;10 Downing Street&quot;,
                &quot;line_3&quot; =&gt; &quot;&quot;,
                &quot;premise&quot; =&gt; &quot;10&quot;,
                &quot;longitude&quot; =&gt; -0.127695242183412,
                &quot;latitude&quot; =&gt; 51.5035398826274,
                &quot;eastings&quot; =&gt; 530047,
                &quot;northings&quot; =&gt; 179951,
                &quot;country&quot; =&gt; &quot;England&quot;,
                &quot;traditional_county&quot; =&gt; &quot;Greater London&quot;,
                &quot;administrative_county&quot; =&gt; &quot;&quot;,
                &quot;postal_county&quot; =&gt; &quot;London&quot;,
                &quot;county&quot; =&gt; &quot;London&quot;,
            ]
        ]);
        $messageFactory-&gt;createRequest(&#39;GET&#39;, &#39;https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo&#39;, [], null, &#39;1.1&#39;)-&gt;willReturn($request);
        $client-&gt;sendRequest($request)-&gt;willReturn($response);
        $response-&gt;getStatusCode()-&gt;willReturn(200);
        $response-&gt;getBody()-&gt;willReturn($stream);
        $stream-&gt;getContents()-&gt;willReturn($data);
        $this-&gt;get(&#39;SW1A 2AA&#39;)-&gt;shouldBeLike(json_decode($data, true));
    }
</code></pre>
<p>This test is by far the biggest so far, so it merits some degree of explanation.</p>
<p>Note that we don’t make a real HTTP request against the API. This may sound strange, but bear with me. We have no control whatsoever over that API, and it could in theory become inaccessible or be subject to breaking changes at any time. We also don’t want to be shelling out for a paid service just to test our API client works. All we can do is test that our implementation will send the request we expect it to send - we don’t want our test suite reporting a bug when the API goes down.</p>
<p>We therefore typehint not just the dependencies for the constructor, but a request, response and stream instance. We mock our our responses from those instances using the <code>willReturn()</code> method, so we have complete control over what we pass to our client. That way we can return any appropriate response or throw any exception we deem fit to test the behaviour under those circumstances. For the message factory, we specify what arguments it should receive to create the request, and return our mocked-out request object.</p>
<p>Also, note we use <code>shouldBeLike()</code> to verify the response - this is effectively using the <code>==</code> operator, whereas <code>shouldBe()</code> uses the <code>===</code> operator, making it stricter.</p>
<p>Let’s run the tests, and don’t forget the prompt:</p>
<pre><code class="lang-php">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                      
  38  - it can send the request
      method Matthewbdaly\Postcode\Client::get not found.

                            75%                                     25%          4
1 specs
4 examples (3 passed, 1 broken)
55ms


  Do you want me to create `Matthewbdaly\Postcode\Client::get()` for you?       
                                                                         [Y/n] 
y
  Method Matthewbdaly\Postcode\Client::get() has been created.

Matthewbdaly/Postcode/Client                                                      
  38  - it can send the request
      expected [array:1], but got null.

                            75%                                     25%          4
1 specs
4 examples (3 passed, 1 failed)
56ms
</code></pre>
<p>Now we can implement the <code>get()</code> method:</p>
<pre><code class="lang-php">    public function get(string $postcode)
    {
        $url = $this-&gt;getBaseUrl() . rawurlencode($postcode) . &#39;?&#39; . http_build_query([
            &#39;api_key&#39; =&gt; $this-&gt;getKey()
        ]);
        $request = $this-&gt;messageFactory-&gt;createRequest(
            &#39;GET&#39;,
            $url,
            [],
            null,
            &#39;1.1&#39;
        );
        $response = $this-&gt;client-&gt;sendRequest($request);
        $data = json_decode($response-&gt;getBody()-&gt;getContents(), true);
        return $data;
    }
</code></pre>
<p>We first build up our URL, before using the message factory to create a request object. We then pass the built request to our client to send, before decoding the response into the format we want.</p>
<p>This should make our tests pass:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
                                      100%                                       4
1 specs
4 examples (4 passed)
307ms
</code></pre>
<p>Our client now works, but there are a couple of situations we need to account for. First, the API will raise a 402 if you make a request for a real postcode without having paid. We need to catch this and throw an exception. Add this to <code>spec/ClientSpec.php</code>:</p>
<pre><code class="lang-php">use Matthewbdaly\Postcode\Exceptions\PaymentRequired;

    ...

    function it_throws_an_exception_if_payment_required(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)
    {
        $this-&gt;beConstructedWith($client, $messageFactory);
        $this-&gt;setKey(&#39;foo&#39;);
        $messageFactory-&gt;createRequest(&#39;GET&#39;, &#39;https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo&#39;, [], null, &#39;1.1&#39;)-&gt;willReturn($request);
        $client-&gt;sendRequest($request)-&gt;willReturn($response);
        $response-&gt;getStatusCode()-&gt;willReturn(402);
        $this-&gt;shouldThrow(PaymentRequired::class)-&gt;duringGet(&#39;SW1A 2AA&#39;);
    }
</code></pre>
<p>With that done, run the tests again:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                      
  87  - it throws an exception if payment required
      expected exception of class &quot;Matthewbdaly\Postcode\Exc...&quot;, but got
      [exc:Prophecy\Exception\Call\UnexpectedCallException(&quot;Method call:
        - getBody()
      on Double\ResponseInterface\P15 was not expected, expected calls were:
        - getStatusCode()&quot;)].

                              80%                                     20%        5
1 specs
5 examples (4 passed, 1 failed)
130ms
</code></pre>
<p>Let’s amend the client to throw this exception:</p>
<pre><code class="lang-php">use Matthewbdaly\Postcode\Exceptions\PaymentRequired;

    ...

    public function get(string $postcode)
    {
        $url = $this-&gt;getBaseUrl() . rawurlencode($postcode) . &#39;?&#39; . http_build_query([
            &#39;api_key&#39; =&gt; $this-&gt;getKey()
        ]);
        $request = $this-&gt;messageFactory-&gt;createRequest(
            &#39;GET&#39;,
            $url,
            [],
            null,
            &#39;1.1&#39;
        );
        $response = $this-&gt;client-&gt;sendRequest($request);
        if ($response-&gt;getStatusCode() == 402) {
            throw new PaymentRequired;
        }
        $data = json_decode($response-&gt;getBody()-&gt;getContents(), true);
        return $data;
    }
</code></pre>
<p>And let’s re-run the tests:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                    
  87  - it throws an exception if payment required
      expected exception of class &quot;Matthewbdaly\Postcode\Exc...&quot;, but got [obj:Error] with the
      message: &quot;Class &#39;Matthewbdaly\Postcode\Exceptions\PaymentRequired&#39; not found&quot;

                              80%                                     20%        5
1 specs
5 examples (4 passed, 1 failed)
389ms
</code></pre>
<p>It fails now because the exception doesn’t exist. Let’s create it at <code>src/Exceptions/PaymentRequired.php</code>:</p>
<pre><code class="lang-php">&lt;?php

namespace Matthewbdaly\Postcode\Exceptions;

class PaymentRequired extends \Exception
{
}
</code></pre>
<p>That should be enough to make our tests pass:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
                                      100%                                       5
1 specs
5 examples (5 passed)
89ms
</code></pre>
<p>We also need to raise an exception when the postcode is not found, which raises a 404 error. Add the following spec:</p>
<pre><code class="lang-php">use Matthewbdaly\Postcode\Exceptions\PostcodeNotFound;
    ...
    function it_throws_an_exception_if_postcode_not_found(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)
    {
        $this-&gt;beConstructedWith($client, $messageFactory);
        $this-&gt;setKey(&#39;foo&#39;);
        $messageFactory-&gt;createRequest(&#39;GET&#39;, &#39;https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo&#39;, [], null, &#39;1.1&#39;)-&gt;willReturn($request);
        $client-&gt;sendRequest($request)-&gt;willReturn($response);
        $response-&gt;getStatusCode()-&gt;willReturn(404);
        $this-&gt;shouldThrow(PostcodeNotFound::class)-&gt;duringGet(&#39;SW1A 2AA&#39;);
    }
</code></pre>
<p>Run the tests:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
Matthewbdaly/Postcode/Client                                                    
  98  - it throws an exception if postcode not found
      expected exception of class &quot;Matthewbdaly\Postcode\Exc...&quot;, but got
      [exc:Prophecy\Exception\Call\UnexpectedCallException(&quot;Method call:
        - getBody()
      on Double\ResponseInterface\P20 was not expected, expected calls were:
        - getStatusCode()&quot;)].

                                83%                                     16%      6
1 specs
6 examples (5 passed, 1 failed)
538ms
</code></pre>
<p>This time we’ll create the exception class before updating the client. Create the following class at <code>src/Exceptions/PostcodeNotFound.php</code>:</p>
<pre><code class="lang-php">&lt;?php

namespace Matthewbdaly\Postcode\Exceptions;

/**
 * Postcode not found exception
 *
 */
class PostcodeNotFound extends \Exception
{
}
</code></pre>
<p>And update the client:</p>
<pre><code class="lang-php">use Matthewbdaly\Postcode\Exceptions\PostcodeNotFound;
    ...
    public function get(string $postcode)
    {
        $url = $this-&gt;getBaseUrl() . rawurlencode($postcode) . &#39;?&#39; . http_build_query([
            &#39;api_key&#39; =&gt; $this-&gt;getKey()
        ]);
        $request = $this-&gt;messageFactory-&gt;createRequest(
            &#39;GET&#39;,
            $url,
            [],
            null,
            &#39;1.1&#39;
        );
        $response = $this-&gt;client-&gt;sendRequest($request);
        if ($response-&gt;getStatusCode() == 402) {
            throw new PaymentRequired;
        }
        if ($response-&gt;getStatusCode() == 404) {
            throw new PostcodeNotFound;
        }
        $data = json_decode($response-&gt;getBody()-&gt;getContents(), true);
        return $data;
    }
</code></pre>
<p>Re-run the tests:</p>
<pre><code class="lang-bash">$ vendor/bin/phpspec run
                                      100%                                       6
1 specs
6 examples (6 passed)
103ms
</code></pre>
<p>And our API client is feature complete! You can find the source code of the finished client <a href="https://github.com/matthewbdaly/postcode-client">here</a>.</p>
<h2 id="summary">Summary</h2>
<p>Personally, I find that while PHPSpec isn’t appropriate for every use case, it’s particularly handy for API clients and it’s generally my go-to testing solution for them. It handles producing a lot of the boilerplate for me, and it results in a much better workflow for test-driven development as it makes it very natural to write the test first, then make it pass.</p>
<p>HTTPlug has been a revelation for me. While it takes a bit of getting used to if you’re used to something like Guzzle, it means that you’re giving consumers of your library the freedom to choose the HTTP client of their choice, meaning they don’t have to fight with several different libraries requiring different versions of Guzzle. It also allows for easy resolution of the HTTP client, rather than having to explicitly pass through an instance when instantiating your client. I’m planning to use it extensively in the future.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Creating custom assertions with PHPUnit]]></title>
            <link>https://matthewdaly.co.uk/blog/2017/11/16/creating-custom-assertions-with-phpunit/</link>
            <guid>https://matthewdaly.co.uk/blog/2017/11/16/creating-custom-assertions-with-phpunit/</guid>
            <pubDate>Thu, 16 Nov 2017 15:15:50 GMT</pubDate>
            <description><![CDATA[<p>Today I’ve been working on a library I’m building for making it easier to build RESTful API’s with Laravel. It uses an abstract RESTful controller, which inherits from the default Laravel controller, and I wanted to verify that the instantiated controller includes all the traits from the base controller.</p>
<p>However, there was a problem. The only practical way to verify that a class includes a trait is with the <code>class_uses()</code> function, but this doesn’t work if the class inherits from a parent that includes these traits. As the class is abstract, it can’t be instantiated directly, so you must either create a dummy class just for testing that extends it, or mock the class, and that means that <code>class_uses()</code> won’t work. As a result, I needed to first get the parent class, then call <code>class_uses()</code> on that, which is possible, but a bit verbose to do repeatedly for several tests.</p>
<p>Fortunately it’s quite easy to create your own custom assertions in PHPUnit. I started out by setting up the test with the assertion I wanted to have:</p>
<pre><code class="lang-php">&lt;?php

namespace Tests\Unit\Http\Controllers;

use Tests\TestCase;
use Mockery as m;

class RestfulControllerTest extends TestCase
{
    public function testTraits()
    {
        $controller = m::mock(&#39;Matthewbdaly\Harmony\Http\Controllers\RestfulController&#39;)-&gt;makePartial();
        $this-&gt;assertParentHasTrait(&#39;Illuminate\Foundation\Bus\DispatchesJobs&#39;, $controller);
        $this-&gt;assertParentHasTrait(&#39;Illuminate\Foundation\Validation\ValidatesRequests&#39;, $controller);
        $this-&gt;assertParentHasTrait(&#39;Illuminate\Foundation\Auth\Access\AuthorizesRequests&#39;, $controller);
    }
}
</code></pre>
<p>Actually implementing the assertion is fairly straightforward. You simply add the assertion as a method on the base test case you’re using. and accept whatever arguments are required, plus a final argument of <code>$message = &#39;&#39;</code>. Then you call <code>self::assertThat()</code>, as demonstrated below:</p>
<pre><code class="lang-php">    public function assertParentHasTrait($trait, $class, $message = &#39;&#39;)
    {
        $parent = get_parent_class($class);
        $traits = class_uses($parent);
        self::assertThat(in_array($trait, $traits), self::isTrue(), $message);
    }
</code></pre>
<p>In this case we’re asserting that the specified trait appears in the list of traits on the parent class. Note the use of <code>self::isTrue()</code> - this just verifies that the response is truthy.</p>
<p>Using this method it’s quite easy to create custom assertions, which can help make your tests less verbose and easier to read.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Run your tests locally with Sismo]]></title>
            <link>https://matthewdaly.co.uk/blog/2017/08/19/run-your-tests-locally-with-sismo/</link>
            <guid>https://matthewdaly.co.uk/blog/2017/08/19/run-your-tests-locally-with-sismo/</guid>
            <pubDate>Sat, 19 Aug 2017 14:40:07 GMT</pubDate>
            <description><![CDATA[<p>Continuous integration is a veritable boon when working on any large software project. However, the popularity of distributed version control systems like Git over the older, more centralised ones like Subversion means that when you commit your changes, they don’t necessarily get pushed up to a remote repository immediately. While this is a good thing because it means you can commit at any stage without worrying about pushing up changes that break everyone else’s build, it has the downside that the tests aren’t automatically run on every commit, just every push, so if you get sloppy about running your tests before every commit you can more easily get caught out. In addition, a full CI server like Jenkins is a rather large piece of software that you don’t really want to run locally if you can help it, and has a lot of functionality you don’t need.</p>
<p><a href="https://sismo.symfony.com/">Sismo</a> is a small, simple continuous integration server, implemented in PHP, that’s ideal for running locally. You can set it up to run your tests on every commit, and it has an easy-to-use web interface. Although it’s a PHP application, there’s no reason why you couldn’t use it to run tests for projects in other languages, and because it’s focused solely on running your test suite without many of the other features of more advanced CI solutions, it’s a good fit for local use. Here I’ll show you how I use it.</p>
<h2 id="setting-up-sismo">Setting up Sismo</h2>
<p>Nowadays I don’t generally install a web server on a computer directly, preferring to use Vagrant or the dev server as appropriate, so Sismo generally doesn’t have to coexist with anything else. I normally install PHP7’s FastCGI implementation and Nginx, along with the SQLite bindings (which Sismo needs):</p>
<pre><code class="lang-bash">$ sudo apt-get install nginx php7.0-fpm php7.0-sqlite3
</code></pre>
<p>Then we can set up our Nginx config at <code>/etc/nginx/sites-available/default</code>:</p>
<pre><code class="lang-nginx">server {
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;
    fastcgi_param HTTP_PROXY &quot;&quot;;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    root /var/www/html;
    index sismo.php index.html index.htm;

    server_name server_domain_or_IP;

    location / {
        try_files $uri $uri/ /sismo.php?$query_string;
    }

    location ~ \.php$ {
        try_files $uri /sismo.php =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
        fastcgi_index sismo.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param SISMO_DATA_PATH &quot;/home/matthew/.sismo/data&quot;;
        fastcgi_param SISMO_CONFIG_PATH &quot;/home/matthew/.sismo/config.php&quot;;
        include fastcgi_params;
    }
}
</code></pre>
<p>You’ll probably want to adjust the paths as appropriate. Then set up the required folders:</p>
<pre><code class="lang-bash">$ mkdir ~/.sismo
$ mkdir ~/.sismo/data
$ touch ~/.sismo/config.php
$ chmod -R a+w ~/.sismo/
</code></pre>
<p>Then, <a href="https://sismo.symfony.com/get/sismo.php">download Sismo</a> and put it in your web root (here it’s at <code>/var/www/html/sismo.php</code>).</p>
<p>Now, say you have a project you want to test (I’m using my <a href="https://github.com/matthewbdaly/laravel-etag-middleware">Laravel ETag middleware</a> for this example). We need to specify the projects we want to test in <code>~/.sismo/config.php</code>:</p>
<pre><code class="lang-php">&lt;?php

$projects = array();

$notifier = new Sismo\Notifier\DBusNotifier();

Sismo\Project::setDefaultCommand(&#39;if [ -f composer.json ]; then composer install; fi &amp;&amp; vendor/bin/phpunit&#39;);

$projects[] = new Sismo\GithubProject(&#39;Laravel ETag Middleware&#39;, &#39;/home/matthew/Projects/laravel-etag-middleware&#39;, $notifier);

return $projects;
</code></pre>
<p>Hopefully this shouldn’t be too difficult to understand. We create an array of projects, then specify a notifier (this is Linux-specific - refer to the documentation for using Growl on Mac OS). Next, we specify that by default the tests should run <code>composer install</code> followed by <code>vendor/bin/phpunit</code>. We then specify this project is a Github project - it also supports Bitbucket, or plain SSH, or the default Project, but in general it shouldn’t be a problem to use it with any repository as you can just run it against the local copy. Finally we return the list of projects.</p>
<p>Now, we should be able to run our tests as follows:</p>
<pre><code class="lang-bash">$ php /var/www/html/sismo.php build
Building Project &quot;Laravel ETag Middleware&quot; (into &quot;68a087&quot;)
</code></pre>
<p>That should be working, but it doesn’t get us anything we don’t get by running the tests ourselves. To trigger the build, we need to set up a post-commit hook for our project in <code>.git/hooks/post-commit</code>:</p>
<pre><code class="lang-bash">#!/bin/sh

php /var/www/html/sismo.php --quiet --force build laravel-etag-middleware `git log -1 HEAD --pretty=&quot;%H&quot;` &amp;&gt;/dev/null &amp;
</code></pre>
<p>You should now be able to view your project in the Sismo web interface at <a href="http://localhost">http://localhost</a>:</p>
<p><img src="/static/images/sismo-screenshot.png" alt="Sismo"></p>
<p>Clicking on the project should take you through to its build history:</p>
<p><img src="/static/images/sismo-screenshot2.png" alt="Sismo project page"></p>
<p>From here on, it should be straightforward to add new projects as and when necessary. Because you can change the command on a per-project basis, you can quite happily use it to run tests for Python or Node.js projects as well as PHP ones, and it’s not hard to configure it.</p>
<p>I personally find it very useful to have something in place to run my tests on every commit like this, and while you could just use a post-commit hook for that, this approach is less obtrusive because it doesn’t force you to wait around for your test suite to finish.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Snapshot test your Vue components with Jest]]></title>
            <link>https://matthewdaly.co.uk/blog/2017/06/17/snapshot-test-your-vue-components-with-jest/</link>
            <guid>https://matthewdaly.co.uk/blog/2017/06/17/snapshot-test-your-vue-components-with-jest/</guid>
            <pubDate>Sat, 17 Jun 2017 13:12:02 GMT</pubDate>
            <description><![CDATA[<p>At work I’ve recently started using <a href="https://vuejs.org/">Vue</a> as my main front-end framework instead of Angular 1. It has a relatively shallow learning curve and has enough similarities with both React and Angular 1 that if you’re familiar with one or both of them it feels quite familiar. We’re a Laravel shop and Laravel comes out of the box with a basic scaffolding for using Vue, so not only is it the path of least resistance, but many of my colleagues knew it already and it’s used on some existing projects (one of which I’ve been helping out on this week), so it made sense to learn it. Add to that the fact that the main alternative is Angular 2, which I vehemently dislike, and learning Vue was a no-brainer.</p>
<p><a href="https://facebook.github.io/jest/docs/snapshot-testing.html">Snapshot tests</a> are a really useful way of making sure your user interface doesn’t change unexpectedly. Facebook introduced them to their Jest testing framework last year, and they’ve started to appear in other testing frameworks too. In their words…</p>
<blockquote>
<p>A typical snapshot test case for a mobile app renders a UI component, takes a screenshot, then compares it to a reference image stored alongside the test. The test will fail if the two images do not match: either the change is unexpected, or the screenshot needs to be updated to the new version of the UI component.</p>
</blockquote>
<p>This makes it easy to make sure than a UI component, such as a React or Vue component, does not unexpectedly change how it is rendered. In the event that it does change, it will fail the test, and it’s up to the developer to confirm whether or not that’s expected - if so they can generate a new version of the snapshot and be on their way. Without it, you’re stuck manually testing that the right HTML tags get generated, which is a chore.</p>
<p>Jest’s documentation is aimed pretty squarely at React, but it’s not hard to adapt it to work with Vue components. Here I’ll show you how I got it working with Vue.</p>
<h2 id="setting-up-a-new-project">Setting up a new project</h2>
<p>I used the <a href="https://github.com/vuejs/vue-cli">Vue CLI</a> boilerplate generator to set up my initial dependencies for this project. I then had to install some further packages:</p>
<pre><code class="lang-bash">$ npm install --save-dev jest babel-jest jest-vue-preprocessor
</code></pre>
<p>After that, I had to configure Jest to work with Vue. The finished <code>package.json</code> looked like this:</p>
<pre><code class="lang-json">{
  &quot;name&quot;: &quot;myproject&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;A project&quot;,
  &quot;author&quot;: &quot;Matthew Daly &lt;matthew@matthewdaly.co.uk&gt;&quot;,
  &quot;private&quot;: true,
  &quot;scripts&quot;: {
    &quot;dev&quot;: &quot;node build/dev-server.js&quot;,
    &quot;start&quot;: &quot;node build/dev-server.js&quot;,
    &quot;build&quot;: &quot;node build/build.js&quot;,
    &quot;lint&quot;: &quot;eslint --ext .js,.vue src&quot;,
    &quot;test&quot;: &quot;jest __test__/ --coverage&quot;
  },
  &quot;dependencies&quot;: {
    &quot;vue&quot;: &quot;^2.3.3&quot;,
    &quot;vue-router&quot;: &quot;^2.3.1&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;autoprefixer&quot;: &quot;^6.7.2&quot;,
    &quot;babel-core&quot;: &quot;^6.22.1&quot;,
    &quot;babel-eslint&quot;: &quot;^7.1.1&quot;,
    &quot;babel-jest&quot;: &quot;^20.0.3&quot;,
    &quot;babel-loader&quot;: &quot;^6.2.10&quot;,
    &quot;babel-plugin-transform-runtime&quot;: &quot;^6.22.0&quot;,
    &quot;babel-preset-env&quot;: &quot;^1.3.2&quot;,
    &quot;babel-preset-stage-2&quot;: &quot;^6.22.0&quot;,
    &quot;babel-register&quot;: &quot;^6.22.0&quot;,
    &quot;chalk&quot;: &quot;^1.1.3&quot;,
    &quot;connect-history-api-fallback&quot;: &quot;^1.3.0&quot;,
    &quot;copy-webpack-plugin&quot;: &quot;^4.0.1&quot;,
    &quot;css-loader&quot;: &quot;^0.28.0&quot;,
    &quot;eslint&quot;: &quot;^3.19.0&quot;,
    &quot;eslint-config-standard&quot;: &quot;^6.2.1&quot;,
    &quot;eslint-friendly-formatter&quot;: &quot;^2.0.7&quot;,
    &quot;eslint-loader&quot;: &quot;^1.7.1&quot;,
    &quot;eslint-plugin-html&quot;: &quot;^2.0.0&quot;,
    &quot;eslint-plugin-promise&quot;: &quot;^3.4.0&quot;,
    &quot;eslint-plugin-standard&quot;: &quot;^2.0.1&quot;,
    &quot;eventsource-polyfill&quot;: &quot;^0.9.6&quot;,
    &quot;express&quot;: &quot;^4.14.1&quot;,
    &quot;extract-text-webpack-plugin&quot;: &quot;^2.0.0&quot;,
    &quot;file-loader&quot;: &quot;^0.11.1&quot;,
    &quot;friendly-errors-webpack-plugin&quot;: &quot;^1.1.3&quot;,
    &quot;html-webpack-plugin&quot;: &quot;^2.28.0&quot;,
    &quot;http-proxy-middleware&quot;: &quot;^0.17.3&quot;,
    &quot;jest&quot;: &quot;^20.0.4&quot;,
    &quot;jest-vue-preprocessor&quot;: &quot;^1.0.1&quot;,
    &quot;opn&quot;: &quot;^4.0.2&quot;,
    &quot;optimize-css-assets-webpack-plugin&quot;: &quot;^1.3.0&quot;,
    &quot;ora&quot;: &quot;^1.2.0&quot;,
    &quot;rimraf&quot;: &quot;^2.6.0&quot;,
    &quot;semver&quot;: &quot;^5.3.0&quot;,
    &quot;shelljs&quot;: &quot;^0.7.6&quot;,
    &quot;url-loader&quot;: &quot;^0.5.8&quot;,
    &quot;vue-loader&quot;: &quot;^12.1.0&quot;,
    &quot;vue-style-loader&quot;: &quot;^3.0.1&quot;,
    &quot;vue-template-compiler&quot;: &quot;^2.3.3&quot;,
    &quot;webpack&quot;: &quot;^2.6.1&quot;,
    &quot;webpack-bundle-analyzer&quot;: &quot;^2.2.1&quot;,
    &quot;webpack-dev-middleware&quot;: &quot;^1.10.0&quot;,
    &quot;webpack-hot-middleware&quot;: &quot;^2.18.0&quot;,
    &quot;webpack-merge&quot;: &quot;^4.1.0&quot;
  },
  &quot;engines&quot;: {
    &quot;node&quot;: &quot;&gt;= 4.0.0&quot;,
    &quot;npm&quot;: &quot;&gt;= 3.0.0&quot;
  },
  &quot;browserslist&quot;: [
    &quot;&gt; 1%&quot;,
    &quot;last 2 versions&quot;,
    &quot;not ie &lt;= 8&quot;
  ],
  &quot;jest&quot;: {
    &quot;testRegex&quot;: &quot;spec.js$&quot;,
    &quot;moduleFileExtensions&quot;: [
      &quot;js&quot;,
      &quot;vue&quot;
    ],
    &quot;transform&quot;: {
      &quot;^.+\\.js$&quot;: &quot;&lt;rootDir&gt;/node_modules/babel-jest&quot;,
      &quot;.*\\.(vue)$&quot;: &quot;&lt;rootDir&gt;/node_modules/jest-vue-preprocessor&quot;
    }
  }
}
</code></pre>
<p>I won’t include things like the Webpack config, because that’s all generated by Vue CLI. Note that we need to tell Jest what file extensions it should work with, including <code>.vue</code>, and we need to specify the appropriate transforms for different types of files. We use <code>jest-vue-preprocessor</code> for <code>.vue</code> files and <code>babel-jest</code> for <code>.js</code> files.</p>
<p>With that done, we can create a basic component. We’ll assume we’re writing a simple issue tracker here, and our first component will be at <code>src/components/Issue.vue</code>:</p>
<pre><code class="lang-html">&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;An Issue&lt;/h1&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data () {
    return {}
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
&lt;/style&gt;
</code></pre>
<p>Next, we create a simple test for this component. Save this as <code>__test__/components/issue.spec.js</code>:</p>
<pre><code class="lang-javascript">import Issue from &#39;../../src/components/Issue.vue&#39;
import Vue from &#39;vue&#39;

const Constructor = Vue.extend(Issue)
const vm = new Constructor().$mount()

describe(&#39;Issue&#39;, () =&gt; {
  it(&#39;should render&#39;, () =&gt; {
    expect(vm.$el.querySelector(&#39;h1&#39;).textContent).toEqual(&#39;An Issue&#39;)
  });

  it(&#39;should match the snapshot&#39;, () =&gt; {
    expect(vm.$el).toMatchSnapshot()
  });
});
</code></pre>
<p><code>Constructor</code> is what creates our Vue component, while <code>vm</code> is our actual newly-mounted Vue component. We can refer to the HTML inside the component through <code>vm.$el</code>, so we can then work with the virtual DOM easily.</p>
<p>In the first test we use the more traditional method of verifying our UI component has worked as expected - we fetch an HTML tag inside it and verify that the content inside is what we expect. This is fine for a small component, but as the components get larger we’ll find it more of a chore.</p>
<p>The second test is much simpler and more concise. We simply assert that it matches the snapshot. Not only is that easier, but it can scale to components of any size because we don’t have to check every little element.</p>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">$ npm test

&gt; myproject@1.0.0 test /home/matthew/Projects/myproject
&gt; jest __test__/ --coverage

 PASS  __test__/components/issue.spec.js
  Issue
    ✓ should render (46ms)
    ✓ should match the snapshot (14ms)

Snapshot Summary
 › 1 snapshot written in 1 test suite.

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   1 added, 1 total
Time:        8.264s
Ran all test suites matching &quot;__test__/&quot;.
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
All files                                                  |    96.15 |       50 |      100 |       96 |                |
 root                                                      |      100 |      100 |      100 |      100 |                |
  unknown                                                  |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |
  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |
  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
</code></pre>
<p>Note this section:</p>
<pre><code class="lang-bash">Snapshot Summary
 › 1 snapshot written in 1 test suite.
</code></pre>
<p>This tells us that the snapshot has been successfully written. If we run the tests again we should see that it checks against the existing snapshot:</p>
<pre><code class="lang-bash">$ npm test

&gt; myproject@1.0.0 test /home/matthew/Projects/myproject
&gt; jest __test__/ --coverage

 PASS  __test__/components/issue.spec.js
  Issue
    ✓ should render (40ms)
    ✓ should match the snapshot (12ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   1 passed, 1 total
Time:        3.554s
Ran all test suites matching &quot;__test__/&quot;.
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
All files                                                  |    96.15 |       50 |      100 |       96 |                |
 root                                                      |      100 |      100 |      100 |      100 |                |
  unknown                                                  |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |
  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |
  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
</code></pre>
<p>Great stuff. Now, if we make a minor change to our component, such as changing the text from <code>An Issue</code> to <code>My Issue</code>, does it pick that up?</p>
<pre><code class="lang-bash">$ npm test

&gt; myproject@1.0.0 test /home/matthew/Projects/myproject
&gt; jest __test__/ --coverage

 FAIL  __test__/components/issue.spec.js (5.252s)
  ● Issue › should render

    expect(received).toEqual(expected)

    Expected value to equal:
      &quot;An Issue&quot;
    Received:
      &quot;My Issue&quot;

      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:9:52)
      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)

  ● Issue › should match the snapshot

    expect(value).toMatchSnapshot()

    Received value does not match stored snapshot 1.

    - Snapshot
    + Received

     &lt;div&gt;
       &lt;h1&gt;
    -    An Issue
    +    My Issue
       &lt;/h1&gt;
     &lt;/div&gt;

      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:13:20)
      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)

  Issue
    ✕ should render (48ms)
    ✕ should match the snapshot (25ms)

Snapshot Summary
 › 1 snapshot test failed in 1 test suite. Inspect your code changes or run with `npm test -- -u` to update them.

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 total
Snapshots:   1 failed, 1 total
Time:        7.082s
Ran all test suites matching &quot;__test__/&quot;.
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
All files                                                  |    96.15 |       50 |      100 |       96 |                |
 root                                                      |      100 |      100 |      100 |      100 |                |
  unknown                                                  |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |
  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |
  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
</code></pre>
<p>Yes, we can see that it’s picked up on the change and thrown an error. Note this line:</p>
<pre><code class="lang-bash"> › 1 snapshot test failed in 1 test suite. Inspect your code changes or run with `npm test -- -u` to update them.
</code></pre>
<p>Jest is telling us that our snapshot has changed, but if we expect that, we can just run <code>npm test -- -u</code> to replace the existing one with our new one. Then, our tests will pass again.</p>
<p>Now, this component is pretty useless. It doesn’t accept any external input whatsoever, so the response is always going to be the same. How do we test a more dynamic component? Amend the component to look like this:</p>
<pre><code class="lang-html">&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;{{ issue.name }}&lt;/h1&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  props: {
    issue: Object
  },
  data () {
    return {}
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
&lt;/style&gt;
</code></pre>
<p>We’re now passing the <code>issue</code> object into our component as a prop, and getting the name from that. That will break our test, so we need to amend it to pass through the props:</p>
<pre><code class="lang-javascript">import Issue from &#39;../../src/components/Issue.vue&#39;
import Vue from &#39;vue&#39;

const Constructor = Vue.extend(Issue)
const issue = {
  name: &#39;My Issue&#39;
}
const vm = new Constructor({
  propsData: { issue: issue }
}).$mount()

describe(&#39;Issue&#39;, () =&gt; {
  it(&#39;should render&#39;, () =&gt; {
    expect(vm.$el.querySelector(&#39;h1&#39;).textContent).toEqual(&#39;My Issue&#39;)
  });

  it(&#39;should match the snapshot&#39;, () =&gt; {
    expect(vm.$el).toMatchSnapshot()
  });
});
</code></pre>
<p>Here we pass our prop into the constructor for the component. Now, let’s run the tests again:</p>
<pre><code class="lang-bash">$ npm test

&gt; myproject@1.0.0 test /home/matthew/Projects/myproject
&gt; jest __test__/ --coverage

 FAIL  __test__/components/issue.spec.js
  ● Issue › should match the snapshot

    expect(value).toMatchSnapshot()

    Received value does not match stored snapshot 1.

    - Snapshot
    + Received

     &lt;div&gt;
       &lt;h1&gt;
    -    An Issue
    +    My Issue
       &lt;/h1&gt;
     &lt;/div&gt;

      at Object.&lt;anonymous&gt; (__test__/components/issue.spec.js:18:20)
      at Promise.resolve.then.el (node_modules/p-map/index.js:42:16)

  Issue
    ✓ should render (39ms)
    ✕ should match the snapshot (25ms)

Snapshot Summary
 › 1 snapshot test failed in 1 test suite. Inspect your code changes or run with `npm test -- -u` to update them.

Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 passed, 2 total
Snapshots:   1 failed, 1 total
Time:        3.717s
Ran all test suites matching &quot;__test__/&quot;.
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
All files                                                  |     96.3 |       50 |      100 |    96.15 |                |
 root                                                      |      100 |      100 |      100 |      100 |                |
  unknown                                                  |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |
  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |
  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
</code></pre>
<p>Jest has picked up on our changes and thrown an error. However, because we know the UI has changed, we’re happy with this situation, so we can tell Jest to replace the prior snapshot with <code>npm test -- -u</code> as mentioned earlier:</p>
<pre><code class="lang-bash">$ npm test -- -u

&gt; myproject@1.0.0 test /home/matthew/Projects/myproject
&gt; jest __test__/ --coverage &quot;-u&quot;

 PASS  __test__/components/issue.spec.js
  Issue
    ✓ should render (39ms)
    ✓ should match the snapshot (14ms)

Snapshot Summary
 › 1 snapshot updated in 1 test suite.

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   1 updated, 1 total
Time:        3.668s
Ran all test suites matching &quot;__test__/&quot;.
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
File                                                       |  % Stmts | % Branch |  % Funcs |  % Lines |Uncovered Lines |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
All files                                                  |     96.3 |       50 |      100 |    96.15 |                |
 root                                                      |      100 |      100 |      100 |      100 |                |
  unknown                                                  |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/__test__/components  |      100 |      100 |      100 |      100 |                |
  issue.spec.js                                            |      100 |      100 |      100 |      100 |                |
 root/home/matthew/Projects/myproject/src/components       |    94.44 |       50 |      100 |    94.12 |                |
  Issue.vue                                                |    94.44 |       50 |      100 |    94.12 |             39 |
-----------------------------------------------------------|----------|----------|----------|----------|----------------|
</code></pre>
<p>Great, we now have a passing test suite again! That’s all we need to make sure that any regressions in the generated HTML of a component get caught.</p>
<p>Of course, this won’t help with the actual functionality of the component. However, Jest is pretty easy to use to write tests for the actual functionality of the application. If you prefer another testing framework, it’s possible to do the same with them, although I will leave setting them up as an exercise for the reader.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Integrating Behat with Laravel]]></title>
            <link>https://matthewdaly.co.uk/blog/2017/02/18/integrating-behat-with-laravel/</link>
            <guid>https://matthewdaly.co.uk/blog/2017/02/18/integrating-behat-with-laravel/</guid>
            <pubDate>Sat, 18 Feb 2017 21:25:57 GMT</pubDate>
            <description><![CDATA[<p>The Gherkin format used by tools like Cucumber is a really great way of specifying how your application will work. It’s easy for even non-technical stakeholders to understand, it makes it natural to break your tests into easily reusable steps, and it encourages you to think about the application from an end-user’s perspective. It’s also one of the easiest ways to get started writing automated tests when you first start out - it’s much more intuitive to a junior developer than lower-level unit tests, and is easier to add to a legacy project that may not have been built with testability in mind - if you can drive a browser, you can test it.</p>
<p><a href="http://behat.org/en/latest/">Behat</a> is a PHP equivalent. Combined with <a href="http://mink.behat.org/en/latest/">Mink</a>, it allows for easy automated acceptance tests of a PHP application. However, out of the box it doesn’t integrate well with Laravel. There is <a href="https://github.com/laracasts/Behat-Laravel-Extension">Jeffrey Way’s Behat Laravel extension</a>, but it doesn’t seem to be actively maintained and seems to be overkill for this purpose. I wanted something that I could use to run integration tests using PHPUnit’s assertions and Laravel’s testing utilities, and crucially, I wanted to do so as quickly as possible. That meant running a web server and using an automated web browser wasn’t an option. Also, I often work on REST API’s, and browser testing isn’t appropriate for those - in API tests I’m more interested in setting up the fixtures, making a single request, and verifying that it does what it’s meant to do, as quickly as possible.</p>
<p>As it turns out, integrating Behat and Laravel isn’t that hard. When using Behat, your <code>FeatureContext.php</code> file must implement the <code>Behat\Behat\Context\Context</code> interface, but as this interface does not implement any methods, you can extend any existing class and declare that it implements that interface. That means we can just extend the existing <code>Tests\TestCase</code> class in Laravel 5.4 and gain access to all the same testing utilities we have in our regular Laravel tests.</p>
<p>Then, in the constructor we can set environment variables using <code>putenv()</code> so that we can set it up to use an in-memory SQLite database for faster tests. We also use the <code>@BeforeScenario</code> hook to migrate the database before each scenario, and the <code>@AfterScenario</code> hook to roll it back afterwards.</p>
<p>Here’s the finished example:</p>
<pre><code class="lang-php">&lt;?php

use Behat\Behat\Context\Context;
use Behat\Gherkin\Node\PyStringNode;
use Behat\Gherkin\Node\TableNode;
use Tests\TestCase;
use Behat\Behat\Tester\Exception\PendingException;
use Illuminate\Foundation\Testing\DatabaseMigrations;
use App\User;
use Behat\Behat\Hook\Scope\BeforeScenarioScope;
use Behat\Behat\Hook\Scope\AfterScenarioScope;
use Illuminate\Contracts\Console\Kernel;

/**
 * Defines application features from the specific context.
 */
class FeatureContext extends TestCase implements Context
{
    use DatabaseMigrations;

    protected $content;

    /**
     * Initializes context.
     *
     * Every scenario gets its own context instance.
     * You can also pass arbitrary arguments to the
     * context constructor through behat.yml.
     */
    public function __construct()
    {
        putenv(&#39;DB_CONNECTION=sqlite&#39;);
        putenv(&#39;DB_DATABASE=:memory:&#39;);
        parent::setUp();
    }

    /** @BeforeScenario */
    public function before(BeforeScenarioScope $scope)
    {
        $this-&gt;artisan(&#39;migrate&#39;);

        $this-&gt;app[Kernel::class]-&gt;setArtisan(null);
    }

    /** @AfterScenario */
    public function after(AfterScenarioScope $scope)
    {
        $this-&gt;artisan(&#39;migrate:rollback&#39;);
    }

    /**
     * @Given I visit the path :path
     */
    public function iVisitThePath($path)
    {
        $response = $this-&gt;get(&#39;/&#39;);
        $this-&gt;assertEquals(200, $response-&gt;getStatusCode());
        $this-&gt;content = $response-&gt;getContent();
    }

    /**
     * @Then I should see the text :text
     */
    public function iShouldSeeTheText($text)
    {
        $this-&gt;assertContains($text, $this-&gt;content);
    }

    /**
     * @Given a user called :user exists
     */
    public function aUserCalledExists($user)
    {
        $user = factory(App\User::class)-&gt;create([
            &#39;name&#39; =&gt; $user,
        ]);
    }

    /**
     * @Given I am logged in as :user
     */
    public function iAmLoggedInAs($user)
    {
        $user = User::where(&#39;name&#39;, $user)-&gt;first();
        $this-&gt;be($user);
    }

}
</code></pre>
<p>Note that I’ve added a few basic example methods for our tests. As you can see, we can call the same methods we normally use in Laravel tests to make assertions and HTTP requests. If you’re using Dusk, you can also call that in the same way you usually would.</p>
<p>We might then write the following feature file to demonstrate our application at work:</p>
<pre><code class="lang-gherkin">Feature: Login

    Background:
        Given a user called &quot;Alan&quot; exists
        And a user called &quot;Bob&quot; exists
        And a user called &quot;Clare&quot; exists
        And a user called &quot;Derek&quot; exists
        And a user called &quot;Eric&quot; exists

    Scenario: Log in as Alan
        Given I am logged in as &quot;Alan&quot;
        And I visit the path &quot;/&quot;
        Then I should see the text &quot;Laravel&quot;

    Scenario: Log in as Bob
        Given I am logged in as &quot;Bob&quot;
        And I visit the path &quot;/&quot;
        Then I should see the text &quot;Laravel&quot;

    Scenario: Log in as Clare
        Given I am logged in as &quot;Clare&quot;
        And I visit the path &quot;/&quot;
        Then I should see the text &quot;Laravel&quot;

    Scenario: Log in as Derek
        Given I am logged in as &quot;Derek&quot;
        And I visit the path &quot;/&quot;
        Then I should see the text &quot;Laravel&quot;

    Scenario: Log in as Eric
        Given I am logged in as &quot;Eric&quot;
        And I visit the path &quot;/&quot;
        Then I should see the text &quot;Laravel&quot;
</code></pre>
<p>We can then run these tests with <code>vendor/bin/behat</code>:</p>
<pre><code class="lang-bash">$ vendor/bin/behat 
Feature: Login

  Background:                         # features/auth.feature:3
    Given a user called &quot;Alan&quot; exists # FeatureContext::aUserCalledExists()
    And a user called &quot;Bob&quot; exists    # FeatureContext::aUserCalledExists()
    And a user called &quot;Clare&quot; exists  # FeatureContext::aUserCalledExists()
    And a user called &quot;Derek&quot; exists  # FeatureContext::aUserCalledExists()
    And a user called &quot;Eric&quot; exists   # FeatureContext::aUserCalledExists()

  Scenario: Log in as Alan               # features/auth.feature:10
    Given I am logged in as &quot;Alan&quot;       # FeatureContext::iAmLoggedInAs()
    And I visit the path &quot;/&quot;             # FeatureContext::iVisitThePath()
    Then I should see the text &quot;Laravel&quot; # FeatureContext::iShouldSeeTheText()

  Scenario: Log in as Bob                # features/auth.feature:15
    Given I am logged in as &quot;Bob&quot;        # FeatureContext::iAmLoggedInAs()
    And I visit the path &quot;/&quot;             # FeatureContext::iVisitThePath()
    Then I should see the text &quot;Laravel&quot; # FeatureContext::iShouldSeeTheText()

  Scenario: Log in as Clare              # features/auth.feature:20
    Given I am logged in as &quot;Clare&quot;      # FeatureContext::iAmLoggedInAs()
    And I visit the path &quot;/&quot;             # FeatureContext::iVisitThePath()
    Then I should see the text &quot;Laravel&quot; # FeatureContext::iShouldSeeTheText()

  Scenario: Log in as Derek              # features/auth.feature:25
    Given I am logged in as &quot;Derek&quot;      # FeatureContext::iAmLoggedInAs()
    And I visit the path &quot;/&quot;             # FeatureContext::iVisitThePath()
    Then I should see the text &quot;Laravel&quot; # FeatureContext::iShouldSeeTheText()

  Scenario: Log in as Eric               # features/auth.feature:30
    Given I am logged in as &quot;Eric&quot;       # FeatureContext::iAmLoggedInAs()
    And I visit the path &quot;/&quot;             # FeatureContext::iVisitThePath()
    Then I should see the text &quot;Laravel&quot; # FeatureContext::iShouldSeeTheText()

5 scenarios (5 passed)
40 steps (40 passed)
0m0.50s (19.87Mb)
</code></pre>
<p>Higher level tests can get very tedious if you’re not careful - you wind up setting up the same fixtures and making the same requests many times over. By using Behat in this way, not only are you writing your tests in a way that is easy to understand, but you’re also breaking it down into logical, repeatable steps, and by passing arguments in each step you limit the amount of repetition. It’s also fast if you aren’t running browser-based tests, making it particularly well-suited to API testing.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Writing faster Laravel tests]]></title>
            <link>https://matthewdaly.co.uk/blog/2016/04/04/writing-faster-laravel-tests/</link>
            <guid>https://matthewdaly.co.uk/blog/2016/04/04/writing-faster-laravel-tests/</guid>
            <pubDate>Mon, 04 Apr 2016 19:55:15 GMT</pubDate>
            <description><![CDATA[<p>Nowadays, Laravel tends to be my go-to PHP framework, to the point that we use it as our default framework at work. A big part of this is that Laravel is relatively easy to test, making practicing TDD a lot easier.</p>
<p>Out of the box running Laravel tests can be quite slow, which is a big issue - if your test suite takes several minutes to run, that’s a huge disruption. Also, Laravel doesn’t create a dedicated test database - instead it runs the tests against the same database you’re using normally, which is almost always not what you want. I’ll show you how to set up a dedicated test database, and how to use an in-memory SQLite database for faster tests. This results in cleaner and easier-to-maintain tests, since you can be sure the test database is restored to a clean state at the end of every test.</p>
<h2 id="setup">Setup</h2>
<p>Our first step is to make sure that when a new test begins, the following should happen:</p>
<ul>
<li>We should create a new transaction</li>
<li>We should empty and migrate our database</li>
</ul>
<p>Then, at the end of each test:</p>
<ul>
<li>We should roll back our transaction to restore the database to its prior state</li>
</ul>
<p>To do so, we can create custom <code>setUp()</code> and <code>tearDown()</code> methods for our base <code>TestCase</code> class. Save this in <code>tests/TestCase.php</code>:</p>
<pre><code class="lang-php">&lt;?php

class TestCase extends Illuminate\Foundation\Testing\TestCase
{
    /**
     * The base URL to use while testing the application.
     *
     * @var string
     */
    protected $baseUrl = &#39;http://localhost&#39;;
    /**
     * Creates the application.
     *
     * @return \Illuminate\Foundation\Application
     */
    public function createApplication()
    {
        $app = require __DIR__.&#39;/../bootstrap/app.php&#39;;
        $app-&gt;make(Illuminate\Contracts\Console\Kernel::class)-&gt;bootstrap();
        return $app;
    }

    public function setUp()
    {
        parent::setUp();
        DB::beginTransaction();
        Artisan::call(&#39;migrate:refresh&#39;);
    }

    public function tearDown()
    {
        DB::rollBack();
        parent::tearDown();
    }
}
</code></pre>
<p>That takes care of building up and tearing down our database for each test.</p>
<p>EDIT: Turns out there’s actually a much easier way of doing this already included in Laravel. Just import and add either <code>use DatabaseMigrations;</code> or <code>use DatabaseTransactions;</code> to the <code>TestCase</code> class. The first will roll back the database and migrate it again after each test, while the second wraps each test in a transaction.</p>
<h2 id="using-an-in-memory-sqlite-database-for-testing-purposes">Using an in-memory SQLite database for testing purposes</h2>
<p>It’s not always practical to do this, especially if you rely on database features in PostgreSQL that aren’t available in SQLite, but if it is, it’s probably worth using an in-memory SQLite database for your tests. If you want to do so, here’s some example settings you might want to use in <code>phpunit.xml</code>:</p>
<pre><code class="lang-xml">        &lt;env name=&quot;APP_ENV&quot; value=&quot;testing&quot;/&gt;
        &lt;env name=&quot;CACHE_DRIVER&quot; value=&quot;array&quot;/&gt;
        &lt;env name=&quot;DB_CONNECTION&quot; value=&quot;sqlite&quot;/&gt;
        &lt;env name=&quot;DB_DATABASE&quot; value=&quot;:memory:&quot;/&gt;
</code></pre>
<p>This can result in a very significant speed boost.</p>
<p>I would still recommend that you test against your production database, but this can be easily handed off to a continuous integration server such as Jenkins, since that way it won’t disrupt your workflow. </p>
<p>During TDD, you’ll typically run your tests several times for any change you make, so if they’re too slow it can have a disastrous effect on your productivity. But with a few simple changes like this, you can ensure your tests run as quickly as possible. This approach should also be viable for Lumen apps.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Building a location aware web app with GeoDjango]]></title>
            <link>https://matthewdaly.co.uk/blog/2016/03/26/building-a-location-aware-web-app-with-geodjango/</link>
            <guid>https://matthewdaly.co.uk/blog/2016/03/26/building-a-location-aware-web-app-with-geodjango/</guid>
            <pubDate>Sat, 26 Mar 2016 21:30:29 GMT</pubDate>
            <description><![CDATA[<p>PostgreSQL has excellent support for geographical data thanks to the PostGIS extension, and Django allows you to take full advantage of it thanks to GeoDjango. In this tutorial, I’ll show you how to use GeoDjango to build a web app that allows users to search for gigs and events near them.</p>
<h2 id="requirements">Requirements</h2>
<p>I’ve made the jump to Python 3, and if you haven’t done so yet, I highly recommend it - it’s not hard, and there’s very few modules left that haven’t been ported across. As such, this tutorial assumes you’re using Python 3. You’ll also need to have Git, PostgreSQL and PostGIS installed - I’ll leave the details of doing so up to you as it varies by platform, but you can generally do so easily with a package manager on most Linux distros. On Mac OS X I recommend using Homebrew. If you’re on Windows I think your best bet is probably to use a Vagrant VM.</p>
<p>We’ll be using Django 1.9 - if by the time you read this a newer version of Django is out, it’s quite possible that some things may have changed and you’ll need to work around any problems caused. Generally search engines are the best place to look for this, and I’ll endeavour to keep the resulting Github repository as up to date as I can, so try those if you get stuck.</p>
<h2 id="getting-started">Getting started</h2>
<p>First of all, let’s create our database. Make sure you’re running as a user that has the required privileges to create users and databases for PostgreSQL and run the following command:</p>
<pre><code class="lang-bash">$ createdb gigfinder
</code></pre>
<p>This creates the database. Next, we create the user:</p>
<pre><code class="lang-bash">$ createuser -s giguser -P
</code></pre>
<p>You’ll be prompted to enter a password for the new user. Next, we want to use the <code>psql</code> command-line client to interact with our new database:</p>
<pre><code class="lang-bash">$ psql gigfinder
</code></pre>
<p>This connects to the database. Run these commands to set up access to the database and install the PostGIS extension:</p>
<pre><code class="lang-psql"># GRANT ALL PRIVILEGES ON DATABASE gigfinder TO giguser;
# CREATE EXTENSION postgis;
# \q
</code></pre>
<p>With our database set up, it’s time to start work on our project. Let’s create our virtualenv in a new folder:</p>
<pre><code class="lang-bash">$ pyvenv venv
</code></pre>
<p>Then activate it:</p>
<pre><code class="lang-bash">$ source venv/bin/activate
</code></pre>
<p>Then we install Django, along with a few other production dependencies:</p>
<pre><code class="lang-bash">$ pip install django-toolbelt
</code></pre>
<p>And record our dependencies:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>Next, we create our application skeleton:</p>
<pre><code class="lang-bash">$ django-admin.py startproject gigfinder .
</code></pre>
<p>We’ll also create a <code>.gitignore</code> file:</p>
<pre><code class="lang-bash">venv/
.DS_Store
*.swp
node_modules/
*.pyc
</code></pre>
<p>Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git init
$ git add .gitignore requirements.txt manage.py gigfinder
$ git commit -m &#39;Initial commit&#39;
</code></pre>
<p>Next, let’s create our first app, which we will call <code>gigs</code>:</p>
<pre><code class="lang-bash">$ python manage.py startapp gigs
</code></pre>
<p>We need to add our new app to the <code>INSTALLED_APPS</code> setting. While we’re there we’ll also add GIS support and set up the database connection. First, add the required apps to <code>INSTALLED_APPS</code>:</p>
<pre><code class="lang-python">INSTALLED_APPS = [
    ...
    &#39;django.contrib.gis&#39;,
    &#39;gigs&#39;,
]
</code></pre>
<p>Next, configure the database:</p>
<pre><code class="lang-python">DATABASES = {
    &#39;default&#39;: {
         &#39;ENGINE&#39;: &#39;django.contrib.gis.db.backends.postgis&#39;,
         &#39;NAME&#39;: &#39;gigfinder&#39;,
         &#39;USER&#39;: &#39;giguser&#39;,
         &#39;PASSWORD&#39;: &#39;password&#39;,
    },
}
</code></pre>
<p>Let’s run the migrations:</p>
<pre><code class="lang-bash">$ python manage.py migrate
Operations to perform:
  Apply all migrations: sessions, contenttypes, admin, auth
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying sessions.0001_initial... OK
</code></pre>
<p>And create our superuser account:</p>
<pre><code class="lang-bash">$ python manage.py createsuperuser
</code></pre>
<p>Now, we’ll commit our changes:</p>
<pre><code class="lang-bash">$ git add gigfinder/ gigs/
$ git commit -m &#39;Created gigs app&#39;
[master e72a846] Created gigs app
 8 files changed, 24 insertions(+), 3 deletions(-)
 create mode 100644 gigs/__init__.py
 create mode 100644 gigs/admin.py
 create mode 100644 gigs/apps.py
 create mode 100644 gigs/migrations/__init__.py
 create mode 100644 gigs/models.py
 create mode 100644 gigs/tests.py
 create mode 100644 gigs/views.py
</code></pre>
<h2 id="our-first-model">Our first model</h2>
<p>At this point, it’s worth thinking about the models we plan for our app to have. First we’ll have a <code>Venue</code> model that contains details of an individual venue, which will include a name and a geographical location. We’ll also have an <code>Event</code> model that will represent an individual gig or event at a venue, and will include a name, date/time and a venue as a foreign key.</p>
<p>Before we start writing our first model, we need to write a test for it, but we also need to be able to create objects easily in our tests. We also want to be able to easily examine our objects, so we’ll install iPDB and Factory Boy:</p>
<pre><code class="lang-bash">$ pip install ipdb factory-boy
$ pip freeze &gt; requirements.txt
</code></pre>
<p>Next, we write a test for the <code>Venue</code> model:</p>
<pre><code class="lang-python">from django.test import TestCase
from gigs.models import Venue
from factory.fuzzy import BaseFuzzyAttribute
from django.contrib.gis.geos import Point
import factory.django, random

class FuzzyPoint(BaseFuzzyAttribute):
    def fuzz(self):
        return Point(random.uniform(-180.0, 180.0),
                     random.uniform(-90.0, 90.0))

# Factories for tests
class VenueFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Venue
        django_get_or_create = (
            &#39;name&#39;,
            &#39;location&#39;
        )

    name = &#39;Wembley Arena&#39;
    location = FuzzyPoint()

class VenueTest(TestCase):
    def test_create_venue(self):
        # Create the venue
        venue = VenueFactory()

        # Check we can find it
        all_venues = Venue.objects.all()
        self.assertEqual(len(all_venues), 1)
        only_venue = all_venues[0]
        self.assertEqual(only_venue, venue)

        # Check attributes
        self.assertEqual(only_venue.name, &#39;Wembley Arena&#39;)
</code></pre>
<p>Note that we randomly generate our location - this is done as suggested in <a href="http://stackoverflow.com/questions/32828890/using-factory-boy-with-geodjango-pointfields">this Stack Overflow post</a>.</p>
<p>Now, running our tests brings up an expected error:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: gigs.tests (unittest.loader._FailedTest)
----------------------------------------------------------------------
ImportError: Failed to import test module: gigs.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py&quot;, line 428, in _find_test_path
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py&quot;, line 369, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 2, in &lt;module&gt;
    from gigs.models import Venue
ImportError: cannot import name &#39;Venue&#39;


----------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s create our <code>Venue</code> model in <code>gigs/models.py</code>:</p>
<pre><code class="lang-python">from django.contrib.gis.db import models

class Venue(models.Model):
    &quot;&quot;&quot;
    Model for a venue
    &quot;&quot;&quot;
    pass
</code></pre>
<p>For now, we’re just creating a simple dummy model. Note that we import <code>models</code> from <code>django.contrib.gis.db</code> instead of the usual place - this gives us access to the additional geographical fields.</p>
<p>If we run our tests again we get an error:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
psycopg2.ProgrammingError: relation &quot;gigs_venue&quot; does not exist
LINE 1: SELECT &quot;gigs_venue&quot;.&quot;id&quot; FROM &quot;gigs_venue&quot; ORDER BY &quot;gigs_ve...
                                      ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;manage.py&quot;, line 10, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 353, in execute_from_command_line
    utility.execute()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 345, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py&quot;, line 30, in run_from_argv
    super(Command, self).run_from_argv(argv)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 348, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py&quot;, line 74, in execute
    super(Command, self).execute(*args, **options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 399, in execute
    output = self.handle(*args, **options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py&quot;, line 90, in handle
    failures = test_runner.run_tests(test_labels)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py&quot;, line 532, in run_tests
    old_config = self.setup_databases()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py&quot;, line 482, in setup_databases
    self.parallel, **kwargs
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py&quot;, line 726, in setup_databases
    serialize=connection.settings_dict.get(&quot;TEST&quot;, {}).get(&quot;SERIALIZE&quot;, True),
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py&quot;, line 78, in create_test_db
    self.connection._test_serialized_contents = self.serialize_db_to_string()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py&quot;, line 122, in serialize_db_to_string
    serializers.serialize(&quot;json&quot;, get_objects(), indent=None, stream=out)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/__init__.py&quot;, line 129, in serialize
    s.serialize(queryset, **options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/base.py&quot;, line 79, in serialize
    for count, obj in enumerate(queryset, start=1):
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py&quot;, line 118, in get_objects
    for obj in queryset.iterator():
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/query.py&quot;, line 52, in __iter__
    results = compiler.execute_sql()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/sql/compiler.py&quot;, line 848, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/utils.py&quot;, line 95, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/utils/six.py&quot;, line 685, in reraise
    raise value.with_traceback(tb)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
django.db.utils.ProgrammingError: relation &quot;gigs_venue&quot; does not exist
LINE 1: SELECT &quot;gigs_venue&quot;.&quot;id&quot; FROM &quot;gigs_venue&quot; ORDER BY &quot;gigs_ve...
</code></pre>
<p>Let’s update our model:</p>
<pre><code class="lang-python">from django.contrib.gis.db import models

class Venue(models.Model):
    &quot;&quot;&quot;
    Model for a venue
    &quot;&quot;&quot;
    name = models.CharField(max_length=200)
    location = models.PointField()
</code></pre>
<p>Then create our migration:</p>
<pre><code class="lang-bash">$ python manage.py makemigrations
Migrations for &#39;gigs&#39;:
  0001_initial.py:
    - Create model Venue
</code></pre>
<p>And run it:</p>
<pre><code class="lang-bash">$ python manage.py migrate
Operations to perform:
  Apply all migrations: gigs, sessions, contenttypes, auth, admin
Running migrations:
  Rendering model states... DONE
  Applying gigs.0001_initial... OK
</code></pre>
<p>Then if we run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
.
----------------------------------------------------------------------
Ran 1 test in 0.362s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>They should pass. Note that Django may complain about needing to delete the test database before running the tests, but this should not cause any problems. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add requirements.txt gigs/
$ git commit -m &#39;Venue model in place&#39;
</code></pre>
<p>With our venue done, let’s turn to our <code>Event</code> model. Amend <code>gigs/tests.py</code> as follows:</p>
<pre><code class="lang-python">from django.test import TestCase
from gigs.models import Venue, Event
from factory.fuzzy import BaseFuzzyAttribute
from django.contrib.gis.geos import Point
import factory.django, random
from django.utils import timezone

class FuzzyPoint(BaseFuzzyAttribute):
    def fuzz(self):
        return Point(random.uniform(-180.0, 180.0),
                     random.uniform(-90.0, 90.0))

# Factories for tests
class VenueFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Venue
        django_get_or_create = (
            &#39;name&#39;,
            &#39;location&#39;
        )

    name = &#39;Wembley Arena&#39;
    location = FuzzyPoint()

class EventFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Event
        django_get_or_create = (
            &#39;name&#39;,
            &#39;venue&#39;,
            &#39;datetime&#39;
        )

    name = &#39;Queens of the Stone Age&#39;
    datetime = timezone.now()

class VenueTest(TestCase):
    def test_create_venue(self):
        # Create the venue
        venue = VenueFactory()

        # Check we can find it
        all_venues = Venue.objects.all()
        self.assertEqual(len(all_venues), 1)
        only_venue = all_venues[0]
        self.assertEqual(only_venue, venue)

        # Check attributes
        self.assertEqual(only_venue.name, &#39;Wembley Arena&#39;)


class EventTest(TestCase):
    def test_create_event(self):
        # Create the venue
        venue = VenueFactory()

        # Create the event
        event = EventFactory(venue=venue)

        # Check we can find it
        all_events = Event.objects.all()
        self.assertEqual(len(all_events), 1)
        only_event = all_events[0]
        self.assertEqual(only_event, event)

        # Check attributes
        self.assertEqual(only_event.name, &#39;Queens of the Stone Age&#39;)
        self.assertEqual(only_event.venue.name, &#39;Wembley Arena&#39;)
</code></pre>
<p>Then we run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: gigs.tests (unittest.loader._FailedTest)
----------------------------------------------------------------------
ImportError: Failed to import test module: gigs.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py&quot;, line 428, in _find_test_path
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py&quot;, line 369, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 2, in &lt;module&gt;
    from gigs.models import Venue, Event
ImportError: cannot import name &#39;Event&#39;


----------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>As expected, this fails, so create an empty <code>Event</code> model in <code>gigs/models.py</code>:</p>
<pre><code class="lang-python">class Event(models.Model):
    &quot;&quot;&quot;
    Model for an event
    &quot;&quot;&quot;
    pass
</code></pre>
<p>Running the tests now will raise an error due to the table not existing:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
psycopg2.ProgrammingError: relation &quot;gigs_event&quot; does not exist
LINE 1: SELECT &quot;gigs_event&quot;.&quot;id&quot; FROM &quot;gigs_event&quot; ORDER BY &quot;gigs_ev...
                                      ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;manage.py&quot;, line 10, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 353, in execute_from_command_line
    utility.execute()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 345, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py&quot;, line 30, in run_from_argv
    super(Command, self).run_from_argv(argv)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 348, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py&quot;, line 74, in execute
    super(Command, self).execute(*args, **options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 399, in execute
    output = self.handle(*args, **options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/management/commands/test.py&quot;, line 90, in handle
    failures = test_runner.run_tests(test_labels)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py&quot;, line 532, in run_tests
    old_config = self.setup_databases()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py&quot;, line 482, in setup_databases
    self.parallel, **kwargs
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/test/runner.py&quot;, line 726, in setup_databases
    serialize=connection.settings_dict.get(&quot;TEST&quot;, {}).get(&quot;SERIALIZE&quot;, True),
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py&quot;, line 78, in create_test_db
    self.connection._test_serialized_contents = self.serialize_db_to_string()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py&quot;, line 122, in serialize_db_to_string
    serializers.serialize(&quot;json&quot;, get_objects(), indent=None, stream=out)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/__init__.py&quot;, line 129, in serialize
    s.serialize(queryset, **options)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/serializers/base.py&quot;, line 79, in serialize
    for count, obj in enumerate(queryset, start=1):
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/base/creation.py&quot;, line 118, in get_objects
    for obj in queryset.iterator():
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/query.py&quot;, line 52, in __iter__
    results = compiler.execute_sql()
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/models/sql/compiler.py&quot;, line 848, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/utils.py&quot;, line 95, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/utils/six.py&quot;, line 685, in reraise
    raise value.with_traceback(tb)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
django.db.utils.ProgrammingError: relation &quot;gigs_event&quot; does not exist
LINE 1: SELECT &quot;gigs_event&quot;.&quot;id&quot; FROM &quot;gigs_event&quot; ORDER BY &quot;gigs_ev...
</code></pre>
<p>So let’s populate our model:</p>
<pre><code class="lang-python">class Event(models.Model):
    &quot;&quot;&quot;
    Model for an event
    &quot;&quot;&quot;
    name = models.CharField(max_length=200)
    datetime = models.DateTimeField()
    venue = models.ForeignKey(Venue)
</code></pre>
<p>And create our migration:</p>
<pre><code class="lang-bash">$ python manage.py makemigrations
Migrations for &#39;gigs&#39;:
  0002_event.py:
    - Create model Event
</code></pre>
<p>And run it:</p>
<pre><code class="lang-bash">$ python manage.py migrate
Operations to perform:
  Apply all migrations: auth, admin, sessions, contenttypes, gigs
Running migrations:
  Rendering model states... DONE
  Applying gigs.0002_event... OK
</code></pre>
<p>And run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
..
----------------------------------------------------------------------
Ran 2 tests in 0.033s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Again, you may be prompted to delete the test database, but this should not be an issue.</p>
<p>With this done, let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add gigs
$ git commit -m &#39;Added Event model&#39;
[master 47ba686] Added Event model
 3 files changed, 67 insertions(+), 1 deletion(-)
 create mode 100644 gigs/migrations/0002_event.py
</code></pre>
<h2 id="setting-up-the-admin">Setting up the admin</h2>
<p>For an application like this, you’d expect the curators of the site to maintain the gigs and venues stored in the database, and that’s an obvious use case for the Django admin. So let’s set our models up to be available in the admin. Open up <code>gigs/admin.py</code> and amend it as follows:</p>
<pre><code class="lang-python">from django.contrib import admin
from gigs.models import Venue, Event

admin.site.register(Venue)
admin.site.register(Event)
</code></pre>
<p>Now, if you start up the dev server as usual with <code>python manage.py runserver</code> and visit <a href="http://127.0.0.1:8000/admin/">http://127.0.0.1:8000/admin/</a>, you can see that our <code>Event</code> and <code>Venue</code> models are now available. However, the string representations of them are pretty useless. Let’s fix that. First, we amend our tests:</p>
<pre><code class="lang-python">from django.test import TestCase
from gigs.models import Venue, Event
from factory.fuzzy import BaseFuzzyAttribute
from django.contrib.gis.geos import Point
import factory.django, random
from django.utils import timezone

class FuzzyPoint(BaseFuzzyAttribute):
    def fuzz(self):
        return Point(random.uniform(-180.0, 180.0),
                     random.uniform(-90.0, 90.0))

# Factories for tests
class VenueFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Venue
        django_get_or_create = (
            &#39;name&#39;,
            &#39;location&#39;
        )

    name = &#39;Wembley Arena&#39;
    location = FuzzyPoint()

class EventFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Event
        django_get_or_create = (
            &#39;name&#39;,
            &#39;venue&#39;,
            &#39;datetime&#39;
        )

    name = &#39;Queens of the Stone Age&#39;
    datetime = timezone.now()

class VenueTest(TestCase):
    def test_create_venue(self):
        # Create the venue
        venue = VenueFactory()

        # Check we can find it
        all_venues = Venue.objects.all()
        self.assertEqual(len(all_venues), 1)
        only_venue = all_venues[0]
        self.assertEqual(only_venue, venue)

        # Check attributes
        self.assertEqual(only_venue.name, &#39;Wembley Arena&#39;)

        # Check string representation
        self.assertEqual(only_venue.__str__(), &#39;Wembley Arena&#39;)


class EventTest(TestCase):
    def test_create_event(self):
        # Create the venue
        venue = VenueFactory()

        # Create the event
        event = EventFactory(venue=venue)

        # Check we can find it
        all_events = Event.objects.all()
        self.assertEqual(len(all_events), 1)
        only_event = all_events[0]
        self.assertEqual(only_event, event)

        # Check attributes
        self.assertEqual(only_event.name, &#39;Queens of the Stone Age&#39;)
        self.assertEqual(only_event.venue.name, &#39;Wembley Arena&#39;)

        # Check string representation
        self.assertEqual(only_event.__str__(), &#39;Queens of the Stone Age - Wembley Arena&#39;)
</code></pre>
<p>Next, we run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
FF
======================================================================
FAIL: test_create_event (gigs.tests.EventTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 74, in test_create_event
    self.assertEqual(only_event.__str__(), &#39;Queens of the Stone Age - Wembley Arena&#39;)
AssertionError: &#39;Event object&#39; != &#39;Queens of the Stone Age - Wembley Arena&#39;
- Event object
+ Queens of the Stone Age - Wembley Arena


======================================================================
FAIL: test_create_venue (gigs.tests.VenueTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 52, in test_create_venue
    self.assertEqual(only_venue.__str__(), &#39;Wembley Arena&#39;)
AssertionError: &#39;Venue object&#39; != &#39;Wembley Arena&#39;
- Venue object
+ Wembley Arena


----------------------------------------------------------------------
Ran 2 tests in 0.059s

FAILED (failures=2)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>They fail as expected. So let’s update <code>gigs/models.py</code>:</p>
<pre><code class="lang-python">from django.contrib.gis.db import models

class Venue(models.Model):
    &quot;&quot;&quot;
    Model for a venue
    &quot;&quot;&quot;
    name = models.CharField(max_length=200)
    location = models.PointField()

    def __str__(self):
        return self.name


class Event(models.Model):
    &quot;&quot;&quot;
    Model for an event
    &quot;&quot;&quot;
    name = models.CharField(max_length=200)
    datetime = models.DateTimeField()
    venue = models.ForeignKey(Venue)

    def __str__(self):
        return &quot;%s - %s&quot; % (self.name, self.venue.name)
</code></pre>
<p>For the venue, we just use the name. For the event, we use the event name and the venue name.</p>
<p>Now, we run our tests again:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
..
----------------------------------------------------------------------
Ran 2 tests in 0.048s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Time to commit our changes:</p>
<pre><code class="lang-bash">$ git add gigs
$ git commit -m &#39;Added models to admin&#39;
[master 65d051f] Added models to admin
 3 files changed, 15 insertions(+), 1 deletion(-)
</code></pre>
<p>Our models are now in place, so you may want to log into the admin and create a few venues and events so you can see it in action. Note that the location field for the <code>Venue</code> model creates a map widget that allows you to select a geographical location. It is a bit basic, however, so let’s make it better. Let’s install <code>django-floppyforms</code>:</p>
<pre><code class="lang-bash">$ pip install django-floppyforms
</code></pre>
<p>And add it to our requirements:</p>
<pre><code class="lang-bash">$ pip freeze -r requirements.txt
</code></pre>
<p>Then add it to <code>INSTALLED_APPS</code> in <code>gigfinder/setttings.py</code>:</p>
<pre><code class="lang-python">INSTALLED_APPS = [
    ...
    &#39;django.contrib.gis&#39;,
    &#39;gigs&#39;,
    &#39;floppyforms&#39;,
]
</code></pre>
<p>Now we create a custom point widget for our admin, a custom form for the venues, and a custom venue admin:</p>
<pre><code class="lang-python">from django.contrib import admin
from gigs.models import Venue, Event
from django.forms import ModelForm
from floppyforms.gis import PointWidget, BaseGMapWidget

class CustomPointWidget(PointWidget, BaseGMapWidget):
    class Media:
        js = (&#39;/static/floppyforms/js/MapWidget.js&#39;,)

class VenueAdminForm(ModelForm):
    class Meta:
        model = Venue
        fields = [&#39;name&#39;, &#39;location&#39;]
        widgets = {
            &#39;location&#39;: CustomPointWidget()
        }

class VenueAdmin(admin.ModelAdmin):
    form = VenueAdminForm

admin.site.register(Venue, VenueAdmin)
admin.site.register(Event)
</code></pre>
<p>Note in particular that we define the media for our widget so we can include some required Javascript. If you run the dev server again, you should see that the map widget in the admin is now provided by Google Maps, making it much easier to identify the correct location of the venue.</p>
<p>Time to commit our changes:</p>
<pre><code class="lang-bash">$ git add gigfinder/ gigs/ requirements.txt
$ git commit -m &#39;Customised location widget&#39;
</code></pre>
<p>With our admin ready, it’s time to move on to the user-facing part of the web app.</p>
<h2 id="creating-our-views">Creating our views</h2>
<p>We will keep the front end for this app as simple as possible for the purposes of this tutorial, but of course you should feel free to expand upon this as you see fit. What we’ll do is create a form that uses HTML5 geolocation to get the user’s current geographical coordinates. It will then return events in the next week, ordered by how close the venue is. Please note that there are plans afoot in some browsers to prevent HTML5 geolocation from working unless content is server over HTTPS, so that may complicate things.</p>
<p>How do we query the database to get this data? It’s not too difficult, as shown in this example:</p>
<pre><code class="lang-bash">$ python manage.py shell
Python 3.5.1 (default, Mar 25 2016, 00:17:15)
Type &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.

IPython 4.1.2 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython&#39;s features.
%quickref -&gt; Quick reference.
help      -&gt; Python&#39;s own help system.
object?   -&gt; Details about &#39;object&#39;, use &#39;object??&#39; for extra details.

In [1]: from gigs.models import *

In [2]: from django.contrib.gis.geos import Point

In [3]: from django.contrib.gis.db.models.functions import Distance

In [4]: location = Point(52.3749159, 1.1067473, srid=4326)

In [5]: Venue.objects.all().annotate(distance=Distance(&#39;location&#39;, location)).order_by(&#39;distance&#39;)
Out[5]: [&lt;Venue: Diss Corn Hall&gt;, &lt;Venue: Waterfront Norwich&gt;, &lt;Venue: UEA Norwich&gt;, &lt;Venue: Wembley Arena&gt;]
</code></pre>
<p>I’ve set up a number of venues using the admin, one round the corner, two in Norwich, and one in London. I then imported the models, the <code>Point</code> class, and the <code>Distance</code> function, and created a <code>Point</code> object. Note that the <code>Point</code> is passed three fields - the first and second are the latitude and longitude, respectively, while the <code>srid</code> field takes a value of <code>4326</code>. This field represents the <a href="https://en.wikipedia.org/wiki/SRID">Spatial Reference System Identifier</a> used for this query - we’ve gone for <a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84">WGS 84</a>, which is a common choice and is referred to with the SRID 4326.</p>
<p>Now, we want the user to be able to submit the form and get the 5 nearest events in the next week. We can get the date for this time next week as follows:</p>
<pre><code class="lang-python">In [6]: next_week = timezone.now() + timezone.timedelta(weeks=1)
</code></pre>
<p>Then we can get the events we want, sorted by distance, like this:</p>
<pre><code class="lang-python">In [7]: Event.objects.filter(datetime__gte=timezone.now()).filter(datetime__lte=next_week).annotate(distance=Distance(&#39;venue__location&#39;, location)).order_by(&#39;distance&#39;)[0:5]
Out[7]: [&lt;Event: Primal Scream - UEA Norwich&gt;, &lt;Event: Queens of the Stone Age - Wembley Arena&gt;]
</code></pre>
<p>With that in mind, let’s write the test for our view. The view should contain a single form that accepts a user’s geographical coordinates - for convenience we’ll autocomplete this with HTML5 geolocation. On submit, the user should see a list of the five closest events in the next week.</p>
<p>First, let’s test the GET request. Amend <code>gigs/tests.py</code> as follows:</p>
<pre><code class="lang-python">from django.test import TestCase
from gigs.models import Venue, Event
from factory.fuzzy import BaseFuzzyAttribute
from django.contrib.gis.geos import Point
import factory.django, random
from django.utils import timezone
from django.test import RequestFactory
from django.core.urlresolvers import reverse
from gigs.views import LookupView

class FuzzyPoint(BaseFuzzyAttribute):
    def fuzz(self):
        return Point(random.uniform(-180.0, 180.0),
                     random.uniform(-90.0, 90.0))

# Factories for tests
class VenueFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Venue
        django_get_or_create = (
            &#39;name&#39;,
            &#39;location&#39;
        )

    name = &#39;Wembley Arena&#39;
    location = FuzzyPoint()

class EventFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Event
        django_get_or_create = (
            &#39;name&#39;,
            &#39;venue&#39;,
            &#39;datetime&#39;
        )

    name = &#39;Queens of the Stone Age&#39;
    datetime = timezone.now()

class VenueTest(TestCase):
    def test_create_venue(self):
        # Create the venue
        venue = VenueFactory()

        # Check we can find it
        all_venues = Venue.objects.all()
        self.assertEqual(len(all_venues), 1)
        only_venue = all_venues[0]
        self.assertEqual(only_venue, venue)

        # Check attributes
        self.assertEqual(only_venue.name, &#39;Wembley Arena&#39;)

        # Check string representation
        self.assertEqual(only_venue.__str__(), &#39;Wembley Arena&#39;)


class EventTest(TestCase):
    def test_create_event(self):
        # Create the venue
        venue = VenueFactory()

        # Create the event
        event = EventFactory(venue=venue)

        # Check we can find it
        all_events = Event.objects.all()
        self.assertEqual(len(all_events), 1)
        only_event = all_events[0]
        self.assertEqual(only_event, event)

        # Check attributes
        self.assertEqual(only_event.name, &#39;Queens of the Stone Age&#39;)
        self.assertEqual(only_event.venue.name, &#39;Wembley Arena&#39;)

        # Check string representation
        self.assertEqual(only_event.__str__(), &#39;Queens of the Stone Age - Wembley Arena&#39;)


class LookupViewTest(TestCase):
    &quot;&quot;&quot;
    Test lookup view
    &quot;&quot;&quot;
    def setUp(self):
        self.factory = RequestFactory()

    def test_get(self):
        request = self.factory.get(reverse(&#39;lookup&#39;))
        response = LookupView.as_view()(request)
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(&#39;gigs/lookup.html&#39;)
</code></pre>
<p>Let’s run our tests:</p>
<pre><code class="lang-python">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: gigs.tests (unittest.loader._FailedTest)
----------------------------------------------------------------------
ImportError: Failed to import test module: gigs.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py&quot;, line 428, in _find_test_path
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/unittest/loader.py&quot;, line 369, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 9, in &lt;module&gt;
    from gigs.views import LookupView
ImportError: cannot import name &#39;LookupView&#39;


----------------------------------------------------------------------
Ran 1 test in 0.000s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Our first issue is that we can’t import the view in the test. Let’s fix that by amending <code>gigs/views.py</code>:</p>
<pre><code class="lang-python">from django.shortcuts import render
from django.views.generic.base import View

class LookupView(View):
    pass
</code></pre>
<p>Running the tests again results in the following:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
.E.
======================================================================
ERROR: test_get (gigs.tests.LookupViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 88, in test_get
    request = self.factory.get(reverse(&#39;lookup&#39;))
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/urlresolvers.py&quot;, line 600, in reverse
    return force_text(iri_to_uri(resolver._reverse_with_prefix(view, prefix, *args, **kwargs)))
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/core/urlresolvers.py&quot;, line 508, in _reverse_with_prefix
    (lookup_view_s, args, kwargs, len(patterns), patterns))
django.core.urlresolvers.NoReverseMatch: Reverse for &#39;lookup&#39; with arguments &#39;()&#39; and keyword arguments &#39;{}&#39; not found. 0 pattern(s) tried: []

----------------------------------------------------------------------
Ran 3 tests in 0.154s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We can’t resolve the URL for our new view, so we need to add it to our URLconf. First of all, save this as <code>gigs/urls.py</code>:</p>
<pre><code class="lang-python">from django.conf.urls import url
from gigs.views import LookupView

urlpatterns = [
    # Lookup
    url(r&#39;&#39;, LookupView.as_view(), name=&#39;lookup&#39;),
]
</code></pre>
<p>Then amend <code>gigfinder/urls.py</code> as follows:</p>
<pre><code class="lang-python">from django.conf.urls import url, include
from django.contrib import admin

urlpatterns = [
    url(r&#39;^admin/&#39;, admin.site.urls),

    # Gig URLs
    url(r&#39;&#39;, include(&#39;gigs.urls&#39;)),
]
</code></pre>
<p>Then run the tests:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
.F.
======================================================================
FAIL: test_get (gigs.tests.LookupViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 90, in test_get
    self.assertEqual(response.status_code, 200)
AssertionError: 405 != 200

----------------------------------------------------------------------
Ran 3 tests in 0.417s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We get a 405 response because the view does not accept GET requests. Let’s resolve that:</p>
<pre><code class="lang-python">from django.shortcuts import render_to_response
from django.views.generic.base import View

class LookupView(View):
    def get(self, request):
        return render_to_response(&#39;gigs/lookup.html&#39;)
</code></pre>
<p>If we run our tests now:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
.E.
======================================================================
ERROR: test_get (gigs.tests.LookupViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 89, in test_get
    response = LookupView.as_view()(request)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py&quot;, line 68, in view
    return self.dispatch(request, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py&quot;, line 88, in dispatch
    return handler(request, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/views.py&quot;, line 6, in get
    return render_to_response(&#39;gigs/lookup.html&#39;)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/shortcuts.py&quot;, line 39, in render_to_response
    content = loader.render_to_string(template_name, context, using=using)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py&quot;, line 96, in render_to_string
    template = get_template(template_name, using=using)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py&quot;, line 43, in get_template
    raise TemplateDoesNotExist(template_name, chain=chain)
django.template.exceptions.TemplateDoesNotExist: gigs/lookup.html

----------------------------------------------------------------------
Ran 3 tests in 0.409s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We see that the template is not defined. Save the following as <code>gigs/templates/gigs/includes/base.html</code>:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Gig finder&lt;/title&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css&quot;&gt;&lt;/link&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Gig Finder&lt;/h1&gt;
        &lt;div class=&quot;container&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;script src=&quot;https://code.jquery.com/jquery-2.2.2.min.js&quot; integrity=&quot;sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>And the following as <code>gigs/templates/gigs/lookup.html</code>:</p>
<pre><code class="lang-django">{% extends &quot;gigs/includes/base.html&quot; %}

{% block content %}
    &lt;form role=&quot;form&quot; action=&quot;/&quot; method=&quot;post&quot;&gt;{% csrf_token %}
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;latitude&quot;&gt;Latitude:&lt;/label&gt;
            &lt;input id=&quot;id_latitude&quot; name=&quot;latitude&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;&lt;/input&gt;
        &lt;/div&gt;
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;longitude&quot;&gt;Longitude:&lt;/label&gt;
            &lt;input id=&quot;id_longitude&quot; name=&quot;longitude&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;&lt;/input&gt;
        &lt;/div&gt;
        &lt;input class=&quot;btn btn-primary&quot; type=&quot;submit&quot; value=&quot;Submit&quot; /&gt;
    &lt;/form&gt;
    &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;
        navigator.geolocation.getCurrentPosition(function (position) {
            var lat = document.getElementById(&#39;id_latitude&#39;);
            var lon = document.getElementById(&#39;id_longitude&#39;);
            lat.value = position.coords.latitude;
            lon.value = position.coords.longitude;
        });
    &lt;/script&gt;
{% endblock %}
</code></pre>
<p>Note the JavaScript to populate the latitude and longitude. Now, if we run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
...
----------------------------------------------------------------------
Ran 3 tests in 1.814s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Success! We now render our form as expected. Time to commit:</p>
<pre><code class="lang-bash">$ git add gigs gigfinder
$ git commit -m &#39;Implemented GET handler&#39;
</code></pre>
<h2 id="handling-post-requests">Handling POST requests</h2>
<p>Now we need to be able to handle POST requests and return the appropriate results. First, let’s write a test for it in our existing <code>LookupViewTest</code> class:</p>
<pre><code class="lang-python">    def test_post(self):
        # Create venues to return
        v1 = VenueFactory(name=&#39;Venue1&#39;)
        v2 = VenueFactory(name=&#39;Venue2&#39;)
        v3 = VenueFactory(name=&#39;Venue3&#39;)
        v4 = VenueFactory(name=&#39;Venue4&#39;)
        v5 = VenueFactory(name=&#39;Venue5&#39;)
        v6 = VenueFactory(name=&#39;Venue6&#39;)
        v7 = VenueFactory(name=&#39;Venue7&#39;)
        v8 = VenueFactory(name=&#39;Venue8&#39;)
        v9 = VenueFactory(name=&#39;Venue9&#39;)
        v10 = VenueFactory(name=&#39;Venue10&#39;)

        # Create events to return
        e1 = EventFactory(name=&#39;Event1&#39;, venue=v1)
        e2 = EventFactory(name=&#39;Event2&#39;, venue=v2)
        e3 = EventFactory(name=&#39;Event3&#39;, venue=v3)
        e4 = EventFactory(name=&#39;Event4&#39;, venue=v4)
        e5 = EventFactory(name=&#39;Event5&#39;, venue=v5)
        e6 = EventFactory(name=&#39;Event6&#39;, venue=v6)
        e7 = EventFactory(name=&#39;Event7&#39;, venue=v7)
        e8 = EventFactory(name=&#39;Event8&#39;, venue=v8)
        e9 = EventFactory(name=&#39;Event9&#39;, venue=v9)
        e10 = EventFactory(name=&#39;Event10&#39;, venue=v10)

        # Set parameters
        lat = 52.3749159
        lon = 1.1067473

        # Put together request
        data = {
            &#39;latitude&#39;: lat,
            &#39;longitude&#39;: lon
        }
        request = self.factory.post(reverse(&#39;lookup&#39;), data)
        response = LookupView.as_view()(request)
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(&#39;gigs/lookupresults.html&#39;)
</code></pre>
<p>If we now run this test:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
..F.
======================================================================
FAIL: test_post (gigs.tests.LookupViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 117, in test_post
    self.assertEqual(response.status_code, 200)
AssertionError: 405 != 200

----------------------------------------------------------------------
Ran 4 tests in 1.281s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We can see that it fails because the POST method is not supported. Now we can start work on implementing it. First, let’s create a form in <code>gigs/forms.py</code>:</p>
<pre><code class="lang-python">from django.forms import Form, FloatField

class LookupForm(Form):
    latitude = FloatField()
    longitude = FloatField()
</code></pre>
<p>Next, edit <code>gigs/views.py</code>:</p>
<pre><code class="lang-python">from django.shortcuts import render_to_response
from django.views.generic.edit import FormView
from gigs.forms import LookupForm
from gigs.models import Event
from django.utils import timezone
from django.contrib.gis.geos import Point
from django.contrib.gis.db.models.functions import Distance

class LookupView(FormView):
    form_class = LookupForm

    def get(self, request):
        return render_to_response(&#39;gigs/lookup.html&#39;)

    def form_valid(self, form):
        # Get data
        latitude = form.cleaned_data[&#39;latitude&#39;]
        longitude = form.cleaned_data[&#39;longitude&#39;]

        # Get today&#39;s date
        now = timezone.now()

        # Get next week&#39;s date
        next_week = now + timezone.timedelta(weeks=1)

        # Get Point
        location = Point(longitude, latitude, srid=4326)

        # Look up events
        events = Event.objects.filter(datetime__gte=now).filter(datetime__lte=next_week).annotate(distance=Distance(&#39;venue__location&#39;, location)).order_by(&#39;distance&#39;)[0:5]

        # Render the template
        return render_to_response(&#39;gigs/lookupresults.html&#39;, {
            &#39;events&#39;: events
            })
</code></pre>
<p>Note that we’re switching from a <code>View</code> to a <code>FormView</code> so that it can more easily handle our form. We could render the form using this as well, but as it’s a simple form I decided it wasn’t worth the bother. Also, note that the longitude goes first - this caught me out as I expected the latitude to be the first argument.</p>
<p>Now, if we run our tests, they should complain about our missing template:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
..E.
======================================================================
ERROR: test_post (gigs.tests.LookupViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/tests.py&quot;, line 116, in test_post
    response = LookupView.as_view()(request)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py&quot;, line 68, in view
    return self.dispatch(request, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/base.py&quot;, line 88, in dispatch
    return handler(request, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/views/generic/edit.py&quot;, line 222, in post
    return self.form_valid(form)
  File &quot;/Users/matthewdaly/Projects/gigfinder/gigs/views.py&quot;, line 31, in form_valid
    &#39;events&#39;: events
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/shortcuts.py&quot;, line 39, in render_to_response
    content = loader.render_to_string(template_name, context, using=using)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py&quot;, line 96, in render_to_string
    template = get_template(template_name, using=using)
  File &quot;/Users/matthewdaly/Projects/gigfinder/venv/lib/python3.5/site-packages/django/template/loader.py&quot;, line 43, in get_template
    raise TemplateDoesNotExist(template_name, chain=chain)
django.template.exceptions.TemplateDoesNotExist: gigs/lookupresults.html

----------------------------------------------------------------------
Ran 4 tests in 0.506s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>So let’s create <code>gigs/templates/gigs/lookupresults.html</code>:</p>
<pre><code class="lang-django">{% extends &quot;gigs/includes/base.html&quot; %}

{% block content %}
    &lt;ul&gt;
    {% for event in events %}
    &lt;li&gt;{{ event.name }} - {{ event.venue.name }}&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
{% endblock %}
</code></pre>
<p>Now, if we run our tests, they should pass:</p>
<pre><code class="lang-bash">$ python manage.py test gigs
Creating test database for alias &#39;default&#39;...
....
----------------------------------------------------------------------
Ran 4 tests in 0.728s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>However, if we try actually submitting the form by hand, we get the error <code>CSRF token missing or incorrect</code>. Edit <code>views.py</code> as follows to resolve this:</p>
<pre><code class="lang-python">from django.shortcuts import render_to_response
from django.views.generic.edit import FormView
from gigs.forms import LookupForm
from gigs.models import Event
from django.utils import timezone
from django.contrib.gis.geos import Point
from django.contrib.gis.db.models.functions import Distance
from django.template import RequestContext

class LookupView(FormView):
    form_class = LookupForm

    def get(self, request):
        return render_to_response(&#39;gigs/lookup.html&#39;, RequestContext(request))

    def form_valid(self, form):
        # Get data
        latitude = form.cleaned_data[&#39;latitude&#39;]
        longitude = form.cleaned_data[&#39;longitude&#39;]

        # Get today&#39;s date
        now = timezone.now()

        # Get next week&#39;s date
        next_week = now + timezone.timedelta(weeks=1)

        # Get Point
        location = Point(longitude, latitude, srid=4326)

        # Look up events
        events = Event.objects.filter(datetime__gte=now).filter(datetime__lte=next_week).annotate(distance=Distance(&#39;venue__location&#39;, location)).order_by(&#39;distance&#39;)[0:5]

        # Render the template
        return render_to_response(&#39;gigs/lookupresults.html&#39;, {
            &#39;events&#39;: events
            })
</code></pre>
<p>Here we’re adding the request context so that the CSRF token is available.</p>
<p>If you run the dev server, add a few events and venues via the admin, and submit a search, you’ll see that you’re returning events closest to you first.</p>
<p>Now that we can submit searches, we’re ready to commit:</p>
<pre><code class="lang-bash">$ git add gigs/
$ git commit -m &#39;Can now retrieve search results&#39;
</code></pre>
<p>And we’re done! Of course, you may want to expand on this by plotting each gig venue on a map, or something like that, in which case there’s plenty of methods of doing so - you can retrieve the latitude and longitude in the template and use Google Maps to display them. I’ll leave doing so as an exercise for the reader.</p>
<p>I can’t say that working with GeoDjango isn’t a bit of a struggle at times, but being able to make spatial queries in this fashion is very useful. With more and more people carrying smartphones, you’re more likely than ever to be asked to build applications that return data based on someone’s geographical location, and GeoDjango is a great way to do this with a Django application. You can find the source on <a href="https://github.com/matthewbdaly/gigfinder">Github</a>.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Mocking external APIs in Python]]></title>
            <link>https://matthewdaly.co.uk/blog/2016/01/26/mocking-external-apis-in-python/</link>
            <guid>https://matthewdaly.co.uk/blog/2016/01/26/mocking-external-apis-in-python/</guid>
            <pubDate>Tue, 26 Jan 2016 23:40:25 GMT</pubDate>
            <description><![CDATA[<p>It’s quite common to have to integrate an external API into your web app for some of your functionality. However, it’s a really bad idea to have requests be sent to the remote API when running your tests. At best, it means your tests may fail due to unexpected circumstances, such as a network outage. At worst, you could wind up making requests to paid services that will cost you money, or sending push notifications to clients. It’s therefore a good idea to mock these requests in some way, but it can be fiddly.</p>
<p>In this post I’ll show you several ways you can mock an external API so as to prevent requests being sent when running your test suite. I’m sure there are many others, but these have worked for me recently.</p>
<h2 id="mocking-the-client-library">Mocking the client library</h2>
<p>Nowadays many third-party services realise that providing developers with client libraries in a variety of languages is a good idea, so it’s quite common to find a library for interfacing with a third-party service. Under these circumstances, the library itself is usually already thoroughly tested, so there’s no point in you writing additional tests for that functionality. Instead, you can just mock the client library so that the request is never sent, and if you need a response, then you can specify one that will remain constant.</p>
<p>I recently had to integrate Stripe with a mobile app backend, and I used their client library. I needed to ensure that I got the right result back. In this case I only needed to use the <code>Token</code> object’s <code>create()</code> method. I therefore created a new <code>MockToken</code> class that inherited from <code>Token</code>, and overrode its <code>create()</code> method so that it only accepted one card number and returned a hard-coded response for it:</p>
<pre><code class="lang-python">from stripe.resource import Token, convert_to_stripe_object
from stripe.error import CardError


class MockToken(Token):

    @classmethod
    def create(cls, api_key=None, idempotency_key=None,
               stripe_account=None, **params):
        if params[&#39;card&#39;][&#39;number&#39;] != &#39;4242424242424242&#39;:
            raise CardError(&#39;Invalid card number&#39;, None, 402)

        response = {
            &quot;card&quot;: {
              &quot;address_city&quot;: None,
              &quot;address_country&quot;: None,
              &quot;address_line1&quot;: None,
              &quot;address_line1_check&quot;: None,
              &quot;address_line2&quot;: None,
              &quot;address_state&quot;: None,
              &quot;address_zip&quot;: None,
              &quot;address_zip_check&quot;: None,
              &quot;brand&quot;: &quot;Visa&quot;,
              &quot;country&quot;: &quot;US&quot;,
              &quot;cvc_check&quot;: &quot;unchecked&quot;,
              &quot;dynamic_last4&quot;: None,
              &quot;exp_month&quot;: 12,
              &quot;exp_year&quot;: 2017,
              &quot;fingerprint&quot;: &quot;49gS1c4YhLaGEQbj&quot;,
              &quot;funding&quot;: &quot;credit&quot;,
              &quot;id&quot;: &quot;card_17XXdZGzvyST06Z022EiG1zt&quot;,
              &quot;last4&quot;: &quot;4242&quot;,
              &quot;metadata&quot;: {},
              &quot;name&quot;: None,
              &quot;object&quot;: &quot;card&quot;,
              &quot;tokenization_method&quot;: None
          },
            &quot;client_ip&quot;: &quot;192.168.1.1&quot;,
            &quot;created&quot;: 1453817861,
            &quot;id&quot;: &quot;tok_42XXdZGzvyST06Z0LA6h5gJp&quot;,
            &quot;livemode&quot;: False,
            &quot;object&quot;: &quot;token&quot;,
            &quot;type&quot;: &quot;card&quot;,
            &quot;used&quot;: False
        }
        return convert_to_stripe_object(response, api_key, stripe_account)
</code></pre>
<p>Much of this was lifted straight from the source code for the library. I then wrote a test for the payment endpoint and patched the <code>Token</code> class:</p>
<pre><code class="lang-python">class PaymentTest(TestCase):
    @mock.patch(&#39;stripe.Token&#39;, MockToken)
    def test_payments(self):
        data = {
            &quot;number&quot;: &#39;1111111111111111&#39;,
            &quot;exp_month&quot;: 12,
            &quot;exp_year&quot;: 2017,
            &quot;cvc&quot;: &#39;123&#39;
        }
        response = self.client.post(reverse(&#39;payments&#39;), data=data, format=&#39;json&#39;)
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
</code></pre>
<p>This replaced <code>stripe.Token</code> with <code>MockToken</code> so that in this test, the response from the client library was always going to be the expected one.</p>
<p>If the response doesn’t matter and all you need to do is be sure that the right method would have been called, this is easier. You can just mock the method in question using <code>MagicMock</code> and assert that it has been called afterwards, as in this example:</p>
<pre><code class="lang-python">class ReminderTest(TestCase):
    def test_send_reminder(self):
        # Mock PushService.create_message()
        PushService.create_message = mock.MagicMock(name=&quot;create_message&quot;)

        # Call reminder task
        send_reminder()

        # Check user would have received a push notification
        PushService.create_message.assert_called_with([{&#39;text&#39;: &#39;My push&#39;, &#39;conditions&#39;: [&#39;UserID&#39;, &#39;EQ&#39;, 1]}])
</code></pre>
<h2 id="mocking-lower-level-requests">Mocking lower-level requests</h2>
<p>Sometimes, no client library is available, or it’s not worth using one as you only have to make one or two requests. Under these circumstances, there are ways to mock the actual request to the external API. If you’re using the <code>requests</code> module, then there’s a <code>responses</code> module that’s ideal for mocking the API request.</p>
<p>Suppose we have the following code:</p>
<pre><code class="lang-python">import json, requests

def send_request_to_api(data):
    # Put together the request
    params = {
        &#39;auth&#39;: settings.AUTH_KEY,
        &#39;data&#39;: data
    }
    response = requests.post(settings.API_URL, data={&#39;params&#39;: json.dumps(params)})
    return response
</code></pre>
<p>Using <code>responses</code> we can mock the response from the server in our test:</p>
<pre><code class="lang-python">class APITest(TestCase):
    @responses.activate
    def test_send_request(self):
        # Mock the API
        responses.add(responses.POST,
            settings.API_URL,
            status=200,
            content_type=&quot;application/json&quot;,
            body=&#39;{&quot;item_id&quot;: &quot;12345678&quot;}&#39;)

        # Call function
        data = {
            &quot;surname&quot;: &quot;Smith&quot;,
            &quot;location&quot;: &quot;London&quot;
        }
        send_request_to_api(data)

        # Check request went to correct URL
        assert responses.calls[0].request.url == settings.API_URL
</code></pre>
<p>Note the use of the <a href="mailto:`@responses.activate">`@responses.activate</a><code>decorator. We use</code>responses.add()` to set up each URL we want to be able to mock, and pass through details of the response we want to return. We then make the request, and check that it was made as expected.</p>
<p>You can find more details of the <code>responses</code> module <a href="https://github.com/getsentry/responses">here</a>.</p>
<h2 id="summary">Summary</h2>
<p>I’m pretty certain that there are other ways you can mock an external API in Python, but these ones have worked for me recently. If you use another method, please feel free to share it in the comments.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Testing Django views in isolation]]></title>
            <link>https://matthewdaly.co.uk/blog/2015/08/02/testing-django-views-in-isolation/</link>
            <guid>https://matthewdaly.co.uk/blog/2015/08/02/testing-django-views-in-isolation/</guid>
            <pubDate>Sun, 02 Aug 2015 16:58:45 GMT</pubDate>
            <description><![CDATA[<p>One thing you may hear said often about test-driven development is that as far as possible, you should test everything in isolation. However, it’s not always immediately clear how you actually go about doing this. In Django, it’s fairly easy to get your head around testing models in isolation because they’re single objects that you can just create, save, and then check their attributes. Forms are also quite easy to test, because you can just set the parameters with the appropriate values and check that the validation works as expected. With views, it’s much harder to imagine how you’d go about testing them in isolation, and often people just settle for writing higher-level functional tests instead. While functional tests are important, they’re also slower than unit tests, which makes it less likely they’ll be run often. So I thought I’d show you a quick and simple example of testing a Django view in isolation.</p>
<p>One of the little projects I’ve written in the past to help get my head around certain aspects of Django is a code-snippet sharing Django application which I named <a href="https://github.com/matthewbdaly/snippetr">Snippetr</a>. The index route of this application is a form for submitting a brand-new code snippet and I’ll show you how we would write a test for that.</p>
<h2 id="testing-a-get-request">Testing a GET request</h2>
<p>Before now, you may well have used the Django test client to test views. That is fine for higher-level tests, but if you want to test a view in isolation, it’s no use because it emulates a real web server and all of the middleware and authentication, which we want to keep out of the way. Instead, we need to use <code>RequestFactory</code>:</p>
<pre><code class="lang-python">from django.test import RequestFactory
</code></pre>
<p><code>RequestFactory</code> actually implements a subset of the functionality of the Django test client, so while it will feel somewhat familiar, it won’t have all the same functionality. For instance, it doesn’t support middleware, so rather than logging in using the test client’s <code>login()</code> method, you instead attach a user directly to the request, as in this example:</p>
<pre><code class="lang-python">request = RequestFactory()
request.user = user
</code></pre>
<p>You have to specify the URL in the request, but you also have to explicitly pass the request through to the view you want to test, which can be a bit confusing. Let’s see it in context. First of all, we want to write a test for making a GET request:</p>
<pre><code class="lang-python">class SnippetCreateViewTest(TestCase):
    &quot;&quot;&quot;
    Test the snippet create view
    &quot;&quot;&quot;
    def setUp(self):
        self.user = UserFactory()
        self.factory = RequestFactory()

    def test_get(self):
        &quot;&quot;&quot;
        Test GET requests
        &quot;&quot;&quot;
        request = self.factory.get(reverse(&#39;snippet_create&#39;))
        request.user = self.user
        response = SnippetCreateView.as_view()(request)
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.context_data[&#39;user&#39;], self.user)
        self.assertEqual(response.context_data[&#39;request&#39;], request)
</code></pre>
<p>First of all, we define a <code>setUp()</code> method that creates a user and an instance of <code>RequestFactory()</code> for use in the test. Note that I’m using Factory Boy to define <code>UserFactory</code> in order to make it easier to work with. Also, if you have more than one view to test, you should create a base class containing the <code>setUp()</code> method that your view tests inherit from.</p>
<p>Next, we have our test for making a GET request. Note that we’re using the <code>reverse()</code> method to get the route for the view named <code>snippet_create</code>. You’ll need to import this as follows if you’re not yet using it:</p>
<pre><code class="lang-python">from django.core.urlresolvers import reverse
</code></pre>
<p>We then attach our user object to the request manually, and fetch the response by passing the request to the view as follows:</p>
<pre><code class="lang-python">    response = SnippetCreateView.as_view()(request)
</code></pre>
<p>Note that this is the syntax used for class-based views - we call the view’s <code>as_view()</code> method. For a function-based view, the syntax is a bit simpler:</p>
<pre><code class="lang-python">    response = my_view(request)
</code></pre>
<p>We then test our response as usual. In this case, the view adds some additional context data, and we check that we can access that, as well as checking the status code.</p>
<h2 id="testing-a-post-request">Testing a POST request</h2>
<p>Testing a POST request is a little more challenging in this case because submitting the form will create a new <code>Snippet</code> object and we don’t want to interact with the model layer at all if we can help it. We want to test the view in isolation, partly because it will be faster, and partly because it’s a good idea. We can do this by mocking the <code>Snippet</code> model’s <code>save()</code> method.</p>
<p>To do so, we need to import two things from the <code>mock</code> library. If you’re using Python 3.4 or later, then <code>mock</code> is part of <code>unittest</code> as <code>unittest.mock</code>. Otherwise, it’s a separate library you need to install with <code>pip</code>. Here’s the import statement for those on Python 3.4 or later:</p>
<pre><code class="lang-python">from unittest.mock import patch, MagicMock
</code></pre>
<p>And for those on earlier versions:</p>
<pre><code class="lang-python">from mock import patch, MagicMock
</code></pre>
<p>Now, our test for the POST requests should look like this:</p>
<pre><code class="lang-python">    @patch(&#39;snippets.models.Snippet.save&#39;, MagicMock(name=&quot;save&quot;))
    def test_post(self):
        &quot;&quot;&quot;
        Test post requests
        &quot;&quot;&quot;
        # Create the request
        data = {
            &#39;title&#39;: &#39;My snippet&#39;,
            &#39;content&#39;: &#39;This is my snippet&#39;
        }
        request = self.factory.post(reverse(&#39;snippet_create&#39;), data)
        request.user = self.user

        # Get the response
        response = SnippetCreateView.as_view()(request)
        self.assertEqual(response.status_code, 302)

        # Check save was called
        self.assertTrue(Snippet.save.called)
        self.assertEqual(Snippet.save.call_count, 1)
</code></pre>
<p>Note first of all the following line:</p>
<pre><code class="lang-python">    @patch(&#39;snippets.models.Snippet.save&#39;, MagicMock(name=&quot;save&quot;))
</code></pre>
<p>Here we’re saying that in this test, when the <code>save()</code> method of the <code>Snippet</code> model is called, it should instead call a mocked version, which lacks the functionality and only registers that it has been called and a few details about it.</p>
<p>Next, we put together the data to be passed through and create a POST request for it. As before, we attach the user to the request. We then pass the request through in the same way as for the GET request. We also check that the response code was 302, meaning that the user would be redirected elsewhere after the form was submitted correctly.</p>
<p>Finally, we assert that <code>Snippet.save.called</code> is true. <code>called</code> is a Boolean value, representing whether the method was called or not. We also check the value of <code>Snippet.save.call_count</code>, which is a count of the number of times the method was called - here we check that it’s set to 1.</p>
<p>As you can see, while the request factory is a little harder than the Django test client to figure out, it’s not too difficult once you get the hang of it. By combining it with judicious use of <code>mock</code>, you can easily test your views in isolation, and without having to interact with the database or set up any middleware, these tests will be much faster than those using the Django test client.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django Blog Tutorial - the Next Generation - Part 9]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/09/28/django-blog-tutorial-the-next-generation-part-9/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/09/28/django-blog-tutorial-the-next-generation-part-9/</guid>
            <pubDate>Sun, 28 Sep 2014 19:51:02 GMT</pubDate>
            <description><![CDATA[<p>Yes, I know the eight instalment was meant to be the last one! Within 24 hours of that post going live, Django 1.7 was released, so naturally I’d like to show you how to upgrade to it.</p>
<p>The biggest change is that Django 1.7 introduces its own migration system, which means South is now surplus to requirements. We therefore need to switch from South to Django’s native migrations. Fortunately, this is fairly straightforward.</p>
<p>First of all, activate your virtualenv:</p>
<pre><code class="lang-bash">$ virtualenv venv
</code></pre>
<p>Then make sure your migrations are up to date:</p>
<pre><code class="lang-bash">$ python manage.py syncdb
$ python manage.py migrate
</code></pre>
<p>Then, upgrade your Django version and uninstall South:</p>
<pre><code class="lang-bash">$ pip install Django --upgrade
$ pip uninstall South
$ pip freeze &gt; requirements.txt
</code></pre>
<p>Next, remove South from <code>INSTALLED_APPS</code> in <code>django_tutorial_blog_ng/settings.py</code>.</p>
<p>You now need to delete all of the numbered migration files in <code>blogengine/migrations/</code>, and the relevant <code>.pyc</code> files, but NOT the directory or the <code>__init__.py</code> file. You can do so with this command on Linux or OS X:</p>
<pre><code class="lang-bash">$ rm blogengine/migrations/00*
</code></pre>
<p>Next, we recreate our migrations with the following command:</p>
<pre><code class="lang-bash">$ python manage.py makemigrations
Migrations for &#39;blogengine&#39;:
  0001_initial.py:
    - Create model Category
    - Create model Post
    - Create model Tag
    - Add field tags to post
</code></pre>
<p>Then we run the migrations:</p>
<pre><code class="lang-bash">$ python manage.py migrate
Operations to perform:
  Synchronize unmigrated apps: sitemaps, django_jenkins, debug_toolbar
  Apply all migrations: sessions, admin, sites, flatpages, contenttypes, auth, blogengine
Synchronizing apps without migrations:
  Creating tables...
  Installing custom SQL...
  Installing indexes...
Running migrations:
  Applying contenttypes.0001_initial... FAKED
  Applying auth.0001_initial... FAKED
  Applying admin.0001_initial... FAKED
  Applying sites.0001_initial... FAKED
  Applying blogengine.0001_initial... FAKED
  Applying flatpages.0001_initial... FAKED
  Applying sessions.0001_initial... FAKED
</code></pre>
<p>Don’t worry too much if the output doesn’t look exactly the same as this - as long as it works, that’s the main thing.</p>
<p>Let’s run our test suite to ensure it works:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database for alias &#39;default&#39;...
....FF.F.FFFFFF..............
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 385, in test_create_post
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_create_post_without_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 417, in test_create_post_without_tag
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 278, in test_delete_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_delete_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 346, in test_delete_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 255, in test_edit_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 447, in test_edit_post
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 323, in test_edit_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_login (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 183, in test_login
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

======================================================================
FAIL: test_logout (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 214, in test_logout
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

----------------------------------------------------------------------
Ran 29 tests in 7.383s

FAILED (failures=9)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We have an issue here. A load of the tests for the admin interface now fail. If we now try running the dev server, we see this error:</p>
<pre><code class="lang-bash">$ python manage.py runserver
Performing system checks...

System check identified no issues (0 silenced).
September 28, 2014 - 20:16:47
Django version 1.7, using settings &#39;django_tutorial_blog_ng.settings&#39;
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
Unhandled exception in thread started by &lt;function wrapper at 0x1024a5ed8&gt;
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/autoreload.py&quot;, line 222, in wrapper
    fn(*args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/management/commands/runserver.py&quot;, line 132, in inner_run
    handler = self.get_handler(*args, **options)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/staticfiles/management/commands/runserver.py&quot;, line 25, in get_handler
    handler = super(Command, self).get_handler(*args, **options)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/management/commands/runserver.py&quot;, line 48, in get_handler
    return get_internal_wsgi_application()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/servers/basehttp.py&quot;, line 66, in get_internal_wsgi_application
    sys.exc_info()[2])
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/servers/basehttp.py&quot;, line 56, in get_internal_wsgi_application
    return import_string(app_path)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/module_loading.py&quot;, line 26, in import_string
    module = import_module(module_path)
  File &quot;/usr/local/Cellar/python/2.7.8_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/importlib/__init__.py&quot;, line 37, in import_module
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/django_tutorial_blog_ng/wsgi.py&quot;, line 14, in &lt;module&gt;
    from dj_static import Cling
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/dj_static.py&quot;, line 7, in &lt;module&gt;
    from django.core.handlers.base import get_path_info
django.core.exceptions.ImproperlyConfigured: WSGI application &#39;django_tutorial_blog_ng.wsgi.application&#39; could not be loaded; Error importing module: &#39;cannot import name get_path_info&#39;
</code></pre>
<p>Fortunately, the error above is easy to fix by upgrading <code>dj_static</code>:</p>
<pre><code class="lang-bash">$ pip install dj_static --upgrade
$ pip freeze &gt; requirements.txt
</code></pre>
<p>That resolves the error in serving static files, but not the error with the admin. If you run the dev server, you’ll be able to see that the admin actually works fine. The problem is caused by the test client not following redirects in the admin. We can easily run just the admin tests with the following command:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine.tests.AdminTest
Creating test database for alias &#39;default&#39;...
.FF.F.FFFFFF
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 385, in test_create_post
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_create_post_without_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 417, in test_create_post_without_tag
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 278, in test_delete_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_delete_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 346, in test_delete_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 255, in test_edit_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 447, in test_edit_post
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 323, in test_edit_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_login (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 183, in test_login
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

======================================================================
FAIL: test_logout (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 214, in test_logout
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

----------------------------------------------------------------------
Ran 12 tests in 3.283s

FAILED (failures=9)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s commit our changes so far first:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/ requirements.txt blogengine/
$ git commit -m &#39;Upgraded to Django 1.7&#39;
</code></pre>
<p>Now let’s fix our tests. Here’s the amended version of the <code>AdminTest</code> class:</p>
<pre><code class="lang-python">class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;, follow=True)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

    def test_create_category(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/category/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new category
        response = self.client.post(&#39;/admin/blogengine/category/add/&#39;, {
            &#39;name&#39;: &#39;python&#39;,
            &#39;description&#39;: &#39;The Python programming language&#39;
            },
            follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new category now in database
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 1)

    def test_edit_category(self):
        # Create the category
        category = CategoryFactory()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the category
        response = self.client.post(&#39;/admin/blogengine/category/&#39; + str(category.pk) + &#39;/&#39;, {
            &#39;name&#39;: &#39;perl&#39;,
            &#39;description&#39;: &#39;The Perl programming language&#39;
            }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check category amended
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 1)
        only_category = all_categories[0]
        self.assertEquals(only_category.name, &#39;perl&#39;)
        self.assertEquals(only_category.description, &#39;The Perl programming language&#39;)

    def test_delete_category(self):
        # Create the category
        category = CategoryFactory()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the category
        response = self.client.post(&#39;/admin/blogengine/category/&#39; + str(category.pk) + &#39;/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check category deleted
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 0)

    def test_create_tag(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/tag/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new tag
        response = self.client.post(&#39;/admin/blogengine/tag/add/&#39;, {
            &#39;name&#39;: &#39;python&#39;,
            &#39;description&#39;: &#39;The Python programming language&#39;
            },
            follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new tag now in database
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 1)

    def test_edit_tag(self):
        # Create the tag
        tag = TagFactory()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the tag
        response = self.client.post(&#39;/admin/blogengine/tag/&#39; + str(tag.pk) + &#39;/&#39;, {
            &#39;name&#39;: &#39;perl&#39;,
            &#39;description&#39;: &#39;The Perl programming language&#39;
            }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check tag amended
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 1)
        only_tag = all_tags[0]
        self.assertEquals(only_tag.name, &#39;perl&#39;)
        self.assertEquals(only_tag.description, &#39;The Perl programming language&#39;)

    def test_delete_tag(self):
        # Create the tag
        tag = TagFactory()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the tag
        response = self.client.post(&#39;/admin/blogengine/tag/&#39; + str(tag.pk) + &#39;/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check tag deleted
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 0)

    def test_create_post(self):
        # Create the category
        category = CategoryFactory()

        # Create the tag
        tag = TagFactory()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: str(category.pk),
            &#39;tags&#39;: str(tag.pk)
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_create_post_without_tag(self):
        # Create the category
        category = CategoryFactory()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: str(category.pk)
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the post
        post = PostFactory()

        # Create the category
        category = CategoryFactory()

        # Create the tag
        tag = TagFactory()
        post.tags.add(tag)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/&#39; + str(post.pk) + &#39;/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: str(category.pk),
            &#39;tags&#39;: str(tag.pk)
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the post
        post = PostFactory()

        # Create the tag
        tag = TagFactory()
        post.tags.add(tag)

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/&#39; + str(post.pk) + &#39;/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post deleted
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)
</code></pre>
<p>There are two main issues here. The first is that when we try to edit or delete an existing item, or refer to it when creating something else, we can no longer rely on the number representing the primary key being set to 1. So we need to specifically obtain this, rather than hard-coding it to 1. Therefore, whenever we pass through a number to represent an item (with the exception of the site, but including tags, categories and posts), we need to instead fetch its primary key and return it. So, above where we try to delete a post, we replace <code>1</code> with <code>str(post.pk)</code>. This will solve a lot of the problems. As there’s a lot of them, I won’t go through each one, but you can see the entire class above for reference, and if you’ve followed along so far, you shouldn’t have any problems.</p>
<p>The other issue we need to fix is the login and logout tests. We simply add <code>follow=True</code> to these to ensure that the test client follows the redirects.</p>
<p>Let’s run our tests to make sure they pass:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database for alias &#39;default&#39;...
.............................
----------------------------------------------------------------------
Ran 29 tests in 8.210s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>With that done, you can commit your changes:</p>
<pre><code class="lang-bash">$ git add blogengine/tests.py
$ git commit -m &#39;Fixed broken tests&#39;
</code></pre>
<p>Don’t forget to deploy your changes:</p>
<pre><code class="lang-bash">$ fab deploy
</code></pre>
<p>Our blog has now been happily migrated over to Django 1.7!</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django Blog Tutorial - the Next Generation - Part 8]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/08/31/django-blog-tutorial-the-next-generation-part-8/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/08/31/django-blog-tutorial-the-next-generation-part-8/</guid>
            <pubDate>Sun, 31 Aug 2014 21:00:00 GMT</pubDate>
            <description><![CDATA[<p>Hello again! In our final instalment, we’ll wrap up our blog by:</p>
<ul>
<li>Implementing a sitemap</li>
<li>Optimising and tidying up the site</li>
<li>Creating a Fabric task for easier deployment</li>
</ul>
<p>I’ll also cover development tools and practices that can make using Django easier. But first there’s a few housekeeping tasks that need doing…</p>
<p>Don’t forget to activate your virtualenv - you should know how to do this off by heart by now!</p>
<h1 id="upgrading-django">Upgrading Django</h1>
<p>At the time of writing, Django 1.7 is due any day now, but it’s not out yet so I won’t cover it. The biggest change is the addition of a built-in migration system, but switching from South to this is well-documented. When Django 1.7 comes out, it shouldn’t be difficult to upgrade to it - because we have good test coverage, we shouldn’t have much trouble catching errors.</p>
<p>However, Django 1.6.6 was recently released, and we need to upgrade to it. Just enter the following command to upgrade:</p>
<pre><code class="lang-bash">$ pip install Django --upgrade
</code></pre>
<p>Then add it to your <code>requirements.txt</code>:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>Then commit your changes:</p>
<pre><code class="lang-bash">$ git add requirements.txt
$ git commit -m &#39;Upgraded Django version&#39;
</code></pre>
<h1 id="implementing-a-sitemap">Implementing a sitemap</h1>
<p>Creating a sitemap for your blog is a good idea - it can be submitted to search engines, so that they can easily find your content. With Django, it’s pretty straightforward too.</p>
<p>First, let’s create a test for our sitemap. Add the following code at the end of <code>tests.py</code>:</p>
<pre><code class="lang-python">class SitemapTest(BaseAcceptanceTest):
    def test_sitemap(self):
        # Create a post
        post = PostFactory()

        # Create a flat page
        page = FlatPageFactory()

        # Get sitemap
        response = self.client.get(&#39;/sitemap.xml&#39;)
        self.assertEquals(response.status_code, 200)

        # Check post is present in sitemap
        self.assertTrue(&#39;my-first-post&#39; in response.content)

        # Check page is present in sitemap
        self.assertTrue(&#39;/about/&#39; in response.content)
</code></pre>
<p>Run it, and you should see the test fail:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
...........................F
======================================================================
FAIL: test_sitemap (blogengine.tests.SitemapTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 847, in test_sitemap
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 28 tests in 6.873s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Now, let’s implement our sitemap. The sitemap application comes with Django, and needs to be activated in your settings file, under <code>INSTALLED_APPS</code>:</p>
<pre><code class="lang-python">    &#39;django.contrib.sitemaps&#39;,
</code></pre>
<p>Next, let’s think about what content we want to include in the sitemap. We want to index our flat pages and our blog posts, so our sitemap should reflect that. Create a new file at <code>blogengine/sitemap.py</code> and enter the following text:</p>
<pre><code class="lang-python">from django.contrib.sitemaps import Sitemap
from django.contrib.flatpages.models import FlatPage
from blogengine.models import Post

class PostSitemap(Sitemap):
    changefreq = &quot;always&quot;
    priority = 0.5

    def items(self):
        return Post.objects.all()

    def lastmod(self, obj):
        return obj.pub_date


class FlatpageSitemap(Sitemap):
    changefreq = &quot;always&quot;
    priority = 0.5

    def items(self):
        return FlatPage.objects.all()
</code></pre>
<p>We define two sitemaps, one for all the posts, and the other for all the flat pages. Note that this works in a very similar way to the syndication framework.</p>
<p>Next, we amend our URLs. Add the following text after the existing imports in your URL file:</p>
<pre><code class="lang-python">from django.contrib.sitemaps.views import sitemap
from blogengine.sitemap import PostSitemap, FlatpageSitemap

# Define sitemaps
sitemaps = {
    &#39;posts&#39;: PostSitemap,
    &#39;pages&#39;: FlatpageSitemap
}
</code></pre>
<p>Then add the following after the existing routes:</p>
<pre><code class="lang-python">    # Sitemap
    url(r&#39;^sitemap\.xml$&#39;, sitemap, {&#39;sitemaps&#39;: sitemaps},
            name=&#39;django.contrib.sitemaps.views.sitemap&#39;),
</code></pre>
<p>Here we define what sitemaps we’re going to use, and we define a URL for them. It’s pretty straightforward to use.</p>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
............................
----------------------------------------------------------------------
Ran 28 tests in 6.863s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>And done! Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/ django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Implemented a sitemap&#39;
</code></pre>
<h1 id="fixing-test-coverage">Fixing test coverage</h1>
<p>Our blog is now feature-complete, but there are a few gaps in test coverage, so we’ll fix them. If, like me, you’re using Coveralls.io, <a href="https://coveralls.io/builds/1151177">you can easily see via their web interface where there are gaps in the coverage</a>.</p>
<p>Now, our gaps are all in our view file - if you <a href="https://coveralls.io/files/280228813">take a look at my build</a>, you can easily identify the gaps as they’re marked in red.</p>
<p>The first gap is where a tag does not exist. Interestingly, if we look at the code in the view, we can see that some of it is redundant:</p>
<pre><code class="lang-python">class TagPostsFeed(PostsFeed):
    def get_object(self, request, slug):
        return get_object_or_404(Tag, slug=slug)

    def title(self, obj):
        return &quot;RSS feed - blog posts tagged  %s&quot; % obj.name

    def link(self, obj):
        return obj.get_absolute_url()

    def description(self, obj):
        return &quot;RSS feed - blog posts tagged %s&quot; % obj.name

    def items(self, obj):
        try:
            tag = Tag.objects.get(slug=obj.slug)
            return tag.post_set.all()
        except Tag.DoesNotExist:
            return Post.objects.none()
</code></pre>
<p>Under the <code>items</code> function, we check to see if the tag exists. However, under <code>get_object</code> we can see that if the object didn’t exist, it would already have returned a 404 error. We can therefore safely amend <code>items</code> to not check, since that try statement will never fail:</p>
<pre><code class="lang-python">class TagPostsFeed(PostsFeed):
    def get_object(self, request, slug):
        return get_object_or_404(Tag, slug=slug)

    def title(self, obj):
        return &quot;RSS feed - blog posts tagged  %s&quot; % obj.name

    def link(self, obj):
        return obj.get_absolute_url()

    def description(self, obj):
        return &quot;RSS feed - blog posts tagged %s&quot; % obj.name

    def items(self, obj):
        tag = Tag.objects.get(slug=obj.slug)
        return tag.post_set.all()
</code></pre>
<p>The other two gaps are in our search view - we never get an empty result for the search in the following section:</p>
<pre><code class="lang-python">def getSearchResults(request):
    &quot;&quot;&quot;
    Search for a post by title or text
    &quot;&quot;&quot;
    # Get the query data
    query = request.GET.get(&#39;q&#39;, &#39;&#39;)
    page = request.GET.get(&#39;page&#39;, 1)

    # Query the database
    if query:
        results = Post.objects.filter(Q(text__icontains=query) | Q(title__icontains=query))
    else:
        results = None

    # Add pagination
    pages = Paginator(results, 5)

    # Get specified page
    try:
        returned_page = pages.page(page)
    except EmptyPage:
        returned_page = pages.page(pages.num_pages)

    # Display the search results
    return render_to_response(&#39;blogengine/search_post_list.html&#39;,
                              {&#39;page_obj&#39;: returned_page,
                               &#39;object_list&#39;: returned_page.object_list,
                               &#39;search&#39;: query})
</code></pre>
<p>So replace it with this:</p>
<pre><code class="lang-python">def getSearchResults(request):
    &quot;&quot;&quot;
    Search for a post by title or text
    &quot;&quot;&quot;
    # Get the query data
    query = request.GET.get(&#39;q&#39;, &#39;&#39;)
    page = request.GET.get(&#39;page&#39;, 1)

    # Query the database
    results = Post.objects.filter(Q(text__icontains=query) | Q(title__icontains=query))

    # Add pagination
    pages = Paginator(results, 5)

    # Get specified page
    try:
        returned_page = pages.page(page)
    except EmptyPage:
        returned_page = pages.page(pages.num_pages)

    # Display the search results
    return render_to_response(&#39;blogengine/search_post_list.html&#39;,
                              {&#39;page_obj&#39;: returned_page,
                               &#39;object_list&#39;: returned_page.object_list,
                               &#39;search&#39;: query})
</code></pre>
<p>We don’t need to check whether <code>query</code> is defined because if <code>q</code> is left blank, the value of <code>query</code> will be an empty string, so we may as well pull out the redundant code.</p>
<p>Finally, the other gap is for when a user tries to get an empty search page (eg, page two of something with five or less results). So let’s add another test to our <code>SearchViewTest</code> class:</p>
<pre><code class="lang-python">    def test_failing_search(self):
        # Search for something that is not present
        response = self.client.get(&#39;/search?q=wibble&#39;)
        self.assertEquals(response.status_code, 200)
        self.assertTrue(&#39;No posts found&#39; in response.content)

        # Try to get nonexistent second page
        response = self.client.get(&#39;/search?q=wibble&amp;page=2&#39;)
        self.assertEquals(response.status_code, 200)
        self.assertTrue(&#39;No posts found&#39; in response.content)
</code></pre>
<p>Run our tests and check the coverage:</p>
<pre><code class="lang-bash">$ coverage run --include=&quot;blogengine/*&quot; --omit=&quot;blogengine/migrations/*&quot; manage.py test blogengine
$ coverage html
</code></pre>
<p>If you open <code>htmlcov/index.html</code> in your browser, you should see that the test coverage is back up to 100%. With that done, it’s time to commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Fixed gaps in coverage&#39;
</code></pre>
<p>Remember, it’s not always possible to achieve 100% test coverage, and you shouldn’t worry too much about it if it’s not possible - <a href="http://nedbatchelder.com/code/coverage/excluding.html">it’s possible to ignore code</a> if necessary. However, it’s a good idea to aim for 100%.</p>
<h1 id="using-fabric-for-deployment">Using Fabric for deployment</h1>
<p>Next we’ll cover using Fabric, a handy tool for deploying your changes (any pretty much any other task you want to automate). First, you need to install it:</p>
<pre><code class="lang-bash">$ pip install Fabric
</code></pre>
<p>If you have any problems installing it, you should be able to resolve them via Google - most of them are likely to be absent libraries that Fabric depends upon. Once it’s installed, add it to your <code>requirements.tzt</code>:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>Next, create a file called <code>fabfile.py</code> and enter the following text:</p>
<pre><code class="lang-python">#!/usr/bin/env python
from fabric.api import local

def deploy():
    &quot;&quot;&quot;
    Deploy the latest version to Heroku
    &quot;&quot;&quot;
    # Push changes to master
    local(&quot;git push origin master&quot;)

    # Push changes to Heroku
    local(&quot;git push heroku master&quot;)

    # Run migrations on Heroku
    local(&quot;heroku run python manage.py migrate&quot;)
</code></pre>
<p>Now, all this file does is push our changes to Github (or wherever else your repository is hosted) and to Heroku, and runs your migrations. It’s not a terribly big task anyway, but it’s handy to have it in place. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add fabfile.py requirements.txt
$ git commit -m &#39;Added Fabric task for deployment&#39;
</code></pre>
<p>Then, let’s try it out:</p>
<pre><code class="lang-bash">$ fab deploy
</code></pre>
<p>There, wasn’t that more convenient? Fabric is much more powerful than this simple demonstration indicates, and can run tasks on remote servers via SSH easily. I recommend you take a look at the <a href="http://www.fabfile.org/">documentation</a> to see what else you can do with it. If you’re hosting your site on a VPS, you will probably find Fabric indispensable, as you will need to restart the application every time you push up a new revision.</p>
<h1 id="tidying-up">Tidying up</h1>
<p>We want our blog application to play nicely with other Django apps. For instance, say you’re working on a new site that includes a blogging engine. Wouldn’t it make sense to just be able to drop in this blogging engine and have it work immediately? At the moment, some of our URL’s are hard-coded, so we may have problems in doing so. Let’s fix that.</p>
<p>First we’ll amend our tests. Add this at the top of the tests file:</p>
<pre><code class="lang-python">from django.core.urlresolvers import reverse
</code></pre>
<p>Next, replace every instance of this:</p>
<pre><code class="lang-python">        response = self.client.get(&#39;/&#39;)
</code></pre>
<p>with this:</p>
<pre><code class="lang-python">response = self.client.get(reverse(&#39;blogengine:index&#39;))
</code></pre>
<p>Then, rewrite the calls to the search route. For instance, this:</p>
<pre><code class="lang-python">        response = self.client.get(&#39;/search?q=first&#39;)
</code></pre>
<p>should become this:</p>
<pre><code class="lang-python">        response = self.client.get(reverse(&#39;blogengine:search&#39;) + &#39;?q=first&#39;)
</code></pre>
<p>I’ll leave changing these as an exercise for the reader, but check the repository if you get stuck.</p>
<p>Next, we need to assign a namespace to our app’s routes:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns(&#39;&#39;,
    # Examples:
    # url(r&#39;^$&#39;, &#39;django_tutorial_blog_ng.views.home&#39;, name=&#39;home&#39;),
    # url(r&#39;^blog/&#39;, include(&#39;blog.urls&#39;)),

    url(r&#39;^admin/&#39;, include(admin.site.urls)),

    # Blog URLs
    url(r&#39;&#39;, include(&#39;blogengine.urls&#39;, namespace=&quot;blogengine&quot;)),

    # Flat pages
    url(r&#39;&#39;, include(&#39;django.contrib.flatpages.urls&#39;)),
)
</code></pre>
<p>We then assign names to our routes in the app’s <code>urls.py</code>:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView, DetailView
from blogengine.models import Post, Category, Tag
from blogengine.views import CategoryListView, TagListView, PostsFeed, CategoryPostsFeed, TagPostsFeed, getSearchResults
from django.contrib.sitemaps.views import sitemap
from blogengine.sitemap import PostSitemap, FlatpageSitemap

# Define sitemaps
sitemaps = {
    &#39;posts&#39;: PostSitemap,
    &#39;pages&#39;: FlatpageSitemap
}

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        ),
        name=&#39;index&#39;
        ),

    # Individual posts
    url(r&#39;^(?P&lt;pub_date__year&gt;\d{4})/(?P&lt;pub_date__month&gt;\d{1,2})/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, DetailView.as_view(
        model=Post,
        ),
        name=&#39;post&#39;
        ),

    # Categories
    url(r&#39;^category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryListView.as_view(
        paginate_by=5,
        model=Category,
        ),
        name=&#39;category&#39;
        ),


    # Tags
    url(r&#39;^tag/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, TagListView.as_view(
        paginate_by=5,
        model=Tag,
        ),
        name=&#39;tag&#39;
        ),

    # Post RSS feed
    url(r&#39;^feeds/posts/$&#39;, PostsFeed()),

    # Category RSS feed
    url(r&#39;^feeds/posts/category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryPostsFeed()),

    # Tag RSS feed
    url(r&#39;^feeds/posts/tag/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, TagPostsFeed()),

    # Search posts
    url(r&#39;^search&#39;, getSearchResults, name=&#39;search&#39;),

    # Sitemap
    url(r&#39;^sitemap\.xml$&#39;, sitemap, {&#39;sitemaps&#39;: sitemaps},
            name=&#39;django.contrib.sitemaps.views.sitemap&#39;),
)
</code></pre>
<p>You also need to amend two of your templates:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;!--[if lt IE 7]&gt;      &lt;html class=&quot;no-js lt-ie9 lt-ie8 lt-ie7&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 7]&gt;         &lt;html class=&quot;no-js lt-ie9 lt-ie8&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 8]&gt;         &lt;html class=&quot;no-js lt-ie9&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if gt IE 8]&gt;&lt;!--&gt; &lt;html class=&quot;no-js&quot;&gt; &lt;!--&lt;![endif]--&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;title&gt;{% block title %}My Django Blog{% endblock %}&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
        &lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;Blog posts&quot; href=&quot;/feeds/posts/&quot; &gt;

        &lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;

        {% load staticfiles %}
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/normalize.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap-theme.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/code.css&#39; %}&quot;&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/modernizr-2.6.2.min.js&#39; %}&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;!--[if lt IE 7]&gt;
            &lt;p class=&quot;browsehappy&quot;&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href=&quot;http://browsehappy.com/&quot;&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;

        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;container-fluid&quot;&gt;
                &lt;div class=&quot;navbar-header&quot;&gt;
                    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#header-nav&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/button&gt;
                    &lt;a class=&quot;navbar-brand&quot; href=&quot;{% url &#39;blogengine:index&#39; %}&quot;&gt;My Django Blog&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;header-nav&quot;&gt;
                    &lt;ul class=&quot;nav navbar-nav&quot;&gt;
                        {% load flatpages %}
                        {% get_flatpages as flatpages %}
                        {% for flatpage in flatpages %}
                        &lt;li&gt;&lt;a href=&quot;{{ flatpage.url }}&quot;&gt;{{ flatpage.title }}&lt;/a&gt;&lt;/li&gt;
                        {% endfor %}
                        &lt;li&gt;&lt;a href=&quot;/feeds/posts/&quot;&gt;RSS feed&lt;/a&gt;&lt;/li&gt;

                        &lt;form action=&quot;/search&quot; method=&quot;GET&quot; class=&quot;navbar-form navbar-left&quot;&gt;
                            &lt;div class=&quot;form-group&quot;&gt;
                                &lt;input type=&quot;text&quot; name=&quot;q&quot; placeholder=&quot;Search...&quot; class=&quot;form-control&quot;&gt;&lt;/input&gt;
                            &lt;/div&gt;
                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Search&lt;/button&gt;
                        &lt;/form&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container&quot;&gt;
            {% block header %}
                &lt;div class=&quot;page-header&quot;&gt;
                    &lt;h1&gt;My Django Blog&lt;/h1&gt;
                &lt;/div&gt;
            {% endblock %}

            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container footer&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                &lt;div class=&quot;span12&quot;&gt;
                    &lt;p&gt;Copyright &amp;copy; {% now &quot;Y&quot; %}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;window.jQuery || document.write(&#39;&lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/jquery-1.10.2.min.js&#39; %}&quot;&gt;&lt;\/script&gt;&#39;)&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/plugins.js&#39; %}&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/bootstrap/dist/js/bootstrap.min.js&#39; %}&quot;&gt;&lt;/script&gt;

        &lt;!-- Google Analytics: change UA-XXXXX-X to be your site&#39;s ID. --&gt;
        &lt;script&gt;
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src=&#39;//www.google-analytics.com/analytics.js&#39;;
            r.parentNode.insertBefore(e,r)}(window,document,&#39;script&#39;,&#39;ga&#39;));
            ga(&#39;create&#39;,&#39;UA-XXXXX-X&#39;);ga(&#39;send&#39;,&#39;pageview&#39;);
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% if object_list %}
            {% for post in object_list %}
            &lt;div class=&quot;post col-md-12&quot;&gt;
            &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
            &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
            {{ post.text|custom_markdown }}
            &lt;/div&gt;
            {% if post.category %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-primary&quot;&gt;{{ post.category.name }}&lt;/span&gt;&lt;/a&gt;
            &lt;/div&gt;
            {% endif %}
            {% if post.tags %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            {% for tag in post.tags.all %}
            &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-success&quot;&gt;{{ tag.name }}&lt;/span&gt;&lt;/a&gt;
            {% endfor %}
            &lt;/div&gt;
            {% endif %}
            {% endfor %}
        {% else %}
            &lt;p&gt;No posts found&lt;/p&gt;
        {% endif %}

        &lt;ul class=&quot;pager&quot;&gt;
        {% if page_obj.has_previous %}
        &lt;li class=&quot;previous&quot;&gt;&lt;a href=&quot;{% url &#39;blogengine:search&#39; %}?page={{ page_obj.previous_page_number }}&amp;q={{ search }}&quot;&gt;Previous Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;li class=&quot;next&quot;&gt;&lt;a href=&quot;{% url &#39;blogengine:search&#39; %}?page={{ page_obj.next_page_number }}&amp;q={{ search }}&quot;&gt;Next Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        &lt;/ul&gt;

    {% endblock %}
</code></pre>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine/
Creating test database for alias &#39;default&#39;...
.............................
----------------------------------------------------------------------
Ran 29 tests in 10.456s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>And commit our changes:</p>
<pre><code class="lang-bash">$ git add .
$ git commit -m &#39;Now use named routes&#39;
</code></pre>
<h1 id="debugging-django">Debugging Django</h1>
<p>There are a number of handy ways to debug Django applications. One of the simplest is to use the Python debugger. To use it, just enter the following lines at the point you want to break at:</p>
<pre><code class="lang-python">import pdb
pdb.set_trace()
</code></pre>
<p>Now, whenever that line of code is run, you’ll be dropped into an interactive shell that lets you play around to find out what’s going wrong. However, it doesn’t offer autocompletion, so we’ll install <code>ipdb</code>, which is an improved version:</p>
<pre><code class="lang-bash">$ pip install ipdb
$ pip freeze &gt; requirements.txt
</code></pre>
<p>Now you can use <code>ipdb</code> in much the same way as you would use <code>pdb</code>:</p>
<pre><code class="lang-python">import ipdb
ipdb.set_trace()
</code></pre>
<p>Now, <code>ipdb</code> is very useful, but it isn’t much help for profiling your application. For that you need the Django Debug Toolbar. Run the following commands:</p>
<pre><code class="lang-bash">$ pip install django-debug-toolbar
$ pip freeze &gt; requirements.txt
</code></pre>
<p>Then add the following line to <code>INSTALLED_APPS</code> in your settings file:</p>
<pre><code class="lang-python">    &#39;debug_toolbar&#39;,
</code></pre>
<p>Then, try running the development server, and you’ll see a toolbar on the right-hand side of the screen that allows you to view some useful data about your page. For instance, you’ll notice a field called <code>SQL</code> - this contains details of the queries carried out when building the page. To actually see the queries carried out, you’ll want to disable caching in your settings file by commenting out all the constants that start with <code>CACHE</code>.</p>
<p>We won’t go into using the toolbar to optimise queries, but using this, you can easily see what queries are being executed on a specific page, how long they take, and the values they return. Sometimes, you may need to optimise a slow query - in this case, Django allows you to drop down to writing raw SQL if necessary.</p>
<p>Note that if you’re running Django in production, you should set <code>DEBUG</code> to <code>False</code> as otherwise it gives rather too much information to potential attackers, and with Django Debug Toolbar installed, that’s even more important.</p>
<p>Please also note that when you disable debug mode, Django no longer handles static files automatically, so you’ll need to run <code>python manage.py collectstatic</code> and commit the <code>staticfiles</code> directory.</p>
<p>Once you’ve disabled debug mode, collected the static files, and re-enables caching, you can commit your changes:</p>
<pre><code class="lang-bash">$ git add .
$ git commit -m &#39;Installed debugging tools&#39;
</code></pre>
<h1 id="optimising-static-files">Optimising static files</h1>
<p>We want our blog to get the best SEO results it can, so making it fast is essential. One of the simplest things you can do is to concatenate and minify static assets such as CSS and JavaScript. There are numerous ways to do this, but I generally use Grunt. Let’s set up a Grunt config to concatenate and minify our CSS and JavaScript.</p>
<p>You’ll need to have Node.js installed on your development machine for this. Then, you need to install the Grunt command-line interface:</p>
<pre><code class="lang-bash">$ sudo npm install -g grunt-cli
</code></pre>
<p>With that done, we need to create a <code>package.json</code> file. You can create one using the command <code>npm init</code>. Here’s mine:</p>
<pre><code class="lang-json">{
  &quot;name&quot;: &quot;django_tutorial_blog_ng&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;Django Tutorial Blog NG =======================&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;repository&quot;: {
    &quot;type&quot;: &quot;git&quot;,
    &quot;url&quot;: &quot;https://github.com/matthewbdaly/django_tutorial_blog_ng.git&quot;
  },
  &quot;author&quot;: &quot;Matthew Daly &lt;matthew@matthewdaly.co.uk&gt; (http://matthewdaly.co.uk/)&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;bugs&quot;: {
    &quot;url&quot;: &quot;https://github.com/matthewbdaly/django_tutorial_blog_ng/issues&quot;
  },
  &quot;homepage&quot;: &quot;https://github.com/matthewbdaly/django_tutorial_blog_ng&quot;
}
</code></pre>
<p>Feel free to amend  it as you see fit.</p>
<p>Next we install Grunt and the required plugins:</p>
<pre><code class="lang-bash">$ npm install grunt grunt-contrib-cssmin grunt-contrib-concat grunt-contrib-uglify --save-dev
</code></pre>
<p>We now need to create a Gruntfile for our tasks:</p>
<pre><code class="lang-javascript">module.exports = function (grunt) {
    &#39;use strict&#39;;

    grunt.initConfig({
        concat: {
            dist: {
                src: [
                    &#39;blogengine/static/bower_components/bootstrap/dist/css/bootstrap.css&#39;,
                    &#39;blogengine/static/bower_components/bootstrap/dist/css/bootstrap-theme.css&#39;,
                    &#39;blogengine/static/css/code.css&#39;,
                    &#39;blogengine/static/css/main.css&#39;,
                ],
                dest: &#39;blogengine/static/css/style.css&#39;
            }
        },
        uglify: {
            dist: {
                src: [
                    &#39;blogengine/static/bower_components/jquery/jquery.js&#39;,
                    &#39;blogengine/static/bower_components/bootstrap/dist/js/bootstrap.js&#39;
                ],
                dest: &#39;blogengine/static/js/all.min.js&#39;
            }
        },
        cssmin: {
            dist: {
                src: &#39;blogengine/static/css/style.css&#39;,
                dest: &#39;blogengine/static/css/style.min.css&#39;
            }
        }
    });

    grunt.loadNpmTasks(&#39;grunt-contrib-concat&#39;);
    grunt.loadNpmTasks(&#39;grunt-contrib-uglify&#39;);
    grunt.loadNpmTasks(&#39;grunt-contrib-cssmin&#39;);
    grunt.registerTask(&#39;default&#39;, [&#39;concat&#39;, &#39;uglify&#39;, &#39;cssmin&#39;]);
};
</code></pre>
<p>You’ll also need to change the paths in your base HTML file to point to the minified versions:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;!--[if lt IE 7]&gt;      &lt;html class=&quot;no-js lt-ie9 lt-ie8 lt-ie7&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 7]&gt;         &lt;html class=&quot;no-js lt-ie9 lt-ie8&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 8]&gt;         &lt;html class=&quot;no-js lt-ie9&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if gt IE 8]&gt;&lt;!--&gt; &lt;html class=&quot;no-js&quot;&gt; &lt;!--&lt;![endif]--&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;title&gt;{% block title %}My Django Blog{% endblock %}&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
        &lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;Blog posts&quot; href=&quot;/feeds/posts/&quot; &gt;

        &lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;

        {% load staticfiles %}
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/style.min.css&#39; %}&quot;&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;!--[if lt IE 7]&gt;
            &lt;p class=&quot;browsehappy&quot;&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href=&quot;http://browsehappy.com/&quot;&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;

        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;container-fluid&quot;&gt;
                &lt;div class=&quot;navbar-header&quot;&gt;
                    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#header-nav&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/button&gt;
                    &lt;a class=&quot;navbar-brand&quot; href=&quot;{% url &#39;blogengine:index&#39; %}&quot;&gt;My Django Blog&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;header-nav&quot;&gt;
                    &lt;ul class=&quot;nav navbar-nav&quot;&gt;
                        {% load flatpages %}
                        {% get_flatpages as flatpages %}
                        {% for flatpage in flatpages %}
                        &lt;li&gt;&lt;a href=&quot;{{ flatpage.url }}&quot;&gt;{{ flatpage.title }}&lt;/a&gt;&lt;/li&gt;
                        {% endfor %}
                        &lt;li&gt;&lt;a href=&quot;/feeds/posts/&quot;&gt;RSS feed&lt;/a&gt;&lt;/li&gt;

                        &lt;form action=&quot;/search&quot; method=&quot;GET&quot; class=&quot;navbar-form navbar-left&quot;&gt;
                            &lt;div class=&quot;form-group&quot;&gt;
                                &lt;input type=&quot;text&quot; name=&quot;q&quot; placeholder=&quot;Search...&quot; class=&quot;form-control&quot;&gt;&lt;/input&gt;
                            &lt;/div&gt;
                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Search&lt;/button&gt;
                        &lt;/form&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container&quot;&gt;
            {% block header %}
                &lt;div class=&quot;page-header&quot;&gt;
                    &lt;h1&gt;My Django Blog&lt;/h1&gt;
                &lt;/div&gt;
            {% endblock %}

            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container footer&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                &lt;div class=&quot;span12&quot;&gt;
                    &lt;p&gt;Copyright &amp;copy; {% now &quot;Y&quot; %}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;script src=&quot;{% static &#39;js/all.min.js&#39; %}&quot;&gt;&lt;/script&gt;

        &lt;!-- Google Analytics: change UA-XXXXX-X to be your site&#39;s ID. --&gt;
        &lt;script&gt;
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src=&#39;//www.google-analytics.com/analytics.js&#39;;
            r.parentNode.insertBefore(e,r)}(window,document,&#39;script&#39;,&#39;ga&#39;));
            ga(&#39;create&#39;,&#39;UA-XXXXX-X&#39;);ga(&#39;send&#39;,&#39;pageview&#39;);
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Now, run the Grunt task:</p>
<pre><code class="lang-bash">$ grunt
</code></pre>
<p>And collect the static files:</p>
<pre><code class="lang-bash">$ python manage.py collectstatic
</code></pre>
<p>You’ll also want to add your <code>node_modules</code> folder to your <code>gitignore</code>:</p>
<pre><code class="lang-bash">venv/
*.pyc
db.sqlite3
reports/
htmlcov/
.coverage
node_modules/
</code></pre>
<p>Then commit your changes:</p>
<pre><code class="lang-bash">$ git add .
$ git commit -m &#39;Optimised static assets&#39;
</code></pre>
<p>Now, our <code>package.json</code> will cause a problem - it will mean that this app is mistakenly identified as a Node.js app. To prevent this, create the <code>.slugignore</code> file:</p>
<pre><code class="lang-bash">package.json
</code></pre>
<p>Then commit your changes and push them up:</p>
<pre><code class="lang-bash">$ git add .slugignore
$ git commit -m &#39;Added slugignore&#39;
$ fab deploy
</code></pre>
<p>If you check, your site should now be loading the minified versions of the static files.</p>
<p>That’s our site done! As usual I’ve tagged the final commit with <code>lesson-8</code>.</p>
<p>Sadly, that’s our final instalment over with! I hope you’ve enjoyed these tutorials, and I look forward to seeing what you create with them.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django Blog Tutorial - the Next Generation - Part 7]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/08/25/django-blog-tutorial-the-next-generation-part-7/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/08/25/django-blog-tutorial-the-next-generation-part-7/</guid>
            <pubDate>Mon, 25 Aug 2014 16:15:01 GMT</pubDate>
            <description><![CDATA[<p>Hello once again! In this instalment we’ll cover:</p>
<ul>
<li>Caching your content with Memcached to improve your site’s performance</li>
<li>Refactoring and simplifying our tests</li>
<li>Implementing additional feeds</li>
<li>Creating a simple search engine</li>
</ul>
<p>Don’t forget to activate your virtualenv:</p>
<pre><code class="lang-bash">$ source venv/bin/activate
</code></pre>
<p>Now let’s get started!</p>
<h1 id="memcached">Memcached</h1>
<p>If you frequent (or used to frequent) social media sites like Reddit, Slashdot or Digg, you may be familiar with something called variously the Digg or Slashdot effect, whereby if a page gets submitted to a social media site, and subsequently becomes popular, it can be hit by a huge number of HTTP requests in a very short period of time, slowing it down or even taking the server down completely.</p>
<p>Now, as a general rule of thumb, for most dynamic websites such as blogs, the bottleneck is not the web server or the programming language, but the database. If you have a lot of people hitting the same page over and over again in quick succession, then you’re essentially running the same query over and over again and getting the same result each time, which is expensive in terms of processing power. What you need to be able to do is cache the results of the query in memory for a given period of time so that the number of queries is reduced.</p>
<p>That’s where Memcached comes in. It’s a simple key-value store that allows you to store values in memory for a given period of time so that they can be retrieved without having to query the database. Memcached is a very common choice for caching, and is by far the fastest and most efficient type of cache available for Django. It’s also available on Heroku’s free tier.</p>
<p>Django has a very powerful caching framework that supports numerous types of cache in addition to Memcached, such as:</p>
<ul>
<li>Database caching</li>
<li>Filesystem caching</li>
<li>Local memory caching</li>
</ul>
<p>There are also third-party backends for using other caching systems such as Redis.</p>
<p>Now, the cache can be used in a number of different ways. You can cache only certain parts of your site if you wish. However, because our site is heavily content-driven, we should be pretty safe to use the per-site cache, which is the simplest way to set up caching.</p>
<p>In order to set up Memcached, there’s a couple of Python libraries we’ll need. If you want to install them locally, however, you’ll need to install both memcached and libmemcached (on Ubuntu, the packages you need are called <code>memcached</code> and <code>libmemcached-dev</code>) on your development machine. If you don’t want to do this, then just copy and paste these lines into <code>requirements.txt</code> instead:</p>
<pre><code class="lang-bash">django-pylibmc-sasl==0.2.4
pylibmc==1.3.0
</code></pre>
<p>If you are happy to install these dependencies locally, then run this command once memcached and libmemcached are installed:</p>
<pre><code class="lang-bash">$ pip install pylibmc django-pylibmc-sasl
</code></pre>
<p>With that done let’s configure Memcached. Open up the settings file and add the following at the bottom:</p>
<pre><code class="lang-python">def get_cache():
  import os
  try:
    os.environ[&#39;MEMCACHE_SERVERS&#39;] = os.environ[&#39;MEMCACHIER_SERVERS&#39;].replace(&#39;,&#39;, &#39;;&#39;)
    os.environ[&#39;MEMCACHE_USERNAME&#39;] = os.environ[&#39;MEMCACHIER_USERNAME&#39;]
    os.environ[&#39;MEMCACHE_PASSWORD&#39;] = os.environ[&#39;MEMCACHIER_PASSWORD&#39;]
    return {
      &#39;default&#39;: {
        &#39;BACKEND&#39;: &#39;django_pylibmc.memcached.PyLibMCCache&#39;,
        &#39;TIMEOUT&#39;: 300,
        &#39;BINARY&#39;: True,
        &#39;OPTIONS&#39;: { &#39;tcp_nodelay&#39;: True }
      }
    }
  except:
    return {
      &#39;default&#39;: {
        &#39;BACKEND&#39;: &#39;django.core.cache.backends.locmem.LocMemCache&#39;
      }
    }

CACHES = get_cache()
CACHE_MIDDLEWARE_ALIAS = &#39;default&#39;
CACHE_MIDDLEWARE_SECONDS = 300
CACHE_MIDDLEWARE_KEY_PREFIX = &#39;&#39;
</code></pre>
<p>Then add the following to <code>MIDDLEWARE_CLASSES</code>:</p>
<pre><code class="lang-python">    &#39;django.middleware.cache.UpdateCacheMiddleware&#39;,
    &#39;django.middleware.common.CommonMiddleware&#39;,
    &#39;django.middleware.cache.FetchFromCacheMiddleware&#39;,
</code></pre>
<p>That’s it! The first section configures the application to use Memcached to cache the content when running on Heroku, and sets some configuration parameters, while the second  section tells Django to use the per-site cache in order to cache all the site content.</p>
<p>Now, Heroku doesn’t include Memcached by default - instead it’s available as an add-on called Memcachier. To use add-ons you need to set up a credit card for billing. We will set it up to use the free developer plan, but if you outgrow this you can easily switch to a paid plan. To add Memcachier, run this command:</p>
<pre><code class="lang-bash">$ heroku addons:add memcachier:dev
</code></pre>
<p>Please note that Memcachier can take a few minutes to get set up, so you may want to leave it a little while between adding it and pushing up your changes. Now we’ll commit our changes:</p>
<pre><code class="lang-bash">$ git add requirements.txt django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Implemented caching with Memcached&#39;
</code></pre>
<p>Then we’ll push them up to our remote repository and to Heroku:</p>
<pre><code class="lang-bash">$ git push origin master
$ git push heroku master
</code></pre>
<p>And that’s all you need to do to set up Memcached. In addition to storing your query results in Memcached, enabling the caching framework in Django will also set various HTTP headers to enable web proxies and browsers to cache content for an appropriate length of time. If you open up your browser’s developer tools and compare the response headers for your homepage on the latest version of the code with the previous version, you’ll notice that a number of additional headers appear, including <code>Cache-Control</code>, <code>Expires</code> and <code>Last-Modified</code>. These tell web browsers and web proxies how often to request the latest version of the HTML document, in order to help you reduce the bandwidth used.</p>
<p>As you can see, for a site like this where you are the only person adding content, it’s really easy to implement caching with Django, and for a blog there’s very little reason not to do it. If you’re not using Heroku and are instead hosting your site on a VPS, then the configuration will be somewhat different - see <a href="https://docs.djangoproject.com/en/dev/topics/cache/#memcached">here</a> for details. You can also find information on using other cache backends on the same page.</p>
<p>That isn’t all you can do to speed up your site. Heroku doesn’t seem to be very good for serving static files, and if your site is attracting a lot of traffic you might want to host your static files elsewhere, such as on Amazon’s S3 service. Doing so is outside the scope of this tutorial, but for that use case, you should check out <a href="http://django-storages.readthedocs.org/en/latest/index.html">django-storages</a>.</p>
<h1 id="clearing-the-cache-automatically">Clearing the cache automatically</h1>
<p>There is one issue with this implementation. As it is right now, if you view the home page, add a post, then reload the page, you may not see the new post immediately because the cache will continue serving the old version until it has expired. That behaviour is less than ideal - we would like the cache to be cleared automatically when a new post gets added so that users will see the new version immediately. That response will still be cached afterwards, so it only means one extra query.</p>
<p>This is the ideal place to introduce <a href="https://docs.djangoproject.com/en/dev/topics/signals/">signals</a>. Signals are a way to carry out a given action when an event takes place. In our case, we plan to clear the cache when a post is saved (either created or updated).</p>
<p>Note that as we’ll be testing the behaviour of the cache at this point, you’ll need to install Memcached on your local machine, and we’ll need to change the settings to fall back to our local Memcached instance:</p>
<pre><code class="lang-python">def get_cache():
  import os
  try:
    os.environ[&#39;MEMCACHE_SERVERS&#39;] = os.environ[&#39;MEMCACHIER_SERVERS&#39;].replace(&#39;,&#39;, &#39;;&#39;)
    os.environ[&#39;MEMCACHE_USERNAME&#39;] = os.environ[&#39;MEMCACHIER_USERNAME&#39;]
    os.environ[&#39;MEMCACHE_PASSWORD&#39;] = os.environ[&#39;MEMCACHIER_PASSWORD&#39;]
    return {
      &#39;default&#39;: {
        &#39;BACKEND&#39;: &#39;django_pylibmc.memcached.PyLibMCCache&#39;,
        &#39;TIMEOUT&#39;: 300,
        &#39;BINARY&#39;: True,
        &#39;OPTIONS&#39;: { &#39;tcp_nodelay&#39;: True }
      }
    }
  except:
    return {
      &#39;default&#39;: {
        &#39;BACKEND&#39;: &#39;django.core.cache.backends.memcached.PyLibMCCache&#39;,
        &#39;LOCATION&#39;: &#39;127.0.0.1:11211&#39;
      }
    }

CACHES = get_cache()
CACHE_MIDDLEWARE_ALIAS = &#39;default&#39;
CACHE_MIDDLEWARE_SECONDS = 300
CACHE_MIDDLEWARE_KEY_PREFIX = &#39;&#39;
</code></pre>
<p>If you don’t want to install Memcached locally, you can skip this step, but be aware that the test we write for clearing the cache will always pass if you do skip it.</p>
<p>Then we’ll run our tests to make sure nothing has been broken:</p>
<pre><code class="lang-bash">$ python manage.py jenkins blogengine
Creating test database for alias &#39;default&#39;...
.......................
----------------------------------------------------------------------
Ran 23 tests in 6.164s

OK
</code></pre>
<p>Let’s commit:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Now use Memcached in development&#39;
</code></pre>
<p>Now we’ll add a test for clearing the cache to <code>PostViewTest</code>:</p>
<pre><code class="lang-python">    def test_clear_cache(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;perl&#39;
        tag.description = &#39;The Perl programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the first post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()
        post.tags.add(tag)

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the second post
        post = Post()
        post.title = &#39;My second post&#39;
        post.text = &#39;This is [my second blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-second-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()
        post.tags.add(tag)

        # Fetch the index again
        response = self.client.get(&#39;/&#39;)

        # Check second post present
        self.assertTrue(&#39;my second blog post&#39; in response.content)
</code></pre>
<p>This should be fairly self-explanatory. We create one post, and request the index page. We then add a second post, request the index page again, and check for the second post. The test should fail because the cached version is returned, rather than the version in the database.</p>
<p>Now we have a test in place, we can implement a fix. First, add this to the top of your <code>models.py</code>:</p>
<pre><code class="lang-python">from django.db.models.signals import post_save
from django.core.cache import cache
</code></pre>
<p>Then add the following at the bottom of the file:</p>
<pre><code class="lang-python">
# Define signals
def new_post(sender, instance, created, **kwargs):
    cache.clear()

# Set up signals
post_save.connect(new_post, sender=Post)
</code></pre>
<p>This is fairly straightforward. What we’re doing is first defining a function called <code>new_post</code> that is called when a new post is created. We then connect it to the <code>post_save</code> signal. When a post is saved, it calls <code>new_post</code>, which clears the cache, making sure users are seeing the latest and greatest version of your site immediately.</p>
<p>Let’s test it:</p>
<pre><code class="lang-bash">$ python manage.py jenkins blogengine
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 8.473s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>There are a number of signals available, and when you create one, you have access to the created object via the <code>instance</code> parameter. Using signals you can implement all kinds of functionality. For instance, you could implement the functionality to send an email when a new post is published.</p>
<p>If you’re using Travis CI, you’ll also need to update the config file:</p>
<pre><code class="lang-yaml">language: python
python:
- &quot;2.7&quot;
services: memcached
before_install:
    - sudo apt-get install -y libmemcached-dev
# command to install dependencies
install: &quot;pip install -r requirements.txt&quot;
# command to run tests
script: coverage run --include=&quot;blogengine/*&quot; --omit=&quot;blogengine/migrations/*&quot; manage.py test blogengine
after_success:
    coveralls
</code></pre>
<p>Time to commit:</p>
<pre><code class="lang-bash">$ git add blogengine/ .travis.yml
$ git commit -m &#39;Now clear cache when post added&#39;
</code></pre>
<h1 id="formatting-for-rss-feeds">Formatting for RSS feeds</h1>
<p>Now, we want to offer more than one option for RSS feeds. For instance, if your blog is aggregated on a site such as <a href="http://planet.python.org/">Planet Python</a>, but you also blog about JavaScript, you may want to be able to provide a feed for posts in the <code>python</code> category only.</p>
<p>If you have written any posts that use any of Markdown’s custom formatting, you may notice that if you load your RSS feed in a reader, it isn’t formatted as Markdown. Let’s fix that. First we’ll amend our test:</p>
<pre><code class="lang-python">class FeedTest(BaseAcceptanceTest):
    def test_all_post_feed(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create a post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my *first* blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category

        # Save it
        post.save()

        # Add the tag
        post.tags.add(tag)
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Fetch the feed
        response = self.client.get(&#39;/feeds/posts/&#39;)
        self.assertEquals(response.status_code, 200)

        # Parse the feed
        feed = feedparser.parse(response.content)

        # Check length
        self.assertEquals(len(feed.entries), 1)

        # Check post retrieved is the correct one
        feed_post = feed.entries[0]
        self.assertEquals(feed_post.title, post.title)
        self.assertTrue(&#39;This is my &lt;em&gt;first&lt;/em&gt; blog post&#39; in feed_post.description)
</code></pre>
<p>Don’t forget to run the tests to make sure they fail. Now, let’s fix it:</p>
<pre><code class="lang-python">from django.shortcuts import render
from django.views.generic import ListView
from blogengine.models import Category, Post, Tag
from django.contrib.syndication.views import Feed
from django.utils.encoding import force_unicode
from django.utils.safestring import mark_safe
import markdown2

# Create your views here.
class CategoryListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            category = Category.objects.get(slug=slug)
            return Post.objects.filter(category=category)
        except Category.DoesNotExist:
            return Post.objects.none()


class TagListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            tag = Tag.objects.get(slug=slug)
            return tag.post_set.all()
        except Tag.DoesNotExist:
            return Post.objects.none()


class PostsFeed(Feed):
    title = &quot;RSS feed - posts&quot;
    link = &quot;feeds/posts/&quot;
    description = &quot;RSS feed - blog posts&quot;

    def items(self):
        return Post.objects.order_by(&#39;-pub_date&#39;)

    def item_title(self, item):
        return item.title

    def item_description(self, item):
        extras = [&quot;fenced-code-blocks&quot;]
        content = mark_safe(markdown2.markdown(force_unicode(item.text),
                                               extras = extras))
        return content
</code></pre>
<p>All we’re doing here is amending the <code>item_description</code> method of <code>PostsFeed</code> to render it as Markdown. Now let’s run our tests again:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 9.370s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>With that done, we’ll commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Fixed rendering for post feed&#39;
</code></pre>
<h1 id="refactoring-our-tests">Refactoring our tests</h1>
<p>Now, before we get into implementing the feed, our tests are a bit verbose. We create a lot of items over and over again - let’s sort that out. Factory Boy is a handy Python module that allows you to create easy-to-use factories for creating objects over and over again in tests. Let’s install it:</p>
<pre><code class="lang-bash">$ pip install factory_boy
$ pip freeze &gt; requirements.txt
$ git add requirements.txt
$ git commit -m &#39;Installed Factory Boy&#39;
</code></pre>
<p>Now let’s set up a factory for creating posts. Add this at the top of the test file:</p>
<pre><code class="lang-python">import factory.django
</code></pre>
<p>Then, before your actual tests, insert the following:</p>
<pre><code class="lang-python"># Factories
class SiteFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Site
        django_get_or_create = (
            &#39;name&#39;,
            &#39;domain&#39;
        )

    name = &#39;example.com&#39;
    domain = &#39;example.com&#39;
</code></pre>
<p>Now, wherever you call <code>Site()</code>, add its attributes, and save it, replace those lines with the following:</p>
<pre><code class="lang-python">        site = SiteFactory()
</code></pre>
<p>Much simpler and more concise, I’m sure you’ll agree! Now, let’s run the tests to make sure they aren’t broken:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 7.482s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/tests.py
$ git commit -m &#39;Now use Factory Boy for site objects&#39;
</code></pre>
<p>Let’s do the same thing with <code>Category</code> objects:</p>
<pre><code class="lang-python">class CategoryFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Category
        django_get_or_create = (
            &#39;name&#39;,
            &#39;description&#39;,
            &#39;slug&#39;
        )

    name = &#39;python&#39;
    description = &#39;The Python programming language&#39;
    slug = &#39;python&#39;
</code></pre>
<p>Again, just find every time we call <code>Category()</code> and replace it with the following:</p>
<pre><code class="lang-python">        category = CategoryFactory()
</code></pre>
<p>Now if we run our tests, we’ll notice a serious error:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
EE..EE.EE.EE...E.EEE..E.
======================================================================
ERROR: test_create_category (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 42, in test_create_category
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 80, in test_create_post
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 339, in test_create_post
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_create_post_without_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 378, in test_create_post_without_tag
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 245, in test_delete_category
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_delete_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 467, in test_delete_post
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 221, in test_edit_category
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 410, in test_edit_post
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_all_post_feed (blogengine.tests.FeedTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 810, in test_all_post_feed
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_category_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 640, in test_category_page
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_clear_cache (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 753, in test_clear_cache
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_index (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 518, in test_index
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create
    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create


    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

======================================================================
ERROR: test_post_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 576, in test_post_page
    category = CategoryFactory()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 82, in __call__
    return cls.create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 585, in create
    return cls._generate(True, attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 510, in _generate
    obj = cls._prepare(create, **attrs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/base.py&quot;, line 485, in _prepare
    return cls._create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 151, in _create


    return cls._get_or_create(model_class, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/factory/django.py&quot;, line 142, in _get_or_create
    obj, _created = manager.get_or_create(*args, **key_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 154, in get_or_create
    return self.get_queryset().get_or_create(**kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 383, in get_or_create
    obj.save(force_insert=True, using=self.db)
TypeError: save() got an unexpected keyword argument &#39;force_insert&#39;

----------------------------------------------------------------------
Ran 24 tests in 5.162s

FAILED (errors=13)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Thankfully, this is easy to fix. We just need to amend the custom <code>save()</code> method of the <code>Category</code> model:</p>
<pre><code class="lang-python">    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(unicode(self.name))
        super(Category, self).save(*args, **kwargs)
</code></pre>
<p>That should resolve the issue:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 7.749s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Category now uses Factory Boy&#39;
</code></pre>
<p>Now let’s do the same thing for tags:</p>
<pre><code class="lang-python">class TagFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Tag
        django_get_or_create = (
            &#39;name&#39;,
            &#39;description&#39;,
            &#39;slug&#39;
        )

    name = &#39;python&#39;
    description = &#39;The Python programming language&#39;
    slug = &#39;python&#39;
</code></pre>
<p>And replace the sections where we create new <code>Tag</code> objects:</p>
<pre><code class="lang-python">        tag = TagFactory()
</code></pre>
<p>Note that some tags have different values. We can easily pass different values to our <code>TagFactory()</code> to override the default values:</p>
<pre><code class="lang-python">        tag = TagFactory(name=&#39;perl&#39;, description=&#39;The Perl programming language&#39;)
</code></pre>
<p>The <code>Tag</code> model has the same issue as the <code>Category</code> one did, so let’s fix that:</p>
<pre><code class="lang-python">    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(unicode(self.name))
        super(Tag, self).save(*args, **kwargs)
</code></pre>
<p>We run our tests again:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine/
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 7.153s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Time to commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Now use Factory Boy for tags&#39;
</code></pre>
<p>Next we’ll create a factory for adding users. Note that the factory name doesn’t have to match the object name, so you can create factories for different types of users. Here we create a factory for authors - you could, for instance, create a separate factory for subscribers if you wanted:</p>
<pre><code class="lang-python">class AuthorFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = User
        django_get_or_create = (&#39;username&#39;,&#39;email&#39;, &#39;password&#39;,)

    username = &#39;testuser&#39;
    email = &#39;user@example.com&#39;
    password = &#39;password&#39;
</code></pre>
<p>And as before, replace those sections where we create users with the following:</p>
<pre><code class="lang-python">        author = AuthorFactory()
</code></pre>
<p>Run the tests again:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 5.808s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Now use Factory Boy for creating authors&#39;
</code></pre>
<p>Now we’ll create a flat page factory:</p>
<pre><code class="lang-python">

class FlatPageFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = FlatPage
        django_get_or_create = (
            &#39;url&#39;,
            &#39;title&#39;,
            &#39;content&#39;
        )

    url = &#39;/about/&#39;
    title = &#39;About me&#39;
    content = &#39;All about me&#39;
</code></pre>
<p>And use it for our flat page test:</p>
<pre><code class="lang-python">        page = FlatPageFactory()
</code></pre>
<p>Check the tests pass:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
........................
----------------------------------------------------------------------
Ran 24 tests in 5.796s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>And commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Now use Factory Boy for flat page test&#39;
</code></pre>
<p>Now we’ll create a final factory for posts:</p>
<pre><code class="lang-python">class PostFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Post
        django_get_or_create = (
            &#39;title&#39;,
            &#39;text&#39;,
            &#39;slug&#39;,
            &#39;pub_date&#39;
        )

    title = &#39;My first post&#39;
    text = &#39;This is my first blog post&#39;
    slug = &#39;my-first-post&#39;
    pub_date = timezone.now()
    author = factory.SubFactory(AuthorFactory)
    site = factory.SubFactory(SiteFactory)
    category = factory.SubFactory(CategoryFactory)
</code></pre>
<p>This factory is a little bit different. Because our <code>Post</code> model depends on several others, we need to be able to create those additional objects on demand. By designating them as subfactories, we can easily create the associated objects for our <code>Post</code> object.</p>
<p>That means that not only can we get rid of our <code>Post()</code> calls, but we can also get rid of the factory calls to create the associated objects for <code>Post</code> models. Again, I’ll leave actually doing this as an exercise for the reader, but you can always refer to the GitHub repository if you’re not too sure.</p>
<p>Make sure your tests still pass, then commit the changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Now use Factory Boy for testing posts&#39;
</code></pre>
<p>Using Factory Boy made a big difference to the size of the test file - I was able to cut it down by over 200 lines of code. As your application gets bigger, it gets harder to maintain, so do what you can to keep the size down.</p>
<h1 id="additional-rss-feeds">Additional RSS feeds</h1>
<p>Now, let’s implement our additional RSS feeds. First, we’ll write a test for the category feed. Add this to the <code>FeedTest</code> class:</p>
<pre><code class="lang-python">    def test_category_feed(self):
        # Create a post
        post = PostFactory(text=&#39;This is my *first* blog post&#39;)

        # Create another post in a different category
        category = CategoryFactory(name=&#39;perl&#39;, description=&#39;The Perl programming language&#39;, slug=&#39;perl&#39;)
        post2 = PostFactory(text=&#39;This is my *second* blog post&#39;, title=&#39;My second post&#39;, slug=&#39;my-second-post&#39;, category=category)

        # Fetch the feed
        response = self.client.get(&#39;/feeds/posts/category/python/&#39;)
        self.assertEquals(response.status_code, 200)

        # Parse the feed
        feed = feedparser.parse(response.content)

        # Check length
        self.assertEquals(len(feed.entries), 1)

        # Check post retrieved is the correct one
        feed_post = feed.entries[0]
        self.assertEquals(feed_post.title, post.title)
        self.assertTrue(&#39;This is my &lt;em&gt;first&lt;/em&gt; blog post&#39; in feed_post.description)

        # Check other post is not in this feed
        self.assertTrue(&#39;This is my &lt;em&gt;second&lt;/em&gt; blog post&#39; not in response.content)
</code></pre>
<p>Here we create two posts in different categories (note that we create a new category and override the post category for it). We then fetch <code>/feeds/posts/category/python/</code> and assert that it contains only one post, with the content of the first post and not the content of the second.</p>
<p>Run the tests and they should fail:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
................F........
======================================================================
FAIL: test_category_feed (blogengine.tests.FeedTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 716, in test_category_feed
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 25 tests in 5.804s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Because we haven’t yet implemented that route, we get a 404 error. So let’s create a route for this:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView, DetailView
from blogengine.models import Post, Category, Tag
from blogengine.views import CategoryListView, TagListView, PostsFeed, CategoryPostsFeed

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        )),

    # Individual posts
    url(r&#39;^(?P&lt;pub_date__year&gt;\d{4})/(?P&lt;pub_date__month&gt;\d{1,2})/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, DetailView.as_view(
        model=Post,
        )),

    # Categories
    url(r&#39;^category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryListView.as_view(
        paginate_by=5,
        model=Category,
        )),

    # Tags
    url(r&#39;^tag/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, TagListView.as_view(
        paginate_by=5,
        model=Tag,
        )),

    # Post RSS feed
    url(r&#39;^feeds/posts/$&#39;, PostsFeed()),

    # Category RSS feed
    url(r&#39;^feeds/posts/category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryPostsFeed()),
)
</code></pre>
<p>Note that the category RSS feed route is similar to the post RSS feed route, but accepts a <code>slug</code> parameter. We will use this to pass through the slug for the category in question. Also note we import the <code>CategoryPostsFeed</code> view. Now, we need to create that view. Fortunately, because it’s written as a Python class, we can extend the existing <code>PostsFeed</code> class. Open up your views file and amend it to look like this:</p>
<pre><code class="lang-python">from django.shortcuts import get_object_or_404
from django.views.generic import ListView
from blogengine.models import Category, Post, Tag
from django.contrib.syndication.views import Feed
from django.utils.encoding import force_unicode
from django.utils.safestring import mark_safe
import markdown2

# Create your views here.
class CategoryListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            category = Category.objects.get(slug=slug)
            return Post.objects.filter(category=category)
        except Category.DoesNotExist:
            return Post.objects.none()


class TagListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            tag = Tag.objects.get(slug=slug)
            return tag.post_set.all()
        except Tag.DoesNotExist:
            return Post.objects.none()


class PostsFeed(Feed):
    title = &quot;RSS feed - posts&quot;
    description = &quot;RSS feed - blog posts&quot;
    link = &#39;/&#39;

    def items(self):
        return Post.objects.order_by(&#39;-pub_date&#39;)

    def item_title(self, item):
        return item.title

    def item_description(self, item):
        extras = [&quot;fenced-code-blocks&quot;]
        content = mark_safe(markdown2.markdown(force_unicode(item.text),
                                               extras = extras))
        return content


class CategoryPostsFeed(PostsFeed):
    def get_object(self, request, slug):
        return get_object_or_404(Category, slug=slug)

    def title(self, obj):
        return &quot;RSS feed - blog posts in category %s&quot; % obj.name

    def link(self, obj):
        return obj.get_absolute_url()

    def description(self, obj):
        return &quot;RSS feed - blog posts in category %s&quot; % obj.name

    def items(self, obj):
        return Post.objects.filter(category=obj).order_by(&#39;-pub_date&#39;)
</code></pre>
<p>Note that many of our fields don’t have to be explicitly defined as they are inherited from <code>PostsFeed</code>. We can’t hard-code the title, link or description because they depend on the category, so we instead define methods to return the appropriate text.</p>
<p>Also note <code>get_object()</code> - we define this so that we can ensure the category exists. If it doesn’t exist, then it returns a 404 error rather than showing an empty feed.</p>
<p>We also override <code>items()</code> to filter it to just those posts that are in the given category.</p>
<p>If you run the tests again, they should now pass:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
.........................
----------------------------------------------------------------------
Ran 25 tests in 5.867s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Implemented category RSS feed&#39;
</code></pre>
<p>Now, we can get our category RSS feed, but how do we navigate to it? Let’s add a link to each category page that directs a user to its RSS feed. To do so, we’ll need to create a new template for category pages. First, let’s add some code to our tests to ensure that the right template is used at all times. Add the following to the end of the <code>test_index</code> method of <code>PostViewTest</code>:</p>
<pre><code class="lang-python">        # Check the correct template was used
        self.assertTemplateUsed(response, &#39;blogengine/post_list.html&#39;)
</code></pre>
<p>Then, add this to the end of <code>test_post_page</code>:</p>
<pre><code class="lang-python">
        # Check the correct template was used
        self.assertTemplateUsed(response, &#39;blogengine/post_detail.html&#39;)
</code></pre>
<p>Finally, add this to the end of <code>test_category_page</code>:</p>
<pre><code class="lang-python">        # Check the correct template was used
        self.assertTemplateUsed(response, &#39;blogengine/category_post_list.html&#39;)
</code></pre>
<p>These assertions confirm which template was used to generate which request.</p>
<p>Next, we head into our views file:</p>
<pre><code class="lang-python">class CategoryListView(ListView):
    template_name = &#39;blogengine/category_post_list.html&#39;

    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            category = Category.objects.get(slug=slug)
            return Post.objects.filter(category=category)
        except Category.DoesNotExist:
            return Post.objects.none()

    def get_context_data(self, **kwargs):
        context = super(CategoryListView, self).get_context_data(**kwargs)
        slug = self.kwargs[&#39;slug&#39;]
        try:
            context[&#39;category&#39;] = Category.objects.get(slug=slug)
        except Category.DoesNotExist:
            context[&#39;category&#39;] = None
        return context
</code></pre>
<p>Note that we first of all change the template used by this view. Then, we override <code>get_context_data</code> to add in additional data. What we’re doing is getting the slug that was passed through, looking up any category for which it is the slug, and returning it as additional context data. Using this method, you can easily add additional data that you may wish to render in your Django templates.</p>
<p>Finally, we create our new template:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% if object_list %}
            {% for post in object_list %}
            &lt;div class=&quot;post col-md-12&quot;&gt;
            &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
            &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
            {{ post.text|custom_markdown }}
            &lt;/div&gt;
            {% if post.category %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-primary&quot;&gt;{{ post.category.name }}&lt;/span&gt;&lt;/a&gt;
            &lt;/div&gt;
            {% endif %}
            {% if post.tags %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            {% for tag in post.tags.all %}
            &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-success&quot;&gt;{{ tag.name }}&lt;/span&gt;&lt;/a&gt;
            {% endfor %}
            &lt;/div&gt;
            {% endif %}
            {% endfor %}
        {% else %}
            &lt;p&gt;No posts found&lt;/p&gt;
        {% endif %}

        &lt;ul class=&quot;pager&quot;&gt;
        {% if page_obj.has_previous %}
        &lt;li class=&quot;previous&quot;&gt;&lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;li class=&quot;next&quot;&gt;&lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        &lt;/ul&gt;

        &lt;a href=&quot;/feeds/posts/category/{{ category.slug }}/&quot;&gt;RSS feed for category {{ category.name }}&lt;/a&gt;

    {% endblock %}
</code></pre>
<p>Note that the category has been passed through to the template and is now accessible. If you run the tests, they should now pass:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database for alias &#39;default&#39;...
.........................
----------------------------------------------------------------------
Ran 25 tests in 7.232s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>With that done. we can commit our changes:</p>
<pre><code class="lang-bash">$ git add templates/ blogengine/
$ git commit -m &#39;Added link to RSS feed from category page&#39;
</code></pre>
<p>Next up, let’s implement another RSS feed for tags. First, we’ll implement our test:</p>
<pre><code class="lang-python">      def test_tag_feed(self):
          # Create a post
          post = PostFactory(text=&#39;This is my *first* blog post&#39;)
          tag = TagFactory()
          post.tags.add(tag)
          post.save()

          # Create another post with a different tag
          tag2 = TagFactory(name=&#39;perl&#39;, description=&#39;The Perl programming language&#39;, slug=&#39;perl&#39;)
          post2 = PostFactory(text=&#39;This is my *second* blog post&#39;, title=&#39;My second post&#39;, slug=&#39;my-second-post&#39;)
          post2.tags.add(tag2)
          post2.save()

          # Fetch the feed
          response = self.client.get(&#39;/feeds/posts/tag/python/&#39;)
          self.assertEquals(response.status_code, 200)

          # Parse the feed
          feed = feedparser.parse(response.content)

          # Check length
          self.assertEquals(len(feed.entries), 1)

          # Check post retrieved is the correct one
          feed_post = feed.entries[0]
          self.assertEquals(feed_post.title, post.title)
          self.assertTrue(&#39;This is my &lt;em&gt;first&lt;/em&gt; blog post&#39; in feed_post.description)

          # Check other post is not in this feed
          self.assertTrue(&#39;This is my &lt;em&gt;second&lt;/em&gt; blog post&#39; not in response.content)
</code></pre>
<p>This is virtually identical to the test for the categroy feed, but we adjust it to work with the <code>Tag</code> attribute and change the URL. Let’s check that our test fails:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
.................F........
======================================================================
FAIL: test_tag_feed (blogengine.tests.FeedTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 757, in test_tag_feed
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 26 tests in 5.760s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>As before, we create a route for this:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView, DetailView
from blogengine.models import Post, Category, Tag
from blogengine.views import CategoryListView, TagListView, PostsFeed, CategoryPostsFeed, TagPostsFeed

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        )),

    # Individual posts
    url(r&#39;^(?P&lt;pub_date__year&gt;\d{4})/(?P&lt;pub_date__month&gt;\d{1,2})/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, DetailView.as_view(
        model=Post,
        )),

    # Categories
    url(r&#39;^category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryListView.as_view(
        paginate_by=5,
        model=Category,
        )),

    # Tags
    url(r&#39;^tag/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, TagListView.as_view(
        paginate_by=5,
        model=Tag,
        )),

    # Post RSS feed
    url(r&#39;^feeds/posts/$&#39;, PostsFeed()),

    # Category RSS feed
    url(r&#39;^feeds/posts/category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryPostsFeed()),

    # Tag RSS feed
    url(r&#39;^feeds/posts/tag/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, TagPostsFeed()),
)
</code></pre>
<p>Next, we create our view:</p>
<pre><code class="lang-python">class TagPostsFeed(PostsFeed):
    def get_object(self, request, slug):
        return get_object_or_404(Tag, slug=slug)

    def title(self, obj):
        return &quot;RSS feed - blog posts tagged  %s&quot; % obj.name

    def link(self, obj):
        return obj.get_absolute_url()

    def description(self, obj):
        return &quot;RSS feed - blog posts tagged %s&quot; % obj.name

    def items(self, obj):
        try:
            tag = Tag.objects.get(slug=obj.slug)
            return tag.post_set.all()
        except Tag.DoesNotExist:
            return Post.objects.none()
</code></pre>
<p>Again, this inherits from <code>PostsFeed</code>, but the syntax for getting posts matching a tag is slightly different because they use a many-to-many relationship.</p>
<p>We also need a template for the tag pages. Add this to the end of the <code>test_tag_page</code> method:</p>
<pre><code class="lang-python">
        # Check the correct template was used
        self.assertTemplateUsed(response, &#39;blogengine/tag_post_list.html&#39;)
</code></pre>
<p>Let’s create that template:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% if object_list %}
            {% for post in object_list %}
            &lt;div class=&quot;post col-md-12&quot;&gt;
            &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
            &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
            {{ post.text|custom_markdown }}
            &lt;/div&gt;
            {% if post.category %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-primary&quot;&gt;{{ post.category.name }}&lt;/span&gt;&lt;/a&gt;
            &lt;/div&gt;
            {% endif %}
            {% if post.tags %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            {% for tag in post.tags.all %}
            &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-success&quot;&gt;{{ tag.name }}&lt;/span&gt;&lt;/a&gt;
            {% endfor %}
            &lt;/div&gt;
            {% endif %}
            {% endfor %}
        {% else %}
            &lt;p&gt;No posts found&lt;/p&gt;
        {% endif %}

        &lt;ul class=&quot;pager&quot;&gt;
        {% if page_obj.has_previous %}
        &lt;li class=&quot;previous&quot;&gt;&lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;li class=&quot;next&quot;&gt;&lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        &lt;/ul&gt;

        &lt;a href=&quot;/feeds/posts/tag/{{ tag.slug }}/&quot;&gt;RSS feed for tag {{ tag.name }}&lt;/a&gt;

    {% endblock %}
</code></pre>
<p>This is virtually identical to the category template. You’ll also need to apply this template in the view for the tag list, and pass the tag name through as context data:</p>
<pre><code class="lang-python">class TagListView(ListView):
    template_name = &#39;blogengine/tag_post_list.html&#39;

    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            tag = Tag.objects.get(slug=slug)
            return tag.post_set.all()
        except Tag.DoesNotExist:
            return Post.objects.none()

    def get_context_data(self, **kwargs):
        context = super(TagListView, self).get_context_data(**kwargs)
        slug = self.kwargs[&#39;slug&#39;]
        try:
            context[&#39;tag&#39;] = Tag.objects.get(slug=slug)
        except Tag.DoesNotExist:
            context[&#39;tag&#39;] = None
        return context
</code></pre>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
..........................
----------------------------------------------------------------------
Ran 26 tests in 5.770s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>You may want to do a quick check to ensure your tag feed link works as expected. Time to commit:</p>
<pre><code class="lang-bash">$ git add blogengine templates
$ git commit -m &#39;Implemented tag feeds&#39;
</code></pre>
<h1 id="moving-our-templates">Moving our templates</h1>
<p>Before we crack on with implementing search, there’s one more piece of housekeeping. In Django, templates can be applied at project level or at app level. So far, we’ve been storing them in the project, but we would like our app to be as self-contained as possible so it can just be dropped into future projects where we need a blog. That way, it can be easily overridden for specific projects. You can move the folders and update the Git repository at the same time with this command:</p>
<pre><code class="lang-bash">$ git mv templates/ blogengine/
</code></pre>
<p>We run the tests to make sure nothing untoward has happened:</p>
<pre><code class="lang-bash">$ python manage.py test
Creating test database for alias &#39;default&#39;...
..........................
----------------------------------------------------------------------
Ran 26 tests in 5.847s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>And we commit:</p>
<pre><code class="lang-bash">$ git commit -m &#39;Moved templates&#39;
</code></pre>
<p>Note that <code>git mv</code> updates Git and moves the files, so you don’t need to call <code>git add</code>.</p>
<h1 id="implementing-search">Implementing search</h1>
<p>For our final task today, we will be implementing a very simple search engine. Our requirements are:</p>
<ul>
<li>It should be in the header, to allow for easy access from anywhere in the front end.</li>
<li>It should search the title and text of posts.</li>
</ul>
<p>First, we’ll write our tests:</p>
<pre><code class="lang-python">class SearchViewTest(BaseAcceptanceTest):
    def test_search(self):
        # Create a post
        post = PostFactory()

        # Create another post
        post2 = PostFactory(text=&#39;This is my *second* blog post&#39;, title=&#39;My second post&#39;, slug=&#39;my-second-post&#39;)

        # Search for first post
        response = self.client.get(&#39;/search?q=first&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the first post is contained in the results
        self.assertTrue(&#39;My first post&#39; in response.content)

        # Check the second post is not contained in the results
        self.assertTrue(&#39;My second post&#39; not in response.content)

        # Search for second post
        response = self.client.get(&#39;/search?q=second&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the first post is not contained in the results
        self.assertTrue(&#39;My first post&#39; not in response.content)

        # Check the second post is contained in the results
        self.assertTrue(&#39;My second post&#39; in response.content)
</code></pre>
<p>Don’t forget to run the tests to make sure they fail:</p>
<pre><code class="lang-bash">$ python manage.py test
Creating test database for alias &#39;default&#39;...
..........................F
======================================================================
FAIL: test_search (blogengine.tests.SearchViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 819, in test_search
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 27 tests in 6.919s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>With that done, we can add the search form to the header:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;!--[if lt IE 7]&gt;      &lt;html class=&quot;no-js lt-ie9 lt-ie8 lt-ie7&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 7]&gt;         &lt;html class=&quot;no-js lt-ie9 lt-ie8&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 8]&gt;         &lt;html class=&quot;no-js lt-ie9&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if gt IE 8]&gt;&lt;!--&gt; &lt;html class=&quot;no-js&quot;&gt; &lt;!--&lt;![endif]--&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;title&gt;{% block title %}My Django Blog{% endblock %}&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
        &lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;Blog posts&quot; href=&quot;/feeds/posts/&quot; &gt;

        &lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;

        {% load staticfiles %}
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/normalize.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap-theme.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/code.css&#39; %}&quot;&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/modernizr-2.6.2.min.js&#39; %}&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;!--[if lt IE 7]&gt;
            &lt;p class=&quot;browsehappy&quot;&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href=&quot;http://browsehappy.com/&quot;&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;

        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;container-fluid&quot;&gt;
                &lt;div class=&quot;navbar-header&quot;&gt;
                    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#header-nav&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/button&gt;
                    &lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;My Django Blog&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;header-nav&quot;&gt;
                    &lt;ul class=&quot;nav navbar-nav&quot;&gt;
                        {% load flatpages %}
                        {% get_flatpages as flatpages %}
                        {% for flatpage in flatpages %}
                        &lt;li&gt;&lt;a href=&quot;{{ flatpage.url }}&quot;&gt;{{ flatpage.title }}&lt;/a&gt;&lt;/li&gt;
                        {% endfor %}
                        &lt;li&gt;&lt;a href=&quot;/feeds/posts/&quot;&gt;RSS feed&lt;/a&gt;&lt;/li&gt;

                        &lt;form action=&quot;/search&quot; method=&quot;GET&quot; class=&quot;navbar-form navbar-left&quot;&gt;
                            &lt;div class=&quot;form-group&quot;&gt;
                                &lt;input type=&quot;text&quot; name=&quot;q&quot; placeholder=&quot;Search...&quot; class=&quot;form-control&quot;&gt;&lt;/input&gt;
                            &lt;/div&gt;
                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Search&lt;/button&gt;
                        &lt;/form&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container&quot;&gt;
            {% block header %}
                &lt;div class=&quot;page-header&quot;&gt;
                    &lt;h1&gt;My Django Blog&lt;/h1&gt;
                &lt;/div&gt;
            {% endblock %}

            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container footer&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                &lt;div class=&quot;span12&quot;&gt;
                    &lt;p&gt;Copyright &amp;copy; {% now &quot;Y&quot; %}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;window.jQuery || document.write(&#39;&lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/jquery-1.10.2.min.js&#39; %}&quot;&gt;&lt;\/script&gt;&#39;)&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/plugins.js&#39; %}&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/bootstrap/dist/js/bootstrap.min.js&#39; %}&quot;&gt;&lt;/script&gt;

        &lt;!-- Google Analytics: change UA-XXXXX-X to be your site&#39;s ID. --&gt;
        &lt;script&gt;
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src=&#39;//www.google-analytics.com/analytics.js&#39;;
            r.parentNode.insertBefore(e,r)}(window,document,&#39;script&#39;,&#39;ga&#39;));
            ga(&#39;create&#39;,&#39;UA-XXXXX-X&#39;);ga(&#39;send&#39;,&#39;pageview&#39;);
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Now we’ll actually implement our search. Implementing search using Django’s generic views can be fiddly, so we’ll write our search view as a function instead. First, amend the imports at the top of your view file to look like this:</p>
<pre><code class="lang-python">from django.shortcuts import get_object_or_404, render_to_response
from django.core.paginator import Paginator, EmptyPage
from django.db.models import Q
from django.views.generic import ListView
from blogengine.models import Category, Post, Tag
from django.contrib.syndication.views import Feed
from django.utils.encoding import force_unicode
from django.utils.safestring import mark_safe
import markdown2
</code></pre>
<p>Next, add the following code to the end of the file:</p>
<pre><code class="lang-python">def getSearchResults(request):
    &quot;&quot;&quot;
    Search for a post by title or text
    &quot;&quot;&quot;
    # Get the query data
    query = request.GET.get(&#39;q&#39;, &#39;&#39;)
    page = request.GET.get(&#39;page&#39;, 1)

    # Query the database
    if query:
        results = Post.objects.filter(Q(text__icontains=query) | Q(title__icontains=query))
    else:
        results = None

    # Add pagination
    pages = Paginator(results, 5)

    # Get specified page
    try:
        returned_page = pages.page(page)
    except EmptyPage:
        returned_page = pages.page(pages.num_pages)

    # Display the search results
    return render_to_response(&#39;blogengine/search_post_list.html&#39;,
                              {&#39;page_obj&#39;: returned_page,
                               &#39;object_list&#39;: returned_page.object_list,
                               &#39;search&#39;: query})
</code></pre>
<p>As this is the first time we’ve written a view without using generic views, a little explanation is called for. First we get the values of the <code>q</code> and <code>page</code> parameters passed to the view. <code>q</code> contains the query text and <code>page</code> contains the page number. Note also that our page defaults to 1 if not set.</p>
<p>We then use the Q object to perform a query. The Django ORM will <code>AND</code> together keyword argument queries, but that’s not the behaviour we want here. Instead we want to be able to search for content in the title or text, so we need to use a query with an <code>OR</code> statement, which necessitates using the <a href="https://docs.djangoproject.com/en/dev/topics/db/queries/#complex-lookups-with-q-objects">Q</a> object.</p>
<p>Next, we use the <code>Paginator</code> object to manually paginate the results, and if it raises an <code>EmptyPage</code> exception, to just show the last page instead. Finally we render the template <code>blogengine/search_post_list.html</code>, and pass through the parameters <code>page_obj</code> for the returned page, <code>object_list</code> for the objects, and <code>search</code> for the query.</p>
<p>We also need to add a route for our new view:</p>
<pre><code class="lang-python">
    # Search posts
    url(r&#39;^search&#39;, &#39;blogengine.views.getSearchResults&#39;),
</code></pre>
<p>Finally, let’s create a new template to show our results:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% if object_list %}
            {% for post in object_list %}
            &lt;div class=&quot;post col-md-12&quot;&gt;
            &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
            &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
            {{ post.text|custom_markdown }}
            &lt;/div&gt;
            {% if post.category %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-primary&quot;&gt;{{ post.category.name }}&lt;/span&gt;&lt;/a&gt;
            &lt;/div&gt;
            {% endif %}
            {% if post.tags %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            {% for tag in post.tags.all %}
            &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-success&quot;&gt;{{ tag.name }}&lt;/span&gt;&lt;/a&gt;
            {% endfor %}
            &lt;/div&gt;
            {% endif %}
            {% endfor %}
        {% else %}
            &lt;p&gt;No posts found&lt;/p&gt;
        {% endif %}

        &lt;ul class=&quot;pager&quot;&gt;
        {% if page_obj.has_previous %}
        &lt;li class=&quot;previous&quot;&gt;&lt;a href=&quot;/search?page={{ page_obj.previous_page_number }}&amp;q={{ search }}&quot;&gt;Previous Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;li class=&quot;next&quot;&gt;&lt;a href=&quot;/search?page={{ page_obj.next_page_number }}&amp;q={{ search }}&quot;&gt;Next Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        &lt;/ul&gt;

    {% endblock %}
</code></pre>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">$ python manage.py test
Creating test database for alias &#39;default&#39;...
...........................
----------------------------------------------------------------------
Ran 27 tests in 6.421s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Don’t forget to do a quick sense check to make sure it’s all working as expected. Then it’s time to commit:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Implemented search&#39;
</code></pre>
<p>And push up your changes:</p>
<pre><code class="lang-bash">$ git push origin master
$ git push heroku master
</code></pre>
<p>And that’s the end of this instalment. Please note this particular search solution is quite basic, and if you want something more powerful, you may want to look at <a href="http://haystacksearch.org/">Haystack</a>.</p>
<p>As usual, you can get this lesson with <code>git checkout lesson-7</code> - if you have any problems, the <a href="https://github.com/matthewbdaly/django_tutorial_blog_ng">repository</a> should be the first place you look for answers as this is the working code base for the application, and with judicious use of a tool like <code>diff</code>, it’s generally pretty easy to track down most issues.</p>
<p>In our next, and final instalment, we’ll cover:</p>
<ul>
<li>Tidying everything up</li>
<li>Implementing an XML sitemap for search engines</li>
<li>Optimising our site</li>
<li>Using Fabric to make deployment easier</li>
</ul>
<p>Hope to see you then!</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django Blog Tutorial - the Next Generation - Part 6]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/05/25/django-blog-tutorial-the-next-generation-part-6/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/05/25/django-blog-tutorial-the-next-generation-part-6/</guid>
            <pubDate>Sun, 25 May 2014 16:23:28 GMT</pubDate>
            <description><![CDATA[<p>Welcome back! In this tutorial we’ll cover the following:</p>
<ul>
<li>Fixing bugs the TDD way</li>
<li>Setting up syntax highlighting for code snippets</li>
<li>Tidying up the front end</li>
</ul>
<p>Apologies, but I’m holding over implementing the search and additional feeds for a future instalment - in the past I’ve tried to cover too much in one post and that has led to me putting them off for much too long. So this instalment and future ones are going to be shorter so I can get them out the door quicker.</p>
<p>Ready? Let’s get started!</p>
<h1 id="fixing-bugs">Fixing bugs</h1>
<p>When someone reports a bug, it’s tempting to just dive straight in and start fixing it. But TDD cautions us against this practice. If we have a bug, then our tests should have caught it. If they don’t, then before we fix the bug, we have to make sure we can catch it if it crops up in future by implementing a test for it, and ensuring that it fails. Once that test is in place, we can then go ahead and fix the bug, safe in the knowledge that if it should reappear in future, we will be warned when our tests run.</p>
<p>As it happens, we have a bug in our web app. If you activate your virtualenv in the usual way and run the development server, and then try to create a new post without adding a tag, you’ll see that it fails as the tag is empty. Now, it’s pretty obvious that this is because the <code>tags</code> attribute of the <code>Post</code> model cannot be blank, so we have a good idea of what we need to do to fix this. But to make sure it never occurs again, we need to implement a test first.</p>
<p>Add the following method to <code>AdminTest</code>:</p>
<pre><code class="lang-python">    def test_create_post_without_tag(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
</code></pre>
<p>This is virtually identical to our previous method for adding a post, but doesn’t add a tag to the post. If you run <code>python manage.py jenkins</code>, the test should fail. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/tests.py
$ git commit -m &#39;Added failing test for posts without tags&#39;
</code></pre>
<p>Now we’re in a position to fix our bug. Let’s take a look at our models:</p>
<pre><code class="lang-python">class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)
    category = models.ForeignKey(Category, blank=True, null=True)
    tags = models.ManyToManyField(Tag)
</code></pre>
<p>If you compare <code>category</code> and <code>tags</code>, you’ll immediately see that <code>category</code> has the additional parameters <code>blank</code> and <code>null</code> both set to <code>True</code>. So that’s what we need to do for <code>tags</code> as well. Amend the model to look like this:</p>
<pre><code class="lang-python">class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)
    category = models.ForeignKey(Category, blank=True, null=True)
    tags = models.ManyToManyField(Tag, blank=True, null=True)
</code></pre>
<p>You shouldn’t have to create a migration for this. Let’s run our tests:</p>
<pre><code class="lang-bash">$ python manage.py jenkins --coverage-html-report=htmlcov
Creating test database for alias &#39;default&#39;...
.......................
----------------------------------------------------------------------
Ran 23 tests in 7.634s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Our tests pass! So we’ve fixed our bug, and we’ve ensured that if it happens again, we’ll catch it. With that done, it’s time to commit:</p>
<pre><code class="lang-bash">$ git add blogengine/models.py
$ git commit -m &#39;Fixed a bug with the Post model&#39;
</code></pre>
<p><strong>Remember</strong>: Always make the effort to create a test to reproduce your bug before fixing it. That way, you know you can catch it in future.</p>
<h1 id="syntax-highlighting">Syntax highlighting</h1>
<p>This is one feature that not everyone will want to implement. If you want to be able to show code snippets on your blog, then implementing syntax highlighting is well worth your time. However, if that’s not what you want to use your blog for, feel free to skip over this section.</p>
<p>Now, earlier in the series we implemented Markdown support. In Markdown there are two main ways to denote a code block. One is to indent the code by four spaces, while the other is to use <a href="https://help.github.com/articles/github-flavored-markdown#syntax-highlighting">fenced code blocks with syntax highlighting</a>. There are many flavours of Markdown available for Python, and unfortunately the one we’ve been using so far doesn’t support fenced code blocks, so we’ll be switching to one that does.</p>
<p>We also need to be able to generate a suitable stylesheet to highlight the code appropriately. For that, we’ll be using <a href="http://pygments.org/">Pygments</a>. So let’s first uninstall our existing implementation of Markdown:</p>
<pre><code class="lang-bash">$ pip uninstall Markdown
</code></pre>
<p>And install the new modules:</p>
<pre><code class="lang-bash">$ pip install markdown2 Pygments
</code></pre>
<p>Don’t forget to record the changes:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>Now, we need to amend our Markdown template tags to use the new version of Markdown:</p>
<pre><code class="lang-python">import markdown2

from django import template
from django.template.defaultfilters import stringfilter
from django.utils.encoding import force_unicode
from django.utils.safestring import mark_safe

register = template.Library()

@register.filter(is_safe=True)
@stringfilter
def custom_markdown(value):
    extras = [&quot;fenced-code-blocks&quot;]

    return mark_safe(markdown2.markdown(force_unicode(value),
                                       extras = extras))
</code></pre>
<p>All we do here is change the Markdown module that gets imported, and amend how it is called. Note that we pass through the parameter <code>fenced-code-blocks</code> to enable this functionality.</p>
<p>If you now run the development server and create a post with some code in it (just copy the Ruby example from <a href="https://help.github.com/articles/github-flavored-markdown#syntax-highlighting">here</a>), then view it on the site, you should be able to see that it’s in a <code>&lt;code&gt;</code> block. However, it’s not highlighted yet. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add requirements/txt blogengine/templatetags/custom_markdown.py
$ git commit -m &#39;Now use Markdown2 to allow for syntax highlighting&#39;
</code></pre>
<p>Now, if you examine the markup for your code blocks using your browser’s developer tools, you’ll notice that the code is wrapped in many different spans with various classes. Pygments can generate a CSS file that uses those classes to highlight your code.</p>
<p>First, let’s create a folder to store our CSS files in:</p>
<pre><code class="lang-bash">$ mkdir blogengine/static/css
</code></pre>
<p>Next, we’ll add a blank CSS file for any other styling we may want to apply:</p>
<pre><code class="lang-bash">$ touch blogengine/static/css/main.css
</code></pre>
<p>Then, we generate our CSS file:</p>
<pre><code class="lang-bash">$ pygmentize -S default -f html &gt; blogengine/static/css/code.css
</code></pre>
<p>We need to include our CSS files in our HTML template:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;!--[if lt IE 7]&gt;      &lt;html class=&quot;no-js lt-ie9 lt-ie8 lt-ie7&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 7]&gt;         &lt;html class=&quot;no-js lt-ie9 lt-ie8&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 8]&gt;         &lt;html class=&quot;no-js lt-ie9&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if gt IE 8]&gt;&lt;!--&gt; &lt;html class=&quot;no-js&quot;&gt; &lt;!--&lt;![endif]--&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;title&gt;{% block title %}My Django Blog{% endblock %}&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;

        &lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;

        {% load staticfiles %}
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/normalize.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap-theme.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/code.css&#39; %}&quot;&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/modernizr-2.6.2.min.js&#39; %}&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;!--[if lt IE 7]&gt;
            &lt;p class=&quot;browsehappy&quot;&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href=&quot;http://browsehappy.com/&quot;&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;

        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;navbar-inner&quot;&gt;
                &lt;div class=&quot;container&quot;&gt;
                    &lt;a class=&quot;btn btn-navbar&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.nav-collapse&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/a&gt;
                    &lt;a class=&quot;brand&quot; href=&quot;/&quot;&gt;My Django Blog&lt;/a&gt;
                    &lt;div class=&quot;nav-collapse collapse&quot;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container&quot;&gt;
            {% block header %}
                &lt;div class=&quot;page-header&quot;&gt;
                    &lt;h1&gt;My Django Blog&lt;/h1&gt;
                &lt;/div&gt;
            {% endblock %}

            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container footer&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                &lt;div class=&quot;span12&quot;&gt;
                    &lt;p&gt;Copyright &amp;copy; {% now &quot;Y&quot; %}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;window.jQuery || document.write(&#39;&lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/jquery-1.10.2.min.js&#39; %}&quot;&gt;&lt;\/script&gt;&#39;)&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/plugins.js&#39; %}&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/bootstrap/dist/js/bootstrap.min.js&#39; %}&quot;&gt;&lt;/script&gt;

        &lt;!-- Google Analytics: change UA-XXXXX-X to be your site&#39;s ID. --&gt;
        &lt;script&gt;
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src=&#39;//www.google-analytics.com/analytics.js&#39;;
            r.parentNode.insertBefore(e,r)}(window,document,&#39;script&#39;,&#39;ga&#39;));
            ga(&#39;create&#39;,&#39;UA-XXXXX-X&#39;);ga(&#39;send&#39;,&#39;pageview&#39;);
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Now, if you run the development server and reload the page, your code will be highlighted using the default Pygments style. If you don’t like it, there are plenty to choose from. Run the following command:</p>
<pre><code class="lang-bash">$ pygmentize -L styles
</code></pre>
<p>That will list the various styles available. For instance, let’s say we want to try the Tango style:</p>
<pre><code class="lang-bash">$ pygmentize -S tango -f html &gt; blogengine/static/css/code.css
</code></pre>
<p>If you like the Monokai theme in Sublime Text, there’s a Pygments version of that:</p>
<pre><code class="lang-bash">$ pygmentize -S monokai -f html &gt; blogengine/static/css/code.css
</code></pre>
<p>If you like the Solarized theme, that’s not bundled with Pygments, but can be installed separately:</p>
<pre><code class="lang-bash">$ pip install pygments-style-solarized
</code></pre>
<p>Then run this for the light version:</p>
<pre><code class="lang-bash">$ pygmentize -S solarizedlight -f html &gt; blogengine/static/css/code.css
</code></pre>
<p>And this for the dark version:</p>
<pre><code class="lang-bash">$ pygmentize -S solarizeddark -f html &gt; blogengine/static/css/code.css
</code></pre>
<p>Pick one that you like - I’m going to go for the dark version of Solarized.</p>
<p>Note that this doesn’t actually change the background colour of the code blocks. You will therefore need to set this manually using the CSS file we created earlier. If you’re using Solarized Dark like I am, then this should set it correctly:</p>
<pre><code class="lang-css">div.codehilite pre {
    background-color: #002b36;
}
</code></pre>
<p>If you’re using Solarized Light, then this should be more appropriate:</p>
<pre><code class="lang-css">div.codehilite pre {
    background-color: #fdf6e3;
}
</code></pre>
<p>Or, if you’re using Monokai, black will do:</p>
<pre><code class="lang-css">div.codehilite pre {
    background-color: #000000;
}
</code></pre>
<p>With that done, let’s record the additional Pygments style:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>And commit our changes:</p>
<pre><code class="lang-bash">$ git add requirements.txt blogengine/static/css/ templates/blogengine/includes/base.html
$ git commit -m &#39;Styled code with Solarized Dark&#39;
</code></pre>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: blogengine.tests (unittest.loader.ModuleImportFailure)
----------------------------------------------------------------------
ImportError: Failed to import test module: blogengine.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python/2.7.6_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 254, in _find_tests
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python/2.7.6_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 232, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 7, in &lt;module&gt;
    import markdown
ImportError: No module named markdown


----------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Whoops! We introduced an error here. If we take a look, we can see that the problem is on line 7, where we import the Markdown module. That makes sense, as we now use a different implementation of Markdown. Fortunately, in Python you can import modules with a different name, which makes this a breeze to fix. Change the line to:</p>
<pre><code class="lang-python">import markdown2 as markdown
</code></pre>
<p>Now, if you run your tests, they should pass. It’s important that if a test breaks, you fix it as soon as possible and don’t put it off. Let’s commit these changes:</p>
<pre><code class="lang-bash">$ git add blogengine/tests.py
$ git commit -m &#39;Fixed a broken test&#39;
</code></pre>
<p>Our syntax highlighting is now done! If you want to see it in action using the Solarized Dark theme, check out the copy of this blogging engine hosted <a href="http://blog.shellshocked.info/">here</a>.</p>
<h1 id="tidying-up">Tidying up</h1>
<p>Now that our blog is up and running on Heroku, it could do with a bit of work on the front end to make it look a bit nicer. If you recall, we’re using Bootstrap for our front end, so you may want to refer to the documentation for that to give you some ideas on how you want to style your blog.</p>
<p>Bootstrap has a nifty pager class for Next and Previous links, so let’s apply that to our post list template:</p>
<pre><code class="lang-django">&lt;ul class=&quot;pager&quot;&gt;
        {% if page_obj.has_previous %}
        &lt;li class=&quot;previous&quot;&gt;&lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;li class=&quot;next&quot;&gt;&lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        &lt;/ul&gt;
</code></pre>
<p>Let’s also add labels to our categories and tags. We’ll also place our posts and other content inside proper columns:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% if object_list %}
            {% for post in object_list %}
            &lt;div class=&quot;post col-md-12&quot;&gt;
            &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
            &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
            {{ post.text|custom_markdown }}
            &lt;/div&gt;
            {% if post.category %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-primary&quot;&gt;{{ post.category.name }}&lt;/span&gt;&lt;/a&gt;
            &lt;/div&gt;
            {% endif %}
            {% if post.tags %}
            &lt;div class=&quot;col-md-12&quot;&gt;
            {% for tag in post.tags.all %}
            &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-success&quot;&gt;{{ tag.name }}&lt;/span&gt;&lt;/a&gt;
            {% endfor %}
            &lt;/div&gt;
            {% endif %}
            {% endfor %}
        {% else %}
            &lt;p&gt;No posts found&lt;/p&gt;
        {% endif %}

        &lt;ul class=&quot;pager&quot;&gt;
        {% if page_obj.has_previous %}
        &lt;li class=&quot;previous&quot;&gt;&lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;li class=&quot;next&quot;&gt;&lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;&lt;/li&gt;
        {% endif %}
        &lt;/ul&gt;

    {% endblock %}
</code></pre>
<p>We’ll also want to tidy up the layout for our individual post pages:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post col-md-12&quot;&gt;
        &lt;h1&gt;{{ object.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ object.pub_date }}&lt;/h3&gt;
        {{ object.text|custom_markdown }}
        &lt;/div&gt;
        {% if object.category %}
        &lt;div class=&quot;col-md-12&quot;&gt;
        &lt;a href=&quot;{{ object.category.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-primary&quot;&gt;{{ object.category.name }}&lt;/span&gt;&lt;/a&gt;
        &lt;/div&gt;
        {% endif %}
        {% if object.tags %}
        &lt;div class=&quot;col-md-12&quot;&gt;
        {% for tag in object.tags.all %}
        &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;&lt;span class=&quot;label label-success&quot;&gt;{{ tag.name }}&lt;/span&gt;&lt;/a&gt;
        {% endfor %}
        &lt;/div&gt;
        {% endif %}

        &lt;div class=&quot;col-md-12&quot;&gt;
        &lt;h4&gt;Comments&lt;/h4&gt;
        &lt;div class=&quot;fb-comments&quot; data-href=&quot;http://{{ object.site }}{{ object.get_absolute_url }}&quot; data-width=&quot;470&quot; data-num-posts=&quot;10&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;/div&gt;

    {% endblock %}
</code></pre>
<p>Time to commit our changes:</p>
<pre><code class="lang-bash">$ git add templates/blogengine/
$ git commit -m &#39;Tidied up post templates&#39;
</code></pre>
<p>With that done, let’s turn our attention to our base template. We’ll amend the header to collapse down at smaller screen widths. This is easy to do with Bootstrap:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;!--[if lt IE 7]&gt;      &lt;html class=&quot;no-js lt-ie9 lt-ie8 lt-ie7&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 7]&gt;         &lt;html class=&quot;no-js lt-ie9 lt-ie8&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 8]&gt;         &lt;html class=&quot;no-js lt-ie9&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if gt IE 8]&gt;&lt;!--&gt; &lt;html class=&quot;no-js&quot;&gt; &lt;!--&lt;![endif]--&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;title&gt;{% block title %}My Django Blog{% endblock %}&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
        &lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;Blog posts&quot; href=&quot;/feeds/posts/&quot; &gt;

        &lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;

        {% load staticfiles %}
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/normalize.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap-theme.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;css/code.css&#39; %}&quot;&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/modernizr-2.6.2.min.js&#39; %}&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;!--[if lt IE 7]&gt;
            &lt;p class=&quot;browsehappy&quot;&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href=&quot;http://browsehappy.com/&quot;&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;

        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;container-fluid&quot;&gt;
                &lt;div class=&quot;navbar-header&quot;&gt;
                    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#header-nav&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/button&gt;
                    &lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;My Django Blog&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;header-nav&quot;&gt;
                    &lt;ul class=&quot;nav navbar-nav&quot;&gt;
                        {% load flatpages %}
                        {% get_flatpages as flatpages %}
                        {% for flatpage in flatpages %}
                        &lt;li&gt;&lt;a href=&quot;{{ flatpage.url }}&quot;&gt;{{ flatpage.title }}&lt;/a&gt;&lt;/li&gt;
                        {% endfor %}
                        &lt;li&gt;&lt;a href=&quot;/feeds/posts/&quot;&gt;RSS feed&lt;/a&gt;&lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container&quot;&gt;
            {% block header %}
                &lt;div class=&quot;page-header&quot;&gt;
                    &lt;h1&gt;My Django Blog&lt;/h1&gt;
                &lt;/div&gt;
            {% endblock %}

            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container footer&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                &lt;div class=&quot;span12&quot;&gt;
                    &lt;p&gt;Copyright &amp;copy; {% now &quot;Y&quot; %}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;window.jQuery || document.write(&#39;&lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/jquery-1.10.2.min.js&#39; %}&quot;&gt;&lt;\/script&gt;&#39;)&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/plugins.js&#39; %}&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/bootstrap/dist/js/bootstrap.min.js&#39; %}&quot;&gt;&lt;/script&gt;

        &lt;!-- Google Analytics: change UA-XXXXX-X to be your site&#39;s ID. --&gt;
        &lt;script&gt;
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src=&#39;//www.google-analytics.com/analytics.js&#39;;
            r.parentNode.insertBefore(e,r)}(window,document,&#39;script&#39;,&#39;ga&#39;));
            ga(&#39;create&#39;,&#39;UA-XXXXX-X&#39;);ga(&#39;send&#39;,&#39;pageview&#39;);
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Here we’ve also added a link to our RSS feed in the header, and another in the page head to facilitate working with browsers that support RSS better.</p>
<p>Our blog’s now looking much more presentable. All that remains is to commit it:</p>
<pre><code class="lang-bash">$ git add templates/blogengine/includes/base.html
$ git commit -m &#39;Amended base template&#39;
</code></pre>
<p>Now we can push it to GitHub and deploy it on Heroku:</p>
<pre><code class="lang-bash">$ git push origin master
$ git push heroku master
</code></pre>
<p>And we’re done! Don’t forget, you can grab this lesson with <code>git checkout lesson-6</code>.</p>
<p>Next time, we’ll cover search (I promise!).</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django blog tutorial - the next generation - part 5]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/05/24/django-blog-tutorial-the-next-generation-part-5/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/05/24/django-blog-tutorial-the-next-generation-part-5/</guid>
            <pubDate>Sat, 24 May 2014 19:15:54 GMT</pubDate>
            <description><![CDATA[<p>Hello again! I was originally planning to cover implementing a search system, adding more feeds, and tidying up the front end in this instalment. However, I felt it was time for a change of pace, so instead, we’re going to look at:</p>
<ul>
<li>Checking code coverage and getting it to 100%</li>
<li>Using continuous integration</li>
<li>Deploying to Heroku</li>
</ul>
<p>Don’t worry, the original lesson isn’t going anywhere. We’ll still be implementing all of that later on, but today is the day we get your Django blog up and running on the web. That way, you can get a better idea of how Django works in the wild, and you have something concrete to show for your efforts.</p>
<h1 id="continuous-integration">Continuous integration</h1>
<p>If you’re not familiar with continuous integration, it’s basically a process that carries out some tasks automatically when you push a new commit to the repository. These tasks may include running unit tests, linting your code, and checking it to see what percentage of the code base is covered by the tests (after all, if your tests don’t actually cover every scenario, then there’s more of a chance that something might slip through the net. It’s also possible to implement hooks to automatically deploy your application only if the tests pass.</p>
<p>Typically, you will have a continuous integration server running somewhere that regularly polls your Git repository for changes, and when it finds a new commit, will check it out and run the tests (or whatever other task you configure it to). One of the most popular continuous integration servers around is <a href="http://jenkins-ci.org/">Jenkins</a> - I use it at work and can highly recommend it. However, we aren’t going to cover using Jenkins here because setting it up is quite a big deal and it really is best kept on a server of its own (although feel free to use it if you prefer). Instead, we’re going to use <a href="https://travis-ci.org/">Travis CI</a>, which integrates nicely with GitHub and is free for open source projects. If you don’t mind your code being publicly available on GitHub, then Travis is a really great way to dip your toe into continuous integration.</p>
<p>NB: You don’t have to use continuous integration at all if you don’t want to - this isn’t a big project so you don’t really need it. If you don’t want to put your code on GitHub, then feel free to just follow along and not bother pushing your code to GitHub and configuring Travis.</p>
<h1 id="code-coverage">Code coverage</h1>
<p>As mentioned above, code coverage is a measure of the percentage of the code that is covered by tests. While not infallible, it’s a fairly good guide to how comprehensive your tests are. If you have 100% code coverage, you can be fairly confident that your tests are comprehensive enough to catch most errors, so it’s a good rule of thumb to aim for 100% test coverage on a project.</p>
<p>So how do we check our test coverage? The <code>coverage</code> Python module is the most common tool for this. There’s also a handy Django module called <code>django-jenkins</code>, which is designed to work with Jenkins, but can be used with any continuous integration server, that can not only run your tests, but also check code coverage at the same time. So, make sure your virtualenv is up and running:</p>
<pre><code class="lang-bash">$ source venv/bin/activate
</code></pre>
<p>Then, run the following command:</p>
<pre><code class="lang-bash">$ pip install coverage django-jenkins
</code></pre>
<p>Once that’s done, add these to our requirements file:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>We now need to configure our Django project to use <code>django-jenkins</code>. Add the following to the bottom of the settings file:</p>
<pre><code class="lang-python">INSTALLED_APPS += (&#39;django_jenkins&#39;,)
JENKINS_TASKS = (
    &#39;django_jenkins.tasks.run_pylint&#39;,
    &#39;django_jenkins.tasks.with_coverage&#39;,
)
PROJECT_APPS = [&#39;blogengine&#39;]
</code></pre>
<p>This adds <code>django-jenkins</code> to our installed apps and tells it to include two additional tasks, besides running the tests. The first task runs Pylint to check our code quality (but we aren’t really concerned about that at this point). The second checks the coverage. Finally, we tell <code>django-jenkins</code> that the <code>blogengine</code> app is the only one to be tested.</p>
<p>You’ll also want to add the following lines to your <code>.gitignore</code>:</p>
<pre><code class="lang-bash">reports/
htmlcov/
</code></pre>
<p>These are the reports generated by <code>django-jenkins</code>, and should not be kept under version control. With that done, it’s time to commit:</p>
<pre><code class="lang-bash">$ git add .gitignore django_tutorial_blog_ng/ requirements.txt
$ git commit -m &#39;Added coverage checking using django-jenkins&#39;
</code></pre>
<p>Now, let’s run our tests. From now on, you’ll use the following command to run your tests:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
</code></pre>
<p>This ensures we check the coverage at the same time. Now, you’ll notice that the <code>reports</code> folder has been created, and it will contain three files, including one called <code>coverage.xml</code>. However, XML isn’t a very friendly format. Happily, we can easily generate reports in HTML instead:</p>
<pre><code class="lang-bash">$ python manage.py jenkins --coverage-html-report=htmlcov
</code></pre>
<p>Running this command will create another folder called <code>htmlcov/</code>, and in here you will find your report, nicely formatted as HTML. Open up <code>index.html</code> in your web browser and you should see a file-by-file breakdown of your code coverage. Nice, huh?</p>
<p>Now, if your code so far is largely identical to mine, you’ll notice that the model and view files don’t have 100% coverage yet. If you click on each one, you’ll see a handy line-by-line breakdown of the test coverage for each file. You’ll notice that in the views file, the areas of the code for when tags and categories don’t exist are highlighted in pink - this tells you that these lines of code are never executed during the tests. So let’s fix that.</p>
<p>First, our template needs to be able to handle empty lists.</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% if object_list %}
            {% for post in object_list %}
            &lt;div class=&quot;post&quot;&gt;
            &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
            &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
            {{ post.text|custom_markdown }}
            &lt;/div&gt;
            &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;{{ post.category.name }}&lt;/a&gt;
            {% for tag in post.tags.all %}
            &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;{{ tag.name }}&lt;/a&gt;
            {% endfor %}
            {% endfor %}
        {% else %}
            &lt;p&gt;No posts found&lt;/p&gt;
        {% endif %}

        {% if page_obj.has_previous %}
        &lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;
        {% endif %}

    {% endblock %}
</code></pre>
<p>Let’s commit the changes:</p>
<pre><code class="lang-bash">$ git add templates/blogengine/post_list.html
$ git commit -m &#39;Added a &quot;No posts found&quot; message to post list template&#39;
</code></pre>
<p>Next, we need to write tests to check that we get a “No posts found” message when we view a tag or category that does not exist. Add the following methods to the class <code>PostViewTest()</code>:</p>
<pre><code class="lang-python">    def test_nonexistent_category_page(self):
        category_url = &#39;/category/blah/&#39;
        response = self.client.get(category_url)
        self.assertEquals(response.status_code, 200)
        self.assertTrue(&#39;No posts found&#39; in response.content)

    def test_nonexistent_tag_page(self):
        tag_url = &#39;/tag/blah/&#39;
        response = self.client.get(tag_url)
        self.assertEquals(response.status_code, 200)
        self.assertTrue(&#39;No posts found&#39; in response.content)
</code></pre>
<p>Now, let’s run our tests again:</p>
<pre><code class="lang-bash">$ python manage.py jenkins --coverage-html-report=htmlcov
</code></pre>
<p>Assuming they all pass as expected, then your coverage reports will be regenerated. If you reload the coverage report, you should see that your views now have 100% test coverage. Let’s commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/tests.py
$ git commit -m &#39;Views file now has 100% coverage&#39;
</code></pre>
<p>Now, our models still don’t have 100% coverage yet. If you look at the breakdown for <code>models.py</code>, you’ll see that the line <code>if not self.slug:</code> has only partial coverage, because we missed out setting a slug for the categories and tags in our test. So, let’s fix that. In <code>PostTest()</code>, amend the <code>test_create_category()</code> and <code>test_create_tag()</code> methods as follows:</p>
<pre><code class="lang-python">    def test_create_category(self):
        # Create the category
        category = Category()

        # Add attributes
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.slug = &#39;python&#39;

        # Save it
        category.save()

        # Check we can find it
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 1)
        only_category = all_categories[0]
        self.assertEquals(only_category, category)

        # Check attributes
        self.assertEquals(only_category.name, &#39;python&#39;)
        self.assertEquals(only_category.description, &#39;The Python programming language&#39;)
        self.assertEquals(only_category.slug, &#39;python&#39;)

    def test_create_tag(self):
        # Create the tag
        tag = Tag()

        # Add attributes
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.slug = &#39;python&#39;

        # Save it
        tag.save()

        # Check we can find it
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 1)
        only_tag = all_tags[0]
        self.assertEquals(only_tag, tag)

        # Check attributes
        self.assertEquals(only_tag.name, &#39;python&#39;)
        self.assertEquals(only_tag.description, &#39;The Python programming language&#39;)
        self.assertEquals(only_tag.slug, &#39;python&#39;)
</code></pre>
<p>Run the tests again:</p>
<pre><code class="lang-bash">$ python manage.py jenkins --coverage-html-report=htmlcov
</code></pre>
<p>Then refresh your coverage page, and we should have hit 100% coverage. Excellent news! This means that we can be confident that if any problems get introduced in future, we can pick them up easily. To demonstrate this, let’s upgrade our Django install to the latest version and check everything still works as expected:</p>
<pre><code class="lang-bash">$ pip install Django --upgrade
</code></pre>
<p>This will upgrade the copy of Django in our virtualenv to the latest version. Then we can run our tests again:</p>
<pre><code class="lang-bash">$ python manage.py jenkins --coverage-html-report=htmlcov
</code></pre>
<p>Our tests should still pass, indicating that the upgrade to our Django version does not appear to have broken any functionality. Let’s update our <code>requirements.txt</code>:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
$ git add requirements.txt
$ git commit -m &#39;Upgraded Django version&#39;
</code></pre>
<h1 id="preparing-our-web-app-for-deployment-to-heroku">Preparing our web app for deployment to Heroku</h1>
<p>As mentioned previously, I’m going to assume you plan to deploy your site on <a href="https://www.heroku.com/">Heroku</a>. It has good Django support, and you can quite happily host a blog there using their free tariff. If you’d prefer to use another hosting provider, then you should be able to adapt these instructions accordingly.</p>
<p>Now, so far we’ve used SQLite as our database for development purposes. However, SQLite isn’t really suitable for production purposes. Heroku provide a Postgresql database for each web app, so we will use that. To configure it, open up <code>settings.py</code> and amend the database configuration section to look like this:</p>
<pre><code class="lang-python">DATABASES = {
    &#39;default&#39;: {
        &#39;ENGINE&#39;: &#39;django.db.backends.&#39;,
        &#39;NAME&#39;: &#39;&#39;,
    }
}
</code></pre>
<p>Then, add the following at the end of the file:</p>
<pre><code class="lang-python">
# Heroku config
# Parse database configuration from $DATABASE_URL
import dj_database_url
DATABASES[&#39;default&#39;] =  dj_database_url.config(default=&quot;sqlite:///db.sqlite3&quot;)

# Honor the &#39;X-Forwarded-Proto&#39; header for request.is_secure()
SECURE_PROXY_SSL_HEADER = (&#39;HTTP_X_FORWARDED_PROTO&#39;, &#39;https&#39;)

# Allow all host headers
ALLOWED_HOSTS = [&#39;*&#39;]

# Static asset configuration
STATIC_ROOT = &#39;staticfiles&#39;

STATICFILES_DIRS = (
    os.path.join(BASE_DIR, &#39;static&#39;),
)
</code></pre>
<p>A little explanation is called for. Remember when we first started out, we installed the <code>django-toolbelt</code> package, which included <code>dj-database-url</code>? Well, here we use the <code>dj_database_url</code> module to get the database from an environment variable set on Heroku. We set a default value so as to fall back to SQLite when that variable is not set. The other settings are required by Heroku.</p>
<p>You may want to run your tests again to ensure everything is still working before committing:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Amended settings to work on desktop and Heroku&#39;
</code></pre>
<h1 id="setting-up-continuous-integration-and-coverage">Setting up Continuous Integration and coverage</h1>
<p>Now, as mentioned previously, I’ll be demonstrating how to set up Travis CI for our project. Travis CI is only free for open-source projects, so if you don’t want to make your code publicly accessible, you may want to use Jenkins instead. I’ll leave setting that up and running it as an exercise for the reader, but I recommend a plugin called Cobertura which allows you to publish details of your code’s test coverage.</p>
<p>Unfortunately, Travis CI doesn’t have the capability to publish your coverage results. Fortunately, you can use <a href="https://coveralls.io/">Coveralls.io</a> to pick up the slack. Like Travis, it’s free for open-source projects, and if you host your code on GitHub, it’s pretty easy to use.</p>
<p>You can find instructions on setting up a project on Travis CI <a href="http://docs.travis-ci.com/user/getting-started/">here</a>. Once you’ve configured it, you’ll need to set up your <code>.travis.yml</code> file. This is a simple text file that tells Travis CI how to run your tests. Put the following content in the file:</p>
<pre><code class="lang-yml">language: python
python:
- &quot;2.7&quot;
# command to install dependencies
install: &quot;pip install -r requirements.txt&quot;
# command to run tests
script: coverage run --include=&quot;blogengine/*&quot; --omit=&quot;blogengine/migrations/*&quot; manage.py test blogengine
after_success:
    coveralls
</code></pre>
<p>Now, this tells Travis that this is a Python application, and we should be using Python 2.7. Please note you can test against multiple versions of Python if you wish - just add another line with the Python version you want to test against.</p>
<p>Then, we see that we use Pip to install our requirements. Finally we run our tests with Coverage, in order to generate coverage data, and afterwards call <code>coveralls</code> to pass the coverage data to Coveralls.io.</p>
<p>We also need to install the <code>coveralls</code> module:</p>
<pre><code class="lang-bash">$ pip install coveralls
$ pip freeze &gt; requirements.txt
</code></pre>
<p>And we need to keep our coverage data out of version control:</p>
<pre><code class="lang-bash">env/
*.pyc
db.sqlite3
blogengine/static/bower_components/
reports/
htmlcov/
.coverage
</code></pre>
<p>You’ll also want to set up your project on Coveralls, as described <a href="https://coveralls.io/docs">here</a> - please note that this requires your project be in a public GitHub repository.</p>
<p>With that done, let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add .gitignore .travis.yml requirements.txt
$ git commit -m &#39;Added Travis config file and Coveralls support&#39;
</code></pre>
<p>With that done, assuming you have Travis CI and Coveralls configured, and your code is already hosted on GitHub, then you should be able to just push your code up to trigger the build:</p>
<pre><code class="lang-bash">$ git push origin master
</code></pre>
<p>If you keep an eye on Travis in your browser, you can watch what happens as your tests are run. If for any reason the build fails, then it shouldn’t be too hard to figure out what has gone wrong using the documentation for Travis and Coveralls - both services are pretty easy to use.</p>
<p>Congratulations - you’re now using Continuous Integration! That wasn’t so hard, was it? Now, every time you push to GitHub, Travis will run your tests, and you’ll get an email if they fail, giving you early warning of any problems, and you can check your coverage at the same time. Both Travis and Coveralls offer badges that you can place in your README file on GitHub to show off your coverage and build status - feel free to add these to your repo.</p>
<p>You may want to try making a change that breaks your tests and committing it, then pushing it up, so that you can see what happens when the build breaks.</p>
<h1 id="deploying-to-heroku">Deploying to Heroku</h1>
<p>Our final task today is deploying our blog to Heroku so we can see it in action. First of all, if you don’t already have an account with Heroku, you’ll need to sign up <a href="https://www.heroku.com/">here</a>. You should also be prompted to install the Heroku toolbelt. Once that’s done, run the following command:</p>
<pre><code class="lang-bash">$ heroku login
</code></pre>
<p>You’ll be prompted for your credentials - enter these and you should be able to log in successfully.</p>
<p>Now, in order to run our Django app on Heroku, we’ll need to add a <code>Procfile</code> to tell Heroku what command to run in order to start your app. In this case, we will be using Gunicorn as our web server. Assuming our project is called <code>django_tutorial_blog_ng</code>, this is what you need to put in this file:</p>
<pre><code class="lang-bash">web: gunicorn django_tutorial_blog_ng.wsgi
</code></pre>
<p>That tells Heroku that the file we need to run for this application is <code>django_tutorial_blog_ng/wsgi.py</code>. To test it, run the following command:</p>
<pre><code class="lang-bash">$ foreman start
</code></pre>
<p>That will start our web server on port 5000, using Gunicorn rather than the Django development server. You should be able to see it in action <a href="http://127.0.0.1:5000/">here</a>, but you’ll notice a very serious issue - namely that the static files aren’t being served. Now, Django has a command called <code>collectstatic</code> that collects all the static files and drops them into one convenient folder. Heroku will run this command automatically, so we need to ensure our static files are available. Amend your <code>.gitignore</code> file so it no longer excludes our static files:</p>
<pre><code class="lang-bash">venv/
*.pyc
db.sqlite3
reports/
htmlcov/
.coverage
</code></pre>
<p>We also need to amend our wsgi.py to serve static files:</p>
<pre><code class="lang-python">import os
os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;django_tutorial_blog_ng.settings&quot;)

from django.core.wsgi import get_wsgi_application
from dj_static import Cling

application = Cling(get_wsgi_application())
</code></pre>
<p>This should solve our problem. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/wsgi.py Procfile blogengine/static/ .gitignore
$ git commit -m &#39;Configured app for deployment on Heroku&#39;
</code></pre>
<p>Now we’re ready to deploy our app!</p>
<h1 id="deployment">Deployment</h1>
<p>Every Heroku app needs a unique name. If you don’t specify one, then Heroku will generate one for you. Your app will have the domain name <code>appname.herokuapp.com</code> - however, if you already have a domain name lined up for your blog, you can point that domain name at the Heroku app if you wish. I’m going to deploy mine with the name <code>blog-shellshocked-info</code>.</p>
<p>You also need to consider where you want to deploy it. Heroku has two regions - North America and EU. By default it will deploy to North America, but as I’m in the EU, that’s where I want to deploy my app to - obviously if you’re in the Americas, you may be better off sticking with North America.</p>
<p>So, let’s create our app. Here’s the command you need to run:</p>
<pre><code class="lang-bash">$ heroku apps:create blog-shellshocked-info --region eu
</code></pre>
<p>You will want to change the app name, or remove it entirely if you’re happy for Heroku to generate one for you. If you want to host it in North America, drop the <code>--region eu</code> section.</p>
<p>Once completed, this will have created your new app, and added a Git remote for it, but will not have deployed it. To deploy your app, run this command:</p>
<pre><code class="lang-bash">$ git push heroku master
</code></pre>
<p>That will push your code up to Heroku. Please note that building the app may take a little while. Once it’s done, you can run <code>heroku open</code> to open it in your web browser. You should see an error message stating that the relation <code>blogengine_post</code> does not exist. That’s because we need to create our database structure. Heroku allows you to easily run commands on your app with <code>heroku run</code>, so let’s create our database and run our migrations:</p>
<pre><code class="lang-bash">$ heroku run python manage.py syncdb
$ heroku run python manage.py migrate
</code></pre>
<p>These are exactly the same commands you would run locally to create your database, but prefaced with <code>heroku run</code> so that they get run by Heroku. As usual, you will be prompted to create a superuser - you’ll want to do this so you can log into the admin.</p>
<p>That’s all for today! We’ve finally got our site up and running on Heroku, and set up continuous integration so our tests will get run for us. You can see an example of the site working <a href="http://blog.shellshocked.info/">here</a>. As usual, you can check out the latest version of the code with <code>git checkout lesson-5</code>. If you’d like a homework assignment, then take a look at <a href="http://docs.travis-ci.com/user/deployment/heroku/">automating deployment to Heroku on successful builds</a> and see if you can get it set up successfully.</p>
<p>Next time around, we’ll get back to implementing our search and tidying up the front end. See you then!</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django blog tutorial - the next generation - part 4]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/02/15/django-blog-tutorial-the-next-generation-part-4/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/02/15/django-blog-tutorial-the-next-generation-part-4/</guid>
            <pubDate>Sat, 15 Feb 2014 17:45:00 GMT</pubDate>
            <description><![CDATA[<p>Hello again! As promised, in this instalment we’ll implement categories and tags, as well as an RSS feed.</p>
<p>As usual, we need to switch into our virtualenv:</p>
<pre><code class="lang-bash">$ source venv/bin/activate
</code></pre>
<h2 id="categories">Categories</h2>
<p>It’s worth taking a little time at this point to set out what we mean by categories and tags in this case, as the two can be very similar. In this case, we’ll use the following criteria:</p>
<ul>
<li>A post can have only one category, or none, but a category can be applied to any number of posts</li>
<li>A post can have any number of tags, and a tag can be applied to any number of posts</li>
</ul>
<p>If you’re not too familiar with relational database theory, the significance of this may not be apparent, so here’s a quick explanation. Because the categories are limited to one per post, the relationship between a post and a category is known as <em>one-to-many</em>. In other words, one post can only have one category, but one category can have many posts. You can therefore define the categories in one table in your database, and refer to them by their ID (the reference to the category in the post table is referred to as a <em>foreign key</em>).</p>
<p>As usual, we will write a test first. Open up <code>blogengine/tests.py</code> and edit the line importing the <code>Post</code> model as follows:</p>
<pre><code class="lang-python">from blogengine.models import Post, Category
</code></pre>
<p>Also, add the following method before <code>test_create_post</code>:</p>
<pre><code class="lang-python">    def test_create_category(self):
        # Create the category
        category = Category()

        # Add attributes
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;

        # Save it
        category.save()

        # Check we can find it
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 1)
        only_category = all_categories[0]
        self.assertEquals(only_category, category)

        # Check attributes
        self.assertEquals(only_category.name, &#39;python&#39;)
        self.assertEquals(only_category.description, &#39;The Python programming language&#39;)
</code></pre>
<p>This test checks that we can create categories. But categories aren’t much use unless we can actually apply them to our posts. So we need to edit our <code>Post</code> model as well, and to do so we need to have a test in place first. Edit the <code>test_create_post</code> method as follows:</p>
<pre><code class="lang-python">    def test_create_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.site.name, &#39;example.com&#39;)
        self.assertEquals(only_post.site.domain, &#39;example.com&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, &#39;testuser&#39;)
        self.assertEquals(only_post.author.email, &#39;user@example.com&#39;)
        self.assertEquals(only_post.category.name, &#39;python&#39;)
        self.assertEquals(only_post.category.description, &#39;The Python programming language&#39;)
</code></pre>
<p>What we’re doing here is adding a <code>category</code> attribute to the posts. This attribute contains a reference to a <code>Category</code> object.</p>
<p>Now, we also want to test adding, editing, and deleting a category from the admin interface. Add this code to the <code>AdminTest</code> class:</p>
<pre><code class="lang-python">    def test_create_category(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/category/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new category
        response = self.client.post(&#39;/admin/blogengine/category/add/&#39;, {
            &#39;name&#39;: &#39;python&#39;,
            &#39;description&#39;: &#39;The Python programming language&#39;
            },
            follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new category now in database
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 1)

    def test_edit_category(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the category
        response = self.client.post(&#39;/admin/blogengine/category/1/&#39;, {
            &#39;name&#39;: &#39;perl&#39;,
            &#39;description&#39;: &#39;The Perl programming language&#39;
            }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check category amended
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 1)
        only_category = all_categories[0]
        self.assertEquals(only_category.name, &#39;perl&#39;)
        self.assertEquals(only_category.description, &#39;The Perl programming language&#39;)

    def test_delete_category(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the category
        response = self.client.post(&#39;/admin/blogengine/category/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check category deleted
        all_categories = Category.objects.all()
        self.assertEquals(len(all_categories), 0) 
</code></pre>
<p>This is very similar to the prior code for the posts, and just checks we can create categories via the admin. We also need to check we can apply these categories to posts, and that they don’t break the existing tests:</p>
<pre><code class="lang-python">    def test_create_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.site = site
        post.author = author
        post.category = category
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post deleted
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)
</code></pre>
<p>Here we basically take our existing post tests in the admin interface and add the category to them. Finally, we edit the <code>PostViewTest</code> class to include categories:</p>
<pre><code class="lang-python">class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>Now it’s time to run our tests:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: blogengine.tests (unittest.loader.ModuleImportFailure)
----------------------------------------------------------------------
ImportError: Failed to import test module: blogengine.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python/2.7.6/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 254, in _find_tests
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python/2.7.6/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 232, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 3, in &lt;module&gt;
    from blogengine.models import Post, Category
ImportError: cannot import name Category


----------------------------------------------------------------------
Ran 1 test in 0.000s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>This is the expected result. We need to create our Category model. So let’s do that:</p>
<pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User
from django.contrib.sites.models import Site

# Create your models here.
class Category(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField()


class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)
    category = models.ForeignKey(Category, blank=True, null=True)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>Note that we add <code>Category</code> before <code>Post</code> - this is because <code>Category</code> is a foreign key in <code>Post</code>, and must be defined in order to be used. Also, note that we add the <code>category</code> attribute as a <code>ForeignKey</code> field, like <code>User</code> and <code>Site</code>, indicating that it is an item in another table being references.</p>
<p>We also allow for <code>category</code> to be blank or null, so the user does not have to apply a category if they don’t wish to.</p>
<p>If we run our tests, they should still fail:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
EEFEEEEE...EE
======================================================================
ERROR: test_create_category (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 20, in test_create_category
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 37, in test_create_post
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 215, in test_create_post
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 192, in test_delete_category
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_delete_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 304, in test_delete_post
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 165, in test_edit_category
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 250, in test_edit_post
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_index (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 353, in test_index
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
ERROR: test_post_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 403, in test_post_page
    category.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_category

======================================================================
FAIL: test_create_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 142, in test_create_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 13 tests in 3.393s

FAILED (failures=1, errors=9)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>The category table hasn’t yet been created, so we need to use South to create and run the migrations:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
$ python manage.py migrate
</code></pre>
<p>If we then run our tests again, some of them will still fail:</p>
<pre><code class="lang-bash">Creating test database for alias &#39;default&#39;...
..F.F.F......
======================================================================
FAIL: test_create_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 142, in test_create_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 201, in test_delete_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 175, in test_edit_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 13 tests in 4.047s

FAILED (failures=3)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>That’s because we haven’t registered the categories in the admin. So, that’s our next job:</p>
<pre><code class="lang-python">import models
from django.contrib import admin
from django.contrib.auth.models import User

class PostAdmin(admin.ModelAdmin):
    prepopulated_fields = {&quot;slug&quot;: (&quot;title&quot;,)}
    exclude = (&#39;author&#39;,)

    def save_model(self, request, obj, form, change):
        obj.author = request.user
        obj.save()

admin.site.register(models.Category)
admin.site.register(models.Post, PostAdmin)
</code></pre>
<p>Now we try again:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
.............
----------------------------------------------------------------------
Ran 13 tests in 4.092s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>It passes! Let’s do a quick sense check before committing. Run the server:</p>
<pre><code class="lang-bash">$ python manage.py runserver
</code></pre>
<p>If you visit the <a href="http://127.0.0.1:8000/admin/">admin</a>, you’ll see the text for category is <code>Categorys</code>, which is incorrect. We also don’t have a good representation of the category in the admin. Let’s fix that:</p>
<pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User
from django.contrib.sites.models import Site

# Create your models here.
class Category(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField()

    def __unicode__(self):
        return self.name

    class Meta:
        verbose_name_plural = &#39;categories&#39;


class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)
    category = models.ForeignKey(Category, blank=True, null=True)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Implemented categories&#39;
</code></pre>
<p>Now, as yet our categories don’t actually do all that much. We would like to be able to:</p>
<ul>
<li>List all posts under a category</li>
<li>Show the post category at the base of the post</li>
</ul>
<p>So, let’s implement that. First, as usual, we implement tests first:</p>
<pre><code class="lang-python">class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post category is in the response
        self.assertTrue(post.category.name in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post category is in the response
        self.assertTrue(post.category.name in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>All we do here is assert that for both the post pages and the index, the text from the category name is shown in the response. We also need to check the category-specific route works. Add this method to <code>PostViewTest</code>:</p>
<pre><code class="lang-python">    def test_category_page(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the category URL
        category_url = post.category.get_absolute_url()

        # Fetch the category
        response = self.client.get(category_url)
        self.assertEquals(response.status_code, 200)

        # Check the category name is in the response
        self.assertTrue(post.category.name in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>This is very similar to the previous tests, but fetches the absolute URL for the category, and ensures the category name and post content are shown. Now, let’s run our new tests:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
...........EFF
======================================================================
ERROR: test_category_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 494, in test_category_page
    category_url = post.category.get_absolute_url()
AttributeError: &#39;Category&#39; object has no attribute &#39;get_absolute_url&#39;

======================================================================
FAIL: test_index (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 391, in test_index
    self.assertTrue(post.category.name in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_post_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 446, in test_post_page
    self.assertTrue(post.category.name in response.content)
AssertionError: False is not true

----------------------------------------------------------------------
Ran 14 tests in 5.017s

FAILED (failures=2, errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s take a look at why they failed. <code>test_category_page</code> failed because the <code>Category</code> object had no method <code>get_absolute_url</code>. So we need to implement one. To do so, we really need to add a slug field, like the posts already have. Ideally, we want this to be populated automatically, but with the option to create one manually. So, edit the models as follows:</p>
<pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User
from django.contrib.sites.models import Site
from django.utils.text import slugify

# Create your models here.
class Category(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField()
    slug = models.SlugField(max_length=40, unique=True, blank=True, null=True)

    def save(self):
        if not self.slug:
            self.slug = slugify(unicode(self.name))
        super(Category, self).save()

    def get_absolute_url(self):
        return &quot;/category/%s/&quot; % (self.slug)

    def __unicode__(self):
        return self.name

    class Meta:
        verbose_name_plural = &#39;categories&#39;


class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)
    category = models.ForeignKey(Category, blank=True, null=True)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>We’re adding the <code>slug</code> attribute to the <code>Category</code> model here. However, we’re also overriding the <code>save</code> method to detect if the slug is set, and if not, to create a slug using the <code>slugify</code> function, and set it as the category’s slug. We also define an absolute URL for the category.</p>
<p>Now, if you run the tests, they will fail because we haven’t made the changes to the database. So, we use South again:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
</code></pre>
<p>Then run the migration:</p>
<pre><code class="lang-bash">$ python manage.py migrate
</code></pre>
<p>Now, running our tests will show that the tables are in place, but we still have some work to do. The index and post pages don’t show our categories, so we’ll fix that. First, we’ll fix our post list:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% for post in object_list %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text|custom_markdown }}
        &lt;/div&gt;
        &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;{{ post.category.name }}&lt;/a&gt;
        {% endfor %}

        {% if page_obj.has_previous %}
        &lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;
        {% endif %}

    {% endblock %}
</code></pre>
<p>Next, we’ll take care of our post detail page:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ object.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ object.pub_date }}&lt;/h3&gt;
        {{ object.text|custom_markdown }}
        &lt;a href=&quot;{{ object.category.get_absolute_url }}&quot;&gt;{{ object.category.name }}&lt;/a&gt;

        &lt;h4&gt;Comments&lt;/h4&gt;
        &lt;div class=&quot;fb-comments&quot; data-href=&quot;http://{{ post.site }}{{ post.get_absolute_url }}&quot; data-width=&quot;470&quot; data-num-posts=&quot;10&quot;&gt;&lt;/div&gt;

        &lt;/div&gt;

    {% endblock %}
</code></pre>
<p>Note that in both cases we include a link to the category URL.</p>
<p>Now, we should only have one failing test outstanding - the category page. For this, generic views aren’t sufficient as we need to limit the queryset to only show those posts with a specific category. Fortunately, we can extend Django’s generic views to add this functionality. First, we edit our URLconfs:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView, DetailView
from blogengine.models import Post, Category
from blogengine.views import CategoryListView

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        )),

    # Individual posts
    url(r&#39;^(?P&lt;pub_date__year&gt;\d{4})/(?P&lt;pub_date__month&gt;\d{1,2})/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, DetailView.as_view(
        model=Post,
        )),

    # Categories
    url(r&#39;^category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryListView.as_view(
        paginate_by=5,
        model=Category,
        )),
)
</code></pre>
<p>Note we import a new view from <code>blogengine.views</code> called <code>CategoryListView</code>. Next, we create that listview:</p>
<pre><code class="lang-python">from django.shortcuts import render
from django.views.generic import ListView
from blogengine.models import Category, Post

# Create your views here.
class CategoryListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            category = Category.objects.get(slug=slug)
            return Post.objects.filter(category=category)
        except Category.DoesNotExist:
            return Post.objects.none()
</code></pre>
<p>This is quite simple. We import the <code>ListView</code>, as well as our models. Then we extend <code>ListView</code> by getting the slug from the request, fetching the appropriate category, and returning only those posts that have that category. If the category does not exist, we return the empty <code>Post</code> object list. We haven’t had to set the template manually as it is inherited from <code>ListView</code>.</p>
<p>If you run the tests, they should now pass:</p>
<pre><code class="lang-bash">Creating test database for alias &#39;default&#39;...
..............
----------------------------------------------------------------------
Ran 14 tests in 5.083s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>So let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/ templates/
$ git commit -m &#39;Categories are now shown&#39;
</code></pre>
<h2 id="tags">Tags</h2>
<p>Tags are fairly similar to categories, but more complex. The relationship they have is called <em>many-to-many</em> - in other words, a tag can be applied to many posts, and one post can have many tags. This is more difficult to model with a relational database. The usual way to do so is to create an intermediate table between the posts and tags, to identify mappings between the two. Fortunately, Django makes this quite easy.</p>
<p>Let’s write the tests for our tagging system. As with the categories, we’ll write the tests for creating and editing them first, and add in tests for them being visible later. First we’ll create a test for creating a new tag object:</p>
<pre><code class="lang-python">    def test_create_tag(self):
        # Create the tag
        tag = Tag()

        # Add attributes
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;

        # Save it
        tag.save()

        # Check we can find it
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 1)
        only_tag = all_tags[0]
        self.assertEquals(only_tag, tag)

        # Check attributes
        self.assertEquals(only_tag.name, &#39;python&#39;)
        self.assertEquals(only_tag.description, &#39;The Python programming language&#39;)
</code></pre>
<p>Next, we’ll amend the test for creating a post to include tags:</p>
<pre><code class="lang-python">    def test_create_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category

        # Save it
        post.save()

        # Add the tag
        post.tags.add(tag)
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.site.name, &#39;example.com&#39;)
        self.assertEquals(only_post.site.domain, &#39;example.com&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, &#39;testuser&#39;)
        self.assertEquals(only_post.author.email, &#39;user@example.com&#39;)
        self.assertEquals(only_post.category.name, &#39;python&#39;)
        self.assertEquals(only_post.category.description, &#39;The Python programming language&#39;)

        # Check tags
        post_tags = only_post.tags.all()
        self.assertEquals(len(post_tags), 1)
        only_post_tag = post_tags[0]
        self.assertEquals(only_post_tag, tag)
        self.assertEquals(only_post_tag.name, &#39;python&#39;)
        self.assertEquals(only_post_tag.description, &#39;The Python programming language&#39;)
</code></pre>
<p>Note the difference in how we apply the tags. Because a post can have more than one tag, we can’t just define <code>post.tag</code> in the same way. Instead, we have <code>post.tags</code>, which you can think of as a list, and we use the <code>add</code> method to add a new tag. Note also that the post must already exist before we can add a tag.</p>
<p>We also need to create acceptance tests for creating, editing and deleting tags:</p>
<pre><code class="lang-python">    def test_create_tag(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/tag/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new tag
        response = self.client.post(&#39;/admin/blogengine/tag/add/&#39;, {
            &#39;name&#39;: &#39;python&#39;,
            &#39;description&#39;: &#39;The Python programming language&#39;
            },
            follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new tag now in database
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 1)

    def test_edit_tag(self):
        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the tag
        response = self.client.post(&#39;/admin/blogengine/tag/1/&#39;, {
            &#39;name&#39;: &#39;perl&#39;,
            &#39;description&#39;: &#39;The Perl programming language&#39;
            }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check tag amended
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 1)
        only_tag = all_tags[0]
        self.assertEquals(only_tag.name, &#39;perl&#39;)
        self.assertEquals(only_tag.description, &#39;The Perl programming language&#39;)

    def test_delete_tag(self):
        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the tag
        response = self.client.post(&#39;/admin/blogengine/tag/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check tag deleted
        all_tags = Tag.objects.all()
        self.assertEquals(len(all_tags), 0)
</code></pre>
<p>These tests are virtually identical to those for the <code>Category</code> objects, as we plan for our <code>Tag</code> objects to be very similar. Finally, we need to amend the acceptance tests for <code>Post</code> objects to include a tag:</p>
<pre><code class="lang-python">    def test_create_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: &#39;1&#39;,
            &#39;tags&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()
        post.tags.add(tag)
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;,
            &#39;site&#39;: &#39;1&#39;,
            &#39;category&#39;: &#39;1&#39;,
            &#39;tags&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.site = site
        post.author = author
        post.category = category
        post.save()
        post.tags.add(tag)
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post deleted
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)
</code></pre>
<p>Here we’re just adding tags to our <code>Post</code> objects.</p>
<p>Now it’s time to run our tests to make sure they fail as expected:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: blogengine.tests (unittest.loader.ModuleImportFailure)
----------------------------------------------------------------------
ImportError: Failed to import test module: blogengine.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python/2.7.6/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 254, in _find_tests
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python/2.7.6/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 232, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 3, in &lt;module&gt;
    from blogengine.models import Post, Category, Tag
ImportError: cannot import name Tag


----------------------------------------------------------------------
Ran 1 test in 0.000s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>So here we can’t import our <code>Tag</code> model, because we haven’t created it. So, we’ll do that:</p>
<pre><code class="lang-python">class Tag(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField()
    slug = models.SlugField(max_length=40, unique=True, blank=True, null=True)

    def save(self):
        if not self.slug:
            self.slug = slugify(unicode(self.name))
        super(Tag, self).save()

    def get_absolute_url(self):
        return &quot;/tag/%s/&quot; % (self.slug)

    def __unicode__(self):
        return self.name
</code></pre>
<p>Our <code>Tag</code> model is very much like our <code>Category</code> model, but we don’t need to change the <code>verbose_name_plural</code> value, and we amend the absolute URL to show it as a tag rather than a category.</p>
<p>We also need to amend our <code>Post</code> model to include a <code>tags</code> field:</p>
<pre><code class="lang-python">class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)
    category = models.ForeignKey(Category, blank=True, null=True)
    tags = models.ManyToManyField(Tag)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>Note that <code>tags</code> is a <code>ManyToManyField</code>, and we pass through the model we wish to use, much like we did with the categories. The difference is that one tag can be applied to many posts and a post can have many tags, so we need an intermediate database table to handle the relationship between the two. With Django’s ORM we can handle this quickly and easily.</p>
<p>Run our tests and they should still fail:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
.EE.EF.EE.EE......
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 64, in test_create_post
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
ERROR: test_create_tag (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 41, in test_create_tag
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
ERROR: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 335, in test_create_post
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
ERROR: test_delete_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 440, in test_delete_post
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
ERROR: test_delete_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 306, in test_delete_tag
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
ERROR: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 377, in test_edit_post
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
ERROR: test_edit_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 279, in test_edit_tag
    tag.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/models.py&quot;, line 34, in save
    super(Tag, self).save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_tag

======================================================================
FAIL: test_create_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 256, in test_create_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 18 tests in 3.981s

FAILED (failures=1, errors=7)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Again, we can easily see why they failed - the <code>blogengine_tag</code> table is not in place. So let’s create and run our migrations to fix that:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
$ python manage.py migrate
</code></pre>
<p>Now, we run our tests again:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
.....F..F..F......
======================================================================
FAIL: test_create_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 256, in test_create_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_delete_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 315, in test_delete_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 289, in test_edit_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 18 tests in 5.124s

FAILED (failures=3)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We can’t yet amend our tags in the admin, because we haven’t registered them. So we do that next:</p>
<pre><code class="lang-python">import models
from django.contrib import admin
from django.contrib.auth.models import User

class PostAdmin(admin.ModelAdmin):
    prepopulated_fields = {&quot;slug&quot;: (&quot;title&quot;,)}
    exclude = (&#39;author&#39;,)

    def save_model(self, request, obj, form, change):
        obj.author = request.user
        obj.save()

admin.site.register(models.Category)
admin.site.register(models.Tag)
admin.site.register(models.Post, PostAdmin)
</code></pre>
<p>Now, if we run our tests, they should pass:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
..................
----------------------------------------------------------------------
Ran 18 tests in 5.444s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Time to commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Implemented tags&#39;
</code></pre>
<p>Now, like with the categories beforehand, we want to be able to show the tags applied to a post at the base of it, and list all posts for a specific tag. So, first of all, we’ll amend our <code>PostViewTest</code> class to check for the tags:</p>
<pre><code class="lang-python">class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;perl&#39;
        tag.description = &#39;The Perl programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()
        post.tags.add(tag)

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post category is in the response
        self.assertTrue(post.category.name in response.content)

        # Check the post tag is in the response
        post_tag = all_posts[0].tags.all()[0]
        self.assertTrue(post_tag.name in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;perl&#39;
        tag.description = &#39;The Perl programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category
        post.save()
        post.tags.add(tag)
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post category is in the response
        self.assertTrue(post.category.name in response.content)

        # Check the post tag is in the response
        post_tag = all_posts[0].tags.all()[0]
        self.assertTrue(post_tag.name in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>We create a tag near the top, and check for the text in the page (note that to avoid false positives from the categories, we set the name of the tags to something different). We do this on both the index and post pages.</p>
<p>We also need to put a test in place for the tag-specific page:</p>
<pre><code class="lang-python">    def test_tag_page(self):
        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()
        post.tags.add(tag)

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the tag URL
        tag_url = post.tags.all()[0].get_absolute_url()

        # Fetch the tag
        response = self.client.get(tag_url)
        self.assertEquals(response.status_code, 200)

        # Check the tag name is in the response
        self.assertTrue(post.tags.all()[0].name in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>Again, this is virtually identical to the category page, adjusted to allow for the fact that we need to get a specific tag. If we now run our tests, they should fail as expected:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
................FFF
======================================================================
FAIL: test_index (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 540, in test_index
    self.assertTrue(post_tag.name in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_post_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 607, in test_post_page
    self.assertTrue(post_tag.name in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_tag_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 714, in test_tag_page
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 19 tests in 5.375s

FAILED (failures=3)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>So, we need to implement the following things:</p>
<ul>
<li>Show tags on the index page</li>
<li>Show tags on the post pages</li>
<li>Create a page listing the posts with a specific tag</li>
</ul>
<p>As we have seen already with the categories, this is actually quite simple. First, we’ll sort out the tags on the index page:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% for post in object_list %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text|custom_markdown }}
        &lt;/div&gt;
        &lt;a href=&quot;{{ post.category.get_absolute_url }}&quot;&gt;{{ post.category.name }}&lt;/a&gt;
        {% for tag in post.tags.all %}
        &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;{{ tag.name }}&lt;/a&gt;
        {% endfor %}
        {% endfor %}

        {% if page_obj.has_previous %}
        &lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;
        {% endif %}

    {% endblock %}
</code></pre>
<p>This is quite simple. We retrieve all the tags with <code>post.tags.all</code> and loop through them. We then do basically the same for the individual post pages:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ object.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ object.pub_date }}&lt;/h3&gt;
        {{ object.text|custom_markdown }}
        &lt;a href=&quot;{{ object.category.get_absolute_url }}&quot;&gt;{{ object.category.name }}&lt;/a&gt;
        {% for tag in post.tags.all %}
        &lt;a href=&quot;{{ tag.get_absolute_url }}&quot;&gt;{{ tag.name }}&lt;/a&gt;
        {% endfor %}

        &lt;h4&gt;Comments&lt;/h4&gt;
        &lt;div class=&quot;fb-comments&quot; data-href=&quot;http://{{ post.site }}{{ post.get_absolute_url }}&quot; data-width=&quot;470&quot; data-num-posts=&quot;10&quot;&gt;&lt;/div&gt;

        &lt;/div&gt;

    {% endblock %}

</code></pre>
<p>This should resolve two of our outstanding tests:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
..................F
======================================================================
FAIL: test_tag_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 714, in test_tag_page
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 19 tests in 5.440s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>The final test is for the tag pages. As we saw with the categories, we can limit our querysets on specific pages. So we’ll extend the <code>ListView</code> generic view again to handle tags:</p>
<pre><code class="lang-python">from django.shortcuts import render
from django.views.generic import ListView
from blogengine.models import Category, Post, Tag

# Create your views here.
class CategoryListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            category = Category.objects.get(slug=slug)
            return Post.objects.filter(category=category)
        except Category.DoesNotExist:
            return Post.objects.none()


class TagListView(ListView):
    def get_queryset(self):
        slug = self.kwargs[&#39;slug&#39;]
        try:
            tag = Tag.objects.get(slug=slug)
            return tag.post_set.all()
        except Tag.DoesNotExist:
            return Post.objects.none()
</code></pre>
<p>Note that here, <code>Tag</code> objects have access to their assigned <code>Post</code> objects - we just use <code>post_set</code> to refer to them and get all of the posts associated with that tag. Next we’ll add the URLconfs:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView, DetailView
from blogengine.models import Post, Category, Tag
from blogengine.views import CategoryListView, TagListView

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        )),

    # Individual posts
    url(r&#39;^(?P&lt;pub_date__year&gt;\d{4})/(?P&lt;pub_date__month&gt;\d{1,2})/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, DetailView.as_view(
        model=Post,
        )),

    # Categories
    url(r&#39;^category/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, CategoryListView.as_view(
        paginate_by=5,
        model=Category,
        )),

    # Tags
    url(r&#39;^tag/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, TagListView.as_view(
        paginate_by=5,
        model=Tag,
        )),
)
</code></pre>
<p>We import the <code>Tag</code> model and the <code>TagListView</code> view, and use them to set up the tag page.</p>
<p>If we now run our tests again, they should pass:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
...................
----------------------------------------------------------------------
Ran 19 tests in 5.473s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Well done! Time to commit:</p>
<pre><code class="lang-bash">$ git add templates/ blogengine/
$ git commit -m &#39;Tags are now shown&#39;
</code></pre>
<h2 id="rss-feed">RSS Feed</h2>
<p>For the final task today, we’ll implement an RSS feed for our posts. Django ships with a handy syndication framework that makes it easy to implement this kind of functionality.</p>
<p>As usual, we’ll create some tests first. In this case, we won’t be adding any new models, so we don’t need to test them. Instead we can jump straight into creating acceptance tests for our feed. For now we’ll just create one type of feed: a feed of all the blog posts. In a later instalment we’ll add feeds for categories and tags.</p>
<p>First of all, we’ll implement our test. Now, in order to test our feed, we need to have a solution in place for parsing an RSS feed. Django won’t do this natively, so we’ll install the <code>feedparser</code> Python module. Run the following commands:</p>
<pre><code class="lang-bash">$ pip install feedparser
$ pip freeze &gt; requirements.txt
</code></pre>
<p>Once that’s done, feedparser should be available. You may wish to refer to the <a href="http://pythonhosted.org/feedparser/">documentation</a> as we go to help.</p>
<p>Let’s write our test for the RSS feed. First, we import feedparser near the top of the file:</p>
<pre><code class="lang-python">import feedparser
</code></pre>
<p>Then we define a new class for our feed tests. Put this towards the end of the file - I put it just before the flat page tests:</p>
<pre><code class="lang-python">class FeedTest(BaseAcceptanceTest):
    def test_all_post_feed(self):
        # Create the category
        category = Category()
        category.name = &#39;python&#39;
        category.description = &#39;The Python programming language&#39;
        category.save()

        # Create the tag
        tag = Tag()
        tag.name = &#39;python&#39;
        tag.description = &#39;The Python programming language&#39;
        tag.save()

        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create a post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.category = category

        # Save it
        post.save()

        # Add the tag
        post.tags.add(tag)
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Fetch the feed
        response = self.client.get(&#39;/feeds/posts/&#39;)
        self.assertEquals(response.status_code, 200)

        # Parse the feed
        feed = feedparser.parse(response.content)

        # Check length
        self.assertEquals(len(feed.entries), 1)

        # Check post retrieved is the correct one
        feed_post = feed.entries[0]
        self.assertEquals(feed_post.title, post.title)
        self.assertEquals(feed_post.description, post.text)
</code></pre>
<p>Run the tests and you’ll see something like this:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
..............F.....
======================================================================
FAIL: test_all_post_feed (blogengine.tests.FeedTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 781, in test_all_post_feed
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 20 tests in 6.743s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>We’re getting a 404 error because the post feed isn’t implemented. So let’s implement it. We’re going to use Django’s syndication framework, which will make it easy, but we need to enable it. Open up <code>django_tutorial_blog_ng/settings/py</code> and add the following under <code>INSTALLED_APPS</code>:</p>
<pre><code class="lang-python">    &#39;django.contrib.syndication&#39;,
</code></pre>
<p>Next, we need to enable the URLconf for this RSS feed. Open up <code>blogengine/urls.py and amend the import from</code>blogengine.views` near the top:</p>
<pre><code class="lang-python">from blogengine.views import CategoryListView, TagListView, PostsFeed
</code></pre>
<p>Further down, add in the following code to define the URL for the feed:</p>
<pre><code class="lang-python">    # Post RSS feed
    url(r&#39;^feeds/posts/$&#39;, PostsFeed()),
</code></pre>
<p>Note that we imported the PostsFeed class, but that hasn’t yet been defined. So we need to do that. First of all, add this line near the top:</p>
<pre><code class="lang-python">from django.contrib.syndication.views import Feed
</code></pre>
<p>This imports the syndication views - yes, they’re another generic view! Our <code>PostsFeed</code> class is going to inherit from <code>Feed</code>. Next, we define the class:</p>
<pre><code class="lang-python">class PostsFeed(Feed):
    title = &quot;RSS feed - posts&quot;
    link = &quot;feeds/posts/&quot;
    description = &quot;RSS feed - blog posts&quot;

    def items(self):
        return Post.objects.order_by(&#39;-pub_date&#39;)

    def item_title(self, item):
        return item.title

    def item_description(self, item):
        return item.text
</code></pre>
<p>This is fairly straightforward. We define our title, link, and description for the feed inside the class definition. We define the <code>items</code> method which sets what items are returned by the RSS feed. We also define the <code>item_title</code> and <code>item_description</code> methods.</p>
<p>Now, if we run our tests, they should pass:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test blogengine
Creating test database for alias &#39;default&#39;...
....................
----------------------------------------------------------------------
Ran 20 tests in 5.933s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/ django_tutorial_blog_ng/ requirements.txt
$ git commit -m &#39;RSS feed implemented&#39;
</code></pre>
<p>And that’s enough for now. Don’t forget, you can get the code for this lesson by cloning the repository from <a href="https://github.com/matthewbdaly/django_tutorial_blog_ng">Github</a> and running <code>git checkout lesson-4</code> to switch to this lesson.</p>
<p>Next time we’ll:</p>
<ul>
<li>Implement a search system</li>
<li>Add feeds for categories and posts</li>
<li>Tidy up the user interface</li>
</ul>
<p>Hope to see you then!</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django Blog Tutorial - the Next Generation - Part 3]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/</guid>
            <pubDate>Fri, 03 Jan 2014 12:57:30 GMT</pubDate>
            <description><![CDATA[<p>Hello again! In this instalment, we’re going to do the following:</p>
<ul>
<li>Add support for flat pages</li>
<li>Add support for multiple authors</li>
<li>Add a third-party comment system</li>
</ul>
<h2 id="flat-pages">Flat pages</h2>
<p>Django ships with a number of useful apps - we’ve already used the admin interface. The flat pages app is another very handy app that comes with Django, and we’ll use it to allow the blog author to create a handful of flat pages.</p>
<p>First of all, you’ll need to install the flatpages app. Edit the <code>INSTALLED_APPS</code> setting as follows:</p>
<pre><code class="lang-python">INSTALLED_APPS = (
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;south&#39;,
    &#39;blogengine&#39;,
    &#39;django.contrib.sites&#39;,
    &#39;django.contrib.flatpages&#39;,
)
</code></pre>
<p>Note that we needed to enable the <code>sites</code> framework as well. You’ll also need to set the <code>SITE_ID</code> setting:</p>
<pre><code class="lang-python">SITE_ID = 1
</code></pre>
<p>With that done, run <code>python manage.py syncdb</code> to create the required database tables. Now, let’s use the <code>sqlall</code> command to take a look at the database structure generated for the flat pages:</p>
<pre><code class="lang-sql">BEGIN;
CREATE TABLE &quot;django_flatpage_sites&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;flatpage_id&quot; integer NOT NULL,
    &quot;site_id&quot; integer NOT NULL REFERENCES &quot;django_site&quot; (&quot;id&quot;),
    UNIQUE (&quot;flatpage_id&quot;, &quot;site_id&quot;)
)
;
CREATE TABLE &quot;django_flatpage&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;url&quot; varchar(100) NOT NULL,
    &quot;title&quot; varchar(200) NOT NULL,
    &quot;content&quot; text NOT NULL,
    &quot;enable_comments&quot; bool NOT NULL,
    &quot;template_name&quot; varchar(70) NOT NULL,
    &quot;registration_required&quot; bool NOT NULL
)
;
CREATE INDEX &quot;django_flatpage_sites_872c4601&quot; ON &quot;django_flatpage_sites&quot; (&quot;flatpage_id&quot;);
CREATE INDEX &quot;django_flatpage_sites_99732b5c&quot; ON &quot;django_flatpage_sites&quot; (&quot;site_id&quot;);
CREATE INDEX &quot;django_flatpage_c379dc61&quot; ON &quot;django_flatpage&quot; (&quot;url&quot;);

COMMIT;
</code></pre>
<p>As mentioned previously, all models in Django have an <code>id</code> attribute by default. Each flat page also has a URL, title, and content. </p>
<p>Also note the separate <code>django_flatpage_sites</code> table, which maps sites to flat pages. Django can run multiple sites from the same web app, and so flat pages must be allocated to a specific site. This relationship is a many-to-many relationship, so one flat page can appear on more than one site.</p>
<p>The other fields <a href="http://127.0.0.1:8000/admin/flatpages/flatpage/add/">are hidden by default in the admin</a> and can be ignored. Let’s have a go with Django’s handy shell to explore the flatpage. Run <code>python manage.py shell</code> and you’ll be able to interact with your Django application interactively:</p>
<pre><code class="lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py shell
Python 2.7.6 (default, Nov 23 2013, 13:53:45)
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
(InteractiveConsole)
&gt;&gt;&gt; from django.contrib.flatpages.models import *
&gt;&gt;&gt; FlatPage
&lt;class &#39;django.contrib.flatpages.models.FlatPage&#39;&gt;
&gt;&gt;&gt; from django.contrib.sites.models import Site
&gt;&gt;&gt; Site.objects.all()
[&lt;Site: example.com&gt;]
</code></pre>
<p>As you can see, <code>flatpages</code> is a Django app similar to the <code>blogengine</code> one, with its own models, as is <code>sites</code>. You can see that the <code>FlatPage</code> class is a model. We can create an instance of it and save it interactively:</p>
<pre><code class="lang-python">&gt;&gt;&gt; f = FlatPage()
&gt;&gt;&gt; f.url = &#39;/about/&#39;
&gt;&gt;&gt; f.title = &#39;About me&#39;
&gt;&gt;&gt; f.content = &#39;All about me&#39;
&gt;&gt;&gt; f.save()
&gt;&gt;&gt; f.sites.add(Site.objects.all()[0])
&gt;&gt;&gt; f.save()
</code></pre>
<p>Note that because the relationship between the site and the flat page is a many-to-many relationship, we need to save it first, then use the <code>add</code> method to add the site to the list of sites.</p>
<p>We can retrieve it:</p>
<pre><code class="lang-python">&gt;&gt;&gt; FlatPage.objects.all()
[&lt;FlatPage: /about/ -- About me&gt;]
&gt;&gt;&gt; FlatPage.objects.all()[0]
&lt;FlatPage: /about/ -- About me&gt;
&gt;&gt;&gt; FlatPage.objects.all()[0].title
u&#39;About me&#39;
</code></pre>
<p>This command is often handy for debugging problems with your models interactively. If you now run the server and visit the admin, you should notice that the Flatpages app is now visible there, and the ‘About me’ flat page is now shown in there.</p>
<p>Let’s also take a look at the SQL required for the <code>Site</code> model. Run <code>python manage.py sqlall sites</code>:</p>
<pre><code class="lang-sql">BEGIN;
CREATE TABLE &quot;django_site&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;domain&quot; varchar(100) NOT NULL,
    &quot;name&quot; varchar(50) NOT NULL
)
;

COMMIT;
</code></pre>
<p>Again, very simple - just a domain and a name.</p>
<p>So, now that we have a good idea of how the flat page system works, we can write a test for it. We don’t need to write unit tests for the model because Django already does that, but we do need to write an acceptance test to ensure we can create flat pages and they will be where we expect them to be. Add the following to the top of the test file:</p>
<pre><code class="lang-python">from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
</code></pre>
<p>Now, before we write this test, there’s some duplication to resolve. We have two tests that subclass <code>LiveServerTestCase</code>, and both have the same method, <code>setUp</code>. We can save ourselves some hassle by creating a new class containing this method and having both these tests inherit from it. We’ll do that now because the flat page test can also be based on it. Create the following class just after <code>PostTest</code>:</p>
<pre><code class="lang-python">class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()
</code></pre>
<p>Then remove the setUp method from each of the two tests based on <code>LiveServerTestCase</code>, and change their parent class to <code>BaseAcceptanceTest</code>:</p>
<pre><code class="lang-python">class AdminTest(BaseAcceptanceTest):

class PostViewTest(BaseAcceptanceTest):
</code></pre>
<p>With that done, run the tests and they should pass. Commit your changes:</p>
<pre><code class="lang-bash">$ git add blogengine/tests.py django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Added flatpages to installed apps&#39;
</code></pre>
<p>Now we can get started in earnest on our test for the flat pages:</p>
<pre><code class="lang-python">class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):
        # Create flat page
        page = FlatPage()
        page.url = &#39;/about/&#39;
        page.title = &#39;About me&#39;
        page.content = &#39;All about me&#39;
        page.save()

        # Add the site
        page.sites.add(Site.objects.all()[0])
        page.save()

        # Check new page saved
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), 1)
        only_page = all_pages[0]
        self.assertEquals(only_page, page)

        # Check data correct
        self.assertEquals(only_page.url, &#39;/about/&#39;)
        self.assertEquals(only_page.title, &#39;About me&#39;)
        self.assertEquals(only_page.content, &#39;All about me&#39;)

        # Get URL
        page_url = only_page.get_absolute_url()

        # Get the page
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, 200)

        # Check title and content in response
        self.assertTrue(&#39;About me&#39; in response.content)
        self.assertTrue(&#39;All about me&#39; in response.content)
</code></pre>
<p>Let’s run our tests:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
......F..
======================================================================
FAIL: test_create_flat_page (blogengine.tests.FlatPageViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 272, in test_create_flat_page
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 9 tests in 2.760s

FAILED (failures=1)
</code></pre>
<p>We can see why it’s failed - in our flat page test, the status code is 404, indicating the page was not found. This just means we haven’t put flat page support into our URLconf. So let’s fix that:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns(&#39;&#39;,
    # Examples:
    # url(r&#39;^$&#39;, &#39;django_tutorial_blog_ng.views.home&#39;, name=&#39;home&#39;),
    # url(r&#39;^blog/&#39;, include(&#39;blog.urls&#39;)),

    url(r&#39;^admin/&#39;, include(admin.site.urls)),

    # Blog URLs
    url(r&#39;&#39;, include(&#39;blogengine.urls&#39;)),

    # Flat pages
    url(r&#39;&#39;, include(&#39;django.contrib.flatpages.urls&#39;)),
)
</code></pre>
<p>Let’s run our tests again:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
......E..
======================================================================
ERROR: test_create_flat_page (blogengine.tests.FlatPageViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 276, in test_create_flat_page
    response = self.client.get(page_url)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py&quot;, line 473, in get
    response = super(Client, self).get(path, data=data, **extra)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py&quot;, line 280, in get
    return self.request(**r)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py&quot;, line 444, in request
    six.reraise(*exc_info)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/handlers/base.py&quot;, line 114, in get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/flatpages/views.py&quot;, line 45, in flatpage
    return render_flatpage(request, f)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/decorators.py&quot;, line 99, in _wrapped_view
    response = view_func(request, *args, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/flatpages/views.py&quot;, line 60, in render_flatpage
    t = loader.get_template(DEFAULT_TEMPLATE)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/template/loader.py&quot;, line 138, in get_template
    template, origin = find_template(template_name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/template/loader.py&quot;, line 131, in find_template
    raise TemplateDoesNotExist(name)
TemplateDoesNotExist: flatpages/default.html

----------------------------------------------------------------------
Ran 9 tests in 3.557s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Our test still fails, but we can easily see  why - the template <code>flatpages/default.html</code> doesn’t exist. So we create it:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ flatpage.title }}&lt;/h1&gt;
        {{ flatpage.content|custom_markdown }}
        &lt;/div&gt;

    {% endblock %}
</code></pre>
<p>This template is based on the blog post one, and just changes a handful of variable names. Note that it can still inherit from the blogengine base template, and in this case we’re using that for the sake of consistency.</p>
<p>If you run your tests, you should now see that they pass, so we’ll commit our changes:</p>
<pre><code class="lang-bash">$ git add templates/ django_tutorial_blog_ng/ blogengine/
$ git commit -m &#39;Implemented flat page support&#39;
</code></pre>
<h2 id="multiple-authors">Multiple authors</h2>
<p>Next we’ll add support for multiple authors. Now, Django already has a User model, and we’ll leverage that to represent the authors. But first we’ll write our test:</p>
<pre><code class="lang-python">from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
from django.contrib.auth.models import User
import markdown

# Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, &#39;testuser&#39;)
        self.assertEquals(only_post.author.email, &#39;user@example.com&#39;)

class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()


class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)

class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)


class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):
        # Create flat page
        page = FlatPage()
        page.url = &#39;/about/&#39;
        page.title = &#39;About me&#39;
        page.content = &#39;All about me&#39;
        page.save()

        # Add the site
        page.sites.add(Site.objects.all()[0])
        page.save()

        # Check new page saved
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), 1)
        only_page = all_pages[0]
        self.assertEquals(only_page, page)

        # Check data correct
        self.assertEquals(only_page.url, &#39;/about/&#39;)
        self.assertEquals(only_page.title, &#39;About me&#39;)
        self.assertEquals(only_page.content, &#39;All about me&#39;)

        # Get URL
        page_url = str(only_page.get_absolute_url())

        # Get the page
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, 200)

        # Check title and content in response
        self.assertTrue(&#39;About me&#39; in response.content)
        self.assertTrue(&#39;All about me&#39; in response.content)
</code></pre>
<p>Here we create a <code>User</code> object to represent the author. Note the <code>create_user</code> convenience method for creating new users quickly and easily.</p>
<p>We’re going to exclude the author field from the admin - instead it’s going to be automatically populated based on the session data, so that when a user creates a post they are automatically set as the author. We therefore don’t need to make any changes for the acceptance tests for posts - our changes to the unit tests for the <code>Post</code> model are sufficient.</p>
<p>Run the tests, and they should fail:</p>
<pre><code class="lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
E........
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 45, in test_create_post
    self.assertEquals(only_post.author.username, &#39;testuser&#39;)
AttributeError: &#39;Post&#39; object has no attribute &#39;author&#39;

----------------------------------------------------------------------
Ran 9 tests in 3.620s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Let’s add the missing <code>author</code> attribute:</p>
<pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>Next, create the migrations:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
</code></pre>
<p>You’ll be prompted to either quit or provide a default author ID - select option 2 to provide the ID, then enter 1, which should be your own user account ID. Then run the migrations:</p>
<pre><code class="lang-bash">$ python manage.py migrate
</code></pre>
<p>Let’s run our tests again:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.F.F.....
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 118, in test_create_post
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 154, in test_edit_post
    self.assertTrue(&#39;changed successfully&#39; in response.content)
AssertionError: False is not true

----------------------------------------------------------------------
Ran 9 tests in 3.390s

FAILED (failures=2)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Our test still fails because the author field isn’t set automatically. So we’ll amend the admin to automatically set the author when the <code>Post</code> object is saved:</p>
<pre><code class="lang-python">import models
from django.contrib import admin
from django.contrib.auth.models import User

class PostAdmin(admin.ModelAdmin):
    prepopulated_fields = {&quot;slug&quot;: (&quot;title&quot;,)}
    exclude = (&#39;author&#39;,)

    def save_model(self, request, obj, form, change):
        obj.author = request.user
        obj.save()

admin.site.register(models.Post, PostAdmin)
</code></pre>
<p>This tells the admin to exclude the <code>author</code> field from any form for a post, and when the model is saved, to set the author to the user making the HTTP request. Now run the tests, and they should pass:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.........
----------------------------------------------------------------------
Ran 9 tests in 4.086s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Time to commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Added author field&#39;
</code></pre>
<h2 id="comments">Comments</h2>
<p>The <a href="http://matthewdaly.co.uk/blog/2012/03/29/yet-another-tutorial-for-building-a-blog-using-python-and-django-part-4/">previous version of this tutorial</a> implemented comments using Django’s own comment system. However, this has since been deprecated from Django and turned into <a href="https://github.com/django/django-contrib-comments">a separate project</a>. So we have two options for how to implement comments:</p>
<ul>
<li>We can use <a href="http://django-contrib-comments.readthedocs.org/en/latest/">the comments system</a></li>
<li>We can use a third-party comments system</li>
</ul>
<p>Now, if you want to use the Django comment system, you can do so, and it shouldn’t be too hard to puzzle out how to implement it using the documentation and my prior post. However, in my humble opinion, using a third-party comment system is the way to go for blog comments - they make it extremely easy for people to log in with multiple services without you having to write lots of additional code. They also make it significantly easier to moderate comments, and they’re generally pretty good at handling comment spam.</p>
<p>Some of the available providers include:</p>
<ul>
<li><a href="http://disqus.com/">Disqus</a></li>
<li><a href="http://intensedebate.com/">IntenseDebate</a></li>
<li><a href="https://developers.facebook.com/docs/plugins/comments/">Facebook</a></li>
</ul>
<p>For demonstration purposes, we’ll use Facebook comments, but this shouldn’t require much work to adapt it to the other providers.</p>
<p>First of all, we need to include the Facebook JavaScript SDK:</p>
<pre><code class="lang-django">        &lt;!-- Add your site or application content here --&gt;

        &lt;div id=&quot;fb-root&quot;&gt;&lt;/div&gt;
        &lt;script&gt;(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = &quot;//connect.facebook.net/en_GB/all.js#xfbml=1&quot;;
                fjs.parentNode.insertBefore(js, fjs);
            }(document, &#39;script&#39;, &#39;facebook-jssdk&#39;));&lt;/script&gt;

        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;navbar-inner&quot;&gt;
                &lt;div class=&quot;container&quot;&gt;
                    &lt;a class=&quot;btn btn-navbar&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.nav-collapse&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/a&gt;
                    &lt;a class=&quot;brand&quot; href=&quot;/&quot;&gt;My Django Blog&lt;/a&gt;
                    &lt;div class=&quot;nav-collapse collapse&quot;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
</code></pre>
<p>Now, the Facebook comment system requires that you pass through the absolute page URL when initialising the comments. At present we can’t do that without hard-coding the domain name in our template, which we want to avoid. So, we need to add a site field to each post to identify the site it’s associated with.</p>
<p>As usual, we update our tests first:</p>
<pre><code class="lang-python">from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
from django.contrib.auth.models import User
import markdown

# Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.site.name, &#39;example.com&#39;)
        self.assertEquals(only_post.site.domain, &#39;example.com&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, &#39;testuser&#39;)
        self.assertEquals(only_post.author.email, &#39;user@example.com&#39;)

class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()


class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;,
            &#39;site&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;,
            &#39;site&#39;: &#39;1&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.site = site
        post.author = author
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)

class PostViewTest(BaseAcceptanceTest):
    def test_index(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the author
        author = User.objects.create_user(&#39;testuser&#39;, &#39;user@example.com&#39;, &#39;password&#39;)
        author.save()

        # Create the site
        site = Site()
        site.name = &#39;example.com&#39;
        site.domain = &#39;example.com&#39;
        site.save()

        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)


class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):
        # Create flat page
        page = FlatPage()
        page.url = &#39;/about/&#39;
        page.title = &#39;About me&#39;
        page.content = &#39;All about me&#39;
        page.save()

        # Add the site
        page.sites.add(Site.objects.all()[0])
        page.save()

        # Check new page saved
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), 1)
        only_page = all_pages[0]
        self.assertEquals(only_page, page)

        # Check data correct
        self.assertEquals(only_page.url, &#39;/about/&#39;)
        self.assertEquals(only_page.title, &#39;About me&#39;)
        self.assertEquals(only_page.content, &#39;All about me&#39;)

        # Get URL
        page_url = str(only_page.get_absolute_url())

        # Get the page
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, 200)

        # Check title and content in response
        self.assertTrue(&#39;About me&#39; in response.content)
        self.assertTrue(&#39;All about me&#39; in response.content)
</code></pre>
<p>All we’ve done here is to add the <code>site</code> attribute when creating a new post using the Django database API, and when we create one via the admin, we add an additional <code>site</code> aparameter to the HTTP POST request with a value of 1. Run the tests and they should fail:</p>
<pre><code class="lang-bash">Creating test database for alias &#39;default&#39;...
E........
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 46, in test_create_post
    self.assertEquals(only_post.site.name, &#39;example.com&#39;)
AttributeError: &#39;Post&#39; object has no attribute &#39;site&#39;

----------------------------------------------------------------------
Ran 9 tests in 4.313s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>So we need to add the <code>site</code> attribute to the <code>Post</code> model. Let’s do that:</p>
<pre><code class="lang-python">from django.db import models
from django.contrib.auth.models import User
from django.contrib.sites.models import Site

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>Now create and run the migrations - you’ll be prompted to create a default value for the site attribute as well:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py schemamigration --auto blogengine
 ? The field &#39;Post.site&#39; does not have a default specified, yet is NOT NULL.
 ? Since you are adding this field, you MUST specify a default
 ? value to use for existing rows. Would you like to:
 ?  1. Quit now, and add a default to the field in models.py
 ?  2. Specify a one-off value to use for existing columns now
 ? Please select a choice: 2
 ? Please enter Python code for your one-off default value.
 ? The datetime module is available, so you can do e.g. datetime.date.today()
 &gt;&gt;&gt; 1
 + Added field site on blogengine.Post
Created 0005_auto__add_field_post_site.py. You can now apply this migration with: ./manage.py migrate blogengine
(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py migrate
Running migrations for blogengine:
 - Migrating forwards to 0005_auto__add_field_post_site.
 &gt; blogengine:0005_auto__add_field_post_site
 - Loading initial data for blogengine.
Installed 0 object(s) from 0 fixture(s)
</code></pre>
<p>Our tests should then pass:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.........
----------------------------------------------------------------------
Ran 9 tests in 4.261s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Now we can include our full page URL on the post detail page:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ object.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ object.pub_date }}&lt;/h3&gt;
        {{ object.text|custom_markdown }}

        &lt;h4&gt;Comments&lt;/h4&gt;
        &lt;div class=&quot;fb-comments&quot; data-href=&quot;http://{{ post.site }}{{ post.get_absolute_url }}&quot; data-width=&quot;470&quot; data-num-posts=&quot;10&quot;&gt;&lt;/div&gt;

        &lt;/div&gt;

    {% endblock %}
</code></pre>
<p>If you want to customise the comments, take a look at <a href="https://developers.facebook.com/docs/plugins/comments/">the documentation for Facebook Comments</a>.</p>
<p>With that done, we can commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/ templates/
$ git commit -m &#39;Implemented Facebook comments&#39;
</code></pre>
<p>And that wraps up this lesson. As usual, you can easily switch to today’s lesson with <code>git checkout lesson-3</code>. Next time we’ll implement categories and tags, and create an RSS feed for our blog posts.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django blog tutorial - the next generation - part 2]]></title>
            <link>https://matthewdaly.co.uk/blog/2014/01/02/django-blog-tutorial-the-next-generation-part-2/</link>
            <guid>https://matthewdaly.co.uk/blog/2014/01/02/django-blog-tutorial-the-next-generation-part-2/</guid>
            <pubDate>Thu, 02 Jan 2014 11:28:48 GMT</pubDate>
            <description><![CDATA[<p>Welcome back! In this lesson, we’ll use Twitter Bootstrap to make our blog look nicer, and we’ll implement individual pages for each post.</p>
<p>Now, before we get started, don’t forget to switch into your virtualenv. From within the directory for the project, run the following command:</p>
<pre><code class="lang-bash">$ source venv/bin/activate
</code></pre>
<p>If you haven’t used Bootstrap before, you’re in for a treat. With Bootstrap, it’s easy to make a good-looking website quickly that’s responsive and mobile-friendly. We’ll also use HTML5 Boilerplate to get a basic HTML template in place.</p>
<p>Now, to install these easily, we’ll use Bower, which requires <a href="http://nodejs.org/">Node.js</a>. Install Node.js first. On most Linux distros, you’ll also need to set <code>NODE_PATH</code>, which can be done by pasting the following into your <code>.bashrc</code>:</p>
<pre><code class="lang-bash">NODE_PATH=&quot;/usr/local/lib/node_modules&quot;
</code></pre>
<p>With that done, run the following command to install Bower:</p>
<pre><code class="lang-bash">$ sudo npm install -g bower
</code></pre>
<p>Next we need to create a Bower config. First, create the folder <code>blogengine/static</code>. Then create a new file called <code>.bowerrc</code> and paste in the following content:</p>
<pre><code class="lang-json">{
    &quot;directory&quot;: &quot;blogengine/static/bower_components&quot;
}
</code></pre>
<p>This tells Bower where it should put downloaded libraries. Next, run the following command to gener Bower:</p>
<pre><code class="lang-bash">$ bower init
</code></pre>
<p>Answer all the questions it asks you - for those with defaults, these should be fine, and everything else should be easy enough. Next, run the following command to install Bootstrap and HTML5 Boilerplate:</p>
<pre><code class="lang-bash">$ bower install bootstrap html5-boilerplate --save
</code></pre>
<p>Note that as jQuery is a dependency of Bootstrap, it will also be installed automatically. Now, we need to keep our Bower-installed files out of version control - the <code>bower.json</code> file keeps track of them for us. So add the following to your .gitignore file:</p>
<pre><code class="lang-bash">blogengine/static/bower_components/
</code></pre>
<p>All done? Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add .gitignore .bowerrc bower.json
$ git commit -m &#39;Added Bower config&#39;
</code></pre>
<p>Now, let’s make our template nicer. Django’s templating system is very powerful and lets one template inherit from another. We’re going to create a base template, using HTML5 Boilerplate as a starting point, that all of our web-facing pages will use. First, create a directory to hold the base template:</p>
<pre><code class="lang-bash">$ mkdir templates/blogengine/includes
</code></pre>
<p>Then copy the <code>index.html</code> file from HTML5 Boilerplate to this directory as <code>base.html</code>:</p>
<pre><code class="lang-bash">$ cp blogengine/static/bower_components/html5-boilerplate/index.html templates/blogengine/includes/base.html
</code></pre>
<p>Now amend this file to look like this:</p>
<pre><code class="lang-django">&lt;!DOCTYPE html&gt;
&lt;!--[if lt IE 7]&gt;      &lt;html class=&quot;no-js lt-ie9 lt-ie8 lt-ie7&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 7]&gt;         &lt;html class=&quot;no-js lt-ie9 lt-ie8&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if IE 8]&gt;         &lt;html class=&quot;no-js lt-ie9&quot;&gt; &lt;![endif]--&gt;
&lt;!--[if gt IE 8]&gt;&lt;!--&gt; &lt;html class=&quot;no-js&quot;&gt; &lt;!--&lt;![endif]--&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
        &lt;title&gt;{% block title %}My Django Blog{% endblock %}&lt;/title&gt;
        &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;

        &lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;

        {% load staticfiles %}
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/normalize.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/html5-boilerplate/css/main.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap.min.css&#39; %}&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;{% static &#39;bower_components/bootstrap/dist/css/bootstrap-theme.min.css&#39; %}&quot;&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/modernizr-2.6.2.min.js&#39; %}&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;!--[if lt IE 7]&gt;
            &lt;p class=&quot;browsehappy&quot;&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href=&quot;http://browsehappy.com/&quot;&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;

        &lt;!-- Add your site or application content here --&gt;
        {% block content %}{% endblock %}

        &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;window.jQuery || document.write(&#39;&lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/vendor/jquery-1.10.2.min.js&#39; %}&quot;&gt;&lt;\/script&gt;&#39;)&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/html5-boilerplate/js/plugins.js&#39; %}&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;{% static &#39;bower_components/bootstrap/dist/js/bootstrap.min.js&#39; %}&quot;&gt;&lt;/script&gt;

        &lt;!-- Google Analytics: change UA-XXXXX-X to be your site&#39;s ID. --&gt;
        &lt;script&gt;
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src=&#39;//www.google-analytics.com/analytics.js&#39;;
            r.parentNode.insertBefore(e,r)}(window,document,&#39;script&#39;,&#39;ga&#39;));
            ga(&#39;create&#39;,&#39;UA-XXXXX-X&#39;);ga(&#39;send&#39;,&#39;pageview&#39;);
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Note the following:</p>
<ul>
<li>We need to use <code>{% load staticfiles %}</code> to be able to load any static files.</li>
<li>We use the <code>{% static %}</code> template tag to load static files such as CSS and HTML</li>
<li>We define blocks called <code>title</code> and <code>content</code>. Any template that extends this one can override whatever is inside this template.</li>
</ul>
<p>Please note that HTML5 Boilerplate may conceivable change in future, so bear in mind that all you really need to do is load the staticfiles app, use the <code>static</code> tag for any static files that need to be loaded, and define the blocks in the appropriate places.</p>
<p>Next, let’s amend our existing template to inherit from this one:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% block content %}
        {% for post in object_list %}
        &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text }}
        {% endfor %}
    {% endblock %}
</code></pre>
<p>Now fire up the server with <code>python manage.py runserver</code> and check everything is working OK. You should see that your new base template is now in use and the CSS and JS files are being loaded correctly. Let’s commit again:</p>
<pre><code class="lang-bash">$ git add templates/
$ git commit -m &#39;Now use Bootstrap and HTML5 Boilerplate for templates&#39;
</code></pre>
<p>Now, let’s use Bootstrap to style our blog a little. First we’ll add a navigation bar at the top of our blog. Edit the base template as follows:</p>
<pre><code class="lang-django">        &lt;div class=&quot;navbar navbar-static-top navbar-inverse&quot;&gt;
            &lt;div class=&quot;navbar-inner&quot;&gt;
                &lt;div class=&quot;container&quot;&gt;
                    &lt;a class=&quot;btn btn-navbar&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.nav-collapse&quot;&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
                    &lt;/a&gt;
                    &lt;a class=&quot;brand&quot; href=&quot;/&quot;&gt;My Django Blog&lt;/a&gt;
                    &lt;div class=&quot;nav-collapse collapse&quot;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container&quot;&gt;
            {% block header %}
                &lt;div class=&quot;page-header&quot;&gt;
                    &lt;h1&gt;My Django Blog&lt;/h1&gt;
                &lt;/div&gt;
            {% endblock %}

            &lt;div class=&quot;row&quot;&gt;
                {% block content %}{% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;container footer&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
                &lt;div class=&quot;span12&quot;&gt;
                    &lt;p&gt;Copyright &amp;copy; {% now &quot;Y&quot; %}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
</code></pre>
<p>Note the footer copyright section. Here we output the current year using <code>now</code>. Also note the addition of the header block. This will let us override the page header if necessary.</p>
<p>We’ll also wrap the posts in a div:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% block content %}
        {% for post in object_list %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text }}
        &lt;/div&gt;
        {% endfor %}
    {% endblock %}
</code></pre>
<p>Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add templates/
$ git commit -m &#39;Amended templates&#39;
</code></pre>
<h2 id="formatting-our-content">Formatting our content</h2>
<p>As it stands right now, we can’t do much to format our posts. It is possible to include HTML in our posts with Django, but by default it will strip it out. Also, we don’t want users to have to write HTML manually - we want to make our blog user friendly!</p>
<p>There are two possible approaches. One is to embed a rich text editor like TinyMCE in the admin and use that for editing the files, but I’ve found things like that to be cumbersome. The alternative is to use some other form of lightweight markup, and that’s the approach we’ll take here. We’re going to use Markdown for editing our posts.</p>
<p>Django has actually dropped support for Markdown, but it’s not hard to implement your own version. First, install Markdown and add it to your <code>requirements.txt</code>:</p>
<pre><code class="lang-bash">$ pip install markdown
$ pip freeze &gt; requirements.txt
</code></pre>
<p>Now, we shouldn’t write any production code before writing a test, so let’s amend our existing post test to check to see that Markdown is working as expected:</p>
<pre><code class="lang-python">class PostViewTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()

    def test_index(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>You’ll also need to add the following at the top:</p>
<pre><code class="lang-python">import markdown
</code></pre>
<p>What we do here is we convert our post text to include a link using Markdown. We also need to render that post in markdown within the test so that what we have in the test matches what will be produced - otherwise our test will be broken. We also check that the link is marked up correctly.</p>
<p>Save the file and run the tests - they should fail. Now, create the following directory and file:</p>
<pre><code class="lang-bash">$ mkdir blogengine/templatetags
$ touch blogengine/templatetags/__init__.py
</code></pre>
<p>Note that the <code>__init__.py</code> file is meant to be blank.</p>
<p>Then create the following file and edit it to look like this:</p>
<pre><code class="lang-python">import markdown

from django import template
from django.template.defaultfilters import stringfilter
from django.utils.encoding import force_unicode
from django.utils.safestring import mark_safe

register = template.Library()

@register.filter(is_safe=True)
@stringfilter
def custom_markdown(value):
    extensions = [&quot;nl2br&quot;, ]

    return mark_safe(markdown.markdown(force_unicode(value),
                                       extensions,
                                       safe_mode=True,
                                       enable_attributes=False))
</code></pre>
<p>Then just amend the post list template to use it:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% for post in object_list %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text|custom_markdown }}
        &lt;/div&gt;
        {% endfor %}
    {% endblock %}
</code></pre>
<p>It’s that easy to use a custom markup system with your blog!</p>
<p>Let’s commit the changes:</p>
<pre><code class="lang-bash">$ git add requirements.txt templates/ blogengine/
$ git commit -m &#39;Added Markdown support&#39;
</code></pre>
<h2 id="pagination">Pagination</h2>
<p>As at right now, all of our posts are displayed on the index page. We want to fix that by implementing pagination. Fortunately, that’s very easy for us because we’re using Django’s generic views. Go into <code>blogengine/urls.py</code> and amend it as follows:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView
from blogengine.models import Post

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        )),
)
</code></pre>
<p>That will automatically paginate our posts by 5 - feel free to change the value of <code>paginate_by</code> if you wish. However, we need to place the links in our template as well:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% for post in object_list %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text|custom_markdown }}
        &lt;/div&gt;
        {% endfor %}

        {% if page_obj.has_previous %}
        &lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;
        {% endif %}

    {% endblock %}
</code></pre>
<p>Try adding a few more blog posts, and you’ll see the pagination links. But give them a try, and they won’t work. Why not? Well, as it turns out there was a bug in the project-wide <code>urls.py</code> file (my bad!). Let’s fix that:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns(&#39;&#39;,
    # Examples:
    # url(r&#39;^$&#39;, &#39;django_tutorial_blog_ng.views.home&#39;, name=&#39;home&#39;),
    # url(r&#39;^blog/&#39;, include(&#39;blog.urls&#39;)),

    url(r&#39;^admin/&#39;, include(admin.site.urls)),

    # Blog URLs
    url(r&#39;&#39;, include(&#39;blogengine.urls&#39;)),
)
</code></pre>
<p>If you try again, you’ll see that the <code>blogengine</code> app now happily deals with the paginated posts. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/ django_tutorial_blog_ng/ templates/
$ git commit -m &#39;Implemented pagination&#39;
</code></pre>
<h2 id="viewing-individual-posts">Viewing individual posts</h2>
<p>As our last task for today, we’ll implement individual pages for each post. We want each post to have a nice, friendly URL that is as human-readable as possible, and also includes the date the post was created.</p>
<p>First of all, we’ll implement our test for it, however:</p>
<pre><code class="lang-python">    def test_post_page(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>Add this method to the <code>PostViewTest</code> class, after <code>test_index</code>. It’s very similar to <code>test_index</code>, since it’s testing much the same content. However, not that we fetch the post-specific URL using the method <code>get_absolute_url</code>, and we then fetch that page.</p>
<p>Now, if you run the test, it will fail because <code>get_absolute_url</code> isn’t implemented. It’s often a good idea to have a <code>get_absolute_url</code> method for your models, which defines a single URL scheme for that type of object. So let’s create one. However, to implement our URL scheme we need to make some changes. Right now we have the date, but we don’t have a text string we can use, known in Django as a <em>slug</em>. So we’ll add a slug field, which will be prepopulated based on the post title. Edit your model as follows:</p>
<pre><code class="lang-python">from django.db import models

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)

    def get_absolute_url(self):
        return &quot;/%s/%s/%s/&quot; % (self.pub_date.year, self.pub_date.month, self.slug)

    def __unicode__(self):
        return self.title

    class Meta:
        ordering = [&quot;-pub_date&quot;]
</code></pre>
<p>Here we’ve added a slug field to the model, as well as implementing our <code>get_absolute_url</code> method. Note we’ve limited the date to year and month, but you can include days if you wish.</p>
<p>While we’re in here, we’ve also implemented the <code>__unicode__</code> method. Essentially, this sets how Django describes the object in the admin - in this case, the post title is a logical way of describing that <code>Post</code> object, so it returns the post title.</p>
<p>We’ve also added the class Meta, with the ordering field. This tells Django that by default any list of posts should return them ordered by <code>pub_date</code> in reverse - in other words, latest first.</p>
<p>To have the slug filled in automatically, we need to customise the admin interface a little as well:</p>
<pre><code class="lang-python">import models
from django.contrib import admin

class PostAdmin(admin.ModelAdmin):
    prepopulated_fields = {&quot;slug&quot;: (&quot;title&quot;,)}

admin.site.register(models.Post, PostAdmin)
</code></pre>
<p>Now, I recommend at this stage going into the admin and deleting all of your posts, because otherwise you’ll have problems in migrating them. The issue is that each slug is compulsory and must be unique, and it’s not practical to use South to automatically generate new slugs from the title on the fly, so by deleting them at this stage you’ll avoid problems. Once that’s done, run this command:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
</code></pre>
<p>You’ll be prompted to specify a one-off default value - enter any string you like, such as “blah”. Then run the migration:</p>
<pre><code class="lang-bash">$ python manage.py migrate
</code></pre>
<p>Let’s run our tests now:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.F.F...F
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 103, in test_create_post
    self.assertTrue(&#39;added successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 132, in test_edit_post
    self.assertTrue(&#39;changed successfully&#39; in response.content)
AssertionError: False is not true

======================================================================
FAIL: test_post_page (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 222, in test_post_page
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

----------------------------------------------------------------------
Ran 8 tests in 2.180s

FAILED (failures=3)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Whoops! Our tests are broken, because the slug field isn’t being filled in. If you take a look at the page for adding a post, you’ll notice that the slug is filled in using JavaScript, so our test fails because the test client doesn’t interpret JavaScript. So in the tests we have to fill in the slug field manually.</p>
<p>Also, for the unit tests, the slug attribute isn’t being created at all, so it can’t be saved. Let’s remedy that. First, edit the <code>test_create_post</code> method of <code>PostTest</code>:</p>
<pre><code class="lang-python">class PostTest(TestCase):
    def test_create_post(self):
        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.slug, &#39;my-first-post&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
</code></pre>
<p>Next, let’s amend <code>AdminTest</code>:</p>
<pre><code class="lang-python">class AdminTest(LiveServerTestCase):
    fixtures = [&#39;users.json&#39;]

    def setUp(self):
        self.client = Client()

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-first-post&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

    def test_edit_post(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;,
            &#39;slug&#39;: &#39;my-second-post&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)

    def test_delete_post(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)
</code></pre>
<p>And <code>PostViewTest</code>:</p>
<pre><code class="lang-python">class PostViewTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()

    def test_index(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)

    def test_post_page(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is [my first blog post](http://127.0.0.1:8000/)&#39;
        post.slug = &#39;my-first-post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Get the post URL
        post_url = only_post.get_absolute_url()

        # Fetch the post
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(markdown.markdown(post.text) in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)

        # Check the link is marked up properly
        self.assertTrue(&#39;&lt;a href=&quot;http://127.0.0.1:8000/&quot;&gt;my first blog post&lt;/a&gt;&#39; in response.content)
</code></pre>
<p>What we’re doing here is that every time we create a Post object programmatically, we add the <code>post.slug</code> atttribute to it. Also, when submitting a post via the admin, we pass the <code>slug</code> parameter via HTTP POST, thus emulating how a form would submit this data.</p>
<p>If you run the tests again, you’ll see that <code>test_post_page</code> still fails. This is because we haven’t yet up the URLs, templates and views to do so. Let’s fix that. We’ll use another generic view, called a DetailView, to display the posts. Amend <code>blogengine/urls.py</code> as follows:</p>
<pre><code class="lang-python">rom django.conf.urls import patterns, url
from django.views.generic import ListView, DetailView
from blogengine.models import Post

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(r&#39;^(?P&lt;page&gt;\d+)?/?$&#39;, ListView.as_view(
        model=Post,
        paginate_by=5,
        )),

    # Individual posts
    url(r&#39;^(?P&lt;pub_date__year&gt;\d{4})/(?P&lt;pub_date__month&gt;\d{1,2})/(?P&lt;slug&gt;[a-zA-Z0-9-]+)/?$&#39;, DetailView.as_view(
        model=Post,
        )),
)
</code></pre>
<p>Running our tests again will still fail, but now because the template <code>post_detail.html</code> has not been found. So let’s create it:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;{{ object.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ object.pub_date }}&lt;/h3&gt;
        {{ object.text|custom_markdown }}
        &lt;/div&gt;

{% endblock %}
</code></pre>
<p>If you run your tests again, they should now pass. However, we still need to provide a hyperlink from each post in the index to the post page, so let’s do that:</p>
<pre><code class="lang-django">{% extends &quot;blogengine/includes/base.html&quot; %}

    {% load custom_markdown %}

    {% block content %}
        {% for post in object_list %}
        &lt;div class=&quot;post&quot;&gt;
        &lt;h1&gt;&lt;a href=&quot;{{ post.get_absolute_url }}&quot;&gt;{{ post.title }}&lt;/a&gt;&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text|custom_markdown }}
        &lt;/div&gt;
        {% endfor %}

        {% if page_obj.has_previous %}
        &lt;a href=&quot;/{{ page_obj.previous_page_number }}/&quot;&gt;Previous Page&lt;/a&gt;
        {% endif %}
        {% if page_obj.has_next %}
        &lt;a href=&quot;/{{ page_obj.next_page_number }}/&quot;&gt;Next Page&lt;/a&gt;
        {% endif %}

    {% endblock %}
</code></pre>
<p>And that’s all for today! We now have individual post pages, we’ve styled our blog a bit, and we’ve implemented Markdown support. All that remains is to commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/ templates/
$ git commit -m &#39;Implemented post pages&#39;
</code></pre>
<p>As before, I’ve tagged the final commit with ‘lesson-2’, so if you’re following along, you can switch to this point with <code>git checkout lesson-2</code>.</p>
<p>Next time we’ll add support for flat pages and multiple authors, as well as adding support for comments via a third-party commenting system.</p>
]]></description>
        </item>
        <item>
            <title><![CDATA[Django blog tutorial - the next generation - part 1]]></title>
            <link>https://matthewdaly.co.uk/blog/2013/12/28/django-blog-tutorial-the-next-generation-part-1/</link>
            <guid>https://matthewdaly.co.uk/blog/2013/12/28/django-blog-tutorial-the-next-generation-part-1/</guid>
            <pubDate>Sat, 28 Dec 2013 15:00:32 GMT</pubDate>
            <description><![CDATA[<p>My series of Django tutorials for building a blogging engine are by far the most popular posts I’ve ever written on here. I’ve had a lot of people contact me with questions or just to express their thanks, for which I’m very grateful!</p>
<p>However, these tutorials haven’t really aged well. I’ve since had the opportunity to use Django in a professional capacity, which has significantly improved my understanding of the framework and the whole Python ecosystem, and there’s a lot of best practices that I didn’t follow and now wish I had. There’s also been a few gotchas that have hindered a few people in the past that I’d like to have the opportunity to correct.</p>
<p>So, I’m therefore creating a brand new series of tutorials to remedy this situation. This series will cover exactly the same basic idea of using Django to build a blogging engine, but will expand on what the original series did in many ways. We will cover such additional topics as:</p>
<ul>
<li>Using Twitter Bootstrap to make your blog look good without too much hassle</li>
<li>Using Virtualenv to sandbox your blog application</li>
<li>Using South to effectively manage changes to your database structure</li>
<li>Writing some simple unit tests</li>
<li>Deploying the finished application to Heroku</li>
</ul>
<p>Ready? Let’s get started!</p>
<h2 id="getting-everything-set-up">Getting everything set up</h2>
<p>Now, first of all, I’m going to assume you’re using some variant of Unix, such as Linux or Mac OS X. I’m not saying you can’t follow this tutorial with Windows, but you’ll have a harder time, because Windows just isn’t as developer-friendly as Unix in general. A modern Linux distro like Ubuntu is generally pretty easy to use, and you can easily run it in Virtualbox, so if you use Windows I would recommend you use that to make things easier.</p>
<p>You should also have at least a basic grasp of the command line, such as how to create and navigate directories. You don’t have to be a wizard with it, though.</p>
<p>You also need a proper programmer’s text editor. I use Vim, but I freely admit that Vim has a very steep learning curve and you may have trouble picking it up at the same time as following this tutorial. Emacs is also a very powerful text editor, and if you like it, feel free to use it. If you haven’t yet found a programmer’s text editor you like, I suggest you check out <a href="http://www.sublimetext.com/">Sublime Text</a>, which is easy to get started with, but also very powerful, and can be used without purchasing a license. Don’t worry too much about your text editor - it’s not vitally import that you use what I use, just find one that works for you. That said, I will say one thing - DON’T use an IDE. IDE’s hide too many details from new users and make it harder to figure out what’s going on.</p>
<p>You will also need to ensure you have the following installed:</p>
<ul>
<li>Python. I recommend installing Python 2.7, because you may have issues with Python 2.6, and Python 3 isn’t universally supported yet so you might have some issues with that</li>
<li>Virtualenv</li>
<li>Pip</li>
<li>Git</li>
</ul>
<p>On most Linux distros, you can find packages for all of these items easily enough using your package manager. On Mac OS X, I recommend using Homebrew to install them, though if you have another package manager installed you can use that too. If you have issues with installing any of these, a quick Google search should be sufficient to resolve the issue.</p>
<h2 id="beginning-work">Beginning work</h2>
<p>With all that done, we’re ready to get started. Create a folder in a suitable place on your file system and switch into it. I generally keep a dedicated folder in my home directory called <code>Projects</code> to use for all of my projects, and give each project a folder within it - in this case the project is called <code>django_tutorial_blog_ng</code>.</p>
<p>Now, we’ll use Git to keep track of our source code. If you prefer Mercurial, feel free to use that, but this tutorial will assume use of Git, so you’ll want to adapt the commands used accordingly. Start tracking your project with the following command from the shell, when you’re in the project directory:</p>
<pre><code class="lang-bash">$ git init
</code></pre>
<p>If you haven’t used Git before, you’ll also want to <a href="http://git-scm.com/book/en/Getting-Started-First-Time-Git-Setup">configure it</a>.</p>
<p>Next, we set up our virtualenv. Run the following command:</p>
<pre><code class="lang-bash">$ virtualenv venv --distribute
</code></pre>
<p>Followed by:</p>
<pre><code class="lang-bash">$ source venv/bin/activate
</code></pre>
<p>Every time you come back to work on this project, you’ll need to run the previous command to make sure you’re running the version of Python installed under venv/ rather than your system Python. You can tell it’s using this because your shell prompt will be prefixed with <code>(venv)</code>.</p>
<p>Why do this? Well, it means you can install whatever version of a Python module you like, without having root access, and means the Python install you’re using will only have those modules you explicitly install, rather than all of those ones available with your operating system. For instance, you could have multiple projects using different versions of Django, rather than having to update a global installation of Django and potentially break existing applications.</p>
<p>Now that our virtualenv is set up, we’ll install Django, as well as several other useful Python modules. Run the following command:</p>
<pre><code class="lang-bash">$ pip install django-toolbelt South
</code></pre>
<p>A little explanation is called for here. The package <code>django-toolbelt</code> includes a number of packages we’ll be using, including Django, as well as Gunicorn (a simple web server we’ll use when the time comes to deploy the app to Heroku). South is a migration tool that is commonly used with Django - basically, if you make changes to existing models, Django doesn’t natively have the capacity to apply those changes (yet - native migrations are planned at some point in the future), so South can be used to apply those changes for you without having to either manually change the database structure or dump the database and rebuild it.</p>
<p>Please note that one of the packages, <code>psycopg2</code>, may fail if you don’t have PostgreSQL installed, but don’t worry about installing it. We’ll be using SQLite for developing the application locally, and we’ll be deploying the finished product to Heroku, which does have it installed.</p>
<p>Once the installation is complete, run the following command to record the new modules installed:</p>
<pre><code class="lang-bash">$ pip freeze &gt; requirements.txt
</code></pre>
<p>The file <code>requirements.txt</code> will be created, which stores the packages and versions you have installed so that they can be easily recreated. If you had issues installing <code>psycopg2</code>, then here’s what your <code>requirements.txt</code> should look like - feel free to edit it manually to look like this, as when we deploy it to Heroku, it will need to be correct to ensure that our application can be deployed successfully:</p>
<pre><code class="lang-bash">Django==1.6.1
South==0.8.4
dj-database-url==0.2.2
dj-static==0.0.5
django-toolbelt==0.0.1
gunicorn==18.0
psycopg2==2.5.1
static==0.4
wsgiref==0.1.2
</code></pre>
<p>Next, we’ll commit these changes with Git:</p>
<pre><code class="lang-bash">$ git add requirements.txt
$ git commit -m &#39;Committed requirements&#39;
</code></pre>
<p>Next we’ll add a <code>.gitignore</code> file to ignore our virtualenv - we want to keep this out of version control because it’s something specific to that install. We have all we need to recreate it so we don’t want to store it. In addition, we also want to ignore any compiled Python files (identifiable by the .pyc suffix):</p>
<pre><code class="lang-bash">venv/
*.pyc
</code></pre>
<p>Let’s commit that too:</p>
<pre><code class="lang-bash">$ git add .gitignore
$ git commit -m &#39;Added a gitignore file&#39;
</code></pre>
<p>Now, let’s generate our project’s basic skeleton:</p>
<pre><code class="lang-bash">$ django-admin.py startproject django_tutorial_blog_ng .
</code></pre>
<p>This application skeleton includes a basic configuration which will be sufficient for now, but you will also want to add the SQLite database file to your <code>.gitignore</code>:</p>
<pre><code class="lang-bash">env/
*.pyc
db.sqlite3
</code></pre>
<p>Let’s commit what we’ve done:</p>
<pre><code class="lang-bash">$ git add .gitignore django_tutorial_blog_ng/ manage.py
$ git commit -m &#39;Created project skeleton&#39;
</code></pre>
<p>Now, before we create our database, we need to ensure we are using South. Go into <code>django_tutorial_blog_ng/settings.py</code> and find <code>INSTALLED_APPS</code>. Edit it to look like this:</p>
<pre><code class="lang-python">INSTALLED_APPS = (
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;south&#39;,
)
</code></pre>
<p>Now, you can create your database. Run the following command:</p>
<pre><code class="lang-bash">$ python manage.py syncdb
</code></pre>
<p>You’ll be prompted to create a superuser - go ahead and fill in the details. Now, run the following command:</p>
<pre><code class="lang-bash">$ python manage.py runserver
</code></pre>
<p>This will run Django’s built-in web server on port 8000, and if you click <a href="http://127.0.0.1:8000">here</a>, you should see a page congratulating you on your first Django-powered page. Once you’re finished with it, you can stop the web server with <kbd>Ctrl-C</kbd>.</p>
<p>Don’t forget to commit your changes:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/settings.py
$ git commit -m &#39;Added South to installed apps&#39;
</code></pre>
<h2 id="your-first-app">Your first app</h2>
<p>Django distinguishes between the concepts of <strong>projects</strong> and <strong>apps</strong>. A project is a specific project that may consist of one or more apps, such as a web app, whereas an app is a set of functionality within a project. For instance, one website might include some flat pages, an admin interface, and a blogging engine, and these could easily be different apps. By encouraging you to separate different types of functionality into different apps, Django makes it easier for you to reuse existing content elsewhere.</p>
<p>We’re going to create our first app, which is the blogging engine. Run the following command to create a basic skeleton for this app:</p>
<pre><code class="lang-bash">$ python manage.py startapp blogengine
</code></pre>
<p>Next, we need to amend our settings to install this app:</p>
<pre><code class="lang-python">INSTALLED_APPS = (
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;south&#39;,
    &#39;blogengine&#39;,
)
</code></pre>
<p>Now, before we can use this app, we want to let South know about it so that changes to your database structure will be managed right from the start by South. Run the following command to create your initial migration:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --initial blogengine
</code></pre>
<p>That creates the file for your first migration,but doesn’t run it. To migrate your database structure to the latest version, run the following:</p>
<pre><code class="lang-bash">$ python manage.py migrate
</code></pre>
<p>This won’t actually make any changes, but it will ensure that all future changes to your models for the <code>blogengine</code> app are handled by South. Let’s commit our app skeleton:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/settings.py blogengine/
$ git commit -m &#39;Added blogengine app skeleton&#39;
</code></pre>
<p>So, we now have our first app set up, but it doesn’t do anything much.</p>
<p>Remember that I mentioned how Django differentiates between projects and apps? Well, Django actually ships with a number of useful apps, and one of those is the admin interface. I consider the Django admin to be one of the framework’s killer features because it’s easy to use and customise, and saves you a lot of grief.</p>
<p>In the past, the admin interface needed a little work to get it working, but in Django 1.6 it’s configured to work out of the box, so if you click <a href="http://127.0.0.1:8000/admin/">here</a>, you should see the login screen for it. You should be able to sign in using the username and password you set when you ran <code>syncdb</code>.</p>
<p>Next, we’ll set up our first model.</p>
<h2 id="an-introduction-to-mvc">An introduction to MVC</h2>
<p>MVC is a common pattern used in web development. Many web development frameworks can be loosely described as MVC, including Django, Rails, CodeIgniter, Laravel and Symfony, as well as some client-side frameworks like Backbone.js. The basic concept is that a web app is divided into three basic components:</p>
<ul>
<li><strong>Models</strong> - the data managed with the application</li>
<li><strong>Views</strong> - the presentation of the data</li>
<li><strong>Controllers</strong> - an intermediary between the models and the views</li>
</ul>
<p>Now, Django’s interpretation of MVC is slightly different to many other frameworks. While in most frameworks the views are HTML templates for rendering the data, in Django this role is taken by the templates, and the views are functions or objects that render data from the models using a template. Effectively, you can think of Django’s views as being like controllers in other frameworks, and Django templates as being views.</p>
<p>In Django, you create your models as Python classes that represent your data, and you use the Django ORM to query the database. As a result, it’s rare to have to directly query your database using SQL, making it more portable between different databases.</p>
<p>Now, our first model is going to be of a blog post. At least initially, each post will have the following attributes:</p>
<ul>
<li>A title</li>
<li>A publication date and time</li>
<li>Some text</li>
</ul>
<p>Now, we could just jump straight into creating our first model, but we’re going to make a point of following the practices of test-driven development here. The basic concept of TDD is that you write a failing test before writing any code, then you write the code to pass that test afterwards. It does make things a bit slower, but it’s all too easy to neglect writing tests at all if you leave it till later.</p>
<p>If you take a look in the <code>blogengine</code> folder you’ll notice there’s a file called <code>tests.py</code>. Open it up and you should see the following:</p>
<pre><code class="lang-python">from django.test import TestCase

# Create your tests here.
</code></pre>
<p>It’s worth taking a little time to plan out what we want to test from our post model. Each post object will have the attributes I mentioned above, and what we want to be able to do is test that we can:</p>
<ul>
<li>Set the title</li>
<li>Set the publication date and time</li>
<li>Set the text</li>
<li>Save it successfully</li>
<li>Retrieve it successfully</li>
</ul>
<p>So, let’s create a test for our post model. We’ll go through the relevant sections of the test bit by bit:</p>
<pre><code class="lang-python">from django.test import TestCase
from django.utils import timezone
from blogengine.models import Post

</code></pre>
<p>Here we’re importing the required functionality. <code>TestCase</code> is provided by Django, and is an object all of your tests should inherit from. <code>timezone</code> is a utility for handling dates and times correctly. Finally, <code>Post</code> is our model, which we have yet to implement.</p>
<pre><code class="lang-python"># Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the post
        post = Post()
</code></pre>
<p>Here we create the PostTest class, which represents a test for your <code>Post</code> model. So far it only has one method, but you can add additional ones if required.</p>
<pre><code class="lang-python">
        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.pub_date = timezone.now()
</code></pre>
<p>Here we set the post’s attributes.</p>
<pre><code class="lang-python">
        # Save it
        post.save()
</code></pre>
<p>Now we save it. At this point it has been added to the database, and the rest of the test involves us ensuring it has been saved correctly and can be retrieved.</p>
<pre><code class="lang-python">
        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)
</code></pre>
<p>Here we use the Django database API to fetch all of the Post objects, assert that there is only 1 post object, retrieve that post object, and assert that it is the same object as the post object we just saved.</p>
<p>If unit testing is new to you, assertions may be new to you. Essentially you’re saying to the Python interpreter, “I assert that X is true, so please raise an error if this is not true”. Here we assert that the length of the variable <code>all_posts</code> is 1, and that that post is the same object as the previously saved object, so that the test will fail if that is not the case.</p>
<pre><code class="lang-python">
        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
</code></pre>
<p>Finally, we assert that the values of each of the post’s attributes as stored in the database match up with those in the post object we set. For the <code>title</code> and <code>text</code> fields, these are easy to validate as we can just check the values against those we set. For the <code>pub_date</code> field, things are a bit more complex, since this will be an object in its own right, so you need to check the day, month, year, hour, minute and second attributes separately.</p>
<p>The whole thing should look like this:</p>
<pre><code class="lang-python">from django.test import TestCase
from django.utils import timezone
from blogengine.models import Post

# Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.pub_date = timezone.now()

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
</code></pre>
<p>With that in place, the time has come to run our test with the following command:</p>
<pre><code class="lang-bash">$ python manage.py test
</code></pre>
<p>You should see something like this:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: blogengine.tests (unittest.loader.ModuleImportFailure)
----------------------------------------------------------------------
ImportError: Failed to import test module: blogengine.tests
Traceback (most recent call last):
  File &quot;/usr/local/Cellar/python/2.7.6/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 254, in _find_tests
    module = self._get_module_from_name(name)
  File &quot;/usr/local/Cellar/python/2.7.6/Frameworks/Python.framework/Versions/2.7/lib/python2.7/unittest/loader.py&quot;, line 232, in _get_module_from_name
    __import__(name)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 3, in &lt;module&gt;
    from blogengine.models import Post
ImportError: cannot import name Post


----------------------------------------------------------------------
Ran 1 test in 0.000s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Don’t worry about the error - this is exactly what we expect to see because we haven’t implemented our Post model yet. Now that we have a failing test in place, we can implement our model to make the test pass. Open up <code>blogengine/models.py</code> and enter the following:</p>
<pre><code class="lang-python">from django.db import models

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
</code></pre>
<p>Save the file and run the test again:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
E
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 17, in test_create_post
    post.save()
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 545, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 573, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 654, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 687, in _do_insert
    using=using, raw=raw)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 232, in _insert
    return insert_query(self.model, objs, fields, **kwargs)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1511, in insert_query
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 898, in execute_sql
    cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/util.py&quot;, line 53, in execute
    return self.cursor.execute(sql, params)
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py&quot;, line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: blogengine_post

----------------------------------------------------------------------
Ran 1 test in 0.059s

FAILED (errors=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Our test still fails, but if we take a look at this error message, we can see why - there is no database table for the posts (called <code>blogengine_post</code>). Using South, we can easily remedy that by creating a new migration to create this table:</p>
<pre><code class="lang-bash">$ python manage.py schemamigration --auto blogengine
</code></pre>
<p>That creates the new migration. Now let’s run it:</p>
<pre><code class="lang-bash">$ python manage.py migrate
</code></pre>
<p>Now, let’s run our tests to check it’s working as expected:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database for alias &#39;default&#39;...
.
----------------------------------------------------------------------
Ran 1 test in 0.001s

OK
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>Success! We now have a model in place that passes our test. Let’s commit our changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Added post model with passing test&#39;
</code></pre>
<p>Now, Django’s ORM is basically a layer on top of SQL that abstracts away differences between different relational databases, but the underlying queries are still being run. You can view the SQL created to generate the table by using the <code>sqlall</code> command. Just run <code>python manage.py sqlall blogengine</code> and you should see something like this:</p>
<pre><code class="lang-sql">BEGIN;
CREATE TABLE &quot;blogengine_post&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;title&quot; varchar(200) NOT NULL,
    &quot;pub_date&quot; datetime NOT NULL,
    &quot;text&quot; text NOT NULL
)
;

COMMIT;
</code></pre>
<p>Note the addition of the <code>id</code> field as the primary key. If you’re at all familiar with relational databases, you’ll know that every table must have one field, called a primary key, that is a unique reference to that row. This can be overridden, but here it’s exactly the behaviour we want.</p>
<h2 id="creating-blog-posts-via-the-admin">Creating blog posts via the admin</h2>
<p>Now, we need a way to be able to create, edit and delete blog posts. Django’s admin interface allows us to do so easily. However, before we do so, we want to create automated acceptance tests for this functionality, in order to test the ability to create posts from an end-user’s perspective. While unit tests are for testing sections of an application’s functionality from the perspective of other sections of the application, acceptance tests are testing from the user’s perspective. In other words, they test what the application needs to do to be acceptable.</p>
<p>First, we will test logging into the admin. Open up <code>blogengine/tests.py</code> and amend it as follows:</p>
<pre><code class="lang-python">from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post

# Create your tests here.
class PostTest(TestCase):
    def test_create_post(self):
        # Create the post
        post = Post()

        # Set the attributes
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.pub_date = timezone.now()

        # Save it
        post.save()

        # Check we can find it
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post, post)

        # Check attributes
        self.assertEquals(only_post.title, &#39;My first post&#39;)
        self.assertEquals(only_post.text, &#39;This is my first blog post&#39;)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)

class AdminTest(LiveServerTestCase):
    def test_login(self):
        # Create client
        c = Client()

        # Get login page
        response = c.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)
</code></pre>
<p>First of all, we import two new objects from <code>django.test</code>, <code>LiveServerTestCase</code> and <code>Client</code>. Then we create the first part of our first test for the admin, named <code>AdminTest</code>. Eventually, this will test that we can log successfully into the admin interface. For now, we’re just doing the following:</p>
<ul>
<li>Creating a Client object</li>
<li>Fetching the <code>/admin/</code> route</li>
<li>Asserting that the status code for this HTTP request is 200, (in other words, that the page was fetched successfully).</li>
</ul>
<p>If you run <code>python manage.py test</code>, you should see that both tests pass successfully. Now we’ll extend <code>AdminTest</code> - we’ll verify that the response contains the string ‘Log in’, which in the Django admin interface, appears on the login page:</p>
<pre><code class="lang-python">class AdminTest(LiveServerTestCase):
    def test_login(self):
        # Create client
        c = Client()

        # Get login page
        response = c.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)
</code></pre>
<p>Here <code>response.content</code> is a string containing the content of the HTTP response - we’re asserting that the substring ‘Log in’ appears in there. If you run <code>python manage.py test</code> again, it should pass.</p>
<p>Now, we need to actually log in. This could be fiddly, but Django has a handy convenience method to log you in when testing:</p>
<pre><code class="lang-python">class AdminTest(LiveServerTestCase):
    def test_login(self):
        # Create client
        c = Client()

        # Get login page
        response = c.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        c.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = c.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)
</code></pre>
<p>Here, we use the <code>login</code> method of the <code>Client</code> object to log into the admin interface, and then we fetch the <code>/admin/</code> route again. We assert that we get a 200 status code, and we assert that the response contains the string ‘Log out’ - in other words, that we are logged in.</p>
<p>Try running <code>python manage.py test</code> and we’ll get an error., because the user details we’ve used to log in don’t exist. Let’s resolve that.</p>
<p>Now, you could put your own credentials in there, but that’s not a good idea because it’s a security risk. Instead, we’ll create a fixture for the test user that will be loaded when the tests are run. Run the following command:</p>
<pre><code class="lang-bash">$ python manage.py createsuperuser
</code></pre>
<p>Give the username as <code>bobsmith</code>, the email address as <a href="mailto:`bob@example.com">`bob@example.com</a><code>, and the password as</code>password`. Once that’s done, run these commands to dump the existing users to a fixture:</p>
<pre><code class="lang-bash">$ mkdir blogengine/fixtures
$ python manage.py dumpdata auth.User --indent=2 &gt; blogengine/fixtures/users.json
</code></pre>
<p>This will dump all of the existing users to <code>blogengine/fixtures/users.json</code>. You may wish to edit this file to remove your own superuser account and leave only the newly created one in there.</p>
<p>Next we need to amend our test to load this fixture:</p>
<pre><code class="lang-python">class AdminTest(LiveServerTestCase):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Create client
        c = Client()

        # Get login page
        response = c.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        c.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = c.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)
</code></pre>
<p>Now, if you run <code>python manage.py test</code>, you should find that the test passes. Next, we’ll test that we can log out:</p>
<pre><code class="lang-python">class AdminTest(LiveServerTestCase):
    fixtures = [&#39;users.json&#39;]

    def test_login(self):
        # Create client
        c = Client()

        # Get login page
        response = c.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        c.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = c.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Create client
        c = Client()

        # Log in
        c.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = c.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        c.logout()

        # Check response code
        response = c.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)
</code></pre>
<p>This test works along very similar lines. We log in, verify that ‘Log out’ is in the response, then we log out, and verify that ‘Log in’ is in the response. Run the tests again, and they should pass. Assuming they do, let’s commit our changes again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Added tests for admin auth&#39;
</code></pre>
<p>This code is a little repetitive. We create the client twice, when we could do so only once. Amend the AdminTest class as follows:</p>
<pre><code class="lang-python">class AdminTest(LiveServerTestCase):
    fixtures = [&#39;users.json&#39;]

    def setUp(self):
        self.client = Client()

    def test_login(self):
        # Get login page
        response = self.client.get(&#39;/admin/&#39;)

        # Check response code
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

        # Log the user in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

    def test_logout(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log out&#39; in response
        self.assertTrue(&#39;Log out&#39; in response.content)

        # Log out
        self.client.logout()

        # Check response code
        response = self.client.get(&#39;/admin/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check &#39;Log in&#39; in response
        self.assertTrue(&#39;Log in&#39; in response.content)

</code></pre>
<p>The <code>setUp()</code> method is automatically run when the test runs, and ensures we only need to start up the client once. Run your tests to make sure they pass, then commit your changes:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Refactored admin test&#39;
</code></pre>
<p>Now, we’ll implement a test for creating a new post. The admin interface implements URLs for creating new instances of a model in a consistent format of <code>/admin/app_name/model_name/add/</code>, so the URL for adding a new post will be <code>/admin/blogengine/post/add/</code>.</p>
<p>Add this method to the AdminTest class:</p>
<pre><code class="lang-python">    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)
</code></pre>
<p>Try running it and this will fail, because we haven’t registered the Post model in the Django admin. So we need to do that. To do so, open a new file at <code>blogengine/admin.py</code> and add the following code:</p>
<pre><code class="lang-python">import models
from django.contrib import admin

admin.site.register(models.Post)
</code></pre>
<p>Now, run <code>python manage.py test</code> and the test should pass. If you want to confirm that the post model appears in the admin, run <code>python manage.py runserver</code> and click <a href="http://127.0.0.1:8000/admin/">here</a>.</p>
<p>So now we can reach the page for adding a post, but we haven’t yet tested that we can submit one. Let’s remedy that:</p>
<pre><code class="lang-python">    def test_create_post(self):
        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Check response code
        response = self.client.get(&#39;/admin/blogengine/post/add/&#39;)
        self.assertEquals(response.status_code, 200)

        # Create the new post
        response = self.client.post(&#39;/admin/blogengine/post/add/&#39;, {
            &#39;title&#39;: &#39;My first post&#39;,
            &#39;text&#39;: &#39;This is my first post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check added successfully
        self.assertTrue(&#39;added successfully&#39; in response.content)

        # Check new post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
</code></pre>
<p>Here we submit the new post via HTTP POST, with all the data passed through. This mirrors the form created by the Django admin interface - if you take a look at the HTML generated by the admin, you’ll see that the inputs are given names that match these. Note that the <code>pub_date</code> field, because it represents a datetime object, is split up into a separate date and time field. Also note the parameter <code>follow=True</code> - this denotes that the test client should follow any HTTP redirect.</p>
<p>We confirm that the POST request responded with a 200 code, denoting success. We also confirm that the response included the phrase ‘added successfully’. Finally we confirm that there is now a single Post object in the database. Don’t worry about any existing content - Django creates a dedicated test database and destroys it after the tests are done, so you can be sure that no posts are present unless you explicitly load them from a fixture.</p>
<p>We can now test creating a post, but we also need to ensure we can test editing and deleting them. First we’ll add a test for editing posts:</p>
<pre><code class="lang-python">    def test_edit_post(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Edit the post
        response = self.client.post(&#39;/admin/blogengine/post/1/&#39;, {
            &#39;title&#39;: &#39;My second post&#39;,
            &#39;text&#39;: &#39;This is my second blog post&#39;,
            &#39;pub_date_0&#39;: &#39;2013-12-28&#39;,
            &#39;pub_date_1&#39;: &#39;22:00:04&#39;
        },
        follow=True
        )
        self.assertEquals(response.status_code, 200)

        # Check changed successfully
        self.assertTrue(&#39;changed successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)
        only_post = all_posts[0]
        self.assertEquals(only_post.title, &#39;My second post&#39;)
        self.assertEquals(only_post.text, &#39;This is my second blog post&#39;)
</code></pre>
<p>Here we create a new blog post, then verify we can edit it by resubmitting it with different values, and checking that we get the expected response, and that the data in the database has been updated. Run <code>python manage.py test</code>, and this should pass.</p>
<p>Finally, we’ll set up a test for deleting posts:</p>
<pre><code class="lang-python">    def test_delete_post(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Log in
        self.client.login(username=&#39;bobsmith&#39;, password=&quot;password&quot;)

        # Delete the post
        response = self.client.post(&#39;/admin/blogengine/post/1/delete/&#39;, {
            &#39;post&#39;: &#39;yes&#39;
        }, follow=True)
        self.assertEquals(response.status_code, 200)

        # Check deleted successfully
        self.assertTrue(&#39;deleted successfully&#39; in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 0)
</code></pre>
<p>Again, this is pretty similar to what we did before. We create a new post, verify that it is the sole post in the database, and log into the admin. Then we delete the post via the admin, and confirm that the admin interface confirmed it has been deleted, and the post is gone from the database.</p>
<p>I think it’s now time to commit again:</p>
<pre><code class="lang-bash">$ git add blogengine/
$ git commit -m &#39;Post admin tests in place&#39;
</code></pre>
<p>So we now know that we can create, edit and delete posts, and we have tests in place to confirm this. So our next task is to be able to display our posts.</p>
<p>For now, to keep things simple, we’re only going to implement the index view - in other words, all the posts in reverse chronological order. We’ll use Django’s generic views to keep things really easy.</p>
<p>Django’s generic views are another really handy feature. As mentioned earlier, a view is a function or class that describes how a specific route should render an object. Now, there are many tasks that recur in web development. For instance, many web pages you may have seen may be a list of objects - in this case, the index page for a blog is a list of blog posts. For that reason, Django has the ListView generic view, which makes it easy to render a list of objects.</p>
<p>Now, like before, we want to have a test in place. Open up <code>blogengine/tests.py</code> and add the following class at the end of the file:</p>
<pre><code class="lang-python">class PostViewTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()

    def test_index(self):
        # Create the post
        post = Post()
        post.title = &#39;My first post&#39;
        post.text = &#39;This is my first blog post&#39;
        post.pub_date = timezone.now()
        post.save()

        # Check new post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), 1)

        # Fetch the index
        response = self.client.get(&#39;/&#39;)
        self.assertEquals(response.status_code, 200)

        # Check the post title is in the response
        self.assertTrue(post.title in response.content)

        # Check the post text is in the response
        self.assertTrue(post.text in response.content)

        # Check the post date is in the response
        self.assertTrue(str(post.pub_date.year) in response.content)
        self.assertTrue(post.pub_date.strftime(&#39;%b&#39;) in response.content)
        self.assertTrue(str(post.pub_date.day) in response.content)
</code></pre>
<p>Here we create the post, and assert that it is the sole post object. We then fetch the index page, and assert that the HTTP status code is 200 (ie. the page exists and is returned). We then verify that the response contains the post title, text and publication date.</p>
<p>Note that for the month, we need to do a bit of jiggery-pokery to get the month name. By default Django will return short month names (eg Jan, Feb etc), but Python stores months as numbers, so we need to format it as a short month name using <code>%b</code>.</p>
<p>If you run this, you will get an error because the index route isn’t implemented. So let’s fix that. Open up the existing <code>django_tutorial_blog_ng/urls.py</code> file and amend it to look like this:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns(&#39;&#39;,
    # Examples:
    # url(r&#39;^$&#39;, &#39;django_tutorial_blog_ng.views.home&#39;, name=&#39;home&#39;),
    # url(r&#39;^blog/&#39;, include(&#39;blog.urls&#39;)),

    url(r&#39;^admin/&#39;, include(admin.site.urls)),

    # Blog URLs
    url(r&#39;^.*$&#39;, include(&#39;blogengine.urls&#39;)),
)
</code></pre>
<p>Then, create a new file at <code>blogengine/urls.py</code> and edit it as follows:</p>
<pre><code class="lang-python">from django.conf.urls import patterns, url
from django.views.generic import ListView
from blogengine.models import Post

urlpatterns = patterns(&#39;&#39;,
    # Index
    url(&#39;^$&#39;, ListView.as_view(
        model=Post,
        )),
)
</code></pre>
<p>A little explanation is called for. The project has its own <code>urls.py</code> file that handles routing throughout the project. However, because Django encourages you to make your apps reusable, we want to keep the routes in the individual apps as far as possible. So, in the project file, we include the <code>blogengine/urls.py</code> file.</p>
<p>In the app-specific <code>urls.py</code>, we import the Post model and the ListView generic view. We then define a route for the index page - the regular expression <code>^$</code> will match only an empty string, so that page will be the index. For this route, we then call the <code>as_view()</code> method of the ListView object, and set the model as Post.</p>
<p>Now, if you either run the tests, or run the development server and visit <a href="http://127.0.0.1:8000">the index page</a>, you’ll see that it isn’t working yet - you should see the error <code>TemplateDoesNotExist: blogengine/post_list.html</code>. This tells us that we need to create a template called <code>blogengine/post_list.html</code>, so let’s do that. First of all, add the following at the end of <code>django_tutorial_blog_ng/settings.py</code>:</p>
<pre><code class="lang-python">
# Template directory
TEMPLATE_DIRS = [os.path.join(BASE_DIR, &#39;templates&#39;)]
</code></pre>
<p>Next, create the folders for the templates, and a blank <code>post_list.html</code> file:</p>
<pre><code class="lang-bash">$ mkdir templates
$ mkdir templates/blogengine
$ touch templates/blogengine/post_list.html
</code></pre>
<p>Now, run your tests again, and you’ll see that the template now exists, but a new error is showing up:</p>
<pre><code class="lang-bash">Creating test database for alias &#39;default&#39;...
......F
======================================================================
FAIL: test_index (blogengine.tests.PostViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py&quot;, line 189, in test_index
    self.assertTrue(post.title in response.content)
AssertionError: False is not true

----------------------------------------------------------------------
Ran 7 tests in 2.162s

FAILED (failures=1)
Destroying test database for alias &#39;default&#39;...
</code></pre>
<p>To fix this, we make sure the template shows the data we want. Open up <code>templates/blogengine/post_list.html</code> and enter the following:</p>
<pre><code class="lang-django">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;My Django Blog&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        {% for post in object_list %}
        &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
        &lt;h3&gt;{{ post.pub_date }}&lt;/h3&gt;
        {{ post.text }}
        {% endfor %}
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>This is only a very basic template, and we’ll expand upon it in future.</p>
<p>With that done, you can run <code>python manage.py test</code>, and it should pass. Well done! Don’t forget to commit your changes:</p>
<pre><code class="lang-bash">$ git add django_tutorial_blog_ng/ templates/ blogengine/
$ git commit -m &#39;Implemented list view for posts&#39;
</code></pre>
<p>And that’s all for this lesson! We’ve done a hell of a lot in this lesson - set up our project, created a comprehensive test suite for it, and implemented the basic functionality. Next time we’ll make it a bit prettier using Twitter Bootstrap, as well as implementing more of the basic functionality for the blog.</p>
<p>You can find the source code <a href="https://github.com/matthewbdaly/django_tutorial_blog_ng">on Github</a>. For your convenience, I’ve tagged this lesson as <code>lesson-1</code>, so you can just clone the repository and switch to the end of this lesson with the following commands:</p>
<pre><code class="lang-bash">$ git clone https://github.com/matthewbdaly/django_tutorial_blog_ng.git
$ cd django_tutorial_blog_ng
$ git checkout lesson-1
</code></pre>
<p>That way, you can easily check that what you’ve done matches up with the repository. Future lessons will be similarly tagged to make them easy to navigate.</p>
]]></description>
        </item>
    </channel>
</rss>