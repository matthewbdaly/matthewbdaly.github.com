<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,tdd,phpspec,http,httplug"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Building a Postcode Lookup Client With Httplug and Phpspec - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">28th November 2017 11:40 am</p><h1>Building a Postcode Lookup Client With Httplug and Phpspec</h1><p>While PHPUnit is my normal go-to PHP testing framework, for some applications I find <a href="http://www.phpspec.net/en/stable/">PHPSpec</a> superior, in particular REST API clients. I’ve found that it makes for a better flow when doing test-driven development, because it makes it very natural to write a test first, then run it, then make the test pass.</p><p>In this tutorial I’ll show you how to build a lookup API client for UK postcodes. In the process of doing so, we’ll use PHPSpec to drive our development process. We’ll also use <a href="http://docs.php-http.org/en/latest/httplug/tutorial.html">HTTPlug</a> as our underlying HTTP library. The advantage of this over using something like Guzzle is that we give library users the freedom to choose the HTTP library they feel is most appropriate to their situation.</p><h2 id="background">Background</h2><p>If you’re unfamiliar with it, the UK postcode system is our equivalent of a zip code in the US, but with two major differences:</p><ul><li>The codes themselves are alphanumeric instead of numeric, with the first part including one or two letters usually (but not always) derived from the nearest large town or city (eg L for Liverpool, B for Birmingham, OX for Oxford), or for London, based on the part of the city (eg NW for the north-west of London)</li><li>A full postcode is in two parts (eg NW1 8TQ), and the first part narrows the location down to a similar area to a US-style zip code, while the second part usually narrows it down to a street (although sometimes large organisations that receive a lot of mail will have a postcode to themselves).</li></ul><p>This means that if you have someone’s postcode and house name or address, you can use those details to look up the rest of their address details. This obviously makes it easier for users to fill out a form, such as when placing an order on an e-commerce site - you can just request those two details and then autofill the rest from them.</p><p>Unfortunately, it’s not quite that simple. The data is owned by Royal Mail, and they charge through the nose for access to the raw data, which places this data well outside the budgets of many web app developers. Fortunately, <a href="https://ideal-postcodes.co.uk/">Ideal Postcodes</a> offer a REST API for querying this data. It’s not free, but at 2.5p per request it’s not going to break the bank unless used excessively, and they offer some dummy postcodes that are free to query, which is perfectly fine for testing.</p><p>For those of you outside the UK, this may not be of much immediate use, but the underlying principles will still be useful, and you can probably build a similar client for your own nation’s postal code system. For instance, there’s a <a href="https://www.zipcodeapi.com/API">Zipcode API</a> that those of you in the US can use, and if you understand what’s going on here it shouldn’t be hard to adapt it to work with that. If you do produce a similar client for your country’s postal code system, submit a pull request to update the README with a link to it and I’ll include it.</p><h2 id="setting-up">Setting up</h2><p>First we’ll create a <code>composer.json</code> to specify our dependencies:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/postcode-client"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A postcode lookup client."</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"library"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"keywords"</span>: [<span class="hljs-string">"postcode"</span>],</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-attr">"require"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"psr/http-message"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"php-http/client-implementation"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">"php-http/httplug"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-attr">"php-http/message-factory"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-attr">"php-http/discovery"</span>: <span class="hljs-string">"^1.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-attr">"psy/psysh"</span>: <span class="hljs-string">"^0.8.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^3.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-attr">"squizlabs/php_codesniffer"</span>: <span class="hljs-string">"^2.7"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-attr">"php-http/mock-client"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-attr">"php-http/message"</span>: <span class="hljs-string">"^1.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-attr">"guzzlehttp/psr7"</span>: <span class="hljs-string">"^1.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>    <span class="hljs-attr">"authors"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        {</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"matthewbdaly@gmail.com"</span></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    ],</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-attr">"Matthewbdaly\\Postcode\\"</span>: <span class="hljs-string">"src/"</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>}</td></tr></table></code></pre><p>Note that we don’t install an actual HTTPlug client, other than the mock one, which is only useful for testing. This is deliberate - we’re giving developers working with this library the choice of working with whatever HTTP client they see fit. We do use the Guzzle PSR7 library, but that’s just for the PSR7 library.</p><p>Then we install our dependencies:</p><pre><code class="hljs lang-bash singleline">$ composer install</code></pre><p>We also need to tell PHPSpec what our namespace will be. Save this as <code>phpspec.yml</code>:</p><pre><code class="hljs lang-yml"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>suites:</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    test_suite:</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">namespace</span>: <span class="hljs-symbol">Matthewbdaly</span>\<span class="hljs-symbol">Postcode</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-symbol">psr4_prefix</span>: <span class="hljs-symbol">Matthewbdaly</span>\<span class="hljs-symbol">Postcode</span></td></tr></table></code></pre><p>Don’t forget to update the namespace in both files to whatever you’re using, which should have a vendor name and a package name.</p><p>With that done, it’s time to introduce the next component.</p><h2 id="introducing-httplug">Introducing HTTPlug</h2><p>In the past I’ve usually used either Curl or Guzzle to carry out HTTP requests. However, the problem with this approach is that you’re forcing whoever uses your library to use whatever HTTP client, and whatever version of that client, that you deem appropriate. If they’re also using another library that someone else has written and they made different choices, you could have problems.</p><p>HTTPlug is an excellent way of solving this problem. By requiring only an interface and not a concrete implementation, using HTTPlug means that you can specify that the consumer of the library must provide a suitable implementation of that library, but leave the choice of implementation up to them. This means that they can choose whatever implementation best fits their use case. There are <a href="http://docs.php-http.org/en/latest/clients.html">adapters for many different clients</a>, so it’s unlikely that they won’t be able to find one that meets their needs.</p><p>In addition, HTTPlug provides the means to automatically determine what HTTP client to use, so that if one is not explicitly provided, it can be resolved without any action on the part of the developer. As long as a suitable HTTP adapter is installed, it will be used.</p><h2 id="getting-started">Getting started</h2><p>One advantage of PHPSpec is that it will automatically generate much of the boilerplate for our client and specs. To create our client spec, run this command:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec desc Matthewbdaly/Postcode/Client</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Specification <span class="hljs-keyword">for</span> Matthewbdaly\Postcode\Client created <span class="hljs-keyword">in</span> /home/matthew/Projects/postcode-client/spec/ClientSpec.php.</td></tr></table></code></pre><p>Now that we have a spec for our client, we can generate the client itself:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  11  - it is initializable</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      class Matthewbdaly\Postcode\Client does not exist.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>1 example (1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>14ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client` <span class="hljs-keyword">for</span> you?              </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Class Matthewbdaly\Postcode\Client created <span class="hljs-keyword">in</span> /home/matthew/Projects/postcode-client/src/Client.php.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>1 example (1 passed)</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>16ms</td></tr></table></code></pre><p>You will need to enter <code>Y</code> when prompted. We now have an empty class for our client.</p><p>Next, we need to make sure that the constructor for our client accepts two parameters:</p><ul><li>The HTTP client</li><li>A message factory instance, which is used to create the request</li></ul><p>Amend <code>spec/ClientSpec.php</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Client</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Client</span>\<span class="hljs-title">HttpClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageFactory</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">let</span> <span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_is_initializable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldHaveType(Client::class);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>}</td></tr></table></code></pre><p>Note the use of the <code>let()</code> method here. This lets us specify how the object is constructed, with the <code>beConstructedWith()</code> method. Also, note that <code>$this</code> refers not to the test, but to the object being tested - this takes a bit of getting used to if you’re used to working with PHPUnit.</p><p>Also, note that the objects passed through are not actual instances of those objects - instead they are mocks created automatically by PHPSpec. This makes mocking extremely easy, and you can easily set up your own expectations on those mock objects in the test. If you want to use a real object, you can instantiate it in the spec as usual. If we need any other mocks, we can typehint them in our method in exactly the same way.</p><p>If we once again use <code>vendor/bin/phpspec run</code> we can now generate a constructor:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  18  - it is initializable</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::__construct not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>1 example (1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>281ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::__construct()` <span class="hljs-keyword">for</span>    </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  you?                                                                          </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Method Matthewbdaly\Postcode\Client::__construct() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>1 example (1 passed)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>50ms</td></tr></table></code></pre><p>This will only create a placeholder for the constructor. You need to populate it yourself, so update <code>src/Client.php</code> as follows:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Client</span>\<span class="hljs-title">HttpClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Discovery</span>\<span class="hljs-title">HttpClientDiscovery</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">MessageFactory</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Http</span>\<span class="hljs-title">Discovery</span>\<span class="hljs-title">MessageFactoryDiscovery</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(HttpClient $client = null, MessageFactory $messageFactory = null)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;client = $client ?: HttpClientDiscovery::find();</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;messageFactory = $messageFactory ?: MessageFactoryDiscovery::find();</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>A little explanation is called for here. We need two arguments in our construct:</p><ul><li>An instance of <code>Http\Client\HttpClient</code> to send the request</li><li>An instance of <code>Http\Message\MessageFactory</code> to create the request</li></ul><p>However, we don’t want to force the user to create one. Therefore if they are not set, we use <code>Http\Discovery\HttpClientDiscovery</code> and <code>Http\Discovery\MessageFactoryDiscovery</code> to create them for us.</p><p>If we re-run PHPSpec, it should now pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       1</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>1 example (1 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>31ms</td></tr></table></code></pre><p>Next, we want to have a method for retrieving the endpoint. Add the following method to <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_retrieve_the_base_url</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getBaseUrl()-&gt;shouldReturn(<span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    }</td></tr></table></code></pre><p>Here we’re asserting that fetching the base URL returns the given result. Note how much simpler and more intuitive this syntax is than PHPUnit would be:</p><pre><code class="hljs lang-php singleline"><span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>, $client-&gt;getBaseUrl());</code></pre><p>Running the tests again should prompt us to create the boilerplate for the new method:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  23  - it can retrieve the base url</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::getBaseUrl not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                  50%                                     50%                    2</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>2 examples (1 passed, 1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>40ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::getBaseUrl()` <span class="hljs-keyword">for</span>     </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>  you?                                                                          </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>  Method Matthewbdaly\Postcode\Client::getBaseUrl() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>  23  - it can retrieve the base url</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      expected <span class="hljs-string">"https://api.ideal-postcod..."</span>, but got null.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                  50%                                     50%                    2</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>2 examples (1 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>72ms</td></tr></table></code></pre><p>Now we need to update that method to work as expected:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $baseUrl = <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>     ...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBaseUrl</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;baseUrl;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    }</td></tr></table></code></pre><p>This should make the tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       2</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>2 examples (2 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>34ms</td></tr></table></code></pre><p>Next, we need to be able to get and set the API key. Add the following to <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_get_and_set_the_key</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getKey()-&gt;shouldReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>)-&gt;shouldReturn(<span class="hljs-keyword">$this</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;getKey()-&gt;shouldReturn(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></tr></table></code></pre><p>Note that we expect <code>$this-&gt;setKey(&#39;foo&#39;)</code> to return <code>$this</code>. This is an example of a <em>fluent</em> interface - by returning an instance of the object, it enables methods to be chained, eg <code>$client-&gt;setKey(&#39;foo&#39;)-&gt;get()</code>. Obviously it won’t work for anything that has to return a value, but it’s a useful way of making your classes more intuitive to use.</p><p>Next, run the tests again and agree to the prompts as before:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::getKey not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                         66%                                     33%             3</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>3 examples (2 passed, 1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>51ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::getKey()` <span class="hljs-keyword">for</span> you?    </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  Method Matthewbdaly\Postcode\Client::getKey() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      method Matthewbdaly\Postcode\Client::setKey not found.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                         66%                                     33%             3</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>3 examples (2 passed, 1 broken)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>43ms</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>  Do you want me to create `Matthewbdaly\Postcode\Client::setKey()` <span class="hljs-keyword">for</span> you?    </td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>  Method Matthewbdaly\Postcode\Client::setKey() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>  28  - it can get and <span class="hljs-built_in">set</span> the key</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>      expected [obj:Matthewbdaly\Postcode\Client], but got null.</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>                         66%                                     33%             3</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>3 examples (2 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>52ms</td></tr></table></code></pre><p>Next, add our getter and setter for the key, as well as declaring the property <code>$key</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">protected</span> $key;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getKey</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;key;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setKey</span><span class="hljs-params">(string $key)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">$this</span>-&gt;key = $key;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr></table></code></pre><p>That should make the tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       3</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>3 examples (3 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>38ms</td></tr></table></code></pre><p>With that done, our final task is to be able to handle sending requests. Add the following imports at the top of <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">RequestInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">ResponseInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">StreamInterface</span>;</td></tr></table></code></pre><p>And add the following method at the bottom of the same file:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_send_the_request</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        $data = json_encode([</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'result'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>                <span class="hljs-string">"postcode"</span> =&gt; <span class="hljs-string">"SW1A 2AA"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>                <span class="hljs-string">"postcode_inward"</span> =&gt; <span class="hljs-string">"2AA"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-string">"postcode_outward"</span> =&gt; <span class="hljs-string">"SW1A"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                <span class="hljs-string">"post_town"</span> =&gt; <span class="hljs-string">"LONDON"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-string">"dependant_locality"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>                <span class="hljs-string">"double_dependant_locality"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                <span class="hljs-string">"thoroughfare"</span> =&gt; <span class="hljs-string">"Downing Street"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>                <span class="hljs-string">"dependant_thoroughfare"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                <span class="hljs-string">"building_number"</span> =&gt; <span class="hljs-string">"10"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                <span class="hljs-string">"building_name"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>                <span class="hljs-string">"sub_building_name"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>                <span class="hljs-string">"po_box"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>                <span class="hljs-string">"department_name"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>                <span class="hljs-string">"organisation_name"</span> =&gt; <span class="hljs-string">"Prime Minister &amp; First Lord Of The Treasury"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                <span class="hljs-string">"udprn"</span> =&gt; <span class="hljs-number">23747771</span>,</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">"umprn"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>                <span class="hljs-string">"postcode_type"</span> =&gt; <span class="hljs-string">"L"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>                <span class="hljs-string">"su_organisation_indicator"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>                <span class="hljs-string">"delivery_point_suffix"</span> =&gt; <span class="hljs-string">"1A"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>                <span class="hljs-string">"line_1"</span> =&gt; <span class="hljs-string">"Prime Minister &amp; First Lord Of The Treasury"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>                <span class="hljs-string">"line_2"</span> =&gt; <span class="hljs-string">"10 Downing Street"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>                <span class="hljs-string">"line_3"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>                <span class="hljs-string">"premise"</span> =&gt; <span class="hljs-string">"10"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                <span class="hljs-string">"longitude"</span> =&gt; <span class="hljs-number">-0.127695242183412</span>,</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>                <span class="hljs-string">"latitude"</span> =&gt; <span class="hljs-number">51.5035398826274</span>,</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>                <span class="hljs-string">"eastings"</span> =&gt; <span class="hljs-number">530047</span>,</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>                <span class="hljs-string">"northings"</span> =&gt; <span class="hljs-number">179951</span>,</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>                <span class="hljs-string">"country"</span> =&gt; <span class="hljs-string">"England"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>                <span class="hljs-string">"traditional_county"</span> =&gt; <span class="hljs-string">"Greater London"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>                <span class="hljs-string">"administrative_county"</span> =&gt; <span class="hljs-string">""</span>,</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>                <span class="hljs-string">"postal_county"</span> =&gt; <span class="hljs-string">"London"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>                <span class="hljs-string">"county"</span> =&gt; <span class="hljs-string">"London"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>            ]</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">200</span>);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        $response-&gt;getBody()-&gt;willReturn($stream);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>        $stream-&gt;getContents()-&gt;willReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'SW1A 2AA'</span>)-&gt;shouldBeLike(json_decode($data, <span class="hljs-keyword">true</span>));</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    }</td></tr></table></code></pre><p>This test is by far the biggest so far, so it merits some degree of explanation.</p><p>Note that we don’t make a real HTTP request against the API. This may sound strange, but bear with me. We have no control whatsoever over that API, and it could in theory become inaccessible or be subject to breaking changes at any time. We also don’t want to be shelling out for a paid service just to test our API client works. All we can do is test that our implementation will send the request we expect it to send - we don’t want our test suite reporting a bug when the API goes down.</p><p>We therefore typehint not just the dependencies for the constructor, but a request, response and stream instance. We mock our our responses from those instances using the <code>willReturn()</code> method, so we have complete control over what we pass to our client. That way we can return any appropriate response or throw any exception we deem fit to test the behaviour under those circumstances. For the message factory, we specify what arguments it should receive to create the request, and return our mocked-out request object.</p><p>Also, note we use <code>shouldBeLike()</code> to verify the response - this is effectively using the <code>==</code> operator, whereas <code>shouldBe()</code> uses the <code>===</code> operator, making it stricter.</p><p>Let’s run the tests, and don’t forget the prompt:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  <span class="hljs-number">38</span>  - it can send the request</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      method Matthewbdaly\Postcode\Client::get not found.</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>                            <span class="hljs-number">75</span>%                                     <span class="hljs-number">25</span>%          <span class="hljs-number">4</span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-number">1</span> specs</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-number">4</span> examples (<span class="hljs-number">3</span> passed, <span class="hljs-number">1</span> broken)</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-number">55</span>ms</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>  <span class="hljs-keyword">Do</span> you want me to create `Matthewbdaly\Postcode\Client::get()` <span class="hljs-keyword">for</span> you?       </td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>                                                                         [Y/n] </td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>y</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>  Method Matthewbdaly\Postcode\Client::get() has been created.</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>  <span class="hljs-number">38</span>  - it can send the request</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      expected [<span class="hljs-keyword">array</span>:<span class="hljs-number">1</span>], but got <span class="hljs-keyword">null</span>.</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>                            <span class="hljs-number">75</span>%                                     <span class="hljs-number">25</span>%          <span class="hljs-number">4</span></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td><span class="hljs-number">1</span> specs</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td><span class="hljs-number">4</span> examples (<span class="hljs-number">3</span> passed, <span class="hljs-number">1</span> failed)</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td><span class="hljs-number">56</span>ms</td></tr></table></code></pre><p>Now we can implement the <code>get()</code> method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>            <span class="hljs-string">'GET'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            $url,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            [],</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            <span class="hljs-keyword">null</span>,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-string">'1.1'</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> $data;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr></table></code></pre><p>We first build up our URL, before using the message factory to create a request object. We then pass the built request to our client to send, before decoding the response into the format we want.</p><p>This should make our tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       4</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>4 examples (4 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>307ms</td></tr></table></code></pre><p>Our client now works, but there are a couple of situations we need to account for. First, the API will raise a 402 if you make a request for a real postcode without having paid. We need to catch this and throw an exception. Add this to <code>spec/ClientSpec.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PaymentRequired</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_throws_an_exception_if_payment_required</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">402</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(PaymentRequired::class)-&gt;duringGet(<span class="hljs-string">'SW1A 2AA'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    }</td></tr></table></code></pre><p>With that done, run the tests again:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                      </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  87  - it throws an exception <span class="hljs-keyword">if</span> payment required</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      [exc:Prophecy\Exception\Call\UnexpectedCallException(<span class="hljs-string">"Method call:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        - getBody()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      on Double\ResponseInterface\P15 was not expected, expected calls were:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        - getStatusCode()")].</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                              80%                                     20%        5</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>5 examples (4 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>130ms</td></tr></table></code></pre><p>Let’s amend the client to throw this exception:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PaymentRequired</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            <span class="hljs-string">'GET'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            $url,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            [],</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-keyword">null</span>,</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>            <span class="hljs-string">'1.1'</span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">402</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PaymentRequired;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> $data;</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    }</td></tr></table></code></pre><p>And let’s re-run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  87  - it throws an exception <span class="hljs-keyword">if</span> payment required</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got [obj:Error] with the</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      message: <span class="hljs-string">"Class 'Matthewbdaly\Postcode\Exceptions\PaymentRequired' not found"</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>                              80%                                     20%        5</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>5 examples (4 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>389ms</td></tr></table></code></pre><p>It fails now because the exception doesn’t exist. Let’s create it at <code>src/Exceptions/PaymentRequired.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentRequired</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>}</td></tr></table></code></pre><p>That should be enough to make our tests pass:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       5</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>5 examples (5 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>89ms</td></tr></table></code></pre><p>We also need to raise an exception when the postcode is not found, which raises a 404 error. Add the following spec:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PostcodeNotFound</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_throws_an_exception_if_postcode_not_found</span><span class="hljs-params">(HttpClient $client, MessageFactory $messageFactory, RequestInterface $request, ResponseInterface $response, StreamInterface $stream)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        <span class="hljs-keyword">$this</span>-&gt;beConstructedWith($client, $messageFactory);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setKey(<span class="hljs-string">'foo'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $messageFactory-&gt;createRequest(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.ideal-postcodes.co.uk/v1/postcodes/SW1A%202AA?api_key=foo'</span>, [], <span class="hljs-keyword">null</span>, <span class="hljs-string">'1.1'</span>)-&gt;willReturn($request);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        $client-&gt;sendRequest($request)-&gt;willReturn($response);</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $response-&gt;getStatusCode()-&gt;willReturn(<span class="hljs-number">404</span>);</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        <span class="hljs-keyword">$this</span>-&gt;shouldThrow(PostcodeNotFound::class)-&gt;duringGet(<span class="hljs-string">'SW1A 2AA'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    }</td></tr></table></code></pre><p>Run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>Matthewbdaly/Postcode/Client                                                    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>  98  - it throws an exception <span class="hljs-keyword">if</span> postcode not found</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>      expected exception of class <span class="hljs-string">"Matthewbdaly\Postcode\Exc..."</span>, but got</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>      [exc:Prophecy\Exception\Call\UnexpectedCallException(<span class="hljs-string">"Method call:</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        - getBody()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>      on Double\ResponseInterface\P20 was not expected, expected calls were:</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        - getStatusCode()")].</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>                                83%                                     16%      6</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>6 examples (5 passed, 1 failed)</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>538ms</td></tr></table></code></pre><p>This time we’ll create the exception class before updating the client. Create the following class at <code>src/Exceptions/PostcodeNotFound.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> * Postcode not found exception</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td> *</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td> */</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostcodeNotFound</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Exception</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>And update the client:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">Postcode</span>\<span class="hljs-title">Exceptions</span>\<span class="hljs-title">PostcodeNotFound</span>;</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    ...</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(string $postcode)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>        $url = <span class="hljs-keyword">$this</span>-&gt;getBaseUrl() . rawurlencode($postcode) . <span class="hljs-string">'?'</span> . http_build_query([</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>            <span class="hljs-string">'api_key'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getKey()</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        $request = <span class="hljs-keyword">$this</span>-&gt;messageFactory-&gt;createRequest(</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-string">'GET'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            $url,</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>            [],</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            <span class="hljs-keyword">null</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            <span class="hljs-string">'1.1'</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        );</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $response = <span class="hljs-keyword">$this</span>-&gt;client-&gt;sendRequest($request);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">402</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PaymentRequired;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">if</span> ($response-&gt;getStatusCode() == <span class="hljs-number">404</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PostcodeNotFound;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $data = json_decode($response-&gt;getBody()-&gt;getContents(), <span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        <span class="hljs-keyword">return</span> $data;</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr></table></code></pre><p>Re-run the tests:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ vendor/bin/phpspec run</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>                                      100%                                       6</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>1 specs</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>6 examples (6 passed)</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>103ms</td></tr></table></code></pre><p>And our API client is feature complete! You can find the source code of the finished client <a href="https://github.com/matthewbdaly/postcode-client">here</a>.</p><h2 id="summary">Summary</h2><p>Personally, I find that while PHPSpec isn’t appropriate for every use case, it’s particularly handy for API clients and it’s generally my go-to testing solution for them. It handles producing a lot of the boilerplate for me, and it results in a much better workflow for test-driven development as it makes it very natural to write the test first, then make it pass.</p><p>HTTPlug has been a revelation for me. While it takes a bit of getting used to if you’re used to something like Guzzle, it means that you’re giving consumers of your library the freedom to choose the HTTP client of their choice, meaning they don’t have to fight with several different libraries requiring different versions of Guzzle. It also allows for easy resolution of the HTTP client, rather than having to explicitly pass through an instance when instantiating your client. I’m planning to use it extensively in the future.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/tdd/">tdd</a></li><li><a href="/blog/categories/phpspec/">phpspec</a></li><li><a href="/blog/categories/http/">http</a></li><li><a href="/blog/categories/httplug/">httplug</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2017/11/28/building-a-postcode-lookup-client-with-httplug-and-phpspec/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/09/21/using-mix-versioning-outside-laravel/">Using Mix Versioning Outside Laravel</a></p><p><a href="/blog/2019/09/07/setting-private-properties-in-tests/">Setting Private Properties in Tests</a></p><p><a href="/blog/2019/07/28/skipping-environment-specific-phpunit-tests/">Skipping Environment Specific Phpunit Tests</a></p><p><a href="/blog/2019/06/19/powering-up-git-bisect-with-the-run-command/">Powering Up Git Bisect With the Run Command</a></p><p><a href="/blog/2019/05/14/writing-golden-master-tests-for-laravel-applications/">Writing Golden Master Tests for Laravel Applications</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li><a class="page-item" href="/blog/2017/11/16/creating-custom-assertions-with-phpunit/">Creating Custom Assertions With Phpunit</a></li><li><a class="page-item" href="/blog/2017/12/02/full-text-search-with-laravel-and-postgresql/">Full Text Search With Laravel and Postgresql</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>