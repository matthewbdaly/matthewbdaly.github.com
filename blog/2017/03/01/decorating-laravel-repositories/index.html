<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,laravel"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2017/03/01/decorating-laravel-repositories/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2017/03/01/decorating-laravel-repositories/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Decorating Laravel Repositories - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">1st March 2017 11:16 pm</p><h1>Decorating Laravel Repositories</h1><p><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">As mentioned previously</a>, when building any nontrivial Laravel application, it’s prudent to decouple our controllers from the Eloquent ORM (or any other ORM or data source we may be using) by creating an interface, and then writing a repository that implements that interface. We can then resolve the interface to our repository, and use the repository to interact with our data source. Should we need to switch to a different implementation, we then need only create the new repository and amend how Laravel resolves that interface.</p><p>The same principle applies when it comes to caching. Database queries are typically a major bottleneck in a web application, and so it’s prudent to implement some form of caching for your queries. However, it’s a bad idea to do so in your controllers, because just as with Eloquent models, you’re tying yourself to one particular implementation and won’t be able to switch without rewriting a good chunk of your controllers, as well as possibly having to maintain large amounts of duplicate code for when a query is made in several places.</p><p>Alternatively, you could implement caching within the methods of your repository, which might make sense for smaller projects. However, it means that your repository is now dependent on both the ORM and cache you chose. If you decide you want to change your ORM but retain the same caching system, or vice versa, you’re stuck with writing a new repository to handle both, duplicating work you’ve already done.</p><p>Fortunately, there’s a more elegant solution. Using the <a href="http://designpatternsphp.readthedocs.io/en/latest/Structural/Decorator/README.html">decorator pattern</a>, we can create a second repository that implements the same interface and “wraps” the original repository. Each of its methods will call its counterpart in the original, and if appropriate cache the response. That way, our caching is implemented separately from our database interactions, and we can easily create a repository for a new data source without affecting the caching in the slightest.</p><p>Say we have the following interface for our <code>User</code> model:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>And the following repository implements that interface:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">User</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Hash</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EloquentUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-keyword">private</span> $model;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(User $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;model = $model;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;model-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        $user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">$this</span>-&gt;model;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $user-&gt;email = $input[<span class="hljs-string">'email'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $user-&gt;name = $input[<span class="hljs-string">'name'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        $user-&gt;password = Hash::make($input[<span class="hljs-string">'password'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        $user-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">return</span> $user;</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>}</td></tr></table></code></pre><p>We might implement the following repository class to handle caching:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Interfaces</span>\<span class="hljs-title">UserRepositoryInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">Repository</span> <span class="hljs-title">as</span> <span class="hljs-title">Cache</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepositoryInterface</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-keyword">protected</span> $cache;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(UserRepositoryInterface $repository, Cache $cache)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache = $cache;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember(<span class="hljs-string">'all'</span>, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOrFail</span><span class="hljs-params">($id)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;remember($id, <span class="hljs-number">60</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($id)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;findOrFail($id);</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($input)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">$this</span>-&gt;cache-&gt;tags(<span class="hljs-string">'users'</span>)-&gt;flush();</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create($input);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Note how each method doesn’t actually do any querying. Instead, the constructor accepts an implementation of the same interface and the cache, and we defer all interactions with the database to that implementation. Each call that queries the database is wrapped in a callback so that it’s stored in Laravel’s cache when it’s returned, without touching the original implementation. When a user is created, the users tag is flushed from the cache so that stale results don’t get served.</p><p>To actually use this implementation, we need to update our service provider so that it resolves the interface to an implementation of our decorator:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;app-&gt;singleton(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            $baseRepo = <span class="hljs-keyword">new</span> \App\Repositories\EloquentUserRepository(<span class="hljs-keyword">new</span> \App\User);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            $cachingRepo = <span class="hljs-keyword">new</span> \App\Repositories\Decorators\CachingUserRepository($baseRepo, <span class="hljs-keyword">$this</span>-&gt;app[<span class="hljs-string">'cache.store'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>            <span class="hljs-keyword">return</span> $cachingRepo;</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>}</td></tr></table></code></pre><p>We instantiate the base repository, passing it the appropriate model. Then we instantiate the decorator, passing it the base repository and the cache, and return it. Now our controllers will start using the new decorator.</p><h2 id="testing-the-decorator">Testing the decorator</h2><p>Now that we have a working decorator, how do we test it? Just as with the decorator itself, we want our tests to be completely decoupled from any particular implementation of the dependencies. If in future we’re asked to migrate the database to MongoDB, say, we’ll have plenty of work writing our new database repositories, so we don’t want to have to rewrite the tests for our decorator as well. Fortunately, using Mockery we can just mock the interface for the repository, and pass that mock into the constructor of the decorator in our test. That way we can have the mock return a known response and not involve either the database repository or the underlying models in any way.</p><p>We will also want to mock the cache itself, as this is a unit test and so as far as possible it should not be testing anything outside of the repository class. Here’s an example of how we might test the above decorator.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Decorators</span>\<span class="hljs-title">CachingUserRepository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * Test fetching all items</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFetchingAll</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'all'</span>)-&gt;andReturn([]);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn([]);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $items = $repository-&gt;all();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertCount(<span class="hljs-number">0</span>, $items);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     * Test fetching a single item</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testFindOrFail</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'findOrFail'</span>)-&gt;with(<span class="hljs-number">1</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'users'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'remember'</span>)-&gt;andReturn(<span class="hljs-keyword">null</span>);</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>        $item = $repository-&gt;findOrFail(<span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertNull($item);</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>     * Test creating a single item</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreate</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td>        <span class="hljs-comment">// Create mock of decorated repository</span></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>        $repo = m::mock(<span class="hljs-string">'App\Repositories\Interfaces\UserRepositoryInterface'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>        $repo-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>])-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>        <span class="hljs-comment">// Create mock of cache</span></td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>        $cache = m::mock(<span class="hljs-string">'Illuminate\Contracts\Cache\Repository'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'tags'</span>)-&gt;with(<span class="hljs-string">'usersUser'</span>)-&gt;andReturn($cache);</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>        $cache-&gt;shouldReceive(<span class="hljs-string">'flush'</span>)-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>        <span class="hljs-comment">// Instantiate the repository</span></td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>        $repository = <span class="hljs-keyword">new</span> CachingUserRepository($repo, $cache);</td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td>        <span class="hljs-comment">// Get all</span></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>        $item = $repository-&gt;create([<span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'bob@example.com'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertTrue($item);</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="84"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="85"></td><td>        m::close();</td></tr><tr><td class="linenos" data-pseudo-content="86"></td><td>        <span class="hljs-keyword">parent</span>::tearDown();</td></tr><tr><td class="linenos" data-pseudo-content="87"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="88"></td><td>}</td></tr></table></code></pre><p>As you can see, all we care about is that the underlying repository interface receives the correct method calls and arguments, nothing more. That way our test is fast and repository-agnostic.</p><h2 id="other-applications">Other applications</h2><p>Here I’ve used this technique to cache the queries, but that’s not the only use case for decorating a repository. For instance, you could decorate a repository to fire events when certain methods are called, and write different decorators when reusing these repositories for different applications. You could create one to log interactions with the repository, or you could use an external library to cache your queries, all without touching your existing repository. Should we need to switch back to our base repository, it’s just a matter of amending the service provider accordingly as both the decorator and the repository implement the same interface.</p><p>Creating decorators does mean you have to implement all of the interface’s methods again, but if you have a base repository that your other ones inherit from, you can easily create a base decorator in a similar fashion that wraps methods common to all the repositories, and then just implement the additional methods for each decorator as required. Also, each method is likely to be fairly limited in scope so it’s not generally too onerous.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/laravel/">laravel</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2017/03/01/decorating-laravel-repositories/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2017/03/01/decorating-laravel-repositories/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2020/06/13/flow-typed-ajax-responses-with-react-hooks/">Flow Typed AJAX Responses With React Hooks</a></p><p><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></p><p><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></p><p><a href="/blog/2020/02/09/don&#x27;t-use-stdclass/">Don&#x27;t Use Stdclass</a></p><p><a href="/blog/2020/01/25/f***-phpstorm-man-and-the-high-horse-he-rode-in-on/">F*** Phpstorm Man and the High Horse He Rode in on</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/blog/2017/02/19/my-first-laravel-package/">&lt; My First Laravel Package</a></li><li class="page-item"><a class="page-link" href="/blog/2017/03/15/enforcing-a-coding-standard-with-php-codesniffer/">Enforcing a Coding Standard With PHP Codesniffer &gt;</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2020.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>