<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,laravel,tdd"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2018/02/25/unit-testing-your-laravel-controllers/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2018/02/25/unit-testing-your-laravel-controllers/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Unit Testing Your Laravel Controllers - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">25th February 2018 3:50 pm</p><h1>Unit Testing Your Laravel Controllers</h1><p>In <a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">my previous post</a> I mentioned some strategies for refactoring Laravel controllers to move unnecessary functionality elsewhere. However, I didn’t cover testing them. In this post I will demonstrate the methodology I use for testing Laravel controllers.</p><p>Say we have the following method in a controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{    </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        $document = <span class="hljs-keyword">new</span> Document($request-&gt;only([</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'title'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'text'</span>, </td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ]));</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $document-&gt;save();</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        event(<span class="hljs-keyword">new</span> DocumentCreated($document));</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-keyword">return</span> redirect()-&gt;route(<span class="hljs-string">'/'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><p>This controller method does three things:</p><ul><li>Return a response</li><li>Create a model instance</li><li>Fire an event</li></ul><p>Our tests therefore need to pass it all its external dependencies and check it carries out the required actions.</p><p>First we fake the event facade:</p><pre><code class="hljs lang-php singleline">    Event::fake();</code></pre><p>Next, we create an instance of <code>Illuminate\Http\Request</code> to represent the HTTP request passed to the controller:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $request = Request::create(<span class="hljs-string">'/store'</span>, <span class="hljs-string">'POST'</span>,[</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-string">'title'</span>     =&gt;     <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>        <span class="hljs-string">'text'</span>     =&gt;     <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    ]);</td></tr></table></code></pre><p>If you’re using a custom form request class, you should instantiate that in exactly the same way.</p><p>Then, instantiate the controller, and call the method, passing it the request object:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $controller = <span class="hljs-keyword">new</span> MyController();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    $response = $controller-&gt;store($request);</td></tr></table></code></pre><p>You can then test the response from the controller. You can test the status code like this:</p><pre><code class="hljs lang-php singleline">    <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">302</span>, $response-&gt;getStatusCode());</code></pre><p>You may also need to check the content of the response matches what you expect to see, by retrieving <code>$response-&gt;getBody()-&gt;getContent()</code>.</p><p>Next, retrieve the newly created model instance, and verify it exists:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    $document = Document::where(<span class="hljs-string">'title'</span>, <span class="hljs-string">'foo'</span>)-&gt;first();</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-keyword">$this</span>-&gt;assertNotNull($document);</td></tr></table></code></pre><p>You can also use <code>assertEquals()</code> to check the attributes on the model if appropriate. Finally, you check the event was fired:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>    Event::assertDispatched(DocumentCreated::class, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($event)</span> <span class="hljs-title">use</span> <span class="hljs-params">($document)</span> </span>{ </td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>        <span class="hljs-keyword">return</span> $event-&gt;document-&gt;id === $document-&gt;id; </td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    });</td></tr></table></code></pre><p>This test should not concern itself with any functionality triggered by the event, only that the event gets triggered. The event should have separate unit tests in which the event is triggered, and then the test verifies it carried out the required actions.</p><p>Technically, these don’t quite qualify as being unit tests because they hit the database, but they should cover the controller adequately. To make them true unit tests, you’d need to implement the repository pattern for the database queries rather than using Eloquent directly, and mock the repository, so you can assert that the mocked repository receive the right data and have it return the expected response.</p><p>Here is how you might do that with Mockery:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$mock = Mockery::mock(<span class="hljs-string">'App\Contracts\Repositories\Document'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>$mock-&gt;shouldReceive(<span class="hljs-string">'create'</span>)-&gt;with([</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-string">'title'</span>    =&gt;        <span class="hljs-string">'foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-string">'text'</span>    =&gt;        <span class="hljs-string">'bar'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>])-&gt;once()-&gt;andReturn(<span class="hljs-keyword">true</span>);</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>$controller = <span class="hljs-keyword">new</span> MyController($mock);</td></tr></table></code></pre><p>As long as your controllers are kept as small as possible, it’s generally not too hard to test them. Unfortunately, fat controllers become almost impossible to test, which is another good reason to avoid them.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/laravel/">laravel</a></li><li><a href="/blog/categories/tdd/">tdd</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2018/02/25/unit-testing-your-laravel-controllers/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2018/02/25/unit-testing-your-laravel-controllers/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers</a></p><p><a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">Put Your Laravel Controllers on a Diet</a></p><p><a href="/blog/2018/02/04/using-lando-as-an-alternative-to-vagrant/">Using Lando As An Alternative to Vagrant</a></p><p><a href="/blog/2018/01/29/how-i-deploy-laravel-apps/">How I Deploy Laravel Apps</a></p><p><a href="/blog/2018/01/28/why-the-speed-of-your-mvc-framework-is-usually-a-red-herring/">Why the Speed of Your MVC Framework Is Usually a Red Herring</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/"><span class="glyphicon glyphicon-chevron-left"></span> Put Your Laravel Controllers on a Diet</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>