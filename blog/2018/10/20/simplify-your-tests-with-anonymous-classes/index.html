<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Simplify Your Tests With Anonymous Classes - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">20th October 2018 2:48 pm</p><h1>Simplify Your Tests With Anonymous Classes</h1><p>Anonymous classes were added in PHP7, but so far I haven’t made all that much use of them. However, recently I’ve been working on building a simple dependency injection container for learning purposes. This uses the PHP Reflection API to determine how to resolve dependencies. For instance, if it’s asked for a class for which one of the dependencies required by the constructor is an instance of the <code>DateTime</code> class, it should create an instance, and then pass it into the constructor automatically when instantiating the class. Then it should return the newly created class.</p><p>Mocking isn’t really a suitable approach for this use case because the container needs to return a concrete class instance to do its job properly. You could just create a series of fixture classes purely for testing purposes, but that would mean either defining more than one class in a file (violating PSR-2), or defining a load of fixture classes in separate files, meaning you’d have to write a lot of boilerplate, and you’d have to move between several different files to understand what’s going on in the test.</p><p>Anonymous classes allow you a means to write simple classes for tests inline, as in this example for retrieving a very basic class. The tests use PHPSpec:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">spec</span>\<span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Vendor</span>\<span class="hljs-title">Package</span>\<span class="hljs-title">MyClass</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">PhpSpec</span>\<span class="hljs-title">ObjectBehavior</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Prophecy</span>\<span class="hljs-title">Argument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">DateTime</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>You can also define your own methods inline. Here we implement the <code>invoke()</code> magic method so that the class is a callable:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_registered_invokable</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DateTime;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        };</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf(<span class="hljs-string">'DateTime'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>You can also define a constructor. Here, we’re getting the class name of a newly created anonymous class that accepts an instance of <code>DateTime</code> as an argument to the constructor. Then, we can resolve a new instance out of the container:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-title">new</span> <span class="hljs-title">DateTime</span>) </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DateTime $datetime)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-keyword">$this</span>-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>}</td></tr></table></code></pre><p>For classes that will extend an existing class or implement an interface, you can define those inline too. Or you can include a trait:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClassSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectBehavior</span></span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">it_can_resolve_dependencies</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        $toResolve = get_class(<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-title">new</span> <span class="hljs-title">DateTime</span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Bar</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>            <span class="hljs-keyword">public</span> $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DateTime $datetime)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>            {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>                <span class="hljs-keyword">$this</span>-&gt;datetime = $datetime;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>            }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>            <span class="hljs-keyword">use</span> <span class="hljs-title">MyTrait</span>;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">$this</span>-&gt;set(<span class="hljs-string">'Foo\Bar'</span>, $toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'Foo\Bar'</span>)-&gt;shouldReturnAnInstanceOf($toResolve);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>}</td></tr></table></code></pre><p>In cases where the functionality is contained in a trait or abstract class, and you might need to add little or no additional functionality, this is a lot less verbose than creating a class the conventional way.</p><p>None of this is stuff you can’t do without anonymous classes, but by defining these sort of disposable fixture classes inline in your tests, you’re writing the minimum amount of code necessary to implement your test, and it’s logical to define it inline since it’s only ever used in the tests. One thing to bear in mind is that anonymous classes are created and instantiated at the same time, so you can’t easily create a class and then instantiate an instance of it separately. However, you can instantiate one, then use the <code>get_class()</code> function to get its class name and use that to resolve it, which worked well for my use case.</p><p>Another use case for anonymous classes is testing traits or abstract classes. I generally use Mockery as my mocking solution with PHPUnit tests, but I’ve sometimes missed the <code>getMockForTrait()</code> method from PHPUnit. However, another option is to instantiate an anonymous class that includes that trait for testing purposes:</p><pre><code class="hljs lang-php7"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="php"><span class="hljs-meta">&lt;?php</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>$item = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span>() </span>{</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-keyword">use</span> <span class="hljs-title">MyTrait</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>};</td></tr></table></code></pre><p>This way, your test class is as minimal as possible, and you can test the trait/abstract class in a fairly isolated fashion.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2019/01/02/why-bad-code-is-bad/">Why Bad Code Is Bad</a></p><p><a href="/blog/2018/12/27/improving-search-in-vim-and-neovim-with-fzf-and-ripgrep/">Improving Search in Vim and Neovim With FZF and Ripgrep</a></p><p><a href="/blog/2018/12/06/decorating-service-classes/">Decorating Service Classes</a></p><p><a href="/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/">Simplify Your Tests With Anonymous Classes</a></p><p><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li><a class="page-item" href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></li><li><a class="page-item" href="/blog/2018/12/06/decorating-service-classes/">Decorating Service Classes</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>