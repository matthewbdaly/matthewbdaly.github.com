<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,testing"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2018/09/13/mutation-testing-with-infection/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2018/09/13/mutation-testing-with-infection/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Mutation Testing With Infection - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/uses/">Uses</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/uses/">Uses</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">13th September 2018 8:10 pm</p><h1>Mutation Testing With Infection</h1><p>Writing automated tests is an excellent way of catching bugs during development and maintenance of your application, not to mention the other benefits. However, it’s hard to gauge the quality of your tests, particularly when you first start out. Coverage will give you a good idea of what code was actually run during the test, but it won’t tell you if the test itself actually tests anything worthwhile.</p><p><a href="https://infection.github.io/">Infection</a> is a mutation testing framework. The documentation defines mutation testing as follows:</p><blockquote><p>Mutation testing involves modifying a program in small ways. Each mutated version is called a Mutant. To assess the quality of a given test set, these mutants are executed against the input test set to see if the seeded faults can be detected. If mutated program produces failing tests, this is called a killed mutant. If tests are green with mutated code, then we have an escaped mutant.</p></blockquote><p>Infection works by running the test suite, carrying out a series of mutations on the source code in order to try to break the tests, and then collecting the results. The actual mutations carried out are not random - there is a set of mutations that get carried out every time, so results should be consistent. Ideally, all mutants should be killed by your tests - escaped mutants can indicate that either the line of mutated code is not tested, or the tests for that line are not very useful.</p><p>I decided to add mutation testing to my <a href="https://github.com/matthewbdaly/laravel-cart">Laravel shopping cart package</a>. In order to use Infection, you need to be able to generate code coverage, which means having either XDebug or phpdbg installed. Once Infection is installed (refer to the documentation for this), you can run this command in the project directory to configure it:</p><pre><code class="hljs lang-bash singleline">$ infection</code></pre><p>Infection defaults to using PHPUnit for the tests, but it also supports PHPSpec. If you’re using PHPSpec, you will need to specify the testing framework like this:</p><pre><code class="hljs lang-bash singleline">$ infection --<span class="hljs-built_in">test</span>-framework=phpspec</code></pre><p>Since PHPSpec doesn’t support code coverage out of the box, you’ll need to install a package for that - I used <code>leanphp/phpspec-code-coverage</code>.</p><p>On first run, you’ll be prompted to create a configuration file. Your source directory should be straightforward to set up, but at the next step, if your project uses interfaces in the source directory, you should exclude them. The rest of the defaults should be fine.</p><p>I found that the first run gave a large number of uncovered results, but the second and later ones were more consistent - not sure if it’s an issue with my setup or not. Running it gave me this:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    0 [&gt;---------------------------] &lt; 1 secRunning initial <span class="hljs-built_in">test</span> suite...</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   27 [============================] 3 secs</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 43/43</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>...................MMM...M.......M.........          (43 / 43)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>43 mutations were generated:</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      38 mutants were killed</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       5 covered mutants were not detected</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 88%</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 88%</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 21s. Memory: 12.00MB</td></tr></table></code></pre><p>Our test run shows 5 escaped mutants, and the remaining 38 were killed. We can view the results by looking at the generated <code>infection-log.txt</code>:</p><pre><code class="hljs lang-txt"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>Escaped mutants:</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>================</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-number">1</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] DecrementInteger</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">-1</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td><span class="hljs-number">2</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] OneZeroInteger</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">1</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td><span class="hljs-number">3</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">132</span>    [M] GreaterThan</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>-                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>+                <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt;= <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>                     $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td><span class="hljs-number">4</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">133</span>    [M] Assignment</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>         $content = Collection::make(<span class="hljs-keyword">$this</span>-&gt;all())-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($item)</span> <span class="hljs-title">use</span><span class="hljs-params">($rowId)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>             <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'row_id'</span>] == $rowId) {</td></tr><tr><td class="linenos" data-pseudo-content="57"></td><td>                 <span class="hljs-keyword">if</span> ($item[<span class="hljs-string">'qty'</span>] &gt; <span class="hljs-number">0</span>) {</td></tr><tr><td class="linenos" data-pseudo-content="58"></td><td>-                    $item[<span class="hljs-string">'qty'</span>] -= <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="59"></td><td>+                    $item[<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="60"></td><td>                 }</td></tr><tr><td class="linenos" data-pseudo-content="61"></td><td>             }</td></tr><tr><td class="linenos" data-pseudo-content="62"></td><td>             <span class="hljs-keyword">return</span> $item;</td></tr><tr><td class="linenos" data-pseudo-content="63"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="64"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="65"></td><td><span class="hljs-number">5</span>) /home/matthew/Projects/laravel-cart/src/Services/Cart.php:<span class="hljs-number">197</span>    [M] OneZeroInteger</td></tr><tr><td class="linenos" data-pseudo-content="66"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="67"></td><td>--- Original</td></tr><tr><td class="linenos" data-pseudo-content="68"></td><td>+++ <span class="hljs-keyword">New</span></td></tr><tr><td class="linenos" data-pseudo-content="69"></td><td>@@ @@</td></tr><tr><td class="linenos" data-pseudo-content="70"></td><td>      */</td></tr><tr><td class="linenos" data-pseudo-content="71"></td><td>     <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasStringKeys</span><span class="hljs-params">(array $items)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="72"></td><td>     {</td></tr><tr><td class="linenos" data-pseudo-content="73"></td><td>-        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="74"></td><td>+        <span class="hljs-keyword">return</span> count(array_filter(array_keys($items), <span class="hljs-string">'is_string'</span>)) &gt; <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="75"></td><td>     }</td></tr><tr><td class="linenos" data-pseudo-content="76"></td><td>     <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="77"></td><td>      * Validate input</td></tr><tr><td class="linenos" data-pseudo-content="78"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="79"></td><td>Timed Out mutants:</td></tr><tr><td class="linenos" data-pseudo-content="80"></td><td>==================</td></tr><tr><td class="linenos" data-pseudo-content="81"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="82"></td><td>Not Covered mutants:</td></tr><tr><td class="linenos" data-pseudo-content="83"></td><td>====================</td></tr></table></code></pre><p>This displays the mutants that escaped, and include a diff of the changed code, so we can see that all of these involve changing the comparison operators.</p><p>The last one can be resolved easily because the comparison is superfluous - the result of <code>count()</code> can be evaluated as true or false by itself, so removing the <code>&gt; 0</code> at the end in the test solves the problem quite neatly.</p><p>The other four mutations are somewhat harder. They all amend the <code>decrement</code> method’s conditions, showing that a single assertion doesn’t really fully check the behaviour. Here’s the current test for that method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>It should be possible to decrement it if the quantity is more than zero, but not to go any lower. However, our current test does not catch anything but decrementing it from 2 to 1, which doesn’t fully demonstrate this. We therefore need to add a few more assertions to cover taking it down to zero, and then trying to decrement it again. Here’s how we might do that.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Services</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LaravelCart</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">Cart</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Mockery</span> <span class="hljs-title">as</span> <span class="hljs-title">m</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@dataProvider</span> arrayProvider</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCanDecrementQuantity</span><span class="hljs-params">($data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $data[<span class="hljs-number">0</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_1'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $data[<span class="hljs-number">1</span>][<span class="hljs-string">'row_id'</span>] = <span class="hljs-string">'my_row_id_2'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $newdata = $data;</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        $newdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">1</span>;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        $session = m::mock(<span class="hljs-string">'Illuminate\Contracts\Session\Session'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($data);</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>        $uniqid = m::mock(<span class="hljs-string">'Matthewbdaly\LaravelCart\Contracts\Services\UniqueId'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>        $cart = <span class="hljs-keyword">new</span> Cart($session, $uniqid);</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        $newerdata = $newdata;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        $newerdata[<span class="hljs-number">1</span>][<span class="hljs-string">'qty'</span>] = <span class="hljs-number">0</span>;</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newdata);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'get'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>)-&gt;once()-&gt;andReturn($newerdata);</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $session-&gt;shouldReceive(<span class="hljs-string">'put'</span>)-&gt;with(<span class="hljs-string">'Matthewbdaly\LaravelCart\Services\Cart'</span>, $newerdata)-&gt;once();</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-keyword">null</span>, $cart-&gt;decrement(<span class="hljs-string">'my_row_id_2'</span>));</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>}</td></tr></table></code></pre><p>If we re-run Infection, we now get a much better result:</p><pre><code class="hljs lang-bash"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>$ infection</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>You are running Infection with xdebug enabled.</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    ____      ____          __  _</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   /  _/___  / __/__  _____/ /_(_)___  ____ </td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   / // __ \/ /_/ _ \/ ___/ __/ / __ \/ __ \</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td> _/ // / / / __/  __/ /__/ /_/ / /_/ / / / /</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>/___/_/ /_/_/  \___/\___/\__/_/\____/_/ /_/</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>Running initial <span class="hljs-built_in">test</span> suite...</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>PHPUnit version: 6.5.13</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   22 [============================] 3 secs</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>Generate mutants...</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>Processing <span class="hljs-built_in">source</span> code files: 5/5</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>Creating mutated files and processes: 41/41</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>.: killed, M: escaped, S: uncovered, E: fatal error, T: timed out</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>.........................................            (41 / 41)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>41 mutations were generated:</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>      41 mutants were killed</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>       0 mutants were not covered by tests</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       0 covered mutants were not detected</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>       0 errors were encountered</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>       0 time outs were encountered</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>Metrics:</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>         Mutation Score Indicator (MSI): 100%</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>         Mutation Code Coverage: 100%</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>         Covered Code MSI: 100%</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>Please note that some mutants will inevitably be harmless (i.e. <span class="hljs-literal">false</span> positives).</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>Time: 19s. Memory: 12.00MB</td></tr></table></code></pre><p>Code coverage only tells you what lines of code are actually executed - it doesn’t tell you much about how effectively that line of code is tested. Infection gives you a different insight into the quality of your tests, helping to write better ones. I’ve so far found it very useful for getting feedback on the quality of my tests. It’s interesting that PHPSpec tests seem to have a consistently lower proportion of escaped mutants than PHPUnit ones - perhaps the more natural workflow when writing specs with PHPSpec makes it easier to write good tests.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/testing/">testing</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2018/09/13/mutation-testing-with-infection/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2018/09/13/mutation-testing-with-infection/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2020/03/11/caching-the-laravel-user-provider-with-a-decorator/">Caching the Laravel User Provider With a Decorator</a></p><p><a href="/blog/2020/02/12/the-trouble-with-integrated-static-analysis/">The Trouble With Integrated Static Analysis</a></p><p><a href="/blog/2020/02/09/don&#x27;t-use-stdclass/">Don&#x27;t Use Stdclass</a></p><p><a href="/blog/2020/01/25/f***-phpstorm-man-and-the-high-horse-he-rode-in-on/">F*** Phpstorm Man and the High Horse He Rode in on</a></p><p><a href="/blog/2019/10/27/input-components-with-the-usestate-and-useeffect-hooks-in-react/">Input Components With the Usestate and Useeffect Hooks in React</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Zend Framework, Django, Phonegap and React.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a> <a href="https://dev.to/matthewbdaly" rel="me">Dev.to</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li class="page-item"><a class="page-link" href="/blog/2018/09/09/switching-from-vim-to-neovim/">&lt; Switching from Vim to Neovim</a></li><li class="page-item"><a class="page-link" href="/blog/2018/09/24/how-i&#x27;m-refactoring-a-zend-1-legacy-project/">How I&#x27;m Refactoring a Zend 1 Legacy Project &gt;</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2020.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>