<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,machine-learning"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Building a Letter Classifier in PHP With Tesseract OCR and PHP ML - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a></li><li class="nav-item active"><a class="nav-link" href="/blog/archives/">Archives</a></li><li class="nav-item active"><a class="nav-link" href="/about/">About</a></li><li class="nav-item active"><a class="nav-link" href="/rss.xml">RSS</a></li><li class="nav-item dropdown d-lg-none"><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/">Home</a> <a class="dropdown-item" href="/blog/archives/">Archives</a> <a class="dropdown-item" href="/about/">About</a> <a class="dropdown-item" href="/rss.xml">RSS</a></div></li></ul><form class="form-inline my-2 my-lg-0" action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input class="form-control mr-sm-2" id="search" name="q" maxlength="200" autocomplete="off" type="search" placeholder="Search" aria-label="Search"><ul class="searchresults"></ul></form></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">10th May 2018 11:50 pm</p><h1>Building a Letter Classifier in PHP With Tesseract OCR and PHP ML</h1><p>PHP isn’t the first language that springs to mind when it comes to machine learning. However, it is practical to use PHP for machine learning purposes. In this tutorial I’ll show you how to build a pipeline for classifying letters.</p><h2 id="the-brief">The brief</h2><p>Before I was a web dev, I was a clerical worker for an FTSE-100 insurance company, doing a lot of work that nowadays is possible to automate away, if you know how. When they received a letter or other communication from a client, it would be sent to be scanned on. Once scanned, a human would have to look at it to classify it, eg was it a complaint, a request for information, a request for a quote, or something else, as well as assign it to a policy number. Let’s imagine we’ve been asked to build a proof of concept for automating this process. This is a good example of a real-world problem that machine learning can help with.</p><p>As this is a proof of concept we aren’t looking to build a web app for this - for simplicity’s sake this will be a command-line application. Unlike emails, letters don’t come in an easily machine-readable format, so we will be receiving them as PDF files (since they would have been scanned on, this is a reasonable assumption). Feel free to mock up your own example letters using your own classifications, but I will be classifying letters into four groups:</p><ul><li><strong>Complaints</strong> - letters expressing dissatisfaction</li><li><strong>Information requests</strong> - letters requesting general information</li><li><strong>Surrender quotes</strong> - letters requesting a surrender quote</li><li><strong>Surrender forms</strong> - letters requesting surrender forms</li></ul><p>Our application will therefore take in a PDF file at one end, and perform the following actions on it:</p><ul><li>Convert the PDF file to a PNG file</li><li>Use OCR (optical character recognition) to convert the letter to plain text</li><li>Strip out unwanted whitespace</li><li>Extract any visible policy number from the text</li><li>Use a machine learning library to classify the letter, having taught it using prior examples</li></ul><p>Sound interesting? Let’s get started…</p><h2 id="introducing-pipelines">Introducing pipelines</h2><p>As our application will be carrying out a series of discrete steps on our data, it makes sense to use the pipeline pattern for this project. Fortunately, the PHP League have produced a excellent <a href="http://pipeline.thephpleague.com/">package</a> implementing this. We can therefore create a single class for each step in the process and have it handle that in isolation.</p><p>We’ll also use the Symfony Console component to implement our command-line application. For our machine learning library we will be using <a href="https://php-ml.readthedocs.io/en/latest/">PHP ML</a>, which requires PHP 7.1 or greater. For OCR, we will be using <a href="https://github.com/thiagoalessio/tesseract-ocr-for-php">Tesseract</a>, so you will need to install the underlying Tesseract OCR library, as well as support for your language. On Ubuntu you can install these as follows:</p><pre><code class="hljs lang-bash singleline">$ sudo apt-get install tesseract-ocr tesseract-ocr-eng</code></pre><p>This assumes you are using English, however you should be able to find packages to support many other languages. Finally, we need ImageMagick to be installed in order to convert PDF files to PNG’s.</p><p>Your <code>composer.json</code> should look something like this:</p><pre><code class="hljs lang-json"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"matthewbdaly/letter-classifier"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Demo of classifying letters in PHP"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"project"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>    <span class="hljs-attr">"require"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        <span class="hljs-attr">"league/pipeline"</span>: <span class="hljs-string">"^0.3.0"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>        <span class="hljs-attr">"thiagoalessio/tesseract_ocr"</span>: <span class="hljs-string">"^2.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>        <span class="hljs-attr">"php-ai/php-ml"</span>: <span class="hljs-string">"^0.6.2"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-attr">"symfony/console"</span>: <span class="hljs-string">"^4.0"</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>    <span class="hljs-attr">"require-dev"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-attr">"phpspec/phpspec"</span>: <span class="hljs-string">"^4.3"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-attr">"psy/psysh"</span>: <span class="hljs-string">"^0.8.17"</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-attr">"autoload"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-attr">"psr-4"</span>: {</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-attr">"Matthewbdaly\\LetterClassifier\\"</span>: <span class="hljs-string">"src/"</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    },</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-attr">"authors"</span>: [</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>        {</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Matthew Daly"</span>,</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-attr">"email"</span>: <span class="hljs-string">"matthewbdaly@gmail.com"</span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    ]</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>}</td></tr></table></code></pre><p>Next, let’s write the outline of our command-line client. We’ll load a single class for our processor command. Save this as <code>app</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-comment">#!/usr/bin/env php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/vendor/autoload.php'</span>;</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Application</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Commands</span>\<span class="hljs-title">Processor</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>$application = <span class="hljs-keyword">new</span> Application();</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>$application-&gt;add(<span class="hljs-keyword">new</span> Processor());</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>$application-&gt;run();</td></tr></table></code></pre><p>Next, we create our command. Save this as <code>src/Commands/Processor.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Commands</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Command</span>\<span class="hljs-title">Command</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Output</span>\<span class="hljs-title">OutputInterface</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputArgument</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Pipeline</span>\<span class="hljs-title">Pipeline</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">ConvertPdfToPng</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">ReadFile</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">Classify</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">StripTabs</span>;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>\<span class="hljs-title">GetPolicyNumber</span>;</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Processor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;setName(<span class="hljs-string">'process'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            -&gt;setDescription(<span class="hljs-string">'Processes a file'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            -&gt;setHelp(<span class="hljs-string">'This command processes a file'</span>)</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            -&gt;addArgument(<span class="hljs-string">'file'</span>, InputArgument::REQUIRED, <span class="hljs-string">'File to process'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $file = $input-&gt;getArgument(<span class="hljs-string">'file'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        $pipeline = (<span class="hljs-keyword">new</span> Pipeline)</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> ConvertPdfToPng)</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> ReadFile)</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> StripTabs)</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> GetPolicyNumber)</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>            -&gt;pipe(<span class="hljs-keyword">new</span> Classify);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        $response = $pipeline-&gt;process($file);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $output-&gt;writeln(<span class="hljs-string">"Classification is "</span>.$response[<span class="hljs-string">'classification'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $output-&gt;writeln(<span class="hljs-string">"Policy number is "</span>.$response[<span class="hljs-string">'policy'</span>]);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>}</td></tr></table></code></pre><p>Note how our command accepts the file name as an argument. We then instantiate our pipeline and pass it through a series of classes, each of which has a single role. Finally, we retrieve our response and output it.</p><p>With that done, we can move on to implementing our first step. Save this as <code>src/Stages/ConvertPdfToPng.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Imagick</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConvertPdfToPng</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($file)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $tmp = tmpfile();</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        $uri = stream_get_meta_data($tmp)[<span class="hljs-string">'uri'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        $img = <span class="hljs-keyword">new</span> Imagick();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        $img-&gt;setResolution(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>);</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        $img-&gt;readImage($file);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        $img-&gt;setImageDepth(<span class="hljs-number">8</span>);</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>        $img-&gt;setImageFormat(<span class="hljs-string">'png'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        $img-&gt;writeImage($uri);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">return</span> $tmp;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>}</td></tr></table></code></pre><p>This stage fetches the file passed through, and converts it into a PNG file, stores it as a temporary file, and returns a reference to it. The output of this stage will then form the input of the next. This is how pipelines work, and it makes it easy to break up a complex process into multiple steps that can be reused in different places, facilitating easier code reuse and making your code simpler to understand and reason about.</p><p>Our next step carries out optical character recognition. Save this as <code>src/Stages/ReadFile.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">thiagoalessio</span>\<span class="hljs-title">TesseractOCR</span>\<span class="hljs-title">TesseractOCR</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadFile</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($file)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        $uri = stream_get_meta_data($file)[<span class="hljs-string">'uri'</span>];</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        $ocr = <span class="hljs-keyword">new</span> TesseractOCR($uri);</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>        <span class="hljs-keyword">return</span> $ocr-&gt;lang(<span class="hljs-string">'eng'</span>)-&gt;run();</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>}</td></tr></table></code></pre><p>As you can see, this accepts the link to the temporary file as an argument, and runs Tesseract on it to retrieve the text. Note that we specify a language of <code>eng</code> - if you want to use a language other than English, you should specify it here.</p><p>At this point, we should have some usable text, but there may be unknown amounts of whitespace, so our next step uses a regex to strip them out. Save this as <code>src/Stages/StripTabs.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StripTabs</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($content)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        <span class="hljs-keyword">return</span> trim(preg_replace(<span class="hljs-string">'/\s+/'</span>, <span class="hljs-string">' '</span>, $content));</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>}</td></tr></table></code></pre><p>With our whitespace issue sorted out, we now need to retrieve the policy number the communication should be filed under. These are generally regular alphanumeric patterns, so regexes are a suitable way of matching them. As this is a proof of concept, we’ll assume a very simple pattern for policy numbers in that they will consist of between seven and nine digits. Save this as <code>src/Stages/GetPolicyNumber.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetPolicyNumber</span></span></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">($content)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>        $matches = [];</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>        $policyNumber = <span class="hljs-string">''</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        preg_match(<span class="hljs-string">'/\d{7,9}/'</span>, $content, $matches);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>        <span class="hljs-keyword">if</span> (count($matches)) {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>            $policyNumber = $matches[<span class="hljs-number">0</span>];</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>            <span class="hljs-string">'content'</span> =&gt; $content,</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>            <span class="hljs-string">'policy'</span> =&gt; $policyNumber</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>}</td></tr></table></code></pre><p>Finally, we’re onto the really tough part - using machine learning to classify the letters. Save this as <code>src/Stages/Classify.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">Matthewbdaly</span>\<span class="hljs-title">LetterClassifier</span>\<span class="hljs-title">Stages</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Dataset</span>\<span class="hljs-title">CsvDataset</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Dataset</span>\<span class="hljs-title">ArrayDataset</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">FeatureExtraction</span>\<span class="hljs-title">TokenCountVectorizer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Tokenization</span>\<span class="hljs-title">WordTokenizer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">CrossValidation</span>\<span class="hljs-title">StratifiedRandomSplit</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">FeatureExtraction</span>\<span class="hljs-title">TfIdfTransformer</span>;</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Metric</span>\<span class="hljs-title">Accuracy</span>;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">Classification</span>\<span class="hljs-title">SVC</span>;</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Phpml</span>\<span class="hljs-title">SupportVectorMachine</span>\<span class="hljs-title">Kernel</span>;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Classify</span></span></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">protected</span> $classifier;</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-keyword">protected</span> $vectorizer;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    <span class="hljs-keyword">protected</span> $tfIdfTransformer;</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>        <span class="hljs-keyword">$this</span>-&gt;dataset = <span class="hljs-keyword">new</span> CsvDataset(<span class="hljs-string">'data/letters.csv'</span>, <span class="hljs-number">1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer = <span class="hljs-keyword">new</span> TokenCountVectorizer(<span class="hljs-keyword">new</span> WordTokenizer());</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer = <span class="hljs-keyword">new</span> TfIdfTransformer();</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        $samples = [];</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;dataset-&gt;getSamples() <span class="hljs-keyword">as</span> $sample) {</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>                $samples[] = $sample[<span class="hljs-number">0</span>];</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        }</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;fit($samples);</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;transform($samples);</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;fit($samples);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;transform($samples);</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        $dataset = <span class="hljs-keyword">new</span> ArrayDataset($samples, <span class="hljs-keyword">$this</span>-&gt;dataset-&gt;getTargets());</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>        $randomSplit = <span class="hljs-keyword">new</span> StratifiedRandomSplit($dataset, <span class="hljs-number">0.1</span>);</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>        <span class="hljs-keyword">$this</span>-&gt;classifier = <span class="hljs-keyword">new</span> SVC(Kernel::RBF, <span class="hljs-number">10000</span>);</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;train($randomSplit-&gt;getTrainSamples(), $randomSplit-&gt;getTrainLabels());</td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>        $predictedLabels = <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;predict($randomSplit-&gt;getTestSamples());</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Accuracy: '</span>.Accuracy::score($randomSplit-&gt;getTestLabels(), $predictedLabels);</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(array $message)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>        $newSample = [$message[<span class="hljs-string">'content'</span>]];</td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>        <span class="hljs-keyword">$this</span>-&gt;vectorizer-&gt;transform($newSample);</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;tfIdfTransformer-&gt;transform($newSample);</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $message[<span class="hljs-string">'classification'</span>] = <span class="hljs-keyword">$this</span>-&gt;classifier-&gt;predict($newSample)[<span class="hljs-number">0</span>];</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>        <span class="hljs-keyword">return</span> $message;</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>}</td></tr></table></code></pre><p>In our constructor, we train up our model by passing our sample data through the following steps:</p><ul><li>First, we use the token count vectorizer to convert our samples to a vector of token counts - replacing every word with a number and keeping track of how often that word occurs.</li><li>Next, we use <code>TfIdfTransformer</code> to get statistics about how important a word is in a document.</li><li>Then we instantiate our classifier and train it on a random subset of our data.</li><li>Finally, we pass our message to our now-trained classifier and see what it tells us.</li></ul><p>Now, bear in mind I don’t have a background in machine learning and this is the first time I’ve done anything with machine learning, so I can’t tell you much more than that - if you want to know more I suggest you investigate on your own. In figuring this out I was helped a great deal by <a href="https://www.sitepoint.com/how-to-analyze-tweet-sentiments-with-php-machine-learning/">this article on Sitepoint</a>, so you might want to start there.</p><p>The finished application is <a href="https://github.com/matthewbdaly/letter-classifier">on GitHub</a>, and the repository includes a CSV file of training data, as well as the <code>examples</code> folder, which contains some example PDF files. You can run it as follows:</p><pre><code class="hljs lang-bash singleline">$ php app process examples/Quote.pdf</code></pre><p>I found that once I had trained it up using the CSV data from the repository, it was around 70-80% accurate, which isn’t bad at all considering the comparatively small size of the dataset. If this were genuinely being used in production, there would be an extremely large dataset of historical scanned letters to use for training purposes, so it wouldn’t be unreasonable to expect much better results under those circumstances.</p><h2 id="exercises-for-the-reader">Exercises for the reader</h2><p>If you want to develop this concept further, here are some ideas:</p><ul><li>We should be able to correct the model when it’s wrong. Add a separate command to train the model by passing through a file and specifying how it should be categorised, eg <code>php app train File.pdf quote</code>.</li><li>Try processing information from different sources. For instance, you could replace the first two stages with a stage that pulls all unread emails from a specified mailbox using PHP’s IMAP support, or fetching data from the Twitter API. Or you could have a telephony service such as Twilio set up as your voicemail, and automatically transcribe them, then pass the text to PHP ML for classification.</li><li>If you’re multilingual, you could try adding a step to sort letters by language and have separate models for classifying in each language</li></ul><h2 id="summary">Summary</h2><p>It’s actually quite a sobering thought that <em>already</em> it’s possible to use techniques like these to produce tools that replace people in various jobs, and as the tooling matures more and more tasks involving classification are going to become amenable to automation using machine learning.</p><p>This was my first experience with machine learning and it’s been very interesting for me to solve a real-world problem with it. I hope it gives you some ideas about how you could use it too.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/machine-learning/">machine-learning</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2018/05/10/building-a-letter-classifier-in-php-with-tesseract-ocr-and-php-ml/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/12/27/improving-search-in-vim-and-neovim-with-fzf-and-ripgrep/">Improving Search in Vim and Neovim With FZF and Ripgrep</a></p><p><a href="/blog/2018/12/06/decorating-service-classes/">Decorating Service Classes</a></p><p><a href="/blog/2018/10/20/simplify-your-tests-with-anonymous-classes/">Simplify Your Tests With Anonymous Classes</a></p><p><a href="/blog/2018/10/16/adding-react-to-a-legacy-project/">Adding React to a Legacy Project</a></p><p><a href="/blog/2018/10/11/do-you-still-need-jquery/">Do You Still Need Jquery?</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pagination"><li><a class="page-item" href="/blog/2018/04/29/console-applications-with-the-symfony-console-component/">Console Applications With the Symfony Console Component</a></li><li><a class="page-item" href="/blog/2018/05/13/full-text-search-with-mariadb/">Full-text Search With Mariadb</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2019.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>